# market/nginx2/market_front_unified_partner_nginx2
    
## Common properties

  * **Owner:** `marketfrontend`
  * **Table:** `nginx2`

## Splits

```json
{
    "service_partner": "multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' )",
    "code": "arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)])",
    "buckets_ttlb": "if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms))))",
    "buckets_req_time": "if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms))))",
    "buckets_handshake": "if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms)))",
    "buckets_bytes_send": "if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent))))",
    "dc": "multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' )",
    "host": "host",
    "requester": "multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in')",
    "robot": "replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\\\)|MSRBOT \\\\(http://research\\\\.microsoft\\\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\\\.com|Refer\\\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '')",
    "resource-type": "if(dynamic = 0 or page_id = '', 'static', 'dynamic')",
    "page": "replaceAll(page_id, ':', '_')",
    "resolver": "replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_')"
}
```

## Filters

```json
[
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service'",
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')",
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != ''",
    "environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')"
]
```

## Resulting metrics

  * [`market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles`](#f4a0b17d285622f7ff7a92c157affb20)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles`](#5f4974e687b33ec47361b69012ea2ecd)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles`](#40d273bb7e0e8fde2a6378fed3eb5e8a)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.rps`](#321effedb5b97008adb8d70af8a44d9e)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles`](#60ab246c289b2dcb9e4e7a06bae5472d)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles`](#c736a41d63e6598f3ad451165505fd8d)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles`](#69243ffebf92abae1a0dbe24db153756)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles`](#c8eedf8aa4ab507de04eabe46838b157)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps`](#3a45e192d4ca7aa73b2999ccc09a2e16)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles`](#ae6512fcd6781dc3d4c16a9523c91c89)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#dd1815eb9e27654f7391ada3a373e453)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles`](#ee6e97a8d5f81a0e89ab672cca06e485)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#c9c9758e101cc2e710b38c92b52fea7b)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.quantiles`](#6a9fe9583a00754bd38d01a96432e349)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#e5a848ce20e632c1430606597dc9cfd3)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.quantiles`](#1631b47ed8206f6b8cfe87ada559ad3f)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.rps`](#d7c4d2f2741898455513e4a1f222ccea)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#ad368c37472092ba085d1cf73513d2b2)
  * [`market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles`](#5a324199ff2ed45c313e2fa1fc807372)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles`](#ed1995a1bbf4a6275641173e41a9edfe)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles`](#6235494a17e2d8cd1b5beaf77dbbca9a)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles`](#55583e513b59ba2266312654d6b3e4f9)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.rps`](#eb80cb00a9c637aaca74647bdb4a988e)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles`](#47165a9559c7e43b07ec101ed9ff3060)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles`](#f4e8a5a992810f8c972d1b1df743af86)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles`](#377db5b2bcce58a69e29baa4cf80ca0f)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles`](#0650d5bbd0edb498df59895621efb160)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps`](#4a20a59ae64863cae0c576d2495d040e)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles`](#5186a38cfa4d4964235b2e43cd9b5da0)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#af43f9a3432ab9e77a614e09abf0a52a)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.quantiles`](#df2de43f22c40baef6b54f0be4d9a643)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#9e1d9aa32f36ec93b0343a38665a9c2a)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.quantiles`](#afe878b403924565d4cd81ac7879cb8e)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#5bd834f8db341940771f9fa4ca7d6efe)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.quantiles`](#d4b2454403f381c76ce87d5395b096d4)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.rps`](#93f1447e9bfed30370badb630853f5dd)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#fa0437bf2cf1f208b048e58c16a6f8d7)
  * [`market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.quantiles`](#13baea90f0a82b66d321a87ed7799438)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#03c77d56cf8aceb9c2bf9c572387df81)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.quantiles`](#6039229e6caa843dd3fdf3dbbd46e240)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#44c283ae07af6f3789a6d1cd4ec5457d)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.quantiles`](#811a4d4b3ec6ef38414a6e0ace6271e1)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#cb663291a2d7470e4bb47b659c4b1e3c)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.quantiles`](#3e7e5bd73da904cd84bf5840ed6417a3)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.rps`](#77bb9c3392825a5b01d632f9e5b02d5f)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#ce66d61b7e5bb8eeeaee4959af4bc933)
  * [`market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.quantiles`](#e11ba19b7518df3ff0be0364c95b0135)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles`](#a5eb76ef0deaf3dc706968f99d6d7096)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles`](#f60bfa6271b0b6ad2a2f2f04306dfb23)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles`](#3a7cd5e58f31e52b3727d9441b55dfa1)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps`](#6cd5112ad27c004928d9430f015ff90c)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles`](#1bd9f3638abb0bd6a4d880e4c5087ca7)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles`](#114e2b856097dba10522a5048fb1e2ab)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles`](#c749bbc99915864e74bae2bfe550ffbc)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles`](#c2c1245c1b74a85daab916f3e312d39c)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.rps`](#1b8e041e2479810a2bc2b37fae402eed)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles`](#a993589fb8a69335a334d49cd5e49712)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles`](#ba810dfb50b3625388790a97117af355)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles`](#eefa851d17d3f30518208d51e5170f16)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles`](#175ca4bff2129c359ab1bca41aa8132b)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.rps`](#d33dac6ca69fa2566942ee369ab95a14)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles`](#3152c9b97d2e4726b9b6050385eab1ae)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles`](#ff353a0b15ecf68553c76fd5b31c73c0)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles`](#5445c8dde1da3e085ef74ecacbf2b2fd)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles`](#c9acceaeb7df1d417cb3a819d6626c88)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps`](#3dea04a92ff538ccff456aae4ab67121)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles`](#2233c62fe4dc2f790653e0ca4df1cbd8)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#67f0dc59a6d2d97c55619954a4f62f3d)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles`](#9b66f202afb2227adfc76c78f3e6850b)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles`](#7af4c4484d9647956c8ce43f6ead5acf)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps`](#f358cc634816211a4ffee211dbbce1e9)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles`](#3eb8e95a3b8ced9558a3fb1e6c44ff10)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#9b2e006eaf100a1a46b45bc94b318620)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles`](#7c6e88783ed0309639ffb94008206321)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#76dbe7c8d29674a7e957162fa7c05fd6)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.quantiles`](#8a2c7ac7d27bf15b2e7bca1d3db57b1d)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#6c792a6c6a242421af97d1271b629794)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.quantiles`](#7d7f4671e0c2c3a4ce2bb543817591ae)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.rps`](#f7a55446de2a44ba13e750aa4c028262)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#dd3719bae8c353ea812ea83cd35b88d7)
  * [`market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles`](#9eb787b1d9d41ba59a54a2c9f11addf4)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#4e12d113f3863b7650409291d6b92242)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles`](#45b790b635d4e9d3fa07fe6fac047863)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#74c1796b3c6fc666136c0fc3afe28344)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles`](#ad6bde725a880ba50f348008c0433c71)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#3c14369dddd9b09676f7d6cab6e144f1)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles`](#811fa190f78e713305d9b12d13b48285)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.rps`](#4b2c0dfe4198a133afddc68d9336b0ed)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#786d2a17aac11f6c4c7be2ec9d40a4fd)
  * [`market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles`](#229c0f7acbfdd5a9a6c5e7c119c67289)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#4cc3b0322c8457abae8aa820bc369659)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles`](#5ef839139e18824c7d55ab3e50e63dfe)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#5bc5a100db8e8fcbdfbd92006ac613b1)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles`](#e6a35a3678d717b1f215b49f8d580bf9)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#cadc1ae493e79bacddfdc868f4227d65)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles`](#b7630c162ab1b368eb4796a8971d8739)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.rps`](#5be789700cb9ac4ab632b0864473c8d3)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#0ce3925da858c53b3b17a306de8d7e86)
  * [`market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles`](#78a024378dc978d4c924257cfa891e96)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles`](#0ee73bb728c3d127fe2d40f7ed6310e8)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles`](#dca3679a3adcdc3b9a42614866c3dc67)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles`](#63bd1cc95096c09079d1019299304c96)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps`](#74ea52014d0e4f4d0a4c82d325aae4db)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles`](#fa8b438359a8f3c3d1d6cd56e690b667)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles`](#11ae874a68f5c9f92d12dd26bbaa7d30)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles`](#6a744938bff65f8293edafe784922890)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles`](#4acc7780554a948c8872a356b301bc23)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.rps`](#9a8f352dfce0c7df16ab2c2127ab1009)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles`](#9e7de46de9753e6fb88ab19cea16472f)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles`](#d1a2e8221a10ab34d054d3b12009f4b0)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles`](#174cfd579d4cc2f536ab2a2402e7da4d)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles`](#40d58248920f946bc6c2c62c7afb6dec)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.rps`](#1cb474e5f3d196bc63f292a8e00e501a)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles`](#94032eb35cd93817977559f3ed0e04bb)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles`](#3e6b521ef082ac34e732004799e3d8a0)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles`](#cdec078f13c8bf1fe74200f5f1e2858f)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles`](#80121d2deeb40a6857b0ed81633a951f)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps`](#a564d9905c611241659948f2e50c8342)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles`](#ae6fe1d619d071ed8191a04783db0cd6)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles`](#175d95624c4ba2a35428e9888a839f61)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles`](#8a8aac6d25373477682a8221d84ac49d)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles`](#7a6a1b12058bfbb6e7c5b7b558768c42)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps`](#84c436b7cd1a620b49d2eb4190d86e05)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles`](#022dd92a6b5e0d53f88851d91e78a2c8)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#216504cd0f9d2bc617ecd148dddce159)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles`](#67992747bdc9030301b3d00457109adf)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}`](#d7dbbfb6452d5736a387242e9945c47c)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.quantiles`](#35e44311d4f261415d0356c3580c34bc)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}`](#bf7f5cd924ab11820b07979d4c990d2e)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.quantiles`](#d19f4cc0817f306738e47fb4465d5714)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.rps`](#9b25479a290fa6d54d97c6bce0a7a461)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#3fac3523a5af9a841448e0dc483a9581)
  * [`market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles`](#0e8f4476b9c4524bec6c3a9eedeaf453)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}`](#260f35067a3667e21b182b239fca3a3c)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.quantiles`](#0f1f9b333d981cafcc3c6063f692ea03)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.buckets.${buckets_handshake}`](#fa971b9d5c105b5cee702e8477b5a933)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.quantiles`](#21f0691d8d95738abd227196d6daf677)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.buckets.${buckets_req_time}`](#cc71b91176ea632a804f1a3c9acb612b)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.quantiles`](#4424402f3560ec88536fc025012612ca)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.rps`](#b0d7c3f1bed571897c95619369ac760a)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}`](#697765c08376ad9554765fcff4bff72d)
  * [`market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.quantiles`](#8252100ff6501324ecf362e55b892714)

## Metrics

#### <a id='b0d7c3f1bed571897c95619369ac760a'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='697765c08376ad9554765fcff4bff72d'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cc71b91176ea632a804f1a3c9acb612b'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fa971b9d5c105b5cee702e8477b5a933'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='260f35067a3667e21b182b239fca3a3c'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d7c4d2f2741898455513e4a1f222ccea'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ad368c37472092ba085d1cf73513d2b2'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e5a848ce20e632c1430606597dc9cfd3'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c9c9758e101cc2e710b38c92b52fea7b'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='dd1815eb9e27654f7391ada3a373e453'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='93f1447e9bfed30370badb630853f5dd'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fa0437bf2cf1f208b048e58c16a6f8d7'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5bd834f8db341940771f9fa4ca7d6efe'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9e1d9aa32f36ec93b0343a38665a9c2a'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='af43f9a3432ab9e77a614e09abf0a52a'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f7a55446de2a44ba13e750aa4c028262'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='dd3719bae8c353ea812ea83cd35b88d7'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6c792a6c6a242421af97d1271b629794'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='76dbe7c8d29674a7e957162fa7c05fd6'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9b2e006eaf100a1a46b45bc94b318620'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5be789700cb9ac4ab632b0864473c8d3'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0ce3925da858c53b3b17a306de8d7e86'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resource_type,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resource_type,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cadc1ae493e79bacddfdc868f4227d65'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resource_type,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resource_type,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5bc5a100db8e8fcbdfbd92006ac613b1'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resource_type,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resource_type,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4cc3b0322c8457abae8aa820bc369659'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resource_type,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resource_type,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6cd5112ad27c004928d9430f015ff90c'></a>market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1b8e041e2479810a2bc2b37fae402eed'></a>market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f358cc634816211a4ffee211dbbce1e9'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9b25479a290fa6d54d97c6bce0a7a461'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3fac3523a5af9a841448e0dc483a9581'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='bf7f5cd924ab11820b07979d4c990d2e'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d7dbbfb6452d5736a387242e9945c47c'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='216504cd0f9d2bc617ecd148dddce159'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='74ea52014d0e4f4d0a4c82d325aae4db'></a>market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9a8f352dfce0c7df16ab2c2127ab1009'></a>market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='84c436b7cd1a620b49d2eb4190d86e05'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='77bb9c3392825a5b01d632f9e5b02d5f'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ce66d61b7e5bb8eeeaee4959af4bc933'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    page,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        page,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cb663291a2d7470e4bb47b659c4b1e3c'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    page,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        page,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='44c283ae07af6f3789a6d1cd4ec5457d'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    page,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        page,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='03c77d56cf8aceb9c2bf9c572387df81'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    page,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        page,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='321effedb5b97008adb8d70af8a44d9e'></a>market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='eb80cb00a9c637aaca74647bdb4a988e'></a>market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d33dac6ca69fa2566942ee369ab95a14'></a>market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4b2c0dfe4198a133afddc68d9336b0ed'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='786d2a17aac11f6c4c7be2ec9d40a4fd'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_ttlb%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resolver,
    code,
    buckets_ttlb

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.buckets.%24%7Bbuckets_ttlb%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_ttlb%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(resptime_ms)%20%3C%20128%2C%20'less_128'%2C%20if(roundToExp2(resptime_ms)%20%3E%2016384%2C%20'more_16384'%2C%20toString(roundToExp2(resptime_ms))))%20as%20buckets_ttlb%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resolver,
        code,
        buckets_ttlb
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3c14369dddd9b09676f7d6cab6e144f1'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_req_time%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resolver,
    code,
    buckets_req_time

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.buckets.%24%7Bbuckets_req_time%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_req_time%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(client_reqtime_ms)%20%3C%2016%2C%20'less_16'%2C%20if(roundToExp2(client_reqtime_ms)%20%3E%204096%2C%20'more_4096'%2C%20toString(roundToExp2(client_reqtime_ms))))%20as%20buckets_req_time%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resolver,
        code,
        buckets_req_time
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='74c1796b3c6fc666136c0fc3afe28344'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_handshake%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resolver,
    code,
    buckets_handshake

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.buckets.%24%7Bbuckets_handshake%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_handshake%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(ssl_handshake_time_ms)%20%3E%2064%2C%20'more_64'%2C%20toString(roundToExp2(ssl_handshake_time_ms)))%20as%20buckets_handshake%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resolver,
        code,
        buckets_handshake
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4e12d113f3863b7650409291d6b92242'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%2C%0A%20%20%20%20buckets_bytes_send%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    resolver,
    code,
    buckets_bytes_send

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
    if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.buckets.%24%7Bbuckets_bytes_send%7D'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%2C%0A%20%20%20%20%20%20%20%20buckets_bytes_send%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%2C%0A%20%20%20%20%20%20%20%20if(roundToExp2(bytes_sent)%20%3C%201024%2C%20'less_1024'%2C%20if(roundToExp2(bytes_sent)%20%3E%2065536%2C%20'more_65536'%2C%20toString(roundToExp2(bytes_sent))))%20as%20buckets_bytes_send%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        resolver,
        code,
        buckets_bytes_send
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code,
        if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3a45e192d4ca7aa73b2999ccc09a2e16'></a>market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4a20a59ae64863cae0c576d2495d040e'></a>market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3dea04a92ff538ccff456aae4ab67121'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1cb474e5f3d196bc63f292a8e00e501a'></a>market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a564d9905c611241659948f2e50c8342'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    count() / 60 as value_0,
    service_partner,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.rps'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20count()%20%2F%2060%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        count() / 60 as value_0,
        service_partner,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8252100ff6501324ecf362e55b892714'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5a324199ff2ed45c313e2fa1fc807372'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='13baea90f0a82b66d321a87ed7799438'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9eb787b1d9d41ba59a54a2c9f11addf4'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='78a024378dc978d4c924257cfa891e96'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1bd9f3638abb0bd6a4d880e4c5087ca7'></a>market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a993589fb8a69335a334d49cd5e49712'></a>market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3eb8e95a3b8ced9558a3fb1e6c44ff10'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0e8f4476b9c4524bec6c3a9eedeaf453'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='fa8b438359a8f3c3d1d6cd56e690b667'></a>market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9e7de46de9753e6fb88ab19cea16472f'></a>market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='022dd92a6b5e0d53f88851d91e78a2c8'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e11ba19b7518df3ff0be0364c95b0135'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='60ab246c289b2dcb9e4e7a06bae5472d'></a>market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='47165a9559c7e43b07ec101ed9ff3060'></a>market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3152c9b97d2e4726b9b6050385eab1ae'></a>market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='229c0f7acbfdd5a9a6c5e7c119c67289'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ae6512fcd6781dc3d4c16a9523c91c89'></a>market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5186a38cfa4d4964235b2e43cd9b5da0'></a>market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='2233c62fe4dc2f790653e0ca4df1cbd8'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='94032eb35cd93817977559f3ed0e04bb'></a>market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_partner,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_partner,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ae6fe1d619d071ed8191a04783db0cd6'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.ttlb.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(resptime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4424402f3560ec88536fc025012612ca'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='1631b47ed8206f6b8cfe87ada559ad3f'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d4b2454403f381c76ce87d5395b096d4'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7d7f4671e0c2c3a4ce2bb543817591ae'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='b7630c162ab1b368eb4796a8971d8739'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3a7cd5e58f31e52b3727d9441b55dfa1'></a>market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c2c1245c1b74a85daab916f3e312d39c'></a>market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7af4c4484d9647956c8ce43f6ead5acf'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d19f4cc0817f306738e47fb4465d5714'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='63bd1cc95096c09079d1019299304c96'></a>market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='4acc7780554a948c8872a356b301bc23'></a>market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7a6a1b12058bfbb6e7c5b7b558768c42'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3e7e5bd73da904cd84bf5840ed6417a3'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='40d273bb7e0e8fde2a6378fed3eb5e8a'></a>market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='55583e513b59ba2266312654d6b3e4f9'></a>market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='175ca4bff2129c359ab1bca41aa8132b'></a>market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='811fa190f78e713305d9b12d13b48285'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c8eedf8aa4ab507de04eabe46838b157'></a>market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0650d5bbd0edb498df59895621efb160'></a>market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c9acceaeb7df1d417cb3a819d6626c88'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='40d58248920f946bc6c2c62c7afb6dec'></a>market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_partner,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_partner,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='80121d2deeb40a6857b0ed81633a951f'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.req_time.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(client_reqtime_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='21f0691d8d95738abd227196d6daf677'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6a9fe9583a00754bd38d01a96432e349'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='afe878b403924565d4cd81ac7879cb8e'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8a2c7ac7d27bf15b2e7bca1d3db57b1d'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='e6a35a3678d717b1f215b49f8d580bf9'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f60bfa6271b0b6ad2a2f2f04306dfb23'></a>market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c749bbc99915864e74bae2bfe550ffbc'></a>market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='9b66f202afb2227adfc76c78f3e6850b'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='35e44311d4f261415d0356c3580c34bc'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='dca3679a3adcdc3b9a42614866c3dc67'></a>market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6a744938bff65f8293edafe784922890'></a>market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='8a8aac6d25373477682a8221d84ac49d'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='811a4d4b3ec6ef38414a6e0ace6271e1'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5f4974e687b33ec47361b69012ea2ecd'></a>market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6235494a17e2d8cd1b5beaf77dbbca9a'></a>market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='eefa851d17d3f30518208d51e5170f16'></a>market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ad6bde725a880ba50f348008c0433c71'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='69243ffebf92abae1a0dbe24db153756'></a>market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='377db5b2bcce58a69e29baa4cf80ca0f'></a>market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5445c8dde1da3e085ef74ecacbf2b2fd'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='174cfd579d4cc2f536ab2a2402e7da4d'></a>market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_partner,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_partner,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='cdec078f13c8bf1fe74200f5f1e2858f'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.handshake.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesTimingIf(0.5%2C0.6%2C0.7%2C0.80%2C0.90%2C0.95%2C0.97%2C0.99%2C0.995%2C0.997%2C0.999%2C1)(ssl_handshake_time_ms%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0f1f9b333d981cafcc3c6063f692ea03'></a>market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.total.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ee6e97a8d5f81a0e89ab672cca06e485'></a>market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.splits.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='df2de43f22c40baef6b54f0be4d9a643'></a>market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.splits.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='7c6e88783ed0309639ffb94008206321'></a>market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.splits.%24%7Brequester%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='5ef839139e18824c7d55ab3e50e63dfe'></a>market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resourceType.splits.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='a5eb76ef0deaf3dc706968f99d6d7096'></a>market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.dc.splits.%24%7Brequester%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='114e2b856097dba10522a5048fb1e2ab'></a>market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.host.splits.%24%7Brequester%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='67f0dc59a6d2d97c55619954a4f62f3d'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
    service_partner,
    requester,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resourceType.splits.%24%7Brequester%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0,
        service_partner,
        requester,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='67992747bdc9030301b3d00457109adf'></a>market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.splits.%24%7Brobot%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='0ee73bb728c3d127fe2d40f7ed6310e8'></a>market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    dc,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.dc.splits.%24%7Brobot%7D.%24%7Bdc%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        dc,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='11ae874a68f5c9f92d12dd26bbaa7d30'></a>market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20host%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    host,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    host as host,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.host.splits.%24%7Brobot%7D.%24%7Bhost%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        host,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        host as host,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='175d95624c4ba2a35428e9888a839f61'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resource_type%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
    service_partner,
    robot,
    resource_type,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resourceType.splits.%24%7Brobot%7D.%24%7Bresource-type%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resource_type%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20if(dynamic%20%3D%200%20or%20page_id%20%3D%20''%2C%20'static'%2C%20'dynamic')%20as%20resource_type%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0,
        service_partner,
        robot,
        resource_type,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='6039229e6caa843dd3fdf3dbbd46e240'></a>market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.page.splits.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f4a0b17d285622f7ff7a92c157affb20'></a>market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    dc,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.page.splits.%24%7Bdc%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        dc,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ed1995a1bbf4a6275641173e41a9edfe'></a>market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    host,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.page.splits.%24%7Bhost%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        host,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ba810dfb50b3625388790a97117af355'></a>market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
    service_partner,
    requester,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.page.splits.%24%7Brequester%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0,
        service_partner,
        requester,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='45b790b635d4e9d3fa07fe6fac047863'></a>market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.resolver.splits.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='c736a41d63e6598f3ad451165505fd8d'></a>market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20dc%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    dc,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.dc.resolver.splits.%24%7Bdc%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20dc%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(%20substring(host%2C%201%2C%203)%20in%20('iva'%2C%20'man'%2C%20'vla'%2C%20'sas'%2C%20'myt')%2C%20substring(host%2C%201%2C%203)%2C%20endsWith(host%2C%20'yp-c.yandex.net')%2C%20substring(host%2C%20position(host%2C%20'.')%20%2B%201%2C%203)%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%20%3C%3E%20''%2C%20dictGetString('dc'%2C%20'dc'%2C%20sipHash64(host))%2C%20'undefined_dc'%20)%20as%20dc%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        dc,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='f4e8a5a992810f8c972d1b1df743af86'></a>market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20host%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20host%20as%20host%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    host,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    host as host,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.host.resolver.splits.%24%7Bhost%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20host%20as%20host%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        host,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        host as host,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='ff353a0b15ecf68553c76fd5b31c73c0'></a>market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20requester%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    requester,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.requester.resolver.splits.%24%7Brequester%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20requester%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20multiIf(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%20!%3D%20''%2C%20'robot'%2C%20yandex_login%20%3D%20''%2C%20'anonymous'%2C%20'logged-in')%20as%20requester%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        requester,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='d1a2e8221a10ab34d054d3b12009f4b0'></a>market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20page%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
    service_partner,
    robot,
    page,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceAll(page_id, ':', '_') as page,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.page.splits.%24%7Brobot%7D.%24%7Bpage%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20page%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20!%3D%20'')%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceAll(page_id%2C%20'%3A'%2C%20'_')%20as%20page%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0,
        service_partner,
        robot,
        page,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '')
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceAll(page_id, ':', '_') as page,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```
#### <a id='3e6b521ef082ac34e732004799e3d8a0'></a>market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles

[Preview query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%0A%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20service_partner%2C%0A%20%20%20%20robot%2C%0A%20%20%20%20resolver%2C%0A%20%20%20%20code%0A%0AFROM%20market.nginx2%0A%0AWHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%0AGROUP%20BY%20metric_ts%2C%0A%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A%0AORDER%20BY%20metric_ts%20LIMIT%2010)
```SQL
SELECT
    multiply(intDiv(timestamp, 60), 60) AS metric_ts,
    quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
    service_partner,
    robot,
    resolver,
    code

FROM market.nginx2

WHERE date = today() and timestamp > now() - 60 * 60
    AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))

GROUP BY metric_ts,
    multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
    replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
    replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
    arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code

ORDER BY metric_ts LIMIT 10
```

[Diagnostic query:](https://yql.yandex-team.ru/?query_type=CLICKHOUSE&query=use%20marketclickhouse%3B%0A%0ASELECT%20%0A%20%20%20%20'market-front-unified.nginx2.v2.%24%7Bservice_partner%7D.robot.resolver.splits.%24%7Brobot%7D.%24%7Bresolver%7D.%24%7Bcode%7D.metrics.bytes_send.quantiles'%20AS%20title%2C%20%0A%20%20%20%20count()%20AS%20cnt%0A%20%20%20%20%20%0AFROM%20(%0A%20%20%20%20SELECT%0A%20%20%20%20%20%20%20%20multiply(intDiv(timestamp%2C%2060)%2C%2060)%20AS%20metric_ts%2C%0A%20%20%20%20%20%20%20%20quantilesIf(0.5%2C0.7%2C0.9%2C0.95%2C0.97%2C0.99%2C0.995%2C1)(bytes_sent%2Cenvironment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%20as%20value_0%2C%0A%20%20%20%20%20%20%20%20service_partner%2C%0A%20%20%20%20%20%20%20%20robot%2C%0A%20%20%20%20%20%20%20%20resolver%2C%0A%20%20%20%20%20%20%20%20code%0A%20%20%20%20%0A%20%20%20%20FROM%20market.nginx2%0A%20%20%20%20%0A%20%20%20%20WHERE%20date%20%3D%20today()%20and%20timestamp%20%3E%20now()%20-%2060%20*%2060%0A%20%20%20%20%20%20%20%20AND%20(environment%20%3D%20'PRODUCTION'%20and%20url%20!%3D%20'%2Fping'%20and%20service_partner%20!%3D%20'undefined_service'%20and%20robot%20!%3D%20''%20and%20page_id%20in%20('api%3Aresolve'%2C%20'fapi%3Aapi'))%0A%20%20%20%20%0A%20%20%20%20GROUP%20BY%20metric_ts%2C%0A%20%20%20%20%20%20%20%20multiIf(%20vhost%20in%20('partner.market.yandex.ru'%2C'partner.market.yandex.com'%2C'partner.market.yandex.ua'%2C'partner.market.yandex.by'%2C'partner.market.yandex.kz')%2C%20'partner_desktop'%2Cvhost%20%3D%20'analytics.market.yandex.ru'%2C%20'partner_analytics'%20%2C%20'undefined_service'%20)%20as%20service_partner%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(extract(user_agent%2C'Googlebot%7CGoogleDocs%7CGoogle-Ads-Creatives-Assistant%7CYaDirectBot%7CYaDirectFetcher%7CYandexRCA%7CYandexDirectDyn%7CYandexAccessibilityBot%7CMail.RU_Bot%7CBingPreview%7CMediapartners-Google%7CFeedfetcher-Google%3B%7CAdsBot-Google%7CYahoo!%20Slurp%7CWebAlta%7CStackRambler%7Cmsnbot%7Cbingbot%7CAport%7CMail%5C%5C.Ru%2F%7CYandex%2F%7CStatbox%2F%7CYandexSomething%2F%7CYandexBlog%2F%7CYandex%5C%5C.Server%2F%7CYaDirectBot%7CJakarta%20Commons-HttpClient%2F%7CTurtleScanner%7CNovoteka%7Cia_archiver%7Cheritrix%7CTwiceler-%7Cpsbot%2F%7CAlchemy%20Eye%20Agent%7CEchoping%2F%7CFriends%2F%7CWhatsUp%2F%7CWhatsUp_Gold%2F%7C%3B%20HttpSatPinger%5C%5C)%7CMSRBOT%20%5C%5C(http%3A%2F%2Fresearch%5C%5C.microsoft%5C%5C.com%2Fresearch%2Fsv%2Fmsrbot%2F%7CMJ12bot%2F%7Cichiro%2F%7CTECOMAC-Crawler%2F%7CGigabot%7CSogou%20Push%20Spider%7Ccheck_http%2F%7Chttp_ping%7CKeepAliveClient%7CSamSunf%7CGenHash%7CIRLbot%7CUptimeInspector%7Cliveinternet%20spider%7CBegun%20Robot%20Crawler%7CInternetSeer%5C%5C.com%7CRefer%5C%5C.Ru%20Favicon%20Bot%7CRobot%20Semonitor%7CRobot%20PagePromoter%7CSESpider%7CJakarta%20Commons-HttpClient%7CParasite%20Eliminator%7CSpinn3r%7CYandexBot%2F%7CYandexImages%2F%7CYandexVideo%2F%7CYandexMedia%2F%7CYandexBlogs%2F%7CYandexFavicons%2F%7CYandexAddurl%2F%7CYandexImageResizer%2F%7CYandexDirect%2F%7CYandexMetrika%2F%7CYandexNews%2F%7CYandexCatalog%2F%7CYandexWebmaster%2F')%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'')%20as%20robot%2C%0A%20%20%20%20%20%20%20%20replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id%20%3D%20'api%3Aresolve'%2C%20arrayFilter(x%20-%3E%20x%20!%3D%20''%2C%20arrayMap(x%20-%3E%20if(splitByChar('%3D'%2C%20x)%5B1%5D%20%3D%20'r'%2C%20splitByChar('%3D'%2C%20x)%5B2%5D%2C%20'')%2C%20extractURLParameters(url)))%2C%20page_id%20%3D%20'fapi%3Aapi'%2C%20%5BextractURLParameter(url%2C%20'name')%5D%2C%20%5B'unknown'%5D)))%2C'%5B%5Ea-zA-Z0-9%5D'%2C%20'_')%20as%20resolver%2C%0A%20%20%20%20%20%20%20%20arrayJoin(%5B'any-code'%2C%20concat(substring(toString(http_code)%2C1%2C1)%2C'xx')%2C%20toString(http_code)%5D)%20as%20code%0A)%0A%0AGROUP%20BY%20metric_ts%0AORDER%20BY%20cnt%20DESC%0ALIMIT%201)
```SQL
SELECT 
    'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, 
    count() AS cnt
     
FROM (
    SELECT
        multiply(intDiv(timestamp, 60), 60) AS metric_ts,
        quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0,
        service_partner,
        robot,
        resolver,
        code
    
    FROM market.nginx2
    
    WHERE date = today() and timestamp > now() - 60 * 60
        AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api'))
    
    GROUP BY metric_ts,
        multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner,
        replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot,
        replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver,
        arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code
)

GROUP BY metric_ts
ORDER BY cnt DESC
LIMIT 1
```


## Overall Diagnostics

### Portion #1

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #2

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resource_type, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resource_type, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resource_type, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resource_type, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, page, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, page, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, page, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #3

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, page, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.buckets.${buckets_ttlb}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resolver, code, buckets_ttlb FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(resptime_ms) < 128, 'less_128', if(roundToExp2(resptime_ms) > 16384, 'more_16384', toString(roundToExp2(resptime_ms)))) as buckets_ttlb ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.buckets.${buckets_req_time}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resolver, code, buckets_req_time FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(client_reqtime_ms) < 16, 'less_16', if(roundToExp2(client_reqtime_ms) > 4096, 'more_4096', toString(roundToExp2(client_reqtime_ms)))) as buckets_req_time ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.buckets.${buckets_handshake}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resolver, code, buckets_handshake FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(ssl_handshake_time_ms) > 64, 'more_64', toString(roundToExp2(ssl_handshake_time_ms))) as buckets_handshake ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.buckets.${buckets_bytes_send}' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, resolver, code, buckets_bytes_send FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code, if(roundToExp2(bytes_sent) < 1024, 'less_1024', if(roundToExp2(bytes_sent) > 65536, 'more_65536', toString(roundToExp2(bytes_sent)))) as buckets_bytes_send ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.rps' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, count() / 60 as value_0, service_partner, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #4

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0, service_partner, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.ttlb.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(resptime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #5

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0, service_partner, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.req_time.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(client_reqtime_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #6

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0, service_partner, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.handshake.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesTimingIf(0.5,0.6,0.7,0.80,0.90,0.95,0.97,0.99,0.995,0.997,0.999,1)(ssl_handshake_time_ms,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #7

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.total.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.splits.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.splits.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.splits.${requester}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resourceType.splits.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.dc.splits.${requester}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.host.splits.${requester}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resourceType.splits.${requester}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') as value_0, service_partner, requester, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.splits.${robot}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.dc.splits.${robot}.${dc}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, dc, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.host.splits.${robot}.${host}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, host, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, host as host, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resourceType.splits.${robot}.${resource-type}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') as value_0, service_partner, robot, resource_type, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, if(dynamic = 0 or page_id = '', 'static', 'dynamic') as resource_type, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.page.splits.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.page.splits.${dc}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, dc, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.page.splits.${host}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, host, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.page.splits.${requester}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') as value_0, service_partner, requester, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.resolver.splits.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.dc.resolver.splits.${dc}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, dc, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf( substring(host, 1, 3) in ('iva', 'man', 'vla', 'sas', 'myt'), substring(host, 1, 3), endsWith(host, 'yp-c.yandex.net'), substring(host, position(host, '.') + 1, 3), dictGetString('dc', 'dc', sipHash64(host)) <> '', dictGetString('dc', 'dc', sipHash64(host)), 'undefined_dc' ) as dc, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.host.resolver.splits.${host}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, host, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, host as host, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.requester.resolver.splits.${requester}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, requester, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, multiIf(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/') != '', 'robot', yandex_login = '', 'anonymous', 'logged-in') as requester, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```
### Portion #8

```SQL
SELECT * FROM (
    SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.page.splits.${robot}.${page}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') as value_0, service_partner, robot, page, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id != '') GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceAll(page_id, ':', '_') as page, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
    UNION ALL SELECT 'market-front-unified.nginx2.v2.${service_partner}.robot.resolver.splits.${robot}.${resolver}.${code}.metrics.bytes_send.quantiles' AS title, count() AS cnt FROM ( SELECT multiply(intDiv(timestamp, 60), 60) AS metric_ts, quantilesIf(0.5,0.7,0.9,0.95,0.97,0.99,0.995,1)(bytes_sent,environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) as value_0, service_partner, robot, resolver, code FROM market.nginx2 WHERE date = today() and timestamp > now() - 60 * 60 AND (environment = 'PRODUCTION' and url != '/ping' and service_partner != 'undefined_service' and robot != '' and page_id in ('api:resolve', 'fapi:api')) GROUP BY metric_ts, multiIf( vhost in ('partner.market.yandex.ru','partner.market.yandex.com','partner.market.yandex.ua','partner.market.yandex.by','partner.market.yandex.kz'), 'partner_desktop',vhost = 'analytics.market.yandex.ru', 'partner_analytics' , 'undefined_service' ) as service_partner, replaceRegexpAll(extract(user_agent,'Googlebot|GoogleDocs|Google-Ads-Creatives-Assistant|YaDirectBot|YaDirectFetcher|YandexRCA|YandexDirectDyn|YandexAccessibilityBot|Mail.RU_Bot|BingPreview|Mediapartners-Google|Feedfetcher-Google;|AdsBot-Google|Yahoo! Slurp|WebAlta|StackRambler|msnbot|bingbot|Aport|Mail\\.Ru/|Yandex/|Statbox/|YandexSomething/|YandexBlog/|Yandex\\.Server/|YaDirectBot|Jakarta Commons-HttpClient/|TurtleScanner|Novoteka|ia_archiver|heritrix|Twiceler-|psbot/|Alchemy Eye Agent|Echoping/|Friends/|WhatsUp/|WhatsUp_Gold/|; HttpSatPinger\\)|MSRBOT \\(http://research\\.microsoft\\.com/research/sv/msrbot/|MJ12bot/|ichiro/|TECOMAC-Crawler/|Gigabot|Sogou Push Spider|check_http/|http_ping|KeepAliveClient|SamSunf|GenHash|IRLbot|UptimeInspector|liveinternet spider|Begun Robot Crawler|InternetSeer\\.com|Refer\\.Ru Favicon Bot|Robot Semonitor|Robot PagePromoter|SESpider|Jakarta Commons-HttpClient|Parasite Eliminator|Spinn3r|YandexBot/|YandexImages/|YandexVideo/|YandexMedia/|YandexBlogs/|YandexFavicons/|YandexAddurl/|YandexImageResizer/|YandexDirect/|YandexMetrika/|YandexNews/|YandexCatalog/|YandexWebmaster/'),'[^a-zA-Z0-9]', '') as robot, replaceRegexpAll(decodeURLComponent(arrayJoin(multiIf(page_id = 'api:resolve', arrayFilter(x -> x != '', arrayMap(x -> if(splitByChar('=', x)[1] = 'r', splitByChar('=', x)[2], ''), extractURLParameters(url))), page_id = 'fapi:api', [extractURLParameter(url, 'name')], ['unknown']))),'[^a-zA-Z0-9]', '_') as resolver, arrayJoin(['any-code', concat(substring(toString(http_code),1,1),'xx'), toString(http_code)]) as code ) GROUP BY metric_ts ORDER BY cnt DESC LIMIT 1
) ORDER BY cnt DESC
```

