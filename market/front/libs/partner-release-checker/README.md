# release-checker

Скрипты автоматизации релизов ПИ.

## Проверка задач-кандидатов в релизы на формальную готовность

Скрипт ищет все задачи, которые могут быть или уже взяты в релиз ПИ, с помощью фильтра в Трекере (см. ниже). Для каждой задачи проверяется ST-тикет (статус, связанные задачи и т.д.) и его ПРы (статус, конфликты, проверки и пр.).

## Ручной запуск

<details>
<summary><strong>Установка, настройка и запуск</strong></summary>

### NodeJS

Для работы скрипта нужна NodeJS версии не ниже 16, поэтому нужно проверить свои версии node и npm:
```bash
# Должно быть v16.*.*
node --version
# Должно быть 6.от14.*
npm --version
```

Если нужно, то обновляем node, для этого нужно:
- поставить `nvm` по [официальной инструкции](https://github.com/nvm-sh/nvm#install--update-script)
- `nvm install` - установить рекомендуемую версию NodeJS командой
- `nvm use` - переключиться на рекомендуемую версию NodeJS командой

**ВАЖНО**: если у вас нода была старая, то перед каждым запуском скриптов нужно делать `nvm use`!

Если нужно, то обновляем npm (после обновления node), для этого нужно:
- `npm i -g npm@6` - поставить нужную версию npm

### Установка

Выполняем в консоли следующие команды: переходим в папку, в которую хотим положить код скрипта, клонируем репозиторий и ставим завимости.
```
cd FOLDER-TO-STORE-RELEASE-CHECKER-SOURCES
git clone git@github.yandex-team.ru:feoktistov/release-checker.git
cd release-checker
npm i
```

### Получение и сохранение OAuth-токенов

Для работы скрипта нужно получить и сохранить себе OAuth-токены для доступа к разным сервисам Яндекса по их API. Для передачи токенов в скрипт нужно прописать токены в соответствующие env-переменные (см. ниже) либо каждый раз перед запуском скрипта, либо добавив объявление этих переменных в свой `~/.bashrc / ~/.bash_profile / ~/.zshrc`.

#### OAuth - Стартрек / Staff

Получить токен можно по инструкции в [документации Трекере](https://docs.yandex-team.ru/cloud/tracker/concepts/access#section_about_OAauth).
```
export OAUTH_TOKEN="AQAD-qwe123qwe"
```

Проверяем, что токен прописан правильно:
- открываем новое окно или таб в консоли
- `echo $OAUTH_TOKEN`
- в консоль должен быть выведен токен, если он не появился, проверяем правильность его экспорта в конфиге bash/zsh

#### OAuth - Арканум (ПР в Аркадию)

Получить токен можно по инструкции в [документации Арканума](https://docs.yandex-team.ru/arcanum/communication/public-api).
```
export ARCANUM_OAUTH_TOKEN="AQAD-foo456bar"
```

Проверяем, что токен прописан правильно:
- открываем новое окно или таб в консоли
- `echo $ARCANUM_OAUTH_TOKEN`
- в консоль должен быть выведен токен, если он не появился, проверяем правильность его экспорта в конфиге bash/zsh

#### OAuth - GitHub

Получить токен можно следующим образом:
- заходим на [страницу управления токенами в GitHub](https://github.yandex-team.ru/settings/tokens)
- нажимаем на кнопку `Generate new token`
- в открывшейся форме
  - в поле `Note` вводим описание токена, например, `для релиз-чекера`
  - ставим галочки у `repo` (выберется всё поддерево), `workflow`, `notifications`
- нажимаем на кнопку `Generate token`
- появится список с выданными токенами - среди них (если были выпущены ранее) будет новый сгенерированный токен
- **ВНИМАНИЕ**: токен отображается один раз, если в следующий раз зайти на страницу, то будет показано только описание токена, поэтому токен нужно сохранить! В противном случае можно выпустить новый токен по этому же алгоритму.
- копируем токен и записываем его себе куда-нибудь, можно сразу в `~/.bashrc / etc` по аналогии с остальными токенами
```
export GITHUB_OAUTH_TOKEN="acdc7foobarb8a3531"
```

Проверяем, что токен прописан правильно:
- открываем новое окно или таб в консоли
- `echo $GITHUB_OAUTH_TOKEN`
- в консоль должен быть выведен токен, если он не появился, проверяем правильность его экспорта в конфиге bash/zsh

### Запуск

Все команды при любом своём запуске:
- перед выполнением обновляют исходники (`git pull`) и обновляют зависимости (`npm ci`), чтобы каждый запуск происходил на самой актуальной версии скрипта без ручных действий (но есть и версии команд - `{command}:cmd` - без автоматического обновления)
- в папке с исходниками скрипта создают папку `logs`, если она до этого не была создана;
- создают в папке `logs` подпапку `{command}_{timestamp}`, в которую сохраняют информацию для отладки.

В случае любых проблем с командами скрипта (ошибки / глюки / странные или нежелательные результаты / отладка и т.д.) нужно отправить разработчику или приложить в тикет на доработку скрипта архив папки с логами `logs/{command}_{timestamp}` от соответствующего запуска команды.

#### update

Команда делает:
- получает список тикетов из фильтра
- достаёт связанные с тикетами PR из GitHub
- обновляет базовые ветки этих PR по мастеру
- дожидается, когда в этих PR добегут критичные проверки (кроме code review)

**ВАЖНО**: так как команда обновляет базовые ветки для многих PR, а потом дожидается завершения критичных проверок в этих PR, то её выполнение может занять от нескольких минут до нескольких десятков минут. Во время работы команды крайне важно не блокировать ноутбук, не переключать VPN потому, что это может привести к потере сети и к экстренному завершению скрипта - его придётся перезапускать.

```bash
npm run --silent update
```

#### validate

Команда позволяет проверить тикеты из фильтра и получить готовые сообщения для отправки в Телеграм о проблемах тикетов.
```bash
npm run --silent validate
```

#### update-validate

Команда последовательно запускает команды `update` и `validate`.
```bash
npm run --silent update-validate
```

**ВАЖНО**: так как эта команда вызывает команду `update`, то к ней относятся те же предупреждения, что и к команде `update`.

</details> <!-- ## Ручной запуск -->


## Разное

### Отбор тикетов-кандидатов в релиз для проверки ...

... осуществляется с помощью объединения результатов фильтров [416059 Готовые к релизу](https://st.yandex-team.ru/issues/416059) и [424981 Тикеты в текущем релизе](https://st.yandex-team.ru/issues/424981) с борды [MARKETPARTNER Планирование релизов](https://st.yandex-team.ru/dashboard/10805).

Для проверки произвольного списка задач в любой команде можно задать свой фильтр через env-переменные `VALIDATE_RELEASE_CHECKER_FILTER` или `TICKETS`:
```bash
# Задаём произвольный фильтр трекера
$ VALIDATE_RELEASE_CHECKER_FILTER="Key: MARKETPARTNER-36275, MARKETPARTNER-36677" npm run --silent validate

# Произвольный сохранённый фильтр по его номеру
$ VALIDATE_RELEASE_CHECKER_FILTER=414771 npm run --silent validate

# Список конкретных задач - можно через пробелы и запятые
$ TICKETS="MARKETPARTNER-38052    MARKETPARTNER-38053,MARKETPARTNER-38054" npm run --silent validate
```

### Куда слать фич-реквесты и баги?

Можно в личку [разработчикам](https://github.yandex-team.ru/feoktistov/release-checker/graphs/contributors), но лучше создавать тикеты подзадачами к [мете](https://st.yandex-team.ru/MARKETPARTNER-33703). Просьба сообщать текущее и желаемое поведение, а так же прикладывать архив с логами выполнения команды для последующего использования отладочной информации из них.
