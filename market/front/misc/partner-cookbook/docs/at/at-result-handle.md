# Подготовка и разбор прогонов АТ

Сейчас разработчик должен сам разбирать прогон АТ, находить и исправлять падения АТ, связанные с правками в задаче, до передачи задачи в тестирвание. Этот алгоритм позволяет снизить нагрузку на тестировщиков. На этой странице собраны хорошие практики, грабли и прочий чужой опыт, который упростит разбор результата прогона АТ.

## После завершения разработки и прохождения code review

После завершения разработки и прохождения code review хорошей практикой является написание отдельного комментария или добавление cut-секции в описание задачи с перечислением затронутых страниц/частей ПИ/блоков.

Примеры:
- [MARKETPARTNER-17801](https://st.yandex-team.ru/MARKETPARTNER-17801)

## Перед прогоном

Перед прогоном АТ для последующего разбора хорошо бы замерджить к себе в ветку последний мастер, после чего пересобрать стенд и запустить АТ. В этом случае можно будет сравнивать свой прогон с прогонами в последних релизах честно.

## Прогон по диффектору vs полный прогон

Положиться ли на автоматический прогон по диффектору или включить полный прогон зависит от скоупа задачи - разработчик сам решает, что ему нужно в каждом конкретном случае.

## Просмотр прогресса прогона

Существует возможность отслеживать прогресс прогона, чтобы не дожидаясь окончания прогона представлять насколько всё плохо. Для этого можно зайти в логи прогона и воспользоваться букмарклетом. [Подробнее тут](https://s3.mds.yandex.net/marketfront/b2b-at/index.html)

## Разбор прогона

Получив прогон АТ, можно взять последний релиз, найти в нём последний полный прогон АТ. Нужно брать именно последний полный прогон потому, что именно он отражает тот скоуп, который был выложен на прод. Более ранние прогоны могут содержать таски, которые были оторваны от релиза - нам не нужно сравнивать свой прогон с такими прогонами.

Далее нужно сравнить свой прогон с выбранным релизным прогоном. Это можно сделать как в ручном режиме, сравнивая вручную каждое падение, так и в полуавтоматическом режиме с помощью [утилиты Артура](https://gist.github.yandex-team.ru/enload/9d818e9a40c822d098d54d66c8b89dd3). В результате разработчик получает набор тестов, падения которых уникальны для его прогона. Каждое падение должно быть разобрано отдельно.

При разборе падения теста возможны варианты:
- флап стенда или бекенда - нужно запустить тест локально или воспроизвести сценарий из тест-палма вручную;
- падение связано с тикетом - нужно чинить;
- падение, которое никак не относится к правкам из тикета - нужно найти тикет на починку этого теста:
  - в mbi-таске в разделе `Issue` - `Bugs`;
  - поиском по Стартреку по названию или ID теста из пальмы;
  - в истории [репозитория скип-пака](https://github.yandex-team.ru/market/partner-hermione-tests-config) - тикет мог быть удалён из скип-пака на днях;
  - если таск не найден, то можно попробовать пройти тест вручную.

Результаты разбора нужно зафиксировать в задаче отдельным комментарием:
- комментарий лучше делать ответом на комментарий с результатами разбираемого прогона;
- прописать номер релиза (или релизов), с прогоном которого было проведено сравнение;
- дать ссылку на отчёт прогона из релизного тикета (тикетов);
- описать все различающиеся падения:
  - привести полное название теста и, желательно, номер marketmbi-тикета;
  - если при локальном запуске или ручной проверке тест проходит успешно, то так и нужно написать;
  - если падение не связано с тикетом, и есть тикет на его починку (см. выше), то нужно приложить ссылку на этот тикет
  - если падение не связано с тикетом, но тикета на починку нет, то нужно обсудить это падение с тестировщиком;
  - если падение связано с тикетом, то так и нужно написать.

Чинить падения, связанные с тикетом, лучше после написания отчёта, чтобы по отчёту можно было понять количество затронутых АТ.

Примеры хороших разборов:
- https://st.yandex-team.ru/MARKETPARTNER-16625#5e90355ca278d72e0ce3cce6

## Починка тестов

Тесты, которые были сломаны в рамках тикета, должны быть починены в рамках того же тикета. Когда локально тесты будут проходить, коммитим, пушим и пересобираем стенд, если правки были не только в автотестах.

Для запуска исправленных автотестов нужно:
- находим Sandbox-таску **MARKET_AUTOTESTS** (таски MARKET_AUTOTESTS_HERMIONE всегда фейлятся!)
  - ищем в пайплайне любой кубик запуска АТ (полный/диффектор/перезапуск), кликаем на иконку Sandbox'а;
  - или в таске в любом комментарии про результат прогона hermione-тестов жмём ссылку "Таск", попадём в MARKET_AUTOTESTS_HERMIONE-таску, в ней нужно нажать на ссылку "Parent ID" в правом блоке, чтобы попасть в MARKET_AUTOTESTS-таску;
- в открывшейся Sandbox-таске жмём на Clone;
- в появившейся форме создания новой таски делаем:
  - очищаем "Id ресурса со списком поломанных тестов";
  - очищаем "Id ресурса со списком testpalm id";
  - проверяем, что в "Ветка", "Тестируемый хост", "Релизный тикет" прописаны правильные данные;
  - заполняем "Environment variables"
    - добавляем `HERMIONE_CASES_SELECTION` со значением `all`, если нам нужно запускать тесты из скип-пака;
    - добавляем `AUTOTESTS_HERMIONE_CASE_FILTER` для запуска только [нужных тестов](https://github.yandex-team.ru/market/hermione-suite-manager/blob/ef5d9b8ec750ebe884a78e736467f9752ceedc84/README.md#object-casefilter);
      - `AUTOTESTS_HERMIONE_CASE_FILTER` -> `{"id":"marketmbi-4144"}`
  - нажимаем "Run";
- ждём завершения прогона и отбивки в тикете;
- если все сломанные ранее тесты были починены, то в отдельном комментарии пишем об этом;
- если починены не все сломанные тесты, то начинаем починку тестов заново.

## Отсмотр прогона тестировщиком

Тестировщик при приёмке задачу на тестирование должен убедиться, что разбор прогона АТ разработчиком сделан качественно, сломанные тесты починены.

## Последующие правки

Если в процессе тестирования были обнаружены и поправлены баги, если в таск были внесены дополнительные правки, если в таск был подмержен свежий мастер, то перед взятием задачи в релиз нужно пересобрать стенд, перезапустить прогон АТ (полный или по диффектору, не перезапуск упавших) и разобрать получившийся прогон заново.

## Полезные ссылки

- [Разбор тестов в задаче от Маши Тюриной](https://wiki.yandex-team.ru/Testirovanie/FuncTesting/Market/PartnerInterface/Processy/Razbor-testov-v-zadache/)
- [Фикс тестовых данных в автотестах ПИ](https://wiki.yandex-team.ru/Testirovanie/FuncTesting/Market/PartnerInterface/Poleznye-znanija/Fiks-testovyx-dannyx-v-avtotestax-PI/)
