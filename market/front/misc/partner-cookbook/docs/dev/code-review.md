# Code review в ПИ

## Общепринятые практики

В данном документе описаны общие и частные нюансы проведения code review в ПИ.

В качестве основы берётся уже готовый опыт других компаний:
- https://google.github.io/eng-practices/review/reviewer/

## Взаимодействие автора и ревьюеров

### Оформление code review

Если в одну ветку слиты несколько MARKETPARTNER-задач, то желательно в описании ПР рассказать об этих задачах.

Если есть необходимость передать ревьюерам какие-то технические или бизнесовые детали, которые неочевидны из кода, то лучше эти детали оставить в комментариях к соответствующем местам непосредственно в коде, а не в описании/комментариях к ПР потому, что комментарии в коде будут доступны и после релиза задачи, а описание/комментарии к ПР никто потом читать не будет.

### Комментарии от ревьюеров

Желательно, чтобы ревьюер при написании комментария использовал такие формулировки, из которых однозначно понятно:
- требуются ли доработки по этому комментарию или нет
- обязательность требуемых доработок:
  - можно ли оставить код как есть и вносить правки по усмотрению автора
  - нужно ли обязательно переписать этот код
- что конкретно не так с этим кодом
- какой вариант решения проблемы будет более приемлемым

Как НЕ надо:
```
какое-то странное место, здесь точно будет работать правильно?
```

Как надо:
```
Мне кажется, что данный код будет работать в некоторых случаях не так, как ожидается потому, что бла-бла-бла. Давай перепишем это вот так: foo-bar.
```
Или:
```
У меня есть сомнения по поводу этого кода потому, что бла-бла-бла. Предлагаю переделать так-то. Но в целом это некритично, и если ты уверен, то можно оставить как есть.
```

Если ПР производится в Аркадии, то на каждый комментарии удобно создавать по issue внутри самого ПР - для этого нужно оставить включённой галочку `Open issue` (см. ниже).

### Реакция автора на комментарии ревьюеров

Желательно на каждый комментарий от ревьюеров оставить какую-то явную реакцию в виде комментария. Например:
- `Хорошее замечание, я поправлю это.`
- `Раз проблема не критична, то оставлю свой вариант.`
- `Ок, попробую твой вариант, если не получится, то оставлю свой.`
- `Здесь я не согласен потому, что ...`

Обратная связь от автора к ревьюерам важна потому, что, во-первых, без ответных комментариев есть ощущение "пишу в пустоту" и общей бесполезности процесса, во-вторых, без обратной связи непонятно, принял ли автор комментарии к сведению и ждать ли соответствующих изменений в коде. Даже если автор согласен со всеми комментариями и внёс правки в свой код, то оставить ответные комменатрии - хороший тон.

Автор ПР не должен сам выставлять статус `resolved` для веток обсуждения внутри ПР потому, что если автор ПР сам выставит `resolved`, то ревьюеру будет сложно отличить свёрнутые завершённые resolved-ветки, по которым достигнут консенсус, от тех, которые пометил завершёнными сам автор, и правки по которым ещё нужно посмотреть ревьюеру - придётся раскрывать ветки и вспоминать, к чему пришли по каждой из них.

Хорошим тоном так же будет являться ответный комментарий со ссылкой на коммит, в котором автор внёс изменения в код. Например,
```
Поправил в ad54e45
```
Ссылка на комментарий позволяет ревьюеру, во-первых, понять, что по его комментарию сделаны правки, во-вторых, быстро перейти к соответствующим правкам. Без ссылки на коммит ревьюеру приходится идти в дифф ПР, искать там для каждого комментария нужный файл и анализировать изменения в нём.

После внесения всех изменений и ответов на все комментарии автор может написать комментарий `/fixed`, чтобы отправить ревьюерам сообщение с приглашением вернуться к этому ПР.

### Реакция ревьюеров на комментарии автора

Если ревьюер удовлетворён реакцией автора, и коммуникация по конкретному комментарию закончена, то

#### в GitHub

В GitHub можно нажать на `Resolve conversation`, тем самым переведя ветку в состояние `resolved` вместо `outdated` или состояния по умолчанию.

При использовании состояния `resolved` есть профит и для автора, и для ревьюеров потому, что такие ветки сворачиваются, не мешают просмотру диффа/списка комментариев и их можно смело пропускать, сосредоточившись на открытых или `outdated`-ветвях.

#### в Аркадии

При написании комментария удобно оставлять включённой галочку `Open issue`. В этом случае все треды комментариев будут видны в ПР в секции `Issues`. При завершении коммуникации ветку можно пометить как `Resolved` или `Dropped`, чтобы не обращать на неё больше внимание при обработке ПР.

### ok или не ok?

Если ревьюер считает свои замечания некритичными, и ПР можно катить в прод без исправлений, то ревьюер апрувит ПР. Автор ПР исправляет замечания по своему усмотрению, но желательно по каждому замечанию отписаться о принятом решении (будет ли исправляться).

Если ревьюер считает свои замечания критичными, то он должен пометить ПР как требующий доработок. Если в этом случае оставлено несколько замечаний, то хорошим тоном со стороны ревьюера будет в каждом замечании упомянуть его критичность (например, `major` / `minor`). Для автора ПР `major` значит "критично, нужно поправить", а `minor` - "некритично, можно оставить как есть".

### ok, ok, не-ok

Формально code review считается пройденным, если ПР "окнули" 2 (GitHub) или 1 (Аркадия) человек. Если же нужное количество ok'ов набрано, но дополнительный ревьюер оставил свои комментарии, то желательно учесть их и переходить к следующему этапу жизненного цикла задачи только после получения ok'а от этого дополнительного ревьюера.

## На что смотреть при проведении code review

To Be Developed ...
