# Работа с динамическими настройками

## Бункер

Бункер является сервисом быстрого редактирования и деплоя JSON-файлов и другой статической информации.

В интерфейсе Бункера можно отредактировать JSON руками или через форму, сгенерированную по JSON-схеме, а потом нажатием одной кнопки сделать новый JSON доступным для чтения из работающего приложения. Таким образом, в Бункер можно вынести настройки, которые влияют на поведение ПИ, и менять эти настройки через Бункер с мгновенным примением без необходимости делать релиз ПИ.

[Бункер](https://bunker.yandex-team.ru/)

Бункер живёт на поддержке, баги фиксятся, сервис обслуживается, но ресурсов на его дальнейшее развитие нет, поэтому в какой-то момент может оказаться, что Бункер перестал работать, и срочно нужно мигрировать на другой инструмент.

## Как было

Первоначально работа с динамическими настройками была сильно завязана на Бункер - вызов к Бункеру и работа с настройкой были в одном месте:
```javascript
const fields = await bunker(partnerContext, ['hotsettings']);
const useSafeLink = fields.hotsettings.value['pages.dropship-wizard:useSafeKZLink'] || false;
const fosLink = useSafeLink ? fields.hotsettings.value['pages.dropship-wizard:FOSLinkForKz'] : '';
```

### Проблемы старого подхода

#### Значение по умолчанию

Значение настройки по умолчанию необходимо было писать там же, где читается нужная настройка. Таким образом, если настройка используется в двух местах, то приходится дублировать значение настройки по умолчанию.

#### Отсутствие типизации

Задание типа данных, лежащих в настройке, необязательно, что поощряет разработчиков пропускать типизацию при работе с настройкой.

#### Тесная связь с Бункером

Так как обращение к Бункеру и работа с настройкой находятся совсем рядом, то переезд с Бункера на другой инструмент будет довольно болезненным.

#### hotsettings

Работа с настройками ПИ в Бункере сейчас никак не регламентирована - большинство кладёт настройки в секцию `hotsettings`, кто-то создаёт свои отдельные ветки. Хотелось бы внедрить единый подход, чтобы каждая настройка жила в своей собственной песочнице. К тому же хранение всех настроек в одном разделе в Бункере в будущем осложнит редактирование настроек из-за роста JSON'а.

P.S.: настройка hotsettings была удалена из кода ПИ в https://st.yandex-team.ru/MARKETPARTNER-18591 , здесь упоминание осталось лишь для истории и понимания контекста проблем.

#### Отсутствие деления на дев/тест/прод

Тестовую среду Бункера использовать не получится из-за workflow разработки самого Бункера, поэтому настройки по факту имеют только одно значение - для продакшена. Если нужно для дева/теста выставить другое значение настройки, но при этом не изменяя значение настройки для продакшена, то приходится колдовать с циклом сохранения-публикации и просить остальных разработчиков не публиковать настройки Бункера.

## API для настроек

API для настроек предлагает новый слой абстракции между бизнес-кодом и сервисом хранения/раскатки настроек (в нашем случае - Бункером).

### Решения прежних проблем

- при описании своей настройки теперь обязательно нужно будет указывать тип настройки и значение по умолчанию
- работа с Бункером скрыта внутри API - переезд с Бункера значительно упростится
- каждая настройка теперь живёт в своё разделе в Бункере
- возможность задать отдельное значение для каждой из сред - дев/тест/прод

### Бункер

Сам по себе этот API не отвязывает ПИ от Бункера - Бункер по-прежнему остаётся сервисом для хранения/редактирования/распространения настроек. Но переход на этот API позволит в будущем мигрировать на другой сервис, не затрагивая бизнес-код - нужно будет только перенести настройки и дополнить код API.

### Код

Весь код API для настроек лежит в [b2b-core/b2b-core/shared/utils/settings](https://a.yandex-team.ru/arc_vcs/market/front/libs/b2b-core/b2b-core/shared/utils/settings/index.ts).

### Пример

Здесь описан простой пример использования API для настроек. Более сложный пример можно найти в коде, например, для синей регистрации:
- [тип, описывающий настройку](https://a.yandex-team.ru/arcadia/market/front/apps/partner/shared/pages/SupplierSignUp/types.ts?rev=63a43fcde8b257bc10d8001e0d3e8bfd58d02c2a#L45)
- [генерация геттера настройки](https://a.yandex-team.ru/arc_vcs/market/front/apps/partner/shared/pages/SupplierSignUp/settings.ts?rev=63a43fcde8b257bc10d8001e0d3e8bfd58d02c2a#L5)

Начнём.

В shared-папке своей страницы или модуля нужно создать тип, который описывает настройку:
```javascript
// shared/page/FooBar/types.js

export type Setting = {
    foo: string,
    bar?: boolean,
};

// ...
```

В app-папке своей страницы или модуля нужно создать отдельный файл **settings.js**, в котором экспортировать результат работы фабрики из модуля API настроек, задав тип настройки, её имя в Бункере и значение по умолчанию:
```javascript
// @flow

import type {Setting} from 'shared/page/FooBar/types';
import {settingsFactory} from '@yandex-market/b2b-core/shared/utils/settings';

export const getSetting = settingsFactory<Setting>({
    settingName: 'foo-bar',
    defaultValue: {
        foo: 'HOORAY!!!',
    },
});
```

В месте использования настройки нужно подключить файл `settings.js` и вызвать функцию получения значения настройки. В результате будет получено текущее значение настройки для текущей среды, в которой запущено приложение:
```javascript
// ...
import {getSetting} from './settings';

    // ...
    const setting = await getSetting(stoutContext);
    if (settings.bar) {
        // do something special :)
    }
    // ...
```

### Заведение новой настройки в Бункере

- заходим в раздел [market-partner в Бункере](https://bunker.yandex-team.ru/market-partner)
- выбираем раздел `Settings`
- нажимаем на иконку шестерёнки у раздела `Settings` и выбираем `Create node`
- в появившемся модальном окне вводим имя новой настройки, нажимаем на `Create`
- ждём создания настройки, если новая настройка не выбрана автоматически, то выбираем её
- в `MIME-тип` выбираем `application/json - Произвольный JSON`
- в `Контент` вставляем базовую схему настройки
  ```json
  {
    "common": {},
    "development": {},
    "testing": {},
    "production": {}
  }
  ```
- нажимаем на `Сохранить`

### Уровни переопределения настройки

В базовой схеме настройки есть четыре уровня:
- `development` - локальные запуски и логрусы;
- `testing` - БТ демо-стенды;
- `production` - prestable и production;
- `common` - общие значения.

В момент вычисления значения настройки происходит мердж объектов из значения от среды исполнения и common-части (у common-части наименьший приоритет). По умолчанию происходит [глубокий мердж](https://ramdajs.com/docs/#mergeDeepRight), но можно включить и [поверхностный мердж](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Object/assign).

Пример глубокого мерджа:
```javascript
const bunkerValue = {
    common: {foo: 'common', bar: 'common', nested: {a: 'A-COMMON', b: 'B-COMMON'}},
    development: {foo: 'development'},
    testing: {bar: 'testing', baz: 'testing', nested: {a: 'A-TESTING'}},
    production: {baz: 'production'},
};

// Значение для testing - часть ключей внутри nested осталась от common,
// а часть переопределилась от testing.
const deepMergedValue = {
    foo: 'common',
    bar: 'testing',
    baz: 'testing',
    nested: {a: 'A-TESTING', b: 'B-COMMON'},
});
```

Пример поверхностного мерджа:
```javascript
const bunkerValue = {
    common: {foo: 'common', bar: 'common', nested: {a: 'A-COMMON', b: 'B-COMMON'}},
    development: {foo: 'development'},
    testing: {bar: 'testing', baz: 'testing', nested: {a: 'A-TESTING'}},
    production: {baz: 'production'},
};

// Значение для testing - ветка nested полностью взята из значений для testing.
const assignValue = {
    foo: 'common',
    bar: 'testing',
    baz: 'testing',
    nested: {a: 'A-TESTING'},
};
```

Глубокий мердж включен по умолчанию, поверхностный мердж можно включить через параметр `envDeepMerge`, задав `false` при вызове фабрики настроек:
```javascript
export const getSetting = settingsFactory<Setting>({
    settingName: 'foo-bar',
    defaultValue: {
        foo: 'bar',
    },
    envDeepMerge: false,
});
```

### Бункер и режим редактирования через форму на основе JSON-схемы

Одна из классных фич Бункера - построение форм редактирования JSON по заданным JSON-схемам. Разработчик пишет JSON-схему для своей настройки, затем загружает её в Бункер, после чего, например, вместо ручного прописывания `true / false` для boolean-значений достаточно будет кликнуть на чекбокс на форме.

API настроек поддерживает редактирование настроек через формы, построенные по JSON-схеме, но при этом перестаёт работать режим переопределения настроек. Проблема в том, что для каждого поля появляется значение по умолчанию, которое при первом сохранении будет вписано в JSON настройки.

Например, настройка состоит из двух полей (`{foo: boolean, bar: string}`), настройка ещё не редактировалась ни разу, её значение для каждого уровня пусто - `{}`. Разработчик изменяет значение только `foo`-поля кликом по чекбоксу, жмёт на `Сохранить`. Бункер возьмёт из `input` текущее значение для `bar`-поля - пустую строку - и сохранит её в JSON. Таким образом, настройка будет иметь значение `{foo: true, bar: ''}`. Получаем, что на каждом уровне переопределения в настройке заполнены все поля значениями по умолчанию из редактора JSON'а Бункера. Переопределение уровней перестаёт работать.

Если переопределение уровней не нужно, то можно:
- задать в фабрике настроек `envDeepMerge: false`, чтобы глубокий мердж не создавал неожиданных спецэффектов в будущем;
- ознакомиться с [туториалом по JSON-схемам](http://json-schema.org/understanding-json-schema/), при этом учесть, что
  - Бункер поддерживает старый драфт 03;
  - ссылки строятся через `#/path/from/root` от корня схемы - см. ссылки в схеме ниже;
  - хотя в Бункере рекомендуют для схем использовать имя узла `.schema`, лучше использовать имя без точки `schema` - ноды с точкой в названии скрываются в UI и доступны только по прямому урлу;
- создать настройку в Бункере по инструкции выше;
- для созданной настройки создать под-ноду `schema`
- для ноды `schema` выбрать в `MIME-тип` значение `application/schema+json; charset=utf-8; schema="bunker:/.schema/base#"`
- взять шаблон и дополнить его описанием своей настройки:
  ```json
    {
        "id": "bunker:/market-partner/settings/YOUR-SETTING/schema#",
        "definitions": {
            "setting": {
                "type": "object",
                "$comment": "Свою настройку описывать нужно здесь в properties!",
                "properties": {
                }
            },
        },
        "$comment": "Эту часть схемы трогать нельзя - на неё завязано получение настройки через API!",
        "type": "object",
        "properties": {
            "common": {
                "$comment": "Настройки по умолчанию",
                "$ref": "#/definitions/setting"
            },
            "development": {
                "$comment": "Настройки для разработки (логрусы)",
                "$ref": "#/definitions/setting"
            },
            "testing": {
                "$comment": "Настройки для тестинга (демо-стенды, БТ, престейбл)",
                "$ref": "#/definitions/setting"
            },
            "production": {
                "$comment": "Настройки для production",
                "$ref": "#/definitions/setting"
            }
        }
    }
  ```
- в поле `id` в JSON-схеме вставить имя своей настройки
- сохранить
- вернуться в ноду своей настройки
- в `RAW`-режиме в `MIME-тип` выбрать `application/json; schema="bunker:/path/to/schema" - JSON по схеме`, в `bunker:/path/to/schema` прописать `id` своей схемы
- сохранить и перейти в режим `Normal` - должна отобразиться форма редактирования настройки

### Сохранение и публикация настроек в Бункер

При применении настроек нужно учитывать, что
- при нажатии на `Сохранить` новое значение настройки раскатывается на дев (логрусы) и тест (БТ и демо-стенды);
- при нажатии на `Опубликовать` последнее сохранённое (**!**) значение настройки раскатится на прод;
- раскатывание настроек после нажатия на `Сохранить` или `Опубликовать` происходит с небольшой задержкой (до пары минут) потому, что перед Бункером стоит кеширующий nginx.

Правильный алгоритм изменения настроек в Бункер:
- вносим изменение в настройку;
- нажимаем на `Сохранить`, ждём успеха сохранения настройки;
- нажимаем на `Опубликовать`, ждём успеха публикации настройки - желательно делать этот шаг даже тогда, когда меняются только `testing / development` ветки потому, что в следующий раз при правке ветки `production` ты можешь забыть нажать на `Опубликовать`, последствия чего легко представить, поэтому формируем полезную привычку и не надеемся на "ну со мной такого никогда не произойдёт".

**ВАЖНО:** если настройка ни разу не публиковалась, то на проде Бункер будет отвечать 404 при попытке получить значение настройки, в качестве значения настройки будет использовано значение по умолчанию, указанное в коде при вызове фабрики настроек. Чаще всего ничего страшного не произойдёт потому, что значение по умолчанию как раз позволяет ПИ не падать, если Бункер не отдал значение настройки по каким-то причинам. Но ошибки обращения к Бункеру будут писаться в логи и маячить на радарах, что рано или поздно станет заметно дежурным, и они попросят таки опубликовать настройку.

### Безопасность при работе с настройками

Если настройки требуется передавать на клиент, то нужно подумать, безопасно ли передавать настройки на клиент как есть. Например, если в настройке фигурирует список логинов, то, вероятно, этот список логинов не нужно передавать клиенту, чтобы его нельзя было "подсмотреть" из Dev Tools. Тогда лучше провести вычисления на сервере, а на клиент передать результат вычислений, не передавая сам список логинов.
