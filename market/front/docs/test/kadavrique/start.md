# Начало работы с Кадавриком

Данный раздел посвящен тому, как начать развернуть приложение для дальнейшей доработки моков/исходного кода приложения в целом.

Если вам необходимо просто прогнать тесты, натравив их на какой-либо Кадаврик, то данный раздел можно пропустить (по умолчанию автотесты сходят в один из уже развернутых инстансов приложения).

## Где разворачивать приложение

На начальном этапе разработки мока приложение можно развернуть и локально. Однако стоит помнить, что с локальных машин разработчиков доступов до многих бэкендов нет, поэтому в дальнейшем, при необходимости прогона тестов с вашим Кадавриком - стоит его развернуть на [логрусе](https://docs.yandex-team.ru/marketfront/getting-started/logrus).

## Развертывание и запуск приложения

**Важно! Установку Кадаврика и запуск сервера нужно производить под NodeJS v16!**

1. В примаунченой Аркадии перейти в `market/front/apps/kadavrique`. В случае логруса сделать `svn checkout svn+ssh://arcadia.yandex.ru/arc/trunk/arcadia/market/front/apps/kadavrique` или `git clone https://git@git.arc-vcs.yandex-team.ru/kadavrique`. Если git clone на логрусе попросит пароль - можно указать токен [отсюда](https://wiki.yandex-team.ru/sdc/sdc-arcadia-tier-1/usage-of-arcadia-git-compat-mode).
2. Указать порт (на логрусе он должен быть свободен) приложения: `export kadavr_port=8089`. Альтернативно порт можно указать через CLI сервера в параметре `--port`.
3. `npm run bootstrap`
4. `npm run build`
5. `npm start`. По умолчанию при старте приложение в логи ничего не пишет, можно это поменять, сделав перед запуском `export NODE_ENV=development`.
6. Проверить кадавр можно, открыв в браузере адрес (и подставив свой логрус и порт): [http://logrus01hd.market.yandex.net:8089/ping](http://logrus01hd.market.yandex.net:8089/ping). В случае старта на локальной машине - достучаться можно через [http://localhost:8089/ping](http://localhost:8089/ping).

## nodemon

Если хочется перезапускать приложение после изменения js кода, можно сделать так:

```bash
npm run dev
```

В приложении есть и ts код, который следует транспилить в js через `npm run build` или `npm run watch`. Nodemon при транспиляции может зависнуть.

## Отладка

Debug режим можно запустить так (порт можно поставить любой свободный):
```bash
node --inspect=:::8088 ./bin/kadavr.js start
```

Далее нужно настроить дебаггер на локальной машине.

Можно воспользоваться своим любимым или выбрать один из распространенных, например из IDEA/WebStorm. Самый простой вариант - запустить приложение командой выше через консоль IDEA/WebStorm и кликнуть по ссылке `Debugger listening on ws://[::]:8088/...`

Также можно подключиться дебаггером из DevTools. Для этого следует открыть вкладку по адресу `browser://inspect/#devices` и кликнуть по ссылке `Open dedicated DevTools for Node`. В открывшемся окне во вкладке `Connection` нажать кнопку `Add connection` и добавить хост сервера и порт дебаггера.

## Debug proxy

У приложения есть debug proxy, которое позволяет логгировать каждый запрос, проходящий через него. [Подробнее об этом](https://a.yandex-team.ru/arcadia/market/front/apps/kadavrique/debug-proxy/README.md)

## Альтернативные виды запуска

Если не предполагается изменение исходного кода Кадаврика - можно поискать его в зависимостях фронтового приложения. Например, у маркетфронта можно запустить его так:
```bash
node_modules/.bin/kadavr start -- --port=10000
```

Однако стоит помнить, что код приложения в зависимостях фронта может отставать от транка.


## Запуск во многопоточном режиме

Автотест может проходить локально, но падать на CI. Чтобы сымитировать Кадавр на CI, его можно запустить локально во многопоточном режиме.

1. Задать пароль: `export REDIS_PASSWORD=secret` (настоящий у @smelukov)
2. Запустить: `npm run start-cluster -- --workers=10`
