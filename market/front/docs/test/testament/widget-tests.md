# Виджетные тесты

[Apiary](https://a.yandex-team.ru/arc_vcs/market/front/monomarket/lib/lib/apiary/)-виджет – это композиция из контроллера, контейнера (вьюхи), редьюсера, эпика, главного файла index, и всех хелперов/резолверов/селекторов которые вызываются в виджете.

Взаимодействие этой связки и покрывает виджетный тест.

Тестируется только логика виджета, изолируя его от родительских виджетов и походов в сеть (мокая ресурсы или резолверы).

**Виджетные тесты помогают проверить, что:**

- генерируется верная разметка
- генерируются верный стейт
- виджет ожидаемо ведет себя на клиенте

## Типичный виджетный тест

- замокали все что необходимо
- подготовили данные для виджета
- смонтировали виджет
- симулировали действия пользователя
- сделали утверждения

## Какие виджеты тестируем

Тестируем только конечные виджеты.
Что это означает? Каждая страница маркета - это большой страничный виджет, в который складываются виджеты поменьше. Допустим, на страничном виджете
КМ (Карточке Модели) Есть ДО (Дефолтный Оффер), ТОП6, Галерея, ну и так далее. ДО - это конечный виджет, который удобно тестировать в полной изоляции.

> Не следует писать тесты под страничные виджеты, это уже задача hermione тестов

## Как определить, подходит ли тесты для переноса с hermione на testament

Идеально для переноса подходят тесты, в которых все проверки проходят в одном
виджете без смены страниц и открытия новых вкладок.
Если нужно протестировать какой-нибудь сценарий взаимодействия нескольких виджетов
(даже на одной странице), то лучше использовать гермиону, чтобы не затаскивать
в пайплайн огромные деревья виджетов.

### Примеры кейсов, которые должны писаться на Testament

- виджетом рендерится такой-то текст
- в рендере виджета присутствует такой-то элемент
- по клику на кнопку/ссылку происходит такое-то действие
- во вьюху виджет прилетает правильный стэйт

### Когда не следует писать на Testament

- Если выходим за рамки тестируемого виджета. Тестируем не конкретный виджет, а взаимодействия виджетов. Как правило, это сценарий поведения пользователя на странице. В таких кейсах нужно писать тест e2e.
- Если ходим по разным страницам. Например, зашли на карточку, положили что-то в корзину, перешли в корзину, ожидаем что там будет нужный товар.

> Проверяем именно поведение конкретного виджета на замоканных данных. Мокаем все внешние зависимости. Виджет максимально изолирован и не зависит от соседних/родительских виджетов.

## Как запустить тесты локально

В платформенной папке лежит скрипт для запуска тестов `test:testament`, соответственно тест можем запустить командой:
```
platform.desktop$ npm run test:testament _путь_до_файла_теста_
```

```
platform.touch$ npm run test:testament _путь_до_файла_теста_
```

Запуск тестов производим из платформенной папки. В том числе и тестов, находящихся в `/src`
Если не указывать путь до теста, запустятся все тесты.

Скрипт запуска тестов осуществляет поиск так:
* Для `src/` и `market/src/` по шаблону `*.desktop.testament.spec.js` или `*.touch.testament.spec.js` в зависимости от платформы
* Внутри платформенных папок по шаблону `*.testament.spec.js` и `*.desktop.testament.spec.js` или `*.touch.testament.spec.js` в зависимости от платформы

В Маркете виджетные тесты настроены так, что из основного процесса jest недоступны контроллеры, и резолверы. Это сделано для ускорения прохождения тестов.
