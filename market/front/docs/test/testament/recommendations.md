# Правила по написанию тестов

Тут собраны основные принципы по написанию тестов на Testament.

## Подход к написанию тестов

* Текущий подход к мокам в тестах - моки кадавра. Альтернативно - моки ресурсов. Это позволит протестировать и бизнес логику виджета, которая может находиться в используемых им резолверах.
* Лучше разбить тесты на несколько файлов, чем сделать один файл с тестом больше чем на 100+ строк.
* Каждый файл с тестом должен быть коротким и читаемым. Не стоит выносить моки или тест-кейсы в отдельные файлы, если в этом нет острой необходимости.

## Куда класть и как называть

* Тест кладем в папку `__spec__` внутри папки тестируемого виджета. В этой же папке складываем моки, лучше в подпапку `__mocks__`
* Для `src/` и `market/src/` тесты называем по шаблону `*.desktop.testament.spec.js` или `*.touch.testament.spec.js` - это даст возможность запускать тесты с нужным окружением.
* Внутри платформенных папок тесты можно называть по шаблону `*.testament.spec.js`, но лучше также: `*.desktop.testament.spec.js` или `*.touch.testament.spec.js`

## Кадавр

* Походы в сеть в кадавре выключены, используются только существующие в нем моки. Это позволяет держать testament тесты стабильнее, лишая их сетевого фактора.
* Допускается создание моков для ресурсов. Менее желательны моки резолвера (см. ниже).

## Что и как мокать

Обычно тест пишется по принципу "от контроллера". Как правило, это означает: "проходим визуально по контроллеру виджета и просматриваем какие резолверы он дергает". Какие-то из этих резолверов пойдут за ресурсами (зачастую со сложной логикой, через другие резолверы). Ответ от сервера, который придет в ресурсы и затем в резолверы, необходимо замокать через кадавр-слой. У нас нет цели сделать так, чтобы testament-тест виджета тестировал ресурсы или резолверы, __для них пишутся свои unit-тесты__.

Рассмотрим типичную ситуацию. У нас в контроллере вызывается `resolveValueA(ctx)`. resolveValueA в свою очередь дергает по какой-то условной логике `resolveValueB(ctx)` либо `resolveValueC(ctx)`, а эти резолверы в свою очередь дергают ресурсы `fetchValueA()` и `fetchValueB()` соответственно. Тут можно поступить несколькими путями (один из вариантов):
- [замокать](moving.md#primer-perevoda-testa) ресурсы fetchValueA и fetchValueB на уровне [kadavrLayer](layers/kadavr.md) (мы не пойдем в сеть)
- [замокать](helpers.md#dlya-mokov-resursov) ресурсы fetchValueA и fetchValueB на уровне [jestLayer](layers/jest.md) (мы не пойдем в сеть)
- [замокать](mocks.md#mok-rezolvera) резолверы - в крайнем случае, если при kadavr моках/моках ресурсов возникли блокирующие проблемы или если первичный резолвер, который вызываем прямо из контроллера, "очень большой" и содержит множество условной логики и вызовов других резолверов и ресурсов.

> ⚠️ Самым правильным подходом будет мок ресурсов на кадавре. Так мы протестируем виджет в полной интеграции.

Вот [тут](moving.md#osobennosti-i-izvestnye-problemy) можно почитать про типичные проблемы при разработке тестов на Testament, с которыми вы скорее всего столкнетесь.

