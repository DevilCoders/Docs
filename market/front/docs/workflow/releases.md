# Релизы

## До сборки релиза
В релиз по умолчанию собираются только тикеты в статусе "Ждёт релиза" (см. доку Тестирование).
Тикеты в других статусах попадают в релиз в исключительных ситуациях.

Тикет попал в релиз если у него в поле "Исправить в версиях" появилась версия релиза (вида 202X.XXX.X)

Один тикет - один открытый опубликованный PR.

Тикеты не из очереди MARKETFRONT не могут попасть в релиз, т.к. релизы собираются по фикс-версии, а фикс-версии у разных очередей разные.

## Сборка релиза
Берутся все опубликованные PRы связанные с тикетами из фикс-версии релиза

Сортируются по возрастанию номера пулл-реквеста

Отводится релизная ветка от транка

Из каждого пулл-реквеста последовательно черрипикаются все коммиты

Если есть конфликт, черрипики из этой ветки отменяются и тикет оторвут от релиза.

Если упали обязательные проверки в CI пулл-реквеста - тикет оторвут от релиза. По умолчанию берутся все проверки с `disabling_policy: "denied"`, вайтлист и лист доп. проверок можно настроить в ЦУМе. Названия проверок для настройки в ЦУМе нужно копировать из поля type в ответе апи арканума, [пример](https://a.yandex-team.ru/api/v1/review-requests/2435627?fields=checks).

Решать конфликты в релизной ветке нельзя, т.к. арк не позволяет коммитить в чужие ветки.

Конфликт может быть с транком, его может быть не видно в самом пулл-реквесте, поэтому если оторвали - лучше сразу ребейзнуть ветку на свежий транк.

Если тикет попал в релиз - трогать ветку тикета можно только по согласованию с релиз-мастером! Потребуется пересборка релиза и релиз-мастеру нужно об этом знать.

## Меня позвал ЦУМ в релизный чат! Что делать?

Шаг 0: Прочитай сообщение ЦУМ-бота. Осознай. При необходимости повтори Шаг 0.

В целом в сообщении ЦУМа уже есть инструкция, но вот более подробная и с объяснениями:

### ЦУМ ругается на непрошедшие обязательные проверки!
![](https://jing.yandex-team.ru/files/lengl/uhura_2022-06-08T11%3A31%3A52.850801.jpg)

Открой свой PR и переключись на вкладку Required. На этой вкладке должны быть зелёными (пройдено) или серыми (пропущена):

![](https://jing.yandex-team.ru/files/lengl/uhura_2022-06-08T11%3A39%3A41.719774.jpg)


#### 1. Проверка "Код-ревью"
  - Проверка зеленеет, когда есть два шипа. Учитываются только шипы от людей с ролью "Разработчик интерфейсов" в ABC фронта маркета. [Ссылка на IDM](https://nda.ya.ru/t/P49CnMA558xGAv).
  - Если ты можешь шипать PRы - тебя будет призывать их ревьюить, только так.
  - Если тебе нужна роль "разработчик интерфейсов", но ты не хочешь ревьюить PRы - закажи роль "Не ревьюер". [Ссылка на IDM](https://nda.ya.ru/t/YP6Yh9zo58xGuF). Но и шип твой учитываться перестанет.

#### 2. Проверка Task Linked
  - Зеленеет, когда хоть какой-нибудь тикет указан в связях PRа. Для фронта - важно, чтобы тикет был в связях ровно один.
  - ![](https://jing.yandex-team.ru/files/lengl/uhura_2022-06-08T11%3A46%3A46.760916.jpg)

#### 3. Все проверки с замочком
  - Это самые разные проверки фронта: линтеры, юнит-тесты, бандлы, сборка, и т.д. и т.п.
  - Подробнее про них написано в разделе CI: [{#T}](../ci/index.md)

{% note warning %}

Проверка `market/front/apps/marketfront: Жди релиза [Может снять дежурный]` ДОЛЖНА быть красной.

Это специальная проверка, которая не даёт мёржить код напрямую в транк и позволяет катить его только через релиз.

Если код всё-таки надо замёржить в транк мимо релиза - проверку могут скипнуть факап-дежурные фронта или @lengl.

{% endnote %}

### ЦУМ ругается на конфликты!
![](https://jing.yandex-team.ru/files/lengl/uhura_2022-06-08T16%3A25%3A55.240877.jpg)

Тут есть несколько вариантов:

#### 1. Тикет, с которым конфликт, уже заехал в транк

Тогда в своём PRе ты увидишь, что проверка на конфликт с транком покраснела.

![](https://jing.yandex-team.ru/files/lengl/uhura_2022-06-08T11%3A57%3A40.781162.jpg)

Что делать:

`arc pull trunk && arc rebase trunk`. Ребейзишь ветку на свежий транк, решаешь конфликты, коммитишь, пушишь, заезжаешь в следующий релиз.

#### 2. Тикет, с которым конфликт, ещё не заехал в транк

Вы ничего сделать не можете. Всё.

Просто ждать пока тикет, у которого номер PRа меньше и с которым у вас конфликт - заедет в транк

И потом ребейзиться и решать конфликты в своей ветке.

{% note info %}

В некоторых случаях проверка на конфликт может быть зелёная, а тикет всё равно ругается на конфликт.

Иногда такое происходит, когда у двух веток были общие коммиты, и одна из них заехала раньше.

Если вы знаете что у вас с кем-то общие коммиты (даже возможно с самим собой) - лишний раз ребейзнуться не помешает.

{% endnote %}

## Мой тикет опять оторвали!!!!!1
Это нормально, теперь живём так. Не собралось - не поедет.

Если отрывали из-за конфликта три раза или меньше - это норм. Не ходите и не кричите, пожалуйста. У вас будет приоритет на следующем мерже, с большой долей вероятности за 4 релиза вы всё-таки попадёте в релиз.

Если отрывали из-за конфликта пять раз или больше - ставьте тикету "СОЛО" или приходите в релизный чат.

Есть автоматика, которая считает сколько раз тикет был оторван. Мы такие тикеты видим и реагируем на них, не надо пушить, пожалуйста.

## Почему тикет могут оторвать от релиза
- Тикет ломает автотесты
- Тикет ломает функциональность сервиса
- При выкладке в прод обнаружены проблемы на графиках, локализованы до тикета

В этих случаях тикет перейдёт в статус "Есть замечания" и фикс-версию в поле "Исправить в версиях" уберут.
Обычно в комментариях указываем, за что оторвали тикет.

### Завершение релиза
Когда релиз выложен на прод и в нём нет видимых проблем - релиз завершается.

В релизном пайплайне кубик завершения релиза пройдёт по всем пулл-реквестам тикетов в релизе в таком же порядке как при мерже в релизную.

Робот проверяет PR, что последний пуш в ветку был до того, как собралась релизная ветка (что в ветку не допушили ничего после начала релиза)
Если есть новые коммиты - робот пропускает эту ветку и уведомляет релиз-мастера, такая ветка должна ехать повторно в одном из следующих релизов.

Если новых коммитов нет - робот мёржит пулл-реквест в транк


## Памятка релиз-мастеру

[Актуальный гайд по релизам](https://wiki.yandex-team.ru/Market/frontend/FAQ-по-релизам-для-PM/)

### Что поменялось в релизах при переезде git->arc:

#### 1. Ребейзить фича-ветку от другой фича-ветки в релизе или от релизной ветки - нельзя!
Это всё равно что подлить чужую или релизную ветку к себе в гите. Ведёт к катастрофическим последствиям если вы не понимаете ТОЧНО что вы делаете и зачем.

В гите в целом тоже было "нельзя", но регулярно встречались с таким, поэтому ещё раз подсвечиваем это.

#### 2. Конфликты в конфликтующих ветках решать в релизе нельзя.
Всё, что не смёржилось из-за конфликтов - идёт в отрыв. Только дождаться пока один тикет заедет и после этого ребейзить другой тикет на транк.

Это значит, что тикеты которые трогают горячие куски маркета (или обновляют пакеты) могут ловить конфликты несколько релизов подряд. Инфра сделала так, чтобы тикеты в релиз мёржились всегда в одном и том же порядке, по возрастанию номера пулл-реквеста, поэтому рано или поздно тикет заедет. Но всё равно стоит присматривать за такими тикетами.

#### 3. Если после сборки релиза обнаружилась какая-то проблема, решать её разработчик может только в своей ветке.
Если проблема из-за конфликта со свежим транком - разработчик может ребейзнуть свою ветку и починить проблему у себя, после чего релиз надо пересобрать с нуля.

Если же конфликт двух тикетов в релизе, то один из тикетов надо отрывать.

#### 4. Тикеты теперь всегда мёржатся в одном и том же порядке

Сделали так, что перед сортировкой пулл-реквесты сортируются по возрастанию номера PR.
Поэтому даже если тикет 1-2 раза отрывался от релиза из-за конфликтов, то у него будет приоритет при мерже в дальнейшем (т.к. номер его PR будет меньше других)

#### 5. Изменился процесс мёржа тикетов/релизной ветки в транк.
В транк будут мёржиться фича-ветки по одной.

Робот будет мёржить эти PRы и выставлять им label релиза, в котором PR был выкачен.

Если разработчик что-то накоммитил в ветку после того как она была вмёржена в релизную - оно никуда не уедет.
