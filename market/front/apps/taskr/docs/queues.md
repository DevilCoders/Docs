# Taskr Queues

На данный момент есть два основных типа очередей:
- Рекурретная очередь (RecurrentQueue)
- Очередь на деплой (DeployQueue)

## RecurrentQueue

Очередь задач, которые должны выполняться с определенной периодичностью.
Основной юзкейс – проверить актуальность данных в каком-либо источнике, и при необходимости обновить кеш (например, S3).
Однако можно также использовать для любых других периодичных задач:

- периодический сбор статистики
- горячее обновление конфигов
- и пр.

Для определения очереди необходимо:

- название очереди (например, `partner-tanker`)
- реализовать [server/processors](../server/processors)
  - `processors/partner-tanker/check` – функция, которая возвращает `cacheKey` ресурса
    Основная задача чек-процессора – получить `cacheKey` запрашиваемых данных и сравнить с имеющимся в кеше (например, в S3). В случае, если `cacheKey` отличается - вернуть новый, что стриггерит старт апдейт-процессора.
  - `processors/partner-tanker/update` – функция обновления данных с использованием `cacheKey`
    Основная задача апдейт-процессора – скачать новые данные и положить их в кеш (например, в S3), указав мета-ключ `cacheKey`, который в дальнейшем будет использоваться для инвалидации
- создать и экспортировать очередь в [server/queues](../server/queues/index.ts)

    ```ts
    export const [
        partnerTankerCheckQueue,
        partnerTankerUpdateQueue
    ] = createRecurrentQueue(
        // name – должно соответствовать названию процессоров
        // env – окружение, в котором будет храниться кеш
        {name: 'partner-tanker', env: 'testing'},
        {
            defaultJobOptions: {
                repeat: {
                    cron: '*/5 * * * *',
                },
            },
        },
    );
    ```

- если для этой задачи также необходим деплой в другую среду, необходимо подписать `deployQueue` на созданную очередь:

    ```ts
    // после обновления среды будет автоматически создана задача на деплой в продакшн с ручным подтверждением
    attachDeployQueue(deployQueue, partnerTankerUpdateQueue);
    ```

## DeployQueue

Очередь для ручного подтверждения задач деплоя в `production` окружение.

- Подробнее про то, [как ей пользоваться в интерфейсе](./ui.md)

Эта очередь общая, ее достаточно определить один раз на "неймспейс" (например, `partner-deploy` может агрегировать все задачи на деплой данных, необходимых для ПИ)

- Создать и экспортировать очередь в [server/queues](../server/queues/index.ts)

    ```ts
    export const deployQueue = createDeployQueue({name: 'partner-deploy'});

    ```
