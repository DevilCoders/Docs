# Автотесты в ПИ

## Как запустить автотесты локально

Установить свежие зависимости ПИ:
```bash
make configure
make bootstrap
veendor install -f
```

Запустить в отдельном терминале сервер Selenium (он нужен и для gemini-тестов):
```bash
make selenium
```

При запущенном Selenium-сервере запустить автотесты:
```bash
make autotest
```

После завершения тестов посмотреть allure-отчёт (откроется в дефолтном браузере):
```bash
make open-allure
```

Для локального запуска Gemini-тестов сперва нужно снять эталоны скриншотов:
```bash
make gemini_update
```

После этого можно запустить сами Gemini-тесты:
```bash
make gemini
```

## Погонятор

Чтобы погонять тесты и проверить их на стабильность, можно включить переменную окружения HERMIONE_REPEAT=[сколько раз прогнать тест]:
```bash
HERMIONE_REPEAT=100 make autotest
```
При этом нужно не забыть отфильтровать запускаемые тесты (в локальном ginny-конфиге, а при запуске в сандбоксе - через переменную окружения).
При наличии переменной HERMIONE_REPEAT ретраи автоматически выставляются равными нулю, поскольку запуск погонятора с ретраями не даёт понятную статистику.

Чтобы сделать это в [Sandbox](https://sandbox.yandex-team.ru), необходимо запушить свои изменения и при создании таска указать ветку, а также две переменнные - фильтрацию по тестам и количество прогонов:
```
HERMIONE_REPEAT: 50
hermione-suite-manager_case_filter: {"id": "marketmbi-1126"}
```

Погонятор работает только для новых тестов (добавленных через makePageSuite).

Если при локальном запуске возникает ошибка, которая ругается на отсутствие фильтрации тестов, но вы уверены, что в ginny-config'е всё отфильтровано, можно попробовать так:
```bash
GINNY_USER_CONFIG_PATH="$HOME/.ginny.conf.js" HERMIONE_REPEAT=50 make autotest
```

## Локальный запуск автотестов

Нужно запустить:
```bash
make autotest
```

### Фильтрация автотестов

Помимо `caseFilter` в файле конфига, можно также использовать переменные окружения, которые не только зададут `caseFilter`, но и действительно найдут и добавят в конфиг только нужные тесты. Это должно помочь запустить тесты быстрее.

Есть следующие переменные:
- `AT_ID` - фильтр по caseId
- `AT_TITLE` - фильтр по названию теста
- `AT_ISSUE` - фильтр по `issue` соответственно

Например,

```sh
AT_ID="marketmbi-2788" make autotest
```

## Как подключить пользовательский конфиг ginny

Часто при локальном запуске нужно переопределить какие-то значения в девелоперском конфиге `ginny`,
с которым автотесты запускаются локально (запускать в других браузерах, или запускать только часть тестов).

Это можно сделать, указав в `.bashrc` или аналоге переменную окружения с абсолютным путём до своего
пользовательского конфига:
```bash
export GINNY_USER_CONFIG_PATH="$HOME/path-to/ginny.conf.js"
```

Пример пользовательского конфига:
```jsx

/**
 * Общий способ фильтрации кейсов для hermione и gemini.
 */
process.env['hermione-suite-manager_case_filter'] = JSON.stringify({
    id: 'marketmbi-3019|marketmbi-3022|marketmbi-3035',
});

/**
 * Здесь можно указать нужную версию Chromium.
 */
const CHROME = {
    desiredCapabilities: {
        browserName: 'chrome',
        version: '74.0',
    },
};

/**
 * Здесь можнo указать нужную версию ChromeDriver.
 * Версии нужно брать отсюда: http://chromedriver.chromium.org/downloads
 */
const SELENIUM = {
    drivers: {
        chrome: {
            version: '74.0.3729.6',
        },
    },
};

module.exports = {
    /**
     * Здесь можно указать адрес своей рабочей копии или демостенда.
     */
    baseUrl: 'https://partner.market.fslb.yandex.ru',
    /**
     * При указании этого параметра Селениум будет запускаться в гриде, то есть
     * локальный make selenium будет не нужен (и локальный браузер не будет запускаться).
     * Настройка действует и на Gemini-тесты.
     */
    // gridUrl: 'http://selenium:selenium@sg.yandex-team.ru:4444/wd/hub',
    kadavr: {
        host: 'logrus01ed.market.yandex.net',
        port: 23264, // любой свободный порт на логрусе
    },
    hermione: {
        /**
         * Количество ретраев (попыток после первого падения теста).
         */
        retry: 0,
        /**
         * При разработке ограничиваем параллельный запуск
         * (количество одновременно запускаемых тестов).
         */
        sessionsPerBrowser: 2,
        browsers: {
            chrome: CHROME,
        },
        sets: {
            desktop: {
                /**
                 * Для ускорения запуска тестов при разработке здесь можно указывать
                 * путь к конкретному страничному сьюту (остальные тесты не будут распарсены).
                 * Путь должен начинаться с lib -- собранные тесты лежат там.
                 * Кроме того, таким способом можно запустить все тесты на одну страницу.
                 * !!! Важно, тут надо указывать путь к файлам с makePageSuite. Например, если у вас их 2 на странице
                 * то нужно указывать что-то вроде: lib/client.next/pages/ProductUpload/spec/e2e/pages/*/index.js.
                 */
                // files: 'lib/client.next/pages/Auction/spec/e2e/index.js',
            },
        },
        system: {
            mochaOpts: {
                /**
                 * Фильтрация запускаемых hermione-тестов по названию:
                 */
                 // fgrep: /ставки/,
            },
            /**
             * Установка этого флага в false отключит вывод Selenium-логов (всех запросов к нему).
             */
            debug: true,
        },
    },
    gemini: {
        /**
         * У gemini свои аналогичные настройки.
         */
        sessionsPerBrowser: 2,
        retry: 0,
        /**
         * Фильтрация запускаемых gemini-тестов по названию:
         */
         // grep: /Popular assortment/,
    },
    selenium: {
        install: SELENIUM,
        start: SELENIUM,
    },
    suiteManager: {
        caseFilter: {
            /**
             * Фильтрация запускаемых тестов по мета-данным:
             */
            id: 'marketmbi-47|marketmbi-3036',
        },
    },
};

```
