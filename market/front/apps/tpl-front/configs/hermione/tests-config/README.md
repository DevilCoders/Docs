# tpl-hermione-tests-config

Содержит списки скипов hermione тестов для репозитория [market/market-tpl-front](https://github.yandex-team.ru/market/market-tpl-front).

[Как добавить скип](./CONTRIBUTING.md)

## OAuth
Для локальных проверок нужно в корневой директории создать oauth_token.txt (под .gitignore)
И прописать токены.

Для получения OAuth-токена ST зайдите из под нужного пользователя на [ST](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=5f671d781aca402ab7460fde4050267b)

Для получения OAuth-токена TestPalm зайдите из под нужного пользователя на [TestPalm](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=6d967b191847496a8a7077e2e636142f)

`ST_OAUTH_TOKEN=<token1>`

`TESTPALM_OAUTH_API_TOKEN=<token2>`


Либо можно экспортнуть их в локальную переменную окружения с аналогичным именем
`export ST_OAUTH_TOKEN=AQAD-...`

`export TESTPALM_OAUTH_API_TOKEN=AQAD-...`

## Запуск

### запустить все АТ
`HERMIONE_CASES_SELECTION=all`

### запустить только АТ из скип конфига
`HERMIONE_CASES_SELECTION=skipped`

### запустить все АТ, кроме занесенных в скип конфиг (можно не указывать - будет по умолчанию)
`HERMIONE_CASES_SELECTION=default`

## Списки

`skipped.desktop.txt` - для десктоп версии

`skipped.touch.txt` - для будущей мобильной версии

## Описание формата

Файл скип-пака состоит из набора строк двух типов: комментарии и пропуски.

Комментарии начинаются с символов `;` или `/`.
Последний комментарий перед пропусками используется в качестве причины пропуска в allure-отчёте.
Пустая строка сбрасывает комментарий и используется для разделения группы пропусков
с одним тикетом на исправление.
Комментарии необязательны, указывать "Сломан тест" не нужно.

Строка пропуска имеет формат

    [=]MARKETPARTNER-xxxxx (пробел) marketmbi-xxxx (пробел) Полное название теста.

Символом `=` помечаются тикеты в релизе (слитно с тикетом, `=MARKETPARTNER-xxxxx`).
Такие пропуски игнорируются в релизных прогонах.

В нормальных условиях тикеты в релизе размечаются автоматически внутри запуска АТ.

## Пример заполнения

```
/ skipped.desktop.txt

; Удалить тесты на Биллинговые операции и Клики по дате учёта
MARKETPARTNER-31688 marketmbi-5871 Биллинговые операции. Маркетплейс. Переход на страницу Помощи
MARKETPARTNER-31688 marketmbi-5876 Биллинговые операции. Маркетплейс. Сортировка по дате события

=MARKETPARTNER-30688 marketmbi-5149 Сводка. Блок "Рейтинг". Подсказка про базу расчёта рейтинга. Магазин без рейтинга
=MARKETPARTNER-30688 marketmbi-3761 Сводка. Блок "Рейтинг". Есть рейтинг, но нет вопросов и отзывов

MARKETPARTNER-30691 marketmbi-6818 Маркетплейсы на белом. Белый. ЕКАТ. Проверка прайс-листа по ссылке. В результате валидации есть только валидные офферы
```

В данном примере есть три тикета на исправление, причина пропуска указана только для первого,
а второй катится в релизе.

## Для копирования полного названия кейса

Копирование строки пропуска в нужном формате производится через иконку с красными страницами
над полным названием теста в столбце с шагами. Само название копируется щелчком по нему.

## Зачистка от закрытых тикетов

При клонировании этого репозитория отдельно от partnernode для запуска инструметна очистки
нужно будет однократно установить зависимости через `npm install`. При запуске в составе
partnernode нужные зависимости там уже есть, каждый запуск АТ клонирует этот репозиторий
в директорию `configs/hermione/tests-config`.

Также потребуется установить переменную окружения `ST_OAUTH_TOKEN`,
[получив свой токен](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=5f671d781aca402ab7460fde4050267b).

    export ST_OAUTH_TOKEN=AQAD-...

Запуск очистки в текущей ветке из директории скип-пака:

    node scripts/remove-tickets.js

Без аргументов будут удалены строки с закрытыми тикетами и примыкающие к ним комментарии,
или можно указать в аргументах свой набор тикетов. После изменений нужно запушить их в
репозиторий.

Для удобства сделан сценарий-обёртка, который вместе с изменениями создаст и запушит
новую ветку.

    sh scripts/remove-closed-tickets.sh {имя-новой-ветки}

При наличии изменений и успешном пуше будет возвращена ветка, активная до запуска.
А новую локальную ветку можно удалить сразу после создания pull request.
