# Сборка на wepback

## development

### Локальная сборка

Сборку приложения на React для разработки можно выполнять **локально**, поднимая `webpack-dev-server`.
Для того, чтобы его запустить с дефолтными настройками, необходимо выполнить следующую команду:
```sh
npm start
```
Таким образом будет использоваться окружение `development`, будут собраны все страницы, и по умолчанию dev-server и собранные файлы будут доступны по адресу https://localhost:8080.
Если необходимо задать другой порт, то можно запустить сервер, определив переменную окружения `W_PORT`, например:
```sh
W_PORT=8081 npm start
```
В таком случае `ASSET_PATH` (путь на клиенте до чанков) станет https://localhost:8081. Эту переменную также можно переопределить следующим образом:
```sh
ASSET_PATH=https://something-else/ npm start
```

#### Сборка с линтингом

На данный момент кодстайл проверяется с помощью `eslint` (js) и `stylelint` (css), а также проверяется валидность
типизации с помощью `typescript`.

Для того, чтобы линтинг не влиял на время основной сборки, он вынесен в отдельную независимую сборку. Чтобы запустить
сборку для линтинга необходимо выполнить:
```sh
npm run start:lint
```

Таким образом обычную сборку и непосредственно линтинг можно держать в двух разных терминалах. Однако удобнее может быть запуск и вывод информации в одном, для этого достаточно запустить:
```
npm run dev
```

С помощью этой команды линтинг и основная сборка будут запущены параллельно, но их сообщения будут выведены в одном окне.

#### Опции сборки

Для более быстрой и комфортной разработки можно задать следующие аргументы:

- `--pages` - позволяет указать через запятую *(без пробелов)*, какие именно страницы нужно включить в сборку при старте. Список страниц, указанный в `--pages` будет объединен со списком, который указан в переменной окружения `WEBPACK_DEFAULT_PAGES`. Название страницы можно указывать как в PascalCase, так и в cebab-case. Например:

    ```sh
    npm start --pages=stat-orders,documents,page-name,AnotherPageName
    ```
- `--sourcemaps` - флаг для запуска сборки с полными сорсмапами. По умолчанию сборка запускается с минимальными, так как это заметно сказывается на времени сборки. Можно использовать для более детальной отладки. Например:

    ```sh
    npm start --sourcemaps
    ```
- `--ncc` - `no-clean-console`, если этот флаг выставлен, то консоль браузера не будет очищаться при обновлении кода:

    ```sh
    npm start --ncc
    ```
- `--nct` - `no-clean-terminal`, если этот флаг выставлен, то терминал не будет очищаться при обновлении кода:

    ```sh
    npm start --nct
    ```
- `--wdyr` - [why-did-you-render](https://github.com/welldone-software/why-did-you-render), если этот флаг выставлен, то будет профилирование лишних ререндеров Компонентов:

    ```sh
    npm start --wdyr
    ```
- `--analyze` - [webpack-analyzer-plugin](https://github.com/webpack-contrib/webpack-bundle-analyzer), если этот флаг выставлен, то после успешной сборки поднимется сервер и в браузере откроется дерево зависимостей с со всей информацией о том что попало в какие чанки, особенно полезно для оптимизации продакшн сборки:

    ```sh
    npm build:client --analyze
    ```

#### Динамическая сборка страниц
Под динамической сборкой страниц понимается возможность автоматически добавлять в сборку новую страницу, не останавливая процесс сборки.
При заходе на страницу, которая не включена в сборку, она добавится в entries конфигурации вебпака, и произойдет пересборка.
По умолчанию, динамическая сборка включена. Динамическую сборку страниц можно выключить, указав переменную окружения `WEBPACK_DYNAMIC_BUILD=false`

Также, можно указать начальный список страниц с переменной окружения `WEBPACK_DEFAULT_PAGES`. Этот список будет объединен со списком страниц, указанных в `--pages`
```
WEBPACK_DEFAULT_PAGES=dashboard,onboarding
```
Дополнительно, можно указать максимальное количество страниц в сборке.
```
WEBPACK_DYNAMIC_MAX_PAGES_COUNT=20
```
При достижении данного количества, самая старая страница, которая была добавлена в сборку, будет исключена из нее.
Страницы, которые были заданы при старте сборки (с использованием `--pages` или `WEBPACK_DEFAULT_PAGES`), исключаться не будут.

#### Использование переменных окружения
Для того, чтобы не указывать параметры при запуске приложения, можно перечислить все в `.env` файле в корне проекта.
Например, чтобы не писать 
```
WEBPACK_DYNAMIC_MAX_PAGES_COUNT=10 WEBPACK_DEFAULT_PAGES=dashboard,onboarding npm start
```
Создаем `.env` файл, где указываем:
```
WEBPACK_DYNAMIC_MAX_PAGES_COUNT=10
WEBPACK_DEFAULT_PAGES=dashboard,onboarding
```
И строка запуска тогда будет выглядеть `npm start`.  

Пример `.env` файла можно посмотреть в корне проекта ПИ [.env.example](https://github.yandex-team.ru/market/partnernode/blob/master/.env.example)

### Запуск node-приложения

Для того, чтобы использовать `development`-сборку, достаточно запустить сервер с окружением `development`, например:
```sh
NODE_ENV=development make server
```

Для удобства есть таргет `dev-*`, который выставит нужное окружение сам:
```sh
make dev-server
```
или
```sh
make dev-rebundle
```
В случае такого запуска будет сначала произведена транспиляция кода в папку lib/ из которой запустится нода.
Если же вы уверенны, что там уже есть все актуальные файлы (например, просто перезапускаем ноду), то достаточно просто запустить
```sh
make devq-server
```
Таким образом нода поднимется на уже готовой папке (q for "quick").

В таком окружении сервер будет отдавать чанки по дефолтному пути (https://localhost:8080).

Если же `W_PORT` или `ASSET_PATH` были переопределены при сборке, то их нужно аналогично задать и для node-сервера.

Так же если необходимо запустить сборку файлов партнерских интерфейсов, можно воспользоваться `devp-*` флагом

```sh
make devp-debug
```

### SSL Сертификат

Для того, чтобы можно было использовать чанки с локальной машины на https-сайтах, во время сборки генерируется SSL-сертификат, но без надежного источника.

Можно добавить сгенерированный сертификат в исключения, однако, так как по умолчанию он кэшируется в `node_modules`, то после удаления этой папки будет сгенерирован новый, который надо будет снова добавить в исключения.

Но для того, чтобы решить этот вопрос один раз, для пользователей Я.Бро/Хромиума достаточно зайти на [`chrome://flags/#allow-insecure-localhost`](chrome://flags/#allow-insecure-localhost) и включить опцию `Allow invalid certificates for resources loaded from localhost`.

## production

Для production-сборки нужно выполнить:
```sh
npm run build:client
```

Чанки будут сформированы в папке `dist`, сервер будет их раздавать на основе сгенерированного `manifest.json`.

Для анализа что попадает в бандлы есть флаг `--analyze`. По следующей команде вебпак соберет все ассеты для наших приложений и откроет в браузере страницу с картой зависимостей, включенных в каждый из бандлов.

По умолчанию продакшн собирается без сорсмапов, для сборки с сорсмапами нужно добавить флаг `--sourcemaps`. Флаг работает для скриптов `build:client:code`, `analitics:build-client` и `analitics:build-server`.

```sh
npm run build:client
```
