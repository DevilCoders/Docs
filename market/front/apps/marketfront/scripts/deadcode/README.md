# Deadcode cleanup

## usage

```bash
./scripts/deadcode/run.sh
```

В результате должны удалиться неиспользуемые файлы, но не все идет так хорошо и периодически что-то отваливается,
поэтому при повторных запусках коммитим в run.sh вызовы функций сверху вниз

## как работает


Весь процесс состоит из двух частей:

1. сборка проектов fapi, desktop, touch, white fapi с плагином Deadcode Plugin (market/configs/webpack/plugins/deadCodePlugin)
2. Запуск unit-тестов для всех проектов с генерацией отчетов по покрытию

После первого пункта в `<root>/deadcode_reports` получаем списки неипользуемых файлов в директориях по проектам в .json,
там же десть *-used.json, *-all.json для отладки

Чтобы webpack-плагин работал, нужно запускать сборку с env-переменной WITH_DEADCODE_PLUGIN=1

После второго пункта нужно запустить скрипт `<root>/scripts/deadcode/prepare-deadcode-reports-from-coverage`,
чтобы получить списки неиспользуемых файлов в тестах скрипт складывает отчеты тоже в `<root>/deadcode_reports`

После этого остается запустить `<root>/scripts/deadcode/remove` - скрипт возьмет все отчеты по неиспользуемым файлам из `deadcode_reports`,
сделает пересечение и получим списки того что не используется ни в src, ни в market

---

Дальше коммитим, пушим и ждем проверок в PR. Конечно же все завалится и flow и тесты.

Все дело в том что есть файлы, которые содержат только типы и соответственно эти типы импортируются,
но в вебпаке такие файлы не видны, так как в finishModules и других хуках код виден уже после transpile

Используемые файлы нужно будет восстановить

Дополнительно есть файлы в src используемые в pokupki, их тоже нужно будет восстановить

Суммарно таких неявных зависимостей получается не больше сотни

---

Еще одна часть это автотесты, но их достаточно запустить и если где-то не хватает файлов будет ошибка

---

Итого для первго этапа - удаляется 1273 файла (-55230 строк), еще посмотрю автотесты

## roadmap

- собрал все что нужно запустить в `<root>/scripts/deadcode/run.sh`, но сходу на логрусах все не проходит, нужно по частям
- можно добавить запуск тестов из pokupki, но думаю в этом нет особого смысла
- добавил много исключений файлов (`<root>/configs/deadcode/patters.js`) можно пробовать убирать исключения и смотреть что получается
