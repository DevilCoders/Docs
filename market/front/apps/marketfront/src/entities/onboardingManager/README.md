# Менеджер онбордингов

[Полная вики](https://nda.ya.ru/t/-xWe5RZZ4sdAf7) с описанием архитектуры, заведением онбордингов и очередей, бизнес логики. 

Ответственные
Manager: @v-shabanov
Web: @egorkakshin
IoS: @avarec
Android: @skim27
## Что это?

Конструктор онбордингов это механика которая позволяет заводить онбординги в CMS в определенном формате и по требованию отдавать визуал на клиент.

## Из чего состоит? 

1. Очередь онбордингов
2. Онбординги / конструктор онбордингов

## Очередь онбордингов

Механика, которая позволяет автоматически, с заданным периодом тишины, показывать онбординги пользователю. Так же поддерживается приоритетность показа онбордингов. Очередь управляется через CMS. Онбординг на показ выбирается в резолвере фронта по определенным критериям.

# Архитектура

[Исходник изображения если захочется что-то поменять](https://disk.yandex.ru/public/nda/?hash=wuMNNwoyCZbXeBTCeE/qD0AcV5LCEeskkVjzlXl%2BP5DGdmAiTKvaOaVw3w5ouCQiq/J6bpmRyOJonT3VoXnDag%3D%3D)

![Тут должна быть картинка, но если ее нет перейди на вики по сурсу](https://jing.yandex-team.ru/files/egorkakshin/mainQueue.png)

## Контракты FAPI

1. Контракт для получения онбординга на показ [Запрос](https://paste.yandex-team.ru/8039509) <=> [Ответ](https://paste.yandex-team.ru/8039613) -> [Fapi дока](https://pages.github.yandex-team.ru/market/marketfront/fapi/#/default/postapi_app_handlers_resolveOnboardingToShow_v1_index_js)
2. [Ответ](https://paste.yandex-team.ru/8643100) CMS с очередью онбордингов и условиями показа
3. Контракт для получения конкретного онбординга по ID [Запрос](https://paste.yandex-team.ru/8643947) <=> [Ответ](https://paste.yandex-team.ru/8039613) -> [Fapi дока](https://pages.github.yandex-team.ru/market/marketfront/fapi/#/default/postapi_app_handlers_resolveOnboardingById_v1_index_js)
4. [Ответ CMS](https://paste.yandex-team.ru/7832779) с конкретным онбордингом
5. Что такое [skip параметр](https://nda.ya.ru/t/GXF5C7eY4pHtnR) и как он работает?

## Как работает очередь

Резолвер [resolveOnboardingToShow](https://nda.ya.ru/t/ih4ofVTQ4sdCx7) решает какой онбординг показать в данный момент пришедшему пользователю/клиенту. ВСЕГДА делает запрос в root очередь, так как там находятся самые приоритетные онбординг, которые необходимо показывать на всех страницах. Если онбордингов в root очереди нет, смотрит в полученные viewPlaceParams и пытается найти в CMS очередь на эту страницу/экран.

Если нашлась root или страничная очередь, фильтрует онбординги находящиеся в списке по:
1. Периоду тишины для онбордингов сравнивая поле lastShownOboardingDate и период тишины платформы, конфиг которой находится в [s3](https://s3.mds.yandex.net/marketfront/onboardingManager/config.json) для каждой платформы.
2. Критериям показов, которые пришли в поле shownOnboardings.

Есть исключение. Если период тишины не прошел, то есть текущая дата < lastShownOboardingDate + периодТишины, резолвер все равно сделает запрос в root очередь, так как там мог появиться онбординг, которые может прерывать период тишины из-за своей важности. И если такой онбординг есть и он не показывался, то резолвер его отдаст.

## Как фиксируются показы?

### Web
Пока онбординги реализованы только в приложении (23.03.2022 @egorkakshin)
На вебе все будет храниться в куках (23.03.2022 @egorkakshin)

### В приложениях
После показа какого-либо онбординга, приложения в storage ложат значения показанного онбординга в формате
```
{
    [onboardingId]: {
        shownDate: 123123 // дата показа в миллисекундах
        removeDate: 123123 // дата в миллисекундах, когда можно удалить значение из storage === условия скрытия по дате окончания, в CMS
    },
}
```

Так же в storage отдельно ложится значение последнего показа онбординга в миллисекундах (lastShownOnboardingDate) - через префы можно сбрасывать эти значения в приложении.

## Тонкости/Костыли

### semanticId 
semanticId в CMS выстраивается по принципу ${pageId}_queue_h{hid}n{nid} и должен быть уникальным
Например для каталога с hid 12 и nid 29 semanticId будет -> catalog_queue_h12n29

### Оптимизации
Что бы сократить количество запросов в приложении, добавили новую ручку [resolveOnboardingsQueueByPageId](https://nda.ya.ru/t/F8Ricp4J4sdCjS), она получает список очередей на конкретную страницу. Пока используется только в каталоге. На каталог можно завести много очередей с различными комбинациями hid и nid. Ручка получит существующие, а клиенты(приложения) смогут делать запрос только на страницах, где теоретически может быть онбординг.
