# Кэшбек

В этой папке будут
- Сушности кэшбека (cashbackOption, cashbackProfile, cashbackOptinoProfile)
- Логика патчинга ответа актуализации + типы
- Немного теории организации сущностей

## Описание логики данных
На бекенде существует сущность - профиль кэшбека.
Это условия, на которых должен быть оформлен заказ (способ оплаты, доставки), и кэшбек за такой заказ.
Например:
1. Прфиль 1: если заказ оплачен картой, то можно потратить 10р кэшбека
1. Прфиль 2: если заказ оплачен картой, то можно накопить 30р кэшбека
1. Профиль 3: если заказ оплачен наличными, то нельзя потратить кэшбека
1. Профиль 4: если заказ оплачен наличными, то можно накопить 30р кэшбека

На описание каждого типа кэшбека (списания, начисления) используется отдельный профиль.
Список профилей генерируется на лоялти и проксируется чекаутером в ручках /cart, /checkout (поле cashbackOptionsProfiles)
Профили - это не окончательные условия, которые будут применены к заказу, а только ориентировочные варианты кэшбека за заказ.
В каждом профиле есть поле cashback, которое описывает сколько баллов списать/начислить, если ли ограничения. Профиль содрежит поля кэшбек для каждого уровня заказа: мультизаказ, заказ, айтем заказа.
Структура: https://wiki.yandex-team.ru/users/fonar101/ruchki-keshbeka-na-lojalti/#telo1

Реальные условия приходят от чекаутера в виде нескольких полей:
* cashbackBalance - текущий баланс у пользователя (внимание! здесь всегда актуальный баланс пользователя. Кэшированный баланс доступен в перке YANDEX_CASHBACK)
* selectedCashbackOpton (передается фронтом и отдается в ответ) - выбранный вариант кэшбека - потратить или накопить
* cashback - поле, в котором описаны реальные условия списания и начисления кэшбека для уже выбранных параметров заказа.
    Чекаутер ходит в ручки /calc /spend лоялти, чтобы посчитать уже реальные условия кэшбека на основании выбранных параметров заказа.
    В отличие от cashbackOptionsProfiles:
     * причина недоступности кэшбека (restrictionReason) приходит агрегированный по всем внутренностям заказа, т.е. не нужно проверять каждый айтем заказа, чтобы понять, разрешен ли кэшбек
     * кол-во кэшбека (amount) ограничено балансом пользователя.

## Как храним данные на фронте
- cashbackProfile хранит параметры заказа и тип профиля (например: начисление на предоплатыный заказ). Т.е. сущность описывает все ограничения, на которые применим этот профиль
- cashbackOption хранит кол-во баллов и причину отказа от начисления/списания, если таковая существует.

Для хранения нескольких вариантов кэшбека (профайлов) сущности, cashbackOption должны линковаться ко всем сущностям, к которым относится - мультизаказ, заказ, айтем заказа, а так же к профилям кэшбека (условиям, на которых эти баллы можно получить).
Поэтому у каждой сущности (мультзаказ, заказ, айтем) есть список связей cashbackOption - cashbackProfile, это и есть весь список вариантов кэшбека, возможных для этой сущности.

При этом поле cashback от чекаутера, т.к. не зависит от профилей, сразу превращается в сущность cashbackOption (на самом деле 2 - для начисления и списания)

Есть мысли переделать нормализацию профайлов в плоскую структуру данных - позволит избежать сложностей понимания, но добавит дублирования данных. Тикет https://st.yandex-team.ru/BLUEMARKET-13347

## Где используем данные на фронте

1. В корзине для айтемов и саммари отображаем максимальный возможный начисленный кэшбек, опираясь на ифнормацию о профилях от лоялти.
Т.е. если приходит несколько профилей, ищем из них максимально выгодные условия начисления и показываем их
2. В чекауте
   * В виджете оплаты используем инфомрацию из профилей для отрисовки разных условий списания для разных типов оплаты
   * В саммари используем поле cashback чекаутера (реальный кэшбек)
   * В виджете выбора опции кэшбека
        * используем поле cashback чекаутера (реальный кэшбек) для отрисовки доступности опций и кол-ва баллов или причину недоступности
        * используем профили для текста "выбери другой способ оплаты"

## Еще

Для удобной нормализации профилей приходится патчить ответ чекаутера - раскладывать поля cashback сущностей к этим самым сущностям.
Код можно посмотреть в src/resolvers/checkout/purchase/utils.js (patchActualizedResponseWithMissingData)
