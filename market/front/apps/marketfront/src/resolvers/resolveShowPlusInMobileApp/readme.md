# Тоггл Плюса на iOS

## Зачем?

Избежание реджекта в сторе Apple https://st.yandex-team.ru/MARKETPROJECT-9325

## Как?

На Андроиде Плюс включается всегда.

Для iOS:

  - Загружается конфиг с s3.

  - Плюс показывается только в странах id которых перечисленны в `countries`.

  - Если `checkPublishedVersion = true`, то кроме того выполняются следующие проверки:

    - С https://itunes.apple.com/ru/lookup?bundleId=ru.yandex.blue.market скачивается текущая опубликованная версия мобильного приложения.
      Для этой и более старых версий Плюс показывается. Для версий все еще находящихся на модерации - нет.

    - На случай если `itunes` недоступен (или по какой-то иной причине) максимальную версию приложения для которой следуют включать Плюс можно
      указать в `/featureToggle/mobileConfigForPlus.json` на `s3`.

    - Данные с `itunes` в приоритете. Т.е если версия приложения больше чем указанная в `s3`, то Плюс все равно включится если эта версия меньше или равна опубликованной.

    - Чтобы гарантировать работоспособность Плюса при проблемах с `itunes` версию в `s3` стоит периодически обновлять ручками... скорее всего делать это будут забывать. Поэтому по-хорошему надо бы это процесс автоматизировать.

При рестарте ноды первый раз ходим за версиями асинхронно, чтобы Плюс не отваливался при каждом релизе. Это несколько затормозит ответ для пары десятков пользователей. После, чтобы не тормозить, используем локальный кеш, а асинхронное его только обновляем.

## Пример конфига на `s3`

Для включения Плюса в России, в версиях приложения 3, 2, 1:
```json
{
  "checkPublishedVersion": true,
  "countries": [225],
  "version": "3.0.0"
}
```

Для включения в России для всех версий:
```json
{
  "checkPublishedVersion": false,
  "countries": [225]
}
```
