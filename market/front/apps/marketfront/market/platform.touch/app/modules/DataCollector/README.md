DataCollector
=============
Модуль для формирования выдачи сущностей из нескольких источников с поддержкой перемешивания и пейджинга. Обладает клиентским интерфейсом.

**Гарсон** (Garson) — поставщик сущностей. Скажем, гарсон `RecommendedProductsByHistory` знает, какую последовательность шагов нужно совершить и какие бекенды дёрнуть, чтобы получить рекомендованные продукты по истории пользователя.

**Шафлер** (Shuffler) — объект, определяющий способ перемешивания сущностей от разных гарсонов.

**Комплетер** (Completer) — функция, осуществляющая пост-процессинг полученных сущностей.

Общий принцип работы:

1. DC инициализируется на сервере:
    1. Для каждого элемента из `garsons` находит соответствующий гарсон и инициализирует его.
    2. По опции `shuffle` выбирается шафлер.
2. На каждый вызов `.next(n)`:
    1. Просит шафлер достать `n` сущностей.
    2. Шафлер опрашивает гарсоны и перемешивает ответы.
    3. Вызывает комплетеры для пост-процессинга.
3. На вызов `.teleport()` сохраняет состояние для телепорта на клиент и возвращает ключ для инициализации клиентского DC.
4. [Клиентский DC](/client/desktop.modules/n-DataCollector/DataCollector.js) инициализируется ключом из предыдущего пункта.
5. На каждый вызов `.next(n)` клиенткий DC делает запрос к [ApiDataCollector](/app/pages/api/ApiDataCollector.js), который восстанавливает состояние и дёргает `.next(n)` серверного DC (см. пункт 2) и возвращает от него ответ.

## Примеры
**Важно**: DC принимает параметры во владение. Их использование после передачи является неопределённым поведением.

Инициализация:
```javascript
this.module(DataCollector, {
    // Обязательный массив источников.
    garsons: [{
        id: 'PopularProducts',  // Идентификатор будущего гарсона.
        params: {nid: 20}       // Параметры гарсона.
    }, {
        id: 'RecommendedByHistory',
        params: [{name: 'nid', value: 42}]  // Параметры в CMS-стиле.
    }, {
        id: 'BestDeals'
    }],

    // Необязательная опция для указания способа замешивания.
    shuffle: {mode: 'serial'},   // 'serial', 'stripe' или 'random (по дефолту `stripe`).

    // Необязательная опция для указания комплетеров.
    completers: [
        {id: 'ratings'},                // Обновить рейтинги у продуктов.
        {id: 'offers', params: {...}}   // Добавить дефолтные офферы продуктам (`product.offer.default`).
    ]
})
```

Далее можно вызывать `.next(n)`:
```javascript
dc.next(20).then(console.log);
```

Если нужно продолжить использовать DC на клиенте, то после окончания работы с серверным:
```javascript
let key = dc.teleport();
```

Убедись, что на страницу был запушен Teleport.

Данный ключ необходимо передать клиентскому DC в конструктор:
```javascript
let DC = require('DataCollector');  // Блок n-DataCollector.

let dc = new DC(key);
dc.next(10)
    .then(res => console.log(res))
    .fail(ex => console.error(ex)); // Клиентский DC может зарежектиться.
```

## Шафлеры (Shufflers)
Реализуется паттерн [стратегия](https://ru.wikipedia.org/wiki/Стратегия_(шаблон_проектирования)).

Базовый класс — `Shuffler`, определяет публичный интерфейс (метод `.next(n)`) всех шафлеров. Наследники реализуют [шаблонный метод](https://ru.wikipedia.org/wiki/Шаблонный_метод_(шаблон_проектирования)) `._next(n)`. `next(n)` всегда резолвится с `<= n` сущностями, причём случай, когда он возвращает меньше запрошенного можно трактовать как конец данных.

`SerialShuffler` — шафлер, который выдаёт сущности последовательно из первого гарсона, пока не исчерпает его (или пока он не завершится с ошибкой), потом из второго и так далее.

`StripeShuffler` — шафлер, который выдаёт сущности по очереди из активных гарсонов.

`RandomShuffler` — шафлер, выбирающий сущности случайным образом из активных гарсонов, но минимум по одному из каждого.

Выбор конкретного шафлера осуществляется [фабричным методом](https://ru.wikipedia.org/wiki/Фабричный_метод_(шаблон_проектирования)) `shufflers.createShuffler`.

## Гарсоны (Garsons)

Состояние всех активных гарсонов передаётся через [хранитель](https://ru.wikipedia.org/wiki/Хранитель_(шаблон_проектирования)) memento DC на клиент.

Описываются [тут](./garsons).

Для понимания работы советую глянуть хотя бы комментарии в [абстрактном Garson](./garsons/Garson.js).

При написании своего гарсона необходимо реализовать шаблонные методы `._next(n)` и, необязательно, `._initState(params)`.

Что касается `._next(n)`:

1. Гарантируется, что он всегда вызывается с `n > 0`.
2. Гарантируется, что он не вызывается, если предыдущий вызов ещё не отработал.
3. Он может вернуть массив или `Response`, который резолвится массивом сущностей.
4. Режект воспринимается шафлерами эквивалентно `[]`.
5. Если возвращается массив с длиной меньше `n`, то считается, что у гарсона данные кончились (при этом сам массив учитывается).
6. Если возвращается массив с длиной больше `n`, то лишние отбрасываются.
7. Внутри метода доступна информация про запрос (`this.user`, `this.request`), в остальном вся необходимая для корректной работы `._next` информация должны быть в `this.state`, который расшаривается с клиентом.

Что касается `._initState(params)`:

1. По умолчанию возвращает `{offset: 0, params: params}`.
2. Гарантируется, что он вызывается с объектом `params`.
3. Он может вернуть любое значение или `Response`, который резолвится значением. Это значение доступно в `._next` как `this.state`.
4. Режект приведёт к выкидыванию гарсона (и сообщению в логи).
5. Состояние должно быть маленьким. Помни: оно шарится с клиентом.
6. Для некоторых горсонов может быть полезным доступ к `this.limit`, в котором задано максимальное количество сущностей, которые могут быть запрошены или `Infinity`, если не указано.

Пример гарсона, который оборачивает ручку без пейджинга — `PopularProducts`.

Пример гарсона, который оборачивает ручку с пейджингом — `BestDeals`.

## Комплетеры (Completers)

Описываются [тут](./completers).

Каждый комплетер экспортирует единственную функцию с сигнатурой `(context, data, params)`, где

1. `context` — объект с полями `user`, `request` и `resource()`.
2. `data` — массив сущностей, которые можно дополнять/изменять.
3. `params` — объект параметров, всегда объект.

Комплетер может возвращать ~~промис~~ респонс для ожидания, возвращаемое значение игнорируется.
