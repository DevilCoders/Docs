# Обертка над bcm-ресурсами

## Ресурсы

- Исторически обертку над бекендом называем "ресурсом"
- Ресурсы делятся на два типа:
  - [legacy-ресурсы](https://github.yandex-team.ru/nodules/resource).
  - bcm-ресурсы. Концептуально похожи на предыдущие.
    - Под собой используют [bcm2](https://github.yandex-team.ru/market/monomarket/tree/master/lib/lib/bcm2)
    - Под собой используют классы определенные в [mandrel](https://github.yandex-team.ru/market/monomarket/tree/master/lib/lib/mandrel/src/bcm)

## Плюшки

- Внешний интерфейс получившехся ресурсов похож на резолверы
- Суперлегкое мокирование ответа ресурса. С плюшками типа задержки, как у реального бекенда. Это чисто про DX.
- Поддержка flow
- Баги уже отловили в синем
- Реюз кода (много методов репорта написано в синем)
- Валидация параметров регулярками
- Поддержка Susanin-а в урлах с автоматической защитой от path-traversal
- Удобство в написании юнит-тестов
- Подмена хостов на лету

## Как правильно написать bcm-ресурс (смотри в синем)

- Пример тут: `@self/project/src/resources/history`
- Пример тестов на ресурс тут: `@self/project/src/resources/history/__spec__`
- Пример тестов на резолверы, которые используют bcm-ресурс: `@self/project/src/resolvers/history/__spec__`

На что важно обратить внимание в конфиге:
- У конфига обязательно нужно указать поле `logName`
- У конфига есть необязательное поле `Backend`
  - Если тебе нужен tvm-бекенд, необходимо указать соответствующего родителя в это поле
  - По умолчанию в этом поле указан `MarketHttpBackend`
  - `createFakeMarketBackend` позволяет создавать удобные мокированные ресурсы

На что важно обратить внимание в схеме:
- Обязательное поле `config`. В него надо прописать конфиг ресурса.
  Это осуществит провязку метода-клиента и бекенда (см. терминологию bcm2)
- У схемы обязательно нужно указать поле `name`


## Как правильно переезжать на bcm-ресурсы

В случае legacy-ресурса, вероятно, понадобится целиком обновить интерфейс,
нормализовать ответ бекенда, покрыть типами, написать тесты.


## Кодирование тела запроса и ответа

Важными параметрами являются:
- encodeBody - определяет как должно обработаться bcm-ом тело запроса (проставляются соответсвующие заголовки и т.д.)
- parseBody - определяет простешую предобработку ответа (влияет на заголовки accept запроса, конвертирует некоторые пришедшие данные в выбранный формат)

Также стоит обратить внимание что при выборе например формата 'raw' bcm добавит в headers.accept = 'text/html',
а вы можете ожидать json. Поэтому необходимо добавить этот заголовок вручную в блоке prepare.

Для передачи файлов на сервер рекомендуется использовать модуль **form-data**.
Примеры есть в `src/resources`. Для получения бинарных данных испольуется `parseBody='buffer'`.

## Однако

Обертка будет забетонирована, но уже можно пользоваться
