### Что это такое

В этом репозитории лежит внутренний вьювер [еком-профиля](https://wiki.yandex-team.ru/users/valbal/e-com-profil-2021/).

### Особенности работы с правами доступа

Внутренний вьювер еком-профиля работает с приватной информацией пользователей, он показывает какими категориями товаров пользователь интересуется, какие товары покупает. В целях соблюдения требований безопасности и предотвращения утечек в нем реализовано разграничение прав доступа.

**Текущая целевая схема прав доступа:**
1. По умолчанию пользователь, авторизованный в домене yandex-team.ru может посмотреть данные только для логина, который привязан к его Стаффу.
2. Пользователь, который имеет роль “Суперсмотритель“ в IDM для сервиса “Вьювер еком-профиля“ может смотреть данные для любого логина. (это пока не реализовано)

Вьювер еком-профиля взаимодействует со следующими сервисами:
- [**Blackbox API**](https://docs.yandex-team.ru/blackbox/) – сервис для проверки авторизационных данных пользователей (авторизация по куке);
- [**Staff API**](https://staff-api.test.yandex-team.ru/v3/) – API Стаффа для того чтобы узнать какой внешний логин привязан в Стаффу авторизованного пользователя.
- [**Passport API**](https://passport.yandex.ru/account/short?login=mellanore) – API Паспорта для того чтобы узнать по логину пользователя его uid 
- [**TVM-демон**](https://wiki.yandex-team.ru/passport/tvm2/tvm-daemon/) – Специальный сервис, выпускающий TVM-тикеты для [TVM](https://wiki.yandex-team.ru/passport/tvm2/) авторизации
- [**Ручка DJ**](http://dj-recommender.vs.market.yandex.net/recommend?experiment=ecom_crypta_viewer&puid=127989118) – специальная ручка на DJ, возвращающая по uid пользователя данные его еком-профиля

### Подготовка к локальной разработке проекта

В первую очередь нужно настроить тестовое окружения.

Для работы с blackbox и staff-api требуется получать tvm тикеты. Чтобы это делать локально, нужно:
1. Установить себе глобально TVM-демон `npm install -g tvmtool-bin --registry=http://npm.yandex-team.ru/`
2. Сконфигурировать его `npm run tvm:configure`.

По требованиям безопасности мы не можем ходить в продакшен blackbox. А значит авторизовываться придется тестовым аккаунтом, заведенным в тестовом паспорте. Сейчас это делается сложно. Если есть идеи как упростить этот процесс - велкам.
1. Сначала нужно завести себе аккаунт в [тестовом паспорте](https://passport-test.yandex.ru/). Принципиально важно чтобы логин совпадал в вашим логином на Стаффе.
2. Далее нужно под этим логином авторизоваться. Авторизация происходит в домене yandex.ru, поэтому вас выбросит из текущего продакшен-логина. Так уж оно работает ¯\_(ツ)_/¯.
3. Теперь нужно скопировать куку Session_id из домена yandex.ru в домен localhost. 

Далее готовим сам проект:
1. `npm i` - установка зависимостей и бутстрапинг

### Разработка

`npm run dev` - поднять клиент, сервер и tvm-демон в разработческом режиме, пересборка автоматическая при изменениях.

### Сборка docker-контейнера

Получить права для пуша в `registry.yandex.net/ecom-profile`

`./deploy.sh testing v0.0.1`

`./deploy.sh stable v0.0.1`

### Деплой в deploy.yandex-team.ru

Проект: https://deploy.yandex-team.ru/projects/ecom-profile

Стейдж с настроенным балансером:
`stable (ecom.crypta.yandex-team.ru)`

### Аутентификация

secret можно узнать [в секретнице](https://yav.yandex-team.ru/secret/sec-01g6qrxj720q1sg3me0mdmwxaa/explore/versions)
[Инструкция к tvm демону](https://wiki.yandex-team.ru/passport/tvm2/tvm-daemon/)
[Получение доступа к черному ящику](https://docs.yandex-team.ru/blackbox/concepts/getting-access)
[Как настроить TVM в Deploy](https://deploy.yandex-team.ru/docs/concepts/pod/sidecars/tvmtool)
