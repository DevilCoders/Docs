# Репорт.

## Стейт
- `report.data` - связи ID сущностей из коллекций, по которым строится денормализованный ответ
- `report.collections` - коллекции сущностей

Пример стейта можно посмотреть в `mocks/Report/basicData.js`


## GET `/yandsearch`
Главная ручка репорта, умеющая делать все на свете

  - place - де-факто метод, который мы хотим вызвать, влияет на структуру ответа и работу других query-параметров
  - [Описание существующих плэйсов](https://wiki.yandex-team.ru/testirovanie/functesting/market/marketservice/klaster-brigady-testirovanija-bekendov/report-places/main-places/)
  - [Описание query-параметров репорта](https://wiki.yandex-team.ru/market/verstka/report-query-params/)

## Принцип работы
1. Запрос попадает в мок
2. Мок создает контекст:
```
{
    place: {
        name, // Название текущего плэйса
        preProcess, // Функция предобработки стейта
        postProcess, // Функция постобработки стейта
        ...placeData, // Остальные данные, характерные плэйсу
    },
    params, // query-параметры запроса
    state, // глубокая копия стейта
    request, // запрос
    response, // ответ
};
```
3. Контекст передается в middleware
4. Если плэйс определяет ее, вызывается функция preProcess
5. Вызываются обработчики query-параметров, подходящие текущим параметрам
6. Если плэйс определяет ее, вызывается функция postProcess
7. Происходит денормализация результата по схеме из контекста
8. Генерируются фейковые данные

## Допущения
 - Чтобы обработчик query-параметра сработал, нужно предоставить ему все необходимые данные. Например, для сортировки по цене в place=prime у офферов и продуктов должны быть цены. Узнать, какие данные нужны можно из JSDoc обработчика
 - Если приложение запрашивает плэйс, которые еще не поддержан, запрос проксируется в реальный бэкенд (пытаемся не сломать старые тесты)
 - Если в стор не сложили никаких данных, отвечаем базовым набором (для того, чтобы не нужно было обязательно задавать данные, даже если тест не проверяет взаимодействие с репортом)
 - Автоматически генерируем только обязательные поля из схем, для повышения стабильности
 - Плэйсом по умолчанию для обработчиков параметров считается prime
 - Нет отправки ошибок

## Как добавить новый place?
1. Посмотреть, есть ли в `Report/entities.js` подходящая схема ответа. Если нет, создать ее
2. Добавить ключ с названием плэйса и его описанием в `Report/places.js`, добавить схему, по необходимости добавить функции preProcess/postProcess и другие данные
3. Если поведение каких-то query-параметров отличается в этом плэйсе, добавить в них нужную логику только для этого плэйса (не ломая обратную совместимость)

## Как добавить новый query-параметр?
1. Создать файл с названием query-параметра в `Report/middlewares`
2. Создать инстанс класса Composer
3. Если достаточно наличие query-параметра, а значение не важно - использовать метод `composer.param`, принимающий название query-параметра и функцию-обработчик.
Если нужен обработчик какого-то опредленного значения - использовать метод `composer.paramValue`, принимающий название query-параметра, значение (`string/RegExp`) и функцию-обработчик.
4. В обработчике проверить, есть ли все необходимые данные. Если нет - `return next();` (пропустить обработчик)
5. Написать логику обработчика, допускается мутировать `ctx.state`. Не забыть выполнить `return next();`, чтобы вызвался следующий обработчик.
6. Обязательно написать в JSDoc, какие данные нужны обработчику.
7. Импортировать и добавить созданный инстанс Composer в `Report/middlewares/index.js`.

## Как добавить новое значение query-параметра?
Шаги 3-6 из пункта о добавлении query-параметра
