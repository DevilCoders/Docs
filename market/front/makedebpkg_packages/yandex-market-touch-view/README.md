yandex-market-touch-view
----------------

Мобильный Маркет на XScript5.

### Информация о пакете

Этот PKGBUILD не совсем обычный. С его помощью можно собирать пакет с Маркетом для следующих целей:
  - Обычный релиз
  - Эксперимент

### Сборка пакета

Возможна кастомизация следующих переменных окружения(в скобках указано значение по умолчанию):

  - `_webapp_package_name`(yandex-market-touch-view) :: имя пакета, в который будет упаковано веб приложение
  - `_webapp_separate_slot`(false) :: если true, то запишет версию в имя пакета, заменив `.` на `-`. Требует указания `_webapp_destdir`
  - `_webapp_slot_name` :: если сборка происходит с `_webapp_separate_slot = true`, то значение переменной будет дописано в конец версии. Пример того что получится если эта переменная будет равна `o-lo-lo`: ```yandex-market-touch-view-17905-028284a1-o-lo-lo_17905.028284a1.o.lo.lo-1_all.deb```
  Обратите внимание на версию пакета, знаки `-` были заменены на `.`.
  - `_webapp_branch`(develop) :: ветка из которой будет собираться пакет
  - `_webapp_destdir`(/usr/local/www5/market-mobile для `_webapp_package_name=yandex-market-touch-view` и `/usr/local/www5/<_webapp_package_name_webapp_package_name>` в ином случае) :: целевая директория, в которую будут сложены файлы веб приложения
  - `_static_package_name`(см. [статический пакет](README.md#%D0%A1%D1%82%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82)) :: имя пакета, в который будет упакована статика веб приложения

Помимо указанных переменных существуют и другие, значения для которых определяются уже на уровне самого проекта. Я опишу их здесь для простоты, но имейте в виду, что эта информация может стать не актуальной. За актуальной информацией лучше обратиться в [репозиторий Маркета][market-repo].

Дополнительные переменные окружения, которые влияют на процесс сборки:
  - `YENV`(production) :: Целевое окружение для которого выполняется сборка

Какие из указанных переменных использовать зависит от того что вы хотите получить на выходе. У нас есть две(пока) цели, которые мы можем приследовать, собирая пакет:
  - Выложить стандартный релиз
  - Запустить эксперимент

О каждой из целей я написал далее.

В остальном к этому пакету применимы [общие инструкции по сборке][common-build-info].

#### Собрать классический релизный пакет

Под классическим релизным пакетом я понимаю пакет, имя которого `yandex-market-touch-view`.
Вы можете хотеть собрать его в том случае, если у вас обычный продуктовый релиз, не затрагивающий эксперименты.
Имейте в виду, что этот пакет является обновляемым, т.е. когда он будет установлен куда-либо то обновит версию, установленную до этого.

Это важно, потому что в некоторых случаях мы не хотим чтобы это происходило, вернее, хотим контролировать обновления более "точечно"(в случае экспериментов, например).

Чтобы выполнить сборку достаточно, находясь в папке с PKGBUILD вызвать команду:
```
../runner -g <id вашего gpg ключа> -c
```

На выходе получится пакет(версии в вашем случае будут отличаться)
`yandex-market-touch-view_17805.01484f1-1_all.deb`

Он будет ставиться в `/usr/local/www5/market-mobile`.
Удостовериться в этом можно с помощью команды `dpkg -c package.deb | less`(советую использовать less, т.к. файлов в пакете много).

#### Собрать эксперимент(или просто пакет с кастомным именем)

Допустим мы хотим собрать эксперимент с именем `experiment-name`. Для у нас должны должно иметься следующее:
  - Имя эксперимента, соответствующее PCRE `^[a-z0-9-]+$`
  - Ветка в системе контроля версий вида `exp/experiment-name`

Далее, находясь в папке с PKGBUILD этого пакета можно вызвать:
```bash
COMMON_REV=develop \
    _webapp_package_name=yandex-market-touch-view-exp \
    _webapp_branch=exp/experiment-name \
    _webapp_separate_slot=true \
    _webapp_slot_name=experiment-name \
    _webapp_destdir=/usr/local/www5/market-mobile-exp/experiment-name \
    ../runner -g <id вашего gpg ключа> -c
```

На выходе получится пакет(версии в вашем случае будут отличаться)
`yandex-market-touch-view-exp-17905-028284a1-experiment-name-1_17905.028284a1.experiment.name-1_all.deb`

Он будет ставиться в `/usr/local/www5/market-mobile-exp/experiment-name`, как мы и указали при запуске сборки.
Удостовериться в этом можно с помощью команды `dpkg -c package.deb | less`(советую использовать less, т.к. файлов в пакете много).

Если эксперимент нужно обновить, то можно просто вновь позвать `runner` с такими же переменными, система сборки вновь выкачает код из системы контроля версий и собирёт обновленную версию пакета, который затронет только конкретный эксперимент.

Больше информации:
  - [Задача][usersplit-task] по которой был сделан PKGBUILD. Там описан путь по которому мы прошли чтобы сделать этот пакет и затрагивается кондукторная магия, связанная с установкой этого пакета.

### Статический пакет

На данный момент статический пакет не собирается потому что вся статика отдаётся с фронтов напрямую(без статического кластера). Это вызвано большими проблемами с фризом, одолевавшими наш проект в последнее время. В итоге мы временно отказались от сборки отдельного пакета со статикой. Сейчас вопрос о переделке сборки отправлен в дальний ящик, есть вероятность что мы к этому не вернёмся, потому что страницы постепенно переезжают в nodejs.

### Загрузка в репозиторий

Этот пакет нужно загрузить в репозиторий [market][repo-link].

Информация о том [как загружать пакеты][package-upload-info].

### Дебаг

В папке с `PKGBUILD` присутствует директория `patches`, внутри которой можно найти патчи для облегчения пакета с целью дебага. Возможно в будущем там появятся патчи для каких-нибудь других случаев.

[common-build-info]: https://github.yandex-team.ru/market/packages#%D0%A1%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2
[repo-link]: https://github.yandex-team.ru/market/packages/blob/master/README.md#market
[package-upload-info]: https://github.yandex-team.ru/market/packages/blob/master/README.md#%D0%97%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D0%B2-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B9
[usersplit-task]: https://st.yandex-team.ru/MARKETVERSTKA-12696
[market-repo]: https://github.yandex-team.ru/market/market
[common-repo]: https://github.yandex-team.ru/market/common
[production-build-config]: https://github.yandex-team.ru/market/market/blob/develop/configs/production/build.mk
[market-vendor-libs]: https://github.yandex-team.ru/market/market-vendor-libs
