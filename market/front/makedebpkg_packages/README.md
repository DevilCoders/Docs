Debian пакеты Фронтэнда Маркета
--------------------

В данном репозитории содержатся конфигурации для сборки пакетов инструментом [makedebpkg](https://github.yandex-team.ru/market/makedebpkg). Про инструмент лучше всего прочитать в [README](https://github.yandex-team.ru/market/makedebpkg/blob/master/README.org) его репозитория.
На случай ядерной войны мы имеем собственное зеркало с этим [инструментом](https://github.yandex-team.ru/market/makedebpkg).

Обращаю внимание на тот факт, что ещё далеко не все пакеты, с которыми мы(фронтэнд Маркета) имеем дело переведены на этот способ сборки.

Если вы хотите собрать новый пакет для Маркета, то этот репозиторий - самое правильное место для размещения его `PKGBUILD`.

Структура директорий и файлов:
```
/
    имя-пакета/
        PKGBUILD   # Файл с конфигурацией сборки для пакета
        README.md  # Информация о собираемом пакете
        templates  # Папка с шаблонными файлами
        install    # Папка с хук-скриптами(postinst, ...)
        runner     # Скрипт, содержащий знание о том как надо запускать сборку(makedebpkg)
```

Данная структура не накладывает ограничений на присутствие в папке других файлов(это может быть удобно в некоторых случаях, например для хранения init скриптов).


### FAQ

#### Алгоритм раскатки

1. Собрать пакет
2. Загрузить пакет в dist.yandex.ru
3. Выложить новую версию в кондукторе

#### Как собрать пакет

----------------------------------------------


1. Установить Docker с  Ubuntu
2. Перейти в директорию пакета, которых хотим собрать (директория содержит файл PKGBUILD) 
3. Запустить сборку:

```bash
export rev=master;          # Предположим, что мы хотим собрать пакет из ветки master(Не все PKGBUILD поддерживают эту переменную)
../runner -c -g 0x0ED74526; # Запускает сборку пакета(-c для очистки репозитория перед сборкой, -g для указания GPG ключа)
```

Посмотреть свой gpg-ключ можно коммандой:
`gpg --list-keys`

Про gpg ключи можно более подробно почитать [здесь](#gnupg).

4. Понять, что части зависимостей не хватает (git, pip, debsign и т.д.). Их можно доустановить через `apt-get install`
5. После этих действий в папке с PKGBUILD пакета должен появиться симлинк на собранный пакет, а папка `pkg` будет содержать всю продукцию сборки.

#### Как загрузить пакет в dist.yandex.ru

Для загрузки используется [dupload](http://h.yandex.net/?http://manpages.ubuntu.com/manpages/gutsy/man1/dupload.1.html), который доступен в системных репозиториях.

Этот инструмент **требуется сконфигурировать перед использованием**(иначе пакет загрузится в публичные репозитории!), конфиг лежит в этом репозитории. Вставьте это в терминал:
```
curl -L https://github.yandex-team.ru/market/packages/raw/master/dupload.conf  | sed "s/robot-metatron/"${USER}"/g" > ~/.dupload.conf
```

Для загрузки пакета потребуется подписанный `.changes` файл(цифровая подпись прикрепляется в процессе сборки). Предположим, что мы хотим загрузить пакет `yandex-market-skubi` и находимся в папке с его PKGBUILD:

```
dupload --to=market-common pkg/yandex-market-skubi_341.09e55873-3_amd64.changes
```

#### Как посмотреть содержимое пакета/куда он ставится по тикету в кондукторе
Допустим у нас есть тикет https://c.yandex-team.ru/tickets/684645 и мы хотим узнать куда установится пакет(ы) который в нём едет.

В этом тикете производится выкладка пакета `yandex-market-export-www-static=92.01cab30d-1`.
Скопировав эти данные запускаем скрипт `find_package.sh` на dist по SSH, фильтруя его вывод по содержанию в нём версии пакета:
```
$ ssh dist.yandex.net find_package.sh yandex-market-export-www-static | grep 92.01cab30d-1
/repo/verstka/stable/yandex-market-export-www-static-92-01cab30d_92.01cab30d-1_all.changes
/repo/verstka/stable/all/yandex-market-export-www-static-92-01cab30d_92.01cab30d-1_all.deb
/repo/verstka/stable/source/yandex-market-export-www-static-92-01cab30d_92.01cab30d-1.dsc
/repo/verstka/stable/source/yandex-market-export-www-static-92-01cab30d_92.01cab30d-1.tar.gz
```
Нас интересует вторая строка(потому что это пакет, заканчивается на `.deb`). Теперь, зная путь к пакету мы можем посмотреть его содержимое:
```
$ ssh dist.yandex.net dpkg -c /repo/verstka/stable/all/yandex-market-export-www-static-92-01cab30d_92.01cab30d-1_all.deb | less
drwxr-xr-x root/root         0 2015-09-16 17:48 ./
drwxr-xr-x root/root         0 2015-09-16 17:48 ./usr/
drwxr-xr-x root/root         0 2015-09-16 17:48 ./usr/doc/
drwxr-xr-x root/root         0 2015-09-16 17:48 ./usr/doc/yandex-market-export-www-static-92-01cab30d/
... +~255 строк
```
Здесь используется pager - less, который не даст вашему терминалу взорваться от обилия выводимых строк.

Если вы не хотите делать несколько действий, то можно добавить следующие функции в ваш `.bashrc`:
```
dist_package() {
    local package="$1"
    local version="$2"

    if [ -z "$package" ] || [ -z "$version" ]; then
        echo "Usage: dist_package <package> <version>" 1>&2
        return 1
    fi

    ssh dist.yandex.net find_package.sh "$package" | grep -- "$version" | grep '\.deb$'
}

dist_contents() {
    local package="$(dist_package $*)"
    if [ -z "$package" ]; then
        echo "Package '$*' was not found in dist" 1>&2
        return 1
    fi

    ssh dist.yandex.net dpkg -c "$package" | less
}
```

#### Как формируется путь для установки статического пакета?
В Яндексе есть [CDN][cdn], на который выкладываются пакеты с `css,js,html,...`(статикой).

Каждый пакет, устанавливаемый на CDN, распаковывается в `/usr/local/www/static.yandex.net`.
Эта папка является публично доступным docroot по адресу https://yastatic.net, внутрь которой ставятся «проектные папки».
Если у нас есть пакет `yandex-market-foo-bar` с версией `111.abcdef-1`(версия приложения `111.abcdef` и ревизия скрипта для сборки пакета `1`), то он должен ставится в папку `/usr/local/www/static.yandex.net/market-foo-bar/111.abcdef`.

Внутри этой папки может быть любая структура. Если вы сомневаетесь, то лучше обратиться вопросу «Как посмотреть содержимое пакета/куда он ставится по тикету в кондукторе».


### Хелперы

При написании своего PKGBUILD можно пользоваться готовыми хелперами `source ../helpers`. Этот файл содержит в себе набор функций, призванный упростить и увеличить гибкость скриптов сборки.

### Создание нового пакета

Используйте шаблон в корне репозитория - `skeleton`.

```bash
cp -r skeleton yandex-market-your-package
```

Не забудьте описать в README этого пакета его предназначение и особенности.
А также поправьте PKGBUILD и скрипты на ваше усмотрение.

#### Используемые репозитории

##### market-common

Репозиторий с пакетами Маркета. По большому счёту это просто большая куча наших пакетов, ничего особенного.

##### market-lucid

Этот репозиторий служит для загрузки маркетных пакетов, которые будут устанавливаться на системы с 64-битной архитектурой.

##### verstka

В этот репозиторий загружаются пакеты для PORTAL, портального статического кластера, которые поедут на yastatic.net или betastatic.yastatic.net.

##### market-frontend-ci

Это secdist репозиторий. Пакеты для него лежат в отдельном приватном git [репозитории](https://github.yandex-team.ru/market/secdist-packages).

##### market
Deprecated.
Репозиторий служил для загрузки всех пакетов, имеющих отношение к Маркету.

##### market-amd64
Deprecated.
Репозиторий служил для загрузки всех пакетов, имеющих отношение к Маркету, которые должны быть установлены в amd64 среду.

#### GnuPG

Чтобы узнать идентификатор своего ключа наберите в терминале `gpg --list-keys`. Вам нужно шестнадцатеричное число после `pub .../`, в моём случае это выглядит так:

![gpg](http://jing.yandex-team.ru/files/corpix/5e85b401548c848835bd6269a6c11d9f0615cb74.png)

Например, идентификатор моего ключа `0x0ED74526`.

#### Версии

Обычно выглядят так: `1.50-36`.

Часть до `-` это номер версии кода самого проекта, после - ревизия `PKGBUILD`, использованного для сборки пакета.

Факты:
  - версии пакетов либо выставляются руками, либо генерируются автоматически на основе данных из репозитория
  - версия состоит из версии идентифицирующей сам проект упакованный в пакет и ревизию, которая соответствует версии PKGBUILD

#### Структура имени файла пакета
Я укажу здесь пример для пакета, версия которого была взята из системы контроля версий. Он не сильно отличается от пакета с фиксированной в PKGBUILD версией(добавлены только две новые сущности: номер и хэш коммита):
```
                                        | Версия пакета
                                 ---------------
                                /               \
yandex-market-x5-view-exp-ololo_17726.0f8eb7ef-11_all.deb
\-----------------------------/ \---/ \------/ \/ \-/
   ^                              ^       ^    ^   ^ Архитектура для которой собран пакет
   | Имя пакета                   |       |    | Ревизия пакета
                                  |       | Хэш коммита из git, к которому добавлен лидирующий 0
                                  |
                                  | Номер коммита из git
```

##### Генерация версий

Для генерации версии на основе данных из репозитория(номер коммита+хэш) у нас есть специальный [helper][helper-link].

*Будьте осторожны, собирая пакет из своих веток. Если при вливании вы делаете squash коммитов, то номер версии будет другим(ниже тех, что вы собирали) и может появиться коллизия в случае загрузки пакетов в dist*

### Jinja-шаблонизация в пакете
```runner``` шаблонизирует все файлы с расширением .j2 с помощью jinja2. После этапа шаблонизации, рядом с этими файлами будут отрендеренные файлы с тем же именем, без расширения .j2. Например, ```init.d.service.j2 → init.d.service```.
От шаблонизации с помощью угловых скобочек и однострочника на perl, отказываемся.
В качестве конфига используются python-файлы, хранящиеся в пакете. Пример:
```(python)
export(
    pkgname = "yandex-market-node-demo-watcher",
    destdir = "/usr/share/yandex-market-node-demo-watcher",
    maintainer = "cornholio <cornholio@yandex-team.ru>"
)
```
Все ```**kwargs```, переданные функции ```export``` будут доступны в шаблоне через глобальную переменную ```config```. То есть, ```pkgname``` из примера выше можно получить как ```{{config.pkgname}}```.
Указать файл конфига можно через ```../runner -C config.py```.
Если файл не указан, по умолчанию будет использован файл ```default.py```. Если его нет на ФС, сборка продолжится без использования файла конфига.

Ещё магия:
* Вставляйте файлы через ```{{include_file("filename")}}```. Имя файла нужно указывать относительно папки с пакетом. Эти файлы также будут отшаблонизированы. Используйте ```{{include_file("filename", enclose=False)}}```, чтобы в шаблонах не оставлять комментарии с именами исходных файлов. Используйте ```{{include_file("filename", vars={"a": "b"})}}```, чтобы передать переменные в шаблон.
* Используйте функцию ```ignore_if``` (например, ```{{ignore_if(config.exp_package)}}```) в начале шаблона, чтобы этот шаблон не рендерился. Тогда можно рендерить разные шаблоны, в зависимости от конфига. Сборка не упадёт из-за отсутствия переменных.
* Переменные окружения доступны через объект ```environ```. Например, ```{{environ.YENV}}```. Удобно использовать в связке с фильтром default: ```rev="{{environ.rev|default("master")}}"```
* ```{{"https://github.yandex-team.ru/market/packages.git"|extract_repo_from_url}}``` напишет "packages". Мелочь, но позволяет держать меньше переменных.


[helper-link]: https://github.yandex-team.ru/market/packages/blob/fd8171b4bcf79f94f06d1284bf89b1408a6492c9/helpers#L53-L60
[cdn]: https://beta.wiki.yandex-team.ru/verstka/static/
