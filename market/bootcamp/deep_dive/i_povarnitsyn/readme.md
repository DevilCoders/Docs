# Популярность модели
## Постановка задачи
Есть таблица с запросами пользователей на маркете за определенный день. В таблице есть информация о том, к какой категории осуществлялся поиск, 
а также информация о моделях, которые были запрошены (это разные запросы. Пайплайн пользователя: категория -> модель -> оффер).

Нужно узнать насколько популярна модель среди пользователей в данной категории. Для этого надо посчитать процент показов модели в категории по 
отношению ко всем запросам на категорию. Для запросов к категории следует искать запросы в которых фигурирует cgi-параметр &place=prime. За 
категорию отвечает параметр &hid=

Для запросов информации о модели следует искать запрос с &place=productoffers, За модель отвечает параметр &hyperid

## Подзадачи

### YQL запрос
#### Задача:
Написать YQL запрос выдергивающий необходимые для решения тематической задачи данные и складывающий в hahn.`tmp/povarnitsyn/model_popularity` и 
настроить расписание для его выполнения

#### Решение: 
Создана sandbox задача: https://sandbox.yandex-team.ru/scheduler/17229/view

### Конвертер из YT-table в protobuf

#### Задача:
Разработать на С++ программу-конвертер, которая на вход принимает путь к YT-таблице, созданной в предыдущем задании, название кластера (hahn/arnold), 
токен (или путь на файловой системе до токена) и путь файловой системы для сохранения результата, а на выходе получает удобную для выполнения 
тематического задания структуру данных в одном из принятых в маркете бинарном формате данных (protobuf или flatbuffers)

#### Решение: 
Реализован модуль transformer. 

```bash
./transformer -c CLUSTER_NAME -i YT_TABLE_PATH -t YT_TOKEN  -o OUT_PATH
```
Переводит содержимое таблицы CLUSTER_NAME.YT_TABLE_PATH в protobuf с помощью модуля protos. Cохраняет результат в OUT_PATH

### Handler
#### Задача:
Разработать на С++ программу, которая принимая на вход путь до protobuf-файла будет зачитывать его в структуру данных, выполняя необходимый 
предрасчет, для того чтоб быстро отвечать на вопросы.

Виды вопросов:
* По дате, id категории и id модели получить процент показов этой модели в этот день, относительно показов всей категории
* По дате и id категории получить список всех id моделей этой категории, показывавшихся в этот день и процент их показов относительно общего числа

#### Решение: 
Реализован модуль handler. 
Примеры использования для запросов первого
```bash
./handler -t getPercent -d DATE -c CATEGORY_ID -m MODEL_ID
```
и второго типа
```bash
./handler -t getModels -d DATE -c CATEGORY_ID
```

### Server
#### Задача:
Разработать на питоне приложение-обертку, которая предоставит http-api к поисковой программе на C++ для ответов на вопросы тематики.
#### Решение: 
Реализован модуль server.
 
Примеры использования:
Запускаем сервер
```bash
./server
```
Для получения ответа на вопрос первого типа отправляем запрос следующего вида:
```bash
curl 'localhost:5003/handler?type=getModels&date=DATE&category=CATEGORY_ID'
```
Для получения ответа на вопрос второго типа отправляем запрос следующего вида:
```bash
curl 'localhost:5003/handler?type=getPercent&date=DATE&category=CATEGORY_ID&model=MODEL_ID'
```

## Сборка

Рекомендуется собирать со следующими ключами:
```bash
ya  make --add-result .py --add-result .a --add-result .h --add-result pb2.py --add-result _pb2 --force-build-depends --yt-store --add-protobuf-result --checkout
```
После этого в дирректориях модулей handler, server и transformer появятся исполняемые фалы с соответствующими названиями