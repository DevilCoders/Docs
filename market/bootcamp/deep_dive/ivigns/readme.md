# Длительность запросов

## Постановка задачи

Есть таблица с запросами пользователей. Нужно определить, в какое время выполняются запросы определенного типа (группировка по &place=).

Нужно быстро получать:
 - топ-N самых тяжелых (длительных запросов), в какой плейс был запрос, минимальное и максимальное время работы запроса для этого плейса
 - топ-N самых легких запросов + информация из пункта выше
 - Персентили (50, 70, 90, 95, 99.0, 99.5, 99.99) для каждого плейса.

 ## Модули

 ### yt-table-to-protobuf

Скачивает YT-таблицы `//tmp/ivigns/theme-task-requests` (с запросами и временем их выполнения), `//tmp/ivigns/theme-task-percentiles` (с персентилями для каждого плейса) с указанного YT-кластера и записывает данные в протобуф `solver/proto` для дальнейшей обработки модулем `solver`. Нужно также указать токен для авторизации.

 ```bash
 cd yt-table-to-protobuf  # важный шаг!
 ya make
 ./yt-table-to-protobuf --cluster название_кластера --token токен
 ```

 ### solver

 Данные из протобуфа `solver/proto` помещаются в специальную структуру данных, с помощью которой можно быстро отвечать на требуемые запросы. В аргументах указывается тип запроса (топ самых тяжелых / топ самых легких / персентиль, см. `--help`), количество запросов в топе или нужный персентиль, place, из которого приходят запросы.

 ```bash
 cd solver
 ya make
 ./solver --query тип_запроса --N размер_топа_или_процент --place place
 ```

### server

Http-обертка над предыдущими модулями. Аргументы к предыдущим модулям прописываются в параметрах http запроса. Работа с `yt-table-to-protobuf` осуществляется через путь `/load`, работа с `solver` - через `/query`.

```bash
 cd server  # все еще важный шаг!
 ya make
 ./server
 ```

 ### cpp-server

 Модуль, комбинирующий в себе функционал `server` и `solver`. Причем, работает быстрее комбинации предыдущих двух за счет того, что предпосчет происходит только один раз. Запросы осуществляются так же, как в `server`, через `/query`.

 Требуется, чтобы предварительно `yt-table-to-protobuf` создал протобуф `solver/proto`.

```bash
cd cpp-server
ya make
./cpp-server -c cfg.pb.txt -p любой_открытый_порт
```

Примеры запросов (сервер работает на `localhost:5000`):
```bash
# топ 10 самых тяжелых из prime
curl 'localhost:5000/query?query=tops&N=10&place=prime'
# самый быстрый из prime
curl 'localhost:5000/query?query=topf&N=1&place=prime'
# процентиль 99.99 для prime
curl 'localhost:5000/query?query=perc&N=99.99&place=prime'
```
