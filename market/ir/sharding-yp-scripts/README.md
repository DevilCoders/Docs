### Скрипты для изменения конфигурации шардирования

Термины:
- Шард - сервис с полезной нагрузкой, обрабатывающий часть данных (принадлежащих этому шарду)
- Мета - вспомогательный сервис, агрегирующий запросы к шардам
- Кластер - набор из меты и шардов, в которые она ходит, по сути является минимальной еденицей деплоя
- Лейбл - по сути env переменная в контейнере. Для шардирования используется лейбл shard_id - номер шарда внутри кластера и replica_id - номер кластера. Шарды деплоятся по кластерно (используя специальный рецепт в няне), также используется ограничение antiaffinity по лейблу replica_id.
- shard_id используется для определения шарда данных, которые нужно процессить.
- replica_id используется метой для нахождения всех шардов данного кластера

Алгоритм:
1. Обновляем по одному ДЦ за раз
2. Перед добавлением подов для избежания не консистентных ответов нужно убрать поды меты текущего ДЦ из service discovery, тем самым вызовы через балансер будут игнорировать все поды данного ДЦ. Открываем сервис в няне, переходим на вкладку Endpoint Sets и редактируем endpoint set (совпадает с именем сервиса) так, чтобы ему не соответсвовал ни один под (например выбираем ДЦ на MYT) 
4. Запускаем скрип  `extend_shards.py`. Указываем service_id, ДЦ, количество шардов и кластеров. Перед запуском скрипта должен существовать хотя бы один под с корректной конфигурацией, на его основе будут создаваться новые поды. Вначале скрипт пробегается по текущим подам, сортирует их по имени (в случае с енам именем подов это позволяет легко понять какому кластеру и шарду принадлежит под, так `shard_id = pod_num % shards_count`, `replica_id = pod_num // shards_count`). Далее скрипт создает недостающие поды и выставляем им соотвествующие лейблы `shard_id` и `replica_id`
5. Далее заходим в няню и проверяем что поды создались. Переходим во вкладку instances и ставим галочки на новые поды. Сохраняем и активируем снэпшот
6. После того как сервис поднялся, проверяем мониторинги и включаем эндпоинсеты. Для этого запускает скрипт `enable_ednpointset.py`.  Указываем service_id, количество кластеров и ДЦ. Данный скрипт пробегается по существующим эндпоинтсетам и ставим им валидные под фильтры (например для `prod_market_matcher_shard_yp_sas_cluster_0` pod filter `[/labels/replica_id] = '0'`). В случае отсутсвия эндпоинтсета скрипт создаст недостающие
7. Проделываем шаг 4-5 для меты - досоздаем поды для новых миникластеров. В качестве shards_count следует установить 1 (на миникластер 1 мета и n шардов)
8. Возвращаем конфигурацию ednpoint set для меты в исходное состояние, чтобы по балансеру можно было достучаться до подов.
9. Ждем пока мета обновит список шардов и проверяем что ничего не сломали
