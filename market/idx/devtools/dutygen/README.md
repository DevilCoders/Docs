# Генератор расписаний дежурств

На текущий момент умеет загружать календарь из Вики или CSV файла и генерировать расписание дежурств службы подготовки данных.

Источник информации о ресурсах - таблица с ресурсами.
Ограничения задаются в коде: https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/devtools/dutygen/lib/market.py

## Использование
1. Запуск с загрузкой отпусков из wiki таблицы
```
./dutygen --token-path duty.token --start-date 2019-08-03 --end-date 2019-09-01 -o duties.csv
```
2. Запуск с загрузкой отпусков из csv файла
```
./dutygen --start-date 2019-08-03 --end-date 2019-09-01 --input-calendar one-day-duty_up_to_20190802.csv --output-calendar duty_20190803_20190901.csv  --output-calendar2 new-duty2.csv
```

## Получение токена для работы с wiki
1. Открыть в браузере https://oauth.yandex-team.ru/authorize?response_type=token&client_id=008de97c588d43cabb5a3e505b7fbd8c
2. Нажать кнопку "Разрешить"
3. Скопировать токен в файл


## Критерии формирования расписания (TODO)
- соседние будни к отпуску не ставится OnCall
- одинаковое количество длинных дежурств в квартале
- одинаковое количество OnCall дежурств в квартале
- одинаковое количество OnCall дежурств по выходным в квартале

- длинные дежурства квартала расставляются в порядке эффективности разработчика (обратный количеству встреч)
- OnCall дежурства расставляются в порядке эффективности разработчика (обратный количеству встреч)
- длинные дежурства в квартале на одного человека разные по составу
- длинные дежурства распределены равномерно в квартале (максимально далеко с учетом соседних кварталов), не должно быть подряд длинных дежурств
- OnCall дежурства распределены равномерно в квартале
- OnCall дежурства максимально далеко от длинных дежурств
- OnCall дежурства в квартале в разные дни недели
- в неделе примерно одинаковое количество OnCall дежурных datacamp/indexer

- новички на длинные дежурства через 2 месяца, на OnCall через 3
- новички не дежурят одновременно друг с другом

- в новогодние каникулы дежурят руководители
- в выходные и праздники нет длинных дежурств
- учитываются гендерные праздники


## TODO
  - [ ] Всё-таки возвращаться назад после исключения "Impossible..."
  - [ ] lookahead факторы: если в середине недели есть reserved day, нельзя начинать с понедельника на этого человека ставить длинные смены
  - [ ] Квоты у ресурсов (дней в месяц)
  - [ ] Синхронизация с репортом
  - [+] Реализовать синтаксис исключений для ресурсов
  - [+] Решить проблему тупика - проверять будущие смены дублицированием
    дублить смену в будущее до выходного и переносить длинные смены
  - [+] Восстановить факторы
    - [+] разнообразие - не работает
    - [+] кол-во в квартал
    - [+] региональность
  - [ ] Фактор для сапорта, что впереди достаточно рабочих дней для длинной смены сапорта
  - [+] Копировать неизвестные поля как есть: Done, ДН, или таки сделать подпорку для ДН
  - [ ] Генерировать личные календари
  - [+] Нормализовать факторы: 0..1
  - [+] Поддержать для разных ролей смены разной длины (однодневные incident смены)
        Отойти от смены и сконцентрироваться на календаре.
        Для каждого дня в календаре найти роли и исполнителей.
        В нерабочие дни нет incident и release дежурных, но fuckup есть всегда.
  - [+] Написать конвертор старого формата таблицы в новый
  - [+] Добавить фактор пессимизирующий смены, в которых дежурят только новые разработчики
  - [+] Добавить фактор пессимизирующий смены, в которых дежурят разработчики из одного проекта
  - [ ] Поддержать прямое чение из wiki
  - [ ] Поддержать прямую запись в wiki
  - [ ] Дописать README

## Ссылки
- [Корневой тикет](https://st.yandex-team.ru/MARKETINDEXER-29857)
- [Регулярка в инфре для вычисления актуального дежурного по календарю индексатора](https://github.yandex-team.ru/market-infra/tsum/blob/master/tsum-core/src/main/java/ru/yandex/market/tsum/core/duty/DutyLoginExtractors.java#L14)
- [Крон в инфре для переключения звонков на актуального дежурного](https://github.yandex-team.ru/market-infra/tsum/blob/master/tsum-tms/src/main/java/ru/yandex/market/tsum/tms/tasks/duty/switchduty/SwitchDutyIdx.java#L40)