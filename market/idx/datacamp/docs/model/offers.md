## Идентификация / Нормализация { #normal }
![Идентификаторы](../_images/offer-normal-id.png "Идентификаторы" =198x361)
![Пример](../_images/offer-normal-example.png "Пример")

* [Wiki](https://wiki.yandex-team.ru/market/development/indexer/arxitektura-marketnogo-indeksatora/Offer-Repository/Platform/#identifikacija)

Конкретный пример для понимания нормализации оффера во внутреннем стейте DataCamp-а:
- описание оффера одно (например у телека всегда диагональ сколько-то дюймов) => это уровень `(business_id, offer_id)` a.k.a. **базовый** оффер
- условия продажи (например цена телека / cpc или cpa) могут меняться в разных комбинациях => это следующая размерность в стейте `(business_id, offer_id, shop_id)` a.k.a. **сервисный** оффер
- поскладские условия (например кол-во в наличии / доставка) могут меняться в рамках одного shop_id => еще одна размерность `(business_id, offer_id, shop_id, warehouse_id)` a.k.a. **актуальный сервисный** оффер

#### FAQ по нормализации
- Что именно содержит в себе сейчас базовый оффер? А сервисный?
  - Базовый оффер содержит в себе: большая часть OfferContent, картинки OfferPictures, часть Resolution.
  - В сервисных и актуальных частях хранятся все остальные поля.
- Сервисная часть - это относящаяся к конкретному магазину? Без разбиения по складам? А деление по складам есть?
  - Сервисная часть хранит цены, некоторые контентные поля, скрытия партнера, некоторые типы вердиктов.
  - Деление по складам есть только в актуальной части. Но в UnitedOffer поле actual может быть не заполнено, все зависит от ситуации, в которой используется UnitedOffer.
- Что представляет из себя актуальная часть оффера?
  - Актуальная таблица хранит: маркетную доставку, стоки, некоторые типы скрытий и вердиктов.
  - Для синих и dbs можно называть ее "складскуя информация".
  - Для ADV и директа складов нет, поэтому актуальная часть хоть и содержит тот же набор полей, что и синий, но складской эту информацию нельзя.
- Это все, других частей оффера нет? (Т.е. есть только базовая, сервисная, актуальная)
  - Да
- Информация может быть и в сервисной части, и в базовой? В таком случае сервисная перетирает базовую? Какие из основных полей оффера живут в таком формате (идентификаторы (msku, например), название оффера и т п, интересуют наиболее часто используемые)?
  - Такое может быть, но редко. Сервисная перетирает базовую, а актуальная (складская) перетирает их обоих.
  - Оффер постоянно эволюционирует, тут сложно что-то предсказать: еще недавно market_sku_id мог храниться только в актуальной, но сейчас может быть и в сервисной.
- В каком случае достаточно использования базового оффера? (Если сходу есть примеры задач, в которых используется базовый и этого достаточно)
  - В ПИ при редактировании/создании оффера может быть осуществлена работа только с базовой частью.
- Есть ли способ получать не всю информацию из ОХ по офферу? (Иногда бывают очень жирные, при этом содержат 95% информации, которая для наших задач не нужна)
  - На данный момент такой возможности нет, но мысли такие были.
- Верно ли, что базовый оффер можно получить по ручке GET /v1/partners/<business_id>/offers/basic?offer_id=<offer_id>, сервисный - по ручке GET /v1/partners/<business_id>/offers/services/<service_id>?offer_id=<offer_id>.
  - Да, но в случае с сервсиными, складская часть не будет мержиться (вернется только сервисная, или актуальная с нулевым складом: для ADV и direct)
- Верно ли, что если нам нужны кусочки из обеих частей, то у нас два варианта: (1) получение цельного оффера ([ручка](https://docs.yandex-team.ru/market-datacamp/components/stroller-api#poluchenie-celnogo-offeraofferov-magazina)); (2) получить united оффера и смержить ([ручка](https://docs.yandex-team.ru/market-datacamp/components/stroller-api#batch-operacii-s-offerami) с подзапросом GET). В чем отличие? Какой предпочтительнее? Если в первой ручке ходить без указания склада, то что мы получим?
  - Большинство использует batch-ручку.
  - Если в первой ручке не указать номер склада, то вернется смерженный базовый и сервисный оффер (для ADV и директа подмержится еще и актальная часть)
- Есть ли способ однозначно проверить, в какой (или каких) частях оффера хранится информация?
  - Есть разметка, но не на всех полях. Мы планомерно работаем над этим.
  - [Пример](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferStatus.proto?rev=r8800358#L84) того, как repited поля могут быть разложены по частям оффера, в зависимости от meta.source.
  - [Пример](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferContent.proto?rev=r8797567#L1161) в котором часть полей в базовой, а quantum_of_supply может быть и в базовой, и в сервисной.
- В продолжение предыдущего вопроса: нам сейчас очень важно понять откуда правильно брать msku. Оно сейчас дублируется в огромном множестве полей + может отличаться в сервисной и базовой части ([пример](https://paste.yandex-team.ru/5929388)), а у нас на него завязано много важной функциональности. Поля, на которые мы сейчас смотрим: identifiers.extra.market_sku & content.binding.uc_mapping.market_sku_id . Также планируем добавлять content.binging.approved . Скажите, как правильно его читать (в какой последовательности из каких полей/частей оффера). И как правильно его получать из ОХ (1) в случае выгрузок white_out/blue_out; (2) в случае запроса по http. Также для dbs его значение (местоположение) похоже отличается от синих, и еще есть некие виртуальные msku. В общем, в рамках этого вопроса хотелось бы получить всю актуальную по msku информацию. Так много, как сможете.
  - Множество мест хранения msku это проблема. Есть тикет https://st.yandex-team.ru/MARKETINDEXER-39794.
  - На данный момент:
    - В extra.identifiers (сервисная и актуальная часть) хранится то же, что и в approved/blue_uc_mapping (из базовой), но только для синих офферов. Для остальных там ничего не должно быть.
    - В approved хранится подтвержденный в КИ маппинг (причем он может быть вирутальный, но это важно только при построении поколения)
    - blue_uc_mapping - это тоже, что и approved, мы хотели бы от него отказаться, но поддерживаем для потребителей.
    - uc_mapping - маппинг по данным от УК (не всегда подтвержденный). Может использоваться для dbs.
    - approved, blue_uc_mapping, uc_mapping - хранятся в базовой части.
- Цены сейчас хранятся только в сервисной части? Были разговоры чтобы унести их в базовую, от этого отказались? Т е если нам нужна информация по стратегиям ДЦО ( price.dynamic_pricing ) нам по http достаточно получить сервисный оффер?
  - Скорое в базовой появится цена, это правда. Но пока это не так.
  - На данный момент dynamic_pricing хранится в сервисной части.

## Наборы или размерности данных

Для многих частей оффера есть несколько полей. Как правило это разделение на **original / actual / market**. Оригинальные поля - это данные партнера (какими он их принес), актуальные - после прогона через различные валидации в сервисе [miner](../components/miner.md), маркетные - обогащенные из сторонних сервисов (например инфа про маркетную карточку). Подробнее на картинке

![Пример](../_images/offer-variations.png)

## Форматы внешний и внутрений { #formats }

При обработке оффер может быть представлен в нескольких форматах:
- [UnitedOffer](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/UnitedOffer.proto?rev=r9384916#L26) - наиболее "прогрессивный". Служит для нормализованного представления оффера
- [DataCampOffer](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/DataCampOffer.proto?rev=r9384916#L41) - "плоский оффер". Получается из united-а путем фиксации конкретных `shop_id, warehouse_id`. Потребляется, например, индексатором маркета: оффер в данном формате соответствует одному документу в индексе, описывая конкретное товарное предложение
- [ExternalOffer](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/external/Offer.proto?rev=r9384916#L31) - "плоский" оффер. В некотором роде является view над `DataCampOffer`. Используется при взаимодействии с немаркетными сервисами ecom-платформы (директ, товарная вертикаль)
- Если вам нужен кастомный формат, его добавление описано в [доках подписки](../for-developers/new-subscriber.md#custom-format)

## Версионирование

Подробнее в [доках подписки](../for-developers/new-subscriber.md#versioned-fields)

## Раскраска

## Классы офферов
[Статистика](https://datalens.yandex-team.ru/c6940dlpde3g8-datacamp-dashbord?tab=Zg)

1. Маркетные
    - CPA
      - 1P
      - 3P [FBY FBS](https://yandex.ru/support/marketplace/models.html)
      - DBS
    - CPC: ADV
2. Директ
    - Фиды
    - Дикий веб
    - Превью
    - Превью по сайту
    - ТГО
3. Еда
4. Лавка
5. Вертикали
    - Фиды
    - Дикий веб
