
## Типы скрытий

```PUSH_PARTNER_OFFICE``` - значение установлено через Пользовательский Интерфейс

```PUSH_PARTNER_API``` - значение установленно через API

```PUSH_PARTNER_FEED``` - значение установленно через фид(явно через тег disabled или в случае отсутствия офера в complete фиде)

```MARKET_IDX``` - тип скрытия офера, который не готов к индексации(нету критическо важных полей, например весогабаритов)

Остальные источники можно найти [тут](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferMeta.proto)

## Интегральный статус
- [Wiki](https://wiki.yandex-team.ru/development/indexer/arxitektura-marketnogo-indeksatora/offer-repository/integralnyjj-status/)

### Техническая реализация
[Интегральный статус контента](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/ContentStatus.proto?rev=r8896397#L28) считается в транзакции при создании/обновлении оффера и сохраняется в базовую таблицу, имеет мету. Статус считается на основе только базовой части оффера.

[Интегральный статус оффера](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferStatus.proto?rev=r8896397#L74) считается на уровне магазина на основе базовой + сервисной + всех складских частей оффера (кусок используемой шопсдаты сохраняется в сервисную часть). Статус является вычислимым, а значит не хранится в стейте и считается по запросу. От хранения статуса в сервисной офферной таблице пришлось отказаться после перехода на релакс-транзакцию в апдейтере - теперь, например, при обновлении только базовой части оффера мы не поднимаем весь united-оффер, а значит не хватает данных для пересчета и обновления интегрального статуса.

Места, где можно найти интегральный офферный статус:
- некоторые ручки строллера: 
    - ```/v1/offers/united/batch```
    - ```/v1/partners/{business_id}/offers/services/{shop_id}```
    - ```/v1/partners/{business_id}/offers``` (только в случае отсутствия фильтров)
- саас
- выгрузки дампера
- ежечасные [выгрузки аналитикам](https://yt.yandex-team.ru/arnold/navigation?path=//home/market/production/indexer/datacamp/export/filtered/recent/service_all)

#### Интегральный статус в саасе
Единый саас подписан на интегральный офферный статус (и на контентный тоже, но там все просто).

В случае обновления сервисной или складской части оффера из таблиц достается базовая + сервисная + все складские части оффера, интегральный статус пересчитывается прямо в [subscription_filter](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/controllers/lib/subscription_filter/subscription_filter.cpp?rev=r8875937#L147) и при его изменении оффер отправляется в саас.

В случае обновления только базовой части сервисные и складские части не достаются. Однако некоторые апдейты базовой части могут приводить к изменению интегрального статуса в каких-то магазинах united-оффера. Поэтому при получении [подобных апдейтов](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/controllers/lib/datacamp_storage_updater/united_updater.cpp?rev=r8896228#L366) оффер безусловно отправляется в саас, тем самым, возможно, производя лишние отправки. В процессоре для отправки в саас происходит [дозачитывание](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/controllers/lib/saas_docs/processor.cpp?rev=r8896228#L160) недостающих частей оффера и перерасчет статуса.

#### Интегральный статус в поисковых таблицах
Интегральный офферный статус является одним из фильтров поисковой ручки строллера, которая работает на основе [поисковых таблиц](https://docs.yandex-team.ru/market-datacamp/model/tables#poiskovye-tablicy). Запись в поисковые таблицы происходит в транзакции, а значит сохранять в них сам статус возможности нет. Вместо этого в таблицы [сохраняются поля](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/controllers/lib/utils/yt_storage/yt_search_offers_storage.cpp?rev=r8875937#L266), необходимые для вычисления статуса - в базовую и сервисную (в сервисную таблицу также кладутся некоторые параметры, преподсчитанные на основе складских частей оффера - для сокращения кол-ва таблиц, участвующих в запросе). Фильтрация по интегральному статусу, в отличие от всех других фильтров, производится на нашей стороне, а не в yt.

#### Хочу завязать интегральный статус на новое поле в оффере
Первым делом, нужно добавить сохранение нового поля в поисковые таблицы, а затем дождаться, пока оно там прорастет (можно сделать форсированную наливку данных).
Затем, можно менять логику вычисления статуса, не забыв добавить новое поле везде, где нужно - см. [MARKETINDEXER-43572](https://st.yandex-team.ru/MARKETINDEXER-43572), чтобы не наступить на те же грабли.
