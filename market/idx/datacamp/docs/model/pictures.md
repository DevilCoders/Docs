# Офферные картинки в datacamp

Как и большинство контентных полей картинка [состоит](https://a.yandex-team.ru/arc/trunk/arcadia/market/idx/datacamp/proto/offer/OfferPictures.proto?rev=r7633882#L25) из `original` и `actual` частей. С помощью `pictures.partner.original` партнер управляет источниками картинок и их порядком. В `pictures.partner.actual[key]` хранится информация про картинки внутри [аватарницы](https://wiki.yandex-team.ru/mds/avatars/ "общеяндексовое хранилище картинок"), ключом в мапе является `url` картинки из оригинальной части.

За скачивание картинок и хранение дополнительной меты по картинкам отвечает [пикробот](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/picrobot).

### Типы офферных картинок
1. По прямой ссылке
2. Аплоадная
3. Модельная

#### Картинка по прямой ссылке
Картинка, которая скачивается специальным роботом из внешней сети.

1. Партнер добавляет ссылку на картинку в фиде
2. Парсер заполняет ссылку на картинку в `pictures.partner.original.source`
3. Пайпер по событию появление новой картинки генерирует задания на скачивание картинки и отправляет в Logbroker в сторону пикробота.
4. Пикробот после скачивания картинки и заливки ее в аватарницу отдает через Logbroker событие с данными картинки в аватарнице
5. Пайпер заполняет поле `pictures.partner.actual`

#### Аплоадная картинка
Картинка, которую партнер заливет через партнерский интерфейс.

1. Партнер добавляет картинку в ПИ
2. ПИ дергает ручку строллера `/shops/*/pictures`
3. Строллер генерирует фейковый URL картинки(datacamp.market.yandex.net), данный URL необходим единой логики работы с картинками в пикроботе
4. Строллер дергает ручку пикробота [put_picture](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/picrobot/http/handler/put_picture.cpp) напрямую заливая картинку и добавляет запись в `pictures.partner.actual`
6. ПИ получает сгенерированный URL и добавляет его в `pictures.partner.original.source`

#### Модельная картинка
Картинка, которую партнер явным образом скопировал из модели. Сами модельные картинки лежат в аватарнице MBO. Отличается от картинок по прямой ссылке тем, что самовар не скачивает файлы из внутренней сети.

1. Партнер при редактировании оффера в ПИ нажимает кнопку "Хочу в оффер вот эти модельные картинки"
2. ПИ добавляет в `pictures.partner.original.source` ссылки на картинки из чужой аватарницы
3. Пайпер отправляет событие пикроботу.
4. Пикробот перекладывает картинку в нужный namespace и отдает ответ в Пайпер.

### Замена ссылок на индексаторную таблицу в original части
[Проблема](https://st.yandex-team.ru/MARKETINDEXER-36699): партнер скачивает xls фид с аплоадной картинкой в оффере. Так как в фид нельзя дампить ссылку на сгенерированный URL, который никак не резолвится, в экспортом фиде добавляется ссылка на аватарницу. После обратного импорта данного фида в `original` части картинок окажется ссылка на индексаторную аватарницу. Такие картинки будут иметь отдельную запись в state пикробота.

### Ответы на вопросы
#### Как картинка используется при сборке поколения?
При сборке поколения картинки заново джойнятся по урлам из `pictures.partner.original.source`. Во-первых, таким образом у нас остается одинаковая логика для пуш и пул схемы. Во-вторых, помимо ссылок на аватарницу в мета таблице пикробота хранится куча полей, связанных с computer vision.

#### Что будет если картинка не скачалась с первого раза?
Пикробот сам генерирует повторные запросы через 6 часов*(1<<количество попыток). После успешной попытки ответ отправляется в пайпер где и записывается в офер.
