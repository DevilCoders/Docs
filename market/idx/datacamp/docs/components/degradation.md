# Управляемая деградация
Для снижения урона хранилищу от перегрузки бандла YT, в контроллерах предусмотрен механизм отключения записи из неприоритетных источников в ответ на ошибки YT.

# Реализация
Деградация реализована с помощью квотирования ошибок при помощи распределенного квотировщика [rpslimiter](https://rpslimiter.z.yandex-team.ru/records/market/datacamp/configs).
Перед началом транзакции от неприортетного источник, контроллер ждет высвобождения квоты на число ошибок. Ошибки транзакций от любого источника учитываются в квоте, таким образом неприоритетные источники отключаются даже если они не являются причиной проблем.

Список приоритетных источников задается в [конфиге](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/controllers/etc/offers_storage_updater.cfg?rev=r9392620#L33)

# Отключение
Для отключения надо прописать пустую строку в переменную [QUOTER_SERVICE_NAME](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/controllers/etc/env/production.united?rev=r9458193#L7).

# Тестирование
Тестирование и отладка деградации производится в тестинге, с помощью утилиты [ddos_tool](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/dev/ddos_tool?rev=r9458193).
Утилита пишет фиксированный поток данных синтетических данных одновременно в топики парсера (приоритетный) и майнера (не приоритетный).
Потоки не пересекаются по ключам и равномерно нагружают все таблеты. Синтетические данные размечены [флагом](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/proto/api/DatacampMessage.proto?rev=r9458193#L58), по которому в контроллерах отключается отправка в диспатчер. Таким образом утилита изолированно нагружает связку piper и YT.
