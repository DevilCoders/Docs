# Relaxed режим
Relaxed режим - это специальный режим записи в YT в контроллерах, снижающий нагрузку на YT, использование памяти, CPU.

Данный режим создан специально для того что бы побороть нагрузку, которую на нас дают магазины с большим количеством региональных клонов.

Основной тикет:
[MARKETINDEXER-41420 решение проблемы региональных клонов](https://st.yandex-team.ru/MARKETINDEXER-41420)

## В чем отличие от обычного режима?
Когда нам приходит оффер в обычно режиме мы их зачитываем следующим образом:
- lookup basic
- select all service <- проблема с региональными клонами возникает тут(x100 нагрузки про 100 региональных клонах)
- select all actual service

В relaxed режиме:
- lookup basic
- lookup service <- проблемное место ушло, читаем одну часть
- select all actual service

Фундаметальное отличие тут в том, что мы не зачитываем все сервисные части, а значит не тратим сеть на их загрузку, процессор на их парсинг и память на их хранение. [Эксперимент показал](https://st.yandex-team.ru/MARKETINDEXER-41420) что данные режим экономит CPU в 6-7 раз и память в 3 раза(по факту меньше, тут не работали подписчики)

Отсутствие всех сервисных частей влечет за собой дополнительные отличия
- мы не запускаем [AfterUpdate](https://a.yandex-team.ru/arc_vcs/market/idx/datacamp/controllers/lib/utils/united_tx_handler.cpp?rev=f2488da1e2526ee9b0cc1a1a9837d95fdb0e74db#L103), потому что там живет код, который завязан на наличие всех сервисных частей
- в подписчиков попадают не все сервисные части, а только одна или вообще ни одной при обновлении только базовой


## Как этим управлять?
Основной способ включения сейчас, это добавления своего подписчика в `RelaxedSources` в `LEGACY_OFFERS_CONVERTER` или `ForceRelaxed` в `DATACAMP_MESSAGE_UNPACKER` (в зависимтости от пайплайна), но в какой то момент мы включим это для всех данных.
Физически оно проставляет `RelaxedAtomicity` в `TMessageBatch` или `TDatacampMessageObject`.

У `SUBSCRIPTION_FILTER` классов есть опция `AcceptRelaxed` указывающая отправлять ли в них данные в relaxed режиме. Тут важно, что они приходят только с одной сервисной частью или вообще без них.
Для подписчиков, которых это не устраивает, например Saas, мы сделали [дозачитывание](https://st.yandex-team.ru/MARKETINDEXER-41498) сервисных частей, непосредственно перед отправкой.
