### Что это?
Описание нового API Репорта

### Зачем это?
Старое API плохо спроектировано, что доставляет следующие неприятности:
- сложность использования из-за кучи параметров
- перегруженность бизнес-логики, затрудняющее расширение и потребляющее много времени поддержки
- сдерживание развития микросервисной архитектуры, т.к. старое апи плохо переиспользуется
- сложность диагностики, т.к. рпс на конкретную ручку (плейс) не отображает реальной нагрузки – скорость ответа одной и той же ручки может отличаться на порядки
- отсутствие модели данных и следовательно направленного развития апи – все колбасят доп. флажки как им хочется, еще больше запутывая бизнес-логику

### Требования
#### REST+gRPC+AppHost
Все новые ручки должны быть написаны в духе [Google Api Design](https://cloud.google.com/apis/design) и в частности поддерживать одновременно [REST](https://ru.wikipedia.org/wiki/REST) и [gRPC](https://ru.wikipedia.org/wiki/GRPC) через [gRPC-transcoding](https://cloud.google.com/endpoints/docs/grpc/transcoding?hl=ru).

Ручки должны быть легко адаптированы к [AppHost'у](https://docs.yandex-team.ru/apphost/).

#### Без походов во внешние сервисы
Ручки не могут ходить во внешние сервисы, за исключением сниппетов и базового поиска. Ограничение связано с прицелом перехода под AppHost. Вся логика рекомендаций (крипта), обработки запроса (спеллер, реквизард) должны вызываться на клиенте, а в поиск приходить в виде параметров запроса.

#### Без дефолтных офферов
Поиск не будет вычислять дефолтный оффер, вместо этого он предоставляет интерфейс получения топа офферов, с последующей дофильтрацией на клиенте. Данное правило не относится к байбоксу, который будет вычисляться поиском для sku-объектов, т.к. использует эти данные в процессе фильтрации и ранжирования.

#### Минимальная дисперсия времени работы ручек
Логика ручек, зависящая от входных параметров, должна работать с минимальной дисперсией по времени ответа, т.е. время ответа не должно сильно отличаться для разных комбинаций параметров одной и той же ручки.

#### Выдача не можете содержать одновременно и результаты поиска и статистику
Практика показала, что выдача топа документов по поиску и сбор статистики по найденному (напр. фильтры, агрегаты и т.п.) – две разные задачи, поэтому не мешаем их воедино. Если клиент хочет получить и то, и другое, то пусть делает два запроса.

#### Без редиректов
Поиск снимает с себя ответственность по вычислению логики редиректов – редиректы должны расчитываться внешними сервисами на основе статистики, собранной поиском. Мотивация – редиректы ломают формат вывода ручек и являются отделимой логикой.

#### Без смешивания объектов
Поиск работает в рамках одного запроса только с одним типом объекта, т.е. смешать офферы и модели не получится. Мотивация: это легко вынести в отдельный сервис, а отдельная логика смешивания только усложняет поиск.

#### Без лишних атрибутов
Поиск может выдать только те атрибуты, которые используются для фильтрации или сортировки, в остальном все внешние связи представлены в виде идентификаторов, по которым можно получить необходимую информацию в других сервисах.

#### Без логов показа и клик-урлов
Поиск снимает с себя ответственность по кодированию клик-урлов и записи логов показа, т.к. этот функционал легко отделим во внешние сервисы и не всем нужен. В случае шоу-лога – поиск не в состоянии писать его честно, т.к. не несет ответственности за рендеринг результатов поиска пользователю (т.е. показ). Отказ от этой функциональности снизит кол-во чисто информационных параметров (типа pp, clid), который транзитом пишутся в логи.

#### Без специфики урлов фронта
Поиск не будет отдавать какие-либо урлы в формате фронта, вместо этого он будет передавать информационные атрибуты, достаточные для конструирования этих урлов на клиенте.

#### Без точечного поиска по ключу
Поиск снимает с себя ответственность поиска по ключу (айдишнику и т.п.). Поиск используется только для широких запросов с фильтрами и сортировками. Мотивация: поиск по ключу можно реализовать на [SaasKV](https://wiki.yandex-team.ru/jandekspoisk/saas/SaaSkv/) или [dYT](https://yt.yandex-team.ru/docs/description/dynamic_tables/dynamic_tables_overview).

#### Жесткое ограничение размера списков
Списки объектов, принимаемых в параметрах или возвращаемых в результате, должны иметь жесткое ограничение сверху. Это делается для того, чтобы предотвратить раздувание ответа или увеличение сложности поиска через параметр. Если нужно получить больше результатов, то используйте пейджинг.

#### Forward-only paging
Пейджинг реализуется только через [Continuation Token](https://phauer.com/2018/web-api-pagination-timestamp-id-continuation-token/), без использования random-access через номер страницы. Это сделано для того, чтобы нельзя было нагружать поиск, задавая случайную большую страницу. Также это поможет переходу на stream-api в будущем.

#### Сортировка только по атрибуту
Сортировка результатов поиска возможна только по подмножеству атрибутом объекта поиска, без синтетических констант.
Параметры не являются атрибутами объекта.
Мотивация: более прозрачный интерфейс для сортировки, исключающий написание магических сортировок.

#### Параметры фильтров не перечисляются в API
В API перечисляются только параметры, по которым нужно уметь сортировать (и некоторые связанные, напр. currency и price), все остальные должны упаковываться в структуру Parameter. Мотивация: более легкое добавление атрибутов без изменения API.

#### AND/OR-фильтры
Разные типы фильтров всегда объединяются по логическому AND, одинаковые типы фильтров всегда объединяются по OR. Это правило нужно, чтобы избежать раздувания времени выполнения ручек из-за нетривиальных конструкций фильтров.

#### Селективный вывод
В запросе можно указать подмножество атрибутов, которые нужно заполнить в результате. По-умолчанию заполняется только минимум.

#### Aвторизация
Все ручки должны поддерживать [TVM-](https://wiki.yandex-team.ru/passport/tvm2/) и [OAuth-авторизацию](https://yandex.ru/dev/oauth/).

#### Именование
Везде, кроме REST, используется единственное число в именованиях сущностей, напр:
```
> ListModel(...)
> repeated model = 3;
> curl 'http://host/v1/models/123'
```

### Открытые вопросы
- точечные запросы за ску включают расчет байбокса, который находится в логике базовых, должен ли поиск их обрабатывать?
- точечные запросы за оффером включают расчет ДЦО, который находится в логике базовых, должен ли поиск их обрабатывать?
