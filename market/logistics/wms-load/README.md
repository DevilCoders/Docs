## Общая схема

### Обзор
Механизм стрельб состоит из двух программ:
* [Генератор патронов](https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load/go/gen)
* [Стрелялка](https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load/go/app)

Перед каждой стрельбой запускается генератор, который собирает конфиг стрельбы и патроны для программы-стрелялки.

### Генерация патронов
Генерация производится на основании конфига стрельбы [директория с конфигами](https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load/sc).
Результаты генерации:
* конфигурация пушек.
Состоит из описания пула пушек (независимый поток стрельбы).
Для каждой пушки задается: тип, RPS, файл с патронами и различные пользовательские настройки.
На данный момент это, например, пути к секретам.
Подробное описание доступно тут: https://wiki.yandex-team.ru/Load/Pandora/#podgotovkakonfiga
* файлы с патронами.
Состоят из патронов (заданий на исполнение) для пушек и представляют собой файлы JSON - по одному файлу на патрон.
У каждой пушки свой формат файла патронов.

### Стрелялка
Программа-стрелялка производит инициализацию (например, отмену задний на отбор в промежуточном состояний), после чего порождает go-рутину (поток) для каждой пушки и выполняет стрельбу в соответствии с настройками нагрузки и файлом патронов.

Задачи из разных пулов выполняются совместно и **параллельно**, задачи из одного пула — **последовательно** друг за другом.

Есть 4 типа пушек:
* [API](go/app/main.go#410) — для действий через ServiceBus
* [WEBUI](go/app/main.go#L469) — для действий в Web UI
* [PACK](go/app/main.go#536) — для обработки задач упаковки

Пул обычно представляет собой отдельного пользователя WMS на каком-то из этапов обработки заказа (запуск волны, отбор, сортировка и так далее).

### Синхронизация
Задачи из разных пулов выполняются параллельно, однако разные этапы обработки зависят друг от друга.
Для организации этих шагов в единый процесс придуман следующий механизм.
Его основу представляет собой глобальная [таблица](go/util/util.go#L583) из каналов.
Для каждого задания генерируются уникальные ключи "in" и "out", к ним привязываются каналы:
* "in" для получения параметров от предыдущих шагов, необходимых для совершения этого шага.
К примеру, это могут быть результат отбора для этапа сортировки.
Также, появление данных в канале одновременно означает завершение шага.
* "out" для передачи результата работы для следующего этапа.

Уникальные ключи генерируются на этапе создания патронов и записываются в  в [параметр `key`](go/model/model.go#L90).
Если для запуска задачи нужно дождаться результатов нескольких задач, то это будет отражено в [параметре `count`](go/model/model.go#L90).

Логика ожидания параметров реализована [тут](go/app/main.go#L609), отсылки параметров [тут](go/util/util.go#L503).

## Как запустить стрельбу
Перед запуском нужно клонировать к себе Аркадию и установить GO.

Установить можно двумя способами:
* по инструкции: https://wiki.yandex-team.ru/devrules/go/getting-started/
* проделать следующие действия:
  * сделать checkout `https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load` в папку ~/go/src/arc/a.yandex-team.ru
  * перед запуском выполнить:
```
export GOROOT=$(ya tool go --print-toolchain-path)
export GOPATH=$HOME/go
export PATH=$PATH:$GOROOT/bin
```

Для запуска на Mac нужно установить утилиту jq:
```
brew install jq
```

### Описание конфигурации
Опишем только конфиг для сценария создания заказа.
Для входящего потока сценария конфигурируется похожим образом, но с меньшим количеством параметров.

Основная конфигурация стрельб: https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load/sc/orders/local_fire.yaml

Параметры с описанием доступны в [gen/main.go](https://a.yandex-team.ru/arc/trunk/arcadia/market/logistics/wms-load/go/gen/main.go#L827)

### Локальный запуск сценария Orders

Для запуска надо выполнить:

```
./run_load_test.sh -l sc/orders/<filename>
```
* `filename` — имя файла конфигурации для стрельбы. Основной: `local_fire.yaml`.

**Важно!** Стрельбы не умеют сами останавливаться поэтому их нужно самостоятельно останавливать, когда нагрузка сошла на нет.

При запуске на Mac нужно увеличить максимальное количество открытых файлов, так как при стрельбах I/O может идти в тысячи файлов одновременно, а по умолчанию максимальное количество открытых файлов — 1024.
Для увеличения лимита этого нужно выполнить команду:
```
sudo launchctl limit maxfiles 4096 unlimited
```

Для шагов по установке этого лимита не только на текущую сессию, можно проконсультироваться с обсуждением на StackOverflow: https://superuser.com/questions/302754/increase-the-maximum-number-of-open-file-descriptors-in-snow-leopard

### Запуск сценария Orders в танке
Для запуска надо выполнить:

```
./run_load_test.sh -r sc/orders/<filename> <ticket>
```
* `filename` — имя конфига для стрельбы. Основной `local_fire.sh`.
* `ticket` — номер заявки в Трекере, в рамках которой выполняется стрельба.

**Важно!** Стрельбы не умеют сами останавливаться поэтому их нужно самостоятельно останавливать, когда нагрузка сошла на нет.

## Мониторинг работы теста

Процесс работы теста отражается в основном логе стрельбы: в файле `fire.log`.
Расположение этого файла зависит от окружения.

В логе стоит обращать внимание на следующие строки:
* `<GUN_TYPE>:IN` — сообщение, пришедшее от сервера;
* `<GUN_TYPE>:OUT` — сообщение, отправленное серверу;
* `<GUN_TYPE>:START` — начало исполнения задачи/патрона;
* `<GUN_TYPE>:FINISH` — конец исполнения задачи/патрона;
* `<GUN_TYPE>:RESULT` — результат исполнения задачи/патрона: с какими параметрами был запуск, каков результат;
* `<GUN_TYPE>:NOCRIT_ERROR` — не критическая ошибка, пытаемся заново отправить запрос;
* `<GUN_TYPE>:ERROR` — критическая ошибка, игнорируем задачу и выкидываем из цикла обработки;

Конфигурация нагрузочного теста поступает из файлов:
* `load.yaml` — файл с конфигурацией стрельбы, в нем указываются настройки пулов пушек;
* `ammo_*.json` — файлы с патронами для пушек;

Также при локальном запуске доступен [отладочный сервис pprof](https://pkg.go.dev/net/http/pprof) по ссылке http://localhost:9997/debug/pprof/.

### Расположение рабочих файлов

#### При локальном запуске
При локальном запуске файлы создаются в папке `/tmp/wms_load/conf`

#### При запуске в танке
Хост запуска будет выведен в консоль началом стрельб.
Также после запуска скрипт создаст файл `jobno.txt` с примерно таким содержимым:
```
2020-10-21_18-03-58.046156 # далее date_id
2589708 # далее id
```

Для доступа к логам нужно подключиться к хосту танка (выводился перед запуском стрельбы) и перейти в папку `/var/lib/tankapi/tests/<datе_id>` (выводится в файле `jobno.txt`).
В данной папке интересны файлы:
* `pandora_*.log` — аналог `fire.log`;
* `pandora_config_*.yaml` — аналог `load.yaml`;
* `tank.log` — логи самого танка. Стоит обратить внимание, если есть проблемы с самим танком.
Например, ничего не понятно по логу самого приложения, но стрельба резко прервалась или не запустилась вовсе;

## Запуск интеграционного теста создания заказа из GoLand.
Тест находится в `api/api_test.go` и называется `TestIntegrationCreateOrder`.
Необходимо прописать токен в самом тесте `token := ""`, его можно найти в секретнице: https://yav.yandex-team.ru/secret/sec-01eaa02anhkadt5n8h8p75p1ce/explore/version/ver-01eafwqva5zjtnns31kr2qenmr
