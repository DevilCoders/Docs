# Дебаг удаленной java

## Задача

Хотим через локальную Idea дебажить java-процесс, запущенный на какой-то другой машине, например на braavos или в тестинге.

**С продакшеном такое делать не надо**

## Теория 

Для удаленного дебага:

- java-процесс должен быть запущен со специальными параметрами ("для отладки слушать такой-то порт")
- в Idea надо сделать и запустить Run-конфигурацию специального типа — Remote 
- "прокинуть порты", чтобы Idea коннектилась локально, а соединение уставаливалось бы с java-процессом на удаленной машине

В разработке Биллинга Маркета удаленная отладка нужна редко.
Обычно достаточно локального запуска (известные исключения: TODO)


## Инструкция

### 1. Чекаутим локально тот же код, который запущен на удаленной машине

Если запускаем приложение на braavos, это получается автоматически, т.к. удаленно копируем код с локальной машины.

TODO: коротко о спецэффектах от расхождения кода

### 2. Запускаем java с нужными параметрами

```
-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=127.0.0.100:<сюда подставить свой debug порт>
```

В старом и новом tms возможно специально этого делать не надо, настройки есть по умолчанию.


### 3. Создаем в Idea Run-конфигурацию Remote (если ее еще не было)

Меню `Run` → `Edit Configurations...` → `Add new configuration` (плюсик вверху слева),
выбираем тип `Remote`,
даем красивое имя (_удобно назвать "Remote Debug Market Billing"_),
больше ничего не меняем, сохраняем.


### 4. Запускаем ssh с пробросом портов

Локально:
```
ssh -N -L localhost:5005:127.0.0.100:<свой debug порт> <сервер, на котором запущена java>
```

### 5. Запускаем дебаг 

В Idea выбираем run-конфигурацию `Remote Debug Market Billing` и жмем Debug (зеленый жук справа).

### Готово

В Idea можно расставлять брекпойнты, дергать команды через telnet и смотреть отладчик. 

### После окончания отладки

Прибиваем ssh из п. 4.


## Ссылки

- [Туториал от JetBrains](https://www.jetbrains.com/help/idea/tutorial-remote-debug.html)
- [Обсуждение на StackOverflow](https://stackoverflow.com/questions/21114066/attach-intellij-idea-debugger-to-a-running-java-process)
- [Историческая документация про отладку на braavos](https://wiki.yandex-team.ru/MBI/Development/new_developer/#nastrojjkadev-serverabraavos)
- [Инструкция Директа](https://docs.yandex-team.ru/direct-dev/dev/betas/java-remote-debug) -- тут есть скриншоты про Run-конфигурацию
- [Инструкция рекламного ПИ](https://wiki.yandex-team.ru/partner/w/docs/kmb/java/#zapuskjsonapinadevslokalnojjotladkojj)

