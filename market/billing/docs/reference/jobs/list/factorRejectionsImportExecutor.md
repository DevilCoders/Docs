# Импорт списка отказанных банком-фактором клиентов

### Код

Основной код:

[класс FactorRejectionsImportExecutor](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/factoring/services/FactorRejectionsImportExecutor.java)

[сервис FactorRejectionsImportService](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/factoring/services/FactorRejectionsImportService.java)

[дао FactorRejectDao](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/factoring/dao/FactorRejectDao.java)

[клиент к АПИ Балалайки BclApiService](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/bcl/BclApiService.java)

### Продукт/подсистема

Внутренний факторинг

### Роль в работе продукта/подсистемы

Джоба ежедневно получает список клиентов, которых банк-фактор не готов кредитовать
(не прошли проверку либо проверка еще не закончилась).

### Датафлоу

Получаем список клиентов через Балалайку (`balalayka.yandex-team.ru`) вызовом ручки `GET /api/proxy/creditors/`.

Для каждого "отказника" создаем новый период отказа (либо, если уже есть открытый период, ничего не делаем)
в таблице `market_billing.factor_reject`. Для клиентов, у которых есть открытый период отказа,
но не попавших в список "отказников", закрываем период отказа (заполняем поле `end_reject_date`).

### Способы наблюдения за текущим состоянием

- Juggler-проверки:
- Логи
- Изменения таблицы `market_billing.factor_reject`


### Какая функциональность пострадает от отказа джобы

Если джоба не работает корректно, у нас будет неактуальный список клиентов, которым можно делать выплаты через
банк-фактор. Выплаты некоторым клиентам будут идти через Маркет (а не черз банк-фактор,
хотя банк-фактор был бы готов к этому). Возможно, будут неудачные попытки сделать выплаты клиентам через банк-фактор,
потому что банк решит отклонить не-нового клиента, а мы про это не узнаем (это не критичная ситуация,
мы должны уметь делать выплаты через Маркет).

### Как пользователи (или команда) заметят проблему и через какое время

Загорится мониторинг о неработающей джобе (внутри `market-billing-tms-18`).

### Контакты разработчиков и менеджеров

Разработчики:
  - [prof](https://staff.yandex-team.ru/prof)
  - [k-sviridenko](https://staff.yandex-team.ru/k-sviridenko)
  - [a-kolchanov](https://staff.yandex-team.ru/a-kolchanov)

Менеджеры:
  - ?

### Желательное время исправления в случае поломки

? Вроде бы, ничего критичного при поломке не произойдет, поэтому - по возможности.

### Способы регулирования работы джобы

У джобы есть расписание, его можно менять в коде.

Джоба смотрит на env-переменную `market_billing.factoring.rejections_import_last_success_date`
(дата последнего успешного запуска джобы) и ничего не делает, если текущая дата <= дате последнего успешного запуска.

Если джоба успешно выполнилась, она обновляет значение переменной на текущую дату.

Поменяв вручную (или миграцией) значение переменной `market_billing.factoring.rejections_import_last_success_date`
на дату в прошлом, можно повторно запустить джобу (вручную, или она сама запустится по расписанию).

### Известные причины поломок


### Дополнительно: тонкости и подводные камни

**Получение списка отказанных клиентов происходит постранично.**

При этом, мы не знаем, какой размер страницы. Поэтому, чтобы быть уверенным в том, что все клиенты получены,
нам нужно последовательно получать все страницы (начиная с нулевой), до тех пор,
пока очередная страница не придет пустой (получим пустой список клиентов).

**Есть теоретический кейс, когда джоба работает некорректно:**
  - при первом запуске джобы банк вернул незааппрувленного клиента (мы создаем новую запись в таблице);
  - при втором запуске в тот же день банк не вернул этого клиента
    (мы закрываем период - заполняем end_reject_date той же датой, что и reject_date);
  - при третьем запуске банк снова возвращает этого клиента
    (мы попытаемся создать новую запись, но не сможем - запись с таким клиентом и такой датой уже есть).

Но на практике такого не должно происходить:
  - во-первых, потому что джоба не должна перезапускаться несколько раз за день (только если вручную);
  - во-вторых, потому что банк не должен так себя вести - сначала зааппрувил, а потом передумал;
    а если вдруг начнет, то это похоже на ошибку со стороны банка.
