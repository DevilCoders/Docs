# Отправка изменений юридических данных клиентов на проверку в банк-фактор

### Код

Основной код:

[класс SendClientsToFactoringBankExecutor](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/factoring/services/SendClientsToFactoringBankExecutor.java)

[сервис SendClientsToFactoringBankService](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/factoring/services/SendClientsToFactoringBankService.java)

[клиент к АПИ Балалайки BclApiService](https://a.yandex-team.ru/arc_vcs/market/billing/market-billing-tms/src/main/java/ru/yandex/market/billing/bcl/BclApiService.java)

### Продукт/подсистема

Внутренний факторинг

### Роль в работе продукта/подсистемы

Джоба регулярно (раз в полчаса) отправляет юридические данные новых клиентов, а также изменения в юридических данных
существующих клиентов в банк-фактор для проверки и регистрации.

### Датафлоу

Получаем список непроверенных клиентов из таблицы `market_billing.unchecked_person`.

Для каждого из них получаем актуальную юридическую информацию из таблицы `market_billing.person_info`.

Эту юридическую информацию отправляем в банк-фактор через Балалайку (`balalayka.yandex-team.ru`)
вызовом ручки `POST /api/proxy/creditors/`.

После отправки, для каждого успешно отправленного клиента выставляем в таблице `market_billing.unchecked_person`
в колонке `processed` значение `true`.

Всех успешно отправленных клиентов сразу добавляем в black-list - добавляем в таблицу `market_billing.factor_reject`
новую запись (до тех пор, пока банк не проверит и не подтвердит данные клиента, факторинг для этого клиента недоступен).

### Способы наблюдения за текущим состоянием

- Juggler-проверки:
- Логи
- Изменения таблиц `market_billing.unchecked_person` и `market_billing.factor_reject`.


### Какая функциональность пострадает от отказа джобы

Если джоба не работает или работает некорректно, юридические данные клиентов не будут регистрироваться в банке-факторе.
Как следствие, у нас для этих клиентов не будет работать факторинг: мы не сможем отправлять платежи через банк-фактор,
только напрямую.

### Как пользователи (или команда) заметят проблему и через какое время

Загорится мониторинг о неработающей джобе (внутри `market-billing-tms-18`).

### Контакты разработчиков и менеджеров

Разработчики:
- [prof](https://staff.yandex-team.ru/prof)
- [k-sviridenko](https://staff.yandex-team.ru/k-sviridenko)

Менеджеры:
- ?

### Желательное время исправления в случае поломки

Ничего супер-критичного при поломке не произойдет, просто не будет использоваться факториг для новых клиентов.
Поэтому исправлять по возможности.

### Способы регулирования работы джобы

У джобы есть расписание, его можно менять в коде.

Джоба смотрит на env-переменную `market_billing.factoring.sending_clients_for_check.enabled`
и отрабатывает только тогда, когда переменной присвоено значение `true`.

### Известные причины поломок


### Дополнительно: тонкости и подводные камни

**Повторная отправка клиетов.**

Если после отправки юридических данных клиента мы не запишем в таблицу `market_billing.unchecked_person`
значение `true` в колонку `processed` для этого клиента, то при следующем запуске джобы данные клиента будут отправлены
повторно. Банк в этом случае присылает ошибку, которую джоба пока обрабатывает как и любую другую ошибку. В результате,
мы до скончания веков будем пытаться отправлять данные этого клиента (или пока они не изменятся), и получать ошибку
от банка.

На это дело запланирована доработка: https://st.yandex-team.ru/MARKETBILLING-1155

**Последовательная отправка данных**

Банк принимает только по одному клиенту за один запрос, балковой ручки нет. Отправка данных множества клиентов сейчас
выполняется строго последовательно. Если поток изменений, которые нужно отправить, будет большим, это может стать
проблемой. Но пока большого потока не ожидается.

Если что, запланирована доработка: https://st.yandex-team.ru/MARKETBILLING-1162
