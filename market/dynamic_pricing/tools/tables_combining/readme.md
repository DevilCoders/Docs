# Tables combining

## Что делает
Объединяет таблицы в партиции за определенный период.
1. Запускается раз в день.
2. Смотрит все обновления таблиц (определяется по revision у YT)
3. Ищет все временные отрезки размера `scale` которые затронули изменения из пункта 2.
4. Перестраивает соответствующие таблицы.

Схема результируешей таблицы. Ну тут все оч просто.
* Если у всех исходных таблиц схема одинкаковая, то у результата будет в точности она + доп столбец с именем исходной таблицы
* Если есть хотябы одна таблица без схемы, то у результата схемы так же не будет
* Если схемы таблиц друг другу не противоречат а просто дополняют друг друга столбцами, то у результата схема будет включать в себя все столюбцы которые встречаются в исходных таблицах
* Если встречаются противоречия числовых типов, то все противоречия в интах превращаются в int64 (ВАЖНО! Могут быть проблемы изза переполнения инта при переходе Uint64 -> Int64)Б а все противоречия с участием дабла превращаются в дабл.
* При любых других противоречиях схема результата будет отсутствовать

При слиянии не делаются сортировки
Все столбцы в финальных таблицах опциональны

### Формат конфига
Конфиг представляет собой список конфигов для отдельной директории

Конфиг для директории это словарь содержащий:
- `source_path: str` - путь к директории на yt
- `source_table_name_pattern` - формат для перевода имени таблицы в дату. Пример: Для ISO формата времени паттерн -
  `'%Y-%m-%dT%H%M%S'`
- `source_table_ttl` - TTL для исходных таблиц (в днях)
- `cluster: list[str]` - список кластеров на которых нужно запустить объединение таблиц
- `scale: str` - размерность в которую нужно объединять таблицы. Допустимые значения `'daily', 'monthly',
  'yearly'`
- `result_path: str` - путь для объединенных таблиц
- `result_table_ttl: int` - TTL для результатов (в днях).
- `result_table_name_pattern: optional[str]` - формат для перевода имени результирующей таблицы в дату. Пример: Для ISO формата времени паттерн -
  `'%Y-%m-%dT%H%M%S'`. Если не задан, то формат будет функцией от `scale`.
## Как катать
Катается автоматически при комите в транк через Arcanum CI. Описание релиза можно посмотреть в `../a.yaml`(там все оч тупо)
Катится сразу на прод. Никаких тестовых пайплайнов нет. Так что аккуратнее.
## Регулярные запуски
Запускается в реакторе:
https://nirvana.yandex-team.ru/browse?selected=9232702
