При запуске расчета формируется **стартовая выборка** (single_time_upload.sql) со следующими условиями:
**Фильтры на базу:**
1. Клиенты с рублевым интерфейсом в Директе
2. Прямые клиенты
3. Срок жизни в Директе больше 30 дней
4. Сумма актов по сервису Директ за последние 30 дней больше 2 000 (с НДС)
5. Скоринговый балл = 0

Из получившейся базы выделяютя клиенты, у которых на момент формирования выборки в интерфейсе нет овердрафтного лимита - это клиенты эксперимента. Полученные клиенты делятся в пропорции 25/75 (25% - в контроль)

**Сумма доступного овердрафтного лимита** рассчитывается как: _акты за 30 дней/2_.

**Каждый последующий запуск** (periodic_upload.sql) проверяет следующие условия:
- если клиент из контрольной группы - в сумму одобренного овердрафта проставляется 0
- если клиент впервые в расчетный день попал под условия овердрафта, для него считается лимит и записывается расчетная дата _count_date_
- если клиенту уже рассчитана сумма доступного овердрафта - она фиксируется на 30 дней и пересчитывается спустя этот срок.

**Запуск периодического расчета:**
- расчет запускается ежедневно каждые 2 часа. Основные условия запуска - обновление таблицы биллинга с актами _`//home/balance/prod/acts/f_sales_daily/`_, заложенная задержка на "долет данных" - 2 дня.
