# Создание и обновление алертов в Solomon
Основной целью является позволить широкую и легкую кастомизацию использующихся методик алертинга, а также отслеживание истории изменений в коде алертов.

Подход использует комбинацию из трех факторов:
1. Python код для взаимодействия с Solomon через REST API и формирования корректного запроса.
2. YAML файл содержащий шаблонные наборы значений и итоговые версии конфигов для конкретных алертов. Каждый итоговый конфиг содержит метаданные алерта и параметры для использования шаблонных программ Solomon. Также позволяет создавать алерты с не-шаблонными программами за счет из определения непосредственно в конфиге алерта.
3. YAML файл содержащий шаблоны программ на языке запросов Solomon. Является необязательным, так как файлы конфигов имеют параметр позволяющий загружать любой код алерта Solomon непосредственно из YAML-конфига.

# Примеры итоговых алертов
Поисковая доля Яндекса: https://solomon.yandex-team.ru/admin/projects/rtmr_yql_results/alerts/94a712e7-06e7-41e4-8460-76bf3c14481c
Отсутствие данных поисковой доли: https://solomon.yandex-team.ru/admin/projects/rtmr_yql_results/alerts/94a712e7-06e7-41e4-8460-76bf3c14481q

# Содержимое конфигов
Все конфиги для алертов находятся в файле configs.yaml. Первая часть файла выделена под наборы шаблонных параметров для легкого составления типовых конфигов, вторая часть содержит готовые к использованию конфиги.

Все шаблоны программ на языке Solomon находятся в файле programs.yaml. Данные шаблоны не включают код для получения данных и непосредственно изменения статуса алерта в зависимости от переменных status_code и message, так как указанные части программы являются стандартизированными в данном подходе.

## Общие
alert - параметры алертов в системе Solomon. Часть из них необходима для корректной работы через API, часть выступают для аннотации алертов. Важным является параметр template, с помощью которого указывается какой шаблон программы использовать либо использовать код программы из параметра type.
data - используется в коде непосредственно Solomon алерта для получения данных. Выглядит стандартным для большинства алертов, но используемые поля могут отличаться.

## Показатели
general - параметры для алгоритма Кронос (https://wiki.yandex-team.ru/users/miptgirl/kronos/) лежащего в основе использующихся в настоящий момент алертов. Определяет механизм оценки среднего и дисперсии временного ряда.
red, yellow, shift - три условно независимых доверительных интервала. red и yellow задаются на весь день вперед, shift смещается на протяжении дня таким образом чтобы среднее за определенный интервал всегда находилось в середине доверительного интервала. Используют следующие параметры:
1. tail - точки за какое время сравниваются с доверительным интервалом. Используется для red и yellow, в настоящий момент shift привязан к yellow (будет изменено).
2. lag - выкидывает точки свежее некоторого времени. Таким образом, смещение доверительного интервала при сильных отклонениях происходит не сразу.
top и bot - две идентичные группы параметров, на рост и падение показателей относительно ожидаемого соответственно.
3. use - принимает значения true/false, при постановке в false выключает соответствующий порог из стандартных правил срабатывания алерта. Обязательно должно быть в формате string и с маленькой буквы, не в формате Boolean.
4. coefficient - определяет ширину доверительного интервала в соответсвующую сторону.
5. threshold - минимальное количество точек за рассматриваемый доверительный интервал которое должно выйти за пределы соответствующего порога для срабатывания алерта.

## Отсутствие данных
general - базовые параметры. На данный момент содержит единственный параметр:
1. timeoutSecs - данные за какой период времени должны отсутствовать для срабатывания алерта.

## Качество поставляемых данных
general - базовые параметры. На данный момент содержит единственный параметр:
1. limitLoss - какой процент данных должен быть потерян (Lost) для срабатывания алерта.

# Запуск
1. В файле configs.yaml создать конфиг для нового алерта или внести изменения в имеющийся.
2. Убедиться что указанный в конфиге шаблон программы alert - template есть в файле programs.yaml, либо равен from_config для не-шаблонных программ.
3. Получить OAuth токен через https://solomon.yandex-team.ru/docs/api-ref/authentication и сохранить его в переменную среды.
    ```sh
    $ export SOLOMON_TOKEN=AQAD-***
    ```

4. Запустить скрипт main.py с указанием следующих параметров:
4.1. Имя конфига алерта внутри файла configs.yaml.
4.2. Тип действия (create, update) - необязательный параметр, по умолчанию стоит update.
Пример запуска:
    ```sh
    $ python main.py prod_rtmr_share_ru update
    ```
