### Кликовая модель для единого геопоискового оффлайна

#### Зачем
В Q4 2019 - Q1 2020 была поставлена цель улучшить рубричный оффлайн и сделать единый геопоисковый оффлайн. 
Кликовая добавка используется только для рубричной части корзины, остальные классы запросов никак её не используют.

В рубричной же части кликовая добавка используется для разбавления "болота RELEVANT_PLUS документов" - ситуации,
когда в рубричном запросе почти все документы имеют оценку `RELEVANT_PLUS` и фактически являются слабо различимыми
с точки зрения релевантности пользователскому запросу. Поэтому было придумано заменить чистую асессорскую релевантность
на смесь релевантности и "пользовательской релевантности" - вероятности клика. 

Таким образом, в маппинге релевантности на рубричной части в число, решили перейти от схемы
````
VITAL: 1
RELEVANT_PLUS: 1
RELEVANT_MUNUS: 0.5
IRRELEVANT: 0
````
к схеме
````
VITAL: 1
RELEVANT_PLUS: 0.5 * (1 + click_proba)
RELEVANT_MUNUS: 0.5
IRRELEVANT: 0
````
Код, который находится в этой папке, реализует обучение и применение модели, предсказывающей `click_proba`.

#### Обучение и применение
Обучение и применение реализовано в виде кубиков в Нирване:

Обучение: [кубик](https://nirvana.yandex-team.ru/operation/32142878-5d53-4904-bf6e-c485c5a9cdcc)

Применение: [кубик](https://nirvana.yandex-team.ru/operation/13042082-48a0-4a91-baf9-a05ca9e48290)

Для того чтобы обучить модель, необходимо и достаточно произвести следующие операции:

1) Собрать пул (таблицу на YT) для обучения. Правила работы с колонками обязательно нужно задать
с помощью специального файла `factor_slices.json`:

   - `id` - список колонок-идентификаторов, которые не будут использоваться для обучения, но будут
   идентифицировать объекты классификации, и будут включены в выходной датасет
  
   - `category` - список названий категориальных факторов
   
   - `numeric` - список числовых факторов
   
   - `weight` - колонка с весами объектов (актуально только для кубика обучения модели). 
   Если весов нет, то нужно запускать кубик с отжатой галкой `weighted`, а в конфиге это поле не указывать.
   **Обратите внимание, что в случае непустого значения это список длины 1**. Так сложилось исторически,
   возможно мы это поправим :)
   
   - `target` - колонка с названием поля, которое является таргетом.
   **Обратите внимание, что это список длины 1**. Так сложилось исторически,
   возможно мы это поправим :)

   Пример такого конфига лежит в папке `config`
   
2) Собрать код в бинарный файл и подать его на вход кубику обучения/применения. Кроме этого,
для корректной работы необходимо передать кубикам следующие данные:

    - пул - таблицу на YT с данными
    
    - `factor_slices.json`
    
    - `catboost_params.json` - файл с параметрами для обучения catboost. Ничего необычного, простой json, пример
    лежит в папке `config`
    
    - в случае применения модели, также надо передать binary-файл - предобученную catboost-модель, которую выдаёт
    [кубик обучения](https://nirvana.yandex-team.ru/operation/32142878-5d53-4904-bf6e-c485c5a9cdcc)
    
    Примеры:
    
    [обучение](https://nirvana.yandex-team.ru/flow/72d5fbd3-f452-49f7-96e3-0b8efcae179b/be186307-73c5-4e4a-8519-8291594b9891/graph/FlowchartBlockOperation/425ac5ba-9a21-46bf-ae2a-fed2d8aac538)
    
    [применение](https://nirvana.yandex-team.ru/flow/17d70669-8695-43bc-93b0-9112bab3289a/5aed7550-6060-46d9-8fcf-5e3d17310fd8/graph/FlowchartBlockOperation/1fc6bf84-7da8-458b-a1f6-2cd95880a7f9)
    
#### К кому обращаться
Если вы вдруг дошли до этого пункта и у вас есть необходимость что-то уточнить, смело обращайтесь к
[Кириллу](https://staff.yandex-team.ru/kostapenko).
