## Ранжирование шайб

### Процессы
* [Построение профилей пользователей](https://reactor.yandex-team.ru/reaction?id=11104194&mode=instances)


### Что происходит

Сначала из логов (`appmetrica` / `bebr` / `geocube` / `orgvisits`) собираются экшны пользователей и пул для обучения. Параллельно
из таблиц `crypta/production/profiles`, `prism_cluster` и `uidreg3` строятся статические профили пользователей, организаций и рубрик. Дальше с помощью
экшнов и профилей рубрик / организаций из статических профилей пользователей строятся динамические профили.
Потом профили сортируются по тому, насколько топ предсказаний по статическому профилю отличается от предсказаний по
построенному профилю, далее топ профилей выгружается в kvsaas.


### По скриптам
* `process_logs.py`: подготовка экшнов, статических профилей и пула для обучения. Состоит из большого числа других
скриптов:
    * `get_ids.py` – получение списков `yandexuid` / `device_id` пользователей за рассматриваемое время (на текущий
       момент – начиная с `2021-01-01`) и джоин с криптой (поскольку профили хранятся по `crypta_id`, если он есть).
    * `build_static_user_profiles.py` – построение статических профилей собранных пользователей. Состоит из сбора
      соцдема (скрипты `devid_to_socdem.yql`, `yandexuid_to_socdem.yql` и `socdem_merge.yql`), данных о домашнем регионе (
      `home_region.yql` и `home_region_filter.yql`), призма-кластера (`prism_cluster.yql`) и объединения всей этой
      информации в один профиль (`build_static_user_profiles.yql`).
    * `build_static_item_profiles.yql` – построение статических профилей рубрик и орг. В профилях рубрик есть только
      ссылка на `activity_class`, в профилях орги – ссылки на рубрики и полигоны.
    * `build_pool_actions.py` – сбор экшнов для обучения. Собираются клики и показы шайб в вебе и МЯКе за время рандомных
      экспов. Показам, которые могли не попасть в экран пользователя (находятся далеко от позиции клика, но зависит от
      конкретного интерфейса) ставится меньший вес (0.1).
    * `build_actions.py` – собираются экшны. Это GDU / GU клики, визиты, рубричные запросы из геокуба. Также собираются
      события из бебра / аппметрики для матчинга запроса в геокубе с кликом в шайбу (это нужно для того, чтобы понять
      какой текстовый запрос и какие рубрики соответствуют шайбе).
    * `build_category_profiles.py` – построение статических профилей шайб. Матчу запросы в геокубе с кликами в шайбу,
      если в шайбу было достаточно много кликов и текстовый запрос заматчился в большую долю кликов – считаю что это
      запрос, соответствующий шайбе.
    * `extend_actions.py` – переделываю текущие экшны, добавляю экшны Шайба -> (клик / показ) -> юзер (для того, чтобы
      смотреть какие-то статистики шайб по соцдему), Юзер -> запрос -> рубрика и Шайба -> (клик / показ) ->
      (День недели / время суток / UI).
    * `build_pool.py` – построение пула для DJ из уже готовых экшнов.

### Что-то техническое:
* Профили хранятся по `crypta_id`, если для пользователя он есть, иначе `yandexuid`, `device_id`.
* Многие скрипты (для сбора пользователей / экшнов) собирают действия за все рассматриваемое время. Чтобы каждый день не
  пробегать сотни таблиц, во многих местах используется кеширование.
