# [Яндекс.Иконостасинатор](https://icon.yandex-team.ru)
### Cервис для расстановки панелей мониторинга
###### За название кидать тапки в @mickxolotl

### TL;DR
В один прекрасный день решили, что было бы прикольно автоматизировать накликивание и восстановление руками расположения панелек на `\d+` экранах иконостаса.  


### Текущий функционал
- Можно расставлять в UI панели 
- Можно добавлять хосты по API
- Панели подгружаются из MartyDB (warden/workplace)
- Можно сохранять конфиги
- Можно получать curl для применения конфигов
- Есть зачатки разделения прав

### Планы на развитие
- [!!] Изменение конфигов
- [!] Применение конфигов из UI без curl
- [!] Отображение скриншотов
- Разделение прав и нормальная TVM-авторизация

### Архитектура сервиса
#### Фреймворк NextJS (JavaScript)
- Обеспечивает разделение кода
- Не надо изобретать велосипед
- Open source

#### Фронт
- React + React-Bootstrap (UI)
- Глобальный стейт в Apollo
- Обмен данными с бэком - GraphQL

##### Бэк
- Node (сервер) + Nginx (кэш статики)
- GraphQL (apollo-server-micro) - шина обмена (прослойка) с фронтом и API
- MongoDB - БД (Mongoose ORM) + Локи

### Разработка
Фреймворк изначально обеспечивает неплохую структуру.  
Однако даже из конфеты можно сделать это самое.  
Надо не забывать об этом.  

Новые структуры **данных** описываем примерно так:  
`./shared/<сущность>/model.js` - модель для бд и валидация  
`./shared/<сущность>/typedef.js` - описание того **как** хотим получать и изменять данные (декларативно)  
`./shared/<сущность>/resolvers.js` - **логика** получения и изменения данных (связки с бд, api, прочим)  
!важно не переборщить с кодом в resolvers!  

**Небольшие** модели можно описывать в ./shared/common

Все структуры данных добавляем в `./shared/schema.js` 

// TODO Пока не нашел ничего лучше `./shared/utils.js` для полезных функций, плохо так делать, потому что конец такого это файл utils в 2-3 тыс строк, где ничего не разобрать.  

`./shared/queries.js` - в этом файле храним все нужные мутации, запросы и подписки со стороны фронта.  

Немного про фронт.  
На самом деле пишется сразу и фронт и бэк. Потому что SSR из-коробки.  
Про SSR. При запросе от юзера - ему генерируется на основе кук (или в идеале отдается пре-рендер если куки не важны) статичная html страничка, таким образом время отрисовки близится к 0, затем потихоньку докачивается JS и подгружается фреймворк (react) и статичная страничка превращается в SPA, запрашивая с сервера только данные. Процесс называется hydration.  
Есть несколько правил, которых надо придерживаться что бы всё это работало.  

Новые странички создаются в `./pages/*`, где папки и пути к файликам `.js` являются по-сути виртуальным роутером.  

`./pages/_app.js` - специальная страничка отрабатывающая свою логику на каждый запрос, там же подгружаются стили и инициализируется глобальный стейт.  

`./styles/*.scss` - глобальные стили  
`./public/*/*` - статика  
React-компоненты для страниц храним в `./components/*.js`

В общем Next подходит для микросервиса с горизонтальным скейлом, в т.ч. "serverless", но есть штуки которые лучше в нём не делать.  
Можно коротко перечислить. Не стоит делать:
- cpu интенсивные вещи (нода - это про асинхронность), стоит закладывать максимум логики преобразования данных в БД или в нижестоящий API на компилируемом языке
- cron-like задачи по расписанию или интервалу (конечно, можно выпендрится, но, возможно не стоит)
- блокирующие операции (JS - нативно асинхронен, но есть способы выстрелить себе в ногу, не стоит делать fs.writeFileSync когда есть async вариант)

// TODO Переписать стейт, написать секурную авторизацию, дописать сюда про стейт и про авторизацию.
// Как только хоть немного перестанет быть стыдно за костыли, выпилить console.log из прода.

### Деплой
- Настроена релизная интеграция с deploy
- После коммита в sandbox варится образ с текущей ревизией и отправляется в докер регистри
- Далее из таски можно запустить релиз
- Сейчас автоматически прожимается тестовый релиз и включен автокоммит в testing
- Проще говоря после коммита сервис в deploy едет сам

### Must-have для разработки 
- [NextJS Docs](https://nextjs.org/docs/getting-started)
- [React-Bootstrap Docs](https://react-bootstrap.github.io)
- [React-Bootstrap-Table Docs](https://react-bootstrap-table.github.io/react-bootstrap-table2/)
- [Mongoose ORM](https://mongoosejs.com)
- [GraphQL Apollo client & server](https://www.apollographql.com/docs/)
