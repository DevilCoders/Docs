# Тестирование Ручек Деградации Алисы

{% note info %}

Данный регламент описывает проверки ручек деградации Алисы.

Проверка осуществляем примерно раз в месяц до 21 часа.

Необходимым условием является обязательное уведомление команды.

Примерная продолительность - 15 минут.

{% endnote %}


## Порядок действий

0. Когда готовы начинать, проверяем, нет ли текущих релизов у Алисы;  
    Любой релиз для нас - блокер!  
    Это можно сделать в [этом чате](https://t.me/joinchat/JczMzkc7zgA4Yjky), вызвав команду `/queue`.  
    Если релизов нет, то приступаем.
0. Нужно написать в [чат с релизами](https://t.me/joinchat/JczMzkc7zgA4Yjky)  
`/push Тестирование ручек деградации Алисы (ASR) <тикет, если есть>.`

0. Зайти в чат Алисы [Alice Duty](https://t.me/joinchat/Tvni3chiAmfIiRDI) и оповестить коллег о начале тестирования:  
    ```
    Коллеги, планирую начать проверку деградации ASR.
    Планируется произвести изменение межпаршиального интервала и значение cutter’a.
    Проверку будем производить в MAN.
    ```
    Вместо MAN может быть любая другая локация на выбор, но проверку проводим только для **одной** локации!

0. Зайти в [ITS панельку](https://nanny.yandex-team.ru/ui/#/its/locations/voicetech/wsproxy_prod/).

    Открыть графики, они понадобятся чуть позже:
    * [Megamind]( https://solomon.yandex-team.ru/?project=megamind&cluster=prod&dashboard=megamind_health )
    * [график применения изменений от ITS](https://yasm.yandex-team.ru/menu/Alice/backends/uniproxy/WsProxy_Internal/?chart=ec0fdb21-0e32-524a-edf8-2e5b86e58a0e).

0. Изменить межпаршиальный интервал.

    В самом начале конфига выбранной локации строки дописать:
    ```
    - name: asr partial update period
      surface: quasar
      share: 1.0
      settings:
      - name: asr_partial_update_period_forced
        value: 1200
    ```
    Результат должен выглядеть так:  
    ![](https://jing.yandex-team.ru/files/bunnyhop/Screen%20Shot%202022-01-18%20at%209.21.30%20PM.png)

0. Предупреждаем в чате Alice Duty коллег о том, что собираетесь изменить межпаршиальный интервал:
    
    ```Выставляю в MAN период паршиалов 1200```

0. Жмем Apply в ITS.

    * На графике применения изменений от ITS,
    
        Дожидаемся пока начнут увеличиваться значения Prod OK.
        ![](https://jing.yandex-team.ru/files/bunnyhop/Screen%20Shot%202022-01-18%20at%209.29.26%20PM.png)

    * На графике Megamind

        На графике трафика должна появиться небольшая ступенька вниз.
        ![](https://jing.yandex-team.ru/files/bunnyhop/Screen%20Shot%202022-01-18%20at%209.31.03%20PM.png)

0. Ждем 5 минут.

    Cледим за чатом Alice Duty на предмет сработавших алертов.

    {% note warning %}

    Могут срабатывать трендовые алерты на резкое понижение трафика, это ожидаемо.

    Например [web_sandwich.APPHOST_report_alice_rps_trend_down_chart_for_all_dc](https://juggler.yandex-team.ru/check_details?host=web_sandwich.APPHOST_report_alice_rps_trend_down_chart_for_all_dc&service=for_all_dc).
    
    Если срабатывают какие-то другие алерты, не связанные с понижением трафика, стоит призвать дежурных.


    {% endnote %}

0. Вернуть интервал в дефолтное значение.

    Убрать из ITS конфига выбранной локации добавленные на шаге 5 строки.

0. Оповестить дежурных в чате Alice Duty.
    О том, что собираетесь возвращать дефолтное значение межпаршиального интервала, и жмем Apply

0. Проверяем в графике применения изменений от ITS, что все применилось.
    Снова вырастут Prod OK, как в шаге 7.

0. Переходим на панель Megamind.
    Дожидаемся чтобы трафик вернулся, появилась ступенька вверх к прежним значениям.
    ![](https://jing.yandex-team.ru/files/bunnyhop/Screen%20Shot%202022-01-18%20at%209.40.47%20PM.png)

0. Изменить значение "срезатора" паршиалов.
    Сразу после того, как на графике трафика на MegaMind все вернулось к прежнему значению.

0. Правим ITS конфиг выбранной локации.
    Находим строки:
    ```
    - name: asr tune settings
      surface: quasar
      share: 1.0
      settings:
      - name: asr_result_threshold
        value: 0.05
    ```
    Выставляем `value: 0.9`.

0. Предупреждаем дежурных в чате Alice Duty.
    О том, что собираетесь изменить значение asr cutter в 0.9
    ```
    Выставляю в MAN значение ASR Cutter в 0.9
    ```

0. Нажать Apply.

0. Дождаться на графике применения изменений от ITS всплеска (как в п.7).

0. Дождаться на графике трафика MegaMind ступеньки трафика вниз.

    ![](https://jing.yandex-team.ru/files/bunnyhop/Screen%20Shot%202022-01-18%20at%209.55.58%20PM.png)

0. Ждем 3 минуты.

    Также следим за алертами в чате Alice Duty.  
    На трендовые алерты на понижение трафика по-прежнему не реагируем - это ожидаемо.

0. Возвращаем value обратно в 0.05.

    В результате этот кусочек конфига должен выглядеть как в п. 14.

0. Оповещаем дежурных в чате Alice Duty.
    
    Что собираемся выставить дефолтное значение ASR Cutter
    ```
    Выставляю в MAN дефолтное значение ASR Cutter (0.05).
    ```

0. Прожимаем Apply в ITS.

0. Ждем на графике применения изменений ITS всплеска (как в п.7).

0. Ждем нормы на графике Megamind, аналогично п.12.

0. После возврата к прежним значениям, пишем в чате Alice Duty:

    `Учения по проверке ручек деградации завершены`.

0. В чате очереди релизов Алисы
    
    выполняем команду `/pop`.

0. Заполнить эту [форму](https://forms.yandex-team.ru/surveys/62972/). 
    
    ```
    - Компонента Warden: alice
    - Название ручки деградации: asr_degradation
    - Тикет на проверку - из календаря. Если тикета нет, можно вписать MARTY-4708.
    - Дата проверки: сегодняшняя
    - Результат: соответственно выбрать.
    ```

    Если проблемы с заполнением формочки - писать @bunnyhop.

## Прочее
При проблемах позвать:
* [@danichk](https://staff.yandex-team.ru/danichk)
* [@av-kotikov](https://staff.yandex-team.ru/av-kotikov)

## Ссылки
* [Применились ли настройки ITS](https://yasm.yandex-team.ru/menu/Alice/backends/uniproxy/WsProxy_Internal/?chart=ec0fdb21-0e32-524a-edf8-2e5b86e58a0e).
* [Дебаг-панель Megamind](https://solomon.yandex-team.ru/?project=megamind&cluster=prod&dashboard=megamind_health%E2%80%A9).
    * Должен уменьшиться трафик на графике запросов в мегамайнд.
    * При возникновении любых упячек - звать дежурных.

## Доп.инф.
* [Пороги срезатора](https://wiki.yandex-team.ru/users/bsheludko/partialsclassifier/thresholds/)
