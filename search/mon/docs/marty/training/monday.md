# Прогрузка

## Время проведения

Стандартное время проведение этих учений - еженедельно **по понедельникам с 16:00 до 17:00**

При необходимости проведения дополнительных работ или переноса требуется [запланировать событие](planning.md)

## Пререквизиты для начала учений

   1. <input type="checkbox" /> | Известен [Дежурный Марти](https://abc.yandex-team.ru/services/dutysearch/), далее Оператор Ручки. Узнать: командой `/marty` в [YaIncBot](https://t.me/YaIncBot)
   1. <input type="checkbox" /> | Есть запланированное событие в [infra](https://infra.yandex-team.ru/timeline?preset=RsermoJ6k5F&from=1640988574162&to=1641074974162&autorefresh=false&status=all&filter=&fullscreen=false) ([пример](https://infra.yandex-team.ru/event/10456)) и оно внесено в [календарь блокирующих работ](https://calendar.yandex-team.ru/embed/month?layer_ids=32047)
   1. <input type="checkbox" /> | Есть тикет на проведение учений в очереди [SEPE](https://st.yandex-team.ru/SEPE/order:updated:true/filter?resolution=empty())(он создается автоматически заранее и линкуется к [SEPE-16694](https://st.yandex-team.ru/SEPE-16694))
   1. <input type="checkbox" /> | Все релизы, включая инфраструктурные, завершены.
   1. <input type="checkbox" /> | Нет активных факапов, все локации стабильны и принимают трафик.
   1. <input type="checkbox" /> | Нет инфо-поводов и значимых событий, требующих высокой доступности сервисов


## Учения

### Анонс
  О начале и об окончании прогрузки приходит автоматическое оповещение. Примерно за 15 минут до прогрузки и сразу же после нее.
  После этого Оператор Ручки ожидает подтверждение от Вертикалей в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy) или просьбу о передвижении времени начала (до 45 минут) учений от дежурных Вертикалей-участников.
  Прогрузка начинается вовремя даже если какая-либо вертикаль не подтвердила свое наличие в чате.

  > Предупреждение о ручных прогрузках в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  ![1](_imgs/monday1.png)

  ### Действия перед прогрузкой

  #### За час до начала прогрузки проверить:

  > Предупреждение за час в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  ![2](_imgs/monday2.png)

  * доступность основного инструмента прогрузки - [сервиса Ученек](https://uchenki.yandex-team.ru/training/current)
  * установить релизные локи второго приоритета на поисковые вертикали
  * доступность резервного инструмента прогрузки - ITS ручки:

    * [WEB](https://nanny.yandex-team.ru/ui/#/l7heavy/production_search/)
    * [IMGS](https://nanny.yandex-team.ru/ui/#/l7heavy/production_imgs/)
    * [VIDEO](https://nanny.yandex-team.ru/ui/#/l7heavy/production_video/)
    * [MORDA+EFIR](https://nanny.yandex-team.ru/ui/#/l7heavy/production_morda/)
    * [ANY](https://nanny.yandex-team.ru/ui/#/l7heavy/any.yandex.ru/)
    * [TURBO](https://nanny.yandex-team.ru/ui/#/l7heavy/turbopages_service_balancer/#turbo)
    * [FRONTEND.VH](https://nanny.yandex-team.ru/ui/#/l7heavy/frontend.vh.yandex.ru/#bygeo)
    * [COLLECTIONS(PDB)](https://nanny.yandex-team.ru/ui/#/l7heavy/pdb.yandex.ru/)

  > Тут указан примерный список ручек. Полный список ручек в сервисе [Учений](https://uchenki.yandex-team.ru/training/current)

  #### За 15 минут до начала прогрузки проверить:

  > Предупреждение за 15 минут в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  ![3](_imgs/monday2.png)

  * нет активных выкаток релизов поисковых вертикалей. Выкатка релизов на время прогрузки приостанавливается и должна быть закончена до начала учений.
  * наличие блокеров (сверхсрочные релизы\аварийные ситуации). При наличии оных, согласовать с [Дмитрием Носовым](https://staff.yandex-team.ru/dmitryno)([Telegram](https://telegram.me/dmitryno)) или [Александром Донцом](https://staff.yandex-team.ru/a$
  * правильно отработало автоматическое оповещение о прогрузке.

  {% note alert "В случае если не отработало или отработало не правильно:" %}

  > Сделать `/martycast` через [YaIncBot](https://t.me/YaIncBot) со следующим текстом:

  `Через 15 минут начинаем плановую прогрузку: https://st.yandex-team.ru/SEPE-<вставить номер актуального тикета> .
  Проверяем запас локаций. Полокационная последовательность - SAS, MAN, VLA
  Просим дежурных сервисов к этому времени быть готовыми ко всему, при желании приходите к нам в SEPE для возможности более тесной координации. Дежурные сервисов, не участвующих в прогрузке, будьте готовы к повышенной нагрузке от соседей.
  Координация ученек в чате https://t.me/joinchat/RwmSLjQAGzFkYjAy.`

  {% endnote %}

  #### За 5 минут до начала прогрузки

  > Предупреждение за 5 минут в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  ![4](_imgs/monday4.png)

  * Уточнить в [чате учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy) : `Привет! Мы готовы начать прогрузку. Есть ли у кого-либо возражения?`. Если за 5 минут возражений по существу не найдётся, то переходим непосредственно к прогрузке.

  >  **Примечание** : нецелесообразно обходить чаты, собирать дежурных от сервисов и проводить перекличку.

### Автоматический режим

  1. За 20 минтут до начала учений, дежурный подтверждает их проведение в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  2. За 15 минут бот присылает сообщение с ссылкой на прогрузки и ссылкой на UI для изменения весов или выхода из прогрузки
  3. Дежурные сервисов, у которых есть доступ к весам балансера могут сделать откат весов или выход из прогрузки
  4. Алерты, размеченные заранее, могут стать причиной автоматической остановки

  ### Ручной режим

  {% cut "Ручной режим"  %}


  ### Последовательность действий

  > Предупреждение о начале ручной прогрузки в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)
  ![5](_imgs/monday5.png)

  Обычно с локациями работаем в порядке SAS -> MAN -> VLA. Предупреждать об изменении порядка в `/martycast` через [YaIncBot](https://t.me/YaIncBot). (Нужно согласование [Александра Донца](https://staff.yandex-team.ru/alexunix)([Telegram](https://t.me/AlexDonets)) и [Дмитрия Носова](https://staff.yandex-team.ru/dmitryno)([Telegram](https://telegram.me/dmitryno)))
  Оператор Ручки работает с весами через сервис [Ученек](https://uchenki.yandex-team.ru/training/current).

  > Выставление шага вперед для всех и применить
  ![6](_imgs/monday6.png)

  Таргет и сигналы rps задаются в сервисе ученек, например для [веба](https://uchenki.yandex-team.ru/settings/service/web) и на панели [таргетов](https://yasm.yandex-team.ru/template/panel/search_load).
  Первоочередная задача - принять таргет.   Выше таргета грузим только после того, как все вертикали достигли таргетных значений.

  Расчет шагов и коэффициенты:
  Поскольку таргеты на все вертикали неравнозначны, и при подаче трафика одинаковыми порциями не получается достичь таргета одновременно всеми Вертикалями, то процент подаваемого трафика на вертикаль - отличается.

  >Во время применения каждого шага, копировать и публиковать diff в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy) на каждом шаге.
  ![7](_imgs/monday7.png)

  **Первый шагом**: Оператор ручки подбирает веса так, чтоб эмулировать закрытие локации.   То есть прилетевший трафик должен быть равен 1/2 текущего трафика.

  **Последующие шаги**: веса берутся исключительно из сервиса [Ученек](https://uchenki.yandex-team.ru/training/current?tab=current).

  Между шагами ждем 3 минуты. В течение этих минут Оператор Ручки:
  * заряжает патроны для следующего шага;
  * проверяет, что графики, которые есть на Иконостасе (disaster метрики), стабилизируются;
  * принимает заявки на кастомизацию от дежурных сервиса;
  А дежурные сервиса проверяют, что сервис не вышел за пределы допустимых значений.

  > Выставление нагрузки в ручном режиме для отдельной вертикали
  ![8](_imgs/monday8.png)

  ### Остановка прогрузки какой-либо вертикали

  #### Остановка происходит одним из способов:
  Инициирована дежурным запросом "Вертикали <такой-то> больше не наливать".
  В качестве результата учений фиксируется цифра, полученная при текущем шаге. Эту цифру изменить будет нельзя, доливать трафика в эту вертикаль больше нельзя.

    > Фриз на нагрузку вертикали для последующих шагов
  ![9](_imgs/monday9.png)

  Откат трафика с сервиса на шаг назад. В том числе, любая просьба "отлить" трактуется как выход из учений.
  В качестве результата учений фиксируется последний успешный шаг.
  При остановке прогрузки какой-либо из вертикалей, оставшиеся - продолжают грузиться.
  Остановка прогрузки может быть автоматически инициирована для сервиса алертами
  (срабатывание алёртов детектится с помощью сервиса [Ученьки](https://uchenki.yandex-team.ru/training/current))
  у алертов должен быть теги в juggler   (uchenki_training_{stop|stepback|default}  и один или несколько uchenki_service_имя_сервиса)

  #### Выход из прогрузки Вертикали:
  > В случае критической ситуации на сервисе, дежурный может объявить default своей вертикали.
  ![10](_imgs/monday10.png)
  В качестве результата учений фиксируется предыдущий шаг.
  При выходе из учений таким образом какой-либо из вертикалей, продолжение учений для остальных сервисов проходит "по желанию". Результаты учений отмечаются как сомнительные.

  {% note info %}

  При выходе из прогрузки Веба до взятия таргета, необходимо завести инцидент на [веб](https://st.yandex-team.ru/MARTY-4599)

  {% endnote %}

  > Default для всех
  ![11](_imgs/monday11.png)

  {% endcut %}

  #### Окончание прогрузки:
  Объявление default всем означает окончание прогрузки. Это целиком и полностью прерогатива и ответственность Дежурной смены.
  Нужно написать `/uchenki finish training` в [чате ученек](https://t.me/joinchat/RwmSLjQAGzFkYjAy).
  Эта команда разошлет мартикаст о завершении, а в мартикасте будет тикет с учениями, куда дежурные линкуют свои spi.

{% note info "Взаимодействие Дежурной смены и дежурных от сервисов" %}

Все взаимодействие Дежурной смены и дежурных от сервисов происходит в [Чате Учений](https://t.me/joinchat/RwmSLjQAGzFkYjAy)

{% endnote %}

#### Дежурная смена отвечает за:
1. изменение весов;
1. состояние disaster-алертов (если сервис предоставил их), контроль состояния RTC, сети, доли и принятие решений на месте;

#### дежурный Вертикали отвечает за:
1. актуальность таргетов
1. работоспособность своей Вертикали во время прогрузки и минимизацию выхода сервисов за критические параметры
1. остановку прогрузки своей Вертикали или выход Вертикали из прогрузки

{% note alert "Дежурная смена следует исключительно:" %}

  1. данному документу
  1. просьбе от команды сервиса в лице дежурного отправить в default Вертикаль в чате прогрузки
  1. просьбе от команды сервиса в лице дежурного об остановке инкрементирования весов вертикали
  1. просьбе от команды сервиса в лице дежурного о снижении весов до предыдущего шага
  1. просьбе от команды любого сервиса остановить прогрузку целиком, так как у сервиса случились обстоятельства непреодолимой силы, выраженные в SPI

{% endnote %}

## После прогрузки

По окончанию процедуры заводятся тикеты и линкуются к тикету текущих учений:
1. Дежурная смена заводит SPI про каждую Вертикаль, которая не пережила первый шаг и линкует к тикету учений
1. Ответственные дежурные сервиса заводят тикеты в своих очередях на починку тех компонентов, которые не дали достичь target
1. Ответственные дежурные сервиса заводят тикеты в своих очередях про компоненты, мониторинги по которым сработали, но которые не стали блокером для дальнейшей нагрузки.

[Dashboard прогрузок](https://datalens.yandex-team.ru/inks4xbmmnwid-dashbord-po-ucheniyam?tab=Lr) автоматически пополняется результатами прогрузок.

В тикет текущих учений дежурные сервиса записывают:
* причины, по которым не достигли таргета локация/вертикаль


