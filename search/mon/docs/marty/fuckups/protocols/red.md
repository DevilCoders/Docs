# Красный протокол
Красный протокол - формат работы с глобальным инцидентом, в котором затронуто множество сервисов.  
Обычно этот протокол связан с крупных инфраструктурными проблемами (датацентры, сеть, балансировщики, RTC), т.к. именно такие проблемы могут сломать сразу большую часть сервисов Яндекса.

Он может быть запущен:
- Вручную в любом чате с ботом дежурной смены Yaincbot при помощи команды `/proto red`
- При эскалации протокола любого уровня ниже в красный.

Необходимо также помнить, что чат протокола красного уровня - закрытый, и ссылку на него не нужно давать в мартикасте.
> Марти является координатором инцидента с момента получения информации о нем и до момента передачи координации координатору
## Сценарий действий {#protocols-red-scenario}
Ниже описаны сценарии действий для Марти и Дежурных девопсов
{% list tabs %}

- Для Марти

  Задачи: контроль за состоянием приборов Иконостаса, информационная поддержка и обеспечение работы инструментов координации.

  - Марти эскалирует протокол любого уровня ниже в красный или запускает красный протокол сам в следующих случаях:
    - Значительно нарушена работа множества сервисов
    - Мажорная авария на сети/инфраструктуре
    - Проблема заметна большому числу пользователей
    - Инцидент освещается в СМИ
    - Инцидент отразился на доле

  - Создать закрытый чат инцидента и добавить туда координатора из Инфраструктурного Координационного чата и призвать дежурных от инфры/сети/ITDC при необходимости.
    > Необходимо ТОЧНО убедиться что выбранный вами координатор принял координацию инцидента! Если же никто из Инфраструктурного чата не отвечает в течение 3 минут - обзванивать по очереди

  - Написать в чат короткое описание проявлений инцидента и, по возможности, дать ссылку на мониторнги

  - Локализовать инцидент до сервиса, компоненты, локации, инфраструктуры или сети
    - Если локализуется до одного из ДЦ - закрыть ДЦ полностью и заблокировать релизы.

  - Предоставить дежурным все необходимую информацию:
    - Какие алерты сработали, какие вертикали/сервисы задевает (ссылки на алерты и графики)
    - Какие релизы/работы были в момент начала проблемы

  - Ограничить написание сообщение в КБФ:
    - Либо полностью [Пример](https://jing.yandex-team.ru/files/lensws/kbf_off.gif)
    - Либо частично [Пример](https://jing.yandex-team.ru/files/lensws/kbf_slow.gif)
  
  - Сделать мартикаст вида
    ```
    Произошла авария N.
    О связанных проблемах сообщать в чат дежурной смены https://t.me/+54xNB5Hi5LU3NTIy
    ```

  - Назначить координатора [в экстренных случаях Марти имеет право принудительно назначить координатора (с молчаливого согласия)]
    - Сделать в чате протокола `/proto coordinator @login`
      - Если нужен дополнительный человек для статусов, помимо координатора, следует указать как `/proto logger @login`

  - По мере необходимости/по запросу от девопсов находить и призывать в аварийный чат дополнительных специалистов

  - Периодически запрашивать статусы от дежурных, занимающихся проблемой, и обновлять статус в запине с помощью команды `/proto status %текст статуса%`.

  - По окончании инцидента сделать мартикаст вида
    ```
    Авария N устранена. Разбор будет в SPI: %ссылка на SPI%. Если ваш сервис пострадал - линкуйте к этому SPI.
    ```

  > Особенности Красного протокола с точки зрения марти:
  > - Чат создается закрытый (и ссылку на чат нельзя указывать где-либо)
  > - Необходимо как можно скорее передать координацию опытному координатору
  > - Обновлять статус проблемы в КБФ при необходимости
  

- Для Координатора

  Задачи: принимать централизованные решения, сокращать время починки, давать информацию пострадавшим сервисам

  - Координатор должен полностью понимать картину происходящего
  - Координатор принимает от сервисов информацию об их состоянии
  - Координатор информирует инженеров, занимающихся починкой о состоянии сервисов
  - Координатор подключает к решению проблемы дополнительные команды при необходимости
  - Координатор берет на себя ответственность за принятие важных решений в процессе починки
  - Координатор дает апдейты в КБФ


- Для Дежурного от сервиса

  Задачи: устранение инцидента, выдвижение идей, помощь командам в поиске проблемы.

  - Прийти в координационный чат и подтвердить свое участие в решении проблемы
  - При необходимости привлечь коллег и руководителя (если нет понимания что делать)
  - Давать всю собранную диагностику и сообщить в чат если удалось понять причину проблемы
  - Сообщать о своих действиях на проде
  - По необходимости запрашивать дополнительную информацию

{% endlist %}

## Чеклист инцидента {#protocols-red-checklist}
- **Создан закрытый чат координации**
  > При красном протоколе необходимо создавать именно закрытый чат для координации. Хотя, если красный протокол появился в результате эскалации из оранжевого/желтого - нет нужды создавать еще один чат. Можно вести координацию в том, который есть.
- **Сделан мартикаст о проблеме**
  > Необходимо оповестить другие сервисы о проблеме. Возможно, дежурные других сервисов прямо сейчас пытаются понять источник проблемы сами, не зная о глобальных проблемах.
- **В чате есть вся информация, относящаяся к проблеме (сработавшие алерты, релизы, работы в момент начала инцидента)**
  > Это сократит время поиска и решения проблемы
- **Выбран координатор**
  > В инцидентах красного уровня необходим опытный координатор, который будет принимать ключевые решения в процессе починки
- **Устранено влияние на пользователей**
- **Мониторинги вернулись в норму**
- **Сделан мартикаст об окончании инцидента**
- **Заведен и привязан к протоколу SPI**

Также существует следующая схема для Красного протокола:
![](https://jing.yandex-team.ru/files/nika/plan.png)
