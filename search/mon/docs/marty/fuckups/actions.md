# Регламентные действия для спасения прода

Для устранения проявлений инцидента дежурный Марти (обычно по согласованию с дежурными девопсами/координатором) может выполнить следующие действия:
> Любое совершение указанных ниже действий - уже инцидент, и на это ***обязательно*** должен быть заведен SPI

## Откат релиза  {#actions-rollback}
***Что дает***
- Возврат состояния сервиса к старой, работающей версии

***Когда применять***
- Если инцидент вызван некорректной работой новой версии сервиса

***Как сделать***  
  
**Обычный откат релиза целиком** (используется в 99.99% cлучаев)
- Останавливаем выкладку текущего релиза кнопкой Reject, переходим в дашборд, и с помощью revert view выбираем нужную версию, на которую будем откатываться (по согласованию с дежурным девопсом/координатором).  
  После того, как хеды (heads) корректно переставились на нужные версии, начинаем выкатку старой стабильной версии.  

**Откат лишь одного из Nanny-сервисов на предыдущий снепшот**
- После согласования с дежурным девопсом/координатором, марти через UI Nanny выбирает нужную версию снепшота у сервиса и производит его активацию  

{% note alert %}

  Применяется в исключительных случаях, т.к. нарушает консистентность прода.

{% endnote %}
  

## Перебалансировка трафика на L7  {#actions-l7-rebalancing}
***Что дает***  
- Перераспределение нагрузки между ДЦ

***Когда применять***  
- Если необходимо разгрузить одну из локаций, при условии что остальные стабильно держат нагрузку

***Как сделать***  
- Изменить веса для нужной вертикали через интерфейс [L7 Heavy](https://nanny.yandex-team.ru/ui/#/list-l7heavy/).  
  Новые веса перед применением стоит согласовать с дежурными девопсами/координатором

## Закрытие локации  {#actions-closing}
***Что дает***
- Отвод трафика из сломанного ДЦ в остальные

***Когда применять***
- В случае, если проблема критичная (Disaster-алерты, влияние на пользователей) и локализуется до конкретного ДЦ
- Запланированы работы с инфраструктурой или сервисами в красном календаре, требующие закрытия локации

***Как сделать***  

**Порядок действий при экстренном закрытии**

1. Закрыть балком [все L7 балансеры](https://nanny.yandex-team.ru/ui/#/list-l7heavy/)
2. ***При необходимости*** закрыть [сервисные балансеры](https://nanny.yandex-team.ru/ui/#/its/locations/balancer/all-service/sas), выбрав нужную локацию и нажав кнопку ***Apply All***
3. ***При необходимости*** cнять [анонс L7](https://nanny.yandex-team.ru/ui/#/its/locations/l7_heavy/l3_checks/), выставив для нужной локации `return 503` и нажав для нее ***Apply***
4. Выставить [даунтайм](https://juggler.yandex-team.ru/dashboards/downtimer/) для локации
5. Сделать мартикаст о закрытии локации. Указать в мартикасте инцидент или ссылку на чат с разбором проблемы  

{% endcut %}
   
{% cut "Штатный вариант (напр. при работах)" %}
  
1. Выставить [даунтайм](https://juggler.yandex-team.ru/dashboards/downtimer/) для локации
2. Сделать мартикаст о закрытии локации, указав причину закрытия и ссылку на чат координации
3. Закрыть балком [L7 балансеры](https://nanny.yandex-team.ru/ui/#/list-l7heavy/)
4. ***При необходимости*** закрыть [сервисные балансеры](https://nanny.yandex-team.ru/ui/#/its/locations/balancer/all-service/sas), выбрав нужную локацию и нажав кнопку ***Apply All***
5. ***При необходимости*** cнять [анонс L7](https://nanny.yandex-team.ru/ui/#/its/locations/l7_heavy/l3_checks/), выставив для нужной локации `return 503` и нажав для нее ***Apply***  

{% endcut %}
  
{% cut "Порядок открытия локации" %}  
  
Открываем локацию в обратном порядке.  
Открывать можно только если нет активных работ в красном календаре (требующих закрытия локации) и в локации нет активных проблем.
1. Мартикаст об открытии локации
2. Возвращаем анонс L7 если снимали (выбрав `return_200_weighted` и нажав ***Apply***)
3. Возвращаем сервисные балансеры (кнопкой ***Cancel All*** в нужной локации)
4. Открываем локацию постепенно (если это возможно).  
> К примеру для веб-поиска плавное открытие делается следующим образом: наливаем в `production_search/search` 5% трафика, посмотреть по приборам что все хорошо, налить 15%, и уже затем вернуть дефолтные веса.
5. Снять даунтайм

{% endcut %}

{% note info %}

Более подробную инструкцию по закрытию локации можно прочесть [тут](https://wiki.yandex-team.ru/jandekspoisk/sepe/dezhurnajasmena/procedures/zakrytie-lokacii2/)

{% endnote %}

## Снятие анонса сервисных балансеров  {#actions-shutdown-announcement}
***Что дает***
- Увод трафика с сервисных балансеров для конкретной локации

***Когда применять***
- Полное (***Apply All для всей локации***) - при наличии проблем, например, со связностью или железом.  
  **Обычно применяется вместе с закрытием локации**
- Выборочное (***Apply для одного из балансеров***) - по запросу дежурных сервиса

***Как сделать***  
- Перейти по [ссылке](https://nanny.yandex-team.ru/ui/#/its/locations/balancer/all-service/sas), выбрать нужную локацию, и нажать ***Apply All***, если закрываем все сервисные балансеры в выбранной локации, или просто ***Apply*** для конкретных балансеров (при выборочном закрытии).


## Снятие анонса с L7  {#actions-shutdown-l7-announcement}
***Что дает***
- Отключается хождение из L3 в L7 локации

***Когда применять***
- При сетевых проблемах в локации (по согласованию с девопсами)

***Как сделать***
- Перейти по [ссылке](https://nanny.yandex-team.ru/ui/#/its/locations/l7_heavy/l3_checks/), выставив для нужной локации `return 503` и нажав для нее ***Apply***

{% note info %}

Нас интересуют именно локации sas, man, vla, а не sas_only и т.п.

{% endnote %}

## Выборочное отключение/добавление флагов через ITS  {#actions-flags-its}
***Что дает***
- Некорректные флаги перестают аффектить работу сервисов

***Когда применять***
- По запросу от сервисных команд

***Как сделать***
- Уточнить у дежурного девопса для какой вертикали необходимо отключить/добавить флаг
- Перейти по [ссылке](https://nanny.yandex-team.ru/ui/#/its/locations/upper/man) и для всех локаций указанной вертикали прописать ID флага в поле `Set flag disable_flag_sections` (если нужно отключить), или удалить нужный ID оттуда (если нужно включить)  

{% note tip %}

Как правило отключаем/включаем флаги во всех локациях (sas, man, vla), но не лишним будет уточнить у дежурного в каких локациях отключаем/включаем

{% endnote %}

{% note warning %}

После внесения на ITS в исключения, удалению не подлежит. Все новые изменения на включение стоит делать новым релизом флагов. 

{% endnote %}

## Экстренная выкатка флагов  {#actions-flags-emergency}
***Что дает***
- Возможность экстренно выкатить релиз флагов в обход очереди

***Когда применять***
- По запросу от команд

***Как сделать***
- ASAP выкатить релиз флагов, после его попадания в очередь 
- Общая процедура описана [тут](https://wiki.yandex-team.ru/jandekspoisk/sepe/dezhurnajasmena/procedures/jekstrennaja-vykatka-cherez-flags.json/)  

{% note tip %}

Можно давать [эту ссылку](https://wiki.yandex-team.ru/jandekspoisk/sepe/dezhurnajasmena/procedures/jekstrennaja-vykatka-cherez-flags.json/) людям, которые приходят в мартичат с просьбой выкатки экстренного релиза флагов, но не знают что нужно для этого сделать

{% endnote %}

## Экстренная выкатка релизов  {#actions-release_emergency}
***Что дает***
- Максимально быстрый способ выкатить релиз

***Когда применять***
- В случае острой необходимости выкатить хотфикс как можно быстрее

***Как сделать***  
   
**Штатный хотфикс**
- ASAP выкатываем релиз после его попадания в очередь  

{% note warning %}

**В случае суперкритичных ситуаций**  по согласованию с дежурными и [bunnyhop@](https://staff.yandex-team.ru/bunnyhop) можно выкатить релиз с DL = 1. Это **обязательно** требует закрытия локации, так как гарантировано приведет к значительной деградации (а скорее неработоспособности) выкатываемой компоненты.

{% endnote %}

## Выборочное и полное отключение экспериментов через ITS  {#actions-off-exps}
***Что дает***
- Выборочное - устраняется негативное влияние того или иного эксперимента на вертикаль
- Полное - экономия ресурсов поиска (не тратятся ресурсы на обработку экспериментальных правил)


***Когда применять***
- Выборочное - по запросу от сервисных команд
- Полное - при массовой деградации поиска (**необходимо** согласование с дежурными девопсами поиска)

***Как сделать***  
  
**Для выборочного**
- Перейти по [ссылке](https://nanny.yandex-team.ru/ui/#/its/locations/experiments/all_loc/), вписать `e[testID отключаемого эксперимента]` в поле `Disable specific experiments`, и нажать кнопку ***Apply***  
  
**Для полного**
- Перейти по [ссылке](https://nanny.yandex-team.ru/ui/#/its/locations/experiments/all_loc/), и напротив  `Disable all experiments` нажать кнопку ***Apply***

{% note alert %}

Полное отключение экспериментов это одна из крайних мер, для этого нужно подтверждение координатора инцидента

{% endnote %}

## Увод трафика в Тыкву  {#actions-pumpkin}
***Что дает***
- Позволяет снизить нагрузку на поиск и при этом отдавать ответы на самые популярные запросы

{% note alert %}

Включается только вручную, по решению координатора инцидента в случае, если все остальные стандартные способы нивелирования влияния инцидентов на пользователей исчерпаны, либо неэффективны ввиду полного отказа поисковых вертикалей.

{% endnote %}

***Когда применять***
- По решению координатора инцидента

***Как сделать***
- Перелить трафик на L7 в секцию Pumpkin (под катом fallback locations) для каждого сервиса отдельно.

## Увод трафика "в пол"  {#actions-flush}
***Что дает***
- Снижение нагрузки на вертикали за счёт игнорирования части трафика

{% note alert %}

"Слив" трафика в devnull является самой крайней мерой

{% endnote %}

***Когда применять***
- По решению координатора инцидента

***Как сделать***
- Перелить трафик на L7 в секцию DEVNULL (под катом fallback locations) для каждого сервиса отдельно.

## Откат FastData  {#fastdata-rollback}

***Что дает***

FastData - данные для переранжирований верхнего метапоиска (noapacheupper), подгружаемые в рантайм. Сюда попадают в т.ч. автоматические списки РКН.

***Когда применять***

Если дежурный DevOps укажет на откат и подтвердит, что источником проблемы является выкладка FastData с неправильными данными, втч от РКН. 

***Как сделать***

Описано тут:
https://docs.yandex-team.ru/noapache-fast-data/rollback

Примеры таких инцидентов:
* https://clubs.at.yandex-team.ru/lsr/161
* https://clubs.at.yandex-team.ru/lsr/185
