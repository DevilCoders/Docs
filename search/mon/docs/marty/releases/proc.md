# Процедура выкладки релиза

{% note alert %}

Переключение релизов начинается, минимум, с 8 часов и должно быть завершено, как максимум, до 23 часов, в пятницу - до 17 часов (до начала ученек и с учётом времени на откат).

Если заранее известно, что релиз не успеет переключиться (с учётом потенциального отката релиза) до 23 часов, его переключение переносится на следующий день.

{% endnote %}

## Порядок выкладки релизов
Для всех сервисов, которые выкатывают релизы самостоятельно рекомендуется:
* Пройти обучение в дежсмене по откатыванию и координации при факапах;
* Добавить лочки в рецепты;
* Проверить что релиз сервиса виден в [таймлайне](https://infra.yandex-team.ru).

## Письма о выкладке срочных релизов

Работа с релизами происходит при помощи [Няни](https://nanny.yandex-team.ru). Для релизов созданы "очереди", у каждой очереди есть ответственные. Если релиз не попал ни в какую очередь (ни один ответственный не забрал себе релиз этой программы), то тикет сваливается в DEVNULL и закрывается автоматом. Дежурный поиска выкатывает релизы из метаочереди [SEARCHMON](https://nanny.yandex-team.ru/ui/#/queues/meta/SEARCHMON/releases/).

О срочных релизах и фиксах необходимо писать заранее (как только о них становится известно) на searchmon@ и отдельно [@bunnyhop](https://staff.yandex-team.ru/bunnyhop), чтобы можно было скорректировать расписание выкладок, оставив место под срочный релиз.
Если релиз необходимо выкатить вне очереди вот прямо сейчас, нужно звонить [@bunnyhop](https://staff.yandex-team.ru/bunnyhop) или на 5050 по телефону.
Письмо о релизе должно содержать:
* название программы, версию релиза;
* откуда брать бинарник (релизы поисковых программ принимаются только из sanbox);
* список изменений релиза или ссылку на него;
* дополнительные действия, сопряженные с выкатыванием, если актуально;
* какие побочные эффекты ожидать при выкатывании, если актуально;
* Смывается ли кеш, если актуально;
; на что откатываться в случае проблем с этим релизом (если предыдущий релиз был неудачным это может быть существенно).

## Выкладка релизов
Выкладки релизов производятся по рабочим дням, в рабочее время.  
**В пятницу и предпраздничные дни действуют дополнительные рекомендации на релизы:**
* не выкладываются экспериментальные релизы (релизы на часть инстансов, "на посмотреть");

### Релизы, выкатываемые "на посмотреть".
Под релизами, выкатываемыми "на посмотреть" подразумеваются релизы, выкатываемые в одну локацию с наливкой небольшой доли трафика для проверки стабильности работы.  
На такие релизы накладываются дополнительные ограничения:
* Такой релиз должен выкатываться в рамках запланированных заранее работ;
* Релиз лучше выкатывать в закрытую локацию;
* В локацию необходимо наливать минимум 1% трафика для оценки выдачи и минимум 5% для оценки влияния на времена целефой вертикали\компоненты.


### Релизы экспериментов АБ
* Понедельник - четверг:  
    * Релизы катаются 2 раза в день - в обед (после 13 часов) и вечером (после 18 часов).
    * Желательно успеть выкатить вечерний релиз до 12 ночи.
* Пятница или предпраздничный день:
    * Если релиз не успевает выехать до 17 часов (до начала ученек и с учётом времени на откат), то он переносится на вечер.
* Суббота, воскресенье и праздничные дни:
    * Выкатка в любое удобное для дежурного время. Рекомендуемое время - до обеда.

Все дополнительные выкатки согласовываются с дежурной сменой.

## Откат релиза
* Тикеты откаченных по каким-либо причинам релизов переведятся Nanny в состояние ROLLED_BACK.
* Релизы с исправлениями откаченных релизов, ставятся в конец очереди релизов на общих основаниях, дабы не тормозить другие релизы.
* Каждый откат релиза должен сопровождаться тикетом SPI на соответствующую компоненту.

Причиной для отката являются:
* падения программ, заметные для пользователей (нарушена «критическая» функциональность поиска);
* проседание качества поиска, времени ответа или других критических показателей сервиса, выходящие за KPI.
    * не только конкретного сервиса, но и любого другого, на который данный деплой мог повлиять.

Причиной для отката не являются:
* редкие падения программ, не заметные для пользователей;
* проседание качества поиска, времени ответа или других критических показателей сервиса, не выходящие за KPI;
* пропадание редкого колдунщика (например колдунщика коктейлей).

{% note alert %}

До принятия решения об откате релиза, таска деплоя, предполагаемая к откату должна быть остановлена.

{% endnote %}

{% note alert %}

Решение об откате релиза принимается ответственными за сервис(владельцами сервиса), дежурными DevOps вертикали или сервиса.  
Исключением являются релизы флагов и экспериментов. Сотрудники дежурной смены незамедлительно приступают к откату, если такие релизы приводят к выходу критических показателей сервисов за KPI.

{% endnote %}

Решение о срочном откате принимается дежурным администратором:
* если в ходе деплоя обнаружены выходы графиков за KPI (не только конкретного сервиса, но и любого другого, на который данный деплой мог повлиять)(сработки disaster алертов сервисов или компонент);
* если нарушена «критическая» функциональность поиска;
* если не было ответа от сервиса на запрос об откате в течение 5 мин от дежурных devops вертикали или сервиса.

{% note warning %}

В случае серьёзного аффекта пользователей при выкатке в SAS сбойного релиза, на время принятия решения об откате и откате релиза следует закрыть локацию.

{% endnote %}

{% note warning %}

Если релиз передан команде сервиса, она указывает в сообщении к релизу, кто имеет право откатывать данный релиз, если сервис сломан, а команда сервиса не может откатить релиз самостоятельно.

{% endnote %}

{% note warning %}

Все общение должно быть в протокольном чате инцидента (в телеграмм).  
Личные сообщения не применимы, чтоб были логи общения с сервисом. Телефоном пользоваться можно, но дублировать в протокольный чат или SPI-тикет.

{% endnote %}

* В случае обнаружения в релизе некритичных проблем, ответственный за релиз должен указать сроки их исправления в соответствующем инциденте.
* Срок исправления привнесённых релизом проблем не должен превышать 7 рабочих дней.
* Если в указанные сроки проблемы не решены, релиз откатывается.
* В случае невозможности отката новые релизы этого компонента не выкладываются до исправления проблемы.
* Откатынные по каким-либо причинам релизы и релизы с исправлениями откаченных релизов, ставятся в конец очереди релизов на общих основаниях, дабы не тормозить другие релизы.

### Откат релизов экспериментов
* Если просели KPI графики - незамедлительно откатываем с уведомлением релиз-менеджера;
* Если есть некритичные отклонения от нормы - связаться с релиз-менеджером и сообщить о проблеме.
    * Возможно, получится решить вопрос через отключение проблемного эксперимента, не прибегая к откату всего конфига целиком.
* Если приходят коллеги со своими упавшими графиками и время совпадает с релизом экспериментов - уведомить релиз-менеджера для совместного решения проблемы.

Рекомендуются к прочтению также следующие инструкции:
* https://wiki.yandex-team.ru/infra-cloud/rfc/nanny/forwardrollback
* https://wiki.yandex-team.ru/runtime-cloud/nanny/revert-view

## Процесс выкладки
Выкладка релиза состоит из двух частей:
* раскладка данных на сервера (preparing\подготовка);
* переключение программы (deploy\выкатка).
    * [Подробнее об рецептах и дашбордах релизов в Nanny](https://wiki.yandex-team.ru/runtime-cloud/nanny/alemate/yaml-recipes/)
    * [Лекция по процессе выкладки релизов в Nanny](https://moe.yandex-team.ru/moebius/courses/116/assignments/515/run/7/)

### Сроки и очерёдность выкладки
* Релизы выкатываются в том порядке, в котором они приходят.
* Если релиз по каким-либо причинам не может быть переключён, но после него в очереди есть готовый к переключению релиз, он пропускает свою очередь.
* Если перед релизом в очереди нет других блокирующих его релизов, он выкатывается за одни сутки (без учета праздников, выходных, регламентных и аварийных работ в ДЦ).

Блокирующим релизом считается релиз:
* Стоящий выше в очереди.
* Способный нарушить связность компонент.
* Являющийся более приоритетным по согласованию с командами сервиса (реконмендуется помечать как urgent, что приводит к перемещению релиза в верх очереди).

{% note alert %}

В случае факапов, учений и неотложных регламентных работ, релизы приостановливаются или откладываются до окончания соответствующего события.

{% endnote %}

{% note warning %}

Если релиз передан команде сервиса, она уточняет у Марти, когда можно будет выкатить релиз в соответствии с его порядком в очереди и блокирующими событиями или релизами.

{% endnote %}

Исключение по времени и очерёдности выкладки может быть сделано для релизов срочных фиксов, релизов со срочной критичной функциональностью или релизов, выкладывание которых в рабочее время, неприемлемо по техническим причинам.

Окончательное решение о том, является ли релиз срочным, принимают ответственные от SEPE, по договорённости с менеджером релиза и ответственным администратором.

Релизы могут меняться местами при согласии ответственных с обеих сторон.

#### Раскладка данных (preparing)
Данные разных релизов могут раскладываться (препейриться) параллельно на разные сервисы.

#### Переключение
* Не переключаются(выкатываются) параллельно релизы связных компонент внутри одного проекта.
* Так внутри большого поиска параллельно не переключатся:
    * Report;
    * Upper;
    * Begemot;
    * Mmeta;
    * Int;
* Так же параллельно могут переключаться релизы связных компонент, которые необходимо выкатывать одновременно.
* Переключение производится так, чтобы не просаживать KPI качества и производительности.
    * В случае выхода за KPI в процессе переключения релиза, последующие переключения не производятся до тех пор, пока система не будет стабилизирована.
    * Таким образом новые релизы не выкатываются до возвращение показателей в норму.
* Переключение релиза должно проходить максимум за 3 часа рабочего времени.
    * Если в течении этого времени релиз не удаётся выкатить по вине релиза (например просадили KPI и он не восстанавливается), он откатывается и встаёт в конец очереди.
    * Время между зависимыми переключениями, которые можно проводить последовательно, не должно превышать часа.

#### Уведомления о статусе выкладки
В [infra](https://infra.yandex-team.ru) обязательно сообщается о:
* начале и завершении переключения;
* проблемах во время выкладки;
* откате или приостановке релиза и их причине.

### Использование лочек при релизах

#### Что такое лочки?
В контексте няни это ноды в кластере [YT Locke](https://yt.yandex-team.ru/locke/) с определенным значением.
#### Для чего это нужно?
Мы хотим максимально обезопасить рантайм поиска.  
Каждая выкатка релиза - это потенциальный факап (релиз может сломать что-то).  
Одновременная же выкатка нескольких релизов на одну вертикаль - более вероятный потенциальный факап.  
Лочки позволяют избежать одновременной выкатки нескольких релизов на одну вертикаль.

Куда добавляются лочки?
В YT: https://yt.yandex-team.ru/locke/navigation?path=//home/deploy/scheduler
Путь в кластере: `//home/deploy/scheduler/{vertical}/{location}`

Локации: sas, man, vla
Вертикали: web, video, images - основные вертикали.

Как добавить лочки в рецепт?
* Кубики: `create_cypress_node` и `delete_cypress_node`.
* В поля `content` и `delete_if_content_equals` нужно вставлять имя сервиса (глобальное, например video_mmeta, begemot).
* В поле `yt_proxy` вставить `locke`.

[Подробнее про тип.](https://nanny.yandex-team.ru/ui/#/alemate/tasktypes_help/)

* После кубика с `manual_confirm` добавить лочки в соответствии с вертикалью и локацией, на которые катится релиз.
* После активации сервисов добавить кубик на удаление лока(ов), созданных до этого.

#### Как склонировать рецепт?
На странице рецепта, который необходимо склонировать, нажать на Clone Recipe (в нижнем левом углу).
Если не получилось:
* Получить OAuth token в nanny.
* Запустить [скрипт](https://a.yandex-team.ru/arc/trunk/arcadia/search/tools/nanny/clone_recipe.py)

Примеры:
* Рецепт бегемота (на вертикали web, images, video сразу)
    * [с лочками](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/begemot/recipes/catalog/deploy_with_locks/)
    * [без лочек](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/begemot/recipes/catalog/deploy/)
* Рецепт шаблонов web (только на web)
    * [с лочками](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/courier_web/recipes/catalog/prepare_and_deploy_with_locks/)
    * [без лочками](https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/courier_web/recipes/catalog/prepare_and_deploy/)
