# YAINCBOT
Yandex Incident Bot - Телеграм/Slack бот созданный с целью урегулирования и помощи в координации инцидентов в яндексе. Он имеет широкий функционал, позволяющий быстро среагировать на инцидент. По порядку:

 - Реализует логику для всех типов протоколов ( стандартный флоу ).
 - Имеет вспомогательные команды для удобной координации.
 - Имеет автоматику отрабатывающую по алертам настроенным в вардене. В том числе и подсчет **YDT**.
 - Умеет оповещать о работах из календаря.
 - Реализует логику для ученек.

## Работа в протоколами

В стандартном флоу имеется 4 уровня и 2 вида протоколов:
- Уровни:
    - [Зеленый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/green)
    - [Желтый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/yellow)
    - [Оранжевый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/orange)
    - [Красный](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/red)

- Виды:
    - [Стандартный протокол](https://testing.docs.yandex-team.ru/marty/fuckups/protocols)
    - [PR протокол](https://testing.docs.yandex-team.ru/marty/fuckups/pr)

#### Создание протокола нужного уровня:

 - /green - Зеленый
 - /yellow - Желтый
 - /orange - Оранжевый
 - /red - Красный

{% note info %}

Если бот используется в чате, после использования команд Зеленого, Желтого и Оранженого протокола будет предложен выбор: создать новый чат или продолжить в текущем.

{% endnote %}



#### Управление протоколом

Важно понимать, что бот автоматически создает spi только если протокол был создан автоматикой. В противном случае он предложит создать тикет или привязать существующий. Это стоит сделать в первую очередь.

В **SPI** бот может:

 - Дампить чат протокола.
 - Заносить графики, по которым завелся протокол.
 - Назначать компоненту
 - Назначать общее название проблемы
 - Назначать исполняющего. Обычно это дежурный сервиса, указанный в вардене.

Команды для работы руками:

 - /proto **component** [component] - привязать компоненту.
 - /proto **summary** [summary] - назвать краткое описание проблемы. Так будет назван **SPI** и, непосредственно, протокол.

Периодически бот будет запрашивать статус протокола. Его необходимо заполнять. Если же статус меняется чаще, можно использовать команду:

 - /proto **status** [status] - указать статус

Чтобы эскалировать протокол Зеленый->Желтый->Оранжевый->Красный, можно использовать вышеупомянутые одноименные команды.

{% note warning %}

Протокол автоматически эскалируется из **Зеленого** в **Желтый**, если в протоколе вынужден принять участие **Марти**.

{% endnote %}

#### TODO: Оранжевый протокол, Красный протокол

## Подписки

Команду `/subscribe`  может вызывать только Марти или администратор чата.
Чтобы начать кастомизировать уведомления от бота необходимо подписать чат. Делается это с помощью команды `/subscribe`. В результате в БД создаётся запись о чате, и дальнейшие изменения сохраняются в ней.

#### Какие могут быть уведомления:
TODO: скриншот subscribe.png

### Деплои (релизы)

#### DEPLOYMENTS
TODO: скриншот subscribe_deployments1.png

Позволяет подписаться на уведомление о взятии лочек для вашего релиза.

1. Нажимаем /subscribe 
2. Deployments
3. выбираем нужную вертикаль
4. выбираем нужный дашборд
5. выбираем нужный рецепт

Если включить уведомления и не выбрать ни один рецепт, то уведомления будут приходить по всем деплоям.

{% note info %}

Если включить уведомления и не выбрать ни один рецепт, то уведомления будут приходить по всем деплоям.

{% endnote %}

{% note alert %}

И не забудьте включить сами уведомления!!

{% endnote %}

TODO: скриншот subscribe_deployments2.png

### Релизы Morty

TODO: скриншот subscribe_morty1.png

Позволяет подписаться на уведомления от сервиса Morty.
1. Нажимаем /subscribe 
2. MORTY
3. выбираем нужную вертикаль
4. выбираем нужный дашборд
5. выбираем нужный рецепт

{% note alert %}

И не забудьте включить сами уведомления!!

{% endnote %}

TODO: скриншот subscribe_morty2.png

### Марти

Подписка на мартикасты - глобальные рассылки от Дежурной Cмены
Включают себя уведомления о:
 - глобальных работах из красного календаря
 - глобальных инцидентах (протоколах: желтый, красный, оранжевый)

На каждый протокол можно подписаться отдельно, однако подписка на Марти включает в себя уведомления обо всех протоколах

#### Регламентные работы

**MAINTENANCE**
Подписка на уведомлениях о глобальных регламентных работах за час до самих работ.

TODO скриншот subsribe_marty.png

### Протоколы

TODO: subscribe_proto1.png, subscribe_proto2.png

 - GREEN - подписки на зеленый протокол по компонентам вардена (аналогично SPI)
 - YELLOW - подписки на желтый протокол по компонентам вардена (аналогично SPI)
 - ORANGE - подписки на мартикасты о оранжевых протоколах
 - RED - подписки на мартикасты о красных протоколах

Только со мной - получать уведомления только о тех протоколах, в которых человек является дежурным или владельцем компоненты (работает только в личке с ботом)

### Инциденты

**SPI**

Подписка на тикеты из очереди SPI.
- /subscribe 
- SPI
- Выбираем нужную вертикаль
- Выбираем нужный сервис или включаем всю вертикаль полностью (если нужно получать уведомления об SPI на родительскую компоненту, то нужно включить "Как сервис" в подменю компоненты.)

Если нажать Включить всё , то по-умолчанию новые сервисы в каталоге будут включаться в подписку. При этом ненужные сервисы (или вертикали) можно выключить.

Если включить настройку "Только со мной" (только для личных сообщений с ботом), то уведомления будут приходить в случае, если вы наблюдатель или исполнитель тикета.

{% note alert %}

И не забудьте включить сами уведомления!!

{% endnote %}

TODO: скриншот subscribe_spi.png

### Инфра

Подписка на события из таймлайна infra.yandex-team.ru
- /subscribe 
- INFRA

Можно включить все неймспейсы кнопкой Включить всё . При этом новые неймспейсы, окружения и сервисы будут автоматически добавляться в подписку. Ненужные фильтры можно выключить.

С включенной полностью INFRA можно настроить фильтры по типу и важности события. Фильтры по типу и важности не наследуются.

- Выбираем неймспейс
- Выбираем сервис
- Выбираем окружения

При включенном хотя бы одном окружении, можно выбрать фильтры событий: minor/major issue/maintenance.

Уведомления о завершении в режиме короткого сообщения не отправляются.


{% note alert %}

И не забудьте включить сами уведомления!!

{% endnote %}

TODO: скриншот subscribe_infra.png

## Марти

Чтобы узнать или призвать Марти (только если есть в чате), напиши команду `/marty`.

## Информация о чате

Информацию о чате можно получить с помощью команды `/pwd`
TODO: pwd.png

## Информация о сервисе

Из бота можно посмотреть всю нужную информацию о компоненте вардена: графички, документации, календари дежурств, чатики.

Для этого нужно вызвать команду `/info`

Все форматы этой команды:

 - `/info name`  - показать информацию о вертикали (или о сервисе, если name не совпадает ни с одним названием вертикалей)
 - `/info vertical/service`  - показать информацию о сервисе
 - `/info`  - показать клавиатуру с выбором сервиса, по которому показать информацию
 - `/info extended`  - показать расширенную информацию про сервис (+ SPPROBLEMS)

TODO: info.png

## Работа с трекером

### Создание SPI 

Можно создать пустой SPI с шаблоном из тикенатора:

 - `/newspi <сервис> <тема>` 
 - `/newtestspi <сервис> <тема>`  - заведет тикет в очереди TEST

**Cервис** - можно указать явно (использовав /  в названии), тогда сервис будет искаться строго по совпадению с именем, например: `web/ -> web` , `spi-tools/yaincbot -> spi-tools/yaincbot` . Если не указать / в названии сервиса, то бот попытается найти сервис по вхождению подстроки в название сервиса и предложит выбрать его самому.

**Tема** - название тикета SPI (не больше 220 символов). Вместо указания темы, можно вызвать команду ответом на другое сообщение, тогда тема будет взята из него.

### Уведомление о создании тикета

**Способ 1** : с помощью языка запросов
Позволяет получать уведомления только о создании тикетов.

{% note info %}

Команду может запускать только администратор чата

{% endnote %}

Есть команда `/startrek`

С помощью этой команды можно подписаться на абсолютно любую очередь. Достаточно будет передать ей фильтр на [языке запросов стартрека](https://doc.yandex-team.ru/tracker/external/user/query-filter.html).

Накликать фильтр и проверить его можно [тут](https://st.yandex-team.ru/issues). Надо нажать вверху справа на "Язык запросов".

Почитать как оно работает можно [на этой странице](https://doc.yandex-team.ru/tracker/external/user/query-filter.html).

Некоторые полезные запросы:
 - `Queue: ОЧЕРЕДЬ ` - простейшие уведомления обо всех тикетах в очереди
 - `Queue: ОЧЕРЕДЬ Followers: me() Resolution: empty() ` - Уведомление о тикетах из очереди, за которыми вы наблюдаете
 - `Queue: ОЧЕРЕДЬ Assignee: me() Resolution: empty()` - Уведомление о тикетах из очереди, исполнителем которых вы являетесь


{% note warning %}

И не забудьте включить фильтры с помощью команды /startrek set [on|enable|enabled] 

{% endnote %}

Некоторые **правила**:
 - На **одну очередь** можно использовать **только один фильтр**. Если попробовать передать другой фильтр на ту же очередь, то бот просто заменит старый.
 - **Нельзя** передавать параметр **Key** в фильтре, иначе бот не сможет получить новых тикетов. Но в общем сам бот не разрешит передать этот параметр.
 - Все остальное работать будет как и полагается, даже параметр "me()" будет заменятся вашим логином.

Как оно работает и что можно делать:

 - `/startrek set {фильтр}` - Добавить новый или изменить существующий фильтр
 - `/startrek set on|enable|enabled` - Включить сами уведомления
 - `/startrek set off|disable|disabled` - Выключить уведомления
 - `/startrek list|status|info` - Посмотреть информацию о существующих фильтрах и посмотреть, включены ли уведомления, а так же номер последнего обработанного тикета
 - `/startrek get {очередь}` - Получить запрос и последний тикет для очереди
 - `/startrek rm|delete|remove {очередь} - Удалить фильтр на очередь

TODO: Способ второй - по триггерам

### Создание тикета

Чтобы ускорить работу в чатах поддержки, бот умеет создавать тикеты по команде в ответ на оригинальное сообщение.

Для разных очередей используются отдельные команды:

 - `/newticketrtc`  - создать задачу в RTCSUPPORT
 - `/newticketqloud`  - создать задачу в QLOUDSUPPORT
 - `/newticketmetrics`  - создать задачу в METRICSSUPPORT
 - `/newticketbsduty`  - создать задачу в BSDUTY
 - `/newticketimgdevops`  - создать задачу в IMGDEVOPS
 - `/newticketpdbdevops`  - создать задачу в PDBDEVOPS
 - `/newticketsaassup`  - создать задачу в SAASSUP
 - `/newticketjupyter`  - создать задачу в JUPYTER
 - `/newticketbalancer`  - создать задачу в BALANCERSUPPORT
 - `/newticketblndr`  - создать задачу в BLNDR
 - `/newticketvideodevops`  - создать задачу в VIDEODEVOPS
 - `/newticketnocreq`  - создать задачу в NOCREQUEST
 - `/newticketerrorbooster`  - создать задачу в ERRORBOOSTER
 - `/newticketlbops`  - создать задачу в LBOPS
 - `/newticketyaincbot`  - создать задачу в YAINCBOT
 - `/newtickettest`  - создать задачу в TEST


## TODO: работа с варденом, ученьки
