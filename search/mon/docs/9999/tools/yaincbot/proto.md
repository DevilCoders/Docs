# Работа в протоколами

В стандартном флоу имеется 4 уровня и 2 вида протоколов:
- Уровни:
    - [Зеленый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/green)
    - [Желтый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/yellow)
    - [Оранжевый](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/orange)
    - [Красный](https://testing.docs.yandex-team.ru/marty/fuckups/protocols/red)

- Виды:
    - [Стандартный протокол](https://testing.docs.yandex-team.ru/marty/fuckups/protocols)
    - [PR протокол](https://testing.docs.yandex-team.ru/marty/fuckups/pr)

## Создание протокола нужного уровня:

 - /green - Зеленый
 - /yellow - Желтый
 - /orange - Оранжевый
 - /red - Красный

{% note info %}

Если бот используется в чате, после использования команд Зеленого, Желтого и Оранженого протокола будет предложен выбор: создать новый чат или продолжить в текущем.

{% endnote %}



## Управление протоколом


### В первую очередь

При создании протокола руками в первую очередь нужно указать следущие две вещи:

 - `/proto component‏ [component]` - привязать компоненту.
 - `/proto summary [summary]` - назвать краткое описание проблемы. Так будет назван **SPI** и, непосредственно, протокол.

### SPI 
Важно понимать, что бот автоматически создает spi только если протокол был создан автоматикой. В противном случае он предложит создать тикет или привязать существующий. Он отправит такое сообщение

TODO: spi_suggest.png

- Если у вас уже есть SPI, бот подсосет оттуда компоненту и описание  
- Если у вас вы создаете новый, то наоборот, бот автоматически укажет компоненту и описание проблемы в SPI

Что вообще бот может в **SPI**:

 - Дампить чат протокола.
 - Заносить графики, по которым завелся протокол.
 - Назначать компоненту
 - Назначать общее название проблемы
 - Назначать исполняющего. Обычно это дежурный сервиса, указанный в вардене.

### Экскалация 
Чтобы эскалировать протокол Зеленый->Желтый->Оранжевый->Красный, можно использовать вышеупомянутые одноименные команды.

{% note warning %}

Протокол автоматически эскалируется из **Зеленого** в **Желтый**, если в протоколе вынужден принять участие **Марти**.

{% endnote %}

### Отписка статусов и периодичные действия

Статус отправляется подписчикам на протоколы компоненты.

Бот периодически просит указать некоторые данные.
В желтом и зеленом протоколах:

- **Статус** - присылается раз в 20 минут.
- **Компонента** - присылается раз в 5 минут на старте протокола (если она не была привязана автоматикой). 

Сообщения можно выключить с помощью команды `/proto mute` . Включить обратно той же командой.

В **красном** и **оранжевом** протоколах:

- **Поиск координатора** - раз в 3 минуты
- **Поиск ответственного** за коммуникацию - раз в 3 минуты
- **Начальный статус** - раз в 3 минуты
- **Периодический статус** - раз в 20 минут
- **Финальный статус** - раз в 10 минут после завершения протокола

{% note info %}

Чтобы руками указать статус используйте команду `/proto status`

{% endnote %}

## Добавление людей в чат протокола

- Можно призвать дежурных любого сервиса, abc или staff через /onduty  и люди будут добавлены в чат
- Можно добавлять людей напрямую через телеграмм
- Можно добавлять людей с помощью команды /proto call login|username [login|username [...]] 

## Zoom 

`/proto zoom [optional_join_url]*` - Позволяет быстро создать или добавить в закреп Zoom для голосовой координации.

Если не передаем url, будет создан Zoom от имени робота, с премом, неограниченный по времени, с включенной записью звонка

## Роли инцидента

- `/proto coordinator|coor {login|username|reply_message}`  - координатор
- `/proto logger {login|username|reply_message}`  - ответственный за коммуникацию (логирующий)
- `/proto consultant {login|username|reply_message}`  - консультант
- `/proto duty|devops|onduty {login|username|reply_message}`, ...  - дежурный девопс
- `/proto pr {login|username|reply_message}`, ...  - PR менеджер
- `/proto manager {login|username|reply_message}`, ...  - менеджер инцидента (помошник координатора)
- `/proto support|smm {login|username|reply_message}`, ...  - поддержка или smm сервиса
- `/proto rtc {login|username|reply_message}`, ...  - участник от инфраструктуры
- `/proto noc {login|username|reply_message}`, ...  - участник от сети.

## Подписка и слияние протоколов
При запуске Красного и Оранжевого протокола, во все уже существующие протоколы отсылается сообщение с предложением связать эти протоколы.  

Команда: `/proto link`

Определим термины, чтобы далее было легче ориентироваться:

**Протокол A** - протокол Красного(или Оранжевого - это не имеет большого значения) уровня, заведенный на глобальную проблему. - глобальная проблема или "проблема А".  
Всё описание окружения этого протокола будет обозначаться буквой A (напр. команда A, проблема A и тд). 

**Протокол X** - протокол Зеленого(или Желтого) уровня, заведеный на проблему некоторого сервиса в Энской губернии.  
Всё описание окружения этого протокола будет обозначаться буквой X (напр. команда сервиса X, проблема X и тд)

Предлагается на выбор три варианта развития событий:

**Подписаться на красный протокол.**

**Какой кейс решает**: Команда X знает, что проблемы их сервиса вызваны глобальной проблемой A. Команда X решает координировать локальное устранение последствий проблем на своем сервисе X в своем чате, но при этом им важно получать статус глобальной проблемы.  
**Что дает**: Все уведомления о проблеме A будут приходить в чат протокола X: статусы и мартикасты. Тикеты инцидентов будут связаны.

**Слиться с красным протоколом.**

**Какой кейс решает**: Команда X знает, что проблема на их сервисе вызвана глобальной проблемой A. Команда решает, что им не нужна координация в отдельном чате и хочет полностью перейти для дальнейшей координации в чат протокола А.  
**Что дает**: Все сотрудники из чата X переносятся в чат A. Протокол X завершается.

**Отмена.**

**Какой кейс решает**: Проблема X и проблема A никак не связаны между собой.  
**Что дает**: все остаются при своих чатах и протоколах.

## Завершение протокола

Завершить протокол можно 2 способами:

- Нажать кнопку "Завершить протокол" в закрепе
- `/proto [end|finish|stop]`

Если не удается завершить протокол, созданный автоматикой по проверке, хотя проверка зеленая, то позовите марти.
