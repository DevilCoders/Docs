# Зачем нужна метрика YDT  

***Основная цель:*** Измерение стабильности для повышения качества сервиса.  

- Downtime измеряем в секундах. Одна секунда downtime-a эквивалентна полной неработоспособности всего Яндекса на 100% пользователей в течение 1 секунды, с точки зрения пользователя.
- Финансовые потери самого Яндекса в метрике не учитываем.
- Инциденты, которые внесли значительный вклад в downtime, разбираем на [Live Site Review(LSR)](../incident_management/lsr/info)


## Как посчитать даунтайм в конкретном инциденте {ydt-calculating}
Инцидентов масштаба полной неработоспособности яндекса бывают нечасто.
Поэтому для подсчета метрики будет использована чистая длительность инцидента с корректирующими коэффициентами.

Корректирующие коэффициенты:
  - Вес вертикали  

    $$impact_{vertical}$$  

  - Процент пользователей вертикали, которые ощутили проявление проблемы (процент материализуется в число по формуле 100% = 1)  

    $$impact_{users}$$  

  - Вес сломанной функциональности  

    $$impact_{functional}$$  


Таким образом

$$ Downtime_{vertical} = t_{duration} * impact_{functional} * impact_{users} $$
$$ Downtime_{yandex} = impact_{vertical} * Downtime_{vertical} $$

Например:  

  1. При релизе компоненты перестал работать веб поиск в sas нагрузку перераспределили в течение минуты. Релиз откатили.  

  - Длительность инцидента:  
  $$ t_{duration} = 60s $$  

  - Вес вертикали веб  
  $$ impact_{vertical} = 0.4 $$  

  - Поиск целиком со всей функциональностью  
  $$ impact_{functional} = 1 $$  

  - 1/3 пользователей чьи запросы попадали в SAS (при условии что перезапросы не уходили в другие локации)  
  $$ impact_{users} = 0.33 $$  

  - Итог:  
  $$ Downtime_{yandex} = 7,92s $$  

  2. Заметили что по графикам пропал web колдунщик на 4 часа у 1/3 пользователей  
  
  - Длительность инцидента:  
  $$ t_{duration} = 4h $$  

  - Вес вертикали веб  
  $$ impact_{vertical} = 0.4 $$  

  - Предположим, что важность данного колдунщика по отношению к WEB-поиску  
  $$ impact_{functional} = 0.001 $$  

  - 1/3 пользователей из условия задачи
  $$ impact_{users} = 0.33 $$  

  - Итог:  
  $$ Downtime_{yandex} = 0,03168s $$  


Если же в инциденте пострадала только часть запросов, стоит рассчитывать итоговый downtime как отношение количества сломанных страниц к среднему трафику в этот промежуток времени.  
Для поиска средний трафик нужно смотреть по графику количества запросов в соответствующий поисковый граф apphost'a.  
Если инцидент задел несколько вертикалей — то даунтайм инцидента = сумма даунтаймов задетых вертикалей.  


## Что делать, если причинй сбоя стали проблемы у горизонтали?
Поскольку наши клиенты пользуются вертикалями, то и даунтайм по своей природе может быть рассчитан только для вертикалей.  
В том случае, если причиной сбоя стали проблемы в горизонтали, то горизонтали также засчитывается даунтайм, рассчитанный в данном инциденте для вертикали.  
Любой сбой вертикали это зона ответственности команды вертикали.

## Сбор статистики
Для сбора этой статистики потребуется разметка инцидентов со стороны дежурных девопсов в тикете SPI.
Нужны:
- Время, когда проявление было видно на пользователях. То есть начало и конец инцидента. Это поля _SRE time_ в тикете SPI.
- Импакт внешний или внутренний. Это поле _SRE impact_
- Пострадавшая вертикаль в терминах _YDT tag product_

Подробнее о разметке можно прочесть [тут](https://wiki.yandex-team.ru/devops/Dive-into-DevOps/incidents-attrs/)
