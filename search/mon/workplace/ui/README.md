# Workplace UI
### Main
#### Requirements 
* `npm -v
6.11.3`
* `node -v 12.12.0`

#### Setup
```
ya make --checkout search/mon/workplace/ui
```
#### Settings
Создать недостающие переменные окружения из `.config/main.js`.

#### Build&Start
```
export OAUTH_TOKEN=<Your token>  # для прокси
cd proxy
./install.sh
./run.sh

export SDMS_OAUTH_TOKEN=<Your Token>  # для вебпака
```
Пока что светлое будующее не наступило, и прокси умеет проксриовать только походы в st\abc. Если вы хотите запроксировать походы к бекенду Workplace, надо собрать бек на вашем компе, запустить его, а в качестве прокси для UI указать порт, на котором запущена бекендная прокся (по умолчанию 8888). Некоторые ручки бека требуют авторизации, в проде используется сессионная кука, а на локалхосте в HTTP-хедеры подставляется OAuth-token, делается это с помощью webpack-proxy. Поэтому при тестировании бека и фронта в связке, надо всегда ходить в нодовский инстанс (:8000), а не бек (:8888).

`npm run build && npm start`

Затем необходимо запустить бекенд (в инструкции уровнем выше сказано, как это сделать).

### Deploy
[zcli](https://wiki.yandex-team.ru/zephyr/#fichi)

`zcli -p workplace -s <production/prestable> --access-key '****************************' --set-as-current`

## Info
Что используется: React 16, TypeScript, Redux, Redux-actions, [lego-on-react](https://github.yandex-team.ru/lego/islands/tree/%40yandex-lego/services%400.1.2/contribs/lego-on-react). Все таблицы &mdash; [react-table](https://react-table.js.org/). Графики &mdash; [recharts](http://recharts.org/)
### Scheme UI
Почти все страницы ходят напрямую в ST.

Плюсы:
- нет лага между изменениями в ST и отображением их в UI
- одной точкой отказа меньше(сервер)
- меньше кода

Минусы:
- большое количество запросов на большом количестве тикетов. К примеру, около 550 почти одновременных запросов, отправленных в ST для подсчёта статистики за июль, на странице /reports при активной галочке "подсчёт Action Items". Большинство этих запросов &mdash; тикеты AI и комментарии из тикетов. Это, вроде, не создаёт тормозов на стороне клиента, но не уверен на счёт ST. Вполне вероятно, что если несколько человек откроют станицу подсчёта статистики за год, то это выльется в DDOS стартрека. Предложенное решение в [заметках](#Заметки)
- не забрать данные куда-либо ещё по API, из-за его отсутствия

Страницы [/di](workplace.z.yandex-team.ru/di), [/reports](workplace.z.yandex-team.ru/reports) запрашивают инциденты за промежуток времени, так как инцидентов >3k и орудовать ими на фронте так себе затея. Также то, что можно было сделать на стороне ST без ущерба производительности страницы, было сделано средствами фильтров ST.

Станица [/yandexdt](workplace.z.yandex-team.ru/yandexdt) загружает все инциденты за год по [фильтру](https://st.yandex-team.ru/filters/filter:33061)([код](https://github.yandex-team.ru/Workplace/WpUI/blob/lego/src/ts/containers/YandexDT.tsx#L125)) и орудует ими на фронте, так как их там менее 300. Это позволяет сделать быстрые фильтры.

### Project Structure
- `src/ts/containers`: здесь лежат "контейнеры", по файлу на вкладку WP. Контейнеры это компоненты, содержащие основную логику страницы и агрегирующие в себе всё необходимое для её функционирования. Все контейнеры наследуются от [Page](https://github.yandex-team.ru/Workplace/WpUI/blob/lego/src/ts/containers/page.tsx#L12)
- `src/ts/components`: здесь лежат "компоненты" &mdash; максимально "тупые" элементы, которые можно переиспользовать. Очень желательно не провязывать их с Redux-хранилищами, но это не всегда получается/выгодно. Если надо изменить вид какого-то элемента, то, скорее всего, это сюда.
- `src/ts/reducers`: [Redux reducers](https://github.com/rajdee/redux-in-russian/blob/master/docs/basics/Reducers.md)
- `src/ts/types`: описания типов.
   - `reducers/`: для [Redux stores](https://github.com/rajdee/redux-in-russian/blob/master/docs/basics/Store.md)
   - `index.d.ts`: описание глобальных типов. Содержит TypeScrips-описание сущностей Стартрека, ABC и ещё нескольких мелких.
   - `presets.ts`: Что-то близкое к конфиг-файлу. Списки продуктов, сервисов, очередей, тегов. Тут захардкожен список [марти](https://github.yandex-team.ru/Workplace/WpUI/blob/lego/src/ts/types/presets.ts#L203).
- `src/ts/utils/utils.ts`: содержит функции, которые могут потребоваться шире, чем в рамках одной вкладки. Парсинг тегов, `init`'ы для запросов и т.д. Специально не тащил сюда ничего с форматом `tsx`.
- `src/ts/index.tsx`: "точка входа" React'a
- `src/ts/store.ts`: создаёт единый Redux Store
- `src/sass`: здесь находятся стили, логически упорядоченные по компонентам
- `public/`: favicon и manifest
- `proxy/`: простенькая прокся на фласке для запросов в ST, ABC
- `node_modules/workplace_ts/`: сгенерированные хорадриком типы. У команды `Yappy` они выкладываются в npm.y-t.ru, но у меня не получилось так запуститься, поэтому они лежат локально(для правки путей внутри если скрипт). Есть подводные камни, в виде ручной правки(были баги в хорадрике). Не стоит трогать без лишней нужды. Возможно, что ребята из хорадрика починили баги и можно попробовать работать с файлами без ручных изменений, но это потенциально ресурсоёмкая задача.


### Development Workflow
Pull-Request'ы поощряются. Работайте, пожалуйста, над одной фичей в одной ветке (для удобства ветку принято называть номером таска, в рамках которого идет работа). PR отправлять из своей ветки с запросом на merge в master. ветку lego - не использовать (deprecated). 

Для уменьшения количесва запросов можно сделать кэши/агррегаторы данных. Не обязательно всю информацию, но то, что нужно для подсчёта статистики: забирать данные AI и комментариев из инцидентов на бэке, отдавая их на фронт по 1/2 запросу. Можно ещё прилепить fallback прямиком в st, но это бэклог задача. Ну и в качестве кэша будет достаточно PgSQL.

Следует ознакомиться(тикет про -mouth) [TOOLSUP-29839](https://st.yandex-team.ru/TOOLSUP-29839)
