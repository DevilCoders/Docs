# Единый артефакт™ Android (Бро)ПП

Библиотека для Android-приложения Яндекс (также известного как ПП), включающая все необходимые компоненты из Аркадии:
 - ~~Офлайн поиск~~ (выпилили за ненадобностью, см. ABRO-63857)
 - Нативная библиотека Я.Клавиатуры
 - Компьютерное зрение
     - OCR + tracking + scanner
     - детектор наличия текста (интегрируется с приложением без JNI оберток, экспортируются непосредственно методы C интерфейса)

## Мотивация

При сборке единого артефакта экономится место за счёт переиспользования общих зависимостей (`util`, `library` и подобное).
Например, объединение библиотек офлайн-поиска и Я.Клавиатуры позволило сократить суммарный размер нативных библиотек
на **6.6Mb**, подробности есть в тикете MT-11535. Кроме того, единый артефакт упрощает путь для добавления новой нативной
библиотеки из Аркадии в ПП: не нужно заморачиваться с особенностями аркадийной сборки под мобильные платформы
и сборочными флагами, не нужно самостоятельно настраивать пайплайн сборки и публикации артефактов, не нужно подключать
новую зависимость к ПП, не нужно разбираться, что такое [crazy loader](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/crazyloader), и т.д.

## Как собирать

Всё необходимое для единого артефакта собирается с помощью `ya package` — либо локально в этой папке (для отладки), либо же
на Sandbox (для использования в продакшене; см. доку [deploy/README.md](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/deploy/README.md)).
Результатом сборки является `.aar`, опубликованный в [artifactory.yandex.net](http://artifactory.yandex.net/artifactory/yandex_mobile_releases/ru/yandex/android/arcadia/nativecode/). Его уже можно привычном способом подключать в gradle.

**Обратите внимание**, сейчас существует два отдельных пакета:
 - [package.json](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/package.json) для ПП
 - [package-bro.json](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/package-bro.json) для Бро

Так сделано для того, чтобы Браузер не зависел от нативного кода Клавиатуры (которая туда не встроена). При обновлении версии крайне рекомендуется обновлять **оба** пакета.

## Как добавить новую библиотеку

Единый артефакт организован по модульному принципу, в связи с чем отдельные его компоненты легко подключать (r7419835) или отключать (r8239913).

Типичная библиотека состоит из двух частей: C++ кода и Java-обёрток, которые собственно и вызывают код на C++ через JNI.
Соответственно:
1. В файле [dll/ya.make](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/dll/ya.make) нужно подключить С++ зависимости (добавив `PEERDIR` + указав в `SRCS` путь ко всем
`.cpp`-файлам, в которых определяются экспортируемые символы; кстати, не забудьте проверить, чтобы все экспортируемые
символы подходили под маску в файле [dll/arcadia.exports](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/all/arcadia.exports)).
2. В файле [ya.make](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/ya.make) в этой папке нужно поставить `PEERDIR`
на Java-обёртки. В простых случаях лучше всего воспользоваться SWIG для генерации обёрток (по примеру библиотеки компьютерного зрения).

В папке [meta](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/meta) лежат манифест, ресурсы и правила для ProGuard. Всё, что в этой папке, напрямую попадает в финальный артефакт. Возможно, там что-то тоже потребуется дополнить.

## Особенности сборки пакета

В этом разделе постараемся разобрать все необычные детали [package.json](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/package.json), сверху вниз.

* `"name": "ru.yandex.android.arcadia:nativecode"`

  Имя пакета представляет из себя `groupId:artifactId` для будущей gradle-зависимости. Этот факт используется машинерией из папки [deploy](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/deploy/README.md) чтобы понять, куда именно заливать собранный AAR.
* `"version": "1.0.{revision}"`

  В имени версии используется ревизия Аркадии, чтобы была полная воспроизводимость. Для возможных различных вариаций пакета (например, [package-bro.json](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/package-bro.json) для Бро) в конце к версии можно дописывать какие-нибудь суффиксы. Эта же версия будет использована машинерией из папки [deploy](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/deploy/README.md) в качестве версии gradle-зависимости.
* `"default-format": "aar"`

  Говорим `ya package` собирать содержимое в файлик `.aar`, который на самом деле просто является zip-архивом. Если так не сказать, то по умолчанию собираться всё будет в `.tar.gz`.
* `"target-platforms": ["DEFAULT-ANDROID-I686", "DEFAULT-ANDROID-ARMV7A", "DEFAULT-ANDROID-X86_64", "DEFAULT-ANDROID-ARMV8A"]`

  Собираем нативные библиотеки сразу под все четыре андроидные архитектуры. По факту устройств на основе `x86`/`x86_64` очень мало (порядка 1%), да и 32-битный ARM (`armv7a`) становится всё менее популярным. Так что в будущем количество поддерживаемых архитектур можно будет сократить, но пока что собираемся под все четыре.
* `{ "name": "STRIP", "value": "yes"}`

  После сборки библиотек вырезаем из них дебажные символы с помощью утилиты `strip`.
* `{ "name": "CFLAGS", "value": "-Os" }`

  Выставляем компилятору флаг, который говорит использовать нечто среднее между оптимизацией скорости работы (`-O3`) и оптимизацией размера бинарника (`-Oz`, он же `minsizerel`). По умолчанию в Аркадии всегда используется оптимизация `-O3`, что абсолютно разумно для серверного кода. Однако мы готовы чуть-чуть пожертвовать производительностью (3-5%), чтобы заметно выиграть в размере. `-Oz` мы тоже пробовали, однако на нативных вызовах клавиатуры он давал слишком серьёзные просадки по производительности (15-30%), и от него решили отказаться.
* `{ "name": "SEARCHAPP_PACKAGE", "value": "yes" }`

  Выставляем переменную сборки `SEARCHAPP_PACKAGE`, которая используется в двух целях. Во-первых, [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/dll/ya.make?rev=r8239913#L48) выставляем флаги линковщика `-Wl,--gc-sections -Wl,--icf=safe -Wl,--pack-dyn-relocs=android`. Во-вторых, [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/ya.make?rev=r8239913#L17) подключаем код Клавиатуры (в противоположность переменной `BRO_PACKAGE`, так как в Бро код Клавиатуры не нужен).

  Хочется поподробнее остановиться на флагах линковщика. Для начала, нужно понимать, что выставление их под переменной сборки это костыль, связанный с тем, что флаги содержат в себе пробелы, и если их явно указать прямо в `package.json`, то файлы с результатом сборки будут содержать пробелы в именах, и из-за багов `ya package` их нельзя будет сложить в итоговый артефакт `¯\_(ツ)_/¯`.

  Теперь к содержимому флагов. Первые два (`--gc-sections`, `--icf=safe`) довольно бесхитростны и просто позволяют немного сократить размер. Третий же (`--pack-dyn-relocs=android`) самый важный и позволяет сэкономить ~**3Mb**. Если коротко, то начиная с Android 6.0 поддержан новый, сжатый формат хранения таблицы динамических релокаций. Однако в ПП мы пока что поддерживаем устройства с Android 5+, в результате чего вынуждены использовать [crazy loader](https://a.yandex-team.ru/arc/trunk/arcadia/search/mobile/android/crazyloader), чтобы и на пятёрках уметь загружать библиотеки, слинкованные с таким флагом. Гораздо больше технических подробностей по ссылке из предыдущего предложения. Кстати, есть ещё более продвинутый формат хранения релокаций, `--pack-dyn-relocs=relr`; он занимает ещё меньше места, но поддерживается уже только начиная с Android 9.0.


#### TODO
 - публиковать нестрипнутые версии библиотек
