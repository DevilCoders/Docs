# SDCH encoder

Сервис, который делает sdch сжатие на веб поиске.

## Линки
- Дащборд в няне: https://nanny.yandex-team.ru/ui/#/services/dashboards/catalog/sdch
- Панелька в голован: https://yasm.yandex-team.ru/template/panel/sdch_panel/
- Сборочная таска: https://a.yandex-team.ru/arc/trunk/arcadia/sandbox/projects/websearch/sdch/BuildSdchEncoder/__init__.py
- ABC: https://abc.yandex-team.ru/services/apphostcompressors/

## Релизный процесс бинаря
Веток нет, CI или rm нет.

Запускается сборка в sandbox, дальше релизится сандбокс таска.
В Няне через Tickets Integrations релиз прорастает в сервисы.


## Релизный процесс словарей

За словари отвечают коллеги из скорости серпа. Для рантайма контент словарей не так важен, но полезно понимать как устроен флоу релиза.

Все начинает с [крона в hitman](https://hitman.yandex-team.ru/projects/sdch/?jobCreationTimeQuery=MONTH&jobPage=1&pageSize=20). Он стартует каждое воскресенье в 3 ночи, чтобы к утру иметь готовый релиз.

С Марти есть говоренность, что в полдень по воскресеньям они прокатывают этот релиз. [Событие в календаре марти](https://calendar.yandex-team.ru/event/52116743?applyToFuture=0&event_date=2022-02-20T09%3A00%3A00&layerId=37852)

### Почему в релизе три части

Так как sdch encoder жмет запрос по частям, то во время релиза не должно случаться ситуация, что мы начали жать старым словарем, а запрос, при попытке продолжить жать мы попали на инстанс, который рестартовал и у него уже нет старого словаря. Это приводит к битому серпу.

В итоге схем релиза выглядит так. У нас в норме есть два активных словаря. Новый и старый. При релизе новый становится старым.

1. Перестаем использовать старый словарь.
2. Обновляем ресурс со словарем, но используем только старый словарь из бандла. То есть новый словарь в старом бандле. Во время этой фазы все сервисы используют один и тот же словарь. Поэтому проблемы не возникает.
3. Начинаем использовать новый словарь. Так как все словари теперь доступны всем инстансам, мы можем сжимать вторую часть тем же словарем, что и новым.

### Раздача словарей
Для раздачи словарей используется [аппхостовый граф](https://a.yandex-team.ru/arc/trunk/arcadia/apphost/conf/verticals/WEB/sdch_dictionary.json).
Словари раздаются с тех же инстансов, что и делают сжатие.


## Завод трафика
Трафик идет параделельно с трафиком веб посика терм->knoss_search->apphost web.


Устарелая вики, но местами полезно: https://wiki.yandex-team.ru/velocity/serp/sdch/
