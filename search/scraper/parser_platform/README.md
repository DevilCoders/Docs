# Python Parser Platform
* [Howto](ppp_howto.md)
* [–ü—Ä–∏–º–µ—Ä –ø–∞—Ä—Å–µ—Ä–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å –ú–µ—Ç—Ä–∏–∫—Å–æ–º](example.md)

## Intro

–ü–∞—Ä—Å–µ—Ä –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É (HTML, JSON, XML etc) –≤ –æ–±—ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ.
–ß–∞—Å—Ç–æ —Ä–µ—á—å –∏–¥–µ—Ç –æ –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–µ. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–∞—Ä—Å–µ—Ä–æ–≤ Python –ø–æ–∑–≤–æ–ª–∏—Ç –∂–µ–ª–∞—é—â–∏–º
—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø–∏—Å–∞—Ç—å, —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å –∏ –ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ
–ø–∞—Ä—Å–µ—Ä—ã –¥–ª—è [Scraper](https://wiki.yandex-team.ru/qe/scraper/) –Ω–∞ Python üêç.

## Requirements

–ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ (–∞—Ä–∫–∞–¥–∏–π–Ω–æ–º) Python 3 –∏ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é `ya make`.

## –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞—Ä—Å–µ—Ä–∞

–ü–∞—Ä—Å–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω –∫–∞–∫ –∫–ª–∞—Å—Å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –º–µ—Ç–æ–¥ `parse`, –∫–æ—Ç–æ—Ä—ã–π
–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ –æ–±—ä–µ–∫—Ç–∞ (–≤–µ—Ä–æ—è—Ç–Ω–æ, –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö
—Å–ª–æ–≤–∞—Ä–µ–π –∏ —Å–ø–∏—Å–∫–æ–≤ Python). –ú–µ—Ç–æ–¥ `parse` –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ (–¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–æ–∫)
—Å –æ–¥–∏–Ω –∏ —Ç–µ–º –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º –ø–∞—Ä—Å–µ—Ä–∞.
–ï—Å–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –º–µ—Ç–æ–¥ `__init__`, –µ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

–í `base_parsers.py` –ª–µ–∂–∞—Ç –¥–≤–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–∞:

* –í –æ–±—â–µ–º —Å–ª—É—á–∞–µ –º–æ–∂–Ω–æ –æ—Ç–Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç –∫–ª–∞—Å—Å–∞ `SerpParser`, –≤ –Ω–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
* –ï—Å–ª–∏ –Ω–∞–¥–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `JSON`, –¥–æ—Å—Ç—É–ø–µ–Ω –∫–ª–∞—Å—Å `JSONSerpParser`,
* –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤

–ü–∞—Ä—Å–µ—Ä—ã –∫–ª–∞–¥—ë–º –≤ `parser_platform/parsers`. –í–Ω—É—Ç—Ä–∏ —Ü–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º.
–°–µ–π—á–∞—Å –º–Ω–æ–≥–∏–µ –ø–∞—Ä—Å–µ—Ä—ã –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ –∫–æ—Ä–Ω–µ, –Ω–æ –∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
–û–±—Ä–∞–∑–µ—Ü –¥–ª—è –ø–æ–¥—Ä–∞–∂–∞–Ω–∏—è - –∫–∞—Ç–∞–ª–æ–≥ `parser_platform/parsers/yandex_baobab`.

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ—Ç—Ä–∏–∫—Å–æ–º

–ï—Å–ª–∏ –ø–∞—Ä—Å–µ—Ä –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–∫–∞—á–µ–∫ –≤ [–ú–µ—Ç—Ä–∏–∫—Å–µ](https://metrics.yandex-team.ru)
–æ–±—ä–µ–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å [–º–µ—Ç—Ä–∏–∫—Å–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É](https://wiki.yandex-team.ru/metrics/api/serp/#primeryjsonserpov) –±–µ–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ query.
–ù–∞–ø—Ä–∏–º–µ—Ä –∏–∑ –ø–∞—Ä—Å–µ—Ä–∞ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–π –æ–±—ä–µ–∫—Ç:
```(json)
{
  "components" : [ {
    "componentInfo" : {
      "type" : 1  #1 –∑–Ω–∞—á–∏—Ç —á—Ç–æ —ç—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ (2 –∫–æ–ª–¥—É–Ω—â–∏–∫)
    },
    "componentUrl" : {
      "pageUrl" : "http://ya.ru" # —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å url
    },
    "type" : "COMPONENT" # —ç—Ç–æ –Ω–∞–¥–æ —á—Ç–æ –±—ã –º–µ—Ç—Ä–∏–∫—Å –Ω–µ –∑–∞–ø—É—Ç–∞–ª—Å—è
  }],
  "text.customTextFiled": "custom value"
}
```

–ß—Ç–æ–±—ã –ú–µ—Ç—Ä–∏–∫—Å –ø–æ–Ω—è–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –Ω–∞–¥–æ —á—Ç–æ –±—ã –æ–Ω–∏ –Ω–∞–∑—ã–≤–∞–ª–∏—Å—å –≤ —Å—Ç–∏–ª–µ `<type>.<name>` - –≥–¥–µ `type` –ø–æ–Ω—è—Ç–µ–Ω
–º–µ—Ç—Ä–∏–∫—Å—É. –ù–∞–ø—Ä–∏–º–µ—Ä, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å `"text.myNewTextFiled": "textvalue"` –∏–ª–∏ `"json.jsonField1": {"k": "v"}`.

* [Wiki –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫—Å–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞](https://wiki.yandex-team.ru/metrics/API/serp/#format).
* [Wiki –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–æ–≤](https://wiki.yandex-team.ru/metrics/API/serp/#dostupnyetipyrequirementov).

–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω—É–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ –ø–æ –∫–ª—é—á—É `"long.docsFound"`
(–∞ –Ω–µ –ø–æ `"headers" > "foundDocumentsCount"`, –∫–∞–∫ –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ –º–µ—Ç—Ä–∏–∫—Å–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É).

## Mapper-–æ–±–µ—Ä—Ç–∫–∞

–ü–∞—Ä—Å–∏–Ω–≥ —è–≤–ª—è–µ—Ç—Å—è map-–æ–ø–µ—Ä–∞—Ü–∏–µ–π –Ω–∞ YT, —Ç–∞–º –∂–µ –ª–µ–∂–∞—Ç —Ç–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ä–ø–∞–º–∏.
–£ —Ç–∞–±–ª–∏—Ü –ø–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –ø—Ä–∏—á–∏–Ω–∞–º –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.
–û–±–µ—Ä—Ç–∫–∞ —á–∏—Ç–∞–µ—Ç –≤—Ö–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –≤—ã–Ω–∏–º–∞–µ—Ç –∏–∑ –Ω–µ–µ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É, –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
–∏ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –•–æ—á–µ—Ç—Å—è –Ω–∞–¥–µ—è—Ç—å—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è,
–∫–∞–∫ –æ–Ω–∏ —É—Å—Ç—Ä–æ–µ–Ω—ã.

## –°–±–æ—Ä–∫–∞

–ü–∞—Ä—Å–µ—Ä—ã —Å –æ–±–µ—Ä—Ç–∫–æ–π —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫ (–æ–Ω –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `metrics`).
–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≤ [arcadia/search/metrics/monitoring](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics/monitoring) –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```bash
ya make
```

–ß—Ç–æ–±—ã –ø–∞—Ä—Å–µ—Ä –ø–æ–ø–∞–ª –≤ —Å–±–æ—Ä–∫—É, –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤–Ω—É—Ç—Ä–∏ `PY_SRCS` –≤ `parsers/ya.make`.

–£ —É—Ç–∏–ª–∏—Ç—ã `metrics` –µ—Å—Ç—å [–º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics/monitoring/readme.md), –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `parse`.

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏ –Ω—É–∂–Ω–æ [–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics/monitoring#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-–æ–∫—Ä—É–∂–µ–Ω–∏—è).

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

–õ–æ–∫–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –≤—ã–¥–∞—á–∏ –±–µ–∑ –æ–±–µ—Ä—Ç–æ–∫ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é –æ–ø—Ü–∏–∏ `--parse-only`:
–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–ø—Ü–∏–∏ `--engine ClassMyParser` –Ω—É–∂–Ω–æ –≤ —Ñ–∞–π–ª–µ
`arcadia/search/scraper/parser_platform/parsers/preparer_mapping.py` –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –ø–∞—Ä—Å–µ—Ä –∏ –≤ `ENGINES`
–ø—Ä–æ–ø–∏—Å–∞—Ç—å filename.ClassMyParser

```bash
cat content.html | ./metrics parse local --engine YandexBaobabHTMLParser --parse-only
```

## –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

–í–æ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —É–¥–æ–±–Ω–æ –≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–Ω–µ—Ç, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—è –µ–≥–æ —á–µ—Ä–µ–∑ `jq`.

```bash
cat content.html | ./metrics parse local --engine YandexBaobabHTMLParser --compact
```

–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –ø–æ–ª—è–º–∏:

```
  no  type                       title                                                         pageUrl                                                       viewUrl
----  -------------------------  ------------------------------------------------------------  ------------------------------------------------------------  ----------------------------------------
   0  W: WIZARD_KNOWLEDGE_GRAPH  –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
   1  W: WIZARD_SUGGEST_FACT     –§–æ—Ä–º—É–ª–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è: –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è ... -         https://220v.guru/fizicheskie-ponyatiya-i-                    220v.guru ‚Ä∫ ... ‚Ä∫ –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ
                                 220v.guru                                                     pribory/napryazhenie/formula-rascheta-napryazheniya-cherez-
                                                                                               silu-toka-i-soprotivlenie.html
   2  W: WIZARD_IMAGE                                                                          https://google.ru/search?source=univ&tbm=isch&q=%D1%84%D0%BE
                                                                                               %D1%80%D0%BC%D1%83%D0%BB%D0%B0+%D0%BD%D0%B0%D0%BF%D1%80%D1%8
                                                                                               F%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5&hl=ru&fir=svsMy_cWVvYe0M%252
                                                                                               CJnz52ZaOr5bnvM%252C_%253BQbGzOmjBv3IkOM%252CUotM6XPA64yHLM%
                                                                                               252C_%253BzUZPsj7F7oBTsM%252CaSN9tnELvAHYnM%252C_%253BIdWEcN
                                                                                               XEYocT5M%252CSfrvtIYvWmt7CM%252C_%253Bsjr7qH9zHEcrpM%252CKb_
                                                                                               4FKt1E9BoDM%252C_%253BZVsOji0QM690aM%252C3TdfET7-tvoLIM%252C
                                                                                               _%253B5MWtac_UvsQ5vM%252Cd5FVZcW4OsDcjM%252C_%253B1UTZQMrwDk
                                                                                               TJsM%252CPeWhOBuYBmOAJM%252C_
   3  SEARCH_RESULT              –ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ, —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ, —Ç–æ–∫ –∏ –º–æ—â–Ω–æ—Å—Ç—å.                    http://sebestroj.ru/ehlektrosnabzhenie/naprjazhenie-          sebestroj.ru ‚Ä∫ ehlektrosnabzhenie
                                                                                               soprotivlenie-tok-moshhnost.html
```

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –æ–±–µ—Ä—Ç–∫–æ–π

–õ–æ–∫–∞–ª—å–Ω–æ –æ—Ç–ø–∞—Ä—Å–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Ç–∞–±–ª–∏—Ü—É:

```bash
yt read '//home/metrics/metrics_executable/examples/yandex_baobab_html_input' --format json --proxy hahn.yt.yandex.net | ./metrics parse local --engine YandexBaobabHTMLParser
```

## –ó–∞–ø—É—Å–∫ –Ω–∞ YT

–û—Ç–ø–∞—Ä—Å–∏—Ç—å –Ω–∞ YT –Ω–µ–∫–æ—Ç–æ—Ä—É—é —Ç–∞–±–ª–∏—Ü—É:

```bash
./metrics parse yt --engine YandexBaobabHTMLParser \
--scr //home/metrics/metrics_executable/examples/yandex_baobab_html_input \
--dst //tmp/parsed_table
```

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ –Ω–µ –ø–æ–¥ Linux –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã `yt parse` —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–¥–µ–ª–∞—Ç—å [–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics/monitoring#—Ä–∞–±–æ—Ç–∞-–ø–æ–¥-mac).

## –ü—Ä–µ–ø–∞—Ä–µ—Ä—ã

–ö–∞–∫ –ø—Ä–∞–≤–∏–ª–æ –ø–∞—Ä—Å–µ—Ä –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –≤–º–µ—Å—Ç–µ —Å —Ä–µ—Ü–µ–ø—Ç–æ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã.
–¢–∞–∫–æ–π —Ä–µ—Ü–µ–ø—Ç –º—ã –Ω–∞–∑—ã–≤–∞–µ–º _–ø—Ä–µ–ø–∞—Ä–µ—Ä–æ–º_. –ü—Ä–µ–ø–∞—Ä–µ—Ä —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–ª–∞—Å—Å–æ–º —Å –º–µ—Ç–æ–¥–æ–º `prepare`, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª–∞—Å—Å –ø–∞—Ä—Å–µ—Ä–∞.
–í `SerpParser` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∞–∫–æ–π –º–µ—Ç–æ–¥, –æ–±—Ä–∞—â–∞—é—â–∏–π—Å—è –∫ –ø–æ–ª—è–º `URL_TEMPLATE`/`TOUCH_URL_TEMPLATE` –∏
–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–º –º–µ—Ç–æ–¥–∞–º `_prepare_url`, `_prepare_headers`, `_prepare_cgi`, `_prepare_cookies`, `_prepare_userdata`,
–∑–∞–¥–∞—é—â–∏–º URL, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ. –í –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–µ—Ä–∞—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Ö.
–í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –º–æ–∂–Ω–æ –∏–∑—É—á–∏—Ç—å `YandexBaobabParser`.

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–æ–ª—É—á–∞—é—â–∏–µ—Å—è –¥–ª—è –∫–æ—Ä–∑–∏–Ω—ã 307271 –∑–∞–ø—Ä–æ—Å—ã –º–æ–∂–Ω–æ —Ç–∞–∫:

```bash
./metrics qg local 307271 | ./metrics prepare local yandex.ru --engine YandexBaobabHTMLParser
```

–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ–ø–∞—Ä–µ—Ä–∞–º–∏ –º–æ–∂–Ω–æ –∏–∑—É—á–∏—Ç—å –≤ [–æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ `metrics`](https://a.yandex-team.ru/arc/trunk/arcadia/search/metrics/monitoring#–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è-–∑–∞–ø—Ä–æ—Å–æ–≤-–¥–ª—è-–ø—Ä–æ–∫–∞—á–∫–∏-—á–µ—Ä–µ–∑-scraper-over-yt-soy) –∏ –≤—Å—Ç—Ä–æ–µ–Ω–æ–π —Å–ø—Ä–∞–≤–∫–µ.

–°–≤–æ–π –ø—Ä–µ–ø–∞—Ä–µ—Ä –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `parsers/preparer_mapping.py`. –ö–ª—é—á –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ `MAPPING` -- —ç—Ç–æ —Ç–æ, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
–≤ –∞—Ä–≥—É–º–µ–Ω—Ç `--engine`.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ API Scraper

–ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö [—á–µ—Ä–µ–∑ API](https://wiki.yandex-team.ru/qe/scraper/api/#acinxronnoezadanienabatchevujuskachkuzaprosov) —Å–∫–∞—á–µ–∫ –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–µ–ø–∞—Ä–µ—Ä–∞.

* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–∞—Ç—á–∞ (`per-set-parameters`) –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ `additional_parameters.get("ssr", {}).get("per-set-parameters", {})`.
* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (`per-query-parameters`) -- –≤ `basket_query.get("per-query-parameters")`.

## –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞

–ü—Ä–∏–º–µ—Ä [–∫—Ä–æ–Ω–∞](https://metrics.yandex-team.ru/crons/102617/runs). –í Monitoring Over Yt Cron v19 –ø–æ—è–≤–∏–ª–æ—Å—å –ø–æ–ª–µ
`Parse parameters`, —Ç—É–¥–∞ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ –∫–æ–Ω—Ñ–∏–≥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ json.

–í –∫–æ–¥–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤–æ—Ç [—Ç–∞–∫](https://a.yandex-team.ru/arc/trunk/arcadia/search/scraper/parser_platform/parsers/yandex_baobab_parser.py?rev=6692946#L44).
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –º–µ—Ç–æ–¥–µ ```parse``` –∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä [additional_parameters](https://a.yandex-team.ru/arc/trunk/arcadia/search/scraper/parser_platform/wrapper/wrapper_lib.py?rev=r9131747#L56).

–í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
```
./metrics parse local --parse-only --module yandex_baobab_html_parser --classname YandexBaobabHTMLParser --parser-config config.json
```
–ì–¥–µ config.json —ç—Ç–æ:
```json
{"dump_node":true}
```

## –¢–µ—Å—Ç—ã

–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ (–∏–∑ `search/scraper/parser_platform`):

```
ya make -tA
```

–ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```
ya make -tA -F yandex_baobab_html_with_custom_user_agent_parser_test.py
```

–ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. –≤ [tests/README.md](tests/README.md).

## Search Engine

–ß—Ç–æ–±—ã –ø–∞—Ä—Å–µ—Ä –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ö –∏ –∫—É–±–∏–∫–∞—Ö, –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é search engine:

```JSON
{
  "id": "yandex-baobab-html",
  "parser-config": {
    "type": "arcadia-python-parser-config",
    "classname": "YandexBaobabHTMLParser",
    "module": "yandex_baobab_html_parser",
    "preparer": "YandexBaobabHTMLParser",
    "output-format": "METRICS"
  }
}
```

–î—Ä—É–≥–∏–µ –ø—Ä–∏–º–µ—Ä—ã –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø–∞–ø–∫–µ [search_engine_config](search_engine_config), —Å–≤–æ–π –Ω—É–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å
—Ç—É–¥–∞ –∂–µ, –∏ Scraper –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∫–æ–Ω—Ñ–∏–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –≤ CI. –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ
search engine'—ã –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ —Ä—É—á–∫–µ
[scraper.yandex-team.ru/api/scraper/engines/all](https://scraper.yandex-team.ru/api/scraper/engines/all)

–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–≤—à–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π  [./try_prepare_custom](../cli_tools/README.md#fetch-query-group)

–¢–∞–∫–∂–µ –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–º –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –≤ `search_engine_config`.
–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ `parser_platform`) —Å–∫—Ä–∏–ø—Ç
```
./validate-search-engine-configs.py
```
–û–Ω –ø—Ä–æ–π–¥–µ—Ç –ø–æ –≤—Å–µ–º –∫–æ–Ω—Ñ–∏–≥–∞–º –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç, —á—Ç–æ –≤ –Ω–∏—Ö –≤–∞–ª–∏–¥–Ω—ã–µ –∏–º–µ–Ω–∞ –º–æ–¥—É–ª–µ–π –ø–∞—Ä—Å–µ—Ä–æ–≤,
–∏ –æ–Ω–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –µ—Å–ª–∏ –≤ –≤–∞—à–µ–º –ø–∞—Ä—Å–µ—Ä–µ –µ—Å—Ç—å –∞—Ä–∫–∞–¥–∏–π–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã.
–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏—Ö –º–æ–∂–Ω–æ –∑–∞–≥–Ω–∞—Ç—å –ø–æ–¥ try-except, –∫–∞–∫ –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ yandex_baobab_html_parser.py

## CI/CD
–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–∞—Ä—Å–µ—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –∞–≤—Ç–æ—Å–±–æ—Ä–∫–µ, —Ç–∞–∫ —á—Ç–æ –≤ —Ü–µ–ª–æ–º –∑–∞ –Ω–∏–º–∏ –º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –≤ [CI](https://a.yandex-team.ru/projects/metric/ci).

–°–ª–µ–¥–∏—Ç—å –∑–∞ –≤—ã–∫–ª–∞–¥–∫–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–æ–∂–Ω–æ –≤ job'–µ [Release metrics binary to production](https://a.yandex-team.ru/projects/metric/ci/actions/launches?dir=ci%2Fregistry%2Fprojects%2Ftestenv%2Fmetrics&id=metrics-binary-release-prod).

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ Sandbox –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å [—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã](https://metrics.yandex-team.ru/xp/new) —Å –Ω–æ–≤—ã–º –ø–∞—Ä—Å–µ—Ä–æ–º.

–ï—Å–ª–∏ –≤—ã–∫–∞—Ç–∫–∞ –≤ CI —É–ø–∞–ª–∞ –∏–∑-–∑–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä downtime yt –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ hahn –∏–ª–∏ arnold)
–º–æ–∂–Ω–æ "–¥–æ–∫–∞—Ç–∏—Ç—å" –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–∞–∂–∞–≤ –Ω–∞ —É–ø–∞–≤—à—É—é –∑–∞–¥–∞—á—É, –∑–∞—Ç–µ–º "Open flow", –∑–∞—Ç–µ–º —Ä–µ—Å—Ç–∞—Ä—Ç –Ω—É–∂–Ω–æ–≥–æ –∫—É–±–∏–∫–∞.

## Misc
TSV-—Ñ–∞–π–ª—ã tld-–¥–æ–º–µ–Ω–∞–º–∏ –≤ –ø–∞–ø–∫–µ parsers/data —Å—Ç–æ–∏—Ç –ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –¥–æ–º–µ–Ω–æ–≤ –≤ PRS.
—Å–º. https://a.yandex-team.ru/arcadia/history/search/scraper/parser_platform/parsers/data/README.md

### See also

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Metrics –ø—Ä–æ –±–∞–æ–±–∞–±–Ω—ã–π –ø–∞—Ä—Å–µ—Ä Yandex: https://wiki.yandex-team.ru/metrics/baobab/
