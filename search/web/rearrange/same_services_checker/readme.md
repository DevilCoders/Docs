# Факторы и фильтры по похожим сервисам
Можно вычислить факторы по количеству хостов похожих сервисов в топе выдачи. Фильтрация производится блендерной командой по выставленному правилом серчпропу.

Чтобы добавить фильтрацию или факторы нужно:

1) Собрать список хостов похожих сервисов, собрать список регулярных выражений для урлов (возможно что-то одно).

2) Добавить созданные файлы в [конфиг](https://a.yandex-team.ru/arc/trunk/arcadia/search/web/rearrs_upper/rearrange/same_services_checker/config.json) или, если нужны быстрые данные, в [конфиг](https://a.yandex-team.ru/arc/trunk/arcadia/search/web/rearrs_upper/rearrange.fast/same_services_checker/config.json) (только для экспериментов).
```
<название нового фильтра> : {
  "Hosts": <путь до файла со списком хостов>,
  "UrlRegexps": <путь до файла с регулярными выражениями>
}
```

3) Добавить новый фильтр в [конфиг](https://a.yandex-team.ru/arc/trunk/arcadia/search/web/rearrs_upper/conf/conf.json?rev=7452307#L5696) правила переранжирования.
```
<название нового фильтра> : {
  "Enabled": <включить/выключить работу нового фильтра. Влияет на выставление серчпропа.>,
  "SetSearchProp": <текст серчпропа, который будет выставлен, если выдача содержит заданное число похожих сервисов>,
  "TopSize" : <сколько документов из топа выдачи рассматривать для выставления серчпропа>,
  "MinMatches" : <сколько хостов/регулярок из топа должно сматчиться, чтобы выставился серчпроп>,
  "CheckSubdomain" : <проверять ли матчинг без самого левого поддомена; используется и при вычислении фичей, и при расчетах для выставления серчпропа>,
  "CalcFeatures": <вычислять/не вычислять фичи>,
  "FeaturesTopSize" : <массив значений, в каком топе выдачи считать количество вхождений хостов похожих сервисов>
  "AllowDuplicates" : <проверять, что совпало несколько разных хостов; полезен только в случае, когда MinMatches больше, чем единица>
}
```
Дефолтные значения можно посмотреть [тут](https://a.yandex-team.ru/arc/trunk/arcadia/search/web/rearrange/same_services_checker/scheme.sc).

4) Чтобы сделать фильтрацию, нужно написать блендерную команду, которая будет банить интент по выставленному серчпропу, [пример](https://cs.yandex-team.ru/#!SameServicesChecker%5C.,%5Esearch%2Fweb%2Frearrs_upper%2Fconf,,arcadia,,5000). Вычисленные факторы будут называться `cst.same_services_checker_<название нового фильтра>.`

5) (опционально) Если необходимо, чтобы пропсы проросли в логи, а не только в блендерную команду, то надо добавить логирование тут https://a.yandex-team.ru/arcadia/scarab/api/proto/report/search_props/UPPER/misc.proto?blame=true&rev=r9482821#L1223 . Дока по пропсам - https://wiki.yandex-team.ru/scarab/api/proto/reqans_containers/
