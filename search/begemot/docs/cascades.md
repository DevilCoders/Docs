# Каскады


## Использование каскадов {#ispolzovaniekaskadov}

[Remorph](rules-remorph.md)- и [TokenLogic](rules-tokenlogic.md)- правила могут использовать результаты работы других правил точно также, как используют результаты работы газетира (каскадные правила). Интеграция правил происходит через специальные газетирные статьи, которые вместо обычного ключа содержат ссылки на правила.

При применении каскадных правил сначала отрабатывают все дочерние правила. Вместо входных символов, захваченных дочерним правилом, вставляется один составной символ, помеченный каскадной газетирной статьей. Результирующие входные символы затем подаются на вход родительскому правилу.

Входной символ, созданный каскадным правилом, наследует все газетирные статьи из главного слова сопоставленной последовательности. Согласование по газетиру и гео-согласование для каскадного символа работают точно также, как если бы оно выполнялось для главного слова (главное слово определяется дополнительными полями каскадной статьи, см. ниже).

При исполнении каскадных правил возможно два режима работы. В первом режиме все найденные варианты разборов дочерними правилами добавляются в итоговую коллекцию результатов (дерево входных символов), и родительское правило исполняется на всех возможных их комбинациях. Во втором режиме происходит снятие омонимии. Из результатов дочерних правил оставляются только не конфликтующие результаты с максимальным покрытием и приоритетом. Родительское правило исполняется только на выбранном лучшем варианте разбора.

Выбор режима работы каскада задается в опциях описания [фактов](facts.md) или программным путем через свойства матчера.


## Задание каскада через газетирную статью {#zadaniekaskadacherezgazetirnujustatju}

Каскад создается автоматически, если какое-либо правило ссылается на газетирную статью с типом ключа `CUSTOM`, и специальным префиксом ключа. Ключ при этом должен задавать путь к файлу с правилами.

Путь к правилам из газетирной статьи вычисляется относительно положения файла газетира. Если путь к файлу газетира неизвестен, то путь вычисляется относительно положения файла с родительскими правилами. Для избежания неоднозначности определения местоположения дочерних правил необходимо откомпилировать правила с помощью компилятора и указать путь к газетиру, относительно которого и будут вычислены пути к дочерним правилам.

Газетирная статья может содержать специальные поля, которые влияют на работу каскада. Эти поля описаны в газетирных типах, описанных ниже для каждого типа каскада. Для подключения описания каскадных газетирных типов необходимо импортировать в исходный газетирный словарь файл [dict/remorph/cascade/cascade.proto](https://arcadia.yandex.ru/wsvn/arc/trunk/arcadia/dict/remorph/cascade/cascade.proto).

Поддерживаемые префиксы ключей:

#|
|| **Префикс газетирного ключа** | **Описание** ||

|| `remorph:` | Создается каскад для правил [Remorph](rules-remorph.md). Ключ должен ссылаться на исходный файл с текстом правил или на откомпилированный бинарный файл правил. ||

|| `rem-char:` | Создается каскад для правил [Char](rules-char.md). Ключ должен ссылаться на исходный файл с текстом правил или на откомпилированный бинарный файл правил. ||

|| `token:` | Создается каскад для [TokenLogic](rules-tokenlogic.md)-правил. Ключ должен ссылаться на исходный файл с текстом правил или на откомпилированный бинарный файл правил. ||
|#


Общие поля каскадной газетирной статьи, которые действительны для любого типа каскада:

#|
|| `priority` | Задает приоритет данной статьи.

Если правило использует несколько каскадных статей, то порядок исполнения вложенных каскадных правил будет задаваться данным приоритетом.

Правила с большим значением приоритета будут исполняться раньше.

Правила с одинаковым приоритетом исполняются в порядке идентификаторов соответствующих каскадных газетирных статей.

По умолчанию приоритет равен 0. ||

|| `filter` | Строковое поле, которое задает [логическое условие на литералы](literals.md#logicheskoeuslovie).

Каскад будет применяться только в том случае, если в дереве присутствует хотя бы один символ, удовлетворяющий заданному условию.

Позволяет пропускать запуск каскадных правил для вариантов разборов, на которых гарантированно ничего не будет найдено. ||

|| `subCascadeAmbiguity` | Булевский флаг, который определяет, будет ли сниматься омонимия _дочерних_ каскадов, если они есть.

По-умолчанию флаг имеет значение `true` (используются все результаты дочерних каскадов) ||

|| `subCascadeRankMethod` | Строковое поле, которое задает [метод ранжирования](coverage-ranking.md), используемый при снятии омонимии дочерних каскадов.

По-умолчанию поле имеет значение `"greater-coverage,less-count,greater-weight"`. ||
|#



### Каскад для remorph-правил {#kaskaddljaremorph-pravil}

Remorph-каскад создается для газетирной статьи с префиксом ключа `remorph:`.

Газетирная статья для remorph-правил должна иметь тип `TAuxRemorphArticle`, описанный в [dict/remorph/cascade/cascade.proto](https://arcadia.yandex.ru/wsvn/arc/trunk/arcadia/dict/remorph/cascade/cascade.proto).

Специальные поля каскадной газетирной статьи, определенные в `TAuxRemorphArticle`:

#|
|| `mainword` | Задает позицию главного слова в сопоставленной последовательности (первое слово нумеруется с 1). 

Отрицательное значение задает позицию главного слова с конца последовательности: -1 ссылается на последнее слово, -2 ссылается на предпоследнее и т.д.

По умолчанию используется первое слово. ||

|| `submatch` | Задает именованное подвыражение, которое должно использоваться вместо всей сопоставленной последовательности. ||

|| `headSubMatches` | Задает список именованных подвыражений, которые будут использоваться для определения главного слова.

Код проверяет по-очереди наличие каждого из указанных подвыражений, и первое найденное используется для определения главного слова.

Если для газетирной статьи задано поле `submatch`, то подвыражения из `headSubMatches` ищутся только в пределах последовательности `submatch`. Если найденное подвыражение покрывает несколько слов, то используется поле `mainword` для определения главного среди них.

В случае пустого списка в `headSubMatches`, главное слово определяется во всей сопоставленной последовательности с использованием `mainword`. ||
|#


Пример каскадной газетирной статьи:

```
import "dict/remorph/cascade/cascade.proto";
TAuxRemorphArticle "complex_addr"
{
    key = [ {"remorph:arcadia_tests_data/wizard/geoaddr/rules.remorph" type=CUSTOM} ]
    submatch = "addr"
    mainword = 1
    headSubMatches = "quater" | "street" | "metro"
    priority = 10
}
```

Пример правила, использующего remorph-каскад:

```
rule from_to = "как" "проехать" (<track> "от" (<from>[?gzt=complex_addr]) "до" (<to>[?gzt=complex_addr]));
```


### Каскад для char-правил {#kaskaddljachar-pravil}

Char-каскад создается для газетирной статьи с префиксом ключа `rem-char:`.

Газетирная статья для char-правил должна иметь тип `TAuxRemCharArticle`, описанный в [dict/remorph/cascade/cascade.proto](https://arcadia.yandex.ru/wsvn/arc/trunk/arcadia/dict/remorph/cascade/cascade.proto).

Специальные поля каскадной газетирной статьи, определенные в `TAuxRemCharArticle`:

#|
|| `submatch` | Задает именованное подвыражение, которое должно использоваться вместо всей сопоставленной последовательности. ||
|#

Пример каскадной газетирной статьи:

```
import "dict/remorph/cascade/cascade.proto";
TAuxRemCharArticle "date"
{
    key = [ {"rem-char:remorph/dates.remorph" type=CUSTOM} ]
    submatch="date_main_part"
}
```

Пример правила, использующего char-каскад:

```
rule cinema_ap = "пойдем" "в" "кино" (<when>[?gzt=date]);
```


### Каскад для правил TokenLogic {#kaskaddljapraviltokenlogic}

TokenLogic-каскад создается для газетирной статьи с префиксом ключа `token:`.

Газетирная статья для TokenLogic-правил должна иметь тип `TAuxTokenLogicArticle`, описанный в [dict/remorph/cascade/cascade.proto](https://arcadia.yandex.ru/wsvn/arc/trunk/arcadia/dict/remorph/cascade/cascade.proto).

Специальные поля каскадной газетирной статьи, определенные в `TAuxTokenLogicArticle`:

#|
|| `mainword` | Задает позицию главного слова в сопоставленной последовательности (первое слово нумеруется с 1).

Отрицательное значение задает позицию главного слова с конца последовательности: -1 ссылается на последнее слово, -2 ссылается на предпоследнее и т.д.

По умолчанию используется первое слово. ||

|| `namedToken` | Задает именованный токен, который должен использоваться как результат каскада вместо всей сопоставленной последовательности.

Если в результате присутствуют несколько токенов с данным именем, то результатом каскада будет вся последовательность между крайними найденными словами с данным именем ||

|| `headTokens` | Задает список именованных токенов, которые будут использоваться для определения главного слова.

Код проверяет по-очереди наличие каждого из указанных токенов, и первый присутствующий в результатах именованный токен используется для определения главное слово.

Если для газетирной статьи задано поле `namedToken`, то используется только пересечение этих двух множеств.

Если в результате присутствуют несколько найденных именованных токенов, то используется поле `mainword` для определения главного среди них. ||
|#

Пример каскадной газетирной статьи:

```
import "dict/remorph/cascade/cascade.proto";
TAuxTokenLogicArticle "download_rule"
{
    key = [ {"token:download.tlrule" type=CUSTOM} ]
    namedToken = "dwn"
    mainword = 1
    priority = 10
}
```

