## Как работает PornQuery.

PornQuery умеет только матчить запрос целиком. Если нужна более продвинутая логика матчинга -- это AdultRule, если нужны модели
-- это AdultRule и AdultModels.

Используемые газетиры описаны в https://a.yandex-team.ru/arc/trunk/arcadia/search/wizard/data/fresh/porn\_query/config.pb.txt,
а формат задан тут: https://a.yandex-team.ru/arc/trunk/arcadia/search/begemot/rules/porn\_query/protos/config.proto
Для каждого газетира нужно указать:
- `File` - имя файла лежащего в папке https://a.yandex-team.ru/arc/trunk/arcadia/search/wizard/data/fresh/porn\_query газетира
- `Tag` - уникальный идентификатор газетира
- `Languages` - список языков, для которых данный газетир может сработать
- `PornoThreshold` - порог срабатывания газетира. Значение формулы выше этого порога, считается как порно.
- `WhiteThreshold` - порог срабатывания не-порно.

Если список языков пустой, то газетир будет проверяться на всех запросах.
(это отчасти дублирует языковую логику статей в газетирах -- так сделано для большей наглядности, и чтобы избежать неожиданных срабатываний).

`WhiteThreshold` не обязателен. Если он не указан, то все значения ниже `PornoThreshold` будут считаться как непорнушные. Если задан,
то появляется дельта между белым и порно порогами, для которой газетир будет молчать.

Пороги могут быть не заданы вообще - тогда считается, что газетир использует старый формат, оставленный для совместимости

### Переопределение поведения PornQuery через CGI параметры

По умолчанию могут сработать только те газетиры, которые перечисленны как `Default` в конфиге. Переопределить список активных газетиров можно
отдельно для каждого запроса, используя CGI параметр `&wizextra=porn_query_trie_tag=tag_selector1,tag_selector2`. Газетиры будут применяться
точно в том порядке, как они указаны в данном параметре. При задании данного параметра, `Default` секция конфига игнорируется, применяются
только указанные газетиры.

Каждый tag\_selector может иметь один из 3 видов
- _tag_
- _tag_`:`_porno\_threshold_
- _tag_`:`_porno\_thrshold_`:`_white\_threshold_

То есть можно как указать используемый газетир, так и переназначить его пороги срабатывания.
Если переназначен хотя-бы порог порно, то белый порог из конфига будет проигнорирован.

#### Пример переопределения

`https://yandex.ru/search/?text=жаренные%20гвозди&wizextra=porn_query_trie_tag=ipq_1072492278:2.3:2.0,ipq_1072842332:1.0`

Правило PornQuery должно отработать, использовав только газетиры __ipq_1072492278__ и __ipq_1072842332__, причём
- если газетир __ipq_1072492278__ вернул значение выше 2.3, то считать документ порнографическим
- если газетир __ipq_1072492278__ вернул значение ниже 2.0, то считать документ белым
- в случае, если газетир __ipq_1072492278__ вернул значение в диапазоне от 2.0 до 2.3 (исключительно), 
  то считать что газетир __ipq_1072492278__ не сработал
- Если газетир __ipq_1072492278__ не сработал (значения от 2.0 до 2.3, или в нём ничего не нашлось), то проверить
  запрос в газетире __ipq_1072842332__. При этом значения больше 1.0 считать порно, а меньше - белыми.

## Создание газетиров

Запросы для матчинга хранятся в газетирах и имеют проставленное значение формулы:

```
NBg.NProto.TPornQueryItem {
    key = {
        "жаренные гвозди",
        morph=EXACT_FORM
    }
    FormulaVal = 1.32134
}
```

Для генерации исходного кода газетира можно воспользоваться следующим шаблоном __Jinja__
```
encoding "utf8";
import "search/begemot/rules/porn_query/protos/entry.gztproto";

{% for item in context -%}
NBg.NProto.TPornQueryItem {
    key = {
        "{{item.query}}",
        morph={% if item.query|wordcount > 10 %}EXACT_FORM{% else %}ALL_LEMMA_FORMS{% endif %}
    }
    FormulaVal = {{item.value}}
}
{% endfor %}
```

Подразумевается, что сырые значения формулы расположены в объекте вида
```
{"context": [
  {"query": "жаренные гвозди", "value": 1.32134},
  ...
]}
```

Полученные данные нужно скомпилировать.
Можно воспользоваться кубиком Нирваны: https://nirvana.yandex-team.ru/operation/6581c5e4-e748-4de5-8b1d-c842a82432be/overview
А можно при помощи https://a.yandex-team.ru/arc/trunk/arcadia/dict/gazetteer/compiler:
```
gztcompiler -T ~/arc example.gzt example.gzt.bin
```

Далее загрузить газетир в Sandbox
```
ya upload --ttl=inf example.gzt.bin
```

И прописать ссылку на него в конфиг и ya.make фреша
- https://a.yandex-team.ru/arc/trunk/arcadia/search/wizard/data/fresh/porn_query/config.pb.txt
- https://a.yandex-team.ru/arc/trunk/arcadia/search/wizard/data/fresh/porn_query/ya.make
