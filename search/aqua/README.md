# Метапоиски
Интеграционное тестирование базового, среднего, верхнего и визарда.

Для тестов нужно установить JDK (1.8 подойдёт).

Для сборки проекта используется [Apache Maven](https://maven.apache.org/).
Установка Maven: `sudo apt-get install maven` (Ubuntu), также можно смотреть [тут](https://maven.apache.org/install.html).
Актуальный файл с настройками можно найти [тут](https://github.yandex-team.ru/artifactory/settings.xml/).

Чтобы обновить проект в акве после внесённых изменений, нужно выполнить команду 
`mvn clean deploy -P production,aqua-report,aqua-report-archive`.

Чтобы убедиться, что ваши изменения выкатились, нужно зайти [в артифактори](http://artifactory.yandex.net/webapp/#/artifacts/browse/tree/General/yandex_qa_snapshots/ru/yandex/autotests/search/serp-meta/1.0-SNAPSHOT/maven-metadata.xml)
и убедиться, что дата `Last Modified` свежая (например, `Last Modified: 01-03-17 18:26:32 +04:00`).

## Модули
### serp-meta-beans
Модуль содержит схему (`report.xsd`) для генерации Java-классов. Эти классы используются для простого создания отчёта 
из Java-кода и его сериализации в XML-файл (`meta.xml`).

Генерация происходит при сборке модуля, для этого используется плагин `jaxb2-maven-plugin`, конфигурирование плагина
производится в секции `build` файла `pom.xml` данного модуля.

### meta-report-files (serp-meta-report)
Модуль содержит файлы, необходимые для построения html-отчёта для тестов.

### serp-meta-tests
Модуль содержит класс, собирающий необходимые тесты и запускающий их.
 
Также в `pom.xml` этого модуля описывается построение `junit.xml` и html-отчёта при помощи плагина 
`xslt-generator-maven-plugin`.

### serp-meta-utils
Модуль содержит все утилитные классы, которые используются для запуска тестов и файлы с запросами в ресурсах модуля.

### Конфигурационные опции
Все опции записаны в классе `ru.yandex.autotests.search.meta.Config` модуля `serp-meta-utils`.

### Инспекции (типы проверок)
Описываются в классах пакета `ru.yandex.autotests.search.meta.checkers`, наследующихся от класса `Inspection`.

### Данные для проверок
Класс, представляющий текущий кейс, - `ru.yandex.autotests.search.meta.data.TestScenario` - открывает хосты, выполняет 
инспекцию.

Для создания представления отчёта используется класс `ru.yandex.autotests.search.meta.ReportHandler`, для записи его 
в виде файлов (`meta.xml` и файлов скриншотов) используется `ru.yandex.autotests.search.meta.ReportCreator`.

Остальные классы используются для получения данных из разных источников для разных инспекций. Часть читают из файла,
часть из вики при помощи [wiki-java-client](https://github.yandex-team.ru/internal/wiki-java-client), часть из 
тестпалма при помощи [spalm](https://github.yandex-team.ru/testweberport/spalm).

Вики-страницы: 
* https://wiki.yandex-team.ru/testirovanie/functesting/websearch/webreport/geowizards/geo/
* https://wiki.yandex-team.ru/testirovanie/functesting/websearch/webreport/meta/

TestPalm: https://testpalm.yandex-team.ru/serp

### Тестируемые сервисы и метапоиски
Тестируемые сервисы описаны в виде перечисления в `ru.yandex.autotests.search.meta.search.Service` модуля 
`serp-meta-utils`. 

Наборы проверок для каждого из метапоисков описаны в соответствующем классе пакета 
`ru.yandex.autotests.search.meta.search`. 

## Настройки
Настройки Maven делаются в настройках IDE (если что-то не настроено, IDE попросит настроить).

Настройки JDK делаются в настройках проекта (также IDE сама попросит настроить).

### Открыть проект
1. Cкачать и поставить https://www.jetbrains.com/idea/download/ (достаточно community edition)
1. Запустить
1. Выбрать пункт меню Открыть (Open)
1. В появившемся файловом менеджере открываем папку с проектом, выбираем файл pom.xml (корневой, у модулей есть свои такие, но в данный момент речь не о них)
1. Нажимаем OK, IDE подхватит проект и всё откроет сама

### Запустить тест
1. Открываем в дереве проектов слева модуль `serp-meta-tests` до класса `MetaTest`.
1. ПКМ по названию класса. 
1. В появившемся меню выбираем 'Create MetaTest...'
1. Настраиваем свойства (имя конфигурации, свойства - имена и значения свойств как в акве) 
  ![Скриншот с примером конфигурации](https://jing.yandex-team.ru/files/fenice/2017-02-14_18-37-27.png)
1. Сохраняем конфигурацию, в дальнейшем она доступна для запуска в списке конфигураций
  ![Скриншот со списком конфигураций](https://jing.yandex-team.ru/files/fenice/2016-06-15_20-01-57.png)

Каждый раз перед запуском теста стоит делать `mvn clean compile`.

### Возможные проблемы
1. Убедитесь, что [этот файл](https://github.yandex-team.ru/artifactory/settings.xml/) расположен в директории `~/.m2/settings.xml`.
2. Каждый раз перед запуском теста стоит делать `mvn clean compile`.
3. Если не проставлено - в настройках проекта укажите import maven projects automatically, если не удается запустить тест - попробуйте на вкладке 
Maven Projects (располагается справа в полном отображении, переключение на полное отображение находится в левом нижнем углу) сделать Reimport All Maven Projects
4. Также проверьте наличие доступа до _SELENIUMGRIDNETS_ по TCP для порта 4444

##Как обновить данные для инспекции непропадания колдунщиков
Данный раздел касается инспекций `DesktopWizard` и `TouchWizard`.

**ВНИМАНИЕ! Обращаться с данными в тестпалме нужно ОЧЕНЬ АККУРАТНО, они используются во МНОГИХ проектах!** 

Если обнаружено, что данные для одного из кейсов устарели, нужно:

1. Найти кейс в тестпалме
1. Если фича не показывается по url, указанному в тестпалме, но показывается по другому, нужно обновить url.
1. Если фича показывается по url, но устарел селектор, нужно обновить селектор.
 
### Как найти кейс в тестпалме
У нас есть упавший кейс, например:
![Пример упавшего кейса](https://jing.yandex-team.ru/files/fenice/2017-03-24_18-59-34.png)

В сообщении об ошибке указаны данные, необходимые для поиска кейса: тип фичи, фича и название кейса. 
Для данного примера это `Type: Вьюпорт`, `Feature: Афиша` и `TestCase: Афиша/ Вьюпорт Кинотеатр`.

Идём в тестпалм https://testpalm.yandex-team.ru/serp/testcases и фильтруем кейсы по `Type` и `Feature`, 
получается такой [список кейсов](https://testpalm.yandex-team.ru/serp/testcases?filters=%7B%22type%22:%22AND%22,%22left%22:%7B%22type%22:%22EQ%22,%22key%22:%22attributes.558d4e41e4b0f81c89c3f9bf%22,%22value%22:%22%D0%92%D1%8C%D1%8E%D0%BF%D0%BE%D1%80%D1%82%22%7D,%22right%22:%7B%22type%22:%22EQ%22,%22key%22:%22attributes.55eda6b1e4b098defd6a1dbc%22,%22value%22:%22%D0%90%D1%84%D0%B8%D1%88%D0%B0%22%7D%7D).
Находим в списке нужный кейс по его названию: 

![Спиок кейсов](https://jing.yandex-team.ru/files/fenice/2017-03-25_10-05-34.png)

Открываем страницу кейса (при клике на кейс в списке появляется панель с кейсом справа, но редактировать намного удобнее 
на странице кейса. На неё можно попасть по клику на идентификатор кейса `serp-XXXX` вверху панели. Также можно просто 
подставить этот идентификатор в ссылку https://testpalm.yandex-team.ru/testcase/serp-XXXX).

### Как обновить url
Находясь на странице кейса, нужно найти свойства (раздел `Properties`).

Включаем режим редактирования свойств: 
![Включаем режим редактирования свойств](https://jing.yandex-team.ru/files/fenice/2017-03-25_10-43-58.png)
 
Интересуют свойства с названиями вида `<Platform>_<tld>`. Свойства для платформ:

* для `yandsearch` (`DesktopWizard`) - свойства `Desktop_<tld>`,
* для `touchsearch` (`TouchWizard`) - свойства `Touch_<tld>`.

Находим свойство для нужного домена и меняем запрос в url'е. Нужно менять флаги только в том случае, 
когда это действительно необходимо для показа фичи. Ссылка должна продолжать вести на продакшен. **Эти ссылки 
используются во многих тестах и для ручного тестирования, они должны остаться валидными после ваших изменений.**

После завершения редактирования нажимаем кнопку `Save`:
![Сохранение](https://jing.yandex-team.ru/files/fenice/2017-03-25_10-50-31.png)

### Как обновить селектор
Находясь на странице кейса, нужно найти ключи кейса (раздел `Keys`).

Включаем режим редактирования ключей:
![Включаем режим редактирования ключей](https://jing.yandex-team.ru/files/fenice/2017-03-25_10-53-43.png)

Интересуют ключи с названиями вида `Selector_<platform>`. Свойства для платформ:

* для `yandsearch` (`DesktopWizard`) - свойство `Selector_deskpad`,
* для `touchsearch` (`TouchWizard`) - свойство `Selector_Touch`.

Сначала составляем новый селектор. Стараемся выбирать минимально сложный селектор, предпочтение отдаётся 
CSS-селекторам, лучше всего использовать CSS-классы. 

Про селекторы:

* [MDN Общее](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors),
* [MDN Классы](https://developer.mozilla.org/en-US/docs/Web/CSS/Class_selectors),
* [W3C](https://www.w3schools.com/csSref/css_selectors.asp)

Находим нужный ключ, удаляем старое значение нажатием на крестик, добавляем новое значение селектора и сохраняем. 

![Редактирование и сохранение](https://jing.yandex-team.ru/files/fenice/2017-03-25_11-04-14.png)
