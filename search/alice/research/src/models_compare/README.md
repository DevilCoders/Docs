# Сравнение различных моделей

Для того, чтобы улучшить базовое качество суммаризации в разумные сроки, нужно уметь быстро решать следующие задачи:
- генерация гипотез;
- обучение моделей на различных конфигурациях данных/параметров;
- перебор параметров обученных моделей, сравнение различных обученных моделей.

Инструменты, которые описываются ниже, позволяют достаточно быстро решить задачу перебора параметров и сравнения моделей.

## Перебор параметров и моделей

Перебор параметров и моделей осуществляется скриптом grid\_run. Этот скрипт:
- перебирает параметры и модели по сетке из grid.cfg в случайном порядке;
- для каждой группы параметров запускается сервер с соответствующей конфигурацией;
- запущенный клиент шлет запросы на поднятый сервер;
- на каждую группу параметров создается отдельный файл. Название файла отражает конфигурацию сервера, содержимое - ответы сервера.

Чтобы запустить скрипт, нужно положить его в папку с сервером, папкой ниже расположить клиент, указать пути до конфигураций, входного файла и папки с результатами.

Формат входного файла соответствует формату входа для serp\_summarizer\_client\_cli. Т.е. jsonlines вида:
{"Query":..., "SerpResults":[{"Snippet":...},...]}

Важный факт: увеличение размера сетки параметров для одной модели слабо влияет на увеличение количества уникальных ответов сервера. Для N запросов количество ответов одной модели с разными параметрами не должно сильно превышать 6N. При этом, разные модели имеют одинаковые ответы на одни и те же запросы гораздо реже.

## Сравнение моделей

После работы grid\_run можно сравнить ответы моделей при помощи вальгальника models\_compare.

Вальгальнику нужно передать путь до запросов и путь до папки с ответами различных моделей.

В последнем кубике вальгальника будет лежать tsv-файл с характеристиками моделей:
1) precision - процент непустых ответов, которые толокеры разметили, как правильные;
2) coverage - процент ответов, которые не являются пустыми;
3) full\_precision - процент ответов, которые являются правильными.

Пример отработавшего вальгальника можно посмотреть [здесь](https://nirvana.yandex-team.ru/flow/67935086-041d-4220-a537-db3b6f5a96f6/98beac0e-edb6-40ad-afbd-dc66c9c4b09a/graph).

## Приемка

Менее частый, но очень важный сценарий. Это необходимое условие выкатки модели на прод.

Для того, чтобы запустить приемку:
- стоит взять последний приемочный граф по [инструкции](https://wiki.yandex-team.ru/alice/vins/vykatka-reliza-vins/#zameryumestnostiposkrinshotamiue2ezamery) (Там же подробно описано, какие параметры нужно поменять при запуске);
- от этого графа стоит взять только общую часть и заменить корзину на поисковую;
- прописать в экспериментах путь до сервера: 
websearch\_bass\_cgi\_srcrwr=SUMMARIZATION:iva1-5739.search.yandex.net:{AppHostPort + 1}

Должно получиться что-то вроде [этого](https://nirvana.yandex-team.ru/flow/047afbb9-661c-4f09-ba2a-90a8e1feabb9/6707f66b-2161-4da9-beae-8b18a2d502e2/graph).
