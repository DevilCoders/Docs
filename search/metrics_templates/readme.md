# Шаблоны MLM для нужд Единой Приёмки

Шаблоны разделены по вертикалям (например, `web/`).
Изменения в шаблонах должны пройти ревью у аналитиков качества
своей вертикали.

В случах, когда назначение шаблона неясно, пожалуйста, обратитесь
в чат поддержки UPS (см. раздел Ссылки).

## Как не закоммитить кривой шаблон

### Запустить валидацию синтаксиса шаблонов

Это НЕ прекоммитные тесты, их нужно запускать самостоятельно.

Вам потребуется программа `js` (поставляется вместе с NodeJs
или вместе с Mozilla JS Engine). Когда-нибудь мы завернём эти тесты
в нормальный `ya make -t`, но нам пока что лень.

Запускаем из консоли скрипт `./test_all.sh`. Если выхлоп пуст,
всё отлично. В противном случае вы получите
[простыню ошибок](https://paste.yandex-team.ru/4973626).

### Снять метрики с новым шаблоном

Здесь возможны варианты в зависимости от шаблона.

1. Для шаблонов `web/common.json` и `web/experiments.json` настроена
автоматическая приёмка при коммитах. Шаблон не будет использоваться,
пока не пройдёт приёмку в Release Machine. Для приёмки создана
компонента [metrics_templates](https://rm.z.yandex-team.ru/component/metrics_templates/manage).

2. Для всех остальных шаблонов нужно прогонять приёмку самостоятельно.
(если вы хотите подключить свой шаблон к автоматике, обратитесь
к ilyaturuntaev@ или в чат UPS).

Для содержательных изменений, меняющих или добавляющих
- метрики
- корзины
- фильтры
- пороги срабатываний
обязательно прогнать съём серпов с новым шаблоном.

Проще всего сделать это так:

- Делаем изменения в шаблоне, прогоняем валидацию синтаксиса
- Коммитим шаблон с именем `<имя_шаблона>.testing.json`
в тот же каталог.
- Клонируем задачу Sandbox `LAUNCH_METRICS`, которая использует
`<имя_шаблона` запускаем клон с параметрами
  - `custom_template_name: <имя_шаблона>.testing.json`
  - `template_source: From Arcadia`
- Анализируем полученную MLM-скачку (ссылка на MLM есть в info задачи).
- В случае удовлетворённости результатом
  - Сообщаем про изменения шаблона в чат UPS на всякий случай
  - Коммитим шаблон с обычным именем
  - Удаляем testing-версию
- Если что-то пошло не так -- исправляем testing-версию шаблона, пока
она не станет достаточно хорошей, чтобы её можно было запускать всем.

**Q**: Почему нельзя просто так взять и закоммитить? Я же знаю, что делаю!

**A**: Потому что шаблоны используются автоматикой для приёмки программ. Если вы
сломаете шаблон, вы сломаете продакшен-процесс приёмки программ. Вас обязательно
найдут, догонят и спасибо точно не скажут.

В сложных случах проконсультируйтесь в чате UPS.

## Ссылки

- Чат поддержки UPS: https://wiki.yandex-team.ru/united-priemka/#pravilaobshhenija
- Фильтры Metrics: https://wiki.yandex-team.ru/metrics/API/serp/filters/
- Metrics FAQ: https://wiki.yandex-team.ru/metrics/faq/
- Автоматическая приёмка шаблонов: https://rm.z.yandex-team.ru/component/metrics_templates/manage
