Ниже описан гайд для Horadric'еских проектов как заехать на IDM + WebAuth для работы с пользовательскими ролями.

*Терминология*:
- *система* — описание вашего сервиса в IDM
- *дерево ролей* — структура, описывающая какие роли могут быть выданы в вашей системе, без информации о пользователях и их ролях (например, `{admin, moderator, system_module/admin}`)

#### 1. Завести систему для вашего сервиса в IDM

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-15%20at%201.23.04%20PM.png =500x139)

Во вкладке *Настройки -> Параметры* в поле *Адрес ручки* точно заполняем:

1. Адрес сервиса в формате `https://my-service.z.yandex-team.ru/` (да, со слешом на конце).
2. ID TVM-приложения (получить через ABC, вот [гайд как завести TVM приложение сервису](https://wiki.yandex-team.ru/passport/tvm2/quickstart/#1-sozdajomprilozhenie))
3. Запрос ролей — если вам не подходит "Только и себя и своих подчиненных" не забудьте сменить на "Для кого угодно"
4. Если вам нужны групповые роли (через ABC), то в поле "Групповые роли" надо выставить "Поддерживает, но про группы ничего не знает"
5. "Разрешить редактировать дерево ролей через API?" — должно стоять "Да"

#### 2. Сходить в WebAuth попросить смотреть в IDM для вашей системы
В их доке не формализован порядок обращения с таким запросом, мне завел человек, который отвечал на вопросы про IDM, думаю, можно сходить к автору их Wiki.

[Ссылка](https://wiki.yandex-team.ru/intranet/webauth/#proverkaproizvolnyxrolejjvidm).

Цитата:
> *Webauth НЕ мониторит весь IDM целиком! Отдельные системы подключаются по запросу. Если вам хочется использовать авторизацию через роли IDM при использовании Webauth, свяжитесь с нами.*

#### 3. Подключить модуль IDM из martylib'а для синхронизации дерева ролей
Ваш сервис должен поддерживать [модули](https://a.yandex-team.ru/arc/trunk/arcadia/search/martylib/modules/README.md).
Нужно подключить модуль IDM вот [так](https://a.yandex-team.ru/arc/trunk/arcadia/search/mon/tickenator_on_db/bin/modules.py?rev=6982211#L5), а также явно указать, что WubAuth подключен и добавить фильтр ролей:
```
role_storage = RoleStorage()
role_storage.use_webauth = True
role_storage.set_role_filter(role_filter=lambda role: role.system == 'tickenator-prestable' and role.module.startswith('search.mon.tickenator_on_db'))
```
[Пример в коде](https://a.yandex-team.ru/arc/trunk/arcadia/search/mon/tickenator_on_db/bin/main.py?rev=7034887#L45)

Явно указывать, что WebAuth подключен — временный костыль, чтоб не сломать авторизацию по старой схеме через Auth, пока все сервисы не переехали. Зачем нужен фильтр ролей будет описано ниже.

Не забудьте также добавить `PEERDIR(search/martylib/idm)` туда, где настраиваете `RoleStorage`, а в `inifuss.scroll` — `- path: search/proto/idm` в `peers` (без этого нужные ручки не прорастут в ваш сервис) и перезапустить `Horadric` после этого. В `serval_configs/root.yaml` должно появиться что-то вроде этого:

```
- main:
    - path_rewrite:
        '/info': '/api/martylib.idm.IdmDaemon/listPossibleRoles'
        '/info/': '/api/martylib.idm.IdmDaemon/listPossibleRoles'
```

А также добавть сгенеренную папку `services/martylib` под контроль вашей vcs.

#### 4. Описать дерево ролей
Сами роли описываются с помощью options внутри сервиса в формате
`option (h.auth.role) = { id: "<system-name-in-IDM>/<role-name>" help: "<role description>" };`,
*Например*:
`option (h.auth.role) = { id: "my-service/admin" help: "admin of my service" };`

[Пример в коде](https://a.yandex-team.ru/arc/trunk/arcadia/search/mon/tickenator_on_db/proto/services/tickenator.proto?rev=6982211#L20).
Не забудьте написать в нужных ручках, что требуется [авторизация](https://a.yandex-team.ru/arc/trunk/arcadia/search/mon/tickenator_on_db/proto/services/tickenator.proto?rev=6982211#L31).

Чтоб проверить, что на этом этапе все выполнено корректно, можно запустить ваш сервис (не забыв про новый модуль `idm`) и проверить, что на запрос `curl --request GET --url https://my-service.z.yandex-team.ru/info/` отдается что-то похожее на:
```
{
  "code": 0,
  "roles": {
    "slug": "my-service",
    "name": "my-service",
    "values": {
      "admin": {
        "name": {
          "ru": "admin",
          "en": "admin"
        },
        "help": {
          "ru": "admin of my service",
          "en": "admin of my service"
        }
      }
    }
  }
}
```

##### Как это работает и зачем же все-таки фильтр ролей?
`RoleStorage` подцепляет все роли из всех proto-файлов всех подсоединяемых в проект модулей. Чтоб отдавать в IDM только связанные с вашим сервисом, стоит фильтровать список ролей, указав имя модуля, из которого стоит брать роли (вряд ли вам нужно что-то описанное в yt'овых pb файлах для ролей) и имя системы в IDM.

#### 5. Синхронизировать узлы
После того как в ваш сервис были задеплоены изменения с ручкой `/info/`, отдающей дерево ролей, нужно чтоб их подцепил IDM. Для этого нужно на странице вашей системы в интерфейсе IDM во вкладке "Синхронизация" нажать "Синхронизировать" для узлов.

(Тут можно избежать выкатки в прод вашего сервиса, а выкатить в условный престейбл, если таковой имеется, указать его адрес в настройках IDM и синхронизировать узлы из него. Потом можно спокойно поменять на адрес вашего сервиса обратно.)

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-15%20at%203.15.32%20PM.png =700x165)

Если все прошло успешно, то во вкладке "Отчеты" должны увидеть что-то вроде:

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-15%20at%203.19.04%20PM.png =900x134)

а из интерфейса IDM из разных мест пропадет сообщение о том, что в системе отсутствует дерево ролей.

Если описанное не произошло, можно пойти во вкладку "Диагностика" подергать ручку `/info/` и посмотреть на ответ.

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-15%20at%203.22.10%20PM.png =700x260)


##### Как обновлять дерево ролей вообще, а не только на старте?
Два варианта:

1. Дерево ролей в вашей системе меняется крайне редко. Каждый раз когда оно меняется (что `/info/` по указанному адресу уже отдает эти изменения), нажимать кнопку "Синхронизировать" в UI IDM'а : )
2. В вашей системе динамически меняется дерево ролей, нажимать на кнопку не получится. Надо сходить к IDM и попросить, чтоб для вашей системы ручка `/info/` дергалась периодически а не только по запросу. Дока [вот](https://wiki.yandex-team.ru/intranet/idm/api/#tree-update), (но там ничего полезного).

#### 6. Запросить роли для людей
Прописать approvers в workflow на соответствующей вкладке:

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-17%20at%209.41.46%20PM.png =600x202)

Роли для людей можно запрашивать на вкладке "Роли". В случае успеха должна роль быть среди активных:

![](https://jing.yandex-team.ru/files/asimonenko18/Screen%20Shot%202020-06-15%20at%203.32.25%20PM.png =900x256)

Можно запрашивать роли на группы, тогда должны быть прописаны approvers во втором workflow для ролей, который становится виден в UI после выполнения 1.4.

#### 7. Заменить все `Role()` на `IdmRole()`
[Например](https://a.yandex-team.ru/arc/trunk/arcadia/search/mon/tickenator_on_db/src/services/tickenator.py?rev=7034887#L422)

То есть если вам важно не потерять возможность авторизации на какое-то время, то полный переезд стоит делать в два шага:
1. Выкатить изменения с подключенным модулем IDM, описать дерево ролей в proro-файдах, запустить синхронизацию в интерефейсе IDM, выдать нужные роли пользователям
2. Выкатить изменения с заменой `Role()` на `IdmRole()`

Синзронизацию дерева в первом шаге можно делать с престейбла, если такой имеется, как было сказано в п.5.


#### P. S. Локальный запуск

Если с машины, где вы запускаете ваш сервис, нет доступа до WebAuth, то для локальной отладки можно указывать пользователя и его роли в переменных среды `STATIC_USER` и `STATIC_USER_ROLES` соответственно.

Например:
`env STATIC_USER_ROLES=tickenator-prestable/admin:tickenator-prestable/moderator STATIC_USER='asimonenko18' bin/./tickenator run server tickenator`
