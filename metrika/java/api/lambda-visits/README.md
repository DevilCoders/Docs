## Общее описание

Лямбда - медленный контур обработки логов.
Демон запущен на кластере [mtconv](https://c.yandex-team.ru/groups/mtconv).
На входе - логи в yt разложенные по таблицам (чанкам) с некоторой гранулярностью (получасовые, часовые, дневные).
На выходе - таблицы в yt с обновленными данными.
Внутри чанк представлен метаданными в mysql (вид лога, id, статус, и т.п.), и таблицами в yt.
Метаданные чанков находятся в mysql [mtmisc](https://c.yandex-team.ru/groups/mtmiscsql), база `misc`, таблицы `lambda_*`.
Таблицы с данными лежат в [yt hahn](https://yt.yandex-team.ru/hahn/navigation?path=//home/metrika-lambda/production/lambda).

По мере обработки данные чанка преобразуются, джойнятся, поглощаются другими чанками.
Обработка осуществляется посредством выполнения тасок `lambda*` в [базинге](https://bazinga.mtrs.yandex-team.ru/).
Таск, как правило, выполняет yql-запрос, определенным образом обрабатывающий данные в yt.
В результате получается новая таблица с данными в yt, а чанк переходит в новый статус.

## Диаграммы

[Общая схема работы](https://wiki.yandex-team.ru/jandexmetrika/doc/visordfd/ljambda/)

## Графики

[Основной дашборд в графане](https://grafana.yandex-team.ru/d/1WFdWhSZk/metrika-lambdavisits)

Основной график - `First Non Terminal Delay` - отражает отставание самого старого необработанного чанка для каждого вида логов.
Для большинства вида логов нормальным является отставание до суток.
Для undo-логов и для visit slow лога нормальным является отставание до двух суток, так как они обрабатываются раз в день.

`YQL Errors by Worker` показывает ошибки в yql-запросах. Всплески или постоянный фон ошибок говорят о проблеме.
Хотя могут быть и ожидаемые всплески ошибок при рестарте демона, или при обслуживании yql/yt.

## Мониторинги

[Проверки bazinga-тасок](https://juggler.yandex-team.ru/aggregate_checks/?query=tag%3Dmetrica-api%26host%3Dbazinga_tasks-production%26service%3Dlambda*&view=tiles)

[Проверки на отставания обработки разных логов](https://juggler.yandex-team.ru/aggregate_checks/?query=tag%3Dmetrica-api%26host%3Dlambda-visits-manual-events-production%26service%3Dlambda-*&view=tiles)

## Полезные места в коде

[Виды логов](https://a.yandex-team.ru/arc/trunk/arcadia/metrika/java/api/lambda-visits/src/java/ru/yandex/metrika/lambda/task/MetrikaLogType.java)

[Статусы чанков](https://a.yandex-team.ru/arc/trunk/arcadia/metrika/java/api/lambda-visits/src/java/ru/yandex/metrika/lambda/task/MetrikaChunkStatus.java)

## Troubleshooting

Если зажегся мониторинг падения bazinga-таски - посмотреть на ошибку в базинге.
Может падать yql запрос, или может быть падение где-то в коде.
В любом случае дальнейшие действия зависят от того, какая именно возникла ошибка.
Если с нашей стороны не было релизов/изменений, а yql запрос, который раньше работал, стал вдруг падать,
это может произойти по следующим причинам:
* поменялся формат входных логов - следует найти ответственных за этот лог, сообщить им о проблеме, если откат невозможен,
то следует с нашей стороны совместимым образом поддержать новый формат
* поменялась логика в yql/yt, следует обратиться в поддержку yql/yt.

Если зажегся мониторинг отставания bazinga-таски - таск может зависнуть, или долго выполняться, или не шедулиться.
Нужно посмотреть на чем подвис таск, погрепать логи, поискать долгий yql-запрос запущенный этим таском.
Если таск не шедулится, то проблема может быть в bazinga-контроллере, или демон lambda-visits не запущен или совсем сломан.

Если зажегся мониторинг на отставание обработки - как правило должен быть падающий/зависший/не шедулящийся/долго выполняющийся таск,
из-за которого обработка отстала, тогда дальше следует отталкиваться от проблемы с таской.
Может случиться отставание, но при этом таски с виду работают - тогда нужно найти какой именно вид логов отстает,
и в каком статусе застряли чанки, найти таск, который должен обрабатывать данные чанки в данном статусе,
разобраться почему этот таск не делает свою работу или делает ее медленно или некорректно.
