# Goals server

Представляет собой grpc-сервер, матчащий цели для батча хитов.
Матчер для каждого счетчика строится/обновляется/работает отдельно, за счет чего не требуется при обновлении хранить x2 данных.

### Чтение из mysql

Таблицы из mysql читаются классами из MySqlScanner.h, затем при помощи GoalsTransformer.h преобразуются в описание с удобным форматом TCounterUrlGoalsDescription (из UrlGoal.h).
Интерфейсом для загрузки целей является MySqlDownloader.h.

### Матчинг целей

Главный класс-интерфейс ко всему здесь -- IGoalMatcher.

Для каждого описания целей на счетчике TCounterUrlGoalsDescription строится UrlMatcher, который состоит из матчера строк (StringMatcher.h, может быть либо простомы strcmp, либо автоматом intel hyperscan (если строк много/есть регулярки)) и дерева проверок (GoalCheckers.h).

Каждой строке, которую требуется матчить (типы матчинга equal, contain, regex, prefix) сопостовляется id.
Этот id используется чекерами в дереве для проверки того, поматчилась ли нужная им строка.
Матчер строк после построения по входному урлу выдает множество id поматчившихся строк.

Сам матчинг происходит следующим образом:
1. Создается TLazyMatchState, который предоставляет чекерам в дереве интерфейс для проверки поматчившихся строк (lazy, поскольку не запускает матчинг, если он не нужен).
2. Происходит обход дерева чекеров с пробросом в ноды TLazyMatchState.


Схема с отдельным матчером строк вместо использования re2/find/... в каждой цели позволяет поматчить все строки за один проход.

