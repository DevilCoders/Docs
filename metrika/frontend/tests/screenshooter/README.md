## О проекте

Сриншотные интеграционные тесты сервисов аналитических продуктов.

## Создание виртуальной машины для разработки

Для стабильной работы тесты во всех средах и на всех операционных системах крайне рекомендуется использовать разработческую виртуалку, чтобы среда запуска была идентична.

Для локального запуска потребуется [завести виртуалку](https://wiki.yandex-team.ru/JandexMetrika/frontend/devcomputerforeveryone/#kaksozdatvirtualku)

После того, как виртуалка создана заходим на нее и донастраиваем (следую инструкциям в терминале).

После первичной настройки, нужно подключить arc. [Инструкция](https://docs.yandex-team.ru/devtools/intro/quick-start-guide)

Далее нам необходимо подготовить IDE для работы на удаленной тачке. [Инструкция для VSCode](https://code.visualstudio.com/docs/remote/ssh)

В дальнейшем работаем с тестами на виртуалке также, как и с локальными тестами.


## Подготовка к запуску

Для работы тестов необходим nodejs. Корректная работа гарантируется на 12 версии. Для удобной работы с разными версия nodejs рекомендуется поставить [nvm](https://github.com/nvm-sh/nvm)&

Также для работы нужно установить переменную окружения TUS_TOKEN
Токен нужно, чтобы иметь возможность забирать тестовые данные пользователей.
Если начинате разработку на чистой машине,где еще нет allure:
    Нужно поставить allure https://docs.qameta.io/allure/
    Нужно поставить JDK, например, apt-get install yandex-openjdk11
[Документация TUS](https://wiki.yandex-team.ru/test-user-service/)
[Как получить токен](https://wiki.yandex-team.ru/test-user-service/#autentifikacija)

## Сборка и запуск

В корне проекта необходимо выполнить `npm run build` для сборки проекта.
В корне необходим файл state.json,он создается так
`BASE_URL='<beta url>' npx playwright test 'Auth' --project='auth'`
state.json помимо авторизации влияет на LS в котором проставлены флаги для баблов и гайдов, чтобы не шумели
Важно  - перед обновлении снэпшотов, обновлять также стэйт с продовым урлом.
Проверять свежеизмененный снэпшот на бэте/тесстинге нужно уже со стэйтом для урла бэты,
иными словами, перед проверкой опять обновляем стэйт на новый
Для запуска тестов нужно выполнить следующий команды:
`BASE_URL='<beta url>' npm run metrika:desktop` - десктопная версия метрики в chromium
`BASE_URL='<beta url>' npm run metrika:desktop-crossbrowser` - десктопная версия метрики в chromium и firefox
`BASE_URL='<beta url>' npm run metrika:mobile` - мобильная версия метрики в chromium
`BASE_URL='<beta url>' npm run metrika:mobile-crossbrowser` - мобильная версия метрики в chromium
`BASE_URL='<beta url>' npm run metrika:full` - и десктопна, и мобильная версии метрики в chromium и webkit
`BASE_URL='<beta url>' npm run metrika:full-crossbrowser` - и десктопна, и мобильная версии метрики в chromium, firefox и webkit

По умолчанию тесты запускаются на одном воркере. Чтобы ускорить их выполнение необходимо указать количество воркеров в момент запуска. Пример:
`ВASE_URL='https://test.metrika.yandex.ru' npm run metrika:full -- --workers 7`

### Запуск отдельных тестов и обновление артефактов

Чтобы обновить отдельный артефакт нужно выполнить соответствующую команду в playwright. Пример:
`npx playwright test --update-snapshots -g 'Отчет "Рекомендательный виджет, материалы"' --project='metrika-mobile'`

Обязательно указывае `--update-snapshots`, также указываем проект `--project='project-name'` и название проверки после ключа `-g "Имя проверки"`

### Построение отчета

Выполняем команду `npm run build:report`. После построения allure отчет откроется в браузере.

## Переменные окружения

`BASE_URL` - урл автобеты, на которой запускать тесты
