# –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–û–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞:

```typescript
import { ConfigField, ValidatorKind } from '@server-libs/configurator/metadata';

class DBConfig {
    // –æ–±—ã—á–Ω–æ–µ —Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø–æ–ª–µ
    @ConfigField()
    user!: string;

    // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ
    @ConfigField({ isOptional: true })
    password?: string;

    isAwesome(): boolean {
        return true;
    }
}

class ApiConfig {
    // —Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø–æ–ª–µ number –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ TCP –ø–æ—Ä—Ç
    @ConfigField({ validator: ValidatorKind.Port })
    port!: number;
}

export class MetrikaAppConfig {
    // –≤–ª–æ–∂–µ–Ω–Ω–æ–µ –ø–æ–ª–µ
    @ConfigField()
    apiConfig!: ApiConfig;

    // –≤ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—è –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
    @ConfigField({
        validator: (dbc: DBConfig) => dbc.isAwesome(),
    })
    dbConfig!: DBConfig;
}
```

–ü–æ–ª—É—á–∞–µ–º –∏–Ω—Å—Ç–∞–Ω—Å –∫–æ–Ω—Ñ–∏–≥–∞:

```typescript
import { getConfig } from '@server-libs/configurator/configurator';

const config = await getConfig(MetrikaAppConfig);
config.dbConfig.user; // string
```

## –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã

–ï—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã `ValidatorKind` –¥–ª—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –º–æ–∂–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

-   `ValidatorKind.Url` - –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º URL
-   `ValidatorKind.Port` - –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º TCP –ø–æ—Ä—Ç–æ–º
-   `ValidatorKind.IpAddress` - –ø–æ–ª–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º IP –∞–¥—Ä–µ—Å–æ–º

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```typescript
export class MetrikaAppConfig {
    @ConfigField({ validator: ValidatorKind.Port })
    port!: number;
}
```

–í–∞–∂–Ω–æ: –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ –ø–æ–ª–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä string –∏–ª–∏ number), –∞
–≤—ã–∑—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤ —Å —Ü–µ–ª—å—é —É–±–µ–¥–∏—Ç—Å—è —á—Ç–æ –ø–æ–ª–µ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä –≤
–ø—Ä–∏–º–µ—Ä–µ –≤—ã—à–µ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ `port` - —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π number, –∞ –∑–∞—Ç–µ–º - —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è `port` —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è
–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —á–∏—Å–ª–æ–≤–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ TCP –ø–æ—Ä—Ç).

–ö–∞–∫ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –±–æ–ª–µ–µ —Ç–æ–Ω–∫–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è:

```typescript
class DBConfig {
    @ConfigField()
    user!: string;

    @ConfigField()
    password!: string;

    isValid(): boolean {
        return this.password.length > 3;
    }
}

export class MetrikaAppConfig {
    @ConfigField({
        validator: (dbc: DBConfig) => dbc.isValid(),
    })
    dbConfig!: DBConfig;

    @ConfigField({
        validator: password => password.length > 3,
    })
    password!: string;
}
```

–í —Ñ—É–Ω–∫—Ü–∏—é –≤ –∫–∞—á–µ—Å—Ç–≤–µ 1–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–Ω—Å—Ç–∞–Ω—Å –∫–ª–∞—Å—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—è (–ª–∏–±–æ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—è –¥–ª—è —Å–∫–∞–ª—è—Ä–Ω—ã—Ö
—Ç–∏–ø–æ–≤), –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç `true` –∑–Ω–∞—á–∏—Ç –ø–æ–ª–µ –≤–∞–ª–∏–¥–Ω–æ, –µ—Å–ª–∏ `false` - –Ω–µ–≤–∞–ª–∏–¥–Ω–æ.

## –°–ø–æ—Å–æ–±—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ YAML —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–º–µ—Ä–∂–µ–Ω—ã —Å `env.base.yml` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è:

-   `env.production.yml` (–¥–ª—è `production` –æ–∫—Ä—É–∂–µ–Ω–∏—è)
-   `env.development.yml` (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–µ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –≤–µ—Ä—Å–∏–π)

–°–Ω–∞—á–∞–ª–∞ –±–µ—Ä—É—Ç—å—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `env.base.yml` –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–æ–≤ –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
(`env.production.yml`, `env.development.yml`). –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:

üìÇ `env.base.yml`

```yaml
dbConfig:
    user: login
    password: pwd
```

üìÇ `env.production.yml`

```yaml
dbConfig:
    password: killerisjim
```

–ù–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ–º:

```yaml
dbConfig:
    user: login
    password: killerisjim
```

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ YML —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–ø–∏—Å–∞–Ω–Ω—É—é —Ä–∞–Ω–µ–µ –≤ –∫–ª–∞—Å—Å–µ –∫–æ–Ω—Ñ–∏–≥–∞ (e.g. –≤ –∫–ª–∞—Å—Å–µ `MetrikaAppConfig`).

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ó–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ –º–æ–≥—É—Ç –≤–∫–ª—é—á–∞—Ç—å –≤ —Å–µ–±—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```yaml
source:
    url: https://my.url.com/{{SERVICE}}/foo
```

–ß—Ç–æ–±—ã —Ç–∞–∫–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –∑–∞–∫–ª—é—á—ë–Ω–Ω–∞—è –≤ `{{}}`, –±—ã–ª–∞ –∑–∞–º–µ–Ω–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–∏—Å–∞—Ç—å –µ—ë –≤ –∫–ª–∞—Å—Å–µ
–∫–æ–Ω—Ñ–∏–≥–∞:

```typescript
@ConfigField({ envSubstitutionParams: {
    name: 'SERVICE',
    options: ['appmetrica', 'shopper'],
}})
url!: string;
```

–ï—â—ë —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞, –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ —Å—Ö–µ–º—É yaml —Ñ–∞–π–ª–∞,
–Ω–∞–ø—Ä–∏–º–µ—Ä:

```bash
env apiConfig.port=90 npm run start # ...service name
```

–í–∞–∂–Ω–æ: –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –±—É–¥—É—Ç –∏–º–µ—Ç—å —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Ç–∏—Ä–∞—Ç—å –ø–æ–ª—è –≤
–∫–æ–Ω—Ñ–∏–≥–∞—Ö –¥–ª—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (`env.production.yml`, `env.development.yml`), –Ω–∞–ø—Ä–∏–º–µ—Ä:

üìÇ `env.base.yml`

```yaml
dbConfig:
    user: login
    password: pwd
    replicaSet: secondary
```

üìÇ `env.production.yml`

```yaml
dbConfig:
    password: killerisjim
    replicaSet: primary
```

```
env dbConfig.password=secret npm run start
```

–ù–∞ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—É—á–∞–µ–º:

```yaml
dbConfig:
    user: login
    password: secret
    replicaSet: primary
```
