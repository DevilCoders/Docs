## Remote call

Термины
- сервер, нода - среда выполнения кода nodejs
- клиент - среда выполнения кода browser
- сага - saga из redux-saga

Это механизм для написания изоморфных саг (саги, которые могут быть вызваны в браузере или ноде с одинаковым результатом). 

Идея заключается в следующем: во время загрузки страницы отрабатывают какие-то саги, которые загружают начальные данные в стор (список приложений, users, права и т.д.). На страницу можно попасть двумя способами:
- по прямой ссылке (или переход из внешнего сайта)
- по внутренней ссылке 
В первом случае у нас есть возможность отрендерить часть приложения на сервере и отдать пользователю готовый html, так называемый hydrated react tree. 
Во втором случае пользователь уже загрузил часть данных и их можно переиспользовать, при этом отрендерить страницу на клиенте.

В обоих случаях большая часть логики загрузки данных одинакова и её хочется писать только один раз, независимо от среды выполнения. 
Для этого был сделан следующий механизм: 
- для каждой загрузки пишется отдельная сага, например загрузка счётчиков (приложений) 
- Для загрузки данных из апи пишется так называемая операция. Это просто асинхронная функция, которая ходит в апи за данными. Все операции объединяются в одну структуру и передаются в метод [createRpcController](https://github.yandex-team.ru/Metrika/frontend/search?q=createRpcController) 
- Вообще в операции можно пихать любой код, который обязательно должен отработать на ноде
- Операции вызываются с помощью саги [callRemote](callRemote.ts). Эта сага определяет текущую среду исполнения (клиент или сервер) и, в случае клиента, делает ajax запрос к серверу и его результат интерпретирует как результат операции, иначе просто вызывает операцию как асинхронную функцию.
- Для сервера и клиента создаются разные сторы и работают разные саги (например в серверной саге будет доступен в контексте текущий запрос (express.Request) [как это?](https://github.yandex-team.ru/Metrika/frontend/search?q=yield+getContext%28%27req%27%29) )
- Саги клиента и сервера могут вызвать одну и ту же сагу, если в ней
    1. нету обращений к глобальным переменным браузера (window, document и т.д.)
    2. Весь node-specific код оборачивается в операции
- Для того чтобы не загружать данные лишний раз есть утка [remoteData](https://github.yandex-team.ru/Metrika/frontend/search?q=createRemoteDataDuck) и сага [fillDuck](https://github.yandex-team.ru/Metrika/frontend/search?q=fillDuck). fillDuck принимает на вход экземпляр RemoteDataDuck и сагу, и, если ранее не была произведена загрузка данных, выполняет сагу и записывает её результат в утку.