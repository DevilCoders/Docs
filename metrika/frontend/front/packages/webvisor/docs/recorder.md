# Recorder

`Recorder` это класс предназначенный для записи действий пользователя. Он предоставляет универсальный способ
сбора и доставки данных на сервер.

Для обеспечения большей гибкости настроек `Recorder` предоставляет возможность использования middlewares для
кастомизации запросов к серверу и имеет возможность настройки того, какие конкретно действия он будет записывать.

## API

У класса `Recorder` есть 4 основных метода доступных после инициализации класса:

* `start()` – метод для запуска записи или ее возобновления после приостановки
* `stop()`  – метод для полной остановки записи, отвязки всех обработчиков событий и полной очистки кэша
* `pause()` – метод для приостановки записи. после ее возобновления класс гарантирует установку правильных таймстемпов с учетом времени паузы
* `middleware(Function: method)` – метод для добавления новых middleware к классу

## Первый запуск

Сразу после запуска записи `Recorder` отправит на сервер данные о странице и стартовый HTML. Объект, отправленный на сервер, будет выглядеть следующим образом:

* `content` – json-интерпретация DOM дерева на момент начала записи
* `meta`    – объект с дополнительными сведениями о странице
  * `doctype`   – DOCTYPE страницы в виде строки
  * `title`     – заголовок страницы
  * `address`   – полный URL
  * `ua`        – строка UserAgent (`navigator.userAgent`)
  * `referrer`  – реферер, если есть
  * `screen`    – разрешение экрана
    * `width`     – ширина
    * `height`    – высота
  * `viewport`  – размеры вьюпорта с учетом зума страницы
    * `width`     – ширина
    * `height`    – высота
  * `location`  – адрес страницы детально
    * `host`      – хост
    * `protocol`  – схема (http(s))
    * `path`      – путь к странице
  * `initialScroll` – массив, в котором содержится информация о блоках с ненулевым значением прокрутки

## Middleware

Возможность использования middlewares дает возможность контролировать какие данные и в каком виде будут отправлены на сервер.

Выглядит это примерно так:

```javascript
const recorder = new Recorder

recorder.middleware(function(props, next){
  // каким-то образом модифицируем props
  next()
})

recorder.start()
```

`props` это "стандартный" объект `Recorder`'а в котором содержатся следующие поля:

* `url` – URL куда мы отправляем запрос, по умолчанию отправляет все данные на https://webvisor.local/dump
* `headers` – объект заголовков запроса где ключ это имя заголовка, по умолчанию `{'Content-Type' : 'application/json'}`
* `data` – любые данные подходящие для сериализации в JSON (никаких circular data)
* `method` – метод запроса, по умолчанию `POST`

### `data`

В объекте `data` находятся данные о действиях пользователя. Они разделены на две группы:

* `saveHTML`    - `Object`, данные о странице и стартовый HTML. Смотри [Первый запуск](#Первый-запуск "Первый запуск")
* `events` – `Array`, данные о действиях (движения мыши, скролл, фокус и прочее)
* `mutations`   – `Array`, данные об изменении DOM

Каждый из массивов содержит следующие данные:

* `stamp`   – timestamp действия или мутации в миллисекундах. отсчет ведется с момента первого запуска записи
* `target`  – ID элемента над которым произведено действие или мутация. ID присваивается во время индексации DOM
* `type`    – тип действия, либо `mutation`, если это DOM-мутация
* `meta`    – объект с сопроводительной информацией о действии/мутации в зависимости от того, что произошло


