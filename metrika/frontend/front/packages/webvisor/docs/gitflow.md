# Флоу разработки/тестирования

Здесь описан флоу разработки и включения кода данного репозитория в другие репозитории Яндекс.Метрика, в частности репозитории metrika-bem и watch.

![WebVisor2 development flow][logo]

### Термины

| Термин    | Определение
| :-------- | :---
| Метрика   | здесь и далее репозиторий [Metrika/metrika-bem]
| Счетчик   | здесь и далее репозиторий [Metrika/watch]
| Плеер     | часть данного репозитория, отвечающая за воспроизведение записей собранных Счетчиком и Рекордером, встраивается в Метрику как независимый модуль.
| Рекордер  | часть данного репозитория, отвечающая за запись пользовательского поведения на сайтах клиентов Яндекс.Метрики, встраивается в Счетчик как независимый модуль.
| Вебвизор  | общее название данного репозитория

### Разработка и/или отладка

Вебвизор имеет два основных бранча:

| Бранч   | Описание                                                                                         |
| :------ | :----------------------------------------------------------------------------------------------- |
| **master**  | бранч, содержащий стабильный и оттестированный функционал. Прямые коммиты в этот бранч запрещены |
| **develop** | по сути это pre-stable бранч, код, содержащийся здесь, можно выкатывать на production-like стенд |

Весь новый функционал и/или отладка производятся в feature-бранчах. При поступлении задачи на реализацию нового функционала или исправление старого создается новый бранч. Бранч должен наследоваться от актуального кода из develop. Именование бранча производится по данному правилу:

```
[логин на yandex-team].[номер задачи]
```

например:

```
nskryabin.METR-1234
```

## Разработка

* Создание feature-ветки
* Разработка/отладка/исправление
* Pull request
* Merge в `master` и `develop`

### Создание feature-ветки

Все feature-ветки должны наследоватся от свежего `develop`.

``` bash
git checkout develop
git pull
git checkout -b username.METR-XXXXX
Switched to a new branch 'username.METR-XXXXX'
```

Вся разработка ведется в feature-ветке с переодическим обновлением из `develop`.

##### Коммиты в feature-ветки должны быть осмысленными и на русском языке.
##### Названия коммитов вроде  "quickfix" и "wip" не допускаются

### Создание Pull request (PR)

Перед закрытием соответствующего тикета в трекере создается PR в `develop`.

_Создать PR можно и в самом начале разработки, это не имеет значения_

Именование: `[номер задачи]: [имя тикета]`. Например:

| Задача                               | Название ветки      | Название PR                     |
| :----------------------------------- | :------------------ | :------------------------------ |
| https://st.yandex-team.ru/METR-XXXXX | username.METR-XXXXX | METR-XXXXX: Очень важная задача |

---

PR помечается одним или несколькими тегами:

- **\# Core**       – Изменения ядре `src/core`
- **\# Player**     – Изменения пдеере `src/player` и/или `src/ui`
- **\# Recorder**   – Изменения записывающей части `src/recorder`
- **Feature**    – Добавление нового функционала
- **Bugfix**     – Исправление проблем/ошибок в уже существующем функционале
- **Release**    – Специальный тег, которым маркируются релизные PR

Перед закрытием тикета необходимо убедиться, что PR **содержит один коммит со всеми изменениями**

Есть несколько способов сделать это:

- С помощью [скрипта для автоматического сквошинга][autosquash]
- Через `git rebase -i`
- Через `git reset [commit_hash]`.

[Скрипт][autosquash] использует последний метод. По сути, происходит следующее:

Берется последний **[commit hash]** из `develop` и текущий **[branch name]** (ветка, где вы находитесь)

```bash
git reset [commit hash]
git add . -A
git commit -m [user typed commit message]
git push -f origin [branch name]
```

---

С этого момента начинается тестирование. По его окончании тикет будет переведен в статус `beta-tested`.

Изменения в коде ревьювятся коллегами, после успешного прохождения ревью PR попадает обратно в `develop`.

### Merge в `develop`

После успешного тестирования все изменения попадают обратно в `develop`.

Для этого можно как воспользоваться интерфейсом [github.com][pulls].

## Релиз

Релизы, по сути, это ветки, которые имеют последнюю, на момент создания, актуальную кодовую базу.

Релизные ветки **всегда** создаются из актуального `develop`.

После выкатки в продакшн релизные ветки мержаться в `master` и `develop`. При возникновении критических ситуаций откат изменений происходит по ветке `master`, так как она содержит в себе стабильный, оттестированный код.

Релизные ветки именуются следующим образом: `release-[x.y.z]`.

```bash
git fetch origin
git checkout develop
git checkout -b release-1.2.3
# [make your changes]
git add . -A
git commit -m "Release 1.2.3: Обновление версии"
git push origin release-1.2.3
```

Релизные ветки мержатся в `develop` и `master` **после** деплоймента.

Изменения в релизные ветки вносятся через PR, ветки изменений создаются по той же схеме, что и при разработке с той лишь разницей, что они должны наследоваться от релизной ветки, а не от `develop`.

### Взаимодействие с другими репозиториями

В develop ветки Метрики и Счетчика доставляется только код из master бранча Вебвизора для гарании того, что ничего не сломается после очередного релиза.

В feature-бранчи Метрики и Счетчика доставляется код из develop или любых feature-бранчей Вебвизора (на усмотрение разработчика или тестировщика).

В master Вебвизора находится только код, прошедший все этапы тестирования и считающийся стабильным.

Во время сборки релизов Метрики или Счетчика коммиты в master Вебвизора не допускаются (кроме крайних случаев) для избежания попадания в релиз нестабильного кода.

[Metrika/metrika-bem]: /../../../metrika-bem
[Metrika/watch]: /../../../watch
[autosquash]: ./tools/autosquash.md
[pulls]: /../../pulls
[logo]: ./flow.jpg
