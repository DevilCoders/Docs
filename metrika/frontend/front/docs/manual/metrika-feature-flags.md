# Флаги фичей в метрике
1. [Для чего нужны флаги](#для-чего-нужны-флаги)
1. [Админка управления флагами фичей](#админка-управления-флагами-фичей)
1. [Добавление нового флага](#добавление-нового-флага)
1. [Правила включения](#правила-включения)
1. [Хранение флагов](#хранение-флагов)
1. [A/B эксперименты](#ab-эксперименты)
1. [Работа с флагами в беме](#работа-с-флагами-в-беме)
1. [Работа с флагами в реакте](#работа-с-флагами-в-реакте)
1. [Параметры визитов](#параметры-визитов)

### Для чего нужны флаги
* Быстрое включение/выключение новой функциональности без привязки к релизам
* Вливать в develop небольшие куски большой фичи спрятанные за флагом
* Определять логику показа при проведении A/B экспериментов

### Админка управления флагами фичей
Редактировать и добавлять новые флаги можно через админку фичей:
* [Тестовое окружение](https://test.metrika.yandex.ru/admin/features)
* [Продовое окружение](https://metrika.yandex.ru/admin/features)

В админке находится таблица со всеми флагами фичей

![attach-env](https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2014.27.53.png)

Грид таблицы отображает:
* Статус активности флага
* Название флага
* Описание
* Условия показа в виде тегов:
  * `ALL` → Флаг включена на всех
  * `A/B` → Флаг A/B эксперимента
  * `UID` → Флаг включен на список юидов
  * `MY UID` → В списке юидов присутствует текущий uid пользователя
  * `COUNTER` → Флаг включен на список счетчиков
* Контролы:
  * `Включить на мой UID` → Позволяет включить флаг на текущий uid пользователя. Если текущий uid уже присутствует в списке, то кнопка будет заменена на лейбл **Включен на мой UID**
  * ![attach-env](https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2014.36.11.png) → Редактировать флаг
  * ![attach-env](https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2014.36.24.png) → Удалить флаг

### Добавление нового флага
Для добавления нового флага нажимаем на кнопку `Добавить флаг`

![attach-env](https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2014.07.03.png)

В открывшейся форме можем заполнить следующие поля:
* `Название` → Название флага фичи
* `Описание` → Описание флага, следует описать за какую логику отвечает этот флаг и указать ссылку на тикет. Поддерживает markdown
* `Запуск на всех` → Если этот тумблер включен, то все условия включения флага будут сброшены. Флаг включится на всех пользователей
* `A/B` → Флаг А/В эксперимента. При включении тумблера будет учитываться ответ от апи ручки А/В экспериментов
* `Активен` → Статус активности флага. При выключении все условия показа будут проигнорированы, флаг выключится для всех.
* `Пользователи` → Список юидов пользователей для которых флаг будет включен. Поддерживает загрузку csv файла или ручной ввод. Ручной ввод работает как поиск по списку
* `Счетчики` → Список счетчиков для которых включится флага

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2012.53.49.png" width="50%"><img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-12-01%20в%2012.53.59.png" width="50%">

Рекомендуется добавлять флаги, которые по дефолту скрыты, например: isSomeFeatureShown: true | false. В обратном случае, если по каким-то причинам переменная не будет выставлена, есть риск, что пользователи увидят то, что не должны.

Валидация в форме:
* Обязательное поле с названием
* В названии флага должны быть только буквы/цифры без пробелов
* Загружаемый csv файл не должен быть больше 4 мб и 400к элементов в списке
* При выключении тумблера «Запуск на всех» должны быть заданы условия показа (A/B, uid, counter)

### Правила включения
Флаг считается активным для пользователя, если:
* Флаг включен `flag.active === true`
* Нет дополнительных условий показа или одно из них выполняется:
  * Активная группа a/b эксперимента `flag.ab === true` и `apiFlag === true`
  * Флаг включен на текущий uid
  * Флаг включен на текущий counterId

### Хранение флагов
Флаги хранятся в монге, в коллекции **featuresFlags**
Структура документа:
* `active` [Boolean] — статус активности флага (включен/выключен)
* `name` [String] — название флага
* `description` [String] — описание
* `ab` [Boolean] — является флагом А/B эксперимента
* `allowedUidList` [String[]] — список юидов на которые будет включен флаг
* `allowedCounterIdList` [String[]] — список счетчиков на которые будет включен флаг

Т.к. мы используем тестовое и продовое окружение, то и флаги фичей также хранятся в тестовой и продовой монге, которые между собой никак не синхронизируются.
Подробнее о том как подключиться к монгу можно почитать тут → [Metrika MongoDB](https://github.yandex-team.ru/Metrika/frontend/tree/develop/services/metrika#mongodb)

### A/B эксперименты
A/B эксперименты заводятся через [абшницу](https://ab.yandex-team.ru/config/190). Все запуски на списки пользователей / счетчиков нужно проводить через нее, a не через
**allowedUidList** и **allowedCounterIdList** т.к. они предназначен для разработки и тестирования новых фичей.

На каждом ините клиента фронт ходит в апишную ручку `/internal/experiments`, куда передается **counterId**, **uid** и **yandexUid**. Апи достает из абшницы набор флагов экспериментов и отдает фронту.
Если для флага включен тумблер A/B, то мы проверяем что флаг фичи включен и он есть в ответе от АПИ.

### Работа с флагами в беме
Работу с флагами осуществляет блок `BN('i-features-flags')`
Загрузка флагов происходит на ините **i-page** → [BN('i-features-flags').init()](https://github.yandex-team.ru/Metrika/frontend/blob/6a46597f5e87f3519fab28d1e9579a62f8ee4ac0/services/metrika-bem/blocks/inherits/i-page/i-page.priv.js#L65)

* `BN('i-features-flags').getUserFlags()` → список всех активных флагов
* `BN('i-features-flags').get(FLAG_NAME)` → проверка активности флага

Также можно реализовать свой метод для проверки активности флага фичи `BN('i-features-flags').FEATUREIsActive(FLAG_NAME)`

### Работа с флагами в реакте
Работу с флагами осуществляет утка `featuresFlags`

Утка хранит:
* mongoFlags → Флаги фичей которые достали из монги
* apiFlags → Флаги фичей А/В экспериментов, полученные от ручки `/internal/experiments`
* userFlags → Флаг фичей пользователя, которые вычислили на основе **mongoFlags** и **apiFlags**

![attach-env](https://jing.yandex-team.ru/files/maximshilov/image.png)

Статус флага фичи можно получить через селектор `getUserFlag`, но лучше заводить отдельный селектор
[Пример селектора isActiveSupportChatFeature](https://github.yandex-team.ru/Metrika/frontend/blob/165dddb5eed07f603e6800198a0b53e05b9578a4/services/metrika/client/store/ducks/featuresFlagsDuck/selectors.ts#L19)

### Параметры визитов
На каждом ините и SPA переходе, например при переключении счетчиков, происходит отправка параметров визитов `exp → flagName → true`

[Отчет по параметрам визитов](https://metrika.yandex.ru/stat/user_vars?period=month&accuracy=0.1&id=24226447&stateHash=61a7672f08b876000cd697ed)
