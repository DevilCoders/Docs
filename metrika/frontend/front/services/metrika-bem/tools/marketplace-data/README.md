# Здесь лежат данные для маркетплейса

## Введение
Маркетплейс - это пункт меню "Интеграции" у счетчикка метрики
Вроде

https://metrika.yandex.ru/marketplace?id=58975258

Там ты видишь фильтры (наверху) и карточкии интеграций (ниже).
Карточка может принадлежать нескольким фильтрам.
Когда в фильтрах выбран пункт "Все интеграции" - для каждого фильтра показывается некоторое количество принадлежащих ему карточек.
Когда в фильтрах выбран конкретный фильтр - показываются все
катрочки, принадлежащие этому фильтру.

Для каждого фильтра и каждой карточки можно задать комбинацию доменов, на которых фильтр или карточка будет показана -
например ["ru", "com", "com.tr"] или ["ru"].

Кажлый фильтр и каждая карточка может иметь переводы на русский, английский или турецкий языки. Для работы с переводами существует
сервис tanker. Там каждому тексту, который нужно перевести, поставлен
в соответствие уникальный ключ. Переводы фильтров и карточек маркетплейса лежат здесь -

https://tanker-beta.yandex-team.ru/project/metrika-bem/keyset/blocks%3Acommon%3Amarketplace-content?branch=master

Фильтры и карточки хрянятся в mongodb. Мы используем две базы - одна доступна в режиме разработки, другая используется в продакшине. Понятно, что вы сначала меняете данные
маркетплейса в разработческой mongo, показываете тестироващикам, а когда все готово - не забываете заапдейтить их и в продуктовую mongo.

**Танкер и mongodb никак не связаны.** Потому сущетсвуют процедуры внесения новых переводов в танкер и генерации данных для mongo с переводами из танкера.

**Mongo ничего не знает о твоих задачах и ветках в git,** потому будь осторожен когда
тебе заходят несколько задач на изменение данных. Делай их либо в одной ветке, либо последовательно отводя ветку от ветки. Складывай подготовленные данные в services/metrika-bem/migrate и не забудь положить в продуктовую монгу самый полный набор данных перед выездом в прод.

На этом с теорией все. Дальше мы рассмотрим твои действия в разных жизненных ситуациях.

## Жизненные ситуации

## Добавь эти интеграции
И дают список интеграций для добавления. Описание интеграции выглядит как-то так:

- **Название:** Яндекс.Метрика Инспектор
- **Короткое описание:** Яндекс.Метрика Инспектор - бесплатный инструмент.
- **Логотип:** https://lh3.googleusercontent.com/2NnmzOcHgzPuRk8edzTatN0KvsxcJTGY5gxkoIde6lbk22eBGpPpuSlW8-4oPHQ73MjxJBI5ZQ=w128-h128-e365-rj-sc0x00ffffff
- **Ссылка на интеграцию:** https://chrome.google.com/webstore/detail/yandexmetrica-inspector/flmegpkccbbginemfdjllloimekpdkif
- **Ссылка в саппорт:** mailto:antoniolite@gmail.com (может не быть)
- **Фильтры:** Расширения, Быстрый доступ к счетчику, Проверка корректности установки счетчика
- **Яндекс:** да/нет
- **Топовая:** да/нет
- **Без помощи разработчика:** да/нет
- **Домены:** ru, com, com.tr

Обязаны быть название, ссылка на интеграцию, домены и фильтры. Фильтры должны соответсовать тем, что уже есть в сервисе. Если это не так - жалуйся в тикете и проси исправить.

Прежде всего открываешь **services/metrika-bem/tools/marketplace-data/marketplaceFilters**.json. Ищешь фильтры к которым привязана интеграция, выписываешь на бумажку их value -
именно эти value нужно будет указать в поле filters данных интеграции.

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceItems.json**.
И добавляешь айтемы вида:

```
 {
    "title": "Яндекс.Метрика Инспектор",
    "description": "Яндекс.Метрика Инспектор - бесплатный инструмент.",
    "url": "https://chrome.google.com/webstore/detail/yandexmetrica-inspector/flmegpkccbbginemfdjllloimekpdkif",
    "supportUrl": "mailto:antoniolite@gmail.com",
    "filters": ["extension", "fastaccess", "countersetcheck"],
    "disableLogoResize": true,
    "isFeatured": true,
    "isNoDev": false,
    "isYandex": false,
    "domains": ["ru","com"],
    "logo": "data:image/jpeg;base64,....."
   }
```
Здесь важно вот чего:
- disableLogoResize - запрети ресайз если лого меньше 170x96 пикселов.
- isFeatured - "топовая" или нет. Когда показываются все фильтры - в каждом фильтре
показываются прежде всего топовые интеграции.
- isNoDev - "Без помощи разработчика"
- logo - здесь должна быть ссылка на лого так, как оно используется в background-image:url(...). Если файл лежит на яндексовом домене - можно попробовать указать просто ссылку, иначе файл нужно стащить, заенкодить в base64 любым сервисом или утилитой и вставить в виде строки. Это нужно потому, что домены, с которых можно загружать картинки, ограничены CSP ибо нехорошо давать возможность внешним людяи в любой момент менять что-то, что показывает Яндекc.

Для загрузки картинки используй: https://metrika.yandex.ru/admin/image-upload/

Добавил все, что нужно. Теперь иди в services/metrika-bem и запускай
```
npm run i18n:marketplace
```
Эта штука стащит из танкера все переводы, пройдется по твоим файлам с интеграциями и фильтрами и построит данные, которые можно будет влить в монгу.

В консоль будет выведен список ключей и значений, которые, по мнению скрипта, нужно добавить в Танкер. Сделай это.

Готовые для влития в монгу файлы:
```
services/metrika-bem/tools/marketplace-data/i18n/marketplaceFilters.json
services/metrika-bem/tools/marketplace-data/i18n/marketplaceItems.json
```
Теперь ты можешь запустить консоль тестовой монги (если не знаешь как - спроси ребят),
запускать косноль монги нужно из папки `services/metrika-bem`.

И заимпортить данные из файлов:

```
db.marketplaceItems.remove({});db.marketplaceItems.insert(JSON.parse(cat('./tools/marketplace-data/i18n/marketplaceItems.json')));
```
и
```
db.marketplaceFilters.remove({});db.marketplaceFilters.insert(JSON.parse(cat('./tools/marketplace-data/i18n/marketplaceFilters.json')));
```

Имей ввиду, что новые айтемы, для которых еще нет ключей в танкере, будут добавлены
только в русский язык с теми текстами, что ты написал в файле.

Теперь можно создавать директорию "services/metrika-bem/migrate/ID вашего тикета" и копировать туда файлы с данными для монги. С ними автоматически ничего не произойдет, они нужны для истории и чтобы можно было откатить коллекции на предыдущее состояние.

Коммиться, выставляйся на ревью, переводи тикет в Решен, для тестировщиков напиши, что переводы еше не готовы и смотреть можно на русском.

Перевод обычно занимает время. Потому через какое-то время после добавления новых ключей к тебе придут со словами:

### Затащи/обнови/пересобери переводы

Это значит, что какие-то новые переводы готовы. Если у тебя есть незакрытый тикет, в рамках которого ты добавлял переводы - чекаутся на его ветку. Если нету - заведи отдельную задачу.

Иди в services/metrika-bem и запускай
```
npm run i18n:marketplace
```
Сгенерятся готовые для влития в монгу файлы:
```
services/metrika-bem/tools/marketplace-data/i18n/marketplaceFilters.json
services/metrika-bem/tools/marketplace-data/i18n/marketplaceItems.json
```
Запусти консоль тестовой монги (если не знаешь как - спроси ребят) и заимпорти данные из файлов:
```
db.marketplaceItems.remove({});db.marketplaceItems.insert(JSON.parse(cat('./tools/marketplace-data/i18n/marketplaceItems.json')));

db.marketplaceFilters.remove({});db.marketplaceFilters.insert(JSON.parse(cat('./tools/marketplace-data/i18n/marketplaceFilters.json')));
```

Не забудь скопировать файлы монговых данных в "services/metrika-bem/migrate/ID вашего тикета".

Коммиться, выставляйся на ревью, переводи тикет в Решен.

### Поменяй интеграцию

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceItems.json**.
Ищешь нужные тебе айтемы и меняешь у них что там нужно поменять.
Про значения и содержание полей смотри в разделе про добавление интеграции.

Опять же идешь в services/metrika-bem и запускаешь
```
npm run i18n:marketplace
```
Если появляются новые ключи - вносишь их в танкер. Импортируешь файлы в монгу, пегеписываешь их в миграции и т.д. - все, как описано в пункте про добавление интеграции.

### Удали интеграцию

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceItems.json**.
Удаляешь ненужные айтемы.
Снова идешь в services/metrika-bem и запускаешь
```
npm run i18n:marketplace
```
Импортируешь файлы в монгу, пегеписываешь их в миграции и т.д. - все, как описано в пункте про добавление интеграции.

### Добавь фильтры

И дают список фильтров. Описание фильтра выглядит как-то так:

- **Название:** Быстрый доступ к счетчику
- **Домены:** ru, com, com.tr

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceFilters.json**.
И добавляешь айтемы вида:

```
{
  "name": "Быстрый доступ к счетчику",
  "value": "somethinguniq",
  "domains": ["ru", "com", "com.tr"],
  "num": 31
 },
```
Здесь важно вот чего:
- value - придумываешь уникальное значение, лучше что-то осмысленное односложное английское
- num - это порядок, в соответствии с которым фильтры сортируются для показа

Опять же идешь в services/metrika-bem и запускаешь
```
npm run i18n:marketplace
```
Новые ключи вносишь в танкер. Импортируешь файлы в монгу, пегеписываешь их в миграции и т.д. - все, как описано в пункте про добавление интеграции.

### Поменяй фильтры

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceFilters.json**.
Ищешь нужные тебе айтемы и меняешь у них что там нужно поменять.

Снова идешь в services/metrika-bem и запускаешь
```
npm run i18n:marketplace
```
Если появляются новые ключи - вносишь их в танкер. Импортируешь файлы в монгу, пегеписываешь их в миграции и т.д. - все, как описано в пункте про добавление интеграции.

### Удали фильтры

По идее - быть такого не должно. Но как обычно - наверняка это придется сделать именно тебе.
Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceFilters.json**.
Ищешь нужные тебе айтемы, выписываешь на бумажку их value. Удаляешь.

Открываешь **services/metrika-bem/tools/marketplace-data/marketplaceItems.json**.
Из полей filters удаляешь ненужные фильтры. Удаляешь айтемы, непривязанные к фильтрам.

Идешь в services/metrika-bem и запускаешь
```
npm run i18n:marketplace
```
Импортируешь файлы в монгу, пегеписываешь их в миграции и т.д. - все, как описано в пункте про добавление интеграции.

### Выложи на прод

Если все счастливы и готовы выкладыватся на прод - тебе нужно заимпортить данные маркетплейса в продуктовую монгу.

Запустить консоль продуктовой монги (если не знаешь как - спроси ребят) и заимпорти данные из файлов:
```
db.marketplaceItems.remove({});db.marketplaceItems.insert(JSON.parse(cat('путь к миграции/marketplaceItems.json')));

db.marketplaceFilters.remove({});db.marketplaceFilters.insert(JSON.parse(cat('путь к миграции/marketplaceFilters.json')));
```
