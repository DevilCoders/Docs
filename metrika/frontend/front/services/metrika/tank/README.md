# Нагрузочное тестирование
## Тестирование в деплое
1. [Подготовка беты для тестирования](#1-подготовка-беты-для-тестирования)
1. [Подготовка патронов](#2-подготовка-патронов)
1. [Запуск стрельб в лунопарке](#3-запуск-стрельб-в-лунопарке)
1. [Добавление запросов для тестирования](#4-добавление-запросов-для-тестирования)
1. [Ссылки](#5-ссылки)

### 1. Подготовка беты для тестирования
Для проведения нагрузочного тестирования поднимаем бету в деплое, например с помощью таски [METRIKA_FRONTEND_DEVELOPMENT](https://sandbox.yandex-team.ru/tasks?children=false&created=14_days&hidden=false&type=METRIKA_FRONTEND_DEVELOPMENT)

После поднятия стейджа в деплое необходимо выделить больше ресурсов т.к. по дефолту будет `0.3 CPU, ~1.0 GB RAM` на под.
Для тестов увеличиваем ресурсы беты до `2 CPU, 2 GB RAM`

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-08-24%20в%2018.33.22.png" width="50%"><img src="https://jing.yandex-team.ru/files/maximshilov/settings.png" width="50%">

### 2. Подготовка патронов
Тестирование проходит c помощью юлогинов. Список логинов можно достать через `yql`.

- Список логинов → https://yql.yandex-team.ru/Operations/YSUbL9K3DOWpxekWDQceuoOvQ1Kd-2s5BfVFcMq-4Ek=
- Список логинов пользователей у которых от 3х до 10 счетчиков, дял тестирования страницы **list** и ручки **getCounters** → https://yql.yandex-team.ru/Operations/YSQeTAuEI-QKZaqzcu8RGYqUOmHyPxbiS01NEvd3n_I=

Выгружаем список логинов в формате **csv** и сохраняем в локальном файле **logins.txt**

После того как подготовили список логинов, запускаем скрипт генерации патронов

``node generate-ammo.js --host=$host --cookie=$cookie --xsrfToken=$token --device=$device --limit=$limit``
- **$host** → хост беты
- **$token** → xsrf токен, нужен для тестирования **/rpc/** запросов мобильной метрики, копируем из нетворка браузера мобильной метрики
- **$cookie** → куки, копируем из нетворка браузера
- **$device?** → ``mobile`` или ``desktop``, по дефолту патроны будут сгенерированы сразу на оба юзерагента
- **$limit?** → количество патронов, дефолт **1000**

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-08-24%20в%2019.33.32.png">

Патроны будут сгенерированы в `/data/${requestName}-${device}-${timestamp}.ammo.txt`

### 3. Запуск стрельб в лунопарке
В тикете на нагрузочное тестирование выбираем ```Действие → Отправить на нагрузочное тестирование```, после чего будет создана связь с [лунопарком](https://lunapark.yandex-team.ru/)

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-08-24%20в%2019.39.38.png">

После перехода по созданному тикету в лунопарк нажимаем на кнопку «Быть первым»

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-08-24%20в%2019.47.22.png">

Заполняем форму:
- Танк: Хост
- Адрес: адрес **RTC танка**, хост такого танка можно посмотреть на главной странице лунопарка https://lunapark.yandex-team.ru/
- Мишень: **FQDN** из деплоя
- Задача: номер тикета, все стрельбы привязываются к задачам - к задаче в Трекере линкуется ссылка на список всех связанных стрельб в Лунапарке.
- Схема нагрузки: Например, line(1, 20, 60s) const(20, 2m) line(20, 1, 10s),
подробнее https://yandextank.readthedocs.io/en/latest/tutorial.html#first-steps
- URI: не заполняем
- Патроны: Здесь загружаем сгенерированный ранее файл патронов
- Пушка: не используем

Далее, в конфиг под формой можно дописать **writelog: all**.
Тогда по результатам стрельбы будет создан в числе прочего лог отправленных запросов и ответов (файл answ_<hash>.log ), что очень полезно при дебаге правильности настройки стрельбы.

<img src="https://jing.yandex-team.ru/files/maximshilov/Снимок%20экрана%202021-08-24%20в%2019.54.25.png">

По кнопке «**Огонь**» запускаем стрельбы

### 4. Добавление запросов для тестирования
В файле **config.js** указаны заголовки, которые будут выставлены при генерации патронов и запросы в поле **requests**, для которых будут сгенерированы файлы

При добавлении новой ручки или страницы для тестирования, нужно указать:
- name → имя, с которого будет начинаться сгенерированный файл
- path → pathname страницы или ручки
- method → метод запросы ``GET | POST``
- body → тело запроса для POST ручек
- device → тип устройства ``mobile | desktop``, определяет какой юзерагент будет указан при генерации запроса. Если не указаывать, то будут оба

### 5. Ссылки
- [Как запустить простую стрельбу](https://wiki.yandex-team.ru/Load/howto/simple-start/)
- [Yandex Tank](https://yandextank.readthedocs.io/en/latest/)
- [Тестирование в Метрике для Медийной рекламы](https://wiki.yandex-team.ru/JandexMetrika/frontend/MediaMetrika/media-metrika-stress-test/)

