# Что это такое

Assistant Automation — программа, скармливающая голосовым ассистентам конкурентов наборы запросов через имитацию действий пользователя.

# Подготовка к запуску

Вам понадобятся компьютер с *nix-подобной системой и телефон на Android с root доступом

## Настройка ПК

Скачать adb: https://developer.android.com/studio/releases/platform-tools
Установить фриду:
```
npm install -g frida
```

Можно поставить через pip
```
pip install -I frida-tools==9.2.4
```

Версия, с которой работает ~ 14.2.18 (ей соответствует frida-tools:9.2.4), с 15 уже не работает

## Настройка телефона

Поставить собственно приложение ассистента (Сбер Салют или Маруся)
Скорее всего будут полезны приложения музыки, ютуб, карт, переводчика, почты

### Настройка прокси

TODO

### Настройка ускорения отрисовки

Значительно ускоряет прокачку и делает жизнь лучше :)
- Стать разработчиком (Зайти в Настройки → Система → Номер сборки → Тапнуть 5-7 раз)
- Настройки → Система → Для разработчиков → Отрисовка → Длительность анимации, выставить вариант «Без анимации».

## Получение корзины

TODO

### Формат

Корзинка  - zip архив с папкой ```raw```, внутри которой лежат файлы с голосовыми запросами в формате raw
Запрос должен быть моно с sample rate - 16KHz  и encoding - 16Bit (little endian)

Скрипт - список сессий и запросов. Сессии друг от друга отделяются пустой строкой.
Первая строка сессии - это её id, последующие - список запросов, которые нужно выполнить в рамках этой сессии
Пример:
```
ffffffff-ffff-ffff-0005-bf2f457436e0 <имя сессии>
65a1de2982f0502365c8040b0afd99c8.raw <имя файла запроса 1>
<пустая строка>
ffffffff-ffff-ffff-002d-190bda9cdb47__ffffffff-ffff-ffff-7cfe-3562f1364127 <имя сессии>
0c2bb120b4890d8a775a8b6ddde18bbf.raw <имя файла запроса 1>
087043eb6523a0ff1aae4e0b6bcf7e3f.raw <имя файла запроса 2>
```

## Очистка старых данных, загрузка новых

В каталоге `data/`:
```
./prepare_launch.sh
```
(при подключённом телефоне).

Это **удалит старые записи с эмулятора** и загрузит туда новый файл `script.txt`, корзинку `basket.zip` и `frida-server`

# Запуск

Запустить frida-server (предварительно отключив JIT):
```
adb root
adb shell stop
adb shell setprop dalvik.vm.usejit false
adb shell start
adb shell /data/local/tmp/frida-server
```
(Блокирует терминал)

Для Сбера:

```
data/frida_sber.sh
```
(Блокирует терминал)

```
./run_sber.sh
```
(Блокирует терминал)

Для Маруси:
```
data/frida_marusya.sh
```
(Блокирует терминал)

```
./run_marusya.sh
```
(Блокирует терминал)

# Получение результатов

Перейти в каталог `data`. Выполнить скрипт `get-data.sh`:
```
./get_data.sh
```

Очистить данные с телефона:
```
./clear_data.sh
```

## Формат результатов
Результаты будут лежать в папке data/assistantautomation/$ASSISTANT
Для каждого ассистента своя папка (SBER, MARUSYA)

Внутри папки ассистента лежат папки сессий session-$id/ (id берутся из скрипта `script.txt`)

Внутри каждой сессии есть набор файлов:
```query-$num.raw``` - оригинал голсового ответа 16bit 24Khz mono
```query-$num.mp3``` - гологосовой ответ в формате mp3
```query-$num.png``` - скриншот результата (может присутствовать, также, ```query-$num_external.png```, если было открыто стороннее приложение)
```query-$num.txt``` - текстовый диалог
```$num``` - номер запроса в сессии

В текстовом ответе в первой строке написан запрос, затем через строку ответ/ответы. Например:
```
Как дела?

Хорошо. Спасибо, что интересуетесь.
А у вас?
```
Также, в ответах могут присутствоать строки, начинающиеся с ```[```.
Если ассистент не смог распознать запрос, что-то сделал без голосового ответа или произошла какая-то ошибка во время запроса, то в первой строке будет написано такое сообщение:
```[ATTENTION: Голосовой ответ не получен. Возможен некоректный диалог или ответ старого]```
Если в ответе есть не только текст, а картинка или элемент, который мы не смогли распарсить, то одним из ответов будет такая строка:
```[Не текстовый ответ]```

# Дебаг
Если не передается звук в приложение или не считывается оттуда, можно скомпилировать (```frida-compile```) запустить ```data/test_write.js``` или ```data/test_write.js```
Команды запуска для приложения можно посмотретьв ```data/frida_sber.sh``` и ```data/frida_marusya.sh```

Если не нажимается какая-то из кнопок, можно выполнить следующие команды и тогда в лог выведутся объекты с именем, текстом, координатами и отсортированные по координате верхнего левого угла
```
./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=ru.yandex.assistantautomation.AssistantInstrumentedTest#METHOD_NAME
```
```METHOD_NAME``` может быть:
- ```printObjects``` - выведет все объекты
- ```printClickableObjects``` - выведет все кликабельные объекты

Так же можно на примере этих методов написать свой с нужными фильтрами тут в ```app/src/androidTest/java/ru/yandex/assistantautomation/AssistantInstrumentedTest.kt```


# Known issues
- В корзинке не стоит иметь запросы, связанные с таймерами, будильниками и выключением сети
- Если 10 раз мы не смогли получить голосовой ответ, то тесты падают и их надо перезапустить -> решение проблемы выше
- Ответ на динамики не выводится, только в файл
- Сбер плохо реагирует на предзаписанный файл с тишиной, поэтому он слушает с реальных микрофонов, когда тесты ничего не пишут (может услышать что-то). С Марусей таких проблем нет
- Сбер может разлогинить. Для этого в тестах есть проверка на перелогин, а в папке ```data``` можно дописать телефоны и пароли для сбера
- Поддерживается только Сбер и Маруся, но в тестах есть заготовки для Гугла и Алисы
- Сбер сохраняет сессию между перезапусками (помогает отправить слово ```хватит```). Также, сохраняется история - стереть её можно только перелогином.
- Во время прокачки нельзя трогать телефон (нажимать что-то на экране, открывать или закрывать приложения), т.к. UI тесты падают с ошибкой из-за такого
