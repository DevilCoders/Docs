# Обработка ошибок в сервисах

* Статус: Принято
* Ответственные: [coreshock](https://staff.yandex-team.ru/coreshock)
* Дата: 2022-01-10

Тех.история: [Обработка ошибок](https://st.yandex-team.ru/VSAPPS-10121)

## Контекст

После модернизации ошибок сетевого слоя в рамках задачи [Модернизация ошибок](https://st.yandex-team.ru/VSAPPS-9095) возникла потребность в корректной обработке новых ошибок в модулях.

## Причины

* текущий код презентационной логики работает только со старыми ошибками
* выработать стандартный подход к созданию и обработке ошибок
* не увеличивать массово количество ошибок

## Рассматриваемые варианты

* Оборачиваем
* Обогащаем, Пробрасываем
* Обогащаем, Оборачиваем
* Обобщаем, Обогащаем, Пробрасываем
* Обобщаем, Обогащаем, Оборачиваем

## Принятое решение

Выбраны варианты "Обобщаем, Обогащаем, Оборачиваем" и "Оборачиваем", потому что:
* можно понять какие специфичные ошибки выдает сервис
* получаем стандартную ошибку транспортного слоя, которую можно обрабатывать единым образом
* типы из сетевого слоя изолированы внутри сервисного слоя

Вариант "Оборачиваем" является вырожденным вариантом "Обобщаем, Обогащаем, Оборачиваем" для случая когда не требуется ошибка транспортного слоя.

## Плюсы и минусы вариантов

### Оборачиваем

Обрабатываем ошибку сетевого слоя `WebServiceError` и заворачиваем ее в ошибку сервисного слоя, попутно добавляя специфичные для сервиса/запроса кейсы.

```swift
enum ServiceError: Swift.Error {
    case unknown
    case noConnection
    case transferError
    case objectNotFound
    case another
}
```

Хороший, потому что:
* ограничивает скоуп всех возможных вариантов
* типы из сетевого слоя изолированы внутри сервисного слоя

Плохой, потому что:
* в идеале необходимо писать по одному типу ошибки на каждый запрос в каждом сервисе
* требует дополнительной обработки часто встречающихся ошибок (например, "нет сети") сначала в Interactor, затем в Presenter


### Обогащаем, Пробрасываем

Обрабатываем только интересующие нас ошибки сетевого слоя, переносим их в отдельные кейсы сервисной ошибки.

Необработанные кейсы заворачиваем в сетевую ошибку отдельным case.

```swift
enum ServiceError: Swift.Error {
    case unknown
    case objectNotFound
    case another
    case web(WebServiceError)
}
```

Хороший, потому что:
* сетевые ошибки остаются нетронутыми, их можно обрабатывать "как есть"

Плохой, потому что:
* типы из сетевого слоя "протекают" в сервисный слой, создавая неявную зависимость, дропается кэш инкрементальной сборки
* может происходит дублирование кейса одной и той же ошибки: приоритетно – в сервисном кейсе, вторично – в сетевом кейсе


### Обогащаем, Оборачиваем

Обрабатываем только интересующие нас ошибки сетевого слоя, переносим их в отдельные кейсы сервисной ошибки.

Необработанные кейсы заворачиваем в обобщенную транспортную ошибку отдельным case.

```swift
enum TransportError: Swift.Error {
    case unknown
    case noConnection
    case transferError
}

enum ServiceError: Swift.Error {
    case unknown
    case objectNotFound
    case another
    case transport(TransportError)
}
```

Хороший, потому что:
* получаем стандартную ошибку транспортного слоя, которую можно обрабатывать единым образом
* типы из сетевого слоя изолированы внутри сервисного слоя

Плохой, потому что:
* нет понятия "специфичной" ошибки сервиса


### Обобщаем, Обогащаем, Пробрасываем

Обобщенная ошибка сервисного слоя, содержащая в себе специфичную ошибку сервиса и сетевую ошибку.

```swift
enum ServiceError<SpecificError>: Swift.Error where SpecificError: Swift.Error {
    case service(SpecificError)
    case web(WebServiceError)
}

enum OfferSpecificServiceError: Swift.Error {
    case objectNotFound
}

typealias OfferServiceError = ServiceError<OfferSpecificServiceError>
```

Хороший, потому что:
* сетевые ошибки остаются нетронутыми, их можно обрабатывать "как есть"
* можно понять какие специфичные ошибки выдает сервис

Плохой, потому что:
* типы из сетевого слоя "протекают" в сервисный слой, создавая неявную зависимость, дропается кэш инкрементальной сборки
* может происходит дублирование кейса одной и той же ошибки: приоритетно – в сервисном кейсе, вторично – в сетевом кейсе


### Обобщаем, Обогащаем, Оборачиваем

Обобщенная ошибка сервисного слоя, содержащая в себе специфичную ошибку сервиса и обобщенную ошибку транспортного слоя.

```swift
enum TransportError: Swift.Error {
    case unknown
    case noConnection
    case transferError
}

enum ServiceError<SpecificError>: Swift.Error where SpecificError: Swift.Error {
    case service(SpecificError)
    case transport(TransportError)
}

enum OfferSpecificServiceError: Swift.Error {
    case objectNotFound
}

typealias OfferServiceError = ServiceError<OfferSpecificServiceError>
```

Хороший, потому что:
* можно понять какие специфичные ошибки выдает сервис
* получаем стандартную ошибку транспортного слоя, которую можно обрабатывать единым образом
* типы из сетевого слоя изолированы внутри сервисного слоя
