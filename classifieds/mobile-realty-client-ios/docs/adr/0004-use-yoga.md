# Использование Yoga

* Статус: Принято
* Ответственные: [coreshock](https://staff.yandex-team.ru/coreshock)
* Дата: 2020-07-02

Тех.история: [Форма подачи объявления](https://st.yandex-team.ru/VSAPPS-6894)

## Контекст

Форма подачи объявления содержит множество элементов, представляющих собой "коробки-в-коробках".

## Причины

* Требуется легковесное и простое решение для реализации "коробочных" интерфейсов
* В проекте накопилась критическая масса интерфейсов с ручным лейаутом
* Необходима возможность считать лейаут в фоне (для списков)

## Рассматриваемые варианты

* [Yoga](https://github.com/facebook/yoga)
* [YogaKit](https://github.com/facebook/yoga/tree/master/YogaKit)
* [LayoutKit](https://github.com/linkedin/LayoutKit)
* [Render](https://github.com/alexdrone/Render)
* [FlexLayout](https://github.com/layoutBox/FlexLayout)
* [Stretch](https://github.com/vislyhq/stretch)
* Pyramid (собственный порт лейаута из Texture)
* Свое решение поверх существующего
* Свое решение отличное от существующих

### Критерии

* Ограничения: iOS 11, Swift 5
* Работа в фоне
* Стандарт или Стандартное решение
* Производительность
* Покрытие тестами
* Популярность
* CocoaPods-совместим

## Принятое решение

Выбран вариант: "Свое решение поверх существующего (Flekseed)", потому что:
* Произодительный (по сравнению с AutoLayout)
* Качественный (покрыт тестами)
* Готов к использованию
* Может считать в фоне или отдельно от UI
* Подходит под ограничения
* Реализует стандарт

### Позитивные последствия

* Быстрая верстка UI-компонент
* Можно комбинировать результаты подсчета с ручным лейаутом
* Сократит количество кода (по сравнению с ручным лейаутом)

### Негативные последствия

* Непонятная сложность интеграции с AutoLayout и SafeAreaInsets
* Потенциальные, но скорее всего незначительные затраты на поддержку

## Плюсы и минусы вариантов

### Yoga (1.14.0)

https://yogalayout.com/<br/>
https://github.com/facebook/yoga

Хороший, потому что:
* Практически полностью совместим со стандартом [CSS Flexible Box Layout Module Level 1](http://www.w3.org/TR/css3-flexbox/)
* Покрыт тестами
* Можно считать лейаут в фоне
* Ограничения: iOS 8
* Популярный: *13353, Y1075
* Кроссплатформенный: .NET, JavaScript, C

Плохой, потому что:
* Решение негибкое – невозможно создавать свои лейаут-спеки
* Работает поверх Float – будут потери при конвертации в CGFloat/Double
* Ручное управление памятью

### YogaKit (1.18.1)

Extension для UIView с ObjC-оберткой для C-функций Yoga.

Хороший, потому что:
* Решение от разработчиков Yoga

Плохой, потому что:
* Extension для UIView – решение привязано к главному потоку

### LayoutKit (10.1.0)

http://layoutkit.org/<br/>
https://github.com/linkedin/LayoutKit

Хороший, потому что:
* Решение от LinkedIn
* Ограничения: iOS 8
* Популярный: *3086, Y263

Плохой, потому что:
* Решение привязано к главному потоку
* Нестандартизировано (похоже на FlexBox)

### Render (7.0.3)

https://github.com/alexdrone/Render<br/>
Обертка над Yoga, схожая по API с SwiftUI.

Хороший, потому что:
* Мимикрирует под SwiftUI, встраивается в SwiftUI
* Ограничения: iOS 10, Swift 5.1
* Популярный: *2077, Y102

Плохой, потому что:
* Решение привязано к главному потоку
* Нет покрытия тестами
* Толстая обертка в том числе над UIKit
* Objective-C: optional protocols, Class, lightweight generics
* Нет поддержки CocoaPods

### FlexLayout (1.3.20)

https://github.com/layoutBox/FlexLayout<br/>
Декларативная обертка над Yoga.

Хороший, потому что:
* Ограничения: iOS 8, Swift 4.2
* Популярный: *1149, Y106

Плохой, потому что:
* Решение привязано к главному потоку
* Слабое покрытие тестами
* Толстая обертка в том числе над UIKit
* Декларативный

### Stretch (0.3.2)

https://vislyhq.github.io/stretch/<br/>
https://github.com/vislyhq/stretch<br/>
[пример | описание | дополнительная информация | …]

Хороший, потому что:
* Практически полностью совместим со стандартом [CSS Flexible Box Layout Module Level 1](http://www.w3.org/TR/css3-flexbox/)
* Покрыт тестами
* Можно считать лейаут в фоне
* Ограничения: iOS 9.3, Swift 4.2
* Популярный: *1160, Y54
* Кроссплатформенный: Rust, Swift, Kotlin, JavaScript, C
* Поставка статической библиотекой

Плохой, потому что:
* Поставка статической библиотекой
* Перспективный но пока еще редкий язык разработки
* Неизменяемые стили

### Pyramid

Порт лейаут-движка из Texture/AsyncDisplayKit на Swift от [coreshock](staff.yandex-team.ru/coreshock).

Хороший, потому что:
* Ограничения: iOS 8, Swift 5
* Можно считать лейаут в фоне
* Расширяемый

Плохой, потому что:
* Практически не покрыт тестами
* Нестандартизирован (похож на FlexBox)
* Один разработчик

### Свое решение поверх существующего (Flekseed)

Обертка для Yoga.

Хороший, потому что:
* Нет трудозатрат на реализацию ключевого функционала
* Строго типизированный Swift-интерфейс (вместо обобщенного на C)
* Ограничения: iOS 8, Swift 5
* Можно считать лейаут в фоне
* Не меняет поведение библиотеки
* Добавляет слой spec – невидимых контейнеров
* Добавляет spec для удобного Stack-лейаута

Плохой, потому что:
* Может понадобить время на изучение API

### Свое решение отличное от существующих

Написать реализацию какого-нибудь стандарта.

Хороший, потому что:
* Можно избежать любых недостатков других библиотек

Плохой, потому что:
* Большие трудозатраты (предварительно от 1 месяца)

## Ссылки

* Связано с [ADR-0002](0002-collectionviewmodel-binding.md)
