# Реализация выезжающей снизу панели (aka Bottom Sheet)

* Статус: **Принято**
* Ответственные: [Алексей Салангин](https://staff.yandex-team.ru/Salangin)
* Ревьюеры: [Павел Журавлёв](https://staff.yandex-team.ru/pavelcrane) и [Савелий Леонтьев](https://staff.yandex-team.ru/l-saveliy)
* Имплементация: https://github.com/YandexClassifieds/mobile-realty-client-ios/pull/1959
* Дата: 2020-09-09

Тех.история: https://st.yandex-team.ru/VSAPPS-5178

## Контекст

Создать компонент модального отображения контента BottomSheet
#### Обязательно:
1. Плашка с контентом приезжает снизу, одновременно происходит показ полупрозрачного бэкграунда через fade.
1. Плашку можно закрыть через крестик и нажатием на пустую область с фоном
#### Желательно:
1. Закрытие свайпом вниз
1. Плашку можно тянуть вверх. После того, как палец отпущен, она возвращается в дефолтное открытое состояние
1. Обработка показа клавиатуры
1. Хаптик
1. Возможность добавить drag indicator (желательно кастомный)
#### На что посмотреть:
ModalPresentationTransition и его применение в OfferCardRouter для статичного пикера (без свайпа вверх/вниз)
SingleSelectPickerViewController/TableBasedPickerPresentationTransition и их применение для пикера на основе таблицы
#### Ограничения:
1. Хотелось бы иметь возможность интерактивно скрывать клавиатуру, но iOS не предоставляет простого способа это сделать. Один из способов описан в [этой статье](https://medium.com/@superpeteblaze/ios-custom-keyboard-dismissal-with-swift-9b6df2d9cc49). Для нас достаточно будет скрывать клавиатуру без анимации вместе с боттом щитом.
1. Ограниченные ресурсы


## Рассматриваемые варианты

* [Microsoft Drawer](https://github.com/microsoft/fluentui-apple/blob/master/ios/FluentUI/Drawer/DrawerController.swift)
* [Slack PanModal](https://github.com/slackhq/PanModal)
* [FloatingPanel](https://github.com/SCENEE/FloatingPanel)
* [BottomSheet](https://github.com/finn-no/BottomSheet)
* [FittedSheets](https://github.com/gordontucker/FittedSheets)
* [UltraDrawerView](https://github.com/super-ultra/UltraDrawerView)
* Самописный компонент

## Принятое решение

Так как ни один из рассмотренных вариантов не удовлетворяет всем нашим критериям, то было решено разработать решение на основе одного из фреймворков.
Был выбран фреймворк **Microsoft Drawer**, потому что:
* Удовлетворяет всем обязательным требованиям и практически всем необязательным
* Минимальные трудозатраты на доработку (по сравнению с остальными решениями)
* Относительно простая поддержка кода
* Нет зависимости от сторонних фреймворков

### Позитивные последствия
* Полный контроль над кодом и лёгкая кастомизация (путём изменения исходного кода компонента)
* Высокое качество кода

### Негативные последствия
* Собственная поддержка выбранного решения
* Возможно потребуется реализовать дополнительные resizingBehavior, например, для неинтерактивного дисмиса (на экранах с клавиатурой)), а также реализовать возможность тянуть плашку вверх на экранах с выключённым resizing (опять же для экранов с клавиатурой)
* Необходимо будет самостоятельно добавить haptic

## Плюсы и минусы вариантов

### Microsoft Drawer
375 ⭐️

Хороший, потому что:
* Умеет адаптироваться под клавиатуру
* Стабильный, используется в таких приложениях как Word, Excel, Powerpoint
* Нет необходимости изменять код презентуемого вью контроллера
* Можно презентовать как вью контроллер, так и отдельный вью
* Учитывается prefferedContentSize

Плохой, потому что:
* Нельзя затянуть как Pod отдельно от всей библиотеки компонентов Microsoft.
* Нет haptic

Оценка: 8/10

### Slack PanModal
An elegant and highly customizable presentation API for constructing bottom sheet modals on iOS.  
2566 ⭐️

Хороший, потому что:
* Лаконичный и кастомизируемый код
* Есть документация
* Приятные spring-анимации
* Есть haptic feedback
* Есть drag indicactor

Плохой, потому что:
* Не адаптируется под клавиатур
* Конфигурация происходит через поля в презентуемом вью контроллере (необходимо имплементировать протокол). Это не очень удобно, когда нужно уметь показывать один  и тот же экран с разными стилями.
* У drag indicator можно настроить только цвет и видимость (нельзя менять форму и позицию)
* Нет колбэка на начало скролла
* Есть 2 состояния: long и short. Если выбрать только short (как нам необходимо на большинстве экранов, например, на экране промо), то тянуть вверх уже нельзя.

Оценка: 8/10

### FloatingPanel
A clean and easy-to-use floating panel UI component for iOS.  
3827 ⭐️

Хороший, потому что:
* Приятные spring-анимации
* Хорошая документация

Плохой, потому что:
* Не адаптируется под клавиатуру 

Оценка: 7/10

### BottomSheet
Custom modal presentation style for thumb-friendly interactive views.  
52 ⭐️

Хороший, потому что:
* Приятные spring-анимации
* Поддерживает навигацию внутри bottom sheet

Плохой, потому что:
* Плохо кастомизируется
* Не адаптируется под клавиатуру 

Оценка: 6/10

### FittedSheets
443 ⭐️

Хороший, потому что:
* Хорошо кастомизируется
* Поддерживает навигацию внутри bottom sheet
* Умеет адаптироваться под клавиатуру

Плохой, потому что:
* Нет bounce-анимации на показ bottom sheet
* Слишком резкий жест закрытия свайпом вниз (не регулируется)
* Странный эффект димминга (некритично)
* В консоль сыпятся ошибки типа `Unbalanced calls to begin/end appearance transitions for <FittedSheets.SheetViewController: 0x1178b6200>.`

Оценка: 8/10

### UltraDrawerView
58 ⭐️

Хороший, потому что:
* Есть [статья на медиуме](https://medium.com/yandex-maps-mobile/вытягивающаяся-карточка-bc2dac091e72)

Плохой, потому что:
* Использует сторонние зависимости (POP)
* Не поддерживает динамическую высоту контента (есть всего 4 состояния)
* Плохо кастомизируется
* Не адаптируется под клавиатуру 

Оценка: 5/10

### Самописный компонент

Хороший, потому что:
* Удовлетворены все требования
* Высокое погружение в код

Плохой, потому что:
* Большие трудозатраты (от 1,5 недель)
