# Сокет для чатов

* Статус: Принята
* Ответственные: [l-saveliy](https://staff.yandex-team.ru/l-saveliy)
* Дата: 2020-09-07

Тех.история: [Чаты с техподдержкой](https://st.yandex-team.ru/VSAPPS-5751)

## Контекст

Входящие сообщения чатов получаем через веб-сокет. Требуется получать сообщения от сервера, включать и выключать сокет по необходимости

## Рассматриваемые варианты

* [Starscream](https://github.com/daltoniam/Starscream)
* [socket.io-client-swift](https://github.com/socketio/socket.io-client-swift)
* [SocketRocket](https://github.com/facebookarchive/SocketRocket)

## Принятое решение

Выбран вариант: "Starscream", потому что:
* Полностью решает текущую задачу
* Удобное апи
* Авто использует это же решение и была возможность сравнить подходы

## Плюсы и минусы вариантов

### socket.io-client-swift

Хороший, потому что можно использовать в Objective-C. Но плохой, потому что не очень удобен в использовании.

### SocketRocket

Отказался от использования, так как написан на Objective-C и в текущий момент репозиторий заархивирован.

# Принципы работы сокета

## Жизненный цикл сокета

* Включаем сокет без задержек при входе на экран списка чатов или конкретного чата
* При выходе с чатов запускаем таймер на 20 секунд, после чего выключаем сокет
* При уходе в бэкграунд выключаем сокет без задержек, если был включен

## Описание алгоритма поддержания соединения сокета

За работу чат сокета ответственен `ChatsServiceSocketAgent`. Для определения необходимости включения сокета используется счетчик "владельцев" сокета. Если он не равен нулю, то включаем сокет, иначе запускаем таймер на выключение.

В процессе работы сокета может произойти разрыв соединения по различным причинам. Для предотвращения этого заводим флажок `isSocketAlive`. Бэк шлет через сокет различные события, в том числе `ping`, который приходит раз в минуту. Каждое такое событие означает, что сокет работает, и мы выставляем флажок `isSocketAlive = true`.

При включении сокета запускаем повторяющийся таймер на 2 минуты `keepSocketAliveTimer`. Каждый тик такого таймера мы смотрим на флажок `isSocketAlive`. Если он равен `true`, значит за последние две минуты сокет был жив, и мы  выставляем `isSocketAlive = false`, чтобы проверить сокет на следующей итерации. Если же флажок равен `false`, значит за предыдущие две минуты ни одного события от сокета не поступило и его следует перезапустить.

# Ссылки
* @l-saveliy: Сделать описание взаимодействий классов `YREChatsModule` и добавить ссылку сюда https://st.yandex-team.ru/VSAPPS-7311
