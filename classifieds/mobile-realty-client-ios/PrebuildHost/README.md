# Prebuild Host

## Что это
Хост-проект (workspace в директории `PrebuildHost` в корне репозитория) для предсборки зависимостей.

## Почему
Основной проект очень сильно разросся и время как локальной сборки, так и сборки на CI-сервере занимает достаточно много времени.

## Зачем это нужно
Ускорить цикл "edit-compile-run" при разработке новых фич, уменьшить время компиляции сборок для тестирования и релиза, уменьшить время сборки для прогона тестов.

## Как пользоваться

### Общая информация
Воркспейс не содержит в себе никакого вспомогательного кода и нужен только в качестве хост-проекта для Pod-проекта.

Существуют три базовых типа бинарных сборок библиотек (для iOS):
* статическая библиотека (libPackage.a + заголовки)
* динамический фреймворк (чаще всего это Package.framework, включающий в себя бинарный файл, заголовки и ресурсы)
* статический фреймворк (то же, что и динамический, только в качестве бинарного файла используется переименованная статическая библиотека)

В чистом виде все они включают в себя только одну архитектуру.

Чтобы исключить необходимость настройки подстановки персональной бинарной библиотеки под каждую архитектуру, средствами SDK реализована поддержка так называемых fat-binary – бинарных файлов, включающих в себя несколько архитектур.

С выходом Xcode 11 был разработан новый формат – XCFramework.<br/>
Он представляет из себя агрегат из статических или динамических фреймворков, или статических библиотек.

### CocoaPods
Начиная с CocoaPods версии 1.9, была добавлена поддержка XCFramework в качестве vendor framework (поставляемый с Podspec), а также возможность собирать статические фреймворки вместо динамических (добавленных еще в версии 0.36).

### Surmagic
Для получения xcframework из нескольких framework используется модифицированный swift-script Surmagic.<br/>
Он собирает фреймворки под каждую платформу и потом формирует из них xcframework.
Он переписан на Combine, в него добавлен флаг `BUILD_LIBRARY_FOR_DISTRIBUTION=YES` для генерации swiftinterface.

### Step-by-step
В Podfile есть два закомменченных варианта сборки зависимостей: `use_frameworks! :linkage => :static` и `use_frameworks!`.<br/>
Под каждый из них есть список подов, которые можно предсобирать тем или иным способом.

Все модифицированные podspec'и должны оставаться в директории `Podspecs` для понимания что было изменено в оригинальной версии.

### Сборка Objective-C static framework
Рассмотрим на примере `geos`.

Переводим `Podfile` в `use_frameworks! :linkage => :static`.<br/>
Делаем `pod install`.

Открываем `Surmagic/Surfile`.<br/>
Меняем значение `framework` на название модуля (`geos`, его импортируем в коде, он станет названием фреймворка).<br/>
Меняем значение всех `targets.scheme` на название таргета (`geos`).<br/>

В директории хост-проекта вызываем `bin/surmagic`.<br/>
После сборки откроется директория с `geos.xcframework`.

В каждую `ios-.../geos.framework/Headers` нужно скопировать `Pods/geos/include/geos.h` и `Pods/geos/include/geos`.<br/>
Дело в том, что C++ заголовки не входят в поставку `geos`.

### Сборка Swift static framework
Рассмотрим на примере `lottie-ios`.

Переводим `Podfile` в `use_frameworks! :linkage => :static`.<br/>
Делаем `pod install`.

Открываем `Surmagic/Surfile`.<br/>
Меняем значение `framework` на название модуля (`Lottie`, его импортируем в коде, он станет названием фреймворка).<br/>
Меняем значение всех `targets.scheme` на название таргета (`lottie-ios`).<br/>

В директории хост-проекта вызываем `bin/surmagic`.<br/>
После сборки откроется директория с `Lottie.xcframework`.

### Сборка Swift dynamic framework
Рассмотрим на примере `Chatto`.

Переводим `Podfile` в `use_frameworks!`.<br/>
Делаем `pod install`.

Открываем `Surmagic/Surfile`.<br/>
Меняем значение `framework` на название модуля (`Chatto`, его импортируем в коде, он станет названием фреймворка).<br/>
Меняем значение всех `targets.scheme` на название таргета (`Chatto`).<br/>

В директории хост-проекта вызываем `bin/surmagic`.<br/>
После сборки откроется директория с `Chatto.xcframework`.

### Подготовка Podspec
Рассмотрим на примере `geos`.

Копируем базовый Podspec (из папки `Podspecs` или репозитория где он лежит).

Удаляем из него `module_name`, `requires_arc`, `compiler_flags`, `prepare_command`, `source_files`, `exclude_files`, `preserve_paths`, `public_header_files`, `pod_target_xcconfig`, `user_target_xcconfig`.

Добавляем
```ruby
s.ios.vendored_frameworks = [
  'geos.xcframework',
]
```

Копируем из официального репозитория файл с лицензией с названием из поля `license.file`.

Укладываем все это в подпапку `geos` в `_Prebuilt` в корне репозитория.
Примерная структура корневой директории:
```
_Prebuilt
    geos
        COPYING
        geos.podspec
        geos.xcframework
    yoga
        LICENSE
        Yoga.podspec
        yoga.xcframework
Podspecs
    CardIO.podspec
    OpenCombineCocoa.podspec
Vendor
    ThreatMetrix
        ThreatMetrix.podspec
        TMXProfiling.framework
        TMXProfilingConnections.framework
```

Необходимо удалить `Pods/geos`. CocoaPods туповат чтобы понять, что пора удалять исходники после замены на бинарник.

Не забываем удалить версию пода во всех зависимостях, а также кастомые podspec из папки `Podspecs` в корне репозитория.

В Git LFS необходимо добавить pattern вида `_Prebuilt/**/geos.xcframework/**/geos.framework/geos`.

## Q/A

Q: Почему это так сложно?<br/>
A: Пока физически нет возможности автоматизировать процесс с помощью скриптов или плагина. Есть сложности с автоматизацией переключения статических/динамических фреймворков, а также разностью именования таргетов и модулей.
