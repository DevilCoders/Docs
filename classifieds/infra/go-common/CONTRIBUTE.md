# go-common

Здравствуй, контрибутор! 

Изменения, не соответствующие данным договоренностям, будут жестоко закомментированы, а автор подвергнут гонениям. Шутка...

Ключевая цель внутренних библиотек это удобство, простота использования и однотипность. Поэтому к реализации предъявляются жесткие требования.

## Требования к библиотеке

Библиотекой считается директория в плоской структуре репозитории `go-common`. Она должна быть вписана в [readme.md](README.md)

### Обязательное содержание

- `go.mod` с указанием `module`
- тесты на функциональность
- `README.md` в котором описывается единственно верный вариант использования
  - Description
  - How to use (Fast start)
  - Options с примером и описанием каждой опции
  - Переменные окружения, которые используются для инициализации и работы
- предоставляемый интерфейс и структуры в корне библиотеки для работы в коде, взаимодействия между другими библиотеками и реализации моков
- `example_test.go` с примером кода и описанием
- `vendor` для работы тестов

### Инициализация

Если библиотека использует собственные переменные окружения, то они должны начинаться с `COMMON_`

Инициализации библиотек могу выглядеть следующим образом:

- Простая: `func NewComponent() libInterface {...}`
- С ошибкой: `func NewComponent() (libInterface, error) {...}`
- С зависимостями: `func NewComponent(log log.Log, c conf.Conf) libInterface {...}`
- С параметрами: `func NewComponent(strParam string, intParama int) libInterface {...}`, по возможности нужно иметь дефолты, которые заменяются опциями 
- С опциями: `func NewComponent(options ...Option) libInterface {...}`
- Тлен: `func NewComponent(log log.Log, c conf.Conf, token string, options ...Option) (libInterface, error) {...}`
- Оптимальный тлен:
  - `func NewComponent(options ...Option) (libInterface, error) {...}`
  - опция `WithLog` (дефолтно без логирования)
  - опция `WithConf` (дефолтно `os.getEnv`)
  - параметры имеют дефолты и переопределяются опциями  
  - параметры без возможности дефолта могу быть переданы через ENV `COMMON_?_TOKEN` и явно через опцию `WithToken`

Ограничения:
1. Если библиотека представляет собой вспомогательный код (например, [retry](go-common/retry)), то она может содержать используемые методы внутри `go-common/lib`
2. Если библиотека использует в качестве основы внешнюю зависимость (например, [conf](go-common/conf)), то инициация должна быть в директории с адаптером `go-common/lib/external_lib`. 
   Тем самым инициализация происходит явно и при изменении достаточно будет изменить только вызов метода Init() в main без изменения остального кода проекта. 

### Опционально

- Если предоставляются глобальные методы для упрощенной работы, они должны находиться в основной директории `go-common/lib/global.go`.
Однако рекомендуемый способ для работы - DI, поэтому по возможности лучше избегать этого.

## Взаимодействию библиотек и зависимости

1. Если есть потребность в функциональности из другой библиотеки, то ее интерфейс должен быть явно передан через конструктор
3. Если в go-common отсутствует нужная библиотека, то используется внешняя зависимость. Их количество должно стремиться к минимуму.

## Обратная совместимость

Все изменения должны быть обратно совместимы. Иначе следует объявить новую версию.

## Тесты

Для включения тестов нужно добавить проект в `.github/workflows/tests.yml` в список проектов
```yaml
...
  - project: lib
...
```