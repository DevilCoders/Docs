## О скрипте

Скрипт juggler-config-generation.py автоматизирует обновление файлов с Juggler checks, описывающих текущие мониторинги в Juggler. Генератор запускается по триггеру в Teamcity при обновлении директории с Prometheus alerts. В алертах вручную прописывают желаемую проверку и указывают мета-информацию. В комментариях нужно указывать свойство call_on weekend:

```
# meta: call_on_weekend: True
```

По умолчанию call_on_weekend выставится в False.

Prometheus alerts хранятся тут: https://github.com/YandexClassifieds/vertis-ansible/tree/master/roles/prometheus/files/stable/etc/prometheus/alerts

Juggler checks хранятся тут: https://github.com/YandexClassifieds/ansible-juggler-configs/tree/master/services

Сборка tc здесь: https://github.com/YandexClassifieds/admin-utils/tree/master/juggler-config-generation


## Пример

Пусть мы изменили Prometheus checks и указали call_on_weekend:

<pre><code>
# Alerts when too few (<1) hub-api instances available for a short time
# meta: call_on_weekend: False
ALERT HubApi_TooFewInstancesShort
  IF sum(up{job="hub-api"}) < 1
  FOR 2m
  LABELS {
    job = "hub-api"
  }
  ANNOTATIONS {
    summary = "Hub-Api: Too few instances alive",
    description = "Alive {{ .Value }} < 2 instances for more than 2 minutes."
  }

<b># Alert doesn't make sense, just for the example
# meta: call_on_weekend: True
ALERT HubApi_TooMuchHeahUsage
  IF sum(up{job="hub-api"}) < 1
  FOR 2m
  LABELS {
    job = "hub-api"
  }
  ANNOTATIONS {
    summary = "Hub-Api: Too few instances alive",
    description = "Alive {{ .Value }} < 2 instances for more than 2 minutes."
  }</b>
</code></pre>

Тогда в файл с Juggler checks добавится то, что выделено жирным:

<pre><code>
- connection: local
  gather_facts: false
  hosts: localhost
  post_tasks:
  - {include: tasks/cleanup.yml}
  pre_tasks:
  - {juggler_facts: 'jserver_api={{ jserver_api }}'}
  tasks:
  - {include: tasks/basic-new-test.yml}
  vars:
    checks:
    - env:
      - group: [CGROUP%vertis_meta_prometheus_prod]
        limits: {call_on_weekend: false}
        name: stable
        unreach_checks: '{{ prod_unreach_check }}'
      name: HubApi_TooFewInstancesShort
    <b>- env:
      - group: [CGROUP%vertis_meta_prometheus_prod]
        limits: {call_on_weekend: true}
        name: stable
        unreach_checks: '{{ prod_unreach_check }}'
      name: HubApi_TooMuchHeapUsage</b>
    def_crit_limit: '0'
    service_name: vertis-hub
</code></pre>

Если для файла с алертами нет подходящего Juggler-файла ни в services, ни в services-for-devs, то создастся новый файл с проверками.

## Как это работает
- Из директории c Prometheus alerts достаются все сервисы и их alerts
- Из директории с Juggler checks достаются все сервисы и их checks, а также dev-сервисы
- Для каждого файлика с promtheus alerts:
  * Ищется соответствующий файлик с juggler checks
  * Если он из services-for-devs, файл пропускается.
  * Если есть соответствующий в services, то достаются все новые алерты (которые есть в prometheus alerts-файлах, но нет в juggler checks) для каждого нового алерта добавляется соответствующая проверка
  * Если нет соответствующего, то создается новый Juggler-файл
  * Новый/обновленный файл с Juggler checks коммитится в ansible-juggler-configs в новую ветку juggler-config-autogenerated-checks-(date+time)
- Создается pull request в ansible-juggler-configs из ветки juggler-config-autogenerated-checks-(date + time) в master
