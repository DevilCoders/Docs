## Общее

Назначение проекта – предоставить единое апи над всеми бекендами auto.ru.
Клиентами являются мобильные приложения, десктоп приложения(node.js),
а также внешние клиенты(партнеры/дилеры).


## Структура проекта
Проект состоит из 4 модулей
  * api-model - protobuf модель
  * api-testkit - утилиты для тестирования
  * api-core - общий код, здесь же лежат клиенты для внешних сервисов
  * api-server – http api

### Логическое разделение
Кроме модулей, проект также делится на 3 уровня:
  * http клиенты – лежат в api-core, в пакете `ru.auto.api.services`.
    Представляют из себя простые классы для доступа к внешним сервисам.
    Не содержат никакой бизнес логики.
    Их задача – правильно задать запрос и распарсить ответ.
  * менеджеры – лежат в api-core в пакете `ru.auto.api.managers`.
    Являются прослойкой между http и внешними сервисами.
    Содержат всю бизнес логику – какие делать запросы в бекенды, как интерпретировать ответы.
  * хендлеры – лежат в api-server в пакете `ru.auto.api.routes`.
    Задача – распарсить запрос, и передать управление в нужный "менеджер".
    В текущий момент в хендлерах также осуществляется проверка прав доступа.

## Model
Большая часть модели генерируется из protobuf'а.
При ответе в http api, модель отдается в сериализованом протобафом формате as-is,
либо конвертируется в json по описаным здесь правилам (https://developers.google.com/protocol-buffers/docs/proto3#json)

### Обратная совместимость
При изменении модели следует руководствоваться документацией google'а
по обратной совместимости:
https://developers.google.com/protocol-buffers/docs/proto3#updating

Помимо этого также запрещено переименовывать поля, т.к. они 1 в 1 отображаются в JSON.

### Style
Для передачи даты со временем следует использовать тип `google.protobuf.Timestamp`;

Для передачи даты без времени следует использовать тип string, имя должно оканчиваться на `_date` а в значении лежать дата в ISO формате (пример: `2018-10-22`)

Существующие поля нарушающие данные правила, ради обратной совместимости следует оставить как есть.

### Аннотации
Поля в модели можно аннотировать, чтобы помочь сгенерированной документации.

Пример:
```
message Pagination {
    required int32 page = 1 [(example) = "1", (description) = "Текущая страница (начиная с 1)"];
    required int32 page_size = 2 [(example) = "10", (description) = "Размер страницы"];
    required int32 total_offers_count = 3 [(example) = "1", (description) = "Общее число объявлений на всех страницах"];
    required int32 total_page_count = 4 [(example) = "1", (description) = "Число доступных страниц"];
}
```

## HTTP-api

### Style
Сегменты урлов именуются в `dash-case` (например, `/login-or-register`)

Имена параметров именуются в `snake_case` (например, `super_gen`, `page_size`)

### Swagger

Гранты которые требует ручка должны быть отражены в OAuth scopes документации.

TODO


## Написание тестов

Для написания тестов создан набор базовых классов, от которых следует наследоваться.

Базовый класс – `ru.auto.api.BaseSpec`.
Его следует использовать если иное не подходит.

При тестировании Handler'ов следует использовать `ru.auto.api.ApiSpec`

Для тестирования http-клиентов к внешним сервисам следует использовать `ru.auto.api.services.HttpClientSpec`
и обогатить его httpClient'ом, например из `ru.auto.api.services.MockedHttpClient`