# Процесс работы над задачей

## Бэклог
Как таск-трекер мы используем Стартрек (он же - Яндекс.Трекер). Наша очередь [VSIF](https://st.yandex-team.ru/VSIF), основная доска задач - https://st.yandex-team.ru/agile/board/7375

Любая задача имеет ключ **ИМЯОЧЕРЕДИ-123**, его мы используем как имя ветки, а также применяем в качестве части заголовка PR. Задача берётся в работу нажатием соответствующей кнопки, после чего нажавший становится её исполнителем:
![в работу](./images/contribution-take-task.png)

![в работу](./images/contribution-responsive.png)

## Работа с ветками
Например: имя ветки - TICKET-123, название тикета - "TICKET-123: Правки чего-то там и чего-то еще".
Запускаем нужный проект (уточнить момент). Вносим правки. Переходим в ветку:
```
git checkout -b TICKET-123
```
Фиксируем изменения:
```
git add -p # в интерактивном режиме y/n добавляем изменения к коммиту
git commit -m "увеличила размер шрифта в заголовке промо страницы" # минимальные глагол + существительное
git push --set-upstream origin TICKET-123
```
Теперь переходим в интерфейс GitHub, на вкладке с пулл-реквестами добавляете новый, заголовком указываем имя задачи (в нашем случае TICKET-123: Правки чего-то там и чего-то еще).

## Сборка в teamcity и демостенды
Для сборки артефактов мы используем [TeamCity](https://t.vertis.yandex-team.ru/project.html?projectId=internal). Когда вы откроете пулл реквест, автоматика поднимет т.н. демостенд, на котором автор задачи (или исполнитель) сможет проверить правильность реализации.

Сборка будет завершена примерно в течение 15-20 минут, после ещё через пару минут поднимается тестовый инстанс, имя инстанса генерируется по имени проекта и имени ветки.
Для ветки TICKET-123 и проекта moderation-www ссылка будет иметь вид https://branch-ticket-123.moderation.test.vertis.yandex-team.ru.
Точную ссылку на демостенд  можно найти в задаче.
![stand](./images/contribution-demo-stand.png)

За процессом сборки можно наблюдать в интерфейсе [TeamCity](https://t.vertis.yandex-team.ru/project.html?projectId=internal)
![tc building](./images/contribution-tc-building.png)

За поднятием демостенда можно наблюдать на странице деплоя сервиса - [admin-www](https://admin.vertis.yandex-team.ru/services). Достаточно в поиске ввести имя проекта и перейти на страницу деплоя - тут в левой колонке мы увидим наш поднимающийся демостенд:
![shiva deploy](./images/contribution-shiva-deploy.png)

## Проверка результатов задачи
Когда демостенд поднят, задачу при необходимости проверки следуюет перевести в статус "проверяется". Для этого в трекере кликаем на ![ready for review](./images/contribution-ready-for-review.png)
В открывшемся окне, в поле "нужен ответ от пользователя", указываем имя автора задачи и при необходимости уточняем комментарием, где и как следует проверить реализацию.

## Ревью
Параллельно с тестированием, каждый PR проходит обязательную проверку кодовой базой другими участниками команды - Ревью. Для этого, когда код готов к проверке призываем участников через интерфейс github ![review request](./images/contribution-review-request.png)

У нас есть team в Гитхабе и именем VSIF, призыв которой призовёт в ревью сразу всю команду:
![review request](./images/contribution-review-request-team.png)
Правим замечания, комментарии с припиской nit исправляем на свое усмотрение (nit: это рекомендации которые не обязательно исправлять). Если правки затрагивают функционал - дожидаемся обновления демостенда и дополнительно уведомляем проверяющего.

## Релиз
Когда мы получили хотя бы 1 апрув при ревью, а также получили "Готово к релизу!" в комментариях задачи от проверяющего (при необходимости проверки), мы начинаем процесс деплоя. Мы делаем микро-релизы под каждую задачу, сразу после подтверждений проверяющих. Для этого:

1. В интерфейсе github. **Сквошим** и пушим в мастер
   ![review request](./images/contribution-squash-merge.png)
   Обязательно именем коммита делаем имя задачи (по умолчанию так и будет стоять, если правильно указали имя PR).
2. После того, как ПР влили в мастер, сборка общего тестинга пройдет автоматически. Когда общий тестинг будет поднят (+-15 минут)m следует перейти на страницу сервиса в интерфейсе [деплоя](https://admin.vertis.yandex-team.ru/services) и кликнуть на кнопку promote сниппета, подписанного как test. Так мы инициируем процесс релиза. Аналогичную кнопку можно нажимать в [телеграм-боте](https://docs.yandex-team.ru/classifieds-infra/deploy/telegram-bot).
3. После окончания процесса промоута (выкатывания релиза в прод) переходим в трекер и закрываем задачу (тикет) со статусом "Решён".

## FAQ
- **Где посмотреть версию деплоя в teamcity?**
  Кликаем на Build log около последний сборки тестинга (вы же её сделали, да?):
  ![tc build log](./images/contribution-tc-build-log.jpg)
  Раскрываем шаг docker-autorelease:
  ![tc docker autorelease step](./images/contribution-tc-docker-autorelease.jpg)
  Находим DOCKER_VERSION:
  ![tc docker autorelease step](./images/contribution-tc-docker-version.jpg)


- **Как посмотреть что на машинке в докере, после сборки в teamcity?**
  Во вкладке Overview нажать на хост машинки в поле Agent:
  ![tc host](./images/contribution-tc-host.jpg)
  Скопировать Hostname:
  ![tc hostname](./images/contribution-tc-hostname.jpg)
  Подключится к машинке по ssh и перейти в директорию, которую можно найти в логе сборки:
  ![tc build dir](./images/contribution-tc-build-dir.jpg)
  ![tc build dir content](./images/contribution-tc-build-dir-content.jpg)

