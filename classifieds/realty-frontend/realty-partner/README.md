# realty-front-partner
- [realty-front-partner](#realty-front-partner)
  - [Запуск проекта](#запуск-проекта)
    - [Blackbox-mimino](#blackbox-mimino)
  - [Зачем нужен этот сервис](#зачем-нужен-этот-сервис)
  - [Разделы партнёрки](#разделы-партнёрки)
    - [Объекты (ЖК или КП)](#объекты-жк-или-кп)
    - [Звонки](#звонки)
    - [Звонки в новой партнёрке](#звонки-в-новой-партнёрке)
    - [Чаты (новая партнёрка)](#чаты-новая-партнёрка)
    - [Финансы](#финансы)
  - [Старая / новая партнёрки](#старая--новая-партнёрки)
    - [Точки соприкосновения](#точки-соприкосновения)
  - [Сущности и роли партнёрки](#сущности-и-роли-партнёрки)
    - [Рекламная кампания / campaign / РК](#рекламная-кампания--campaign--рк)
    - [Клиент / client](#клиент--client)
    - [(Рекламное) агентство / agency / РА](#рекламное-агентство--agency--ра)
    - [Админ](#админ)
      - [Дополнительные права (в сравнении с агентством)](#дополнительные-права-в-сравнении-с-агентством)
      - [shadow_uid, shadow_name](#shadow_uid-shadow_name)
    - [Больше инфы](#больше-инфы)
  - [Деплой / логи](#деплой--логи)
  - [Хосты](#хосты)

## Запуск проекта
Собирается и запускается стандартно, [как и другие пакеты](../docs/quick-start.md), за исключением того, что нужно открывать туннель до blackbox-mimino. Об этом ниже.

### Blackbox-mimino
[Blackbox-mimino](https://wiki.yandex-team.ru/passport/mimino/) - сервис в тестинге, в котором лежат обфусцированные паспортные данные из прода. Партнёрка ходит за данными о юзере в этот сервис вместо обычного блэкбокса из тестинга.

Проблема с мимино в том, что он недоступен локально, доступы не дают по соображениям безопасности.

Чтобы можно было разрабатывать партнёрку локально, во время `make start-local` поднимается ssh-туннель от локальной машины до мимино через личную виртуальную машину.

[Как заказать себе виртуалку, если у вас её ещё нет](https://wiki.yandex-team.ru/vertis-admin/dev-containers/).

Для того, чтобы туннель поднялся, нужно добавить параметр `vm`, содержащий адрес личной виртуальной машины.
Например:
```bash
make start-local vm=<username>.dev.vertis.yandex.net
```

Туннель закрывается после завершения процесса NodeJS.

## Зачем нужен этот сервис
Партнёрка - это личный кабинет для продвижения ЖК и КП в выдаче.
Место в выдаче определятся на основе аукциона: чем выше цена контакта с пользователем ([целевой звонок](https://yandex.ru/support/realty-partner_3ed75f9c8c5f5d2809625b0370121281/terms.html#target-calls) или целевая переписка в чате), тем выше место ЖК\КП в выдаче.

Например:
1. Василий готов заплатить за то, что пользователь позвонит ему по поводу квартиры в ЖК "Яхонт" 5000 рублей
2. Пётр готов заплатить за звонок по поводу квартиры в ЖК "Каналья" 6000 рублей
3. Звонок по ЖК "Каналья" стоит дороже, чем по ЖК "Яхонт", поэтому "Каналья" будет выше в выдаче

Квартиры в одном и том же ЖК могут продавать несколько агентов, поэтому среди них действует такой же аукцион: покажется телефон того агента, который больше предложит.

Например:
1. Василий всё так же готов заплатить за звонок по ЖК "Яхонт" 5000 рублей
2. Приходит Анна, которая готова заплатить за звонок по ЖК "Яхонт" уже 7000 рублей (самая большая сумма из всех агентов по этому ЖК)
3. Когда пользователь кликает на "показать телефон", на карточке ЖК или карточке оффера из этого ЖК, то ему показывается номер телефона Анны, а не Василия, потому что она предлагает наибольшее количество денег за звонок
4. "Яхонт" поднимается выше "Канальи" в выдаче ЖК, потому что стоимость звонка (7000) там теперь выше чем в "Каналье" (6000)

## Разделы партнёрки
### Объекты (ЖК или КП)
- Отображение объектов (статус РК, ЖК, коэффициент интереса, ставка, позиция на карточке, позиция в выдаче, ставка за первое место в карточке, ставка за первое место в выдаче, ставка за премиум блок, ограничения по покупке РК)
- Фильтрация объектов
- Включение/отключение рекламных кампаний
- Настройка расширенной карточки ЖК
- Групповое включение/отключение рекламных кампаний
- Архивация объектов
- Изменение ставки
- Групповое изменение ставки
- Задание бюджета на месяц по кампании
- Настройка номера телефона для кампании
### Звонки (новая партнёрка)
- Список прямых и обратных звонков по ЖК или КП
- Прослушивание/скачивание звонка
- Отправка жалобы на то, что звонок был не целевым и что деньги за него не нужно списывать (например, спам)
- Скачивание списка звонков в `.xls`
### Чаты (новая партнёрка)
- Список чатов застройщика и пользователя
- Просмотр сообщений в конкретном чате
- Отправка жалобы на то, что чат - не целевой (пользователь написал не по поводу покупки)
### Финансы
- Список изменений в балансе клиента

Все эти разделы доступны от лица [клиента](#Клиент-/-client). Если пользователь - [агентство](#(Рекламное)-агентство-/-agency-/-РА), то для доступа
к этим разделам, он должен выбрать одного клиента из списка своих клиентов и зайти "под ним".

## Старая / новая партнёрки
Старая партнёрка находится тут: https://a.yandex-team.ru/arc_vcs/classifieds/vertis-partner-www и включает в себя страницу объектов и финансов.

Раздел чатов и звонков находится в новой партнёрке в нашем монорепо, в папке где лежит этот ридми.

В будущем планируется добавлять новые разделы в новую партнёрку и переносить в неё разделы из старой партнёрки. Раздел звонков уже добавлен в новую партнёрку, но сохранился и в старой.

Старую партнёрку использует только Недвижимость. В прошлом её использовали ещё работа и путешествия.

### Точки соприкосновения
Старая партнёрка явно связана с новой в двух точках: 
- шапка: в старой партнёрке есть ссылка на чаты из новой партнёрки, а в новой партнёрке - на все разделы старой партнёрки
- куки shadow_uid и shadow_name (подробнее про них [тут](#shadow_uid,-shadow_name))

## Сущности и [роли](./app/lib/const/roles.js) партнёрки
Дисклеймер: сущности партнёрки не привязаны к недвижимости в силу того, что партнёрка используется несколькими сервисами,
но дальше в этом документе они описаны через специфику недвижимости.

### Рекламная кампания / campaign / РК
Относится связью много к 1 к ЖК (или КП). Наличие РК у ЖК говорит о том, что он может участвовать в аукционе и подниматься в выдаче. Для одного ЖК может быть создано несколько рекламных кампаний (от разных клиентов), своя для каждого продавца ЖК (см. пример про Василия и Анну выше).

При создании рекламной кампании пользователь указывает целевой номер телефона (звонки на который будут идти через наши подменники) и цену за один звонок.

После создания пользователь может поднимать цену за звонок, тем самым поднимая соответствующий ЖК в выдаче и выводя себя на первое место в списке продавцов (первое место получает звонок).

Кроме цены на звонок пользователь может настроить ежемесячные ограничения по тратам по этой РК (не тратить на звонки больше денег, чем хочется).

### Клиент / client
Клиентом может являться:
- агент рекламного агентства
- агент, работающий индивидуально
- небольшое рекламное агентство, которому хватает одного аккаунта (и которое не работает с клиентами)
- застройщик, если он сам продвигает свои ЖК/КП
- застройщик, если он пользуется услугами рекламного агентства

В некоторых случаях клиент может иметь доступ на чтение чужих рекламных кампаний (роль ClientRO). Например, агентство, занимающееся продажами ЖК, может дать застройщику такой аккаунт, чтобы тот мог посмотреть как тратятся его деньги.

Клиент - это владелец рекламных кампаний. Рекламное агентство не может напрямую создавать кампании, только через одного из своих клиентов.
У одного клиента может быть несколько рекламных кампаний для ЖК/КП от одного застройщика или от нескольких разных.

### (Рекламное) агентство / agency / РА
"Агрегатор" нескольких клиентов. Может выполнять все действия, которые может выполнять любой из его клиентов + может просматривать список своих клиентов.
Чтобы получить доступ к РК, пользователь-РА должен зайти под клиентом, который является владельцем этой РК.

### Админ
Админ - роль, с которой может заходить кто-либо из недвижимости и управлять различными агентствами и клиентами без агентств.
Скоуп доступа админа показан на этой картинке:

![scope](./docs/access.png)

Админ имеет доступ к общему списку агентств и может получать доступ к клиентам других агентств.

#### Дополнительные права (в сравнении с агентством)
- корректировать баланс клиента (без фактического платежа)
- изменять подменники для кампаний клиента
- добавлять / изменять клиентов агентства
- просматривать / изменять список всех агентств

#### shadow_uid, shadow_name
Кроме возможности просто передать `agencyId` и `clientId` в URL и тем самым перейти на страницу клиента определённого агентства, админ также может
"перевоплотиться" в определённого пользователя и пользоваться сервисом (просматривать, изменять данные) от его лица (с соответствующими правами). Для этого он тыкает в старой партнёрке сюда:

![shadow_user](./docs/shadow.png)

После этого на общий с недвижимостью домен (`.realty.yandex.ru` для прода и `.realty.test.vertis.yandex.ru` для тестинга и бранчей) записываются две куки: 
- `shadow_uid` - uid пользователя
- `shadow_name` - имя (никнейм) пользователя

При наличии куки `shadow_uid`, все запросы админа выполняются с этим uid взамен его собственного. Если не-админ установит себе такие куки, они проигнорируются.

Обработка этой куки в новой партнёрке лежит тут: [мидлвара, которая смотрит на тип пользователя и кладёт нужный uid в контекст](./app/lib/middleware/shadowUser.js).
Если в запросе к бэкенду нужно указать uid текущего пользователя, то нужно использовать `this.req.currentUid`, созданный этой мидлварой, а не какое-то другое поле.

### Больше инфы
О разделах партнёрки с точки зрения пользователя можно прочитать тут: 
- https://yandex.ru/support/realty-partner_3ed75f9c8c5f5d2809625b0370121281/index.html
- https://wiki.yandex-team.ru/realty/partner-nb/

## Деплой / логи

| Service | URL                                                                                                               |
|---|-------------------------------------------------------------------------------------------------------------------|
| Arcanum CI | https://a.yandex-team.ru/projects/realty/ci/releases/timeline?dir=classifieds%2Frealty-frontend&id=realty-partner |
| Deploy | https://admin.vertis.yandex-team.ru/services/realty-front-partner                                                 |
| Grafana | https://grafana.vertis.yandex-team.ru/d/yQvo5o6iz/realty-nodejs-frontends?var-job=realty-front-partner            |

## Хосты

| Environment | URL |
|---|---|
| Testing | https://realty.test.vertis.yandex.ru/partner/ <br> https://branch-${branch}.realty.test.vertis.yandex.ru/partner/ |
| Production | https://realty.yandex.ru/partner/ |
