# Про эксперименты
Эксперименты позволяют опробовать новый функционал только на определенной части пользователей. Эксперименты заводятся в общеяндексовом сервисе ABT.

### Конфиг (experiments.json)
Конфиги экспериментов хранятся в виде отдельных файлов в папке:
```
realty-core/configs/default/experiments
```

Формат файла "<Имя_эксперимента>.json":
```json
{
  "flags" : {
    "<Флаг экспериментальной выборки>": "<ID экспериментальной выборки>",
  },
  "controlId": "<ID контрольной выборки>"
}
```
Например "REALTYFRONT-7621.json":
```json
{
    "flags": {
        "REALTYFRONT-7621_no_background_button": "212537"
    },
    "controlId": "212536"
},
```

Название эксперимента всегда должно начинаться с `REALTY`, лучше всего записывать в него название таска или, если таск подразумевает несколько экспериментов или же эксперимент проводится не в таске, в конфиге эксперимент можно назвать понятным именем, начинающимся с `REALTY` (например: `REALTY_standalone_exp`)

Флаги и ID выборок (экспериментальных выборок может быть несколько) обычно отписывает в таске создатель эксперимента в ABT, также их можно найти в [очереди экспериментов Недвижимости в ABT](https://ab.yandex-team.ru/queue/52/) или в [списке черновиков](https://ab.yandex-team.ru/task/list#filters_advanced=1&group=new&queue_id=52)

Контрольная выборка всегда одна, читаемого флага не имеет, только числовой ID

#### Фича-флаги

Существует ряд случаев когда нужно завести эксперимент без добавления его в ABT:
- На этапе разработки. Чтобы не ждать появления эксперимента в ABT и начать разработку с временным экспериментом.
- Для создания фича-флага. Когда хочется сделать функционал закрытый флагом для 100% пользователей. Обычно используется чтобы проверить некоторый функционал в проде.

Для этого можно завести эксперимент специальным образом, например:

```json
{
    "flags": {
        "REALTYFRONT-8477_feature_flag_1": "REALTYFRONT-8477-feature-1"
    },
    "controlId": "none"
},
```

Вместо id конртольной выборки пишется НЕ числовой идентификатор - имя фича флага (REALTYFRONT-8477-feature-1). Ограничение на имя - строка НЕ содержащая символ "_" (так как нижнее подчеркивание используется как разделитель в куках для хранения controlId). В качестве префикса лучше использовать имя тикета.

Созданный таким образом эксперимент не будет передаваться в ABT, но его можно будет включить на странице /experiments. Такие эксперименты будут иметь специальную метку "BY COOKIE ONLY"

### Страница экспериментов (/experiments)

ABT-эксперименты на странице /experiments распологаются в секции `UAAS Experiments` Названия экспериментов и выборок берутся из experiments.json (не описанные там эксперименты в форме не отобразятся), значения radiobutton'ов - из ответа UAAS (NB: активное значение "Контрольная группа / Не в экспе" может обозначать как попадание в контрольную группу эксперимента, так и непопадание в какую-либо из выборок в принципе - такое возможно, если суммарно выборки покрывают менее 100% пользователей)

При отправке формы, по кнопке `Set` под формой нас прокинет во ВСЕ проставленные выборки (и выкинет изо всех непроставленных).

Можно также принудительно прокинуть себя в какие-либо выборки (в том числе в несколько выборок одного экспа одновременно) через GET-параметры: для этого нужно запросить страницу /experiments с GET-параметром `REALTY` со всеми ID необходимых выборок, разделённых `_` (Например: `/experiments?REALTY=0000_1111_2222`)


### Cookies

Чтобы удостовериться, что мы попали в необходимые выборки, можно проверить значение куки `prev_uaas_data` - в ней записаны yandexUid и ID выборок, в которые мы попали, разделённые `#` (в панели браузера этот символ обычно выглядит как `%23`). Например: `<yandexUid>%23209473%23212536%23214322%23214300%23215904%23215488%23218546%23228590%23227539` - это означает попадание в выборки `209473 212536 214322 214300 215904 215488 218546 228590 227539`.

Кука живет 5 минут, потом она вновь проставляется при следующем запросе. Кука необходима в случае, если произойдёт ошибка, и из ABT не придёт информация по выборкам - в таком случае выборки возьмутся из куки

#### Установка экспериментов без похода в uaas

Для нужд автотестов добавили возможность установки специальной куки autotest_uaas_ids. Её значение это разделенные "_" идентификаторы экспериментов, которые должны быть включены. Если значение куки "-1" - все эксперементы будут выключены. При этом запросов в uaas не будет. 

```
autotest_uaas_ids=244766_235850 // Будут включены два экспа
autotest_uaas_ids=-1 // Все выключены 
```


### Работа с экспериментами в браузере/на сервере

В `.priv.js` файлах доступ через:
```javascript
//Флаги (Предпочтительный вариант)
data.experimentsData.has('REALTYFRONT-000000_my_exp_flag');
//ID
data.experimentsData.has('000000');
```

В react-компонентах используем `checkExperiment`
```javascript
import { checkExperiment } from 'realty-core/view/common/libs/experiments';
//Флаги (Предпочтительный вариант)
checkExperiment('REALTYFRONT-000000_my_exp_flag');
//ID
checkExperiment('000000');
```
