# Спецпроекты на Недвижимости

## Бункер

У нас используются несколько видов спецпроектов, которые влияют на отображение некоторых блоков.

Все конфигурации спецпроектов хранятся в бункере:
https://bunker.yandex-team.ru/realty-www?view=raw

Как правило, эти конфиги меняют менеджеры, но иногда это делают и разработчики.
По дефолту доступа на редактирование конфига у разработчика нет, его нужно заказать.

<details>
<summary>Как заказать права на редактирование конфигов в бункере</summary>
<p>

Права лучше всего заказать на сразу же на корневой узел ```realty-www```

- Переходим в https://bunker.yandex-team.ru/realty-www?view=raw
- Нажимаем "Дополнительно" -> "Заказать права"
- Заказываем Бессрочную роль на себя

Роль нужно заказать дважды: один раз на редактирование, и один раз на публикацию
![bunker-roles](bunker-roles.png)\
_Заказ роли в idm_
</p>
</details>

У конфигов бункера есть 2 состояния: "Сохраненное" и "Опубликованное".
Первое - это по сути черновик, второе - финальная версия.
У нас это работает так, что сохраненная версия будет в тестинге, опубликованная в проде.
Соответственно, сохраненный конфиг можно менять в целях тестирования, опубликованный должен быть с корректными данными.

**Важно!**
Перед тем как шатать сохраненные конфиги, нужно предупредить менеджера, чтобы никто его случайно не опубликовал.
Поскольку с конфигами работают разные люди, можно попасть в неприятную ситуацию.

## Расширенная карточка ЖК

Регулируется конфигом 
https://bunker.yandex-team.ru/realty-www/site-special-cards?view=raw

Он состоит из массива объектов у которых есть 2 значения:

```developerId``` - id застройщика, купившего расширенные карточки

```siteId``` - массив идентификаторов (или единичный идентификатор) ЖК данного застройщика, для которых включены расширенные карточки

Этот конфиг модифицируют менеджеры, которые взаимодействуют с застройщиками.

Для расширенных карточек ЖК у нас показывается кастомный баннер верху страницы, а так же блок "Варианты отделки" и блок с видео в описании.

## Расширенная карточка застройщика
Регулируется конфигом https://bunker.yandex-team.ru/realty-www/site-special-developers?view=raw

Он состоит из массива объектов со следующей структурой:

```developerId``` - id застройщика

```developerName``` - наименование застройщика

```geoId``` - geo id региона, в котором у застройщика будет расширенная карточка

```startDate``` - дата начала действия расширенной карточки в формате YYYY-MM-DD

```endDate``` - дата конца действия расширенной карточки в формате YYYY-MM-DD

Этот конфиг модифицируют менеджеры, которые взаимодействуют с застройщиками.

Для застройщиков, указанных в данном списке (и попадающих в диапазон дат), включается расширенная карточка застройщика.
На страницах вида ```/moskva_i_moskovskaya_oblast/zastroyschik/mr-group-268784/``` появляются дополнительные блоки (слайдер, блок акций, блок с видео и другие), которые заполняются контентом.

<details>
<summary>Пример расширенной карточки застройщика</summary>
<p>

![extended-developer-card](extended-developer-card.png)

</p>
</details>

## Спецпроект с застройщиком
### Конфиг
Регулируется конфигом https://bunker.yandex-team.ru/realty-www/site-special-projects?view=raw

Он состоит из массива объектов со следующей структурой:

```
"params": {
    "geoId" - geo id региона (или массив geo id), в котором у застройщика будет работать спецпроект
    "startDate" - дата начала действия спецпроекта в формате YYYY-MM-DD
    "endDate" - дата конца действия спецпроекта в формате YYYY-MM-DD
},
"data": {
    "developerId" - id застройщика
    "developerName" - наименование застройщика
    "showPin" - регулирует показ кастомных пинов на карте
    "hideAds" - регулирует показ рекламы в карточке ЖК
    
    // Поля, связанные с ссылками на застройщика в меню
    "showTab": - если true, то в меню появится таб с наименованием застройщика
    "hasLogoInTab": если true, то в меню вместо наименования появится логотип (если логотип добавлен в коде)
    "tabUrl" - ссылка, на которую будет вести таб в меню
    "sideMenuText" - текст ссылки в боковом меню тача
    
    // Поля, связанные с фильтром по застройщику
    "showFilter" - если true, то в таче появится кнопка с фильтром по застройщику
    "filterText" - текст фильтра по застройщику
    "developerFullName" - текст выбранного фильтра по застройщику
}
```

Чаще всего это конфиг так же меняют менеджеры, но иногда это делаем и мы (например, при добавлении нового логотипа застройщика).

### Использование в коде

Мы получаем информацию о текущем спецпроекте в регионе с помощью специальной [спецпроектной ручки](http://realty-gateway-api.vrts-slb.test.vertis.yandex.net/index.html?url=/api/2.x#!/developer/specialProject). Она отдает нам информацию о текущем спецпроекте в заданном гео.

У нас эта информация получается в общем провайдере и кладется в стор общим редьюсером.
Поэтому на любой странице сервиса можно взять информацию о спецпроекте в текущем гео из ```siteSpecialProject``` в сторе.

### Что регулирует спецпроект в деталях

#### Скрытие рекламы
Если ```hideAds: true```, то в карточках ЖК спецпроектного застройщика не будет показываться реклама.

В десктопе пропадет реклама под правым плавающим блоком и под отзывами.
В таче пропадет реклама под блоком с обратным звонком.

#### Пины
Если в конфиге задать ```showPin: true```, то для такого застройщика включаются кастомные пины.

Чтобы пины появились их нужно добавить в коде, поэтому эту опцию иметь смысл включать только после выкатки в прод кода с новыми пинами.

Пины показываются с помощью хока [withSitePins](../../realty-core/view/react/modules/map/common/MapObjectManager/enhancers/withSitePins/index.js), он используется везде, где есть карта с ЖК.

Новые пины нам рисует дизайн (включая активное состояние и ховер).

Чтобы они появились достаточно добавить иконки с нужными цвета в файлик [стилей](../../realty-core/view/react/modules/map/common/MapObjectManager/enhancers/withSitePins/styles.css)

![pins](pins.png)\
_Пример кастомных пинов_

#### Ссылки в меню на застройщика
Урл ссылки задается параметром ```tabUrl```, как правило это ссылка на страницу застройщика.
Если указать ```showTab: true```, то в главном меню десктопа появится ссылка на застройщика с текстом ```developerName```
Через ```sideMenuText``` можно управлять текстом ссылки на ту же страницу, что и в десктопе, для бокового меню тача.

```hasLogoInTab: true``` позволяет вместо текста отобразить логотип.
Лого будет отображаться в главном меню десктопа и в боковом меню тача.
Чтобы логотип появился, нам нужно добавить его в коде.

Саму картинку логотипа мы получаем от дизайнеров. 
Картинку нужно экспортировать в svg, важно чтобы высота логотипа была такая же, как для всех остальных (сейчас это 44px).

После этого нужно добавить логотип к компоненту [MenuSpecialProjectLogo](../../realty-core/view/react/modules/header/common/MenuSpecialProjectLogo/index.tsx).
Для этого саму картинку нужно положить в ассеты рядом, и добавить нужные стили (как правило, только размеры).

Так же нужно добавить тесты на десктопного и тачового меню.
Для этого надо добавить мок и переснять тест для [скриншотных тестов MainMenu](../../realty-core/view/react/modules/header/deskpad/MainMenu/__tests__/index.browser.tsx) как это сделано для всех других логотипов.
То же самое надо сделать для [скриншотных тестов HeaderMenu](../../realty-core/view/react/modules/header/touch-phone/__tests__/index.browser.tsx) как это сделано для всех других логотипов.


<details>
<summary>Пример логотипа в меню</summary>
<p>

![logo-in-tab](logo-in-tab.png)

</p>
</details>

<details>
<summary>Пример ссылки в боковом меню</summary>
<p>

![side-menu](side-menu.png)

</p>
</details>

#### Фильтр по застройщику
С помощью опции ```showFilter:true``` можно включить отображения фильтра по застройщику в таче.

```filterText``` регулирует текст, самого фильтра (кнопки)

```developerFullName``` регулирует текст, который будет показан, если фильтр выбран

![developer-filter](developer-filter.png)\
_Пример фильтра по застройщику_

## Расширенный спецпроект с застройщиком
### Конфиг

Регулируется конфигом https://bunker.yandex-team.ru/realty-www/site_special_projects_second_package?view=raw

Он состоит из массива объектов со следующей структурой:

```
"params": {
    "geoId" - массив geo id регионов, в которых у застройщика будет работать спецпроект
    "startDate" - дата начала действия спецпроекта в формате YYYY-MM-DD
    "endDate" - дата конца действия спецпроекта в формате YYYY-MM-DD
},
"data": {
    "developerId" - id застройщика
    "developerName" - наименование застройщика
    "pinnedSiteIds" - список идентификаторов ЖК (в порядке приоритета), которые будут ображатся в блоке запиненных ЖК
    "hasExtendedSiteCards" - если true, то в десктопе карточки ЖК будут иметь баннер во весь экран 
    
    // Поля, связанные с баннерами в фильтрах
    "mixedListingBannerUrl" - url картинки в аватарнице для баннера в смешанном листинге офферов
    "mixedListingBannerText" - текст баннера для смешанного листинга офферов
    "siteListingBannerUrl" - url картинки в аватарнице для баннера в листинге ЖК
    "siteListingBannerText" - текст баннера для листинга ЖК
    "commercialListingBannerUrl" - url картинки в аватарнице для баннера в листинге коммерческой недвижимости
    "commercialListingBannerText" - текст баннера для листинга коммерческой недвижимости
    
    // Поля, связанные с фильтром по застройщику
    "phones" - объект с телефонами застройщика по geo id
    "redirectPhones" - массив с данными, который используется на бекенде, чтобы продлевать подменники из phones
```

Здесь не так часто, что-то меняется. ```pinnedSiteIds``` и ```phones``` (как и ```redirectPhones```) меняются менеджерами.
Мы помогаем с загрузкой картинок для баннеров, поэтому меняем поля связанные с баннерами.

Как правило, расширенный спецпроект всего один на сервисе.

### Использование в коде

Мы получаем информацию о текущем спецпроекте в регионе с помощью специальной [спецпроектной ручки](http://realty-gateway-api.vrts-slb.test.vertis.yandex.net/index.html?url=/api/2.x#!/developer/specialProject). Она отдает нам информацию о текущем спецпроекте в заданном гео.

У нас эта информация получается в общем провайдере и кладется в стор общим редьюсером.

Поэтому на любой странице сервиса можно взять информацию о спецпроекте в текущем гео из ```siteSpecialProjectSecondPackage``` в сторе.

### Что регулирует расширенный спецпроект

#### Телефоны
В ```phones``` записан объект, ключом которого является geo id региона, а значение - отформатированный номер телефона.

Это довольно кастомное значение для отображения номера телефона в каких-то специальных местах, например, на спецпроектном лендинге.
В общем коде нигде не используется.

```redirectPhones``` используется бекендом, для того чтобы правильно работали подменники для номеров указанных в ```phones```, мы это значение не трогаем.

#### Запины ЖК
В ```pinnedSiteIds: []``` указывается список идентификаторов ЖК, которые будут показываться в специальном блоке в листинге ЖК в десктопе.

При этом показываться будут только те ЖК, которые подходят под текущие фильтры. 
Показываться будут в том порядке, в котором они указаны в конфиге (это регулируется на бекенде).

Для нас это работает так, что в ручке ```/1.0/offerWithSiteSearch.json``` есть поле ```pinnedItems``` с запиненными сниппетами ЖК.

Мы отрисовываем блок с запинами, на основе того включен ли спецпроект в текущем регионе и есть ли запиненые ЖК.
Если спецпроект включен, а запинов нет, то показывается специальный рекламный блок.

Логику отрисовки запинов можно посмотреть в компоненте [SitesSerpSpecialPinnedBlock](../../realty-www/view/react/deskpad/components/serps/SitesSerp/SitesSerpSpecialPinnedBlock/index.tsx)

![pinned-sites](pinned-sites.png)\
_Пример запиненных ЖК_

#### Баннер в фильтрах
В рамках расширенного спецпроекта у нас так же показываются баннеры в различных листингах в десктопе.

В конфиге каждый баннер задается двумя полями:

```<тип листинга>ListingBannerUrl``` - урл изображения в аватарнице (без указания размера)

```<тип листинга>ListingBannerText``` - текст, который будет отображаться на банере

Сейчас есть 3 типа листингов:

```mixed``` - смешанный листинг офферов

```site``` - листинг новостроек

```commercial``` - листинг коммерческой недвижимости

Компонент баннера [FiltersBannerSamolet](../../realty-www/view/react/deskpad/components/FiltersBannerSamolet/index.tsx)

<details>
<summary>Как добавить новую картинку в аватарницу</summary>
<p>

В баннере используется 2 размера картинки: ```banner_1440``` и ```banner_2880```

Аватарница автоматически нарезает картинку на нужные размеры, достаточно лишь загрузить картинку в наш ```realty``` неймспейс.
Размер подставляется в коде автоматически, поэтому достаточно лишь указать урл до картинки.

Чтобы картинка отображалась в проде важно загрузить ее именно в продовую аватарницу.

Cделать это можно только с вируалки.
Если у вас ее нет, то можно [заказать виртуалку](https://wiki.yandex-team.ru/vertis-admin/dev-containers/) или попросить товарища, у которого она есть.

**Загрузка картинки**
1. Копируем картинку на виртуалку, например так: ```scp <image.jpg> <username>.dev.vertis.yandex.net:<image.jpg>```
2. Заходим на виртуалку ```ssh <username>.dev.vertis.yandex.net```
3. Загружаем картинку в продовую аватарницу ```curl "http://avatars-int.mds.yandex.net:13000/put-realty/filename" -F file=@<image.jpg>```
4. Берем из ответа значение ```extra.tags.path```, убираем ```/tags``` на конце.
5. Добавляем получившийся путь к домену ```https://avatars.mds.yandex.net/```

Перед тем как сохранять значение в бункер стоит проверить, что картинка работает.
К итоговому урлу можно добавить ```banner_1440``` и проверить, что изображение показывается.

Если что-то поменяется можно обратиться к [доке аватарницы](https://wiki.yandex-team.ru/mds/avatars/)

</p>
</details>

![filters-banner](filters-banner.png)\
_Пример баннера в фильтрах_

#### Баннер в карточке ЖК
Если в конфиге задана параметр ```"hasExtendedSiteCards": true``` в десктопе в карточках ЖК застройщика появляются баннеры во весь экран.

Все картинки баннеров на данный момент зашиты на фронте, если ее нет, берется первая картинка из галереи.

Отвечает за это компонент [SiteCardSecondPackageHeader](../../realty-www/view/react/deskpad/components/cards/SiteCard/SiteCardSecondPackageHeader/index.tsx)

<details>
<summary>Пример баннера на странице ЖК</summary>
<p>

![site-card-banner](site-card-banner.png)

</p>
</details>

#### Другое

Помимо тех, вещей которые указанны в конфига, само наличие расширенного спецпроекта в регионе, так же добавляет некоторую функциональность.

Для расширенного спецпроекта автоматически включаются кастомные пины.
Если иконок для пинов нет, то их нужно добавить точно так же, как для обычного спецпроекта.

Карточки ЖК застройщика становятся платящими.
