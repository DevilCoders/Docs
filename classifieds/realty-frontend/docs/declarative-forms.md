# Декларативные формы

Валидации в крупных формах (например, форма подачи объявления) сделаны с помощью [JSON Schema](https://json-schema.org/) в декларативном стиле, это позволяет переиспользовать схему как для валидации на фронте, так и на Node.js.

## Форма подачи объявления

При сборке проекта запускается [скрипт](https://github.com/YandexClassifieds/realty-frontend/blob/master/realty-lk-www/Makefile#L25-L32) на генерацию схемы `add_form_data.schema.json`, в котором и находится информация по всем полям.

### Валидация

Для простых валидаций (тип поля, минимум, максимум, количество символов и пр) можно использовать встроенные валидации JSON Schema, если появляется нужда в более сложных валидаций, а также для зависимостей от других полей следует использовать `formatters`, которые срабатывают после основной валидации.

#### Добавление валидации

В текущей реализации довольно просто добавить валидацию на уже существующее поле. Посмотрим по шагам, что для этого нужно сделать.

Для примера, возьмем валидацию поля этажа. Это число, обязательно для всех типов недвижимости, кроме коммерческой. Минимальный этаж для коммерческой недвижимости -5, а для других 0. Максимум не определен, но объектвно не больше 99.

1. Базовая валидация находится в `realty-lk-www/app/lib/add-form/controls_decl.js`, там мы определим максимум.
2. Добавим в `opts` поле `maximum = 99`, а также `validation.isRequired = true`.
3. Чтобы переопределить для определенной категории добавим `validationByTypeCategory.COMMERCIAL.isRequired = false`.

Итоговая структура выглядит так:

```javascript
    floor: {
        type: 'text-numeric',
        opts: {
            maximum: 99,
            validation: {
                isRequired: true
            },
            validationByTypeCategory: {
                COMMERCIAL: {
                    isRequired: false
                }
            }
        }
    }
```

4. Теперь перейдем к ошибке минимума, здесь нам также потребуются разные сообщения об ошибках для коммерческой и остальной недвижимости. Для подобной более динамичной логики предусмотрены валидации на основе форматеров, находятся они в `realty-lk-www/app/lib/add-form/formaters.js`.

5. Напишем простой код валидации и посмотрим на него:

```javascript
floor_minFloor(data) {
    if (data.category === 'COMMERCIAL') {
        return data.floor < -5 ? 'floor_minFloor; floor; floorsTotal_range_commercial' : null;
    }

    return data.floor < 1 ? 'floor_minFloor; floor; floorsTotal_range' : null;
}
```

Когда нам не нужно показывать ошибку, возвращаем `null`. Структура возвращаемой строки ошибки такая: `'название_форматера; поле; i18n_для_ошибки'` (если не указан перевод для ошибки, то возьмется название форматера).

6. Добавим наш форматер в `realty-lk-www/app/lib/add-form/generate_schema.js`, в зависимости от нужной нам категории (в текущем примере надо добавить в два массива), добавляем в `allOf`:

```javascript
{ format: 'floor_minFloor' }
```

7. Осталось добавить текст ошибки. Все текста для ошибок формы находятся в `realty-lk-www/view/lib/add-form/serialize-error/i18n/ru.js`.

```javascript
{
    floor_required: 'Укажите этаж',
    floor_range: 'Этаж должен быть больше нуля',
    floor_range_commercial: 'Этаж должен быть больше -6',
}
```
