# Метрики

Наше node-приложение отправляет различные метрики для мониторинга его состояния. Посмотреть визуализацию метрик можно в [графане](https://grafana.vertis.yandex-team.ru/d/yQvo5o6iz/realty-nodejs-frontends?orgId=1).

Общая схема сбора метрик:

![metrics](metrics.svg)

Наше node-приложение запускается в кластерном режиме (luster). Есть один мастер-процесс, который осуществляет координацию и поднятие рабочих узлов в случае падения. Рабочий узел это само наше приложение. Обычно в проде на каждой машине у нас [4 рабочих процесса](https://github.com/YandexClassifieds/realty-frontend/blob/e28038094b6270c9181ccc316047409a7963f3df/realty-arenda/configs/production/luster.js#L5). Метрики собираются только из мастер-процесса путем агрегации данных полученных от каждого worker-а. Функция агрегации для каждого типа метрики задана по умолчанию, но может быть переопределена явно, например, как для [appVersion](https://github.com/YandexClassifieds/realty-frontend/blob/41f17724bbd61e3c88815a46aab1198096b09e71/realty-core/app/lib/prometheus/metrics.js#L57).

Важно, что метрики не отправляются сразу, а аккумулируются в приложении. Prometheus сам их забирает с некоторой периодичностью.

## Графики в графане

График представляет собой визуализацию метрик полученных с помощью запроса к prometheus. Чтобы посмотреть запрос можно нажать на Edit на любом графике.

### Response codes

Показывает кол-во завершенных запросов к node-приложению с определенным статусом.

Отправляется по окончании обработки каждого запроса пришедшего в приложение.

**На что смотреть:** Изменения в сравнении с предыдущей версией приложения. Некоторые изменения могут быть ожидаемыми (например рост редиректов, если мы их добавили). Рост 500-ок всегда плохо, но нужно изучать их природу по логам.

### Backed RPS

Показывает кол-во запросов в секунду к разным микросервисам беканда.

Отправляется при завершении каждого http-запроса, сделанного из node-приложения

**На что смотреть:** При появлении заметного изменения кол-ва запросов в какую-то ручку стоит проверить ожидаемо ли это. Могли или потерять какие-то вызовы или наоборот сделать лишние.

### Backend timeouts

Количество запросов в бекенд упавших по timeout-у

### Backend 99 percentile

Время выполнения самых медленных запросов. Значит что 99% запросов выполненились быстрее.

### Backend 95 percentile

Время выполнения самых медленных запросов. Значит что 95% запросов выполненились быстрее.

### Active incoming requests in nodejs

Показывает кол-во еще не обработанных запросов к node-приложению в единицу времени

Представляет собой глобальный счетчик, в начале обработки запроса инкрементируется, а при завершении декрементируется.

**На что смотреть:** Рост показателя говорит или об увеличении трафика или об увеличении времени на обработку одного запроса.

### Asker error

Показывает кол-во ошибок при запросах из node-приложения в различный бекенд.

Ошибки генерируются из библиотек ask и resource. Отправляются при логировании ошибки из нашей обертки над библиотекой Terror.

**На что смотреть:** Возрастание фона всегда плохо, нужно смотреть логи запросов, в которых такие ошибки возникают. Вероятные причины:

- Мы неправильно формируем запрос в бекенд
- Не укладываемся в лимиты на время выполнения запроса
- Бекенд не выкатили в прод

При возрастании фона на этом графике есть большая вероятность, что нужно откатывать релиз.

### Other events and errors (rpm)

Количество ошибок, которые мы бросаем сами из приложения (через createError). Из данного графика исключены ошибки типа RedirectError (вынесены на отдельный график)

Отправляются при логировании ошибки из нашей обертки над библиотекой Terror.

**На что смотреть:** Почти всегда возрастание фона плохо, но нужно смотреть в логи. Например, в процессе раскатки может повышаться фон “GateError.UNEXPECTED_ERROR” если в новой версии приложении поменяли сигнатуру gate-а - старые клиенты попадают на новое приложении с не актуальными параметрами.

### Redirect errors (rpm)

Тоже что и “other events and errors”, но с фильтром по RedirectError

### Phones. Количество запросов (RPM)

Фильтр запросов в бекенд по имени ресурса “realty3/contacts.get” и “realty3/offer-phones.get”. Показывает кол-во вызовов ручек в минуту

**На что смотреть:** Смотрим на изменения. Резкое снижение кол-ва вызовов этих ручек после релиза - серьезный повод разобраться и, вероятно, откатить релиз.

### Phones. Ошибки запросов в бэкэнды (RPM)

AskerError отфильтрованные по “realty3/contacts.get” и “realty3/offer-phones.get”

**На что смотреть:** На этом графике не должно быть ошибок, так как ошибки в этих ручках напрямую вдияют на прибыль.

### Phones. Ошибки NodeJS API (RPM)

Ошбки приложения, связанные с телефонами: “PhoneModalGateError”, “ContactsGateError”

### Proof of work calculations (RPM)

Показывает количество верно и неверно рассчитанных [proof-of-work](https://github.com/indutny/proof-of-work) значений

**На что смотреть:** Увеличение числа не верно рассчитанных значений может говорить о том, что нас парсят или если это происходит в процессе релиза, то мы что-то сломали

### App version

Показывает кол-во инстансов приложения определенной версии.

Устанавливается при инициализации worker-а в 1 (init-in-worker.js). На одном инстансе в проде обычно 4 worker-а, но метрики отправляются из главного узла и агрегируются. В случае с данной метрикой для отправки в prometheus уйдет только первая. Поэтому для кластера из 4 worker-ов на графике будет только 1, а не 4.

**На что смотреть:** При выкатке в прод кол-во инстансов старой версии должно падать, а новой возрастать.

### Prometheus health

Доступность урла для сбора метрик “/metrics”. Точка сбора одна для всех worker-ов и создается в мастер-процессе в luster-prometheus.

**На что смотреть:** Недоступность урла говорит о том, что приложение упало. Нужно посмотреть логи с упавшего инстанса и постараться понять причину падения (чаще всего это ООМ) 

### Eventloop lag

Встроенная метрика, которая показывает как долго запланированный callback не выполняется.

**На что смотреть:** Увеличение этого показателя может говорить об увеличении синхронного кода в приложении

### Active incoming requests by instance

То же, что “active incoming requests in nodejs”, но сгруппированные по инстансам

