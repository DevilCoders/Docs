# Новая реклама

## Структура конфигурации в бункере
[Конфиг хранится тут](https://bunker.yandex-team.ru/realty-www/ads/)

Стандартно для бункера `latest` - для тестинга, `published` - для прода.

В корне два узла: `desktop` и `mobile` по платформе.

В каждой платформе есть узел `_sources`, где можно указать общие настройки для каждого конкретного источника (adfox, rtb, direct). Это сделано для того, чтобы на разных страницах не дублировать одинаковые параметры вызова того или иного рекламного блока.

Все остальные узлы - это названия контроллеров (в общем случае). Для загрузки конфигурации рекламных блоков для конкретной страницы, к контроллерам есть [миксин](../packages/shared/ad/app/mixin/ad.js), который добавляет метод `getAds`:

```js
SomePage.dataProviderDecl('ads', function(data) {
    // index тут - название узла для этой платформы. Тут может быть listing, map, card...
    // Вторым параметром передаются параметры для серверного директа (поскольку серверный директ ренедерится на сервере, а значит и данные запросить нужно сейчас)
    return this.getAds('index').then(ads => data.ads = ads);
});
```

Типовой конфиг:
```json
{
    "side": { // название блока
        // если задано - при инициалзации страницы сначала будут загружены блоки,
        // значение свойства order у которых меньше, независимо от того, где в вёрстке они расположены
        "order": 5,
        // Перезагружать блок каждые 30 секунд
        "reload": 30,
        // Перезагрузить блок при скроле > 1500px (один раз)
        "scrollReload": 1500,
        // Список источников
        "sources": [
            {
                // Ссылка на конфиг из узла _sources, встретив этот ключ
                // либо скопирует все свойства из соответсвующего конфига в sources и замерджит туда указанные тут
                "&": "adfox",
                // Какие-то параметры вызова, которые прокидываются в библиотеку adfox
                "params": {
                    "p2": "fhwz",
                    "pp": "irt",
                    "ps": "cjtp"
                }
            }
        ]
    },
    // Если у блока нет общих настроек (типа reload) - можно сразу указать массив sources
    "bottom": [
        {
            "&": "rtb",
            // Для RTB указывается blockId (e.g. R-A-95646-21)
            // Можно либо указать свойство blockId: "R-A-xxx"
            // Либо указать только impId (число в конце), placeId уже указан в _sources
            // { blockId: source.blockId || `R-A-${source.placeId}-${source.impId}` },
            "impId": "21"
        },
        // Если нужно взять настройки из _sources и ничего не добавлять - можно указать только ключ
        // Будет аналогично { "&": "adfox-bottom" }
        "adfox-bottom"
    ],
    "top": {
        "scrollReload": 1200,
        "sources": [
            "rtb-top",
            "adfox-top"
        ],
        // Можно заоверрайдить любое свойство для каких-нибудь экспериментов
        "experiments": {
            // Например, если включен этот эксп
            // Поменять порядок загрузки местами
            // И добавить автоперезагрузку каждые 15 секунд
            // При этом оригинальный scrollReload тоже останется
            "REALTYFRONT-42069": {
                "reload": 15,
                "sources": [
                    "adfox-top",
                    "rtb-top"
                ]
            }
        }
    }
}
```


## Верстка

Далее, все данные из `data.ads` прокидываются в [стор](../packages/shared/ad/view/reducer/ads.ts).

Для вставки непосредственно блока используется компонент [Ad](../packages/shared/ad/view/components/Ad/index.tsx)

Пример
```jsx
<Ad place="bottom" />
```

Далее, тут сгенерируются контейнеры для клиентской рекламы (адфокс + ртб), и вставится серверный директ (сверстанные компоненты нужно положить [сюда](../packages/shared/ad/components/Ad/AdDirectItem)).

## Клиентская библиотека

В конце блока сгенерируется `<script>new Ad('blockid', blockOpts)</script>` - непосредственно инициализация [клиентской библиотеки](../packages/shared/ad/view/lib/client.js).

Она занимается управлением блоков, их перезагрузкой, борется с гидрацией и т.д.

Либа доступна в `window.AD`. Например, можно руками перезагрузить блок на странице `AD.renderByPlace('top')` - удобно при дебаге.

Теги, классы, параметры хешируются [этой функцией](../packages/shared/ad/app/lib/hash.js) используя [adAliasName](../packages/shared/ad/app/middleware/ad.js) - динамическое название класса рекламы (генерируется на каждый новый запрос Document) и одновременно используется как соль при хешировании.

## CSS

Поскольку css-класс динамический - стили для рекламы тоже должны быть динамическими, они лежат [тут](../packages/shared/ad/view/components/Ad/styles.css).

Таким образом, каждый раз при загрузке Document (=полная загрузка страницы) в `head` инлайнится ad.client.js и ad.client.css - клиентская js либа и стили рекламы, куда каждый раз подставляется актуальное значение `adAliasName`.
