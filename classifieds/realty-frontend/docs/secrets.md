# Работа с секретами

[Документация админов](https://wiki.yandex-team.ru/vertis-admin/deploy/secret/)

Все секреты храним в [yav](https://yav.yandex-team.ru/) и подкладываем в переменные окружения.
Чтобы посмотреть наши секреты нужно выбрать тег `realty-frontend` в интерфейсе yav.

Для разработки используется утилита `secrets-to-dotenv`, которая на основе `secrets.config.json`
скачивает секреты и кладет их в `.env.secrets`.
> Для работы `secrets-to-dotenv` может требоваться наличие
> переменной окружения [VAULT_TOKEN](https://vault-api.passport.yandex.net/docs/#oauth)

Для тестинга/продакшена используется - [манифест деплоя](https://github.com/YandexClassifieds/services/tree/master/deploy).

## Как добавить секрет

* Заходим на [yav](https://yav.yandex-team.ru/)
* Нажимаем "Новый секрет"
* В поле "Алиас" вводим имя секрета, которое должно начинаться с префикса `realty-frontend-`
* В поле "Описание" добавляем описание
* Добавляем тег `realty-frontend`
* Даем доступ "Чтение и редактирование" для ABC сервиса "Недвижимость" и роль "Разработка"
* Добавляем ключ, имя ключа произвольное, обычно это `token` или `key`
* Нажимаем создать
* Добавляем в `secrets.config.json` - `"ИМЯ_СЕКРЕТА": "айди:версия:имя_ключа"`
* Делегируем секрет через cli-утилиту (см. [доку админов](https://wiki.yandex-team.ru/vertis-admin/deploy/secret/#cli-utilita))
* Добавляем в манифест деплоя `ИМЯ_СЕКРЕТА: ${айди:версия:имя_ключа}`

## Как изменить секрет

* Заходим на [yav](https://yav.yandex-team.ru/)
* Находим секрет по его айди
* Нажимаем "Редактировать"
* Меняем, сохраняем
* Если у секрета поменялась версия, то это нужно отобразить в `secrets.config.json` и
в манифесте деплоя

## Как удалить секрет

Сначала:
* Удаляем секрет из `secrets.config.json`
* Удаляем секрет из манифеста деплоя
* Убеждаемся, что секрет больше нигде не используется
* Выкатываем изменения

Выжидаем какое-то количество времени, например, неделю

Затем:
* Заходим на [yav](https://yav.yandex-team.ru/)
* Находим секрет по его айди
* Нажимаем "Удалить"
