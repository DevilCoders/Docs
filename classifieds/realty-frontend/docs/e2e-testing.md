# Интеграционные тесты

Данный вид тестов позволяет протестировать фичу целиком: и клиентский код и код ноды, мокаются только ответы бэкенда.

При прогоне таких тестов стартует обычное наше приложение с единственным отличием - все запросы в бэкенд идут через прокси-сервер, который запускается в тесте. При записи тестов сервер проксирует запрос в настоящий бекенд, а при воспроизведении отдаёт сохраненный. При это разработчик может переопределить любой текстовый ответ бэкенда в тесте.

## Стабильность тестов

Тесты будут стабильными только в том случае если само приложение работает детерминировано, т. е. в нем нет вызовов random и завязок на дату.

В некоторых ручках передаются параметры, которые вычисляются на ходу, поэтому каждый прогон может приводить к тому, что запросы в бекенд будут немного отличаться. Так как имена моков формируются на основе параметров запроса в процессе записи тестов, то это приводит к тому, что при прогоне теста мок может быть не найден.

Для таких частных случаев нужно явно прописать, что такие рандомные параметры нужно игнорировать при формировании имени мока. Это можно сделать в файле:

```
packages/utils/jest-utils/proxy/exclusions.js
```

## Файловая структура

Интеграционные тесты находятся в корневой папке проекта "e2e".  Далее внутри можно строить файловую структуру на базе названий фичей, например:

```
|-- e2e
|---- owner
|------ listing
|-------- __e2e_mocks__
|-------- index.e2e.ts  
```

## Создание нового теста

1. Заводим в папке проекта "e2e" новую подпапку с именем фичи
2. Добавляем файл теста "index.e2e.ts":
```js
import { ContentType } from 'allure-js-commons';
import noop from 'lodash/noop';

import { Server } from '@realty-front/jest-utils/proxy/server';
import { allure } from '@realty-front/jest-utils/puppeteer/tests-helpers/allure';

import { RealtyUser } from 'realty-core/app/test-utils/users';

describe('Название фичи', () => {
    // Используем одни и те же авторизационные данные для каждого теста
    beforeAll(async () => {
        await customPage.login({
            user: RealtyUser.owner.gomer,
        });
    });
    
    it('Название теста', async () => {
        const server = new Server();

        allure.descriptionHtml('Опциональное произвольное описание или вывод json с данными');

        // Запускаем proxy-сервер, который будет управлять заглушками ответов бэкенда 
        server.start();

        try {
            await page.setViewport({width: 1000, height: 800});

            // Заходим на интересующий нас url
            await customPage.path('/management-new/settings/');

            // Ждем пока не появится основной элемент страницы, чтобы удоставерится что она загрузилась
            await page.waitForSelector('#settings_contacts_user_type');

            const inputSelector = '[name=phone_input]';
            const phones = await page.$$(inputSelector);

            allure.step(`Должен быть только один элемент с селектором: ${inputSelector}`, noop);
            expect(phones.length).toBe(1);

            const form = await page.$('form');
            const screenshot = await form?.screenshot();

            // Это просто скриншот (не скриншотный тест), он добавитсяс в отчет для наглядности
            screenshot && allure.attachment('Финальный скриншот формы', screenshot, ContentType.PNG);
        } finally {
            // Нужно чтобы гарантированно погазись proxy-сервер в случае возникновения ошибки
            server.stop();
        }
    });
});    
```

3. Собираем нужный проект:
```bash
make webpack-e2e
```

По умолчанию собираются все бандлы, но в Makefile конкретного проекта можно указать только необходимые (для ускорения сборки).

4. Запускаем проект в режиме работы с proxy-сервером:
```bash
make start-local-proxy
```

5. Запускаем тест в режиме записи ответов бэкенда:
```bash
yarn test:e2e-create <путь к файлу теста>
```
Выполнение этой команды удаляет все существующие заглушки в папке `__e2e_mocks__` (если она есть).

6. Добавить все файлы из папки `__e2e_mocks__` в git

После запуска в папке с тестом появится новая папка `__e2e_mocks__` с записанными ответами бэкенда

## Запуск теста локально

Чтобы проверить, что тест работает, его можно запустить локально в двух режимах: обычном и режиме отладки (со стартом браузера). При запуске в этом режиме новые файлы заглушек ответов бэкенда не создаются.

1. Обычный режим

```bash
make start-local-proxy

yarn test:e2e-play <Пусть к файлу с тестом>
```

2. Режим отладки:

```bash
make start-local-proxy

yarn test:e2e-play-debug <Пусть к файлу с тестом>
```

## Переопределение ответов бэкенда

В тесте можно модифицировать реальные ответы бэкенда, это бывает полезно, когда получить желаемый ответ от реального сложно или невозможно в тестинге. Технически, можно просто переписать файл в папке `__e2e_mocks__`, но при таком подходе при перезаписи этого теста (e2e-create) придется вносить аналогичные изменения, поэтому лучше описывать изменения прямо в коде теста.

Деалется это с помощью параметра при старте proxy-сервера:

```ts
const server = new Server({
    // Ключом является имя ресурса (можно посмотреть в папке __e2e_mocks__
    blackbox: (body: Record<string, unknown>, req: Express.Request) => {
        body.phones = PHONES;

        return body;
    },
});
```


## Изменение хоста ручки

Чтобы избавиться от перезаписи всех тестов при изменении ручки в .env можно воспользоваться командой:

```
make rename-e2e-mocks host-from=old.host.path host-to=new.host.path
```
