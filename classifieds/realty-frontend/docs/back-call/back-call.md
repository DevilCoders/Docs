# Обратный звонок
## Общие сведения
Это функция на сервисе, которая позволяет пользователю не звонить по ЖК или офферу самому, а попросить продавца перезвонить ему.
Обратный звонок можно запросить только у застройщика: через ЖК/КП, оффер ЖК/КП или самого застройщика.
Обратный звонок доступен только для платных объектов (у которых есть история биллинга/billingDump). В случае звонка через страницу застройщика, у застройщика должна быть подключена расширенная карточка, либо же это вообще должен быть спецпроект.

### Компоненты для этого функционала выглядят следующим образом:

![desktop-form](desktop-form.png)\
_форма в десктопе_

![desktop-modal](desktop-modal.png)\
_модалка в десктопе_

![mobile-form](mobile-form.png)\
_форма в таче_

![mobile-modal](mobile-modal.png)\
_модалка в таче_ 

### Эти компоненты есть на следующих страницах/местах (возможно, список не полон):
- /tatarstan/zastroyschik/suvarstroit-1525537/ расширенная карточка застройщика
	- mobile
		- форма на странице
	- desktop
		- форма на странице

- /kotelniki/kupit/novostrojka/belaya-dacha-park-299766/ карточка ЖК
	- mobile
		- форма под разделом "участники строительства" внизу страницы
		- модалка с формой в галерее
	- desktop
		- форма справа от галереи под кнопкой телефона
		- форма в плавающем блоке справа
		- форма в разделе "участники строительства"
		- кнопка "позвоните мне" на сниппетах других ЖК в разделе "Объекты от застройщика"
		- форма в попапе планировок

- /kotelniki/kupit/novostrojka/belaya-dacha-park-299766/<planirovki/otzyvy/hod-stroytelstva/ipoteka> SEO-страницы карточки ЖК
	- desktop
		- форма в плавающем блоке справа
		- попап планировок (на странице `/planirovki`)
		- карточки в разделе "объекты от застройщика"
		
- /offer/3389990977146441646/ карточка оффера в ЖК / КП
	- mobile
		- форма под разделом "участники строительства" внизу страницы
	- desktop
		- форма справа от галереи под кнопкой телефона
		- форма в фулскрин-галерее под кнопкой телефона
		- форма в теле карточки: раздел "застройщик"
		
- /moskva_i_moskovskaya_oblast/kupit/kottedzhnye-poselki/orlov-1832934/ карточка КП
	- mobile
		- форма под разделом "участники строительства" внизу страницы
		- модалка с формой в галерее
	- desktop
        - форма справа от галереи под кнопкой телефона
		- форма в плавающем блоке справа
		- форма в разделе "участники строительства"
        - форма в фулскрин-галерее под кнопкой телефона 
		- кнопка "позвоните мне" на сниппетах других ЖК в разделе "Объекты от застройщика"
		
- /pik/?newbuildingId=1686471 спецпроект пика
	- desktop
		- кнопка в шапке (звонок по id застройщика)
		- кнопка на сниппетах ЖК (звонок по id ЖК)
		- кнопка на запиненном сниппете ЖК

- /samolet/ спецпроект самолёта
	- desktop
		- кнопка на сниппетах ЖК

- /moskva/kupit/novostrojka/ выдача ЖК
	- desktop
		- кнопка на обычном сниппете
		- кнопка на премиум-сниппете
		
- /moskva_i_moskovskaya_oblast/kupit/novostrojka/karta выдача ЖК на карте
	- desktop
		- кнопка на сниппете
		
- /favorites/ избранное (только разделы ЖК / КП)
	- desktop
		- кнопка на сниппете
		
- /favorites/karta/ избранное, карта
	- desktop
		- кнопка на сниппете

## Технические подробности
### Вкратце про [telepony](https://wiki.yandex-team.ru/vertis/telepony/) и бэкенд
Телепони - это внутривертикальный сервис для работы со звонками. В контексте функции обратного звонка бэкенд использует его следующим образом:
1. В запросе с фронта приходит номер телефона пользователя
2. Из объекта ЖК/КП/застройщика достаётся номер телефона застройщика
3. В телепони создаётся заявка на соединение двух абонентов: пользователя и застройщика
4. Телепони звонит двум абонентам из предыдущего пункта и склеивает эти звонки в один, будто это прямой звонок

### Ручки
- **ЖК** http://realty-gateway-api.vrts-slb.test.vertis.yandex.net/index.html?url=/api/2.x/#!/newbuilding/newbuildingCallbackCreateRoute)
- **КП** http://realty-gateway-api.vrts-slb.test.vertis.yandex.net/index.html?url=/api/2.x/#!/village/villageCallbackCreateRoute
- **Застройщик** http://realty-gateway-api.vrts-slb.test.vertis.yandex.net/index.html?url=/api/2.x/#!/developer/createDeveloperCallback

_ручки могут отдавать статус 409 в том случае, когда на телефон ранее уже была создана заявка, и она ещё не исполнена_

Эти ручки имеют одинаковые сигнатуры и отличаются только path'ом. В [ресурсе telepony](../../realty-core/app/resource/realty3/telepony.js) происходит выбор нужной ручки.

В body запросов к этим ручкам есть параметры `trafficInfo` и `tag`.
- `trafficInfo` - набор параметров, формируемых в контроллере страницы, нужный для сбора статистики, остался как легаси от предыдущей реализации обратных звонков (не через `telepony`, а через внешний сервис `callkeeper`)
- `tag` - тот же тег, что передаётся в ручку подменных телефонов; нужен для правильного обилливания обратных звонков в зависимости от места на сервисе  

Помимо этих параметров, конечно, передаётся сам номер телефона, на который нужно перезвонить: параметр `sourceNumber`.

### Клиентская логика
#### Контроллеры
**Условие показа формы обратного звонка** - наличие поля  `backCallTrafficInfo` в карточке ЖК/КП/застройщика. Это поле появляется в них в контроллерах.
Примеры: [адаптер ЖК](../../realty-core/app/adapters/getSiteSnippet.js), [контроллер оффера](../../realty-mobile-www/app/controller/pages/offer.js).

#### [Гейт](../../realty-core/app/controller/gates/back-call.js)
Актуальный метод, использующийся общим HOC'ом - `makeCallTeleponyV2`.

#### [HOC](../../realty-core/view/react/modules/back-call/enhancers/withBackCallApi.tsx) и синхронизация с localStorage
- синхронизирует обратные звонки с `localStorage`
- делает запросы к гейту
- достаёт дефолтный телефон пользователя и отдаёт его потребителям
- мапит ошибки в понятный для потребителей формат

См. более подробную документацию в файле с кодом по ссылке выше.

#### Компоненты
Есть четыре компонента с неконсистентным неймингом, подключенных с помощью HOC'a `withBackCallApi`:
- десктопная форма: [BackCall](../../realty-www/view/react/deskpad/components/BackCall/index.tsx)
- десктопная модалка с формой [BackCallModal](../../realty-www/view/react/deskpad/components/BackCallModal/index.js)
- мобильная форма [BackCallForm](../../realty-mobile-www/view/components/BackCallForm/index.js)
- мобильная модалка с формой [BackCall](../../realty-mobile-www/view/components/BackCall/index.js)
