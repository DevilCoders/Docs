# Правила проведения релиза

**ВАЖНО: релизную ветку НЕ НАДО никуда ребейзить! Они должна остаться в том же состоянии, в котором из нее собирали пакет!
В этом же состоянии ее надо замержить в мастер!**

**Если в релизную ветку внесены изменения кода, пересоберите пакет!**

**Важно:** Считаем релиз стабильным, если его не забраковали в течение трёx часов с момента выкладки в продакшен. Назовём этот отрезок времени "**периодом нестабильности**".

### Общими словами о релизе
Релиз собирает и катит тестировщик. Помогает ему дежурный и, если необходимо, разработчик сложной фичи из релиза.

* Создается релизная ветка: обычный релиз — от мастера, хотфикс — от последнего релиза.
* В релизную ветку вмерживаются фича-ветки, либо черри-пикаются нужные коммиты, если это хотфикс.
* Приложение собирается в TeamCity.
* После этого автоматически через Шиву катится в тестинг и ветку `test_fixes` в проде (это ветка интеграционных тестов от тестирования).
* Происходит регресс: а) запускается джоба в TeamCity с автотестами, в ветке `autotest`, и б) тестировщики руками прогоняют тест-план в тестинге.
* После этого релиз промоутится в канари (то есть раскатывается в продакшн на 1% пользователей). В графане есть [каранеечные графики](https://grafana.vertis.yandex-team.ru/d/-ijMOSW7z/autoru-nodejs-frontends-canary?orgId=1&refresh=1m&var-datasource=Prometheus&var-job=af-desktop), по которым можно судить о стабильности релиза.
* После тридцати минут наблюдений пакет раскатывается на 100% в проде.
* После трех часов, если ничего не сломалось, то релизная ветка вмерживается в мастер (все PR автоматически закрываются).

### Сборка проектного релиза:
 1. Перед сборкой необходимо смержить все открытые PR с тэгом `release`, у которых с момента создания
 прошел **период нестабильности**
 2. Создать ветку проектного релиза с именем `release_<date>_<project>` из `master` или предыдущего релиза (если указано в релизном тикете).
 3. Смержить в новосозданную ветку все задачи со статусом **протестировано** из релизного тикета(`*`) в трекере
 4. Запустить сборку ветки в соответствующем проекте в [TeamCity](https://t.vertis.yandex-team.ru/project/vs_frontend_Applications_AuroRuFrontendRepo)

`*` - традиционно, тестировщики выписывают названия веток, которые нужно вмержить в релиз, в описание релизного тикета.

### Последовательность действий после выкладки релиза в продакшен
1. Ответственный за выкладку релиза сразу после выкладки в продакшен **создаёт** PR для проектного релиза
и выставляет для него тэг `release`
2. Если в релизном тикете в трекере существует задача, [вызывающая проблемы обратной совместимости кода](#core_is_unstable),
то сотрудник **выставляет** тэг `unstable` для PR

Если в течение периода нестабильности релиз откатывается, то ответственный за релиз немедленно закрывает соответствующий ему PR.

По прошествии **периода нестабильности** любой сотрудник может вмержить релизный PR в `master` (если у PR нет тэга `unstable`!) и выполнить команду `./tools/git prune` для удаления веток, смерженных в `master`

### Когда выставляется тэг `unstable` для релизного тикета в трекере?
Если ваша задача потенциально вызывает проблемы обратной совместимости кода в одном из проектов, явно указывайте это в релизном тикете в трекере. Если такая задача не проходит тестирование в одном из проектов,
то PR релизных веток `auto-core` для остальных проектов помечаются тэгом `unstable`.

### Параметры
- `<date>` - дата выкладки релиза в продакшен (в формате 25.11.2015)
- `<project>` - имя проекта (desktop, mobile)

###  Оповещения
* [Настройка оповещений TeamCity](https://wiki.yandex-team.ru/autoru-dev/build/teamcity-notifications/);
* Подписаться на выкладки в телеграм-канале **Auto.ru Deploy** через запрос к админам.
