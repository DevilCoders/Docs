# Пакет отвечает генерацию pdf

В этот пакет ходит desktop (```/history/[ id ]```) и desktop-lk (```/my/reports/```) и аппы.

## Схема работы:

1. При скачивании со страницы отчёта, либо по прямому урлу из почты или апппов, пользователь попадает на урл ```/download-report/[ vin ]```. Там идет обработка ошибок самого принтера. Контроллер живет в десктопе.
2. Запрос приходит по урлу ```/printer/pdf/?content=history&id=[ vin ]``` в принтер и попадает в мидлвару, которая обрабатывает куки и заголовки и с помощью стандартных методов **pupeteer** прокидывает их дальше в браузерную ферму, и уже после этого идет туда же за страницей отчёта.
3. Браузерная ферма открыает страницу, уже подготовленную к печати (```/printer/history/[ id ]```). Страница тоже живет в принтере. Да, в некотором роде пакет ходит сам в себя. Страница либо отдает полный отчёт, либо ошибку. Это важно! У мидлвары нет доступа к данным, на основе которых отрендерилась страница, а парсить html просто так мы не хотим.
4. Если страница успешно отрисовалась, мидлвара снимает с неё pdf и прокидывает дальше. Если нет - отдает ошибку.
5. ```/download-report/[ vin ]``` отдает пользователю pdf, либо корректно обрабатывает ошибку принтера и редиректит куда следует.

Хотя бек хранит логику доступа к полной версии отчёта у себя, урлы пакета всё равно НАРУЖУ НЕ СВЕТИМ.
При желании в пакет можно подселить генерацию pdf на основе других страниц и данных.

## Браузерная ферма

Живёт здесь https://a.yandex-team.ru/arcadia/classifieds/chrome-puppeteer

## Дебаг

Урл, по которому отдается pdf: ```/printer/pdf/?content=history&id=[ id ]```.
Урл, по которому отрисовывается страница для печати: ```/printer/history/[ id ]```.

При дебаге надо помнить что для pdf учитываются **media print** и просто при просмотре страницы в браузере не всё будет ровно так же как в pdf. Ширина страницы для печати по умолчанию 800px, но она ещё ужмется полями до 752px. Верстку подвала мы вставляем как скрытый элемент и потом достаем из html. pupeteer позволяет отметить места, куда нужно подставлять счетчики страниц.
