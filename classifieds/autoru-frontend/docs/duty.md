# Про дежурство и мониторинги

**Дежурный** — член команды, снимающий непроектную нагрузку с команды.
Ему помогает резервный дежурный — как правило, человек, дежуривший перед ним.
Порядок назначения дежурных совпадает с канбан-доской, срок дежурства — неделя.
Узнать, кто сейчас дежурит, посмотреть график дежурств, а также подтвердить даты своего дежурства можно в [ABC](https://abc.yandex-team.ru/services/autoru/duty).

## Обязанности дежурного в порядке приоритета:

1. Реагирует на мониторинги. Подписываемся здесь [JugglerSearchBot](https://t.me/JugglerSearchBot) (основной бот мониторинга). И далее (juggler ([раз](https://juggler.yandex-team.ru/aggregate_checks/?query=host%3Dvertis_ops_autoru-frontend) и [два](https://juggler.yandex-team.ru/notification_rules/?query=rule_id=5e57d57cef1625006ec4bc40)) + [grafana](https://grafana.vertis.yandex-team.ru/d/jUwX30jMk/autoru-frontends-summary)) и сигналы от саппорта/смежников. **Как смотреть и грепать логи написано ниже и вот [тут](./grep-logs.md)**. Если не получается оперативно потушить, заводится таск и проблема эскалируется до других членов команды и тимлида.

2. Помогает тестировщикам выкатить релизы (см. [ниже](#о-релизах)). [Свинка Пеппа](https://t.me/+SySHZYNbrOQ2NzEy) - Чат коммуникации с QA командой

3. Следит за фильтром ревью ([фильтр](https://st.yandex-team.ru/filters/filter:40633)). Ревьюеры проставляются ботом, но иногда задача зависает в ревью надолго, а ревьюер может уйти в отпуск или заболеть, либо задача надолго зависает в статусе Resolved. SLA на ревью — сутки, поэтому если в тикетах из фильтра нет движения больше суток, дежурный должен пинговать исполнителя, ревьюера или менеджера. Это обязанность дежурного, потому что код-ревью — задача разработки.

4. Отвечает на вопросы смежников; если не знает ответа — находит человека, который занимался этой задачей, и перенаправляет к нему, к своему тимлиду или в чат AUTORUFRONT.

5. Три дня берёт задачи [отсюда]( https://st.yandex-team.ru/issues/416502) и делает их в порядке следования. Если решить задачу за время дежурства не успевает, то всё равно нужно доделать. Либо, в порядке исключения, передать следующему дежурному.

**Важно** понимать, что задачи дежурного требуют скорого и качественного решения, от них зависит скорость выкатки релизов. Поэтому есть дополнительные правила, когда нужно обратиться к старшему разработчику или попросить помощи у команды:
* если баг релиза или конфликт при мерже не удаётся решить или определить причину за полчаса;
* если в PR есть непонятные моменты, особенно, относящиеся к архитектуре проекта;
* если решение бага из бэклога занимает больше половины дня.

## О релизах

Если что-то сломалось в релизе, упали тесты или есть конфликты с мастером, к дежурному придёт тестировщик и попросит всё починить. Если удалось локализовать проблему и понять, чья задача всё сломала, можно смело идти к автору задачи, если нет - нужно чинить самому. Координацией занимается дежурный, чтобы тестировщику не пришлось бегать самому между авторами задач и дежурным.

**Запрещено подливать мастер в релизные ветки без согласования с тестировщиком.** Ветка может находиться в стадии регресса, а в мастере может оказаться код из других релизов, из-за которого регресс придётся проводить заново.

**Ребейзить релизную ветку тоже запрещено**, из-за этого слетят релизные теги: после ребейза поменяются хеши git-коммитов, а следовательно все уже собранные релиз-теги будут указывать на несуществующие коммиты и мы не сможем собрать хотфикс при необходимости.

### Хотфиксы
Если в свежевыкаченном релизе нашлась какая-то ошибка, которую нужно срочно починить, но релиз откатывать не хочется, либо в проде обнаружилась ошибка, требующая немедленного исправления, нужно катить хотфикс. Для этого создаётся ветка **не от мастера, а от текущего прод-тега**. Это нужно, чтобы выкатить релиз с минимальными изменениями от текущего, без всего того кода, который успел попасть в мастер после предыдущего релиза.

Делается это так (на примере пакета `af-desktop`):
- идем в [админку](https://admin.vertis.yandex-team.ru/services/af-desktop), берем оттуда версию контейнера из прода.
Версия контейнера — это хеш git-коммита, из которого собран релиз, при сборке в git ставится тег `<docker-name>_<version>`. Теги можно посмотреть [в гитхабе](https://a.yandex-team.ru/arcadia/classifieds/autoru-frontend/releases).
- чекаутим прод-тег,  создаём ветку и т.д.:
```sh
# чекаутим прод-тег
$ git checkout af-mobile_6866ed2fd28
# создаем из него ветку для хотфикс
$ git checkout -b mobile_hotfix
# фиксим, пушим, собираем
````

### Мёрж релизных веток в мастер
Мониторить релизные PR лучше самостоятельно и не ждать, пока придет тестировщик. PR можно найти по такому фильтру - `is:open is:pr label:release label:branch:stable`. Если к PR был добавлен тег `branch:stable` более 4 часов назад, тесты зеленые и конфликтов нет, нужно вмержить PR в мастер, нажав на кнопку "Merge pull request". Если есть конфликты или тесты красные, нужно пофиксить и тогда уже вливать в мастер.

## Про мониторинги и логи
Стоит ознакомиться с [докой про логи](./grep-logs.md) и [докой про мониторинги](https://a.yandex-team.ru/arcadia/classifieds/autoru-frontend/docs/monitoring.md), там есть список всех дашбордов с краткими описаниями и примерами использования в различных ситуациях.

Процесс нахождения проблемной ручки выглядит примерно вот так:
1. Идём на [сводный дашборд по всем сервисам](https://grafana.vertis.yandex-team.ru/d/jUwX30jMk/autoru-frontends-summary), видим 500ки от какого-то конкретного сервиса.
1. Идём на [дашборд по сервисам](https://grafana.vertis.yandex-team.ru/d/000000595/autoru-nodejs-frontends), выбираем проблемный сервис, изучаем ситуацию.
1. Идём на [дашборд с графиками отдельных ручек](https://grafana.vertis.yandex-team.ru/d/gijPm-Iik/autoru-nodejs-frontends-backend-total-timings), находим какая конкретно ручка не работает и что с ней не так (500ки, таймауты и т.д).
1. Не лишним будет посмотреть как выглядит эта же ручка со стороны бекенда. На дашборде publicAPI, например.

Чтобы постоянно не смотреть на графики, полезно подписаться на бота Juggler. Это система событийного мониторинга, которая шлёт сообщения в Телеграм, если количество ошибок резко возрастает выше какого-то лимита (они начинаются со слова CRIT), и если количество ошибок падает (OK). Чтобы подписаться на сообщения juggler, нужно добавить свой ник сюда [Juggler](https://juggler.yandex-team.ru/notification_rules/?query=rule_id=5c88e5192c7c4400738b9b5e).
Не все ошибки связаны с нодой, у нас есть [Error booster](https://error.yandex-team.ru/projects/auto_ru) — это агрегатор JS-ошибок.

**Что делать, если пришла ошибка:**

1.a Посмотреть на графики и локализовать ошибку до ручки и страницы

1.b Погрепать [логи](./grep-logs.md):

__Руками для старых пакетов__:

```sh
ssh logs.vertis.yandex.net
cd /var/remote-log/
tail -f nodejs-*.prod.vertis.yandex.net/node-init-cluster/autoru-frontend-desktop/*.log | grep Error
```
Где `autoru-frontend-desktop` — название пакета, а `Error` — текст, который вы хотите найти.

__Для новых пакетов__ - посмотреть в [Grafana](https://grafana.vertis.yandex-team.ru/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22vertis-logs%22,%7B%22expr%22:%22%22,%22fields%22:%5B%22thread%22,%22context%22,%22message%22,%22rest%22%5D,%22limit%22:100%7D%5D) (для пакетов в облаке, которые деплоятся через Shiva).
Пример запроса (по ссылке выше есть подробное описание языка запросов):
```
service=af-desktop layer=prod rest.response_code=520
```
Кликнув по любому результату в поиске можно настроить отображение полей. Например, только response_code и request_url.

2. Если это ошибка на стороне фронта, то сообщить тестировщикам (и в чат AUTORUFRONT); если со стороны бекэндов — в чат vertical-duty.

3. Завести тикет в соответствующей очереди (`AUTORUFRONT` или `AUTO`) с типом Bug.

4. Если это критичная ошибка — починить (или откатить релиз). Выкатки релизов можно посмотреть тут: [Список релизов](http://autoru-beggar-web.vrts-slb.test.vertis.yandex.net/releases).

У нас есть провязки на Морде Яндекса и в ПП, пакет называется [af-search-app](
https://grafana.vertis.yandex-team.ru/d/000000595/autoru-nodejs-frontends?refresh=1m&orgId=1&var-datasource=Prometheus&var-job=af-search-app&var-dc=All&var-group=All). Иногда мы получаем слишком много трафика и ложимся. Чтобы отключить эти провязки, пишите нашим маркетологам, начиная с [@vilianinovamm](https://staff.yandex-team.ru/vilianinovamm), кому-нибудь [из Морды](https://staff.yandex-team.ru/departments/yandex_distproducts_morda/), либо заводите тикет в **HOME** ([типа такого](https://st.yandex-team.ru/HOME-59157)).

## Чаты
 Список всех чатов есть тут [Чаты Вертикалей](https://wiki.yandex-team.ru/verticals/chats/).
Чаще всего могут понадобиться (подписаться и размьютить обязательно):
- [JugglerSearchBot](https://t.me/JugglerSearchBot)
  Основной бот мониторинга
- [Свинка Пеппа](https://t.me/+SySHZYNbrOQ2NzEy)
  Чат коммуникации с QA командой
- [vertical-duty](https://t.me/joinchat/BGV6Pj5M0IoB3PH5qXJLyg)
- [auto.ru public api](https://t.me/joinchat/BWIidg6ix2iTm27RylNJoA)
- [AUTORUFRONT](https://t.me/joinchat/QF85IeRwj9WYurIc)
