# Первые шаги

Здесь описан пошаговый процесс разворачивания проекта фронта [Авто.ру](https://auto.ru).
Проект включает в себя серверное Node.js приложение и клиентский код (все в одной монорепе).

<a name="project_location"></a>
## Тачка для разработки

У каждого разработчика фронтенда Авто.ру есть выделенная виртуалка в [QYP](https://qyp.yandex-team.ru/?my=no).
Виртуалка доступна по адресу `<LOGIN>.dev.avto.ru`.
Соответственно все проекты будут открываться по адресу `https://<название-рабочей-копии>.<LOGIN>.dev.avto.ru`.
Например, `https://frontend.aandrosov.dev.avto.ru`.

*Немного подробностей.*
На самом деле полный адрес виртуалки имеет вид `<LOGIN>-01-dev.sas.yp-c.yandex.net`.
Для нашего удобства админы делают нам алиасы в DNS, таким образом физическую виртуалку можно менять, а все урлы остаются как есть:
- `<LOGIN>.dev.avto.ru`
- `<LOGIN>.dev.vertis.yandex.ru`

```sh
$ host privet.aandrosov.dev.vertis.yandex.ru
privet.aandrosov.dev.vertis.yandex.ru is an alias for aandrosov-01-dev.sas.yp-c.yandex.net.
aandrosov-01-dev.sas.yp-c.yandex.net has IPv6 address 2a02:6b8:c1b:2317:0:1459:ba23:0

$ host privet.aandrosov.dev.avto.ru
privet.aandrosov.dev.avto.ru is an alias for aandrosov-01-dev.sas.yp-c.yandex.net.
aandrosov-01-dev.sas.yp-c.yandex.net has IPv6 address 2a02:6b8:c1b:2317:0:1459:ba23:0

```

Рабочее приложение поднимается именно на виртуалке, это позволяет создать приближенную к продакшену среду выполнения.

Виртуалка доступна только из внутренней сети Яндекса (извне можно использовать VPN), для работы с виртуалкой нужно подключиться по ssh.

<a name="project_ssh"></a>
## Настройка ssh
Как правильно настроить ssh, написано в [вики](https://wiki.yandex-team.ru/diy/macos/ssh/#generacijaparykljuchejj).

После настройки подключаемся `ssh <SERVER_NAME>.sas.yp-c.yandex.net` (пример ssh aandrosov-01-dev.sas.yp-c.yandex.net)

<a name="project_repo"></a>
## Работа с репозиторием
Есть два способа для работы с кодом проекта:
1. Хранить репозиторий на локальной машине (ноутбуке) и синхронизировать изменения с виртуалкой с помощью RealSync и подобных средств
2. Редактировать код непосредственно на виртуалке по ssh + Vim (и подобные)

Для регулярных проектных задач удобнее использовать первый способ, так как скриншотные тесты пока заводятся только на локальной машине.


### RealSync

Для односторонней синхронизации исходников в виртуалку удобно использовать [RealSync](https://github.com/DmitryKoterov/dklab_realsync); в README проекта можно найти подробное описание и инструкции по установке для различных ОС. [Пошаговая настройка синка](./realsync.md).

После первоначальной настройки в директории синхронизируемого проекта сгенерируется файлик .realsync, нужно проверить, что есть незакомментированная строчка `exclude_file = .gitignore`, чтобы rsync не синзронизировал лишний мусор вроде node_modules  ([пример конфига .reaslync](https://paste.yandex-team.ru/908878))

<a name="project_init"></a>
## Первоначальная настройка виртуалки

Первоначальная настройка виртуалки выполняется автоматически ansible-скриптами.
Админские плейбуки накатывают общие пакеты + у нас есть [фронтовый плейбук](https://a.yandex-team.ru/arcadia/classifieds/infra/vertis-ansible/roles/frontend-dev/tasks/main.yml), который тоже накатывается автоматически.

Проверить наличие своей виртуалки в списке для автоматической настройки можно [здесь](https://c.yandex-team.ru/groups/vertis_vdev_personal_frontend). Если ее там нет, то надо написать [Игорю Бирюлину](https://staff.yandex-team.ru/ibiryulin).

Автоматическая настройка виртуалки займет до 1 часа. Как проверить:
```
# Стоит свежая нода
$ node --version

# Есть файл с геобазой
$ ls -l /var/cache/geobase/geodata6.bin
```

Если все ок, то можно идти дальше.

<a name="project_init"></a>
## Запуск проекта

1. Клонируем репозиторий на dev-машину (виртуалку):

(если используется RealSync, то исходники уже скопированы на виртуалку, этот шаг можно пропустить)

Клонировать репозиторий нужно в домашнюю директорию на виртуальной машине (`cd ~`).

 ```bash
 git clone git@github.com:YandexClassifieds/autoru-frontend.git frontend
 ```

2. Все наши сайты работают в https-only режиме, поэтому надо сгенерировать себе валидный SSL-сертификат.
```bash
# заходим в репозиторий с проектом
cd frontend

# генерируем сертификат
make load-ssl-cert
```

Если нужен какой-то специфичный сертификат - можно подложить его айдишник в файлик `tools/load-cert/.env` в формате `CERT_ID=4351862` и запустить скрипт - он скачается из crt.yandex-team.ru и скопируется куда нужно

Важно, чтобы на стаффе был добавлен актуальный SSH-ключ

3. Собираем нужный проект
```bash
 cd <PROJECT_NAME>
 make
 ```
 где `<PROJECT_NAME>` - это `www-mobile`, `www-desktop`, `www-cabinet` или `www-poffer`

В качестве названия папки можно использовать что угодно, не только `frontend`, поднимая таким образом много копий проекта. Тогда эта копия будет доступна как `<название_папки>.<SERVER_NAME>.dev.avto.ru`

4. Наслаждаемся результатом

Если все прошло хорошо, то сайт будет доступен по URL (проект `www-desktop`):
`https://frontend.<LOGIN>.dev.avto.ru`

Для проекта `www-mobile`:
`https://m.frontend.<LOGIN>.dev.avto.ru`

Если поддомены не резолвятся, значит, админы забыли добавить вайлдкард - нужно пингануть их и подождать.

Важно понимать следующее: структура доменов 1-в-1 соответствует структуре auto.ru, только базовым доменом является ваш dev-хост (`frontend.<LOGIN>.dev.avto.ru`)

<a name="project_editor"></a>
## Настройка редактора для работы с кодом

Для более удобной работы с проектом можно выбрать и настроить редактор кода в соответствии с [этой докой](./editor.md)


## Для запуска скриншотных тестов

Установить и запустить docker и выполнить инструкцию https://wiki.yandex-team.ru/docker-registry/#authorization

## Что дальше?
Прочти другие важные доки из [списка](./README.md): всё про работу с React, как мы пишем css, что такое descript, как происходит процесс работы над задачей и многое другое.
