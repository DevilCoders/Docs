# A/B-эксперименты

A/B-эксперименты позволяют включать какую-нибудь функциональность на ограниченную группу (бакет) пользователей.
В Яндексе они реализованы через UaaS (UserSplit as a Service), бакет привязывается по `device_id/autoruuid`.


## Как использовать
В код приходят [тут](https://a.yandex-team.ru/arcadia/classifieds/autoru-frontend/auto-core/lib/app/middleware/experiments.js).

На сервере в ноде:
```js
if (req.experimentsData.has('EXPERIMENT_ID')) {
    // do something
}
```

В React.js в `context` есть функция `hasExperiment`
```js
if (this.context.hasExperiment('EXPERIMENT_ID')) {
    // do something
}
```

В `priv.js` эксперименты можно подключать через
```js
if (data.experimentsData.has('EXPERIMENT_ID')) {
    // do something
}
```

Принудительно включить или выключить какой-либо эксперимент (например, при разработке) можно с помощью GET-параметра
`?exp_flags=EXPERIMENT_ID1,EXPERIMENT_ID2`. В этом случае ставится сессионная кука, которая запомнит параметр.
**ВАЖНО**: при принудительном включении экспериментов все другие будут выключены! Чтобы исключить попадание в любой эксперимент, можно передать несуществующий флаг.

Чтобы попасть в выборку определенного экспа, можно использовать параметр `test-id`
`?test-id=123_321`. Айдишники отделяются друг от друга с помощью `_`. Они берутся из [админки АБТ](https://ab.yandex-team.ru/testid#queue_id=47).
Логика работы как с `exp_flags`. Проставится одноименная сессионная кука, чтобы запомнить параметр
**ВАЖНО**:
1) При принудительном включении экспериментов все другие будут выключены!
2) Не использовать вместе с кукой `exp_flags`. Она перебивает `test-id`, так как при ее использовании мы не ходим за конфигом экспов в uaas

Эксперименты обычно именуются `TASK-ID_description`, например, `AUTORUFRONT-2703_no-fresh`. Если названия эксперимента нет в таске на разработку, то разработчик может придумать его сам и добавить в описание таска.

### Девтулзы

Лучше всего использовать специальные девтулзы, которые можно найти в левом нижнем углу экрана.
1) В блоке "Выборки" можно указать значения параметра `test-id` через запятую.
2) В блоке "Применённые флаги" указываются значения `exp_flags` через запятую.
3) В блоке "Текущие эксперименты" будут указаны все включенные эксперименты, которые пришли из UaaS.
4) В блоке "Все эксперименты" отображаются вообще все эксперименты из очереди AUTORUFRONT, которые сейчас созданы в админке АБТ. Эксперименты можно фильтровать по заголовку, тикету, автору или id выборки.
**ВАЖНО**:
1) При любых манипуляциах с экспериментами, чтобы изменения применились, необходимо перезагрузить страницу
2) Если устанавливаем параметр `test-id` со значением -1, то выходим из всех экспериментов

**Доработки на будущее**:
1) показывать на мобилке

## Список активных экспериментов

Список активных экспериментов можно посмотреть [в админке АБТ](http://ab.yandex-team.ru/config/131).

## Удаление старых экспериментов

От старых экспериментов есть две проблемы:
1) они лежат в коде и увеличивают его объем
2) могут замедлять разработку, т.к. надо учитывать их условия
3) раздувают [размер заголовка ответа от uaas](https://solomon.yandex-team.ru/?project=uaas&cluster=production&service=usersplit&l.metric=max_exp_flags_len&l.host=all&l.split_service=auto_ru&graph=auto&b=2021-12-24T10%3A23%3A21.458Z&e=2022-01-24T10%3A23%3A21.458Z)

Поэтому важно регулярно, а лучше сразу после эксперимента, удалять старые эксперименты.
Процесс:
1) удостовериться у менеджера, что он правда не нужен.
2) удалить код эксперимента, обычно ищется по названию эксперимента или таска.
3) удалить эксперимент [из админки АБТ](http://ab.yandex-team.ru/config/131).
