# Секретница

[Секретница](https://yav.yandex-team.ru/) - это сервис, который помогает разработчикам безопасно хранить, получать и обновлять секреты для приложений, например, токены.

Вот [тут](https://vault-api.passport.yandex.net/docs/) можно почитать официальную документацию, а [тут](https://wiki.yandex-team.ru/security/secrets/) есть правила хранения и передачи секретов для всего Яндекса.

В секрете может храниться несколько пар ключ-значение, например, в рамках одного секрета могут лежать токены и для тестинга и для прода.

Для каждого секрета можно назначить доступы на просмотр/редактирование для конкретного человека или группы. Рекомендуется выдавать доступ группе на Стаффе/ABC, а не отдельному человеку, чтобы не удалять вручную тех, кто ротировался или уволился, и не добавлять тех, кто добавился.

## Как работать с секретами

Работать с секретницей довольно просто, нужно лишь выполнить несколько действий.

### Создание

Для начала, секрет нужно создать.

Заходим в интерфейс [секретницы](https://yav.yandex-team.ru/), тыкаем на «Новый секрет» и заполняем все необходимые поля.

![Секретница](./img/secrets/1.png)

**Важно:** к секрету нужно будет открыть доступы разработке и тестированию (нашей Службе разработки фронтенда и Группе тестирования Авто.ру).

![Доступы в секретнице](./img/secrets/2.png)

После того, как мы создали секрет, он будет доступен по [ссылке](https://yav.yandex-team.ru/secret/sec-01fpyjdn6ahyha9e7her8xh8mf).

### Использование в коде

В каждом пакете у нас лежит файл `secrets.config.json`, именно в нём мы и будем «подключать» наш секрет.

В нем секрету присваивается какой-то определенный ключ, например `AUTORU_MOOD`, а в качестве значения будет ссылка на сам секрет.

![secrets.config.json](./img/secrets/3.png)

Ссылка состоит из трёх частей, разделенных двоеточием:
1) ID секрета
2) ID версии
3) нужный нам ключ внутри самого секрета (как я уже писал выше, в одном секрете может храниться несколько пар ключ-значение)

Все три части ссылки мы можем найти на странице нашего секрета.

![secrets.config.json](./img/secrets/4.png)

Таким образом, ссылка на наш секрет будет выглядеть вот так:

`sec-01fpyjdn6ahyha9e7her8xh8mf:ver-01fpyjdn6meh3jpqb0vmjwjk6w:mood`

После этого в дев-окружении нужно сделать в корне проекта `make secrets`, чтобы обновить локальный файл с секретами, и мы сможем брать наш секрет из `process.env.AUTORU_MOOD`.

### Деплой

Последнее, что нужно сделать, это делегировать секрет в деплоилку для нужных сервисов, вот тут есть [дока](https://docs.yandex-team.ru/classifieds-infra/deploy/secret).

1) устанавливаем специальную cli-утилиту
```
brew tap YandexClassifieds/vertis git@github.com:YandexClassifieds/homebrew-vertis.git
brew update
brew install yandexclassifieds/vertis/sscli
```

2) добавляем OAuth-токен в bashrc (сам токен [тут](http://oauth.yandex-team.ru/authorize?response_type=token&client_id=f33f3a3b3fbe4f28a870ac070d60e681))

```
echo export VSS_OAUTH_TOKEN="<YOUR_TOKEN>" >> ~/.bashrc
```

3) делегируем секрет (указываем ID секрета и пакет, в который будем делегировать)
```
sscli delegate --secret-id sec-01f71jt9bje08vfe32vs6znq4r af-desktop
```

4) добавляем наш секрет в манифест деплоя, вот [пример](https://a.yandex-team.ru/arcadia/classifieds/services/pull/5900)

### Финал

Итак, подытожим, что нам в итоге нужно, чтобы работать с секретами:
1) созданный секрет в секретнице
2) добавить его в `secrets.config.json`
3) делегировать в деплоилку
4) прописать в манифесте деплоя

Если ты всё сделал правильно, то теперь ты - настоящий мастер секретов!
