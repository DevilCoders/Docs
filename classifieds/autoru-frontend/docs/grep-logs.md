# Разбираемся в логах

Часто у новичков, да и не только у них, возникают вопросы, на которые порой не так просто найти ответы:
- где посмотреть логи и как что-то в них найти
- что делать с ошибками на дежурстве, куда бежать и как узнать их причину (вот [тут](./duty.md), кстати, хорошая дока для дежурных)
- что такое YQL и как им пользоваться
- что означают все эти полоски в Jaeger
- и многие другие...

В этой доке мы попытаемся ответить на самые частые вопросы, с которыми сталкивается любой разработчик, разберем поподробнее таких монстров как [Grafana](https://grafana.vertis.yandex-team.ru) и [YQL](https://yql.yandex-team.ru), немного посмотрим на [Jaeger](https://jaeger.test.vertis.yandex.net) и перестанем бояться ошибок на дежурстве.

Сейчас существует три варианта смотреть логи:

- Grafana - для обычного поиска по логам, live-режима и прочего
- YQL - для более детального грепа с возможностью разными способами селектить данные и готовить результат
- Vtail - консольная утилита для потокового чтения логов в реальном времени

Подбробно мы разберем первые два способа, а для vtail есть отдельная [дока](https://docs.yandex-team.ru/classifieds-infra/logs/console).

Итак, поехали!

## Grafana

Начнем, пожалуй, с одного из самых полезных инструментов.

Grafana — это платформа с открытым исходным кодом для визуализации, мониторинга и анализа данных. Grafana позволяет создавать дашборды с панелями, каждая из которых отображает определенные показатели в течение установленного периода времени. Примеры таких дашбордов можно посмотреть вот в этой [доке](./monitoring.md). Там же описаны всякие интересные подробности про то, как это работает и как сделать свой дашборд.

Но Grafana это не только про графики и дашборды, там можно удобно смотреть [логи](https://grafana.vertis.yandex-team.ru/explore).

Для начала разберем интерфейс, а потом пройдемся по самым основным полям.

### Интерфейс

![Интерфейс Grafana](./img/grep-logs/1.jpg)

1) параметры, по которым будут фильтроваться логи (подробнее о них далее)
2) количество строк логов, которые будут выводиться (лучше не переусердствовать)
3) поля, которые будут выводиться в логах (тут есть и request_id и версия сборки и много всего другого, подробнее о них ниже)
4) временной интервал, за который будем смотреть логи (можно задать определенный интервал или же последние Х часов/минут)
5) кнопка для запуска процесса грепа
6) сброс всех параметров
7) clickhouse-запрос в YQL со всеми выбранными параметрами
8) кнопка, под которой прячется ссылка на мини-доку и немного подсказок

### Основные параметры

Есть много параметров, по которым можно фильтровать логи (пункт 1 со скриншота выше). Вот тут можно посмотреть [доку](https://wiki.yandex-team.ru/vertis-admin/logs/query-syntax/) про язык запросов - операторы, сравнения и другие полезные вещи, а вот [тут](https://docs.yandex-team.ru/classifieds-infra/conventions/logs) есть дока админов, где тоже есть полезная информация. Сейчас мы разберем самые основные параметры:

- **service** - пакет, который нас интересует (принимает значения af-desktop | af-poffer | af-amp и другие)
- **layer** - *слой*, в котором будем искать (принимает значения prod | test)
- **level** - *уровень* записи в логах, например, ошибка (принимает значения TRACE | DEBUG | INFO | WARN | ERROR | FATAL)
- **context** - поиск по контексту (можно искать по ручкам, например, publicApiSearch | publicApiReviews и другие)
- **request_id** - поиск по уникальному идентификатору запроса
- **rest** - содержит в себе кучу самых разных полей, о них ниже
- **branch** - если нужна конкретная ветка
- **version** - если нужна конкретная версия релиза (узнать версии, например, десктопа можно [тут](https://admin.vertis.yandex-team.ru/services/af-desktop) и вот [тут](https://admin.vertis.yandex-team.ru/releases?layer=PROD&serviceNames%5B0%5D=af-desktop))
- **dc** - если нужен конкретный ДЦ (принимает значения vla | sas)

### Параметры rest

Объект rest содержит в себе несколько полезных параметров:

- **rest.controller** - можно указать необходимый контроллер, например card-group
- **rest.request_url** - поиск по определенным урлам, можно с регулярками (например, `rest.request_url = *cars/used*` покажет нам логи из листинга б/у)
- **rest.request_headers** - позволяет искать по хэдерам (например, экспы можно смотреть вот так `rest.request_headers.x-exp-flags = *SEARCHER_VS_923_DISTANCE_SORTING*`)
- **rest.response_code** - код ответа (`rest.response_code = 404` покажет все 404, `(rest.response_code >= 500 rest.response_code <= 599)` покажет все 5хх)
- **rest.request_is_robot** - роботы
- **rest.request_is_parser** - парсеры

### Поля fields

Комбинируя необходимые параметры можно отыскать в логах именно ту информацию, которая интересует.

Для того, чтобы управлять тем, что именно будет показываться в логах, можно использовать поле Fields (пункт 3 со скриншота выше). Тут можно указывать уже заранее отобранные поля из выпадающего списка, такие как branch, rest, request_id, version и другие.

## YQL

YQL (Yandex Query Language) — универсальный декларативный язык запросов к системам хранения и обработки данных с основанным на SQL синтаксисом и поддержкой императивных пользовательских функций на C++, Python и JavaScript. Может использоваться для работы с данными в YT, YDB и ClickHouse, RTMR.

Вот [тут](https://yql.yandex-team.ru/docs/) можно посмотреть документацию, а вот [тут](https://moe.yandex-team.ru/courses/library/course/7) можно пройти ознакомительный курс, который познакомит со всякими основными штуками.

### Интерфейс

Интерфейс у YQL довольно простой:

![Интерфейс YQL](./img/grep-logs/6.jpg)

1) Текстовый редактор, где мы будем писать запрос
2) Результат
3) Кнопка запуска

### Операторы

#### USE

Всегда в значении `vertislogs`. Это директория, в которой будем искать логи.

#### SELECT

Указываем то, что мы хотим достать из таблички. Это будут колонки, которые мы хотим получить. Параметры такие же, как и в Grafana, но перед названием параметра пишем `_`.

Например, `_time, _time_nano, _layer, _service, _version, _branch, _canary,
_dc, _allocation_id, _context, _thread, _level, _request_id, _message, _rest`.

Если мы хотим достать какое-то одно поле из тела запроса, то селектор будет, например, таким:

`JSONExtractString(JSONExtractString(_rest, 'request_body'), 'request', 'phonesData', 'user_phone') as phone`

#### FROM

Всегда в значении `logs.logs`. Это YT-табличка с логами.

#### WHERE

Тут нужно указать то, по каким критериям мы будем фильтровать данные. Например, мы можем взять значение из какой-нибудь колонки и искать по нему, или же задать определенный временной интервал. Оператор `WHERE` пишется один раз, а все критерии поиска внутри разделяются оператором `AND`.

Например, вот так мы найдем логи за определенный временной интервал

`WHERE _time BETWEEN '2021-10-22 16:42:50' and '2021-10-22 17:12:50'`

А вот так за последний час в проде (для минут используется subtractMinutes)

`WHERE _time BETWEEN subtractHours(now(), 1) and now() AND _layer = 'prod'`

Поиск по конкретным полям выглядит проще, вот, например, поиск в тестинге  в таче

`WHERE _service = 'af-mobile' AND _layer = 'test'`

А вот так выглядит пример поиска в проде десктопа с определенным экспериментом. Очень похоже на то, как это делается в Grafana, только вместо `*` ставится символ `%`, который означает "любое количество символов". Функция `JSONExtractString` позволяет развернуть свойство объекта и найти что-то непосредственно в нём как в строке (например, в _rest.request_headers.x-exp-flags)

`WHERE _service = 'af-desktop' AND _layer = 'prod' AND like(JSONExtractString(_rest, 'request_headers', 'x-exp-flags'), '%SEARCHER_VS_923_DISTANCE_SORTING%'))`

Для добавления исключения используется оператор `NOT`. Вот так будет выглядеть пример выше, но для всех случаев, которые не попали под эксперимент

`WHERE _service = 'af-desktop' AND _layer = 'prod' AND NOT like(JSONExtractString(_rest, 'request_headers', 'x-exp-flags'), '%SEARCHER_VS_923_DISTANCE_SORTING%'))`

Можно искать что-то напрямую в _rest как в строке, но такой способ считается не очень надёжным. Например, вот так можно найти все запросы, где фигурирует слово breadcrumbs

`WHERE _rest LIKE '%breadcrumbs%'`

Для поиск по кодам ответа можно использовать функции `equals()`, `greaterOrEquals()`, `lessOrEquals()` и другие
`WHERE equals(JSONExtractFloat(_rest, 'response_code'), 404)`
`WHERE greaterOrEquals(JSONExtractInt(_rest, 'response_code'), 500) AND lessOrEquals(JSONExtractInt(_rest, 'response_code'), 599)`

#### GROUP BY

Мы можем группировать результат поиска по определенным полям. Вот так, например, мы можем сгруппировать выдачу по полю `_level`, в котором у нас хранится тип записи в логах (ошибка, варнинг и так далее) и посчитать количество каждой из них. Для этого в `SELECT` с помощью функции `count()` нужно посчитать количество. А в конце с помощью `GROUP BY` указать, по какому полю будем группировать выдачу. В качестве результата получим вот такую табличку

```
SELECT
    _level,
    count(_level) as num
GROUP BY _level
```

![Интерфейс YQL](./img/grep-logs/7.jpg)

#### ORDER BY

Логи можно отсортировать по определенному полю. Например, вот так мы отсортируем их по времени

`ORDER BY _time DESC`

#### LIMIT

Мы можем ограничить количество строк логов, которые получим в результате. Например, вот так мы получим максимум 50 строк

`LIMIT 50`

#### Примеры запросов

Если собрать в кучу всё то, что описано выше, то получится вот такой [запрос](https://yql.yandex-team.ru/Operations/YXLdoa5OD-0ymQpmHi1weTexVNLb6UxBBgumBIZsabc=), который поможет нам посчитать количество ошибок в ручке с крошками под экспом относительно нормальных ответов

![Интерфейс YQL](./img/grep-logs/8.jpg)

А вот [так](https://yql.yandex-team.ru/Operations/YXLf0gVK8IhSFu3eZ3FuHK4ODHAynN89_sFn4NyaUxQ=) найдем 404 ошибки в журнале за последние полчаса

![Интерфейс YQL](./img/grep-logs/9.jpg)

## Jaeger

Jaeger (читается «егерь») представляет собой сервис для сбора и отображения трейсов в распределенных системах.

Вот [тут](https://jaeger.test.vertis.yandex.net/) можно посмотреть трейсы тестинга, а вот [тут](https://jaeger.vertis.yandex.net/) продовские.

Трейсы живут около 24 часов, поэтому если нужно сохранить трейс на подольше, есть кнопка "Archive Trace".

### Интерфейс

Интерфейс Jaeger состоит из двух частей - [поиска](https://jaeger.vertis.yandex.net/search) и [детальной страницы трейса](https://jaeger.vertis.yandex.net/trace/e55e73207f37938b298a5ce432c73644).

![Интерфейс Jaeger](./img/grep-logs/14.jpg)

Слева можно заметить несколько полей, по которым можно искать определенные трейсы.

Там можно выбрать пакет (тут не только пакеты авто, так же недвижимость и другие), указать интересующую нас ручку, код ответа и временной интервал. Чем-то похоже на урезанную версию логов Grafana.

Тут же можно выбрать несколько трейсов через чекбокс и сравнить их друг с другом.

![Интерфейс Jaeger](./img/grep-logs/15.jpg)

Детальная страница трейса выглядит более непонятной.

Попасть на неё можно из поиска по трейсам, из кнопки в жуке или же просто указав нужный нам request_id в урле после /trace/.

Каждая разноцветная строка представляет собой один запрос к одному бэкенду. Многие запросы происходят по цепочке и это явно видно в дереве слева.

На каждый запрос можно нажать и посмотреть детальную информацию по нему. Например, хедеры, параметры, статус ответа и многое другое. Если запрос упал с ошибкой, то там покажется немного информации про ошибку.

![Интерфейс Jaeger](./img/grep-logs/16.jpg)

## Как что-то залогировать самому
Для логирования мы используем [@vertis/pino](https://a.yandex-team.ru/arcadia/classifieds/vertis-frontend/packages/pino) и вот [это](https://a.yandex-team.ru/arcadia/classifieds/autoru-frontend/auto-core/server/descript/logger.js).

Например, если мы захотим что-то залогировать, то можно сделать вот так:

```
const logger = require('@vertis/pino').child({ _context: 'debug_for_dealer_credit' });

logger.info({ _request_id: context.req.env.id, creditParams: params });
```

И потом в логах это можно найти через `context=debug_for_dealer_credit`
## Частые юзкейсы

Здесь перечислены ситуации, которые могут произойти и действия, которые помогут в них разобраться.

#### Пример 1

Повысился фон ошибок в десктопе и нужно понять, в чем причина. На графиках мы увидели, что появились ошибки, например, в листинге.

В таком случае можно собрать такой запрос в [Grafana](https://grafana.vertis.yandex-team.ru/s/t/eWi0-A4g4NaGQk) или [YQL](https://yql.yandex-team.ru/Operations/YXLhy9K3DJ9c1yxJVtjwaDZzZqYhznPMmhhhAHOiD6U=) и вытащить оттуда парочку request_id.

![Пример запроса](./img/grep-logs/2.jpg)
![Пример запроса](./img/grep-logs/10.jpg)

И уже потом подробнее изучить ситуацию в [Grafana](https://grafana.vertis.yandex-team.ru/s/t/kvMiG4Xs4NaJ2Y) или [YQL](https://yql.yandex-team.ru/Operations/YXLibdK3DJ9c1y1P8Hl3Cv4uXng4liUF541kOj54Ip0=), посмотрев логи по request_id.

![Пример запроса](./img/grep-logs/3.jpg)
![Пример запроса](./img/grep-logs/11.jpg)

В большинстве случаев это достаточно для того, чтобы понять, в чем проблема.

#### Пример 2

Тестировщики начали катить релиз тача, но графики стали показывать повышение ошибок и нужно разобраться.

Такой запрос в [Grafana](https://grafana.vertis.yandex-team.ru/s/t/zK_WvONp4NaMhg) или [YQL](https://yql.yandex-team.ru/Operations/YXLjggVK8IhSFvBW7GM60pBfKN8FrhO8eaRXJCV9GlY=) позволит посмотреть все ошибки определенной версии релиза и потом уже по request_id изучить причину подробнее, если это сразу не будет понятно.

![Пример запроса](./img/grep-logs/4.jpg)
![Пример запроса](./img/grep-logs/12.jpg)

#### Пример 3

В каком-то экспе что-то идет не так и нужно понять, что именно.

Вот [так](https://grafana.vertis.yandex-team.ru/s/t/2VMTXpim4Nabyr) в Grafana и [так](https://yql.yandex-team.ru/Operations/YXLkTpfFtxLpg73scBVP5wQeHCnIG0nVNI9oUWVB1BM=) в YQL мы можем посмотреть логи с определенным экспом.

![Пример запроса](./img/grep-logs/5.jpg)
![Пример запроса](./img/grep-logs/13.jpg)
