# Auto.ru CM.Expert auction bot
Эксперимент B2B аукциона на базе Авто.ру СМ.Эксперт

_Дисклеймер: все указанные параметры могут быть не точными на момент прочтения. См. конфиг за актуальными данными_

### Что это за бот?

Бот используется для проведения торгов по автомобилю.

Каждый будний день с 10:30 до 17:30 (см. конфиг) дилеры получают анонс о новом лоте в боте.
Через час (см. конфиг) стартуют торги. Пользователи видят кнопки в для быстрых ставок в лоте (+1000), а также могут
вводить свою абсолютную цену.

Торги длятся 40 минут (см. конфиг) и продлеваются на 5 минут, если менее чем за 5 минут до конца аукциона кто-то делает ставку.
Продление условно бесконечное (в конфиге 10 000 раз).

### Механика

- В http-ручку прилетает заявка. Создается новая Заявка в базе (application)
- Заявка попадает в Планировщика, который решает: нужно ли сейчас спланировать этот аукцион
  - Если есть активный аукцион (идет сейчас), то ничего не делает
  - Если нет -- планирует аукцион на следующих условиях: будний день с 10:30 до 17:30, иначе переносит на следующий подходящий день
- В начале дня (10:30) пользователи получают анонс аукциона (карточку лота), а непосредственно торги стартуют через 1 час после ознакомления
Верхняя граница дня (17:30) это время последнего анонса, т.е. непосредственно торги стартуют максимум в 18:30
- Во время аукциона пользователи (дилеры) делают ставки посредством кнопок в тг-боте
  - быстрые действия (+1000, +2000 и т.д.)
  - либо посредством ввода своей абсолютной цены
- Ставки выше 10000 руб. требуют дополнительного подтверждения через кнопку в пришедшем сообщении (меньшие ставки подтверждаются автоматически)
- После успешной ставки пользователь видит подтверждение этого
- Если ставку перебили (между моментом непосредственно ставки и моментом ее подтверждения кто-то успел сделать и подтвердить свою), то пользователь видит сообщение об этом. Его ставка при этом не засчитывается
- При каждой новой подтвержденной ставке все видят сообщение об этом:
  - Автор последней успешной ставки видит сообщение, что его перебили
  - Все остальные -- сообщение о новой ставке
- Если ставка делается менее чем за 5 минут до окончания аукциона, то он продлевается еще на 5 минут
- В момент окончания аукциона все получают карточку с итогом. Победитель видит соответствующее сообщение
- По окончанию аукциона:
  - Дергается ручка в сервиса лотов, которая переводит его статус
  - Создается тикет в Стартреке с исторей торгов (кто, сколько, подтвердил ли)

### Как работает

Всегда запускается один инстанс бота (поэтому следите за учениями) и поллится сервер ТГ (через прокси).
Один инстанс, потому что иначе два инстанса могут получить один и тот же набор команд и отреагировать X2/X3 раз.

Можно переделать на вебхуки, но пока не потребовалось.

### Деплой

[Сборка в Arcanum](https://a.yandex-team.ru/projects/autoru/ci/releases/timeline?dir=classifieds%2Fautoru-expert-auction-bot&id=autoru-app-ssr).
Настроен автозапуск на пуш в trunk.

Деплой происходит через шиву (shiva), название проекта: [autoru-expert-auction](https://admin.vertis.yandex-team.ru/services/autoru-expert-auction).

### История

Этот бот ранее изначально был написан для эксперимента Аукционов на базе Авто.ру.
Механика была следующая:
- составляется расписание торгов в csv-формате
- загружается в бота через телеграм
- происходит планирование лотов и запись времени в базу
- старт торгов

Затем стартовал проект Выкупа Авто.ру. Под капотом у продукта проходят торги между дилерами на базе платформы СМ.Эксперт.
В первой итерации торги решили проводить в боте, поэтому он был переписан под нужды нового продукта.
Новая механика:
- Заявки падают в бота через http-ручку и ставится в очередь
- Первый в очереди лот планирутся на аукцион
- По окончании аукциона берется следующий из очереди и также планируется для торгов

В момент миграции торгов из бота в СМ.Эксперта механика поменялась:
- Все пользователи получают карточку с анонсом и ссылкой на раздел Аукционов (лоты в подготовке) в СМ.Эксперте
- Через 1 час все получают сообщение о старте торгов и ссылку на раздел Аукционов в СМ.Эксперте (активные лоты)
- Непосредственно торги в лоте не проводятся и ставки больше не принимаются
- Лоты дублируются и в бота и в СМ.Эксперт
