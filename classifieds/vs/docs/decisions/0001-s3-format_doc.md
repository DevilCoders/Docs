# adr-0001: Формат хранения индексов на s3

Тикет: [VS-1362](https://st.yandex-team.ru/VS-1362)

## Контекст и постановка проблемы

Нужно зафиксировать формат хранения индексов на `s3`. Имеется ввиду то, как именно формируется полный путь до индекса. В
таком формате индексаторы будут писать обновления индексов, а сёрчеры (рантаймы) будут на них подписываться.

## Предпосылки к решению

* Как мапятся шарды `registry` на шарды `scandex` ?
* Как задать версию индекса ? определять явно / таймстемпом / офсетом ?
* Нужна ли нам эпоха для индексов ?
* Что происходит с индексом при компакшене ?
* Что делать если мы меняем формат хранения индексов ?

## Принятое решение

* Одному шарду БД может соответствовать один или несколько шардов `registry`.
* Индексы хранятся в виде бинарных файлов. Один файл на каждый логический шард БД.
* Версия индексом определяется теми офсетами `registry` из которых он построен, эти офсеты хранятся как метаданные в
  индексном файле.
* Индексные файлы лежат по таким путям:
  `{platform_name}/{format_version}/{domain}/{env}/{db_epoch}/{db_shard_id}/{file_name}`

Где:

* `platform_name` - бакет, в котором будут лежать все артефакты поисковой платформы: `vs-indices`
* `format_version` - версия формата хранения данных на `s3`
* `domain` - домен поиска, например `autoru` (возможно лучше `autoru_cars`) для автошных объявлений
* `env` - окружение (`test` | `prod`)
* `db_epoch` - версия БД целиком, на случай если мы захотим перелить все документы (для внештатных ситуаций) или
  перешардировать `scandex`
* `db_shard_id` - номер логического шарда БД. Не следует путать с шардами registry, но определяется он также на
  стороне `registry`
* `file_name` - имя файла логического шарда БД, (например `scandex.db`). Имя файла значащее, загружается лишь база из
  файла `latest.scandex`. Остальные версии сохраняются 14 дней (или иная указанная в конфигурации длительность) и служат
  для возможности ручного восстановления с них с помощью копирования файла в `latest.scandex`

## Разъяснения

#### О версионировании индексов

Файл содержит в метаданных офсеты всех шардов `registry` из которых он получен. В клиентах (в рантайме) при обновлении
индексов будем опираться на опцию `If-Modified-Since`.

Актуальная версия всегда лежит в файле `latest.scandex`. Кроме того, создаются копии этого файла с
именем `back-$millis.scandex`, где `milllis` - переменная, содержащая таймстемп версии. Время жизни этих файлов
определяется конфигурацией, по умолчанию - 14 дней.

#### Инициализация хранилища

Перед первым стартом для каждой комбинации `domain`/`env`, а так же при увеличении номера `db_epoch` нужно
[создать тикет в очереди VSSUPORT](https://st.yandex-team.ru/createTicket?queue=VSSUPPORT), в котором попросить
установить время жизни в 14 дней для файлов, попадающих под префикс
`/{parent_path}/{platform_name}/{format_version}/{domain}/{env}/{db_epoch}/{db_shard_id}/back-`

#### Почему не мапить шарды БД и шарды `registry` взаимнооднозначно ?

Мы можем хотеть иметь максимально компактные физические шарды `registry` чтобы размазать нагрузку по `ydb`, но для
реалтайма такие кусочки будут слишком маленькими - и тогда нам надо будет их объединять в меньшее число логических
шардов БД.

#### Какие права на S3?

У команды "Группа разработки поискового сервиса" есть права на чтение и запись в бакет `vs-indices` по accessKey и
accessSecret. Отдельные права на объекты не закреплены.

## На будущее

При компакшене меняются `doc_id` у всех документов, поэтому, при реализации компакшена, предлагается ввести т.н.
поколение шарда и добавить его в формат хранения индексов как ещё один префикс ( что-то вроде `/{shard_gen}/`).
