# vsSplice

Основная задача - выполнить несколько элементарных действий над базой данных и вернуть результат выполнения в рамках
сессии.

Ключевая сущность - **Interpreter** с заданным набором инструкций над ассоциированной БД (см. окружение в сигнатуре).

**Инструкции** - элементарные действия над БД, например, фильтрация и количество записей. Актуальный список инструкций
см. в [model.proto](./src/main/protobuf/vs/splice/model.proto)

Кроме самих инструкций для удобства можно использовать **переменные** - типизированные ячейки памяти **MemoryCell**.
Они могут поставляться сразу вместе с инструкциями в секции _predef_ - можно считать их константами, а могут быть
вычислены
в одной из инструкций, в то время как инструкция, в которой потребуется фактическое значение переменной, будет ожидать
завершения вычисления первой инструкции и означивания переменной.

#### Типы переменных:

* примитив - любой тип из strict: Int8, Utf8, ListValue,...
* DbResult - тип результатов операций над базой данных, содержит в себе типы колонок. Можно использовать для
  подзапросов. Например, результат фильтрации можно записать в переменную с типом DbResult, а затем выполнить над этим
  результатом инструкцию Count.

## FAQ

### Что такое сессия?

1. Снепшот базы, т.е. состояние базы (состав документов и их значения в индексах) на момент инициации конкретного
   запроса.
   Все операции(фильтрации, проекции, etc.) выполняются на этом снепшоте.
2. Переменные сессии

Сессия живет, пока есть запрос, привязанный к ней. По завершению освобождаются все занятые ею ресурсы, переменные
вычищаются.

Для получения снепшота служит **DatabaseService**  - он отдает актуальную на момент вызова версию базы данных в виде
ResultSet.
**ResultSet** - это не сырая база данных с индексами, а интерфейс с методами, сходными с инструкциями Interpreter.

_Мотивация_

В рамках одного запроса можно выполнить несколько инструкций, для поддержания консистентности ответа нужно зафиксировать
состояние БД.

### В чем отличия команд от инструкций?

**Инструкции** - элементарные действия над базой данных, например, фильтрация и количество записей.
**Команды** поступают извне в запросе к интерпретатору и служат для передачи

* множества инструкций
* ожидаемых (через await) значений
* отмены запроса




