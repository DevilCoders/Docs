# Формат декларации рекламного блока в бункере

## Общие сведения

* **РСЯ**, **РТБ**, **RTB** - Рекламная Сеть Яндекса.
* **s2s** - в общем виде это аббревиатура от `server-to-server`. Подразумевается, что мы делаем запрос рекламы с нашего сервера (nodejs) в бекенд рекламного источника.
  Рекламу не рисуем сами, а передаем полученный ответ в клиентский код РСЯ, который занимается отрисовкой.
  По сути мы делаем тот же самый запрос, что сделал бы рекламный код РСЯ из браузера, только на сервере.
  Это позволяет нам заранее знать будет баннер или нет и зарезервировать место (например, для top-баннеров).
  Подробнее про схему s2s-запросов можно почитать [тут](https://wiki.yandex-team.ru/users/larichevmn/s2s/) и [тут](https://wiki.yandex-team.ru/users/disaev/s2s-dlja-nativnyx-blokov/vidzhetov/).
* **клиентская реклама** - вид рекламы, который запрашивается и рисуется на клиенте (в браузере).
  Обычно подразумевает, что запросом и отрисовкой занимаемся не мы, а специальный код из источника рекламы.
  Но бывают исключения в виде специальных размещений adfox.


* **Рекламное место (place)** - декларация конкретного рекламного места на странице (например, top, r1, c1).
  Включает в себя массив источников рекламы и общие настройки места (например, стили или перерисовка по таймеру).
* **Рекламный источник (source)** - декларация кто и как будет непосредственно отрисовывать баннер.
  Включает такие параметры как тип (direct, rtb, adfox, awaps), параметры запроса и т.д.

Виды рекламных источников:
* **awaps** (*deprecated*) - никто не помнит что это и зачем, но оно есть и работает.
* **direct** - текстовая реклама.
  Работает по следующей схеме: мы на сервере делаем запрос в `yabs.yandex.ru/page/` со специально сформированными параметрами `text` и/или `grab`.
  Специальные react-компоненты в конечном проекте рисуют из ответа рекламный блок с требуемой логикой и дизайном.
  Компоненты обычно уникальные для проекта и для рекламного места, поэтому делать их общими не имеет смысла.
  Обычно основная задача такой рекламы - мимикрировать под дизайн проекта.
* **adfox** - бесконечно кастомизируемый (что и хорошо и плохо) рекламный источник.
  Бывает только клиентским (есть возможность сделать серверным, но у нас не реализована). Может быть отрисован как стандартными средствами adfox, так и вручную на основе ответа.
* **rtb** - наша обычная РСЯ.
  Может быть как клиентским, так и серверным.
  Бывает следующих подвидов:
  * **обычный RTB** - стандартный вариант. Обычно подразумевает, что сайт просто вставляет код к себе в нужное место, а дальше рекламный код все делает сам.
    В нашем случае надо просто указать ID блока. Наш общий код загрузит рекламный код и вызовет его.
  * **s2s** - тот же обычный RTB, но с серверным вызовом рекламы. Используется в редких случах.
    Например, для top-баннеров, где надо заранее знать есть баннер или нет и его высоту, чтобы страница не скакала.
  * **нативный RTB**/**нативная реклама** - вариант RTB с кастомной версткой, которая задается в настройках баннера на стороне RTB.
    Может быть как обычным, так и s2s.


## Структура папки

Живой пример можно посмотреть в проекте [auto.ru](https://bunker.yandex-team.ru/auto_ru/ad/)

```
bunker/node/with/project/ad
    _common // Опциональная специальная нода для общих деклараций рекламных мест
    _sources // Опциональная специальная нода для общих деклараций рекламных источников
    <page1>
    <page2>
    ...
    <pageN>
```

Все ноды `pageXXX` имеют одинаковую структуру и представляют из себя JSON-объект
```json
{
    "<place1>": "<Place1_Declaration>",
    "<place2>": "<Place2_Declaration>",
    "<placeN>": "<PlaceN_Declaration>"
}
```

Пример `_common`
```json5
{
  "reloadable": {
    "reload": 35,
  },
  "r1": {
    // можно ссылаться внутри на другие декларации
    "&": "reloadable",
    "resize": true,
    "reload": 40,
    "scrollReload": 2000,
  }
}
```

Пример `_sources`
```json5
{
  "adfox": {
    "type": "adfox",
    "placeId": "243420"
  },
  "rtb": {
    "type": "rtb",
    "extParams": {
      "awaps_section": "29337"
    },
    "allowRepeatAds": {
        "screen": -1,
    }
  },
  "direct": {
    "type": "direct",
    "sections": [
      "direct_premium",
      "premium",
      "direct"
    ]
  },
  "adfox-r0": {
    // можно ссылаться внутри на другие декларации
    "&": "adfox",
    "params": {
      "pp": "inf",
      "ps": "cefq",
      "p2": "fhwz"
    }
  }
}
```

Если есть ноды `_common` или `_sources`, то можно на них ссылаться с помощью символа `&`.
```json5
{
  "r0": [
    // На уровне "sources" настройки возьмутся из _sources
    "adfox-r0"
  ],
  "r1": {
    "reload": 50,
    "scrollReload": 2000,
    // На уровне "place" настройки возьмутся из _common
    "&": "r1",
    "sources": [
      "adfox-r1",
      {
        // На уровне "sources" настройки возьмутся из _sources
        "&": "rtb",
        "code": [
          "R-A-148440-3",
          "R-A-148440-7"
        ]
      }
    ]
  }
}
```

## Декларация рекламного места (place)

Представляет собой JSON-объект.
Обязательным является только поле `sources`, потому что без него блок не имеет смысла.

```json5
{
  // перезагрузка баннера по таймеру через указанное количество секунд
  "reload": 50,
  // перезагрузка баннера по скроллу через указанное количество пикселей
  "scrollReload": 1000,
  "sources": [
    "Source1",
    "Source2",
    "SourceN",
  ],
  // По умолчанию все баннеры рисуются скрытыми, открываются они после того как реклама отрисовалась.
  "initiallyHidden": false,
  // Надо ли баннера следить за изменение размера окна браузера
  // см. настройки rtb/adfox для широких/узких экранов
  // Сейчас используется такое определение: isWide = window.innerWidth >= 1280
  "resize": true,
  // кастомные стили для рекламнго блока
  "style": "margin: 0 auto !important;overflow:hidden;",

  // Полное переопределение настроек рекламного места в эксперименте
  "experiments": {
    "ключ_эксперимента1": {
      // ПОЛНЫЕ настройки рекламного места
      // Настройки никак не наследуются!
    },
    "ключ_эксперимента2": {
      // ПОЛНЫЕ настройки рекламного места
      // Настройки никак не наследуются!
    }
  }
}
```

Есть еще вариант краткий декларации со ссылками на ноды из `_sources`

```json5
[
  "Source1",
  "Source2",
  "SourceN",
]
```

## Декларация рекламного источника (source)

### direct

```json5
{
    // обязательное поле с типом
    "type": "direct",
    // порядок полей откуда пытаться брать рекламу из ответа Директа
    "sections": [
        "direct_premium",
        "premium",
        "direct"
    ],
    // Название метода, который сделает запрос.
    // Методы реализуются в серверной части рекламы
    "method": "getStaticSearchDirectJSON",
    // параметры запроса, pageId - обязательный
    "params": {
        "pageId": "699956"
    },

    // необязательные поля

    // ограничение на количество объявлений в ответе
    "count": 1,
    // Именование ответа, чтобы два разных рекламных места могли использовать один ответ
    "groupKey": "special"
}
```

Пример с groupKey.
В этом случае будет сделан один запрос в директ по правилам `direct-special`.
И два рекламных места будут использовать один ответ.
```json
{
    "top": [
        {
            "&": "direct-special",
            "groupKey": "top"
        }
    ],
    "c2": [
        {
            "&": "direct-special",
            "groupKey": "top"
        }
    ]
}
```

### adfox

```json5
{
    // обязательное поле с типом
    "type": "adfox",
    // ID баннера в adfox, берётся из админки adfox
    "placeId": "243420",
    // Параметры для запроса, берутся из админки adfox (не пытайся понять их смысл)
    "params": {
        "pp": "h",
        "ps": "cefr",
        "p2": "gstd"
    },
    // может быть массивом для узких/широких экранов
    "params": [
      {
        "pp": "g",
        "ps": "cefq",
        "p2": "fhwz"
      },
      {
        "pp": "iji",
        "ps": "cefq",
        "p2": "fhwz"
      }
    ]

    // необязательные поля

    // Тип вызова рекламного кода. Определяется исходя из конкретного баннера
    // По умолчанию, Ya.adfoxCode.create(...).
    // Если true, то Ya.adfoxCode.createScroll(...)
    "scroll": true,
    // Параметр adfox-вызова, определяется исходя из конкретного баннера
    "useProtectMode": true,
}
```

### Обычный RTB

```json5
{
  // обязательное поле с типом
  "type": "rtb",
  // ID баннера
  "code": "R-A-148422-2",
  // Массив ID, используется чтобы рисовать разные баннеры для широких/узких экранов
  // Первый баннер для узких экранов, второй для широких.
  "code": [
    "R-A-183282-5",
    "R-A-183282-2"
  ],
  // необязательные поля

  // Дополнительные параметры для запроса. Обычно тут awaps_section для статистики.
  // Не стоит пугаться слова awaps в настройках RTB-блока, это многовековое наслоение от покупки и слияния рекламных сетей в Яндексе.
  // Не надо думать про эти параметры как и про параметры в adfox :)
  "extParams": {
    "awaps_section": "29337"
  },

  // Скип-токен, служит для улучшения открутки прямых рекламных кампаний.
  // Если скип-токен выключен, баннеры могут дублироваться во всех блоках.
  "allowRepeatAds": {
    "screen": -1,
  }
}
```

### RTB + s2s

```json5
{
  "type": "rtb",
  "code": "R-A-148383-1",
  // Отличается только полем data, где описаные какие запросы надо сделать
  "data": {
    "meta": {
      // это постоянное поле
      "method": "getDirectS2S",
      // эти поля тоже постоянные, меняеются только ID
      "params": {
        "pageId": "148383",
        "imp-id": "1"
      }
    }
  }
}
```

### нативный RTB

```json5
{
  "type": "rtb",
  "code": "R-A-148383-1",
  // флаг, что это нативная реклама.
  // По нему меняется вызов с Ya.Context.AdvManager.render() на yaads.push()
  "native": true,
  // Отличается только полем data, где описаные какие запросы надо сделать
  "data": {
    "meta": {
      // это постоянное поле
      "method": "getDirectS2S",
      // эти поля тоже постоянные, меняеются только ID
      "params": {
        "pageId": "148383",
        "imp-id": "1"
      }
    }
  }
}
```

### Пример с несколькими источниками

Например, в рекламном месте рисуется RTB+adfox.
Через RTB получаем дорогие целевые баннеры, а если там баннеры закончились, то adfox для остаточного трафика.

```json
{
  "r1": {
    "reload": 50,
    "scrollReload": 1500,
    "resize": true,
    "sources": [
      {
        "type": "rtb",
        "extParams": {
          "awaps_section": "29337"
        },
        "code": [
          "R-A-148422-7",
          "R-A-148422-4"
        ]
      },
      {
        "type": "adfox",
        "placeId": "243420",
        "params": [
          {
            "pp": "g",
            "ps": "cefq",
            "p2": "fhwz"
          },
          {
            "pp": "iji",
            "ps": "cefq",
            "p2": "fhwz"
          }
        ]
      }
    ]
  }
}
```
