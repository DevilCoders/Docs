# Пинги по неактивности в ЧПО Аренды

Изначально делалось в REALTYBACK-7801 и подтикетах. Общая идея такая: если дать пользователю отвалиться от чата, то есть высокая вероятность, что он найдет квартиру где-то еще. Поэтому пингуем его, если в чате случается задержка.

## Если задерживается ответ менеджера {#idle-operator-pings}

Тикет на реализацию: REALTYBACK-8060.

**П**инги по неактивности **о**ператора (ПО) нужно бы описать подробнее.

## Если задерживается сам пользователь {#idle-user-pings}

Тикет на реализацию: REALTYBACK-8268.

В отличие от ПО, для **п**ингов по неактивности **п**ользователя (ПП) предполагается какая-то интерактивность, поэтому все сложнее.

Для ПП заводится два новых состояния бота: IDLE_USER_PING_1 и IDLE_USER_PING_2.

Помимо этого, в объекте сессии появляются следующие свободные поля:

- Флаг "не ожидаем ответ пользователя" появляется в DIRECT_PASS:
  - При переходе в DIRECT_PASS можно флаг выставить или оставить снятым (на момент написания не было случаев, когда нужно переходить в DP и снимать флаг).
  - Сообщения бота вообще не влияют на флаг, потому что мы выставляем его в нужное положение в момент отправки этих сообщений.
  - Любое сообщение менеджера снимает флаг.
  - Любое сообщение юзера взводит флаг.
- Время и ID неотвеченного сообщения:
  - Выставляются при получении сообщений от бота/менеджера.
  - Сбрасывается при получении сообщения от юзера.
- Информация для восстановления состояния бота при возврате из пинга:
  - Заполняется ботом при переключении состояния и при отправке сообщений. (Исключения: состояние бота не записывается при переходе в пинговые состояния; сообщения не (пере)записываются при отправке пингов и при переотправке (на выходе из пингового состояния).)
  - Также заполняется при получении сообщений от менеджера. (Мы бы и сообщения бота записывали при получении обратно из топика, но тогда потеряется информация о составных сообщениях.)

Далее определим пару дополнительных вычислимых условий.
- *Ожидаем ответ пользователя* = не выполняется ни одно из условий:
  - бот в состоянии FAILED_BYE;
  - бот в состоянии DIRECT_PASS *И* в нем включен флаг;
  - бот в состоянии IDLE_USER_PING_2. (По логике скрипта тут мы ответ все-таки ждем, но не настолько, чтобы слать пинги.)
- *Возможен пинг* = есть время/айди неотвеченного сообщения *И* *ожидаем ответ пользователя*.

Отправка пингов должна быть отложенным действием. Для этих целей делаем табличку с очередью комнат, которые периодически шедулер извлекает и отправляет в них ревизиты. Правила жизни этой очереди такие:
- После обработки ботом сообщения бота или менеджера, если *возможен пинг*, добавляем в очередь.
- После обработки сообщения юзера удаляем из очереди.

Логика бота для пинговых состояний:
- Сообщения бота игнорируются.
- Сообщения пользователя обрабатываются в соответствии с логикой пингов.
- Сообщения менеджеров (если это не команда) вызывают молчаливое переключение на DIRECT_PASS без переотправки сообщений. Информация для восстановления очищается.

Пинг отправляем в `processEnd`, по аналогии с ПО, соблюдая все условия по состоянию комнаты, времени, наличию необработанных сообщений.
