## Сожители

### Вводная

В аренде часто возникает ситуация, когда жилец хочет жить не один, а с кем-то. Раньше каждый из желающих совместно
снимать квартиру раздельно заполнял анкету и впоследствии они показывались собственнику раздельно и оформлялись как
отдельные жильцы с несвязанными между собой анкетами. Хотелось дать пользователям возможность отправлять заявки
группами, чтобы собственник мог просматривать их как группу кандидатов, потенциально живущих вместе, и чтобы
впоследствии они жили в квартире связанной группой. Отсюда появилась идея "сожителей".

Первоначальная схема бизнес-процесса:
![workflow](img/workflow.jpeg)

На текущий момент есть следующие отклонения от схемы:

При одобрении одной группы остальные отклоняются в том случае, если включен флаг `DeclineOtherGroupsAfterApproving`.
Сейчас он выключен.

### Терминология

**_Связи_** - связь пользователей между собой до подачи в квартиру. В связях нет главного. Связь не транзитивна, то есть
если связь образована между пользователями (А, В) и (A, C), то нет связи между пользователями (B, C). Связь также
позволяет видеть статус анкеты в некотором общем виде. Связи симметричны.

_**Группы**_ - группы пользователей, подающих заявку в квартиру. Тут уже есть главный и это тот кто создал заявку,
образовав группу. По дефолту для формирования группы отображаются пользователи, с которыми у текущего есть связь.
Главный пользователь может редактировать состав группы до и после отправки заявки.

### Связи

Связи образуется между пользователями посредством ссылок. Когда пользователь A хочет образовать связь с пользователями B
и C, он генерирует ссылку, которую потом отправляет пользователям В и С. После того как пользователи В и С переходят по
этим ссылкам, они образуют связи (A,C) и (A,B) и заполняют анкету. Ссылка общая для всех пользователей. Ссылка живет 30
дней и после протухает. После можно сгенерировать еще одну ссылку.

#### Связи в БД

![roommates](img/roommates.png)

1. Таблица user

- roommate_link_id - уникальное сгенерированное рандомное число для формирования ссылки
- roommate_link_expiration_time - дата протухания ссылки

2. Таблица roommate_candidate

- candidate_id - уникальный id связи
- user_id - id пользователя, с которым связываются (пользователь А в связи А-В)
- roommate_user_id - id пользователя, который прошел по ссылке (пользователь В в связи А-В) (опциональное поле)
- phone - телефон пользователя, которому отправляется смс с ссылкой (опциональное поле, так как пользователь мог зайти в
  систему и не указать свой телефон)

  Уникальны: candidate_id, (user_id, roommate_user_id)
  Когда пользователь добавляет сожителей в связи и высылает им ссылки, в таблице появляются записи с пустым
  roommate_user_id , но заполненным phone . Как только пользователь с таким телефоном переходит по присланной ссылке, в
  соответствующей записи в roommate_candidate проставляется его roommate_user_id

#### API связей

1. Генерация/получение ссылки `GET /rent/user/{user}/roommates/link-id`

   Когда пользователь генерирует ссылку, он при необходимости (если они пустые или протухли) обновляет поля
   `roommate_link_id` и `roommate_link_expiration_time` в таблице `user`. На основе этих полей генерируется ссылка,
   которая содержит в себе `roommate_link_id`. Перейдя по ссылке, пользователь должен иметь возможность вступить в связь
   с пользователем и зарегистрироваться/заполнить анкету. Формат ссылки:

- Прод: `https://arenda.realty.yandex.ru/lk/roommate-assign/{userId}/{roomateLink}`
- Тест: `https://arenda.test.vertis.yandex.ru/lk/roommate-assign/{userId}/{roomateLink}`

2. Создание связи `PUT /rent/user/{user}/roommates`

   Пользователь может создать связи между собой и пользователями, которым он высылает ссылки. Для этого он указывает
   номера телефонов этих пользователей. В таком случае в `roommate_candidate` создаются записи с указанными
   `user_id` и `phone`, но пустыми `roommate_user_id`. Всего связей может быть не больше 30.

3. Подтверждение связи `PUT /rent/user/{user}/roommates/{linkId}`

   После перехода по сгенерированный ссылке, пользователь идет в ручку создать связь с тем пользователем, кто отправил
   ссылку. Ручка не пересоздает уже существующую связь, даже симметричную. Если в бд уже существует связь для
   пользователя с таким номером телефона, то у нее заполнится `roommate_user_id` (даже если `roommate_user_id` было не
   пусто). Если связи с таким пользователем не создано, то сформируется новая запись с заполненными `user_id` (кто
   скинул ссылку), `roommate_user_id` (кто перешел по ссылке). Телефон в связи в таком случае заполнится телефоном
   пользователя.

4. Удаление связи `DELETE /rent/user/{user}/roommates/{candidate_id}`

   Ручка удаляет связи с `candidate_id`, где текущий пользователь либо `user_id`, либо `roommate_user_id` для
   пользователя, по которому отправляется запрос. Таким образом, связь можно удалить с любой стороны.

5. Получение связанных пользователей `GET /rent/user/{user}/roommates`

   Ручка возвращает списком всех пользователей, у которых есть связь с текущим пользователем.

### Группы

Группа пользователей и показ представлены одной сущностью `FlatShowing`. Показ становится группой пользователей после
отправления его на рассмотрение собственнику (переход `Created` -> `Consideration` на схеме). В группах есть главный
пользователь. До момента отправления группы на рассмотрение к показу может быть привязано множество главных
пользователей, а после отправления только один. Менять состав группы после отправления собственнику может только главный
пользователь. С ним подписывается договор. В дальнейшем под показом/группой будет пониматься объеденная
сущность `FlatShowing`.

Схема статусов в группе:

![roommates](img/group_workflow.png)

#### Связи в БД

![roommates](img/groups.png)

1. Таблица flat_showing

- showing_id - id показа/группы
- owner_request_id - id заявления собственника
- group_status - статус группы
- status - статус показа
- is_active - текущий показ/группа относятся к активному поиску квартиры? Да, если пользователь, создавший показ, еще не
  снял квартиру. Нет, если уже снял и поиск квартиры завершен.
- close_showing_cause - причина закрытия показа
- showing_type - тип показа

2. Таблица user_showing

- showing_id - id показа/группы
- user_id - id пользователя в группе
- is_main - является ли этот пользователь главным.

Группа образуется из множества `user_showing` и одним `flat_showing`. Показ формируется либо на стороне Амо, либо на
стороне Аренды. В момент создания показа к нему привязывается один пользователь, который по умолчанию считается главным.
Статус группы в этот момент - `Created`. Сразу после создания через Амо к показу можно привязать дополнительных
пользователей и в таком случае в группе/показе будет сразу несколько главных пользователей. Если показ закрывается, то
группа автоматически переходит в состояние отклоненной (`Declined`). В группе может быть разное количество главных
пользователей в зависимости от статуса группы:

- Статус группы = `Created` или = `Declined`. Возможно несколько главных пользователей.
- Статус группы = `Consideration` или = `Approved`. Возможен только один главный пользователь.

Между статусом показа и статусом группы есть соответствие: при изменении статуса показа статус группы может также
измениться. Логику того процесса можно посмотреть
тут: `ru.yandex.realty.rent.service.impl.amohub.ShowingsLeadProcessor.chooseGroupStatus`

Именно из-за такого изменения статуса через Амо показ может закрыться, не став группой (переход `Created -> Decline`).

#### API групп

1. Отправление группы/анкеты на рассмотрение собственнику `PUT /rent/user/{user}/flats/{flatId}/roommates`

   Соответствует переходам статуса группы `Created -> Consideration`, `Approved -> Consideration`.

   Эта ручка меняет состав группы и отправляет собственнику на рассмотрение. Через ручку можно поменять состав группы,
   отправив запрос с коллекцией `user_id` (обычные пользователи) и с единственным `main_user_id` (главный пользователь).
   Таким образом при отправлении группы на рассмотрение в ней останется только один главный пользователь. Только главный
   пользователь может менять состав группы, в том числе назначая другого главного пользователя. Так как пользователь
   записывается на показ (добавляется в группу в статусе `Created`) до отправления группы на рассмотрение, то на момент
   отправления группы на рассмотрение в бд уже будет создана группа/показ, где пользователь будет главным. Присутствует
   валидация: нельзя добавить пользователя из другой группы, привязанной к текущей квартире, пользователя без анкеты, а
   также пользователя, не связанного с текущим. Если группа была в статусе `Approved`, то меняя группу, мы меняем статус
   группы на `Consideration`. После провязки пользователей в группу все они привязываются к квартире как кандидаты в
   жильцы (
   появляется запись в UserFlat).
4. Отображение групп `GET /rent/user/{user}/flats/{flatId}/roommates`

   Для пользователя она выводит последнюю активную группу, которую он отправил на рассмотрение собственнику.
   Гипотетически возможно ситуация, когда групп/показов может быть подано несколько, но работаем всегда с последней.
   После завершения поиска квартиры и заселения все группы/показы пользователя деактивируются (поле `isActive = false`)

### Рассмотрение собственником заявки

Соответствует переходам статуса группы `Consideration -> Approved`.

Собственник может рассматривать отправленные анкеты и группы. Он может отклонять и подтверждать любые группы. Если
человек подается в квартиру один, то он проходит тот же процесс, но в его группе он единственный главный пользователь.

Одобрение/отклонение анкеты или группы происходит через
ручку `PUT /rent/user/{user}/flats/{flatId}/roommates/{showingId}/update-status` В нее передается состав группы, который
видит собственник (из ручки квартиры). При изменении статуса если переданный состав группы отличается от того, который
есть в бд, то будет брошена ошибка. Сделано это для того, чтобы в случае параллельного изменения группы жильцами
собственник случайно не одобрил/отклонил группу, состав которой он еще не видел. Если собственник одобряет одну группу,
то он автоматически отклоняет все остальные.

### Админские ручки управления группой

Иногда возникает ситуация, когда пользователь забывает добавить сожителя в группу и просит сделать это поддержку. Для
этого менеджерам дана возможность менять состав группы посредством следующих ручек:

1. Добавление пользователя в группу `POST /rent/moderation/showings/{showingId}/roommates`

   Добавлять можно пользователя с пройденными проверками и заапрувленной анкетой в не отклонённую активную группу. При
   добавлении формируется связь между добавляемым пользователем и главным в группе, если ее еще нет. Нельзя добавлять в
   группу пользователей, которые уже привязаны к показам в ту же квартиру.

2. Удаление пользователя из группы `DELETE /rent/moderation/showings/{showingId}/roommates/{userId}`

   Удалять можно пользователя, не являющегося последним, из не отклонённой активной группы. При удалении связь между
   пользователями тоже удаляется. Если был удалён главный пользователь, то в группе выбирается новый главный
   пользователь.

3. Изменение статуса группы `POST /rent/moderation/showings/{showingId}/roommates/status`

   Позволяется изменять статус группы в один из: consideration, approved, created, declined.
   Информация об изменении статуса записывается в status audit log.
