## База данных realty-rent

Координаты базы данных Аренды в тестинге следующие:
- хост - `c-mdbktnnpuedsnkcjpdmf.rw.db.yandex.net:3306`;
- имя базы - `realty_rent`;
- юзер - `realty_rent`;
- пароль лежит в секретнице [здесь](https://yav.yandex-team.ru/secret/sec-01epp5zms84ch1rdj46acs45bx/explore/versions).

Данные из этой базы экспортируются в Yt - подробнее об этом [здесь](https://wiki.yandex-team.ru/realty/backend/yt-exports/#arenda).

Чтобы не запутаться во всём многообразии табличек, ниже приводится общая схема и краткое описание каждой таблички. Синим цветом здесь подсвечены таблички, на которых есть Watcher'ы.

![realty-rent db schema](img/realty-rent-db.png)

### Core
- **User** (UserWatcher) - Юзер Аренды. Создаётся при первом логине юзера в ЛК. Имеет помимо яндексового uid'а ещё свой арендный userId.
- **Flat** (FlatWatcher) - Квартира. Создаётся собственником из его ЛК.
- **UserFlat** - Связь "многие ко многим" между юзерами и квартирами.
- **OwnerRequest** - Заявление собственника о том, что он хочет работать с нами. Содержит ещё настройки ЖКХ - их собственник заполняет до того, как мы найдём жильца.
- **RentContract** (RentContractWatcher) - Договор Аренды. Создаётся из админки ВМ'ом, когда жилец готов заселяться в квартиру.

### Платежи
- **Payment** - Платёж по договору Аренды. Может быть одного из двух типов - за аренду квартиры и за ЖКХ.
- **PayoutTransaction** - Транзакция выплаты. Используется для дедубликации выплат.
- **InvalidPaymentTransaction** - Невалидные транзакции из Тинькофф. В норме - совсем пустая. Нужна для мониторинга странных транзакций в продакшене - если появится хотя бы одна строка, загорится алерт.

### ЖКХ
- **HouseService** - Счётчик в квартире. Связан с OwnerRequest'ом, создаётся собственников при заполнении настроек ЖКХ.
- **Period** - Период оплаты ЖКХ (некоторый месяц в году).
- **MeterReadings** (MeterReadingsWatcher) - Показания по счётчику за некоторый период.

### Показы
- **FlatShowing** - Показ в некоторой квартире. Связан с OwnerRequest'ом. Кроме того, представляет собой группу юзеров, которые собираются заселяться сожителями.
- **UserShowing** - Связь "многие ко многим" между показами и юзерами.

### Другое
- **FlatQuestionnaire** - Анкета по квартире. Создаётся и заполняется ВМ'ом из админки.
- **FlatCode** - Уникальный код квартиры. В этой табличке лежит много заранее сгенерированных кодов, для каждой квартиры случайным образом выбирается один из них.
- **KeysHandover** - Передача ключей - от собственника или жильца менеджеру, или от менеджера жильцу или собственнику. Создаётся и подтверждается из админки. Связана либо с квартирой, либо с договором.
- **UserCardBinds** (UserCardBindsWatcher) - Привязка карт собственника. Поллинг статуса привязки карт вынесен в отдельный вотчер, чтобы не делать слишком частые запросы в Тинькофф из UserWatcher'a.
- **RoommateCandidate** - Кандидат в сожители. По сути, это связь "многие ко многим" между юзерами и юзерами.
- **StatusAuditLog** - Аудитная табличка с действиями, совершаемыми из админки. Здесь сохраняются изменения статуса квартиры, договора и показа вместе с ответственным ВМ'ом.
- **Offer** - Оффер Недвижимости, Авито или Циана. Содержит дату, когда последний раз обработали этот оффер, т. е. создали для него сделку в Амо.
- **FlatKeyCode** - Сгенерированный код для маркировки ключей от квартиры. Используется для распечатки в виде qr-кодов и наклейке на связку ключей, потом по этому коду можно сдавать и принимать ключи из складов Лавки. Коды генерится и распечатываются заранее, а не в момент привязки к квартире, чтобы менеджеру не ходить с принтером подмышкой.
- **Inventory** - Опись по договору аренды. Создаётся и заполняется при заселении жильца в квартиру.
