## Генератор платежей по аренде

Класс `RentPaymentsGenerator` - интерфейс создающий шаблоны платеже по арендной плате.
Его реализация содержит всю логику по генерации новых платежей.

На вход интерфейс принимает _договор аренды_(`RentContract`, ДА) с уже существующими платежами,
на выходе отдает шаблоны платежей(`RentPaymentTemplate`) по которым уже и создаются новые платежи.

Стандартная реализация этого интерфейса(`DefaultRentPaymentsGenerator`) включает в себя три генератора,
которые последовательно вызываются друг за другом:

 - Генератор периодов условий(`ConditionPeriodsGenerator`) –
   собирает из контракта цепочку периодов условий(`ConditionPeriod`),
 - Генератор периодов платежей(`RentPaymentPeriodGenerator`) –
   нарезает весь период аренды на периоды по которым будет происходить оплата
 - Генератор арендной платы(`PaymentAmountsBuilder`) -
   для каждого периода оплаты вычисляет сумму арендной платы

### Генератор периодов платежей(`RentPaymentPeriodGenerator`) {#rent-payment-period-generator}

Правила генерации изложены [тут](rules-for-payment-generation.md#payment-period-generation-rules)

В процессе работы генератора он наращивает стек платежей:
список платежей где на верхушке находятся самые поздние платежи.
Получить актуальный стек платежей для конкретного состояния можно методом `payments`
(поскольку стек иммутабельный, то каждое состояние хранит свой экземпляр стека)

Генерация периодов основана на иммутабельном конечном автомате.
Текущее состояние при вызове метода `nextState` создает новое состояние,
параллельно добавляя новые платежи в стек платежей.

Идея состоит в том, чтобы строить следующий платеж на основе текущего,
а не пытаться построить все периоды сразу.
Грубо обобщая, можно сказать, что каждое состояние представляет собой свитч,
выбирающий следующий платеж на основе текущего.

Генерация необязательно идет до конца, ее ограничивает текущая дата переданная в генератор.

Состояния, в текущей реализации, могут добавлять один или ноль платежей в стек за состояние.
Потенциально можно добавлять больше одного платежа или перезаписывать предыдущие.

{% note warning %}

Важно понимать, что хоть часть состояний однозначно совпадает с создаваемыми платежами,
в общем случае это не так.

{% endnote %}

В генераторе используется термин _Выровненный_(_Aligned_).
Он применяется к различным периодам и означает, что дата начала или конца
(в зависимости от контекста) периода совпадает с
[_днем оплаты аренды_(`payment_day_of_month`)](./terminology.md#rent-contract-main-attributes)

Структура классов:

![](img/period-generator-uml.drawio.png)

При описании сущностей будет использован термин _указывает_/_соответствует_ – в отношении платежей это означает, что
верхний платеж стека платежей в этом состоянии будет именно таким,
в отношении границ(дат) – то, что дата конца последнего платежа в стеке платежей находится на этой границе(дате)

Описание сущностей:

- `FSMGenerator` – интерфейс, для того чтобы реализовать декораторы `WithTracing` и `WithLogging`
- `WithTracing` и `WithLogging` - декораторы, которые можно, подмешать в `SimpleFSMGenerator` и `IncrementalFSMGenerator`
   для того что бы добавить трейсы и логирование соответственно
- `SimpleFSMGenerator` - класс, содержащий всю логику конечного автомата и основные правила генерации платежей
- `IncrementalFSMGenerator` - класс, расширяющий SimpleFSMGenerator,
   позволяет передавать в генератор уже существующие платежи и достраивать новые после них.
   Такое разделение появилось исключительно из-за попытки упростить написание генератора.
- `State` - интерфейс состояния для конечного автомата
- `BeginState` - самое первое состояние в случае если не существует оплаченных платежей,
   имеет пустой стек платежей и указывает на самое начало аренды
- `FirstPeriodState` - состояние соответствующее самому первому платежу
- `BeginConditionPeriodState` - состояние соответствует границе между _периодами условий_
- `ShortAlignedPeriodState` - состояние соответствует платежу-сдвигу для выравнивания по _дню оплаты аренды_
- `FullAlignedPeriodState` - состояние соответствует обычному месячному платежу с датой начала равной _дню оплаты аренды_
- `EndConditionPeriodState` - состояние соответствует последнему платежу в _периоде условий_
- `TailAfterEndState` - специальное состояние для генерации хвостиков в случае когда жилец не согласился оплатить 30 дней,
  единственное состояние которое генерирует платежи за границей последнего периода условий.
- `EndState` - состояние-терминатор, означает что все платежи были сгенерированы.
- `ErrorState` - состояние-терминатор, означает что в процессе генерации произошла ошибка.
- `ExistingPeriodState` - c этого состояния начинается генерация в IncrementalFSMGenerator,
  если были передано больше одного существующего платежа, поддерживает логику по продолжению
  и восстановлению генерации после существующих платежей

#### Диаграмма **основных** переходов состояний {#graph-of-state-transitions}

Легенда:
 - Оранжевые стрелки – начало нового платежа будет совпадать с днем оплаты аренды
 - Зеленые стрелки – начало нового платежа не будет совпадать с днем оплаты аренды
 - Синие стрелки – переходы в случаях, когда до конца периода условий не помещается нужный платеж
 - Черные стрелки – прочие переходы
 - Синяя обводка – это состояние может быть начальным состоянием для генерации
 - Красная обводка – терминальное состояние
 - Зеленая заливка – в состоянии добавляется один платеж
 - Голубая заливка – в состоянии добавляется один или ноль платежей
 - Без заливки – в состоянии не добавляются платежи


![граф переходов](img/diagram-of-state-transitions.drawio.png)



