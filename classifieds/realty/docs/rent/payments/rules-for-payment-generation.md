# Правила генерации Платежей

## Периоды условий {#condition_periods}

![conditions_period](img/condition_periods_example.png)

Дата начала аренды и даты начала действия ДС разделяют весь период аренды на _периоды условий_.
В рамках одного _периода условий_ условия аренды не меняются.

В генераторе платежей им соответствует класс `ConditionPeriod`.

Между _периодами условий_ нет разрывов, начало для одного является концом другого.
Все периоды, кроме последнего, имеют даты начала и конца.
Последний период не имеет даты окончания в случае, если не задана дата окончания аренды.
Для последнего периода дата конца рассчитывается специальным образом
(подробное обьяснение найдется в правилах построения платежей):

- Если `termination_date` > `notification_date` + 30 дней (нормальный съезд), \
  то `endDate` = `termination_date` + 1
- Если `termination_date` <= `notification_date` + 30 дней, \
  то `endDate` = `notification_date` + 31
- Если `termination_date` <= `notification_date` + 30 дней, но `check_out_without_additional_payments` = true, \
  то `endDate` = `termination_date` + 1

В случае, если задана _временная арендная плата_ для периода условий,
добавляется дополнительный(_виртуальный_) период условий,
замещающий часть основного периода условий, с арендной платой в размере временной АП
и длиной в указанное количество месяцев.
_День оплаты аренды_ для такого периода должен совпадать с датой начала периода,
которая в свою очередь совпадает с датой начала аренды.

На одну дату может приходиться несколько ДС, тогда появляются _периоды условий_ нулевой длины.
Такие _периоды условий_ не участвуют в генерации платежей
и не будут создаваться генератором периодов условий.

## Правила построения периодов платежей {#payment-period-generation-rules}

#### Начало самого первого периода условий {#first-condition-period-beginning}

Самый первый платеж должен быть длиной в месяц,
даже если дата платежа не совпадает с _днем оплаты аренды_.
Это обусловлено юридическими причинами.

Последующий платеж зависит от того, совпадает ли дата первого платежа
с _днем оплаты аренды_(`payment_day_of_month`)

1. если да, то генерируется нормальный платеж на месяц
2. если нет, то генерируется короткий платеж(хвостик)
  от даты конца первого платежа до ближайшего _дня оплаты аренды_

Пример первого случая:

![](img/payments/payment-first.png)

Пример второго случая:

![](img/payments/payment-first-pdm.drawio.png)

Дальнейшие платежи до конца _периода условий_ создаются длиной в месяц.

#### Завершение периода условий {#condition-period-end}

Окончание всех периодов условий, кроме последнего, подчиняется следующим правилам:

1. если до конца периода помещается целое количество месячных платежей
  (это соответствует случаю когда _день оплаты аренды_ совпадает с днем окончания периода условий),
  то просто создаются месячные платежи до самого конца периода условий
2. если до конца периода не помещается целое количество месячных платежей
  (это соответствует случаю когда _день оплаты аренды_ не совпадает с днем окончания периода условий),
  то генерируется максимальное количество месячных платежей до даты конца периода
  и потом создается короткий платеж-хвостик от даты конца последнего платежа
  до даты окончания _периода условий_

{% note warning %}

Второй случай не должен использоваться при нормальном создании ДС
и в целом бизнесовая логика такого не предусматривает, но поскольку генератор
поддерживает этот кейс, то считаю, что его тоже стоит тут описать.

{% endnote %}

Пример второго случая:

![](img/payments/payment-tail.drawio.png)

#### Начало периода условий {#condition-period-beginning}

Начало всех периодов условий, кроме первого, подчиняется следующим правилам:

1. если дата начала _периода условий_ совпадает с _днем оплаты аренды_,
  то генерация сразу начинается с месячного платежа, и дальше так же генерируются месячные платежи.
2. если дата начала _периода условий_ не совпадает с _днем оплаты аренды_,
  то сначала генерируется короткий платеж для сдвига даты платежа к _дню оплаты аренды_,
  и только после этого начинают создаваться нормальные месячные платежи.

Пример второго случая:

![](img/payments/payment-shift-pdm.drawio.png)

#### Завершение последнего периода {#last-condition-period-end}

Окончание последнего периода имеет особую специфику – оно может быть как нормальным
(жилец оповестил о съезде за 30 дней как это требуется контрактом)
так и коротким(в случае если не было оповещения за 30 дней).

В случае нормального съезда конец периода генерируется таким же образом как и у обычных периодов
(смотри выше)

В случае короткого съезда по контракту жилец обязан оплатить 30 дней после даты оповещения.
Однако не все соглашаются на это, поэтому предусмотренны несколько вариантов завершения:

1. обычный вариант, когда жильцу выставляются платежи до даты оповещения + 30 дней
2. собственник согласовал съезд без доплат, тогда мы прощаем жильцу 30 дней
   и выставляем платежи до _даты фактического съезда_
3. Жилец отказался выплачивать 30 дней и тогда платежи ему выставляются как в первом варианте,
   однако платеж на который выпадает _дата фактического съезда_ разрезается на 2 платежа:
   первый от начала платежа до _даты фактического съезда_ и второй от _даты фактического съезда_
   до даты конца платежа. Сделано это с целью получить от жильца платежи хотя бы до даты фактического съезда.

Выбор между вариантами делается комбинацией флагов
[`check_out_without_additional_payments`](./terminology.md#rent-contract-termination-attributes) и
[`tenant_refused_pay_for_30_days`](./terminology.md#rent-contract-termination-attributes)

Пример первого варианта:

![](img/payments/payment-end.drawio.png)

Пример третьего варианта(когда собственник съехал раньше, чем сообщил нам об этом):

![](img/payments/payment-end-2.drawio.png)

Первый и второй варианты поддерживаются на уровне [генерации периодов условий](#condition_periods)

#### Прочие правила {#other-generation-rules}

Помимо общих правил генерации, есть условие, что **оплаченные платежи не могут быть изменены**
Это накладывает свои особенности на генерацию платежей при съезде.
Жилец может оплатить часть платежей хвостиков из третьего варианта, а потом отменить расторжение.
Тогда с точки зрения вышеописанный схемы платежи будут неправильными, но двигать мы их не можем.
Поэтому в этом случае и в других подобных случаях, когда генерация нарушена,
генератор должен восстанавливать нормальную генерацию платежей,
генерируя хвостик для выравнивания по дню оплаты аренды, если он нужен,
а после продолжать нормальную генерацию.

Генерация _периодов платежей_ должна учитывать смещение последнего дня месяца:
например, если день оплаты аренды 31 число, то для месяцев, где нет 31 числа(февраль, апрель, и тд),
выбирается последний день месяца.

Пример:

![](img/payments/payment-31.drawio.png)

Больше примеров в тестах: `ru.yandex.realty.rent.backend.payment.periods.RentPaymentPeriodGeneratorSpec`

## Вычисление арендной платы {#rent-amount-calculation}

При вычислении суммы арендной платы для платежа могут возникнуть несколько вариантов:

1. Длина платежа равна месяцу
2. Длина платежа меньше месяца
3. Длина платежа больше месяца(не поддерживается, таких случаев надо избегать)

В первом случае сумма платежа просто равна арендной плате указанной в контракте.

Во втором случае используются следующие формулы:
1. если платеж находится в рамках одного месяца, то используется следующая формула: \
   rent_amount * \[количество дней в платеже\] / \[количество дней в месяце\]
2. если платеж попадает на 2 месяца, то используется следующая формула: \
   rent_amount * \[количество дней платежа в месяце 1\] / \[количество дней в месяце 1\] + \
   rent_amount * \[количество дней платежа в месяце 2\] / \[количество дней в месяце 2\]


{% note alert "TODO" %}

Необходимо написать про страховку

{% endnote %}
