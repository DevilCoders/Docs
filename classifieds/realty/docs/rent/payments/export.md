## Аналитические выгрузки

Про платежи Аренды отправляется несколько событий через брокер в Yt для аналитических целей.
- Это делается в стейдже `RentContractWatcher`'a - `PaymentEventStage`.
- Аналитические таблички с этими эвентами в Yt'е можно найти [здесь](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/prod/warehouse/realty/rent/payment_v3).
- Модель `PaymentEvent` этих эвентов можно найти [здесь](https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/realty/rent/event/payment.proto).

### Виды событий

- `PAYING_BY_TENANT` и `PAYING_HOUSING_AND_COMMUNAL_SERVICES_BY_TENANT` - отправляются для платежей,
успешно оплаченных жильцом, после оплаты, но не раньше `paymentDate` данного платежа.
- `PAYOUT_TO_OWNER` и `PAYOUT_HOUSING_AND_COMMUNAL_SERVICES_TO_OWNER` - отправляется для платежей,
успешно выплаченных собственнику до 18:00 в `paymentDate`, т. е. НЕ по поручительству.
- `PAYOUT_UNDER_GUARANTEE` - отправляется для платежей, выплаченных собственнику
по поручительству в 18:00 в `paymentDate`.
- `PENALTY_INCREASED` - отправляется раз в сутки для платежей, не оплаченных вовремя,
т. е. при каждом увеличении суммы штрафа.
- `PAYMENT_DATE_HAS_COME` - отправляется для платежей, НЕ оплаченных заранее до `paymentDate`,
при наступлении этой даты.

### Добавление новых полей в выгрузку

В модель `PaymentEvent` можно добавлять новые поля, но нужно понимать, что после добавления для старых платежей
эти поля в Yt уже не прорастут, вместо значений в старых строках будет `null`.

Если есть необходимость перевыгрузить старые платежи с заполнением новых полей, можно сделать следующее:
- завести копию модели `PaymentEvent`, привязав её к новой табличке в Yt (например, `payment_v4` вместо `payment_v3`);
- добавить логику выгрузки для новой версии в `PaymentEventStage` (для каждого вида события придётся завести
новые булевые флаги);
- порескедулить в проде все договора;
- дождаться, когда аналитики перейдут на использование новой таблички вместо старой;
- выпилить логику старой выгрузки из `PaymentEventStage`.

Но важно понимать, что при текущей реализации для эвентов `PAYOUT_UNDER_GUARANTEE`, `PENALTY_INCREASED` и
`PAYMENT_DATE_HAS_COME` **это не сработает**! Если это потребуется, то в `PaymentEventStage` нужны будут доработки.
