## Терминология

**Ордер** (`Order`) представляет собой некоторую сущность, которая включает в себя совокупность услуг, платежи по этим
услугам и чеки по платежам.

**Услуга** (`OrderItem`) представляет собой пункт ордера, по которому требуется совершить платёж. Услуга может как
оплачиваться только со стороны пользователя (например, комиссия, страховка, штрафы и т.п.), так и быть переводом другому
пользователю (например, арендная плата, услуги ЖКХ). В одном ордере могут быть как разные услуги. Услуга может быть
привязана к периоду.

**Транзакция** (`Transaction`) содержит в себе информацию о произведенном платеже. Транзакция может частично или
полностью покрывать все услуги. Транзакции могут являться **оплатой**, если платеж проходил со стороны клиента и деньги
поступили нам, или **выплатой**, если платеж совершили мы и отправили деньги клиенту.

**Чеки** (`Receipt`) содержат в себе информацию по совершённым платежам, которая отправляется пользователю.

Ордер является **коротким**, если содержит в себе услуги с периодом, не покрывающим полный песяц

Ордер может быть **отклонённым**. Такие ордера нельзя менять и их можно понимать как мягко удалённые. Их также можно
восстановить.

Ордер является **закрытым**, если выполняются 2 условия:

- Сумма всех успешно проведённых оплат покрывает услуги, по которым требовалась оплата
- Сумма всех успешно проведенных выплат покрывает все услуги, по которым требовалась выплата

Закрытый ордер нельзя отклонить, а отклонённый нельзя закрыть. Общее представление ордера `Order`
= [{`OrderItem`}, {`Transaction`}, {`Receipt`}]

## Сущности

`Event` - _неизменяемое_ событие, связанное с ордером.

* `order_id` - id ордера, по которому происходит событие.
* `entity_id` - id сущности, связанной с ордером. Например, договор Аренды
* `idempotency_key` - ключ идемпотентности события
* `data` - протобаф с необходимой информацией о событии. Содержит в себе тип события
* `create_time` - время возникновения события

Все события реализуют поток: Формирование ордера => Платежи по ордеру => Отправка чеков по платежам

Для построения ордера события формируют цепь в виде связанного списка, на основе которого формируется ордер. Связный
список не содержит циклов.

Ключ идемпотентности события должен уникальным образом определяться событием, которое мы пытаемся добавить в бд.
Пара (`order_id`, `idempotency_key`) образуют primary key события. Таким образом, этот ключ предотвращает добавление
одинаковых событий для одного ордера. То есть если `idempotency_key_1 == idempotency_key_2` и `order_id_1 == order_id_2`
, то мы считаем, что соответствующие события 1 и 2 совпадают и сохранять необходимо только одно из них. Естественно,
некоторая составляющая id будет определяться типом события, разделяя таким образом пространство id на id для
соответствующих типов. Механика формирования такого ключа будет зависеть от конкретного типа события.

Например, у нас есть события создания услуги и последующей её отмены. В таком случае, мы не можем отменить услугу дважды
и не можем добавить событие отмены второй раз. Попытка добавить событие отмены во второй раз должна сгенерировать
событие отмены с тем же id, что и событие отмены, которое уже сохранено в бд. Поскольку id является PK, то добавить
событие 2ы мы не сможем.

Использование `entity_id` необходимо для привязки ордера к сущности (например, к договору Аренды).

Использование `order_id` необходимо для образования ордера.

Для определённых типов событий внутри data также будут сохраняться дополнительные id:

- `order_item_id` необходим для возможности отменить услугу/совершить по ней платёж. В качестве альтернативы можно
  рассмотреть возможность привязки этих событий не к id, а к типу пункта, но такое решение кажется менее гибким.

- `transaction_id` необходим для обработки платёжных событий в ордере. Например, если мы захотим указать, что некая
  транзакция упала с ошибкой, а другая транзакция в том же ордере прошла успешно.

Также для услуг в ордере могут использоваться периоды:

- `period_start_date` - начало действия периода, к которому привязана услуга (включительно)

- `period_end_date` - конец действия периода, к которому привязана услуга (исключительно)
