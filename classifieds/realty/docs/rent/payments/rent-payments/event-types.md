## Типы событий

Основная парадигма в делении событий на 4 класса: формирующие ордер, формирующие услуги в ордере, совершающие платёж по
ордеру и завершающие платёж (чеки). Каждый класс может обладать некоторым набором событий. Эти 4 класса представлены в
виде следующих событий:

### События ордера

**Создание ордера.** Событие `CreateOrderEvent`

Ордер может быть 2х типов:

- На услуги аренды
- На коммунальные услуги

Мы можем одновременно создать столько ордеров, сколько требуется. Однако, после создания и до отклонения создать ордер
вновь нельзя (новые события создания создаваться не будут). После отклонения ордера его можно восстановить. Нельзя
восстановить ордер под другим типом. Например, если ордер был создан на услуги аренды, то отклонить и восстановить его
как ордер на коммунальные услуги уже нельзя.

Ключ идемпотентности для такого события представляется в виде `create_${declineEventCount}`, где `declineEventCount` -
это количество событий `DeclineOrderEvent` в ордере.

**Обновление ордера.** Событие `UpdateOrderEvent`

Позволяет указать дополнительную информацию об ордере, не связанную напрямую с услугами. Например, можно указать, что
ордер является коротким. Также через это событие мы определяем формат оплаты платежа (см. ниже).

Ключ идемпотентности для такого события представляется в виде `update_${updateEventCount}`, где `updateEventCount` - это
количество событий `UpdateOrderEvent` в ордере.

**Отклонение ордера.** Событие `DeclineOrderEvent`

Отклонить можно только созданный ордер. Отклоненный ордер нельзя отклонить снова (новые события отклонения создаваться
не будут). После отклонения ордер можно восстановит, а после отклонить вновь. Повторять эту процедуру можно любое
количество раз

Ключ идемпотентности для такого события представляется в виде `decline_${createEventCount}`, где `createEventCount` -
это количество событий `CreateOrderEvent` в ордере, необходимо `createEventCount > 0`.

### События услуг в ордере

**Создание услуги в ордере.** Событие `CreateOrderItemEvent`

Услуги в ордере бывают следующих типов:

- Перевод денег. Отражает услугу, по которой мы должны получить деньги от пользователя, а после произвести по ней
  выплату другому пользователю.
- Комиссия. Оплачиваемая пользователем услуга.
- Страховка. Оплачиваемая пользователем услуга.
- Штраф. Оплачиваемая пользователем услуга.

Количество различных услуг в ордере не ограничено. Следовательно, ключ идемпотентности будет полностью
определяться `order_item_id`. Добавить услугу можно только в открытый ордер.

**Отклонение услуги в ордере.** Событие `DeclineOrderItemEvent`

Событие отклонения услуги удаляет услугу из ордера. Восстановить услугу с тем же `order_item_id` нельзя, но можно
создать идентичную услугу с новым `order_item_id`.

### События платежей

**Инициализация транзакции.** События `InitPaymentEvent` и `InitPayoutEvent`

Каждая транзакция представляет собой либо оплату (если деньги за услуги поступают нам, `InitPaymentEvent`), либо
выплату (если деньги за услуги отправляем мы, `InitPayoutEvent`). Используется 2 разных события, поскольку у них разный
набор полей. Событие `InitPaymentEvent` запускается через соответствующую ручку инита платежа, а
событие `InitPayoutEvent` возникает как следствие события выплаты (см. ниже). Платёж по ордеру может быть следующих
типов:

1. Полное покрытие всего ордера. В таком случае один платеж содержит все сумму за все услуги сразу и связан с ордером.
2. Частичное процентное покрытие всего ордера. В таком случае один платеж содержит в себе некий процент от суммы за все
   услуги. Платёж связан с ордером
3. Частичное покрытие услуг ордера. В таком случае платёж проходит по некоторым услугам и связан с ними.

Инициализацию платежа одного типа можно вызвать любое количество раз. Комбинировать различные типы нельзя. Тип задается
через событие изменения ордера (`UpdateOrderEvent`) до первой инициализации платежа. При частичной оплате мы делим
оплату на несколько частей и каждой части присваиваем свой `id`. В частности, если оплата идет по одной услуге, то
этот `id = order_item_id`. Если по всем сразу, то `id = order_id`.

Ключ идемпотентности рассчитывается в зависимости от типа и формата оплаты:

1. Оплата. Полное покрытие. Ключ считается по формуле `init_payment_${initCount}`, где `initCount` - количество
   предыдущих инициализаций оплаты.
2. Оплата. Частичная, каждая из частей получает свой `id`. Ключ считается по формуле `init_payment_${id}_${initCount}`,
   где `initCount` - количество предыдущих инициализаций платежа по `id`.
3. Выплата. Полное покрытие. Ключ считается по формуле `init_payout_${initCount}`, где `initCount` - количество
   предыдущих инициализаций оплаты.
4. Выплата. Частичная, каждая из частей получает свой `id`. Ключ считается по формуле `init_payout_${id}_${initCount}`,
   где `initCount` - количество предыдущих инициализаций платежа по `id`.

**Обновление транзакции.** Событие `TransactionEvent`

**Ручное обновление транзакции.** Событие `ManualTransactionEvent`

**Начало выплаты.** Событие `StartPayoutEvent`

### События чеков

**Отправка чека.** Событие `ReceiptEvent`

[//]: <> (TODO: Все строки ниже удалить)
Типы событий примерно могут быть представлены в следующем виде:

```
message EventData {
    
    //События ордера
    message OpenOrderEvent {
         //тип ЖКХ/аренда
         //полный/хвостик
    }
       
    message CreateOrderItemEvent {
         //string order_item_id = 1 [(required) = true];
         //сумма, тип услуги (арендная плата, страховка, комиссия, штраф и т.п.)
         //тип входящий/исходящий (оплата или выплата)
    }
       
    message CancelOrderItemEvent {
         //string order_item_id = 1 [(required) = true];
    }
    
    message CloseOrderEvent {
    }
    
    //События платежей
    message InitTransactionEvent {
         //string transaction_id = 1 [(required) = true];
         //string user_id = 2 [(required) = true];
         //данные о транзакции 
         //данные о оплачиваемых услугах
         //тип платежа: входящий/исходящий
    }
       
    message ConfirmTransactionEvent {
         //string transaction_id = 1 [(required) = true];
         //string user_id = 2 [(required) = true];
    }
       
    message ErrorTransactionEvent {
         //string transaction_id = 1 [(required) = true];
         //string user_id = 2 [(required) = true];
         //Статус ошибки
    }
       
    //События чеков
    message ReceiptEvent {
         //string transaction_id = 1 [(required) = true];
    }
       
    oneof event {
            option (oneof_required) = true;
            OpenOrderEvent open_order_event = 1;
            CreateOrderItemEvent create_order_item_event = 2;
            CancelOrderItemEvent cancel_order_item_event = 3;
            CloseOrderEvent close_order_event = 4;
            
            InitTransactionEvent init_transaction_event = 10;
            ConfirmTransactionEvent confirm_transaction_event = 11;
            ErrorTransactionEvent error_transaction_event = 12;
            
            ReceiptEvent receipt_event = 30;
    }
}
```