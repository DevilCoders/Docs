## Обновление E2C-сертификата в КриптоПро

В данный момент интеграция с E2C API тинька устроена таким образом, что каждый запрос подписывается
электронной подписью через КриптоПро и Я.Подпись (подробнее об этом
[тут](https://docs.yandex-team.ru/realty/rent/payments/tinkoff#payouts)).
В Я.Подписи хранится сертификат, срок годности которого - примерно год, поэтому периодически его нужно обновлять,
что являет собой очень непростой процесс с юридической точки зрения.

Есть вариант уйти с такого вида сертификатов в сторону RSA, но пока этого не сделали,
поэтому будет очень полезен чеклист про то, как обновлять сертификат КриптоПро.

### Полезные ссылки

- [Тикет](https://st.yandex-team.ru/DSS-223) про выпуск самого первого продового сертификата.
- [Тикет](https://st.yandex-team.ru/DSS-532) про перевыпуск второго продового сертификата.
- [Тикет](https://st.yandex-team.ru/REALTYBACK-8456) про переход на RSA сертификаты.

### Чеклист для разработчиков

- **Подготовка**
  - Получить на почту алерт о том, что сертификат скоро заэкспайрится (алерт настроен заранее).
  - Завести тикет в REALTYBACK, в рамках которого будет вестись работа по замене сертификата.
  - Если нет ролей наблюдателя сервиса в Я.Подписи, запросить их.
  В IDM нужно выбрать систему "Яндекс Подпись -> Наблюдатель сервиса",
  сервис - "Аренда (API)" и "Аренда (Scheduler)" (всего нужно две роли).
  - После получения роли зайти в [интерфейс](https://ysign.yandex-team.ru/index.html#/users) продовой Я.Подписи и
  убедиться, что там виден текущий актуальный сертификат. Отсюда будем следить за созданием нового сертификата дальше.


- **Юридические вопросы**
  - Передать [ссылку на форму](https://cdoc.mba.yandex-team.ru/965) ответственному менеджеру.
  В этой форме заполняются все данные, необходимые для перевыпуска сертификата, их знают только менеджеры и юристы.
  - Далее запускается сложный процесс подготовки документов. Разработчики тут ничем помочь не могут, а для юристов
  мы решили не готовить чеклисты, т. к. за год слишком много всего меняется. Главное, - периодически пинговать юристов
  и убеждаться, что процесс двигается и делается заранее.
  - Вначале юристы находят подходящую доверенность (или делают новую) для менеджера, её нужно передать менеджеру
  из Я.Подписи (в 2022 году эта была [Юля Дашковская](https://staff.yandex-team.ru/mozart)).
  - Далее совместно юристы Я.Подписи и Я.Аренды коммуницируют с представителями тинька, чтобы окнуть все документы.
  - Результат работы юристов и менеджера - появление нового актуального сертификата
  в [интерфейсе](https://ysign.yandex-team.ru/index.html#/users) Я.Подписи.


- **Переход на новый сертификат**
  - Из [интерфейса](https://ysign.yandex-team.ru/index.html#/users) Я.Подписи нужно скачать открытую часть ключа
  для нового сертификата (файлик с расширением `.cer`). Это делается кнопкой скачивания в правой части
  строки нужного сертификата (см. скриншот ниже).
  - Оттуда же запоминаем id нового сертификата (столбец "ID сертификата").
  - Запаковать `.cer`-файл в zip-архив.
  - Отправить архив на почту `eacq_support@tinkoff.ru`, отписавшись о ситуации и указав ключ нашего продового
  E2C-терминала (его можно найти
  [в services](https://a.yandex-team.ru/arcadia/classifieds/services/conf/realty-rent/prod/common.yml?rev=r9618332#L26),
  см. env-переменную `TINKOFF_E2C_TERMINAL_KEY`).
  - Через какое-то время с этой почты ответит менеджер о том, что они поддержали новый сертификат на своей стороне.
  - Только после этого можно поменять
  [в services](https://a.yandex-team.ru/arcadia/classifieds/services/conf/realty-rent/prod/common.yml?rev=r9618332#L12)
  env-переменную `CRYPTOPRO_CERTIFICATE_ID`, указав id нового сертификата.
  - Если доверенность оформляли на другого человека, то там же нужно поменять ещё и `CRYPTOPRO_LOGIN`, записав в него
  staff-логин соответствующего менеджера.
  - Теперь нужно ребутнуть в проде `rent-api` и `rent-scheduler` так, чтобы новые env-переменные подхватились.
  - Чтобы проверить, что запросы нормально подписываются и выполняются, достаточно проверить, что открывается страница
  с привязанными картами в админке
  [у какого-нибудь юзера](https://arenda.yandex.ru/management/manager/user/008f83d2720a7800/payment/methods/).

![ysign interface](img/ysign-interface.png)
