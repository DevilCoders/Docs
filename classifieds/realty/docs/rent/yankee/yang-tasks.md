## Задачи в Yang

[Yang Tools](https://a.yandex-team.ru/arcadia/crowdsourcing/yang/yang-tools) - сервис-обёртка над Yang'ом, Hitman'ом и прочими сервисами для автоматического выполнения задач по распознаванию ПД на изображениях. Мы используем его для разметки данных паспорта и сверки фото паспорта и селфи.

### Как мы храним информацию о тасках Yang'а

Есть табличка `yang_task` со следующими полями:
- `id` - идентификатор таски, сохраняется в БД Аренды для обращения по нему в Yankee за результатами тасок;
- `task_type` - тип таски в Yang'е (сверка фото паспорта и селфи, разметка главной страницы паспорта и страницы с регистрацией);
- `payload` + `payload_json` - кастомный payload для данного типа таски (для фотографий паспорта - набор `documentId` фотографий в Пальме, плюс `userId` пользователя в Аренде);
- `idempotency_key` - ключ идемпотентности для таски в Yang'е, используется для дедубликации тасок в MySQL БД и в самом Yang'е (передаётся в поле `unique_key`);
- `status` - статус таски в Yange'е, имеет следующие значения:
  - `new` - таска в Yang'е ещё не создана;
  - `initiated` - таска в Yang'е создана, ожидаётся получение результата;
  - `success` - результат таски в Yang'е успешно получен и сохранён;
  - `failed` - таска в Yang'е зафейлилась;
- `yang_operation_id` + `yang_operation_create_time` - id операции в Yang'е и время её создания;
- `result` + `result_json` - поле с результатами выполнения таски, содержит только техническую информацию (например, тексты ошибок), не содержит ПД;
- `delivery_status` (`not_delivered`, `delivered`) - статус доставки терминального статуса таски в кафку.

### Как мы обрабатываем таски Yang'а

Поверх таблички `yang_task` есть вотчер (реализованный по новой схеме с оптимистическими локами, todo - добавить ссылку). Вотчер содержит следующие стейджи.
- `YangTaskInitiationStage`
  - срабатывает при статусе `new`;
  - перекладывает фотографии из шифрованной Пальмы во временное хранилище;
  - преобразует `payload` в параметры таски Yang'а (см. формат [здесь](https://st.yandex-team.ru/MASSRECRUIT-3590)), в том числе берёт `idempotency_key` в качестве `unique_key` таски Yang'а;
  - создаёт таску в Yang'е и сохраняет её `operation_id`.
- `YangTaskPollingStage`
  - срабатывает при статусе `initiated`, когда после `yang_operation_create_time` прошло хотя бы N секунд;
  - поллит статус операции в Yang'е - если он ещё не терминальный, рескедулится на N секунд вперёд;
  - если статус операции в Yang'е `OK`, то преобразует ответ Yang'а (см. формат [здесь](https://st.yandex-team.ru/MASSRECRUIT-3590)) в модель хранения и при наличии в ответе ПД сохраняет их в шифрованную Пальму;
  - если статус операции в Yang'е `BAD`, то сохраняет информацию об ошибках в `result`.
- `StatusDeliveryStage`
  - срабатывает при статусах `success` и `failed`, когда `delivery_status` - `not_delivered`;
  - преобразует результат выполнения таски в `YankeeEvent` (не содержит ПД!) и отправляет его в топик кафки `realty-yankee-events`.

### Жизненный цикл тасок про разметку паспорта

- Yankee узнаёт из топика `rent-diff-events`, что в юзере аренды изменились [фотографии паспорта](https://a.yandex-team.ru/arcadia/classifieds/realty/realty-model/src/main/proto/rent/user.proto?rev=r9466278#L106).
- В консьюмере Yankee создаёт три таски - сверка фото паспорта и селфи, разметка главной страницы паспорта и страницы с регистрацией.
- В качестве `idempotency_key` он конкатенирует три `documentId` фотографий паспорта.
- Далее выполняются все стейджи `YangTaskWatcher`'a (см. предыдущий раздел), в результате распаршенные данные паспорта складываются в шифрованную Пальму, и в кафку отправляется сообщение о результате таски.
- В `rent-consumer`'е проверяется, совпадают ли `documentId` завершённой таски с теми, которые в данный момент находятся в юзере Аренды, и если да, то в него сохраняется результат и `yankee_task_id`.
- Когда до `rent-consumer`'а доходят результаты всех трёх тасок, в юзере меняется агрегированный статус проверки паспорта.
- Этот статус затем пробрасывается из ручек `rent-api` в ЛК вместе с распаршенными данными паспорта. Сами данные при этом хранятся только в Пальме, и `rent-api` ходит за ними в проксирующие GRPC-ручки Yankee.
- При перезагрузке фотографий паспорта из ЛК вся информация о тасках из юзера стирается (или уходит в архив), и процесс начинается заново.
