## Экспорт лидов в Yt

Содержимое лидов Амо экспортируется в [Yt-табличку](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/prod/warehouse/realty/lead) в виде лога событий `LeadEvent`. Табличка широко используется аналитиками (например, для подсчёта времени, сколько сделки находятся в каждом из статусов).

### Как найти в коде

- `yt_export_hash` - поле в табличке `Lead`, хэш, при изменении которого отправляются события в Yt.
- `last_event_timestamp` - поле в табличке `Lead`, время, до которого включительно уже были отправлены события в Yt.
- `LeadEventsExportDecider` - место, где вычисляется хэш лида.
- `SendLeadEventsStage` - стейдж, где `LeadEvent` отправляются в брокер.
- `EventExportManager` - класс с логикой вычисления очередной пачки эвентов.

### Алгоритм экспорта

- В стейдже вычисляется хэш лида (по сущности из базы и по модели из ответа `AmocrmClient`'a), и если он изменился с прошлого раза, запускается алгоритм экспорта.
- Идёт запрос в Амо в [ручку получения событий](https://www.amocrm.ru/developers/content/crm_platform/events-and-notes#events-list) по данному лиду, с учётом пагинации.
- Полученные события фильтруются по времени (больше `last_event_timestamp`) и по типу.
- События по очереди (от последнего к первому) применяются к текущему состоянию лида, "отматывая" его состояние назад во времени.
- Итоговая цепочка событий в нужном порядке отправляется в брокер.
- В табличке `lead` обновляются поля `yt_export_hash` и `last_event_timestamp`.
