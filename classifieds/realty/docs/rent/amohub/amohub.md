## Amohub

Amohub - микросервис для интеграции с [AmoCRM](amocrm).

### Функции

- [**Зеркалирование сущностей**](amo-mirroring). Контакты и лиды Амо зеркалируются в базу данных amohub'a с тем, чтобы
иметь возможность произвольной выборки по ним.
- [**Асинхронные запросы в Амо**](crm-actions). В базу сохраняются экшены, при выполнении которых в Амо делаются запросы
по заданной бизнес-логике.
- [**Экспорт лидов в Yt**](lead-export). Настроен экспорт лидов без брокер в виде лога событий об изменениях лидов.
- [**Смена ответственных в Амо**](responsible-changes). На основе дежурств в ABC переодически перераспределяются
ответственные менеджеры в воронке показов.
- **Rate limiter**. Все запросы в AmoCRM идут из scheduler'a amohub'a, вотчеры которого работают на одном инстансе.
Засчёт этого достигаются нужные 10 rps.

### Устройство

![rent-amohub structure](img/rent-amohub-structure.png)

Amohub состоит из трёх частей, объединённых в один микросервис.
- **Scheduler**. Набор вотчеров на табличках из БД, плюс набор периодических тасок.
- **Consumer**. Читает из топиков кафки, создавая Crm action'ы при некоторых триггерах:
  - `rent-diff-events` - реагирует на изменения сущностей в БД Аренды;
  - `holocron-realty-compare-from-vos` - реагирует на появление новых офферов аренды в Яндекс.Недвижимости.
- **GRPC API**. Получить доступ к нему в тестинге можно с помощью grpcui:
  `./grpcui -plaintext rent-amohub-api.vrts-slb.test.vertis.yandex.net:80`

Кроме того, amohub пишет события об изменениях лидов в удобочитаемом формате в свой собственный топик кафки -
`realty-amohub-events` (пример его использования есть [здесь](crm-actions#dvustoronnyaya-sinhronizaciya-statusov)).

Графики с метриками amohub'a [здесь](https://grafana.vertis.yandex-team.ru/d/Us6-Kwenz/rent-amohub-dashboard).
