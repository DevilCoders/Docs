## Зеркалирование сущностей AmoCRM

В amohub'e реализовано зеркалирование контактов и сделок Амо в собственную MySQL базу данных. При нормальной работе
amohub'a лаг отставания данных в базе от данных в AmoCRM - 1-2 минуты.

### Зачем нужно зеркалирование

API AmoCRM небогато на возможности фильтрации и поиска по лидам и контактам, поэтому в самом начале разработки
Яндекс.Аренды было решено зеркалировать сущности Амо в свою базу в формате, удобном для произвольных выборок.

### Что храним в базе, чтобы зеркалирование работало

Есть табличка `crm_integration` с единственной строкой, которая содержит следующее.
- `access_token` и `refresh_token` - периодически обновляемые токены, с которыми делаются все запросы в Амо.
- `last_tokens_update_time` и `tokens_expiration_time` - времена для обновления токенов.
- `last_sync_time` - время, до которого включительно на данный момент успешно отзеркалированы лиды и контакты Амо.

На этой табличке есть вотчер, состоящий всего из двух стейджей.
- `ExchangeTokensStage` - обновляет токены раз в 23 часа.
- `SyncStage` - делает pull всех изменений контактов и лидов Амо раз в 1 минуту.

### Как работает зеркалирование

Раз в 1 минуту стейдж вызывает метод `ru.yandex.realty.amohub.backend.manager.AmocrmSyncManager.sync`, реализующий
всю логику зеркалирования. Алгоритм тут следующий.

- В ручки получения [сделок](https://www.amocrm.ru/developers/content/crm_platform/leads-api#leads-list) и
[контактов](https://www.amocrm.ru/developers/content/crm_platform/contacts-api#contacts-list) идут запросы вида
"получить сущности, отсортировав по убыванию update time".
- Из сущностей отбираются те, у которых update time больше `last_sync_time`.
- В ручках есть пагинация, поэтому при необходимости в эти ручки идёт по несколько запросов.
- Полученный батч контактов и лидов трансформируется в сущности БД, которые затем обновляются или инсертятся.
- В базе обновляется `last_sync_time`.

В этой схеме есть нюансы.

- Чтобы один вызов зеркалирования выполнялся за прогнозируемое время, собираемый батч сущностей ограничивается сверху
по максимальному update time (`last_sync_time` + 3 минуты) и по размеру батча (2500 сущностей за раз). Всё, что
не попало в обрезанный батч, попадёт в него при следующем вызове.
- Т. к. инстанс AmoCRM один на прод и тестинг, есть необходимость уметь различать в нём продовые и тестинговые сущности.
Поэтому при зеркалировании лиды фильтруются по `pipelineId` (id воронки), а контакты - по наличию тега `testing`.
- [Фильтрация по id воронки](https://a.yandex-team.ru/arcadia/classifieds/realty/amohub/rent-amohub/src/main/scala/ru/yandex/realty/rent/amohub/backend/manager/RentAmocrmSyncManager.scala?rev=r9725368#L43)
подразумевает, что чтобы начать зеркалировать новую воронку, нужно добавить её id в соответствующий список.
- Данный механизм не позволяет узнавать об удалении сделок и контактов в Амо, поэтому дополнительно к нему есть
`LeadWatcher` и `ContactWatcher`, в стейджах которых сущности переобходятся и помечаются удалёнными. Лаг обновления
признака `deleted` составляет несколько дней. Этот механизм мы называем **синхронизацией** (не путать
с **зеркалированием**!).

### Инварианты отказоустойчивости

Т. к. список id воронок из механизма зеркалирования мы убрать не можем, то это рождает определённые ограничения и
вероятность что-то сломать действиями в Амо. Поэтому решили договориться с менеджерами о нескольких инвариантах.
- Перенос лида из известной нам воронки в неизвестную и обратно не должен ничего ломать (зеркалирование при этом
не обеспечивается).
- Воронки можно добавлять, не спрашивая нас, но их сделки зеркалироваться не будут (и в аналитику отправляться тоже).
- Если нужно зеркалировать и отправлять в аналитику сделки из новой воронки, нужно завести на нас задачу.

### Графики

- [График](https://grafana.vertis.yandex-team.ru/d/Us6-Kwenz/rent-amohub-dashboard?orgId=1&from=now-6h&to=now&viewPanel=9)
обновления токенов Амо
- [График](https://grafana.vertis.yandex-team.ru/d/Us6-Kwenz/rent-amohub-dashboard?orgId=1&from=now-6h&to=now&viewPanel=8)
лага зеркалирования сущностей Амо
