## Crm actions

### Что такое Crm action

Crm action - абстрактное действие, которое нужно совершить в Амо. Например, создать сделку (одну или несколько), изменить её статус, добавить в неё комментарий или таску, что угодно ещё. При обработке одного экшена в Амо может делаться произвольное количество запросов, могут делать дополнительные запросы в другие сервисы и в БД amohub'a.

Один экшен - это одна строка в таблице `crm_action`, в которой хранится следующее:
- `action_type` - по типу определяется, как нужно процессить данный экшен;
- `idempontency_key` - обеспечивает идемпотентность в создании экшенов (см. ниже);
- `group_id` - используется для предотвращения гонок в обращении к Амо (см. ниже);
- `payload` - proto-поле с произвольной информацией, необходимой для обработки экшена.

### Как создаются Crm action'ы

Экшены создаются в следующих местах.
- В консьюмере от топика кафки `rent-diff-events` для этого используется трейт `CrmActionExtractor`.
- В консьюмере от топика `holocron-realty-compare-from-vos` они создаются в зависимости от состояния в табличке `offer`.
- Часть экшенов создаётся в GRPC-сервисе `CrmActionService`.
- Часть экшенов создаётся в `ChangeShowingResponsibleUserStage`.

Для идемпотентного создания экшенов при каждом из данных триггеров для каждого типа экшена по некоторому правилу создаётся ключ идемпотентности (например, `owner_request_id` + время отправки SMS).

### Как процессятся Crm action'ы

Есть `CrmActionGroupWatcher`, который батчами собирает экшены из базы и процессит их, выбирая нужную реализацию `CrmActionProcessor`'a для данного типа экшена (см. `ProcessActionStage`).

При процессинге все экшены агрегируются в группы по полю `group_id`. Внутри каждой группы экшены выполняются строго в порядке их создания в базе. **Таким образом предотвращается гонки в обращении к Амо**. Например, в `group_id` можно сохранять `flat_id`, тогда все экшены, связанные с данной квартирой, выполнятся последовательно.

Каждый экшен пытается запроцесситься 10 раз. При ошибке на 10-й раз он переходит в статус `Error` и больше не процессится - такие ошибки можно увидеть на графиках и в алертах.

### Что делать с зафейленными экшенами?

Зависит от конкретной ситуации и типа экшена:
- если фейлы - результат ошибки в коде или временных проблем с окружением (например, отставала синхронизация с Амо), то можно выборочно перезапустить экшены запросом в базу:

  `update crm_action set status = 'new', visit_time = now() where id in (<...>)`

- если это не массовая проблема, и то, что несколько экшенов зафейлилось, некритично, то с самими экшенами можно ничего не делать, но код процессора лучше поправить так, чтобы учитывались неучтённые кейсы, и результат обработки был не ошибкой, а осознанным игнорированием экшена.

### Дедубликация

Т. к. при процессинге одного экшена может происходить несколько запросов в Амо, нужно думать о том, что произойдёт, если часть из них выполнится успешно, часть упадёт с ошибкой, а затем выполнится ретрай.

Это особенно критично для экшенов, которые создают лиды в Амо, т. к. важно не создавать их дубли. Простейший способ этого добиться - сохранять в `payload` id созданного лида при ошибке после его создания. Примеры такой реализации:
- `RentRequestProcessor`
- `CreateOfferLeadProcessor`
- `OwnerRequestSmsSentProcessor`
- `CreateShowingProcessor`

В исключительных случаях этого может быть недостаточно. Например, при создании двух лидов с одинаковой ссылкой на показ в админке нагибается вся синхронизация с Амо, поэтому в `CreateShowingProcessor` есть дополнительная защита в виде таблички `showing_lead`. Используется она следующим образом.

- В коде процессора сначала ищется запись в этой табличке с данным `showing_id`, чтобы найти `lead_id`, если он уже был создан ранее.
- Если в табличке ничего не нашли, то создаётся лид (пока без ссылки на показ), и в эту табличку сохраняется пара `showing_id` + `lead_id` (в отдельной транзакции).
- Далее отдельным запросом делается апдейт лида в Амо - проставляется ссылка на показ.
- Таким образом, в Амо невозможно создать два лида с одинаковыми ссылками на показ.
- Тем не менее, есть вероятность множественного создания лидов без ссылок, но это менее критично.

### Односторонняя синхронизация статусов

В воронке собственников лиды связаны с `OwnerRequest`'ами Аренды 1:1, но статусы между ними синхронизируются **только в одну сторону**: если поменялся статус в админке Аренды, обновится статус лида в Амо, но не наоборот.

Реализация тут очевидная, см. здесь:
- `OwnerRequestStatusChangedExtractor`
- `OwnerRequestStatusChangedProcessor`

### Двусторонняя синхронизация статусов

В воронке показов лиды связаны с `FlatShowing` Аренды 1:1, и статус между ними синхронизируются **в обе стороны**.

При изменении статуса показа в админке происходит следующее:
- в показе обновляется поле `status_moderation_update_time`;
- создаётся экшен в `UpdateShowingStatusExtractor`;
- статус лида обновляется в `UpdateShowingStatusProcessor`.

При изменении статуса лида происходит следующее:
- через механизм синхронизации с Амо обновится статус лида в БД amohub'a;
- в `LeadUpdatedEventStage` отправится эвент в кафку об изменённом лиде;
- в `ShowingsLeadProcessor` `rent-consumer`'a обновится статус показа в БД Аренды;
- экшен в `UpdateShowingStatusExtractor` при этом не создастся, т. к. не будет обновлено поле `status_moderation_update_time`, - таким образом, обновление статуса не может зациклиться.

### Графики

- [График](https://grafana.vertis.yandex-team.ru/d/rMtSovJnz/amohub-dashboard?orgId=1&from=now-6h&to=now&viewPanel=10) успешного процессинга экшенов
- [График](https://grafana.vertis.yandex-team.ru/d/rMtSovJnz/amohub-dashboard?orgId=1&from=now-6h&to=now&viewPanel=11) recoverable ошибок в процессинге экшенов (после таких ошибок будет ретрай)
- [График](https://grafana.vertis.yandex-team.ru/d/rMtSovJnz/amohub-dashboard?orgId=1&from=now-6h&to=now&viewPanel=12) unrecovable ошибок в процессинге экшенов (ошибка после 10-й попытки)
