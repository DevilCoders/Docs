# Как юзать модуль schema-registry

## Дисклеймер

Здесь описывается временная версия работы gradle-модуля `schema-registry`. Позже она будет улучшена засчёт гранулярной сборки proto-файлов. Когда это случится, эта дока будет обновлена.

## Для чего он нужен

Gradle-модуль `schema-registry` собирает proto-модели из соседней папки в Аркадии, отбирая из них только те модели, которые используются в нашем репозитории, таким образом сокращая время сборки этих моделей.

При этом он умеет отдельно компилировать часть proto-моделей в java-классы, а часть - в scalapb-классы. Засчёт этого тоже экономится время сборки.

Кроме того, **больше не нужно менять номер версии `schema-registry`** и ждать, пока соберутся её джарки. Вместо этого можно менять proto-модели и использующие их классы в `realty` **в рамках единого PR'а**.

## Как им пользоваться

В файле `schema-registry/build.gradle` есть два списка моделей, которые компилируются, соответственно, в java- и scalapb-классы:
- `includeJavapbPaths`;
- `includeScalapbPaths`.

В обоих списках можно указывать либо гранулярно выбираемые proto-файлы (например, `'broker/broker_options.proto'`), либо целые папки (например, `'realty/'`). В последнем случае выберутся все модели внутри данной папки и всех вложенных в неё.

При необходимости использовать в `realty` proto-модели из `schema-registry`, которые не попадают в эти списки, их нужно добавить (только в один из этих списков, в оба без необходимости добавлять не надо).

## Как он работает

- Есть два source set'a - `javapb` и `scalapb`, - для каждого из которых раздельно отбираются модели из соседней папки `../../schema-registry`.
- Для каждого из них отдельно запускается `protoc`- компилятор в тасках protobuf-плагина - `generateJavapbProto` и `generateScalapbProto`.
- Генерируемые ими классы подсовываются в `main` source set.
- Далее они компилируются, соответственно, тасками `compileJava` и `compileScala`.
- Есть две конфигурации `javapbCompileProtoPath` и `scalapbCompileProtoPath`, наследующие от `api`, - они нужны, чтобы из зависимостей можно было вытащить proto-модели и использовать их в импортах, для каждого из source set'ов.
- Кроме того, таска `processResources` настроена так, чтобы в ресурсы собираемой джарки добавились все отобранные proto-модели из обоих source set'ов, - это нужно, чтобы они могли использоваться во всех остальных модулях в `realty`.

## Что может пойти не так

- Т. к. мы зависим не только от недвижечных proto-моделей, но и общевертикальных, и даже авторушных, то при добавлении в них разработчиками из других команд новых импортов у нас может ломаться билд. С этим ничего не поделать (в `verticals-backend` есть аналогичная проблема), поэтому иногда придётся чинить билд добавлением в наши списки новых чужих proto-моделей.
- При увеличении количества генерируемых scalapb-классов может потребоваться увеличение XMX в файле `gradle.properties`. Эта проблема должна будет порешаться позже засчёт гранулярной сборки proto-моделей.
