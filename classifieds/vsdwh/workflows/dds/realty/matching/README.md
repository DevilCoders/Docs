## Матчинг звонков в Недвижимости

Алгоритм матчинга описан в задаче https://st.yandex-team.ru/VSDWH-1670

### Новостройки
У нас в новостроечном домене есть несколько типов звонков, которые отличаются по тэгам

1. Звонки не с сервиса: `serp`, `mapsMobile`, `type=suburban`
2. Звонки с персональными подменниками, они в себя включают следующую информацию:
   - yuid - для звонков с веба , uuid, adid для звонков с аппов
   - платформа, которая пишется в сочетании со словом Platform
   - site_id 
   - offer_id
   - utm_campaign
   - utm_source
   - место, откуда был сделан звонок : карточка ЖК или оффер новостройки

   Такие подменники есть не во всех регионах. Регионы в которых есть персональные подменники:

   | subject_federation |
   |---|
   | Москва и Московская область |
   | Санкт-Петербург и Ленинградская область |
   | Нижегородская область |
   | Свердловская область |
   | Ростовская область |
   | Краснодарский край |
   | Республика Татарстан |

   Пример, как определять источник звонка (ЖК или новостроечный оффер): 
`PlatformDesktopCampaign#utmSource=GoogleAdwordsKms#yuid=5288309071621522068#siteId=224482#utmCampaign=1487522111_kms-gdn_msk_dinamicheskiy-remarketing-jk#utmDate=01.01.2022` - звонок с карточки ЖК

   `PlatformTouchOffer#yuid=9306202181638637783#siteId=1685695#offerId=5205620753106731449` - звонок с карточки оффера

   `PlatformDesktopCampaign` - содержит в себе информацию о платформе и источнике просмотра телефона. В данном случае звонок совершен с карточки ЖК, на это указывает слово Campaign. Если бы звонок был совершен с оффера, то эта часть выглядела примерно так `PlatformTouchOffer`, ну и в самом тэге передастся offerId
}>
3. Звонки с сервиса, но в регионах, где нет персональных подменников, имеют не персональные телефоны, поэтому тэги у них отличаются. По ним нельзя определить платформу или id пользователя, но можно определить с оффера был звонок или с карточки ЖК. 
<{Какие бывают:
campaign - звонок с ЖК
newbuildingOffer - звонок с оффера
}>

4. Звонки с сервиса, телефоны для которых в некоторых регионах выдаются с 22х до 7ми утра, и звонки для роботов. Они помечаются специальными тегами `personalDefault` (22-7, тоже только в регионах с персональными подменниками) и `HoneyPot` (роботы)

У всех таких звонков есть billing_campaign_id по которому можно определить site_id


Исходя из этого предлагаю следующие схемы матчинга для каждого из этих типов звонков

1. **Звонки не с сервиса** - сразу в missmatched
2. **Звонки по персональным подменникам** - Ищем просмотры телефона с таким же id пользователя (yuid, uuid, adid), с таким же site_id. Если такие не нашли, то отправляем в missmatched сразу. Дальше смотрим на offer_id. Если не нашли с таким offer_id, то не страшно, это возможно ошибка на стороне продукта. Ищем ближайший с idшниками выше (yuid, uuid, adid, site_id), иначе отправляем в missmatched. На другие параметры не смотрим. 
3. **Звонки с неперсональным подменником** тоже можно максимально близко сматчить. Во первых у каждого звонка есть billing_campaign_id, по которому можно определить site_id. Поэтому в первую очередь, смотрим именно на site_id и номер телефона с которого совершили звонок. Если не нашлось таких просмотров телефонов, то отправляем в missmatched. Тут можно еще опираться на то, откуда был совершен звонок - с карточки ЖК или с карточки оффера и искать ближайший среди нужного источника. !!Тут надо уточнить, везде ли нас есть номер телефона, который выдается при просмотре телеофона!!
4. **Звонки с сервиса, которые выдаются с 22-7 и для роботов** - тут мы поступаем так же как в пункте 3, только без определения источника просмотра телефона (ЖК или оффер)

### Яндекс.Аренда и вторичка

Вторичка и Яндекс.Аренда так же важны и в некоторых регионах у них так же есть персональные подменники. На данный момент регионы с персональными подменниками во вторичке это Новосибирская область, Свердловская область, Москва и Московская область, Санкт-Петербург и Ленинградская область. В других регионах подменники не персональные и матчить там нужно по ближайшему с таким подменным номером телефона, и, если звонок тузовый, то там есть информация о категории оффера, типе сделки, uid автора - это тоже необходимо учитывать при матчинге. Если хоть что-то из этого не совпадает, то отдаем в missmatched.

Далее опишу, как я вижу правильный матчинг для звонков по персональным подменникам:

1. Так же как и для новостройки в тэг прокидывается yuid, uuid, adid, так что в первую очередь ищем просмотры телефона по id пользователя. Если не нашли, то отправляем в missmatched.
2. В тэг прокидывается offer_id, так что далее матчим по нему и по такому же номеру телефону, что был звонок. Если не нашли, то в missmatched.

Но надо понимать, что к сожалению, сейчас далеко не все покрыто персональными подменниками, даже в регионах, где мы такое выкатили. Тут так же как и во вторичке мы не выдаем персональные подменники, если он был запрошен с 22-7 утра. Это работает для всей вторички, кроме Я.Аренды. Поэтому если звонок совершен не по персональному подменнику (отсутсвует id пользователя), то матчим как обычные звонки вторички. Очень важно, что бы категория, тип сделки и uid автора в тузовых звонках совпадали. 

**В первую очередь, нам важно качество матчинга. Полнота нам важна меньше.**
