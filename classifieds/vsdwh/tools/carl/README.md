# carl

`carl` — это CLI-утилита, позволяющая облегчить работу с vh3 для хранения графов в виде Python3-кода.
За счёт чего это достигается:
1. Использование vh3 происходит внутри самой утилиты и сокрыто от пользователя `carl`
2. `carl` предоставляет удобные средства для описания параметров создаваеых инстансов Nirvana-графов: можно унифицировать общие глобальные опци и их значения в ресурсах, а описание инстансов происходит в одном классе.
3. `carl` предоставляет библиотеку операций Nirvana с дополнительным функционалом в виде провязки некоторых опций кубиков на глобальные опции графа.
   Например, `yt_token` во всех реализованных операциях будет пытаться примагнититься к одноимённой глобальной опции графа, что делает использование библиотеки более лаконичным.
   Так в код для кубика [YQL 4](https://nirvana.yandex-team.ru/alias/operation/yql4) достаточно передать только запрос, а все токены подтянутся из глобалзов графа.
4. `carl` предоставляет функционал пресетов (аналогичных пресетам в [lama](https://a.yandex-team.ru/arc/trunk/arcadia/maps/analytics/tools/lama)):
   типичные графы можно описать один раз в виде функции с небольшим числом аргументов, что позволит описывать графы ещё лаконичнее.

Всё это позволяет более простыми методами, чем работа напрямую с vh3, описывать графы кодом, а также унифицировать процессы внутри команды за счёт общих ресурсов и пресетов.




## Сборка утилиты

1. [Счекаутить Аркадию](https://doc.yandex-team.ru/arc/setup/arc/install.html)
2. В директории Аркадии `/classifieds/vsdwh/tools/carl/bin` выполнить
```bash
$ ya make
```
В `bin` появится `carl`, который можно сделать доступным глобально, например, при помощи такого симлинка:

```bash
$ ln -snf ~/arc/classifieds/vsdwh/tools/carl/bin/carl  /usr/local/bin/carl
```




## Авторизация
Для работы необходимо задать переменную окружения `NIRVANA_TOKEN`:
```bash
$ export NIRVANA_TOKEN='<ваш токен>'
```
Сам токен можно получить [тут](https://oauth.yandex-team.ru/authorize?response_type=token&client_id=637ca17604cb4dfa90b262952c00b1e9).




## Команды
На данный момент реализована одна команда `sync`, которая создаёт новый инстанс **в уже существующем графе Нирваны** из переданного ей кода.

При вызове `carl sync` утилита по умолчанию ищет файл `carl.py` с описанием графа в текущей рабочей директории и производит деплой его в Нирвану. При помощи опции `-c` можно указать произвольный путь до файла (**важно, именно до .py файла, удовлетворяющего описанным ниже условиям**) с кодом графа:
```shell
$ carl sync -c /path/to/your/carl.py
```
В случае успеха выведется ссылка на созданный инстанс.




## Как описать свой граф кодом
В папке [examples](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/examples) содержатся примеры кода описания графов как с импользованием пресетов, так и с явным описанием операций и их зависимостей. Общие требования к коду таковы:

* Обязательно должна быть корректно определена переменная `CONFIG` класса [GraphConfig](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/lib/config/graph_config.py#L14).

* Обязательно должен быть определена функция
```python
def workflow():
```
В ней описывается то, какие кубики с какими значениями опций и связями есть на графе. При передаче значений в опции кубиков и описании типов связей между кубиками будут полезны функции из `classifieds.vsdwh.tools.carl.lib.operations`. С их помощью, например, можно задать последовательное выполнение кубиков, передавать в опции кубиков текст из файлов или Nirvana-exspressions и т.п.

Рекомендуется использовать операции, описанные в [библиотеке `carl`](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/lib/operations) или заранее описанные [пресеты](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/lib/presets), если каких-то операций/пресетов не хватает, их можно законтрибьютить в имеющуюся структуру через PR.

* Все импорты операций из библиотеки, пресетов, вспомогательных функций утылиты `carl` и проч. должны быть сделаны в самом файле с кодом графа

* Имя `workflow` зарезервировано для функции описания графа в конфиге. Не рекомендуется использовать его в качестве имен операций и пресетов

При вызове команды `sync` в первую очередь `carl` пытается получить описание глобальных опций и конфига графа из переменной `CONFIG`. Эти данные уже используются для создания vh3-контекста, внутри которого сначала инициализируется глобальный конфиг графа с созданием глобальных опций, а затем вызывается функция `workflow`, размещающая по графу кубики.

*Важно:* утилитные функции из библиотеки операций, использующие `expr_opt`, проверяют наличие среди глобальных опций графа опций, указанных в переданном контенте. Если внутри экспрешена опции используются необъявленные глобальные опции, деплой упадёт с ошибкой. Это же ограничивает использование `expr_opt`: его можно использовать только в пресетах и при прямом описании графа, то есть только после инициализации конфига с глобальными опциями.



## Пресеты
[Пресеты](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/lib/presets) используются, чтобы описать один раз и зафиксироовать операции каких-то часто используемых графов для того, чтобы в дальнейшем переиспользовать их.

Сам по себе пресет — это функция с произвольными параметрами, внутри которой средствами библиотеки операций и вспомогательных функций `carl` описаны операции графа и их взаимодействия. Вызов этой функции внутри функции `workflow` поместит все описанные в пресете операции на граф.

Примеры использования пресетов есть в папке [examples](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/examples), примеры реализации можно найти в [/lib/presets](https://a.yandex-team.ru/arc_vcs/classifieds/vsdwh/tools/carl/lib/presets).




## Полезное

Для доработок и использования `carl` очень полезно [создать себе виртуальное окружение](https://docs.yandex-team.ru/ya-make/usage/ya_ide/venv), чтобы использовать в IDE и пользоваться [скриптом-линтером](scripts/lint.sh). Создать такое окружение можно, выполнив в [bin](bin):
```shell
$ ya ide venv --venv-root /PATH/TO/YOUR/VENVS/DIRECTORY/carl_venv --venv-with-pip
```

Указав это окружение в Python Interpreter в PyCharm, можно будет получить рабочий саджест при использовании библиотеки операций при описании своих графов, а так же вызывать линтер из консоли IDE.
