# Холокрон

Холокрон – это специализированный архив типизированных данных (например, объявлений), преобразующий события по документам в снепшоты всех `активных` документы на конец дня. `Активным` называется документ, последнее действие по которому отличается от деактивации (см. поле `action` в модели события).

## Требования к поставке

Поставки холокрона заводятся так же, как и обычные поставки в брокер, но с некоторыми нюансами.

- В конфиге поставки следует выставить флажок *holocron*:

```
 option (.broker.config) = {
     holocron: true
 };
```

- Обязательные поля для модели события:
* **id** – строковый идентификатор объекта, к которому относится событие (например, id объявления).
* **action** – типа Action:
```
enum Action {
    UNDEFINED = 0;
    //appeared in search results
    ACTIVATE = 1;
    //an active offer was updated
    UPDATE = 2;
    //any kind of deactivation, i.e. the item is not for sale anymore
    DEACTIVATE = 3;
}
```
* **change_version** – поле типа uint32 для случаев, когда одного таймстампа события недостаточно, чтобы установить порядок. Сравнение идет сперва по `change_version`, а затем по `timestamp`.
* **timestamp** / поле, помеченное как [is_timestamp](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/broker/broker_options.proto#L18)– таймстамп отправки события аналогично обычным поставкам в брокер (можно использовать более понятное имя, например, sent_timestamp).
* **event_timestamp** – время, когда событие произошло. Именно этот таймстамп будет использоваться в расчете eod, имя является обязательным.

- Для поставки холокрона обязательно использование [перепартиционирования](./configuration.md#repartitioning) с перекладыванием по полю `event_timestamp`

## Где мои данные

Для поставки с перепартиционированием имя (путь в ыте) задается как путь для "сырых" событий, например, `holocron/auto/cars/raw`.
При этом основной директорией поставки  мы считаем директорию на уровень выше, то есть `holocron/auto/cars`.

События и eod холокрон ожидает увидеть в папках `/events` и `/eod` соответственно осносительно [основной](./configuration.md#yt-data) директории поставки.
Например, для упомянутой поставки события должны лежать в `holocron/auto/cars/events`, а eod запишутся в `holocron/auto/cars/eod`.

Потому путь для перепартиционированных событий **всегда** следует задавать как `{основная директория поставки}/events`.
Это отчасти странное требование – задавать в конфиге предопределенный путь – обусловлено желанием единообразия в директориях поставок холокрона с одновременным нежеланием вносить частные случаи в конфигурацию брокерных поставок.

Соответствие путей ожидаемым будет провалидировано в PR-е в schema-registry.

В итоге основная директория поставки `holocron/auto/cars` будет содержать три папки:
- [raw](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/test/warehouse/holocron/auto/cars/raw) – для событий присланных в брокер
- [events](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/test/warehouse/holocron/auto/cars/events) – для событий, разложенных по дневным табличкам в соответствии с **event_timestamp**
- [eod](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/test/warehouse/holocron/auto/cars/eod) – материализованные состояния на конец дня


