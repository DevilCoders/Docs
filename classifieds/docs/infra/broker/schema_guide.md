# Рекомендации к схеме

## Требования:

 - все сообщения схематизированы в protobuf
 - схема сообщения должна быть в транке [schema-registry](https://a.yandex-team.ru/arc_vcs/classifieds/schema-registry)
 - отсутствие рекурсии: рекурсивную часть нельзя будет прочитать из protobuf-поля в YQL. Эту проверку можно явно отключить через опцию [allow_recursion](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/broker/broker_options.proto#L17).
 - сообщение должно содержать поле `timestamp` (либо поле с произвольным названием, проаннотированное как таймстамп). Тип поля должен быть `google.protobuf.Timestamp`. Поле обязательно для заполнения.
```
    //Пример проаннотированного поля c таймстампом
    google.protobuf.Timestamp event_time = 1 [(.broker.is_timestamp) = true];

```
 - имена полей верхнего уровня (которые потом станут колонками) _не _должны _начинаться _с _нижнего _подчёркивания


## Эволюция схемы

Схема должна изменяться обратно-совместимым образом. Помимо стандартных правил [Protobuf](https://developers.google.com/protocol-buffers/docs/overview) у брокера есть свои.

1) Нельзя менять тип целочисленных полей (`int32` -> `uint32`, `int32` -> `int64`).
2) При удалении поля требуется резервировать не только дескриптор, но и имя поля.
3) Нельзя менять модификаторы полей (добавлять/удалять `repeated`).

За соблюдением этих правил следит бот `anubis`.

