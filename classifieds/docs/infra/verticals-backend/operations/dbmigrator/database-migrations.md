# Как выполнить миграцию базы данных
Существует 2 типа миграций баз данных: миграция схемы и миграция данных.
- Миграция схемы данных — логика изменения схемы данных (добавление, удаление таблиц, столбцов, индексов и пр.) необходимая для добавления новой функциональной возможности в продукт.
- Миграция данных — логика изменения самих данных в таблицах.

Миграции схемы обычно выполняется достаточно быстро, кроме того, на неё завязана логика приложения, поэтому она должна быть выполнена в процессе доставки новой версии приложения. 
Миграции схемы должны быть откатываемы для того, чтобы безболезненно переключиться на предыдущую версию приложения в случае проблем.
Миграции данных зачастую занимают больше времени, чем миграции схемы. Это увеличивает время простоя при развертываниях. При больших объёмах время простоя может превысить время тайм-аута, установленного для миграций.
В связи с этим, для данных видов миграций предлагаются различные подходы.

В некоторых случаях допустимо делать миграции данных в миграциях схемы. 
В том числе, в том случае, когда это необходимо для достижения консистентности данных при запуске приложения. Например,
```
ALTER TABLE "users" ADD COLUMN "full_name" TEXT;
UPDATE "users" SET "full_name" = concat("first_name", ' ', "last_name")
```

## dbmigrator
Представляет собой обёртку над библиотекой liquibase, берёт на себя контроль номера последнего выполненного изменения структуры данных и обеспечивает прогон скриптов модификации структуры в линейном порядке, один и только один раз.
Задача решается путём накопления change-скриптов 2 видов:
- sql патчи
- кастомные миграции, написанные на языке Scala

Скрипты описываются в файле `changelog.xml` в следующем формате:
```
<changeSet id="SQL-PATCH-ID" author="author-name" context="prod,test,development">
    <sqlFile path="sql/patch-name.sql"/>
</changeSet>

<changeSet id="CUSTOM-MIGRATION-ID" author="author-name" context="prod,test,development">
    <customChange class="package.Classname" />
</changeSet>
```
В качестве id рекомендуется указывать номер тикета, под которым был добавлен скрипт.
Контекст определяет платформы, на которых будет выполнена миграция. 
Например, если требуется выполнить скрипт только на тестовом окружении, то следует указать `context="test"`.

В базе данных создаются 2 таблицы:
1. `databasechangelog` - хранит информацию обо всех успешно выполненных миграциях, предотвращает повторное применение.
2. `databasechangeloglock` - служит для блокировки процесса, чтобы предотвратить одновременное выполнение миграций несколькими инстансами приложения.

Подключение к базе данных осуществляется посредством jdbc соединения. На данный момент поддерживается PostgreSQL.
Для YDB поддержка liquibase не реализована на момент написания документа (ждём тикета [YDBREQUESTS-895](https://st.yandex-team.ru/YDBREQUESTS-895)).
Тем не менее осуществить миграцию данных в YDB можно, реализовав кастомную миграцию, используя при этом базу PostgreSQL для хранения таблицы изменений: [dbmigration][^dbmigration] в production окружении и [dbmigration-test][^dbmigration-test] в тестовом окружении.
В этом случае для каждого приложения нужно указывать отдельную схему в базе, предварительно создав её.

## Миграция схемы данных
Требуется выполнить следующие шаги:
- подключить модуль `LiquibaseScriptRunner` в существующее приложение
- добавить вызов метода `migrate()` на старте приложения
- описать миграции в файле `changelog.xml`

Запуск осуществляется автоматически при старте приложения.

## Миграция данных
Необходимо создать новый bazel модуль (если его ещё не существует для целевого приложения) и добавить его в карту-сервисов, чтобы можно было запускать миграции из UI:
- указать `common.db.migrations.app.MigratorApp` в качестве основного класса
- описать миграции в файле `changelog.xml`
- добавить релизную джобу в TeamCity
- создать [карту сервиса][^servicemap], указать тип сервиса **batch**
- добавить [манифест деплоя][^deploymanifest], делегировать требуемые секреты из [секретницы][^deploy-secret]

Запуск выполняется вручную из UI ручным запуском batch джобы. ![image](data-migrations-ui.png)


[^dbmigration]: https://yc.yandex-team.ru/folders/foo7hoq6n5qc38qul2e8/managed-postgresql/cluster/mdbqftnf3nfg6k3u6pa8
[^dbmigration-test]: https://yc.yandex-team.ru/folders/foo7hoq6n5qc38qul2e8/managed-postgresql/cluster/mdbfpuu6ae7jnbd46gmk
[^servicemap]: https://wiki.yandex-team.ru/vertis-admin/deploy/servicemap/
[^deploymanifest]: https://wiki.yandex-team.ru/vertis-admin/deploy/deploymanifest/
[^deploy-secret]: https://wiki.yandex-team.ru/vertis-admin/deploy/templates#sekrety/
