# Фича-флаги

Сервис реализует функциональность [фича-флагов](https://martinfowler.com/articles/feature-toggles.html).
Состоит из двух частей – бэкенда для работы из кода и UI, в котором можно узнать текущее значение фичей,
создать новую фичу, посмотреть историю изменений или выставить новое значение.
UI доступен на карточке сервиса в табе `Фича-флаги`, [пример](https://admin.vertis.yandex-team.ru/services/broker-controller/feature-toggles) для сервиса broker-controller.

Ожидается, что изменение фичей будет происходить через UI, а чтение из кода сервиса через API или готовый SDK.

Скоупом фичи является сервис из карты. По умолчанию сервис должен ходить только в свои фичи.
Если хочется иметь межсервисную фичу, нужно явно запрашивать фичи чужого сервиса (не гарантируется, что эта возможность останется в будущем).

## Типы данных

На данный момент поддерживаются 3 типа данных
1) строка
2) целое число
3) булевый флаг
4) В UI доступен JSON, но внутри это строка

## Клиенты

### Node.JS

TBD

### Scala

Для базельной монорепы есть [готовый клиент](https://docs.yandex-team.ru/classifieds-infra/verticals-backend/operations/feature-toggles).


## API бэкенда

* Тестинг – `feature-toggles-api-grpc.vrts-slb.test.vertis.yandex.net:80`
* Прод – `feature-toggles-api-grpc.vrts-slb.prod.vertis.yandex.net:80`

[gRPC-API](https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/feature-toggles/api.proto)

Сервис, использующий фичи, вызывает один из 3 методов – `get`, `list` или `watch`.

`get` – точечное получение текущего значения фичи. На вход принимает имя сервиса + имя фичи.
Чтобы снизить нагрузку на сервис, рекомендуется кешировать значение.

`list` – дать все фичи сервиса. Как и в случае с `get` ответ нужно кешировать.

`watch` – получение всех фичей сервиса со стримингом обновлений. Является рекомендуемым вариантом
для взаимодействия с сервисом.

Также клиент должен периодически отправлять на сервер телеметрию об использовании фичей (метод `reportTelemetry`). Это позволяет дать больше возможностей в UI:
- показывать какие фичи никем не используютя и могут быть удалены
- показывать какие сервисы используют фичу (актуально при шаринге фичей между несколькими сервисами)
- упрощать создание фичей, которые уже запрашиваются клиентом, но еще не заведены на сервере 

## ACL

На чтение фича-флаги доступны всем. На запись – только [владельцам](../service-map.md) сервиса при наличии [TVM user ticket](https://wiki.yandex-team.ru/passport/tvm2/user-ticket/).

## Grafana

Все изменения фичей (обновления/удаления) сопровождаются соответствующей Grafana-аннотацией. Найти их можно по тегам: `features`, `%имя сервиса%`, `%имя фичи%` и `%среда%`. Например, для фичи `pipeline2yt_blacklist` сервиса `broker-controller` в тестинге будет выставлена следующая аннотация:

![feature-toggle-grafana](feature-toggle-grafana.png)