# Telegram bot

Здесь представлена полная документация для управления деплоем через telegram-бот [\@vertis_shiva_bot](https://t.me/vertis_shiva_bot).

## Базовые команды

### /help

Базовые примеры использования команд и ссылка на данную документацию.

### /run

Команда для запуска/обновления сервиса. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md)

#### Опции
|<font color="red"> \*</font>| флаг | описание | может потворяться | значение | пример |
|---|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой |  | `test|prod`|  `-l test` |
| | -v | версия приложения и docker image (если не указывается, то берется текущая версия)  | | string(128)  | `-v tc20191004.143823` |
|   | -b | Имя бранча. В качестве разделителя `-`  | | string (16)  | `-b branch-name` |
|   | -t | Включить наливание 1% общего трафика в branch | | | `-t` |
| SoX  | -i | Номер задачи в трекере. Результат будет записан в виде комментария. Должен быть доступ от робота https://staff.yandex-team.ru/robot-vertis-shiva    | да| issue number  | `-i VOID-185 -i VOID-186` |
|  | -с | Комментарий (будет выведен как markdown)   | | string  | `-c fix my stupid` |
|  | -f | Force deployment (поддерживается только для [type:batch](../../service-map.md#batch), [подробнее](https://st.yandex-team.ru/VOID-491)   | |  | `-f` |
|  | -сo | Добавление конфигурационного файла  | да| string  | `-co shiva/test-conf/test.yml` |
|  | -e | добавление переменной окружения  | да | string  | `-e key:value -e "key2:some value"` |

#### Переопределение конфигурации
Для бранчей возможно добавление файлов конфигурации и переменных окружения при старте. Переданное таким образом окружение может переопределять переменные из манифеста и указанных в нем файлов конфигурации. Файлы конфигурации будут применяться в порядке указания их в команде, а переменные окружения применяются в последнюю очередь.
Возможно переопределить секрет обычной переменной и наоборот (секреты имеют тот же формат, что и в манифесте, и также должны быть делегированы)
#### Примеры

- Запуск/обновление сервиса `my_service` в тесте на версиию `0.1.7`
  ``
  /run -l test -v 0.1.7 my_service
  ``

- Запуск бранча с именем `VOID-1` сервиса `my_service` в тесте с версией `1.4.5-hotfix`
  ``
  /run -l test -v 1.4.5-hotfix -b VOID-15 my_service
  ``
- Запуск/обновление SoX сервиса `my_sox_service` в проде  на версию `0.1.7`
  ``
  /run -l prod -i VOID-1 -v 0.1.7 my_sox_service
  ``

- Обновление карты/манифеста без изменения версии
  ``
  /run -l prod my_service
  ``

- Запуск бранча с добавлением переменных окружения из файла my_service и переменными key1 и  key2 со значениями value1 и value2 соответственно
  ``
  /run -l test -v 0.0.18 -b conf-override -e key1:value1 -e "key2:value 2" -co conf/my_conf.yml my_service
  ``



### /restart

Команда для рестарта сервиса. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md).
Рестарт идемпотентен, т.е. он перезапустит контейнеры с той же спекой какая и была, даже если в манифесте деплоя произошли изменения. Если надо перезапустить контейнеры с новой спекой, то надо использовать команду /run

#### Опции
|<font color="red"> \*</font>| флаг | описание | значение | пример |
|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой | `test|prod`|  `-l test` |
|   | -b | Имя бранча | string (16)  | `-b branch-name` |
|  | -с | Комментарий (будет выведен как markdown)    | string  | `-c fix my stupid` |

#### Примеры
- Перезапуск сервиса `my_service` в проде
  ``
  /restart -l prod my_service
  ``
- Перезапуск бранча `my_branch` сервиса `my_service` в тесте
  ``
  /restart -l test -b my_branch my_service
  ``

### /revert

Команда для отката сервиса. При откате будут использоваться версия, манифест и карта с предыдущей успешной выкатки. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md)

#### Опции
|<font color="red"> \*</font>| флаг | описание | значение | пример |
|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой | `test|prod`|  `-l test` |
|   | -b | Имя бранча | string (16)  | `-b branch-name` |
|  | -с | Комментарий (будет выведен как markdown)    | string  | `-c fix my stupid` |

#### Примеры
- Откат сервиса `my_service` в проде
  ``
  /revert -l prod my_service
  ``


### /stop

Команда остановки сервиса. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md)

#### Опции
|<font color="red"> \*</font>| флаг | описание | значение | пример |
|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой | `test|prod`|  `-l test` |
|   |-b | Имя бранча | string (16)  | `-b branch-name` |
|  | -с | Комментарий (будет выведен как markdown)    | string  | `-c fix my stupid` |

#### Примеры
- Остановка `my_service` в проде
  ``
  /stop -l prod my_service
  ``
- Остановка бранча `my_branch` сервиса `my_service` в тесте
  ``
  /stop -l prod -b my_branch my_service
  ``

## Второстепенные команды

### /status

Статус сервисов и бранчей в деплое
Пример:
```plain
/status grpc-echo
```
Ответ:
```plain
Status for service grpc-echo
test
-  ver:v3 by alexander-s at 2019-11-28T16:34 (map manifest)

test branches
-  branch=mybranch ver:v3 by alexander-s at 2019-12-04T13:56 (map manifest)
```

### /sub
Подписаться на обновления сервиса. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md)

#### Опции
|<font color="red"> \*</font>| флаг | описание | значение | пример |
|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой | `test\|prod`|  `-l test` |
|   | -b | Признак, что уведомления нужно получать и для бранчей | none  | `-b` |
|   | -s | Подписка на состояния. Варианты: `all` (по умолчанию), `end` (конечное состояние), `fail` (только ошибки). | `all\|end\|fail`  | `-s end` |
|   | -u | Признак, что уведомления нужно получать для типа деплоймента `UPDATE` (Автоскейлинг, возвращение инстансов после учений) | none | `-u` |

#### Примеры
- Подписаться на обновления сервиса `sub_service` в тесте
  ``
  /sub -l test my_service
  ``
- Подписаться на обновления сервиса `sub_service` в проде включая бранчи
  ``
  /sub -l prod -b my_branch my_service
  ``

### /unsub
Отменить подписку на обновления сервиса. В конце команды должно присутствовать имя сервиса из [карты сервисов](../../service-map.md)

#### Опции
|<font color="red"> \*</font>| флаг | описание | значение | пример |
|---|---|---|---|---|
| <font color="red"> \*</font> | -l |   слой | `test|prod`|  `-l test` |

#### Примеры
- Описаться от обновлений сервиса `sub_service` в тесте, включая бранчи
  ``
  /unsub -l test my_service
  ``

### /subs
Список действующих подписок для данного чата/группы

#### Примеры
```
/subs
```

### /approve_list
Вызов списка сервисов, требующих подтверждения. Требования **SoX**. В качестве результат будет список сервисов в виде кнопок для подтверждения.

#### Примеры
```
/approve_list
```

### /system_status
Вывод статуса системы (списка закрытых датацентров).

#### Примеры
```
/system_status
```

## Вспомогательные команды

Данные команды вызываются через интерфейс (button) в зависимости от контекста ранее вызванных команд.

### /cancel
Отмена запущенного процесса деплоя. Представлена в виде контекстной кнопки во время выполнения [/run](#run).

### /approve
Подверждения релиза SoX сервиса. Представлены в виде кнопки-результата команды [/approve_list](#approve_list)

### /promote
Продвижение сервиса далее по пайплайну. На данный момент поддерживается переход из теста в прод. Представлена в виде контекстной кнопки результата выполненной команды [/run](#run)
