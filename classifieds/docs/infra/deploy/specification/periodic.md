# Периодические/разовые задачи

На данной странице описаны особенности работы с периодически задачами

## Требования

1. Сервис должен соответствовать [общим правилам](../../service-preparation/service-requirements.md)
2. При успешном завершении задачи сервис должен выйди с кодом `0`

## Первый запуск

1. Создать [карту сервиса](../../service-map.md) с типом [batch](../../service-map.md#batch)
2. Создать [манифест деплоя](../../service-preparation/manifest.md) с полем [periodic](../../service-preparation/manifest.md#periodic)
3. Вызвать команду [run](../integration/telegram-bot.md#run) в [телеграмм боте](../integration/telegram-bot.md): `/run -l test -v 0.0.1 my-service`
4. Протестировать работу сразу и не ждать выполнения расписания `/run -l test -f my-service`
5. Для отслеживания работы можно [подписаться на выполнения задач](../integration/telegram-bot.md#sub) `/sub -l test my-service`. Если важен только результат, то нужно добавить параметр `-s end`. А также, если задача стартует слишком часто, то можно подписаться только на ошибки: `-s fail`
6. Для остановки расписания и текущей задачи достаточно выполнить команду `/stop -l test my-service`

## Особенности

- При запуске периодической задачи будет поднят один контейнер в случайном ДЦ. Поэтому [datacenters](../../service-preparation/manifest.md#datacenterss) и [upgrade](../../service-preparation/manifest.md#upgrade)  не поддерживается.
- Нельзя выставить API, так как для периодической задачи оно не может быть постоянно доступно. Поэтому поле [provides](../../service-map.md#provides-(api)) не поддерживается.
- Нет ограничений на время выполнения уже запущенной задачи. При этом при попытке запуска очередной задачи по расписанию она будет пропущена. Следить за этим можно через подписку `/sub -l test -s fail my-service`
- При запуске с флагом `-f` без версии, будет запущена задача с конфигурацией последнего деплоя. Чтобы обновить конфигурацию задачу и запустить ее сейчас, достаточно указать версию `/run -l test -v 0.0.1 -f my_service`
- Поле [periodic](../../service-preparation/manifest.md#periodic) может отсутствовать, но это не мешает запускать задачи самостоятельно `/run -l test -f -v version my-service`
- Наличие метрик на 81 порту (см. [monitoring](../../service-preparation/service-requirements.md#monitoring) не является обязательным и не влияет на деплой и работу сервиса. Однако если они присутствуют с них также будут собираться метрики.
- Запускаемым задачам будет выставлен hard limit. То есть она не сможет потреблять больше CPU, чем указанно в манифесте деплоя.
- Prometheus метрики, для данного типа сервиса, собираются с более высокой частотой - раз в 2 секунды (для обычных сервисов раз в 30 секунд).
- При необходимости гарантированно записать результирующую метрику нужно сделать time.sleep(5s) перед концом работы

## Переезд

Для того что перевезти сервис с [service](../../service-map.md#service) на [batch](../../service-map.md#batch), достаточно сменить тип, добавить [periodic](../../service-preparation/manifest.md#periodic) и задеплоиться через ботика.
