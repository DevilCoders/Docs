# Канареечный релиз (Canary)

Включает возможность выкладки в production через промежуточные stages с небольшим количеством трафика. Тем самым позволяет проверить работоспособность приложения на реальном трафике и найти ошибки до полного обновления.


## Включение

Для включения канареечного релиза нужно добавить следующий блок в [манифест деплоя](../../service-preparation/manifest.md#canary)

```
canary:
  promote: manual
```

## Как работает
С точки зрения работы это полноценный бранч, подробнее можно прочесть [тут](branch.md).

Канареечный релиз разделен на два этапа.

### Canary 1%
Разворачивается канареечный бранч в количестве 10% (минимум 1) от контейнеров на датацентр, указанных в [манифисте](../../service-preparation/manifest.md#datacenters). На все развернутые контейнеры сумарно подается 1% от всего реального трафика.

Для фронт приложений работает логика попадания по `cookie` и привязка по `yandexuid`.

### Canary
На этом шаге контейнеры с canary попадают под балансировку основного кластера. Это означает, что на каждый контейнер canary придется столько же трафика, сколько попадает на каждый контейнер основного кластера, что позволяет например сравнить графики контейнеров канареечного релиза новой версии с графиками контейнеров на старой.
Переключение происходит в районе нескольких секунд без повторного деплоя.

Стоит учитывать корреляцию процента трафика от количества инстансов, прописанных в [манифесте](../../service-preparation/manifest.md#datacenters). Так как при подъеме канареечного релиза количество контейнеров у работающего приложения пока не уменьшается, то трафик на каждый рабочий инстанс будет уменьшен. Данное поведение будет исправлено в VOID-1333.

datacenters (манифест) | количество канареечных инстансов | в результат получится процент трафика на канарейку
:---: | :---: | :---:
sas: 4; vla: 4| sas: 1; vla: 1| 20%
sas: 9; vla: 9| sas: 1; vla: 1| 10%
sas: 10; vla: 10| sas: 1; vla: 1| 9.1%
sas: 15; vla: 15| sas: 1; vla: 1| 6.3%
sas: 35; vla: 35| sas: 3; vla: 3| 7.9%
sas: 60; vla: 60| sas: 6; vla: 6| 9.1%
sas: 115; vla: 115| sas: 11; vla: 11| 8.7%

Для фронт приложений работает логика попадания по `cookie`, но уже не работает привязка по `yandexuid`.

## Grafana
На этапах с canary ставится соответствующая аннотация

![canary-release-grafana](canary-release-grafana.png)

Пример логов для работы с canary
https://grafana.vertis.yandex-team.ru/goto/HQV0m2PMz

![canary-metrics-grafana](canary-metrics-grafana.png)

## Полный пайплайн канареечного релиза
1. Инициируем новый деплой в прод
   **Telegram**
   Командой `/run -l prod -v 0.1.1 shiva-test-with-canary`
   **Web**
   ![canary-ui-run](canary-ui-run.png)
2. Будет запущен `Canary 1%`. Проверяем все ли хорошо и промоутим канарейку.
   **Telegram**
   ![canary-tg-canary-one-percent](canary-tg-one-percent.png)
   **Web**
   ![canary-ui-one-percent](canary-ui-one-percent.png)
4. Канарейка перейдет во второй шаг `Canary` и получит реальный трафик. Проверяем все ли хорошо и промоутим релиз в прод.
   **Telegram**
   ![canary-tg-real-traffic](canary-tg-real-traffic.png)
   **Web**
   ![canary-ui-real-traffic.png](canary-ui-real-traffic.png)
6. Запустится деплой в прод, канареечный бранч остановится.

Если на этапе проверки что-то пошло не так, то канареечный релиз можно отменить. В этом случае бранч с канарейкой будет остановлен.




