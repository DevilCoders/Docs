# Работа с ветвями (Branchs)

В Shiva есть возможность выкатить свое приложение в отдельную ветвь.
Данная возможность полезна чтобы посмотреть как работает функциональность, не мешая работе основной версии приложения.

Особенности работы:
- Количество контейнеров под ветвь фиксировано: по одному в ДЦ из списка ДЦ в [манифеста деплоя](https://a.yandex-team.ru/arcadia/classifieds/services/deploy) сервиса.
- В тестинге выдается 100 mHz CPU, вне зависимо то указанного в манифесте
- В проде выдается CPU из манифеста (для `auto_cpu` расчитанный для прода)

### TTL

TTL ветви, если не указан тикет, составляет 3 дня, иначе TTL не ставится пока не будут закрыты все связанные тикеты. После закрытия тикетов, ставится TTL в 1 день.

### Валидация имени ветви

Имя ветви может содержать только буквы, цифры и дефис. При этом нельзя использовать дефис в начале или конце имени, а также нельзя использовать два дефиса подряд.

Хорошие примеры:
- `vertisadmin-1111`
- `void-42-hotfix`

Плохие примеры, которые не пройдут валидацию:
- `-myfix-`
- `vertisadmin-1111_hotfix`
- `vertisadmin-1111--hotfix`

Бранч регистрируется как сервис в consul, по короткому доменному имени следующего вида: `<имясервиса>-<имябранча>-<имяинтерфейса>`. При этом длина этой конструкции не должна превышать 63 символа. Так же надо помнить, что у каждого сервиса есть интерфейс с именем `monitoring`
Подробнее можно посмотреть в [официальной документации nomad](https://www.nomadproject.io/docs/job-specification/service#service-parameters).

### Доступ в приложение, выкаченное в ветвь
По-умолчанию доступ осуществляется через SLB по следующему доменному имени:
`<имясервиса>-<имябранча>-<имяинтерфейса>.vrts-slb.(test|prod).vertis.yandex.net:80`

, где `имяинтерфейса` - это [provides name](https://a.yandex-team.ru/arcadia/classifieds/services/maps/grpc-echo.yml?rev=r9383240#L7) из карты сервиса.
Другой вариант - использовать доменное имя основной версии сервиса с добавлением заголовка `x-branch-name: <имябранча>`.

Часто нам нужно попасть в сервис по доменному имени, которое ведет нас в балансер\web-сервер (например Nginx) и которое отличается от доменного имени сервиса в Shiva, описанного выше. В этой ситуации заголовок позволяет работать с приложением, выкаченным в ветвь, без изменения конфигурации на входной точке балансировки. Важно чтобы заголовок нигде не перетирался по пути к сервису.
Если вдруг в заголовок `x-branch-name` передано имя несуществующей ветви, то запрос попадет в контейнеры с основной версией сервиса.

Однако, этого может быть недостаточно и нужно пустить в ветвь часть пользовательского трафика.
В этом случае, при выкладке через telegram-бота необходимо добавить опцию `-t`.
Данная опция по-умолчанию позволяет пустить ~1% запросов от трафика приходящегося на балансер основной версии сервиса.
Реализовано это через генерацию более сложной конфигурации роутов envoy. Пример такой конфигурации: https://paste.yandex-team.ru/1010814.

### Дополнительно
Для большинства сервисов такой конфигурации вполне достаточно, чтобы пользоваться ветвями и пускать в них реальный трафик, но есть нюансы: во-первых, это 1% рандомных запросов, во-вторых не всегда удобно использовать заголовок для попадания в branch.

Подобные потребности обычно нужны фронтенду и так как в качестве вышестоящего балансировщика у нас выступает Nginx, логику попадание в сервис, выкаченный в ветвь по cookie `_branch`, возможность проклейки запросов по двум последним цифрам cookie `yandexuid` мы реализовали [там](https://wiki.yandex-team.ru/vertis-admin/NGINX/branches/).
