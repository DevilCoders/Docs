# Best practices по использованию Teamcity

Эту доку мы рекомендуем всем, кто хочет начать пользоваться Teamcity для проверок и CI/CD, и тем, кто хочет улучшить уже работающие билды.

## Общая информация о Teamcity

Teamcity - инструмент для автоматизации задач, позволяющий делать пайплайны для тестов, CI и CD.

Мы используем собственный пул агентов. Их мощности (14 cpu, 42Gb RAM, 372Gb диск) полностью отдаются запущенным билдам. На одном агенте в момент времени может выполняться только один билд. На агентах установлен широкий набор пакетов, но мы настоятельно рекомендуем не завязываться на них и запускать свои сборки в докере.

Посмотреть графики загруженности тимсити-агентов, статусов билдов и очереди можно [тут](https://grafana.vertis.yandex-team.ru/d/_BCntTLmk/teamcity?orgId=1&refresh=30s).

Ниже мы собрали best practices для комфортной жизни в Teamcity.

## Жизнь в докере или локально на агенте

Лучший вариант - запускаться в докер-контейнере, из плюсов:
* docker позволяет изолировать среду выполнения (значит, проблем с правами на файлы удастся избежать 100%);
* появляется возможность контролировать настройки и переменные в окружении;
* все необходимые пакеты запекаются в образ - все точно будет работать.

Докер-контейнер без указания дополнительных опций запускается в дефолтных сетях докера, как и контейнеры, поднимаемые через `docker-compose`. При использовании docker-compose помните, что мы гарантируем корректную работу сети только для контейнеров в подсетях `10.0.0.0/8`, `192.0.0.0/8`, `172.0.0.0/8`.

Докер-образ закэшируется агентом и через несколько запусков ваш билд будет работать быстрее. Каждую ночь мы подчищаем образы старше 3 суток.

При использовании докера для запуска билда рекомендуется собрать свой докер-образ и хранить исходники в доступном месте, чтобы а) контролировать окружение и б) своевременно обновлять образ.

Жить локально на агенте (то есть не указывать контейнер для запуска) можно, но все проблемы по привозу дополнительных пакетов/переменных/настроек ложатся на ваши плечи. Дополнительно на агентов кроме текущих пакетов ничего поставляться не будет.

## Монтирование файлов

Робот, из-под которого на агенте запускаются процессы тимсити, уже авторизован в docker-registry, но иногда нужно принести дополнительные файлы при запуске докера в докере:

* `/home/robot-vertis-repo/.ssh` - монтируют для доступа ко внутренним ресурсам Яндекса и github;
* `/home/robot-vertis-repo/.docker/config.json` - при запуске докера внутри докера и возникновении такой ошибки:
    * `cat: /github/home/.docker/config.json: No such file or directory`
    * `docker: Error response from daemon: Get <ссылка на в образ в docker-registry>: no basic auth credentials.`

## Оптимизация

Для оптимизации сборок и уменьшения очередей мы рекомендуем следующие действия:

* Закапывать билды и проекты, которыми вы не пользуетесь и на которые не смотрите. Многие из них все еще продолжают запускаться в рамках настроенного CI и занимают агента на время билда.
* Запуск в докере - отличная практика, которую мы продвигаем. Полный контроль среды, кэширование образа и все необходимые пакеты - большой профит.

## CI/CD

На данный момент для CI/CD можно использовать несколько инструментов:

1. [GRPC-API](../integration/api.md)
2. [Docker-autorelease](docker-autorelease.md)

В рамках тикета [VOID-1917](https://st.yandex-team.ru/VOID-1917) будет проведена работа по созданию единого пайплайна автоматизации CI+CD.

