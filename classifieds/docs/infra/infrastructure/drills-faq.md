# Учения в Вертикалях

**Учения проводятся на регулярной основе и всегда участвует 1 дц**

[Календарь наших учений](https://calendar.yandex-team.ru/embed/week?embed&layer_ids=55907&uid=1120000000283545)
[Календарь регламентных работ](https://calendar.yandex-team.ru/embed/week?embed&layer_ids=22354&uid=1120000000283545)
[Тикет с текущими регламентными работами](https://st.yandex-team.ru/DRILLS-2)

## Зачем мы проводим учения
> Общий ответ - сделать все наши сервисы более надёжными и отказоустойчивыми. Учения — это моделирование ситуации, при которой мы теряем весь дата-центр или его часть. Такие ситуации вполне реальны: отключение электричества, перегрев серверов, пожар, потоп, обрыв оптоволокна в результате филигранных действий экскаваторщиков.

## Регламент проведения учений

1. Подготовка к учениям;
2. Проведение учений;
3. Восстановление кластеров и немного бюрократии.

### Подготовка к учениям

О надвигающихся учениях и работы вы можете через бот `vertis-announcement-bot`.

### Проведение учений

1. Переключение мастеров Teamcity/Jenkins/Rundeck;
2. Выключение деплоя;
3. Выключение load balancers пошагово: ingress, upstreams, envoy, внутренние lb с nginx;
4. Проставляется `downtime` на закрытый датацентр;
5. Закрытие HBF.

Все действия на учениях, которые происходят до HBF, повторяем до победного после починки проблем на следующий день. Этот этап гораздо дешевле, чем отключение сети в дц и не влияет на инфраструктуру и периодические процессы, поэтому его можно проводить чаще чем HBF.

[HBF](https://clubs.at.yandex-team.ru/noc/1869) (host based firewall) - агент, который управляет правилами firewall на серверах. Через него происходит закрытие датацентра. При закрытии датацентра с HBF:
1. В датацентр можно попасть из внутренней сети;
2. Внутри датацентра работает связанность между серверами;
3. Остальные датацентры не могут работать с отключенным датацентром.

Так как отключение сети через HBF - тяжелая операция, то мы коммитимся что не будем отключать сеть в дц больше 1 раза в неделю. Если HBF был запущен на неделе и нашлись сервисы, которые не пережили учения, то в следующий раз попробуем закрыться с HBF только через неделю.

### После окончания учений

1. Если у нас не получается провести учения, заводятся тикеты с тегом vertis_drills_fail. Задачи можно найти на [дашборде](https://st.yandex-team.ru/agile/board/9353), они имеют высший приоритет;
2. Все найденные проблемы оформляются тикетами и линкуются с тикетом про учения;
3. Происходит полное восстановление работоспособности инфраструктуры.

## FAQ

#### Участвует ли тестинг или дев в учениях?

Нет, учения только для прода. Но во время общеяндексовых работ - участвует и дев, и тестинг.

#### Будет ли работать деплой в прод во время учений?

Да, в открытом датацентре, если ваш сервис живет в Shiva. Если он катится через Jenkins или Conductor, деплой работать не будет, и мы рекомендуем вам переезжать в Shiva. Если закрывается VLA, деплоиться можно в SAS и наоборот. При закрытии ДЦ MAN или MYT - деплой продолжает работать и во VLA, и в SAS для всех способов деплоя.

