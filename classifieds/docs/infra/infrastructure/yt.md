# YT

[Документация сервиса](https://yt.yandex-team.ru/docs/)

[Чат вертикалей про YT/YQL](https://t.me/+UZNDpqWsAanBiURg)


## Расположение данных

Вертикали живут в одном кластере – Hahn (целиком находится в Сасово). Все данные находятся в директории [//home/verticals](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals).

Основные поддиректории:

* `.tmp` – место для хранения временных данных (кеши, промежуточные рассчеты). Периодически очищается, не стоит хранить здесь важные данные. Используйте ее вместо дефолтной `//tmp`.
* `__import` – место, куда смежники из других БЮ могут писать свои данные для использования в Вертикалях.
* `__private_export` – место, чтобы делиться чувствительной информацией с остальным Яндексом. Директория закрыта, заказывайте доступы до конкретных поддиректорий.
* `__public_export` – место, чтобы делиться нечувствительной информацией с остальным Яндексом. Директория открыта для всех на чтение.
* `_home` – домашние директории, лучше не хранить в них production-данные.
* `broker` – данные [брокера](../broker/info.md).
* директории сервисов – для каждого крупного сервиса/направления есть отдельная корневая директория. Не плодите новые без необходимости.


## Вычислительные пулы

Все операции выполняются в некотором пуле, основная задача которых – справедливое распределение ресурсов.
По умолчанию используется пул выполняющего запрос пользователя с дефолтной квотой.

## ACL

Доступы к данным и пулам можно заказать через интерфейс YT или через IDM. Подробности в [документации](https://yt.yandex-team.ru/docs/description/common/acl_manage).

* Предпочитайте групповой доступ персональному, чтобы не повторять процедуру для каждого нового члена команды. Исключение – чувствительные данные или временные доступы.
* Заказывайте минимально необходимые права. Права на запись не будут одобрены без обоснования. То же касается и ширины запроса – доступ ко всем переливкам баз также не будет одобрен.
* Прикладывайте тикет или текстовое обоснование того, зачем вам права.


## Продакшен-процессы

- Используйте [роботов](https://wiki.yandex-team.ru/tools/support/zombik/), а не личные токены.
- Используйте пул `verticals`.
- [Советы от YT](https://yt.yandex-team.ru/docs/best_practices/howtorunproduction).


## Описание операций

Работать с YT можно тремя способами:
1) используя yql-запросы
2) напрямую через API
3) через Clickhouse over YT

### YQL

[Документация](https://yql.yandex-team.ru/docs/yt/)

Основные преимущества:
 – декларативность и лаконичность
 – наличие оптимизаций запроса
 – эффективный код исполнения

Полезные прагмы:
```
PRAGMA yt.Pool = "verticals" # используем вычислительный пул вертикалей
PRAGMA yt.TmpFolder = "home/verticals/.tmp" # используем вертикальный tmp
```

YQL предоставляет несколько [интерфейсов](https://yql.yandex-team.ru/docs/yt/interfaces/jdbc) – http api, jdbc-драйвер, UI.

### API

Если выразительности YQL не хватает, можно реализовать mapper/reducer вручную и воспользоваться ими через API. В этом случае вам могут помочь [советы](https://yt.yandex-team.ru/docs/description/mr/mr_recommendations#mapreduce-vs-mapsortreduce) от команды YT.

Работать с API лучше через официальные [драйверы](https://yt.yandex-team.ru/docs/api/java/java_api) или обертки над ними. Помимо выполнения MR-операций они позволяют работать с деревом Кипариса и более гибко управлять транзакционностью.

### CHYT

Можно делать clickhouse-запросы по данным yt. Для его есть кликхаус-сервера, поднятные на вычислительном пуле yt (клика), наша клика называется 'ch_vertis'.

Запросы в ui yql-я выглядят [так](https://yql.yandex-team.ru/Operations/Ys2UfslwvT0n7xKVY90-fF_2Ck5Mml4IC5qqvS2LEtQ=).
Есть [чат](https://t.me/joinchat/DPeS0xFdpaSZoCWTYnhnnw) поддержки

## Квоты

В YT выделяют 3 квоты: число нод (узлов) в дереве Кипариса, число чанков и объем занимаемых данных.

Общая рекомендация – не пишите данные слишком мелко (таблицы на несколько мегабайт – это скорее плохо) и уплотняйте/чистите историю.
