# Пальма

## Общие сведения

Пальма – kv-сервис для хранения **справочников** (шифрованных или нет). **Справочник** – коллекция изображений, файлов, а также protobuf-сообщений одного типа.

## Сценарии использования

1) Хранение персональных данных в шифрованном виде (сканы документов, паспортные данные)
2) Хранение простых конфигов с доступом по ключу (например, шаблоны для рассылок)

{% note warning %}

Использовать Пальму как dsl для полноценной базы данных НЕ рекомендуется. Если у вас много данных, не kv-нагрузка или требуется много индексов, возьмите обычную базу данных.

Также Пальма не является полноценной контентной системой.

{% endnote %}

## Начало работы

Для начала работы необходимо

1. Создать сообщение-справочник в [schema-registry](https://github.com/YandexClassifieds/schema-registry) в формате protobuf, указав его имя.
2. Если справочник будет содержать приватную информацию, пометить его опцией `encrypted = true` и добавить свои сервисы в список авторизованных `authorized_services = [...]`. Ознакомиться со схемой шифрования можно в соответствующем [разделе](encryption.md).

Пробности в разделе про [модель справочников](model.md)

{% note warning %}

Рекурсивные сообщения не поддерживаются!

{% endnote %}

Нешифрованные proto-справочники можно смотреть/редактировать через [web-интерфейс](https://palma.vertis.yandex-team.ru)

### Примеры
Примеры справочников можно найти в [schema-registry](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/palma/samples.proto).

### Переливка данных в YT
Справочники регулярно переливаются в [YT](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/export/ydb/palma/palma).
Данные можно использовать для аналитических запросов.

## API

Тестинг доступен по адресу ``palma-api-grpc-api.vrts-slb.test.vertis.yandex.net:80``. Продакшен – ``palma-api-grpc-api.vrts-slb.prod.vertis.yandex.net:80``.
Подробнее об [авторизации и аутентификации](auth.md).

Все операции с данными попадают в [аудит-лог](changelog.md).

### Protobuf-справочники

Для справочников со значениями в формате Protobuf предусмотрено два grpc-api:
- [json версия](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/palma/dictionary_service.proto)
- [proto версия](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/palma/proto_dictionary_service.proto)

- в каждый метод передается название справочника
- вместо конкретной сущности справочника передается его сериализованное в json представление, либо протобафный Any
- в ответе также сущности справочника сериализованные в json, либо протобафный Any

Операции:
* `create` - добавляет новую сущность в справочник и добавляет ее связи. Если сущность уже существует, то бросает ошибку. Если сущностей, на которые ссылаем нет, то тоже бросаем ошибку.
* `read` - возвращает сущность справочника по ключу без подгрузки сущностей, на которые ссылаемся.
* `delete` - удаляет сущность справочника по ключу и его связи, если есть ссылки на эту сущность, то вернется ошибка.
* `update` - изменяет существующую сущность справочника, обновляя связи и нессылочные поля.
* `list` - листинг сущностей справочника с фильтром и/или сортировкой и паджинацией по указателю. По умолчанию отдаёт 50 записей, максимально за один запрос можно получить 500 записей.
* `all` - поток всех сущностей справочника.

### Шифрованные блобы

Пальма умеет хранить изображения и файлы в шифрованном виде. Работа происходит через [grpc-api](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/palma/encrypted_service.proto).

{% note warning %}

Загружать шифрованные файлы и изображения можно только в шифрованные справочники!

{% endnote %}

#### Шифрованные изображения

1. Для загрузки изображения в пальму сервис вызывает метод `putImage`.
2. Для получения изображения вызывает метод `getImage`. В ответ получает временные ссылки на прямое скачивание изображения в разных размерах.

##### Доступные алиасы

| Алиас      | Размер |
| ----------- | ----------- |
| thumbnail      | 100x100       |
| image   | 1500x1000        |
| optimize   | оптимизированная версия оригинала  

#### Шифрованные файлы

1. Для загрузки файла в пальму сервис вызывает метод `signUpload`. На выход получает временную ссылку с подписью для заливки и токен.  
2. Заливает данные через метод `PUT` напрямую по урлу из п. 1.
3. Передает токен из п.1 в метод `link`, привязывая загруженную сущность к словарю.
4. Для получения файла вызывает метод `get`. В ответ получает временную ссылку на прямое скачивание.
