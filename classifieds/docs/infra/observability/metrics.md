# Метрики

## Общие сведения

Метрики сервисов, живущих в шиве, собираются инсталляцией на стеке VictoriaMetrics (Prometheus-совместимая) и после сбора доступны для использования в observability-инструментах: в графане и джаглере.  Отправка метрик не является обязательной для всех сервисов.

Мы исповедуем pull-модель сбора метрик: скрейпер метрик узнает о вашем сервисе и о наличии ручки с метриками и в течение некоторого времени снимает метрики с сервиса.

Для случаев, когда pull-модель не подходит или не может быть использована, доступен инструмент для пуша метрик - `prometheus-pushgateway`. **Это легаси-инструмент и мы настоятельно не рекомендуем его использовать.**

Для каждого сервиса в шиве автоматически генерируется дашборд с базовыми метриками сервиса. Подробнее читайте в [документации про автогенерацию](../auto.md#grafana-dashboard).

## Как писать метрики

### Формат метрик

При необходимости отправлять метрики, они должны быть доступны на http-ручке `/metrics`, работающей по IPv6, на порту из переменной окружения [_DEPLOY_METRICS_PORT](../service-preparation/default-env.md#_deploy_metrics_port). Скрейп-интервал для метрик сервисов составляет 30s, для батч-джоб - 2s.

Метрики необходимо писать в prometheus-формате. Реализации экспорта метрик в таком формате и библиотеки для этого существуют во многих языках программирования.

Подробнее о [форматах](https://prometheus.io/docs/instrumenting/exposition_formats/) и [типах](https://prometheus.io/docs/concepts/metric_types/) метрик можно прочесть в официальной документации Prometheus. Также на сайте Prometheus представлен [список официальных и не очень библиотек-клиентов](https://prometheus.io/docs/instrumenting/clientlibs/) для вывешивания метрик.

Выбор названия метрик и лейблов к ним остаются за вами.

Метрики, экспортируемые через shiva-деплой, всегда дополняются следующими лейблами:

* `_service` - имя сервиса;
* `_layer` - environment test/prod;
* `_version` - версия сервиса в шиве;
* `_branch` (только если сервис запущен в отдельном бранче) - имя бранча;
* `_canary` (=false или =true) - является деплой canary;
* `_dc` - датацентр, в котором находится инстанс сервиса;
* `_allocation_id` - allocation id инстанса в номаде (уникальный);
* `_allocation_index` - индекс аллокейшена в рамках одного деплоя, не уникален в рамках нескольких деплоев.
* `container_ip` - ip инстанса сервиса, отправившего метрику;
* `docker_host` - физический хост, на котором запущен инстанс сервиса;
* `instance` - ip + порт инстанса сервиса, отправившего метрику.

Существует возможность отказаться от лейблов `_allocation_id`, `_version`, `container_ip`, `docker_host`, `instance` - для экспортируемой метрики необходимо добавить лейбл `_noenrich`.

Это может пригодиться, если:
* ваш сервис экспортирует слишком большое количество тайм-серий (метрика + набор лейблов), что осложняет визуализацию графиков и/или выполнение recording rules. При выключении упомянутых лейблов на каждый передеплой сервиса **не генерируется** новая тайм-серия;
* при этом вам не нужны вышеуказанные инфраструктурные лейблы.

{%  cut "deprecated-метод отправки метрик через prometheus-pushgateway" %}

{% note warning %}

Prometheus-pushgateway - компонент, позволяющий принимать метрики согласно push-модели вместо стандартной для prometheus pull-модели. Не рекомендуется к использованию, т.к. не обеспечивает отказоустойчивости: prometheus-pushgateway запущен только в 1 экземпляре.

{% endnote %}

Координаты prometheus-pushgateway:

* Prod: `http://prometheus-pushgateway-prod-int.slb.vertis.yandex.net`
* Test: `http://prometheus-pushgateway-test-int.slb.vertis.yandex.net/`

Для отправки в prometheus-pushgateway необходимо в данные запроса положить метрики в формате prometheus (см. раздел выше).

Пример отправки из bash shell:

    ```
    echo "<metric_name> <metric value>" | curl --data-binary @- {PUSHGATEWAY_ENDPOINT}/metrics/job/${JOB_NAME}/instance/${_DEPLOY_ALLOC_ID}
    ```
{% endcut %}

## Просмотр и использование метрик

Метрики могут быть использованы для:

* просмотра и построения графиков в графане;
* настройки алертов.

В данном разделе будут рассмотрены просмотр метрик и построение на их основе графиков в графане. Построение алертов по метрикам описано в разделе [Алерты](alerts.md).

Для работы с метриками используется [вертикальная графана](https://grafana.vertis.yandex-team.ru).

Просматривать метрики можно во вкладке [Explore](https://grafana.vertis.yandex-team.ru/goto/Nc9cARkVk?orgId=1). Построение графиков происходит на дашбордах, которые можно найти во вкладке `Dashboards`. В обоих случаях в качестве `Datasource` выбирается `Prometheus` или `Prometheus-testing` соответственно для метрик из прода или тестинга.

В качестве языка запросов в графане используется PromQL, о нем можно почитать в [официальной документации Prometheus](https://prometheus.io/docs/prometheus/latest/querying/basics/).

## FAQ

### Самостоятельный траблшутинг сбора метрик

Есть подозрение, что метрики вашего приложения не собираются? Предлагаем пройтись по данному чеклисту, возможно вы сможете решить проблему самостоятельно:

1. Убедитесь, что ручка `/metrics` доступна по ipv6. Http-сервера, используемые для такой ручки, иногда по дефолту используют ipv4. Рекомендуем запустить приложение локально и проверить, что метрики по ipv6 доступны.
2. Если вы уверены, что метрики доступны по ipv6, проверьте, что скрейпер видит ваш сервис как таргет для сбора метрик:
    * [в проде](https://prometheus.vertis.yandex.net/targets);
    * [в тестинге](https://prometheus-testing.vertis.yandex.net/targets).

    Если скрейпер не видит в таргетах ваш сервис - прежде всего проверьте его хелсчеки в UI консула ([прод](https://consul.vertis.yandex.net/ui/sas/services), [тест](https://consul.test.vertis.yandex.net/ui/sas/services)). Если хелсчеки флапают или сервис в консуле отсутствует - это причина, по которым метрики не скрейпятся.

    В случае, если хелсчеки на месте, но в таргетах сервиса нет, обратитесь в чат `verticals-duty` или `verticals-infra-deploy`.

4. Попробуйте снять метрики с работающего сервиса. Это можно сделать самостоятельно с помощью [h2p](../tools/h2p/quick-start.md), в тестинге это можно также сделать с помощью `curl`.

    {% cut "Пример снятия метрик с помощью curl" %}

    1. Определить IP инстанса сервиса. В UI консула ([прод](https://consul.vertis.yandex.net/ui/sas/services), [тест](https://consul.test.vertis.yandex.net/ui/sas/services)) найдите ваш сервис в списке сервисов и перейдите в окно его проверок. В проверке хелсчека будет указан ip-адрес контейнера. Альтернативный вариант - взять ip-адрес контейнера из логов из соответствующего лейбла.

    2. Выполнить`curl http://[<container_ip_address>]:81/metrics`, где `container_ip_address` - адрес контейнера сервиса.

   {% endcut %}
