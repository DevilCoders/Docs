# Quick start guide

## Подготовка
1. Поселиться и раскатываться посредством [Нового деплоя](../../deploy/quick-start.md)
2. Писать логи приложения в [json формате](logs-format.md)
3. Направить логи приложения в stdout (файлы на диске мы не используем).
4. Логи stderr рассчитаны на части системы, которым невозможно изменить формат (например: java gc log) в данном случае они будут доставлены в исходном виде построчно с `"_context":"stderr"; "_level":"ERROR"`

Если формат логов будет не соответствовать описанному, вся исходная строка будет помещена в поле `_message`, а сама лог-запись будет дополнена следующими данными: `"_context":"validation_failed", "_level":"ERROR", "validation_error": "{error message}"`, где `{error message}` &mdash; текст ошибки.

## Метрики

Посмотреть текущий статус доставки логов можно в [графане](https://grafana.vertis.yandex-team.ru/d/Nu0YzoTWz/vertis-logs)

* Поступления новых сообщений
* Дропнутых сообщений по техническим причинам или по превышению квоты:
    * `message_size_exceeded` - размер одного сообщения превышает установленный лимит
    * `size_rate_limit` - превышен поток данных на инстанс.
    * `count_rate_limit` - превышена квота на количество сообщений в секунду.
    * `buffer_overflow` - буфер драйвера переполнен
    * `connection_refused` - драйвер не смог приконнектится для передачи сообщения
    * `time_out` - Произошел тайм-аут при коннекте для передачи сообщения
    * и другие
* Не валидных сообщений
* Временной лаг между записью лог сообщения в stdout и его появлением в хранилище.

## Квота на инстанс

На каждый инстанс приложения действуют следующие ограничения:
1. 5000 строчек с логами в секунду.
2. Поток данных ≈20MB в секунду. Сейчас нет графика потока данных (изменится после [VOID-803](https://st.yandex-team.ru/VOID-803)).
3. 128KB на одну запись лога. Сообщения больше сейчас дропаются (изменится после [VOID-802](https://st.yandex-team.ru/VOID-802)).

Квоты считаются усредненными за 10 секунд, т.е. можно превысить квоту в первую секунду и поменьше использовать в последующие секунды.
При превышении квоты лог-запись дропается, а в [графике](https://wiki.yandex-team.ru/vertis-admin/logs/#m-grafiki) видна причина дропа.

## Чтение

### Горячие логи

**Особенности:**
- Clickhouse под капотом
- время жизни 14 дней
- доставка в районе секунды

**Как читать:**
- [Grafana](grafana.md)
- [YQL](yql-ch.md)

### Холодные логи

**Особенности:**
- YT под капотом
- время жизни 180 дней
- доставляются только за последние сутки (то есть логи за прошедший час в них не посмотреть)

**Как читать:**
- [YQL](yql-yt.md)

### Логи в реальном времени

Аналог `tail -f`

**Особенности:**
- LogBroker под капотом (читает данные напрямую)
- не хранит логи в прошлом
- доставляет текущий поток в реальном времени с небольшим лагом

**Как читать:**
- [Grafana](grafana.md)
- [В консоли](console.md)



