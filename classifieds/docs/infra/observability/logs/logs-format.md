# Формат логов

## Введение

Данный формат подразумевает миграционный процесс от старого формата к новому без сохранения обратной совместимости. То есть старые логи нужно самостоятельно привести к новым правилам.

### JSON
JSON заранее структурирован, что облегчает работу с логами (избегает проблему сложного парсинга). А также все современные инструменты умеют писать логи в JSON.

**Пример:**
```json
{"_level": "INFO", "_time": "2006-01-02T15:04:05.000+07:00", "_message": "base message", "custom_field": "my custom message"}
```

Весь блок JSON лога должен находиться в одной строке и не использовать перевода на новую строку (`\n`)

Поля начинающиеся с префикса `_` являются основными и описываются в этом документе. Они имеют жестко заданный формат данных. Остальные поля являются пользовательскими и могут содержать любые допустимые значения, в том числе объекты. Они будут собраны и добавлены в поле `_rest`

## Основные поля

### Логи от сервиса
Данные поля общие для всех логов. Но в зависимости от языка и других особенностей могут отсутствовать. Однако если они используется, то должны соответствовать правилам ниже. Для них будут гарантироваться быстрый поиск и агрегации в хранилищах логов.

`*` | Поле | Формат | Пример| Описание
:---: | :---: | :---: | :---:  | :---:
 _message | Произвольная строка |`No wizard detected`| Поле представляет из себя классический блок лога с произвольной информацией
_context | Произвольная строка (128 символов) |`r.y.a.w.v.r.b.WizardResultBuilderFactory`| Область действия лога. Контекст события
`*` |_time | `yyyy-MM-ddTHH:mm:ss.SSSXXX` |`2006-01-02T15:04:05.000-07:00`| Время события, RFC3339 (опционально с наносекундами)
 *d |_level | `TRACE,DEBUG,INFO,WARN,ERROR,FATAL` |`INFO`| Уровень логирования. Если не проставлено, то будет выставлено в `INFO`
 _thread | Произвольная строка (128 символов) | `178195504:wizard` | Текущий поток
 _request_id | Произвольная строка (128 символов) | `444535f9378a3dfa1b8604bc9e05a303` |Идентификатор запроса
  _time_nano | Число | `500` |Количество наносекунд. Проставляет автоматически при формировании stderr лога. Можно передать из сервиса.

### Метаданные

Логи не нужно насыщать дополнительными данными такими как сервис, хост, ip и т.п. Информация об окружении соберется автоматически и будет доступна в хранилищах логов для чтения и поиска по ней.

 `*` | Поле | Формат | Пример| Описание
:---: | :---: | :---: | :---:  | :---:
 `*` |_service | Произвольная строка | `my-service` | Имя сервиса из карты сервисов
 `*` | _layer |  `test|prod` | `test` | Слой в котором был запущен сервис
 | _version | Произвольная строка | `1.5.17` | Версия сервиса
 | _branch | Произвольная строка | `branch-name` | Ветка сервиса. Для основной - пустое значение
 | _canary | Флаг | `0` | Признак, что данный инстанс является частью канареечного релиза
 | _host | Произвольная строка | `docker-cloud-11-vla.test.vertis.yandex.net` | Хост на котором запущен сервис
 |_dc | `myt/sas/vla` | `vla` | Датацентр
 | _allocation_id | Произвольная строка | `1e7056fb-1246-95da-c5fa-4bf4dbab6429` | Идентификатор аллокейшена
 | _container_id | Произвольная строка | `144d0e59fc5c40696...36931a9ca6956f7b0` | Идентификатор контейнера

###  Технические поля
 `*` | Поле | Формат | Пример| Описание
:---: | :---: | :---: | :---:  | :---:
 `*` |_uuid | UUID | `00112233-4455-6677-8899-aabbccddeeff` | uuid строчки лога
 `*` | _rest | json структура | `_rest: {a: {b: 'c'}}` | Поле собирающее в себе все произвольные поля

`*` - обязательное поле
`*d` - если поле не будет проставлено, то ему будет присвоено дефолтное значение
