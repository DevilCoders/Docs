# Как должен выглядеть сервис

#### Envs
Конфигурация через переменные окружения.
Все, что сейчас живет в `vertis-datasources` должно перекочевать в переменные окружения или локальные настройки приложения.
В том, числе, если для конфигурации используется consul.

#### Stateless
Не расчитывать на данные на диске (в nomad ephemeral_disk).
Все сервисы должны быть stateless - мы ни в коем случае не гарантируем, что сервис при переедеплое/переезде увидит данные, которые он положил на диск.

#### Sidecar-free
Отказ от sidecar.
Мы хотим сделать деплой как можно проще. Для этого выкинуть sidecar-контейнеры по типу push-client.
Если сервису нужно отправлять логи в logbroker, то контейнер можно собрать с push-client и [запустить его вторым процессом](https://docs.docker.com/config/containers/multi-service_container/).

#### Logs
Работа с новыми логами и запись в stdout.
Старые системы логов считаются deprecated, поэтому всем, кто живет в nomad нужно переехать на новую поставку логов.
Как это сделать описано [тут](https://docs.yandex-team.ru/classifieds-infra/observability/logs/quick-start).

#### Scaling
Возможность горизонтального масштабирования.
В идеале каждый экземпляр сервиса не должен потреблять больше чем 4 ядра (12000Mhz) и 32Gb памяти, чтобы система деплоя могла использовать как можно больше ресурсов железа.
Лучше много мелких сервисов, чем мало крупных.

#### Monitoring
Если сервис отдает prometheus метрики, то сделать это он должен через http ручку `/metrics`, работающей по IPv6, на порту из переменной окружения [_DEPLOY_METRICS_PORT](default-env.md#_deploy_metrics_port).
*Метрики опциональны*

#### Healthcheck
У каждого сервиса должен быть базовый Healthcheck, работающая по IPv6, на порту из переменной окружения [_DEPLOY_METRICS_PORT](default-env.md#_deploy_metrics_port) отдающий http 200 OK на ручку `/ping`

А также каждый порт [предоставляемого api](../service-map.md#provides-(api)) должен иметь хелсчек. Хелсчеки [различаются в зависимости от протокола](../service-map.md#protocol), по которому предоставляется api.

#### Secrets
Все секреты должны быть спрятаны в [секретницу](https://yav.yandex-team.ru).
Секреты не должны храниться в репозиториях.
Деплой умеет [передавать секреты](../deploy/templates.md#sekrety) приложениям через переменные окружения, забирая их из секретницы.

#### Root

Приложение в контейнере должно запускаться от пользователя root.

#### Internet-isolated

Приложение в контейнере не должно отправлять запросы во внешний интернет. Если доступ во внешнюю сеть вам необходим - воспользуйтесь нашими прокси-серверами для отправки таких запросов. Документацию можно найти [здесь](../infrastructure/external-proxy.md)
