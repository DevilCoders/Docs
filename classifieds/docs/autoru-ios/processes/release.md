# Создание релиза 

## Задачи
На недельном планировании с менеджерами выбираются **ключевые** задачи для следующего релиза. При этом, стоит ориентироваться на недельные-двухнедельные итерации и не накидывать в один релиз много крупных задач.

Процесс:
1. Заканчиваем задачи, отдаем в тестирование по мере выполнения
2. Получаем ответ от тестирования, заводятся баги, доработки
3. Если **ключевые** задачи закрыты, при отсутствии крупных замечаний-багов создается релизная ветка.

{% note warning %}

В релизную ветку избегаем добавления крупных изменений. То же касается фич-реквестов от менеджеров и дизайна – стараемся перенести их в последующие релизы, чтобы не делать существенных изменений в коде и не затягивать релиз.

Неключевые задачи, не прошедшие QA, или требующие серьёзных доработок, после ревью следует переносить на следующую итерацию. 

{% endnote %}

## Startrek
Перед фиксацией релиза, все задачи в статусе `Ready for merge` мержатся в `trunk` и переводятся в `Ready to release`. 
1. Задачи в статусе `Resolved` / `Ready for test` переносятся в следующий релиз, для которого нужно предварительно создать новую версию.

    {% cut "Как создать новую версию" %}

    1. Перейти в раздел [Версии](https://st.yandex-team.ru/AUTORUAPPS/versions) очереди AUTORUAPPS
    2. Создать новую версию с инкрементом среднего числа для обычных релизов (9.40.0 -> 9.41.0) или последнего для хотфиксов (9.40.0 -> 9.40.1)
    3. Перейти к задачам и отфильтровать их по компоненту `iOS` и полю с нужной `Fix version`. 
    
        {% note alert %}

        В выборку не должны попадать задачи со статусом `Closed`, `Ready to release`, `Ready for merge`.

        {% endnote %}

        [По ссылке](https://st.yandex-team.ru/AUTORUAPPS/order:status:true/filter?status=10%7C21%7C97%7C6%7C4%7C2%7C27%7C1%7C17&components=25566) находится пример фильтра, но без указания `Fix version`. Обязательно укажите текущую релизную версию!
    
    4. Много раз нажать `Show more` внизу страницы, пока не будут показаны все задачи
    5. Выделить все показанные задачи
    6. Нажать `Edit fields` внизу страницы
    7. Выставить новую `Fix version` и отметить `remove original values`
    8. Нажать `Next`

    {% endcut %}
2. Вручную переносим готовые, но не вошедшие в текущую версию (в статусах `Resolved`, `Ready for QA` и др.) задачи на следующую версию.
3. Создаём два тикета: 
    - тикет на release notes ([пример](https://st.yandex-team.ru/AUTORUAPPS-16157)) 
    - релизный тикет ([пример](https://st.yandex-team.ru/AUTORUAPPS-16158)).
    
    Для этого можно воспользоваться [формой](https://st.yandex-team.ru/createTicket?queue=AUTORUAPPS&_form=85812). В результате будут сгенерированы две задачи, которые надо будет руками слинковать друг с другом:
      ![Форма создания релизного тикета](_assets/form_release.png =x300)
4. В тикет с release notes указываем ссылки на сделанные в релизе задачи, о которых мы хотим рассказать в what's new.
 
{% note tip %}

Может быть полезно зайти в [релизный чат](https://t.me/+rjff_2YlTIhhMjUy) и пингануть редактора (shablovskaya@) и менеджеров вышеупомянутых задач.

{% endnote %}

## Ветка и билд

После того, как все задачи для релиза были добавлены в trunk, создается релизная ветка. 
Имя ветки – `releases/autoru/ios/{версия}` (например, `releases/autoru/ios/13.1.0`). 
Для того, чтобы у вас была возможность пушить коммиты в релизную ветку, у вас должны быть права, выданные в IDM на префикс `releases/autoru/ios/*`.

1. Создаём ветку
2. Повышаем `MARKETING_VERSION` в `Config/Common/Project.xcconfig` и коммитим изменения 
3. На [TeamCity](https://teamcity.yandex-team.ru) выбираем конфигурацию `Build release`, нажимаем кнопку `...` рядом с `Run` и выбираем релизную ветку:
    ![Запуск из тимсити](_assets/teamcity_run.png =x300)
    
    {% note info %}

    Список веток в TeamCity обновляется с интервалом 5-10 минут.

    {% endnote %}
    
    
4. После того как сборка собралась, её номер переносим в релизный тикет.
5. Загружаем сборку в TestFlight
    1. Скачиваем [Transporter](https://apps.apple.com/ru/app/transporter/id1450874784?l=en&mt=12) и логинимся под y-t.ru AppleID
    2. Из вкладки `Artifacts` билда в TeamCity скачиваем файл `AutoRu.ipa`
    3. Переносим его в Transporter и жмём Deliver. 
    4. Сборка должна загрузиться и через какое-то (иногда, возможно, долгое время) появиться в TestFlight
    
## Авто-тесты и ручное тестирование QA

На каждый релиз мы запускаем весь имеющийся набор авто-тестов + каждый релиз проходит ручное smoke (реже regress) тестирование.

1. В TeamCity находим `Run all tests` и запускаем прогон на нужной ветке аналогично релизному билду.
2. Ждём окончания прогона и находим отчёт в [телеграм-канале](https://t.me/joinchat/VuHYebt55Pn5oARR).
3. Фиксим в релизной ветке упавшие тесты и чиним баги, найденные тестированием.

    {% note info %}

    Чтобы создать PR не в trunk, а в релизную ветку, можно воспользоваться параметром `--to` у `arc pr create`.

    {% endnote %}
    
4. Повторяем, пока баги не кончатся/тесты не позеленеют/тестирование не скажет, что можно катить в стор.
5. Заливаем содержимое релизной ветки в trunk путем cherry-pick'а отдельных коммитов или checkout'а релизной ветки в пользовательскую и последующего PR'а.

## Выкладка

{% note alert %}

Выкладка в AppStore обычно производится силами QA. Если необходимо выложить приложение самостоятельно, требуется роль App Manager и выше.

{% endnote %}

1. Заводим версию приложения в AppStore Connect: "Мои приложения" -> "Auto.ru" -> "+ версия или платформа" -> "iOS" -> вводим версию
2. Из тикета с release notes заполняем поле "Что нового в этой версии"
3. _(по необходимости)_ Обновляем скриншоты
4. Выбираем сборку из TestFlight
5. Отправляем сборку на ревью
