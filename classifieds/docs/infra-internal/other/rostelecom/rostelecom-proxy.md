# Ростелеком прокси
## Что это

Прокси для подключения к СМЭВ через криптошлюз в РТК<p>
https://st.yandex-team.ru/VERTISADMIN-27001

## Про архитектуру

Упрощенная схема подключения:

<img src="https://jing.yandex-team.ru/files/kasev/arch-overview-2.jpeg" width="1000" />
<p>

1. Сопряжение со СМЭВ происходит через криптомаршрутизатор (КШ).
2. Сам КШ мы арендуем у Ростелеком-а, располагается на collocation где-то у них на площадке.
3. Связь с КШ есть у виртуальных серверов в "виртуальном датацентре" (заказали такую услугу в облаке Ростелекома).
4. На виртуальные сервера можно попасть через виртуальный EDGE маршрутизатор с которым у нас связь по IPSec соединению (отдельное соединение для каждой из наших машинок).
5. Сами наши машинки развернуты в двух датацентрах (VLA и SAS).
6. Над машинками поднят NOC SLB

## Про сервера в нашем датацентер

Кондукторная группа: [%vertis_vprod_rt_proxy](https://c.yandex-team.ru/groups/vertis_vprod_rt_proxy)

Представляют собой lxc-контейнеры. Развернуты (на момент написания этой документации) в ДЦ SAS и ДЦ VLA (по две штуки на датацентр).

На серверах установлен nginx, который принимает запросы и проксирует их дальше на машинки в ВЦОД РТК.

Для организации связи между серверами в нашем датацентре и виртуальными серверами в ВЦОД РТК, с наших серверов до EDGE установлены IPSec соединения ( используется ПО [strongswan](https://www.strongswan.org)). Сам IPSec канал построен по IPv6 адресам, но внутри него адресация идёт по серым IPv4 адресам.

Сервера конфигурируются с помощью [ansible плейбуки](https://a.yandex-team.ru/arc_vcs/classifieds/infra/vertis-ansible/vertis_vprod_rt_proxy.yml), основная роль: [rt-proxy](https://a.yandex-team.ru/arc_vcs/classifieds/infra/vertis-ansible/roles/rt-proxy)

## Про ВЦОД

Панель управления заказом (услуги ВЦОД) в РТК [тут](https://www.cloud.rt.ru/client/orders/153565).
В ней можно посмотреть текущий статус ВЦОД (включен/выключен), а так же получить доступ к инфраструктуре ВЦОД (адрес, логин и пароль)

Прямая ссылка на доступ к инфраструктуре: [https://vcd6.vdcportal.ru/tenant/org_153565/vdcs](https://vcd6.vdcportal.ru/tenant/org_153565/vdcs)

Инфраструктура ВЦОД представляет собой два датацентра.
В первом датацентре настраивается Edge Gateway и всё что связано с сетью: маршрутизация, пулы IPv4 и IPv6 сетей, адреса ДНС серверов, фаервол  и настройки для IPsec соединений с EDGE. Пулы IPv4/Ipv6 сетей из этого датацентра расшариваются и используются во втором.
Во втором датацентре создаются и настраиваются виртуальные сервера, их характеристики и affinity правила.

На момент написания, во втором ДЦ поднято два виртуальных сервера с характеристиками:
* Virtual CPUs: 4
* Cores per socket: 1
* Memory: 8Gb
* HD: 50Gb
* Operating System: Ubuntu Linux(64 bit)

К каждому виртуальному серверу подключено два сетевых интерфейса (тип адаптера: VMXNET3), один с серой IPv4 сетью (название сети: vertisnet), второй - с IPv6 сетью (название сети: ip_v6).

На фаерволе разрешен трафик с источником - IPv6 сеть, приёмник - любой (правило необходимо для установки deb пакетов с официальных репозиториев)

## Про криптошлюз

Криптошлюз представляет собой программный комплекс на аппаратной платформе S-terra G-7000-ST-KC3. Арендуется у РТК и располагается у них же на collocation. Физического доступа у нас к нему нет, все настройки производятся инженерами РТК.

## Дополнительно

[Howto по работе с ВЦОД](howto.md)
[Про IPSec ](ipsec.md)

[Графики](https://grafana.vertis.yandex-team.ru/d/ypf_Sndnz/rt-proxy)

