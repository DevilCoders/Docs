# Учения в Вертикалях

**Учения проводятся на регулярной основе и всегда участвует 1 дц**

[Календарь наших учений](https://calendar.yandex-team.ru/embed/week?embed&layer_ids=55907&uid=1120000000283545)
[Календарь регламентных работ](https://calendar.yandex-team.ru/embed/week?embed&layer_ids=22354&uid=1120000000283545)
[Тикет с текущими регламентными работами](https://st.yandex-team.ru/DRILLS-2)

Вся информация о учениях отмечается в сервисе `infra.yandex-team.ru` в namespace Verticals. Информация об общеяндексовых регламентных работах тоже есть в `infra.yandex-team.ru`.

Все тикеты про учения маркируются тегом vertis-drills  в очереди `VERTISADMIN`. Анонсы о работах пишутся в `vertis-announcement-bot` с указанием тикета, события в инфре и таймлайна. Сообщения о ходе работ отправляются в чат координации учений [verticals-tech-warroom](https://t.me/joinchat/AjIsiRnjgfZXiNKgednCgQ).

## Зачем мы проводим учения
> Общий ответ - сделать все наши сервисы более надёжными и отказоустойчивыми. Учения — это моделирование ситуации, при которой мы теряем весь дата-центр или его часть. Такие ситуации вполне реальны: отключение электричества, перегрев серверов, пожар, потоп, обрыв оптоволокна в результате филигранных действий экскаваторщиков.

## Регламент проведения учений

1. Подготовка к учениям;
2. Проведение учений;
3. Восстановление кластеров и немного бюрократии.

### Предподготовка

На этом шаге необходимо:
* За день до проведения учений написать анонс в `vertis-announcement-bot`, переслать сообщение в чаты `verticals-duty`, `verticals-tech-warroom`. Сделать то же самое за час-полчаса до начала учений.
* Создать тикет в очереди VERTISADMIN с компонентой `drills`, в качестве исполнителя проставить себя.
    * В заголовке - день проведения учений/работ и название датацентра.
    * В описании необходимо указать таймлайн работ и ссылку на событие в инфре (см. следующий пункт)
* Создать событие в `infra.yandex-team.ru` в namespace Verticals.

### Проведение учений

1. Переключение мастеров Teamcity/Jenkins/Rundeck. [Смотрим](https://grafana.vertis.yandex-team.ru/d/I1-gRG8Zk/drills-overview?orgId=1&refresh=1m), где находятся мастера, под катом `Admin services status`.
2. В зависимости от того Вертикальные это учения или общие учения (регламентные работы) и локации проведения выбираем следующее действие:
   * если учения в **MAN** или **MYT**, то достаточно проставить DT командой `drills-helper dt 2h -l prod -d <dc>`  и закрыть HBF: `drills-helper hbf start 1h45m -d <dc> -i <issue>`;
   * если вертикальные учения в **SAS** или **VLA**, то запускаем пайплайн командой `drills-helper p c -d <dc> -t 2h -i <issue>`;
   * если общие яндексовые учения или регламентные работы в **SAS** или **VLA**, то запускаем пайплайн с дополнительной опцией `-a` командой `drills-helper p c -d <dc> -t 2h -i <issue> -a`.

[Подробнее про drills-helper](https://docs.yandex-team.ru/classifieds-ops-internal/duty/drills-helper)

Если что-то пошло не так, можно воспользоваться [старым способом закрытия ДЦ](https://docs.yandex-team.ru/classifieds-ops-internal/duty/close-dc-old).

Все действия, которые происходят до HBF, повторяем до победного после починки проблем на следующий день. Этот этап гораздо дешевле, чем отключение сети в дц и не влияет на инфраструктуру и периодические процессы, поэтому его можно проводить чаще чем HBF.

[HBF](https://clubs.at.yandex-team.ru/noc/1869) (host based firewall) - агент, который управляет правилами firewall на серверах. Через него происходит закрытие датацентра. При закрытии датацентра с HBF:
1. В датацентр можно попасть из внутренней сети;
2. Внутри датацентра работает связанность между серверами;
3. Остальные датацентры не могут работать с отключенным датацентром.

Как закрывать датацентр hbf в ручном режиме не через `drills-helper` описано [тут](https://docs.yandex-team.ru/classifieds-ops-internal/duty/hbf-close-open).

Так как отключение сети через HBF - тяжелая операция, то мы коммитимся что не будем отключать сеть в дц больше 1 раза в неделю. Если HBF был запущен на неделе и нашлись сервисы, которые не пережили учения, то в следующий раз попробуем закрыться с HBF только через неделю.

Так как кластер hadoop живет в одном датацентре MYT, он исключается из учений. Так как смысла нет - он просто не будет работать.

### После окончания учений
1. Открываем ДЦ, например, так: `drills-helper pipeline open -d <dc>`
2. Если у нас не получается провести учения, заводятся тикеты с тегом vertis_drills_fail. Задачи можно найти на [дашборде](https://st.yandex-team.ru/agile/board/9353), они имеют высший приоритет;
3. Все найденные проблемы оформляются тикетами и линкуются с тикетом про учения;
4. Заполняется [форма](https://forms.yandex-team.ru/surveys/46647/?abc_service=verticals);
5. Восстановление couchbase в случае срабатывания failover описано [здесь](https://wiki.yandex-team.ru/vertis-admin/storage/couchbase/#uchenija);

