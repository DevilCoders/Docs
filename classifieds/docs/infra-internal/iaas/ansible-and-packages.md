# Работа с vertis-ansible и vertis-packages

В рамках Группы эксплуатации есть определенные договоренности о том, как катить конфиги для ansible и раскатывать пакеты с минимальным риском для инфраструктуры. Эти рекомендации описаны ниже.

## Vertis-ansible

Все изменения, которые вмержены в trunk для репозитория `vertis-ansible` подхватываются автоматикой (ansible-pull) и будут доставлены на сервера в течение 15-20 минут. Таски, помеченные `when: ansible_pull is not defined` на серверах автоматически выполняться не будут, но будут работать в ручном режиме.

Синтаксические ошибки, встречающиеся в плейбуках, могут привести к падению прогона `ansible-pull`, поэтому настоятельно рекомендуется проверять вносимые изменения руками с ограничением 1-2 сервера.

Мы используем следующий порядок раскатки изменений:
* проверка в ручном режиме - отлавливаем ошибки в плейбуках и проверяем, что все отрабатывает;
* раскатываем соответствующие изменения в тестинге;
* только после успешной раскатки автоматикой в тестинге катим в прод.

Версии пакетов, которые привозятся средствами `ansible`, мы фиксируем в плейбуках, чтобы не было расхождений на серверах и чтобы случайно не получить версии пакетов с уязвимостями.

Также мы коммитимся на том, что **в пятницу вечером мы ничего потенциально взрывоопасного не катим в прод и контролируем процесс раскатки изменений**.

## Vertis-packages

Подробнее о том, как собирать и раскатывать пакеты описано в [документации про сборку пакетов](building-packages.md).

Политика раскатки пакетов аналогична репозиторию `vertis-ansible`: сначала катим в тестинг, затем в прод.

При этом, для раскатки в тестинг собираем новую версию пакета из бранча - так будет проще откатиться, если что-то пошло не так.

После сборки пакета из мастера, раскатываем его в тестинг и в прод.

Пакеты в тестинге какое-то время "маринуются": от часа до нескольких дней.

Также мы коммитимся на том, что **в пятницу вечером мы ничего потенциально взрывоопасного не катим в прод и контролируем процесс раскатки изменений**.
