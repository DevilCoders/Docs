# Сборка пакетов

Исходники пакетов, собираемых вертикальными админами, находятся в [Аркадии](https://a.yandex-team.ru/arcadia/classifieds/infra/vertis-packages).

* Если вы собираете пакет, который а) поддерживается яндексом и б) будет иметь такое же название, и это разовая история - его нужно самостоятельно собрать руками и положить в наш дист (хранилище пакетов);
* Если вы собираете новый пакет для вертикалей - его исходники необходимо будет добавить в репозиторий и создать для него сборку в тимсити по аналогии с другими пакетами;
* Если необходимый пакет уже лежит в репозитории, то мы работаем с ними и руками их не собираем.

Ниже описаны инструкции как собрать такие типы пакетов, запушить их на дист и как с ними работать после сборки.

## Сборка пакетов из vertis-packages в teamcity (предпочтительный способ)

Вертикальные пакеты собираются в [тимсити](https://t.vertis.yandex-team.ru/), благодаря этому их не нужно собирать руками. Там настроен автоматический changelog и пуш в дист, поэтому никакой дополнительной магии не потребуется.

Проект сборки в тимсити имеет те же названия, что и пакеты, поэтому найти его довольно просто по фильтру в `Projects`. Если в проекте есть две сборки (`Build` и `packagename`), то нужная сборка - `Build`.

Если сборки нужного вам пакета в vertis-packages нет или вы добавляете новый, то можно подсмотреть настройки сборки соседнего пакета и накликать аналогичную.

Для пакетов конфигов nginx настроена автоматическая сборка на PR, новые коммиты в PR и на пуш в транк - она запускается в течение нескольких минут. Последняя версия пакета автоматически подтягивается в PR под проверками аркадии, версия из бранча оканчивается на `pr-*`. Версию пакета, собранного из транка, необходимо посмотреть в тимсити.

Для остальных пакетов автосборки нет, чтобы не захламлять дист, поэтому для сборки нужно будет нажать кнопку в тимсити. Для сборки из бранча нужно в фильтре по бранчам ввести номер PR, для сборки из транка - выбрать default бранч (транк).

## Сборка пакета руками и загрузка его в вертикальный дист

Для сборки пакетов можно использовать dev-виртуалку или tc-агента. Настоятельно не рекомендую собирать пакеты на своих десктопах.

Вам необходимо сгенерировать пару gpg ключей (открытый/закрытый), т.к. все наши пакеты должны быть подписаны. Неподписанные пакеты не примут в наши репозитории, если у Вас уже есть сгенеренные ключи, переходите сразу к пункту 7.

1. Запускаем команду:

    `gpg --gen-key`

2. Отвечаем на вопросы gpg про типы ключей и их длину. Тип ключа - `RSA`, длина - 2048 ([пояснение](https://st.yandex-team.ru/RUNTIMECLOUD-6924), почему именно так);

3. В поле `Real name:` вводим свои имя и фамилию латиницей ровно так, как потом Вы будете писать их в changelog'е пакетов. Например: `Ivan Petrov`;

4. В поле `Email address:` вводим свой корпоративный email. Например: `ipetrov@yandex-team.ru`;

5. Поле "Comment:" можно оставить пустым, далее жмём: `O(kay)`;

6. Вводим пасс-фразу от ключа (нужно будет вводить при каждой подписи пакета). После этого начнётся генерация ключей, это может занять до 10 минут;

7. После того как ключ сгенерился, вам нужно загрузить ваш публичный gpg ключ на [стафф](https://staff.yandex-team.ru):

    `gpg --export --armor`

    **Внимание, забэкапьте директорию .gnupg куда-нибудь, бэкап Вам пригодится в случае краха сборочного сервера**

8. Откройте Ваш `.bashrc` и добавьте туда следующие строки:

    ```
    export DEBFULLNAME='Ivan Petrov'
    export DEBEMAIL='ipetrov@yandex-team.ru'
    alias dupload='dupload --nomail'
    alias dch='dch --no-auto-nmu'
    alias debuild='debuild --no-tgz-check'
    ```

    **Внимание, переменные `DEBFULLNAME` и `DEBEMAIL` должны содержать ровно такие значения, которые Вы вводили при генерации gpg-ключей с точностью до символа, иначе подпись пакета будет завершаться с ошибкой**

9. Создайте в Вашей домашней директории файл `.dupload.conf`, это файл настройки для утилиты `dupload` - (утилита закачки пакетов в репозитории) следующего содержания:

   {% cut "Содержание .dupload.conf" %}

   ```
    package config;

    $default_host = "yvc";

    $cfg{'yvc'} = {
        fqdn => "yandex-vertis-common.dupload.dist.yandex.ru",
        method => "scpb",
        incoming => "/repo/yandex-vertis-common/mini-dinstall/incoming/",
        dinstall_runs => 0,
    };

    $cfg{'yvx'} = {
        fqdn => "yandex-vertis-xenial.dupload.dist.yandex.ru",
        method => "scpb",
        incoming => "/repo/yandex-vertis-xenial/mini-dinstall/incoming/",
        dinstall_runs => 0,
    };

   $cfg{'yvf'} = {
       fqdn => "yandex-vertis-focal.dupload.dist.yandex.ru",
       method => "scpb",
       incoming => "/repo/yandex-vertis-focal/mini-dinstall/incoming/",
       dinstall_runs => 0,
   };
    ```

   {% endcut %}

   {% cut "Подробнее о репозиториях из .dupload.conf" %}

    У Вертикалей есть несколько репозиториев:
        * `yandex-vertis-common`: в этот репозиторий помещаются пакеты, которые НЕ зависят от версии Ubuntu. В таких пакетах могут содержаться, например, конфиги, скрипты на python/perl/shell, и прочие вещи, которые подходят для всех версий Ubuntu. Возможно статически собранные бинари, но с ними осторожно. Ни в коем случае не заливайте туда пакеты, которые работают только на каких-то конкретных версиях Ubuntu;
        * `yandex-vertis-xenial`: в этот репозиторий помещаются пакеты, работающие только на Ubuntu Xenial (16.04);
        * `yandex-vertis-focal`: в этот репозиторий помещаются пакеты, работающие только на Ubuntu Focal (20.04).

    Эти репозитории перечислены в нашем .dupload.conf.

    Утилита dupload при запуске ищет в текущей директории файлы с уже собранными пакетами (файл `%mypackage%.changes`), в котором перечислены все файлы c md5-суммами, которые необходимо закачать в репозиторий. Если утилите dupload не передать никаких параметров командной строки, то она закачивает найденные пакеты в репозиторий по-умолчанию. Репозиторием по-умолчанию является имя репозитория, взятое из переменной $default_host, из файла /.dupload.conf. В нашем случае, пакетики закачаются в репозиторий `yandex-vertis-common`.

    Если Вам необходимо залить пакеты, например, в репозиторий `yandex-vertis-xenial`, то Вам необходимо запустить команду `dupload --to yvx`.

    {% endcut %}

10. Установить `tools` для сборки: `sudo apt install devscripts dupload equivs build-essential`

11. В целом сборка сводится к запуску 3х команд в каталоге распакованном после команды **apt-get source pkgname**:
    ```
    mk-build-deps -i # создаст list сорцов для сборки пакета и установит их
    dch -i # обертка для changelog
    debuild --force-sign # непосредственно сборка
    dupload --to XXX # заливка в репозиторий
    ```

    Поле заливки в репозиторий на индексацию dist требуется время (Можно ускорить с помощью `apt-get update`).

12. Если необходимо закоммитить исходники Вашего пакета в репозиторий, то складываем их в [vertis-packages](https://a.yandex-team.ru/arcadia/classifieds/infra/vertis-packages)

**Внимание! Не закачивайте собранные бинарные пакеты в аркадию. Там должны лежать только исходники!**

## Как мы собираем и раскатываем пакеты на кластера

{% note warning %}

Не забывайте подтягивать `trunk` перед работой с `vertis-packages`. Это **особенно важно** при работе с пакетами конфигов для nginx.

{% endnote %}

1. В [vertis-packages](https://a.yandex-team.ru/arcadia/classifieds/infra/vertis-packages) создаем свою ветку и вносим необходимые изменения в нужный пакет, делаем PR;

2. Собираем пакет из бранча - автосборкой или нажатием кнопки;

3. С этой версией пакета уже можно экспериментировать - поставить на виртуалке или на тачке в тестинге (например, на docker-хосте), предварительно выключив AP, чтобы он не перетер изменения.  Когда эксперименты проведены - необходимо вернуть AP. **Если эксперименты прошли неуспешно, то снова сделать изменения в пакет и вернуться к п. 2**;

4. Если эксперименты прошли успешно - фиксируем версию в `vertis-ansible`, но только для серверов в тестинге. Если это пакет из роли `common-packages`, то коммитим новую версию в `nonprod`-плейбуке, дальше пакет раскатится на сервера. Если пакет используется в других ролях - аккуратно разводим task так, чтобы новая версия попала только в тестинг. Оставляем мариноваться на некоторое время, чтобы убедиться в отсутствии проблем;

5. Когда пакет с версией из бранча помариновался (зависит от критичности изменений - от пары часов до +inf) - можем катить дальше. Для этого мержим правки в `vertis-packages`, собираем пакет из транка.

6. Новую версию пакета из транка коммитим в `vertis-ansible` для сначала в `nonprod`, раскатываем. После раскатки - обновляем версию в `prod`.
