# Kafka на "железе" (legacy)

Здесь описаны "старые" кластеры Kafka на "железе". В настоящее время взят курс на переезд на mdb-кафку, поэтому "железные" кластера считаются deprecated, новые топики на них не селим.

## Архитектура
Используемая версия Kafka: 2.3.1
Для работы используются внешние общие кластера Zookeeper ("старые" кластера на момент написания страницы).

### Тестинг

Хосты:
```
%vertis_vtest_kafka
```

Веб-морда:
[http://kafka-01-myt.test.vertis.yandex.net:9000](http://kafka-01-myt.test.vertis.yandex.net:9000)
[http://kafka-01-vla.test.vertis.yandex.net:9000](http://kafka-01-vla.test.vertis.yandex.net:9000)
[http://kafka-01-sas.test.vertis.yandex.net:9000](http://kafka-01-sas.test.vertis.yandex.net:9000)
(можно использовать любой из перечисленных)

Один общий кластер, всего 3 хоста-брокера, по одному в ДЦ: sas, vla, myt.
Брокеры поселены в lxc-контейнеры.
Типично у топика RF (replica factor) равен 3, min ISR (in-sync replicas) - 2. Это означает, что каждая партиция реплицируется во все ДЦ (на каждого брокера), при этом запись разрешается, если хотя бы 2 из 3 брокеров доступны.

### Прод

Хосты:
```%vertis_prod_kafka
%vertis_vprod_kafka
```
Веб-морда:
[http://kafka-01-sas.prod.vertis.yandex.net:9000](http://kafka-01-sas.prod.vertis.yandex.net:9000)
[http://kafka-01-myt.prod.vertis.yandex.net:9000](http://kafka-01-myt.prod.vertis.yandex.net:9000)
[http://kafka-03-vla.prod.vertis.yandex.net:9000](http://kafka-03-vla.prod.vertis.yandex.net:9000)
(можно использовать любой из перечисленных, доступ только у Эксплуатации)

Один общий кластер, но условно разделённый на 2 сегмента: `default` и `hl`.
В кластере по 4 хоста в ДЦ: sas, vla, myt; итого 12 брокеров. Поселены на "железные" серверы, за исключением двух брокеров во vla в сегменте `hl` - они живут в lxc-контейнерах.

Первые 2 хоста (01, 02) в ДЦ отнесены к сегменту `default`, следующие 2 хоста в ДЦ (03, 04) - к сегменту `hl`.

Разделение на сементы сделано для минимазации негативного влияния нагрузки на топики при интенсивном "догоне" непликации: после учений/регламентных работ, или после недоступности какого-либо брокера.
Условно, в сегмент `default` селится абсолютное большинство топиков, небольших по размеру, и с небольшой нагрузкой.
В сегмент `hl` отселены всего несколько топиков, больших по размеру (больше всех топиков в сегменте `default` вместе взятых) создающих значительную нагрузку на кластер в вышеуказанных ситуациях.
Таким образом, условный выход из учений больше не приводит к продолжительным проблемам у большинства потребителей, когда догон репликации всего нескольких самых "жирных" топиков мешают нормальной работе всего кластера, и большинства топиков в частности.

Для равномерного распределения партиций топика по брокерам внутри сегмента используется механизм rack awareness.
Для поселения же топика в конкретный сегмент используется скрипт в Rundeck, который после создания топика производит перераспределение партиций через утилиты `kafka-assignment-generator.sh`, `kafka-reassign-partitions.sh` из пакета поставки Kafka.

Типично у топика RF (replica factor) равен 3, min ISR (in-sync replicas) - 2. Это означает, что реплика каждого топика есть в каждом ДЦ на одном из брокеров в сегменте, при этом запись разрешается, если хотя бы 2 из 3 брокеров доступны.

## Управление топиками
Для управления топиками (создание, увеличение количества партиций) созданы соответствующие джобы в Rundeck.

Тестинг:
[Create topic](https://rundeck.vertis.yandex.net/project/sandbox/job/show/0abee80b-1401-4f68-97c4-1c2fb9c64456)
[Alter topic partitions count](https://rundeck.vertis.yandex.net/project/sandbox/job/show/6dd4c0c2-ed5d-497f-a34c-f4e3957c6edf)

Прод:
[Create topic](https://rundeck.vertis.yandex.net/project/sandbox/job/show/3adf9eb6-3a52-4c68-b036-9a982cfb3b9b)
[Alter topic partitions count](https://rundeck.vertis.yandex.net/project/sandbox/job/show/380b94a2-58d0-40e7-8bcc-9382ae5c721c)

Для создания топика необходимо знать 2 обязательных параметра: имя топика и количество партиций. Их сообщает заказчик топика.
В форме создания топика так же есть дополнительные поля, где, например, можно переопределить значение RF или min ISR, а так же указать какие-либо дополнительные параметры в поле `Additional options`, однако в большинстве случаев всё это не требуется и остаётся по умолчанию.

Управлять топиками можно в том числе и через веб-морду (см. ссылки в разделе [Архитектура](#arhitektura)), однако в проде создавать или изменять количество партиций рекомендуется исключительно через Rundeck, т.к. веб-морда ничего не знает про rack awareness и деление на сегменты, и в результате она поселит партиции рандомным образом.
Для тестинга это не критично, т.к. там нет rack awareness и разделения на сегменты, поэтому в тестинге можно пользоваться веб-мордой.

**После создания топик надо добавить в [список](https://wiki.yandex-team.ru/vertis-admin/kafka/topics/)!**

## Графики, алерты
[Дашборд с графиками](https://grafana.vertis.yandex-team.ru/d/000000589/kafka)
[Алерты](https://a.yandex-team.ru/arc_vcs/classifieds/infra/prometheus-config/production/alerts/vertis-kafka.rules.yml)
