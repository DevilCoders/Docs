# Jenkins
## Описание
Адрес сервиса: [https://j.vertis.yandex-team.ru/](https://j.vertis.yandex-team.ru/)

Используется для инициации деплоев по "старой" схеме (до shiva).

## Деплой
Сервис живёт в проде на lxc, кондукторная группа `%vertis_vprod_jenkins_deploy`.
Наливается плейбукой `vertis_vprod_jenkins_deploy.yml`, роль `jenkins-deploy`.
Ставится пакетом jenkins, который скачивается из нашего S3.

## Особенности
Конфигурация сервиса, данные, конфигурации джоб - всё это хранится на файловой системе в рабочей директории `/var/lib/jenkins/`. Никакие БД не используются.

## Отказоустойчивость, репликация
Настоящей отказоустойчивости нет, используется ручной фейловер: сервис в каждый момент времени должен выполняться только на одном из двух серверов во избежание split brain. Есть мониторинг на количество одновременно запущенных инстансов, зажигается если их != 1.
Переключение в другой ДЦ (например, при учениях) производится вручную, см.  [ниже](#pereklyuchenie-v-drugoj-dc).

Репликация осуществляется через синхронизацию рабочей директории, для этого написан скрипт `jenkins-filesync.sh`, который выполняется по крону.
Есть monrun-чек `jenkins-filesync`, проверяющий, что последняя синхронизация была выполнена без ошибок, не очень давно, и заняла не слишком много времени.
Перед запуском скрипт синхронизации выполняет несколько проверок: смотрим, что размер стораджа с последней синхронизации изменился не более, чем на 10% (защита от затирания стораджа пустой директорией), что в данный момент выполняется сам Jenkins (синхронизируем только с активного сервера на неактивный).
Скрипт пишет лог выполнения: `/var/log/jenkins-filesync/jenkins-filesync.log`
В скрипте предусмотрены ключи:
  - `-v`: пишем сообщения не только в лог, но и в консоль
  - `-f`: пропускаем проверки

## Переключение в другой ДЦ
Основной способ переключения - через `drills-helper`, который, в свою очередь, выполняет скрипт `/usr/bin/switch-master.sh`.
Если что-то идёт не так, то переключение можно выполнить вручную. Для этого:
  - останавливаем сервис на старом сервере:
    ```
    service jenkins stop
    ```
  - выполняем финальную синхронизацию рабочей директории:
    ```
    jenkins-filesync.sh -v -f
    ```
    Если скрипт падает с сообщением *"According status file and rsync process running sync is in progress. Exiting."*, смотрим его лог. Если в данный момент действительно выполняется периодическая синхронизация, дожидаемся её завершения, после чего снова пробуем выполнить финальную синхронизацию.
  - запускаем сервис на новом сервере:
    ```
    service jenkins start
    ```


## Бэкапы
Бэкапы выполняются путём архивирования рабочей директории ```/var/lib/jenkins``` с последующей загрузкой в S3.

Джоба, которая по расписанию раз в сутки пакует, криптует, выливает в S3, а так же удаляет старые бэкапы (скрипт описан в самой джобе):
[https://j.vertis.yandex-team.ru/job/Utils/job/jenkins%20backup%20to%20s3/](https://j.vertis.yandex-team.ru/job/Utils/job/jenkins%20backup%20to%20s3/)
Бэкапы заливаются в S3-бакет `vertis-backups`, в директорию `prod/jenkins/`. Храним последние 7 штук, по одному бэкапу в сутки.

### Восстановление бэкапа
Скачиваем файл бэкапа:
```wget http://s3.mds.yandex.net/vertis-backups/prod/jenkins/j-backup-2021-08-28-13-50.tar.gz.enc```

Расшифровываем и распаковываем::
```
openssl aes-128-cbc -d -k ${ENCRYPT_PASSWORD} -salt -in j-backup-2021-08-28-13-50.tar.gz.enc | tar -xf - -C /var/lib/jenkins
```
В случае, если из бэкапа нужно лишь достать что-то отдельное вместо замещения им текущей инсталляции Jenkins, то нужно указать, соответственно, другую директорию вместо ```/var/lib/jenkins```.

Пароль для расшифровки брать в [секрете](https://yav.yandex-team.ru/secret/sec-01dcp21zy6aapzzw3bmc8vr6aw/explore/versions).
