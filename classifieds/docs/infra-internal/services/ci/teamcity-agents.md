# Teamcity-agents

## Общая информация

У нас есть [дашборд](https://grafana.vertis.yandex-team.ru/d/_BCntTLmk/teamcity?orgId=1&refresh=30s) в графане, который отражает всю статистику по тимсити-агентам и билдам: количество свободных и занятых агентов, количество запущенных билдов и количество билдов в очереди.
Метрики в графану перекладываются сервисом [teamcity-metrics](https://a.yandex-team.ru/arc_vcs/classifieds/infra/teamcity-metrics), который живет в шиве. Статистику собираем, обращаясь к нашему teamcity-серверу.

Кондукторная группа: `vertis_vdev_tc_cloud`

FQDN: `tc-cloud-<index>-<dc>.dev.vertis.yandex.net`

## Управление кластером

Тимсити-агенты живут в Яндекс Облаке в инстанс-группах.
Конфигурируются через terraform с помощью [конфига](https://bb.yandex-team.ru/projects/YANDEX-CLASSIFIEDS/repos/terraform/browse/compute/vertis_vdev_tc_cloud/vertis_vdev_tc_cloud.tf).

## Наливка тимсити-агентов

1. Изменяется количество хостов в конфигах терраформа, изменения применяются;
2. На хост приезжает AP и прогоняет [кластерную плейбуку](https://a.yandex-team.ru/arc_vcs/classifieds/infra/vertis-ansible/vertis_vdev_tc_cloud.yml).
3. В базовом случае AP привезет все необходимые файлы для старта процесса тимсити-агента и systemd, который запустит процесс агента и вставит агента в пул. Плейбука и кластерная роль написаны так, чтобы была возможность катать там AP и избежать ручной наливки. Версии пакетов для нужд разработки зафиксированы.

Хосты должны нормально переживать reboot, удаление и создание - для этого была написана обвязка `tc-mngr.sh` + systemd `teamcity-agent`.

Из [tc-mngr.sh](https://a.yandex-team.ru/arc_vcs/classifieds/infra/vertis-ansible/roles/teamcity-agent-cloud/files/usr/local/bin/tc-mngr.sh) можно управлять состоянием агентом вручную. Доступны следующие действия:
* `tc-mngr.sh --run` - запустить агента. Запустится агентский процесс и агент будет авторизован на сервере. Он автоматически встанет в пул агентов;
* `tc-mngr.sh --stop` - остановить агента. Будет остановлен процесс агента, но тимсити-сервер будет знать об агенте;
* `tc-mngr.sh --force-stop` - остановить агента принудительно. Процесс агента не будет дожидаться завершения запущенного билда и принудительно остановится. Использовать с осторожностью;
* `tc-mngr.sh --disable` - остановить агента (gracefully) и выполнить remove агента с тимсити-сервера. Эта операция позволяет перерегистрировать агентов с одинаковыми хостнеймами, поэтому именно она используется автоматикой перед выключением хоста;
* `tc-mngr.sh --status` - отобразить статус агента;

Для операции `disable` используются походы в API тимсити-сервера. Они совершаются от имени робота robot-optimus-prime с [access токеном](https://yav.yandex-team.ru/secret/sec-01fjxw6ssj5yd4psw4hgwp1jsq/explore/versions). Это отдельный токен для tc-mngr и ему выданы минимальные права, только для доступа к управлению билдами и пулами агентов.



