# Конфигурация Nginx для сервисов

> Большинство наших сервисов живут в докере ([Shiva](https://docs.yandex-team.ru/classifieds-infra/deploy/quick-start)). Поэтому здесь описан вариант конфигурации именно для таких сервисов - для статических адресов смотрите на существующие конфиги.

Запросы от Nginx в сервис, живущий в докере, проходят через Envoy, который умеет по заголовку `Host` направлять запросы в динамические инстансы сервиса.
Поэтому для простого проксирования запроса достаточно следующей конфигурации:
```
location /<my_awesome_svc> {
    ...

    include                 /etc/nginx/include/common/proxy-params-<int/ext>-wo-host.inc;
    proxy_set_header        Host $rhost_<svc_name>;
    proxy_pass              http://lb_int;

    ...
}
```

где:
- в `include` прописываем необходимый набор параметров для проксирования;
- в `proxy_set_header` передаем нужный заголовок `Host` (для определения тест/прод создаем `map`, об этом ниже);
- в `proxy_pass` указываем общий апстрим Envoy.

#### map для заголовка Host
Сама `map` для заголовка `Host` выглядит примерно так:
```
map "$host"                               $rhost_<svc_name> {
    "~<domain>.test.vertis.yandex.ru"     '<short_svc_domain_name>.vrts-slb.test.vertis.yandex.net';
    "~<domain>.yandex.ru"                 '<short_svc_domain_name>.vrts-slb.prod.vertis.yandex.net';
}
```

Это базовая конфигурация, которая работает и поддерживает бранчи (но только по заголовку `x-branch-name`).

### Бранчи по куке и поддомену

Для полноценной поддержки бранчей необходимо добавить в конфигурацию выше строки:
```
location /<my_awesome_svc> {
    ...

    proxy_pass              http://lb_int;

    proxy_set_header        x-branch-name       $branch_<svc_name>;
    proxy_set_header        x-sticky-uid        '1';

    ...
}
```
где:
- Заголовок `x-branch-name` отвечает за попадание в конкретный бранч сервиса. Как задается переменная для него - описано ниже;
- Заголовок `x-sticky-uid` отключает балансировку 1% трафика на стороне Envoy (ниже мы делаем это сами, на стороне Nginx).

#### map для заголовка x-branch-name

Для упрощения понимания тут будет рассматриваться сервис `realty-front-lk`.

Сама `map` для заголовка `x-branch-name` выглядит так:
```
map "$host"                                                                                 $subdomain_realty_front_lk {
    default                                                                                 '';

    ~^(branch-(?<br_realty_front_lk>[0-9a-zA-Z\-\.\_]+)\.)?m.realty.test.vertis.yandex.ru   $br_realty_front_lk;
    ~^(?<br_realty_front_lk>[0-9a-zA-Z\-\.\_]+)\.m.realty.test.vertis.yandex.ru             $br_realty_front_lk;
    ~^(branch-(?<br_realty_front_lk>[0-9a-zA-Z\-\.\_]+)\.)?realty.test.vertis.yandex.ru     $br_realty_front_lk;
    ~^(?<br_realty_front_lk>[0-9a-zA-Z\-\.\_]+)\.realty.test.vertis.yandex.ru               $br_realty_front_lk;
}
map "$subdomain_realty_front_lk:$cookie_yandexuid:$cookie__branch:$http_x_branch_name"      $branch_realty_front_lk {
    default                                                                                 '';

    "~.*:.*:.*:.+"                                                                          $http_x_branch_name;
    "~.*:.*:.+:.*"                                                                          $cookie__branch;
    "~.+:.*:.*:.*"                                                                          $subdomain_realty_front_lk;
}
```

Здесь:
- В первой секции с помощью регулярных выражений мы вытаскиваем имя бранча (именованный захват в `br_realty_front_lk`). Переменные в Nginx имеют по-сути глобальную область видимости, поэтому для каждого сервиса имя переменной должно быть уникально и для единообразия иметь префикс `br_`;
- Во второй секции мы заполняем переменную `branch_realty_front_lk` названием бранча. Либо из заголовка `x-branch-name`, либо из куки `_branch`, либо из поддомена.

### Балансировка 1% трафика в бранчи

Чтобы добавить возможность 1% пользователям попадать в бранч (и, чтобы одни и те же пользователи попадали в один и тот же бранч) надо добавить в мапу `include`:
```
map "$subdomain_realty_front_lk:$cookie_yandexuid:$cookie__branch:$http_x_branch_name"      $branch_realty_front_lk {
    default                                                                                 '';

    "~.*:.*:.*:.+"                                                                          $http_x_branch_name;
    "~.*:.*:.+:.*"                                                                          $cookie__branch;
    "~.+:.*:.*:.*"                                                                          $subdomain_realty_front_lk;

    include                                                                                 /etc/nginx/include/autogenerated/map-yandexuid-branch-realty-front-lk.inc;
}
```

Cодержимое этого `include` будет генерироваться сервисом **nginx-configs-generator**, для которого надо написать [конфигурацию](https://a.yandex-team.ru/arc_vcs/classifieds/infra/vertis-ansible/roles/nginx-configs-generator/files).
Пример конфигурации для `realty-front-lk`:
```
  - service:    'realty-front-lk'
    value:      '~.*<UIDSUFFIX>:.*:.*:.*'
    path:       '/etc/nginx/include/autogenerated/map-yandexuid-branch-realty-front-lk.inc'
```
где:
  - `service` - имя сервиса в shiva;
  - `value` - значение, которое будет генерироваться для ключей map c заменой шаблона `<UIDSUFFIX>` на цифру, которую генерирует у себя shiva после выкладки branch с ключом `-t` (начиная с 99 по убыванию);
  - `path` - путь по которому будет сохранен сгенерированный include-файл.


