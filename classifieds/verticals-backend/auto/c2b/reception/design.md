#Сервис для работы с заявками на аукцион

## Решаемая задача

Обеспечение жизненного цикла заявок на аукцион

Создание, отслеживание статуса, обогащение отчётами и другой дополнительной информацией,
изменение и удаление

Ожидаемая нагрузка - сотни и далее тысячи заявок в месяц

## Сущности

### Заявка на аукцион
- `id`
- `offer` (оффер auto.ru)
- `inspect_time` (желаемое время осмотра авто)
- `inspect_place` (желаемое место осмотра авто)
- `status` (статус заявки)

- `pro_auto_report` (отчёт ПроАвто - ссылка на s3)
- `evaluation_list` (лист оценки CME - ссылка на s3)
- `inspection_list` (результат осмотра CME - ссылка на s3)
- `moderation_status` (статус модерации)
- `application_status` (статус готовности к торгам)
- `waiting_data` (список источников, из которых мы ждём данные)
- `created_at` (дата создания)
- `completed_at` (дата готовности)

### Статусы заявки и аукциона
Сквозные через все сервисы аукциона
`NEW` | `WAITING_INSPECTION` | `INSPECTED` | `AUCTION` | `FINISHED`

### Статусы модерации
`PENDING` | `OK` | `FAILED`

### Внутренний статус заявки
`NEW` | `MODERATED` | `WAITING_DATA` | `READY` | `REJECTED`

### Источники данных
`CME` | `CARFAX`

## Компоненты

### API

 - Создать заявку
   - user_id
   - offer
   - inspect_date
   - inspect_place

 - Получить заявки пользователя
   - user_id

 - Получить подробности о заявке
   - application_id

 - Проверить оффер на аукционабельность
   - user_id
   - offer

 - Редактировать - непубличная ручка
   - application_id
   - offer
   - pro_auto_url
   - cme_evaluation_url
   - cme_inspection_url
   - moderation_status

 - Есть ли активная заявка с таким VIN
   - vin

 - Обновить статус - непубличная ручка 
   Продавец захочет видеть **сквозной** статус своей заявки, включая статус лотов, кажется хорошей идеей будет
пропушивать статус в заявку из лотов или иных сервисов

 - Ручка настройки рубильника - непубличная, закрыть приём заявок, задать фильтр
   - turn_off
   - global_filter


### Scheduler

- создание заказа проАвто, поллинг результата
- отправка в модерацию (hobo), ожидание вердикта
- создания черновика оценки в CME
- отправка готового лота куда-то дальше (в сервис лотов, в телегу)

На данном этапе нет смысла создавать сложную систему стейджей

#### Первый этап
Заявка создаётся в статусе `NEW`, далее её подхватывает шедулер,
который должен отправить запрос в hobo и выставить статус
`moderation` = `PENDING`

ожидаем вердикта слушая топик, получив вердикт - устанавливаем соответствующий статус модерации
и переводим статус заявки в `MODERATED`

#### Второй этап
Тянем из базы заявки где `status` = `MODERATED`
И опрашиваем для неё все источники из которых её можно обогатить информацией, 
cme, carfax

Здесь, если такой источник синхронно отдаёт соответствующую информацию - мы можем сразу
заполнить соответствующее поле в заявке, если синхронно не получилось -
помещаем соответствующую источнику запись в список `waiting_data`
источники: `CME` | `CARFAX`

Также в заявку записываем id того что мы ждём асинхронно если это понадобится для поллинга

#### Третий этап
Далее:
- CME - ждём вебхука с результатом оценки и осмотра, когда приходит -
  сохраняем отчёт в s3, заполняем соответствующие поля ссылками на отчёты,
  удаляем `CME` из `waiting_data`
- carfax - тянем из БД все заявки у которых в `waiting_data` есть `CARFAX`,
  делаем это раз в N минут, для всех
  если получили готовый отчёт, со всеми необходимыми блоками - сохраняем его в s3, заполняем
  соответствующее поле ссылкой и удаляем `CARFAX` из `waiting_data`

#### Третий этап
Следующий шедулер подхватывает заявки с пустой `waiting_data` и отправляет их дальше -
например в телеграм-бота или сервис лотов


### Webhooks
- ожидание вебхука от CME об окончании оценки/осмотра
- ожидание вебхука от CME о смене статуса

## Внешние зависимости

### БД

Postgresql

`auction_applications` - таблица с заявками на аукцион, тысячи записей в месяц
  - `application_id:      BIGSERIAL` - уникальный идентификатор заявки
  - `user_id:             VARCHAR(???)` - идентификатор пользователя
  - `offer_body:          BYTEA`
  - `inspect_time:        TIMESTAMP WITH TIME ZONE`
  - `inspect_place:       TEXT`
  - `application_status:  APPLICATION_STATUS`
  - `status:              STATUS`
  - `pro_auto_request_id: VARCHAR(???)`
  - `pro_auto_report:     TEXT`
  - `cme_evaluation_id:   INTEGER`
  - `cme_evaluation:      TEXT`
  - `cme_inspection:      TEXT`
  - `moderation_status:   MODERATION_STATUS`
  - `waiting_data:        DATA_SOURCE[]`
  - `created_at:          TIMESTAMP WITH TIME ZONE`
  - `completed_at:        TIMESTAMP WITH TIME ZONE`

`ENUM STATUS = WAITING_INSPECTION | INSPECTED | AUCTION | FINISHED | REJECTED`

`ENUM MODERATION_STATUS = OK | FAILED`

`ENUM APPLICATION_STATUS = NEW | WAITING_DATA | READY | REJECTED`

`ENUM DATA_SOURCE = CME | CARFAX | MODERATION`

`PK = application_id`

`Index(waiting_data)`

`Index(user_id)`

### Хранилище бинарных данных

s3 - пишем отчёты в публичный бакет со ссылкой вида s"${application_id}/${report_type}"

### Поставки брокера

Заявки - всё про заявки, точно пишем создание и изменение, отказ и отправку на торги

### Интеграции с сервисами

- trade-in - отправляем оффер, получаем `boolean`, на основе этого отвечает ручка проверки возможности заявки
- carfax - отчёты
- cme - оценка и осмотр
- модерация - отправляем заявки - забираем вердикты
- [телеграм бот](https://github.com/YandexClassifieds/autoru-expert-auction-bot) - первое время будет вместо сервиса лотов