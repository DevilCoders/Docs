# Сервис для проведения аукциона

## Решаемая задача

Проведение аукциона, обеспечение механики торгов

Создание, отслеживание статуса, торги

Ожидаемая нагрузка - 6 rps средняя, пик ориентировочно - 50 rps

## Сущности

### Лот
- `id`
- `applicationId` (ссылка на заявку из которой произошел лот)
- `offer` (оффер auto.ru)
- `status` (статус лота)
- `proAutoReport` (отчёт ПроАвто - ссылка на s3)
- `evaluationList` (лист оценки CME - ссылка на s3)
- `inspectionList` (результат осмотра CME - ссылка на s3)
- `createdAt` (дата создания)
- `startAt` (время начала аукциона по лоту)
- `finishAt` (время завершения торгов аукциона по лоту)
- `currentPrice` (текущая цена)
- `startingPrice` (начальная цена)
- `finishingPrice` (итоговая цена)
- `winner` (победитель аукциона)
- `prolongedTimes` (счетчик отображает число сколько раз был продлен аукцион вследствие сильной активности дилеров)


### История ставок
- `id`
- `lotId`
- `userId`
- `value` (цена после ставки сделанной дилером)
- `createdAt TIMESTAMP WITH TIME ZONE`


### Статусы лота
`NEW` |  `AUCTION` | `DEAL` |`FINISHED` |`REJECTED`


## API
 - Получить список лотов с возможностью фильтрация по статусу и dealer_id
 - Получить подробности о лоте (по id)
 - Сделать ставку
 - Генерировать ссылку на сокет (Функционал для того чтобы дилер мог подписаться на уведомление новых ставок) (Метод подписки)
 - Отправить лот во второй круг аукциона (внутренняя ручка)
 - Остановка торгов

## Жизненный цикл лота

### Первый этап
Подписываемся на топик изменения заявок, при получении сообщения о том что в заявке собраны все нужные документы -
создаем лот в статусе `NEW`, определяем время начала торгов согласно настройкам, происходит оповещение дилеров,
о том что такой-то лот скоро будет торговаться.

Как определяем время начала торогов:
 - хотим запускать их настолько рано, насколько возможно
 - только по будням
 - с 10:30 до 17:30
 - соответственно, ищем ближайший к текущему момент во времени, в который можно запустить торги по лоту

### Второй этап
Забираем из базы все лоты в статусе `NEW`, у которых время начала торгов сейчас или позже,
переводим в статус в статус `AUCTION` и запускаем торги, происходит оповещение дилеров, а также установка даты и времени
завершения аукциона (`now + auction_duration`)

### Третий этап (Механика аукциона)
Шаг 1.
Дилер делает ставку

Шаг 2.
Происходит блокировка лота и сравнение currentPrice и ставки, если ставка выше то ставка принимается и currentPrice = ставке,
если currentPrice >= ставки, значит другой дилер опередил своей ставкой, и ставка которая <= currentPrice отклоняется.

* При успешной ставке происходит уведомление остальных дилеров, что текущая цена изменилась через websocket.

### Четвертый этап
1 Вариант. Завершение торгов. За установленный временной интервал происходит уведомление о завершении торгов.
При завершении лот переводится в статус `DEAL`.
Пишем в топик изменения лотов ивент изменения статуса.

2 Вариант. Продление торгов на фиксированное время. Торги могут быть продлены если была сделана ставка за интервал из конфига до их окончания.

### Пятый этап
При завершении переговоров между дилером и продавцом лот переводится либо в статус `FINISHED` либо `REJECTED`
пишем в топик изменения лотов ивент изменения статуса.

## Внешние зависимости

### БД

Postgresql

`lots` - таблица с лотами, тысячи записей в месяц
  - `lot_id`
  - `application_id INTEGER`
  - `offer_body:          BYTEA`
  - `status:              STATUS`
  - `pro_auto_report:     TEXT_URL`
  - `cme_evaluation:      TEXT_URL`
  - `cme_inspection:      TEXT_URL`
  - `created_at TIMESTAMP WITH TIME ZONE`
  - `start_at TIMESTAMP WITH TIME ZONE`
  - `finish_at TIMESTAMP WITH TIME ZONE`
  - `current_price BIGINT`
  - `starting_price BIGINT`
  - `finishing_price BIGINT`
  - `winner_dealer_id UUID`
  - `prolonged_times INTEGER`


`NEW` |  `AUCTION` | `DEAL` |`FINISHED` |`REJECTED`

`bids` - таблица ставок
  - `bid_id BIGSERIAL`
  - `lot_id INTEGER`
  - `dealer_id UUID `
  - `value INTEGER`

### Интеграции с сервисами

- c2b-auction-scheduler - создание лота из заявки, и обновление статуса заявки из лота, взаимодействие через kafka
- public api - гейтвей
- яндекс трекер - как CRM - на данном этапе не делаем
- xiva (https://console.push.yandex-team.ru/#overview) - как high level замена для вебсокетов (для real-time пушей дилерам)
