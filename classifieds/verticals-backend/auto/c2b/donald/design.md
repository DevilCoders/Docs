# Сервис для интеграции с биллингом

## Открытые вопросы:
- Завязываться на дилера, а не клиента (спросил сережу, пингануть когда начнем делать)
- Админка (не совсем сюда вопрос, но частично касается, самое время будет еще раз напомнить)
- 
## Решаемая задача

Глобально на 27.06.2022 есть вещи, которые мы хотим делать:

1) Получать процент-комиссию с проданного авто дилеру
2) Выкуп у капота. Покупаем авто сразу у продавца, если дилер подтвердил что выкупит его у нас. Сначала мы платим за авто, потом выставляем
счет дилеру.

Нагрузки не ожидается, 1rps.

## Бизнес сценарии
### Терминология
 - User - Дилер
 - Account - Юридическое информация, по сути реквизиты, которые используем для денежных операций.
             Account с точки зрения биллинга это новый клиент. По сути аккаунт у нас это == плательщик + договор в биллинг

Для каждой операции, что мы хотим делать (получать вознаграждение (процент с продажи авто), проверять может ли дилер участвовать в выкупе у капота,
получать деньги (взаиморасчеты) за выкуп у капота) нужен отдельный account (клиент в биллинг).

### Функционал. Что мы хотим?

1. Мы хотим получать вознаграждение с каждого авто, который дилер купил на нашем аукционе.
   Что для этого надо? 
   - а) Регистрируем дилера у себя, после того как он согласился с новой офертой (на этом этапе дилер вводит свои реквизиты, которые мы сохраняем)
   - б) Создаем клиента в биллинг
   - в) Создаем плательщика в биллинг 
   - г) Создаем договор в биллинг
   - д) Каждый раз когда сделка заключена (дилер купил авто через наш продукт), мы считаем процент (наше вознаграждение) и отправляем эту информацию в биллинг
   - е) Раз в месяц на наш счет приходят деньги за все авто


2. Выкуп у капота. Мы покупаем авто для дилера, дилер позже переводит нам за него деньги.
   Что для этого надо?
   а) На этом моменте у нас уже есть дилер, зарегистрированный у нас
   б) Нам нужно создать для него два новых account. По сути это создать два новых клиента в биллинг и пройти путь из пункта 1, этапы б, в, г.
      Почему два новых account (клиента в биллинг)?

      Мы хотим выдать разрешение дилеру для торгов по определенной ценовой категории авто, которые участвуют в выкупе у капота. 
      Для этого создаем account - условно депозит. Куда дилер положит некую сумму, но в денежном обороте она участвовать не будет.

      Мы хотим сами выкупить авто у пользователя, но чтобы потом дилер перевел нам деньги.
      Это второй account - условно взаиморассчетный. На него после покупки авто выставляется счет для дилера, что мы купили авто вот за такую то сумму, оплати/верни нам эти деньги.

Это примерное описание процессов с точки зрения бизнеса.

## Техническая часть
### Сущности

#### Dealer 
- `id` - уникальный id внутри нашего сервиса
- `cmeDealerId` - dealerId из CME, для связи нашей сущности с CME
- `requisite` - реквизиты дилера/юридическая информация, вводит дилер при регистрации у нас (согласие с новой офертой)

#### Account(по сути это создание клиента в биллинг)
- `accountId` - (dealerId, accountType - тип счета `[COMMISION, DEPOSIT, SETTLEMENT]`)
- `currentBalance` - будет > 0, если дилер положил больше денег чем должен

#### Bill(выставление счета на конкретный account)
- `id` - уникальный id внутри нашего сервиса
- `accountId` - ссылка на account
- `commonSum` - сумма
- `paidSum` - выплаченная сумма



#### Типы счетов
- COMMISSION - тип счета с которого мы получаем процент/снимаем комиссию с дилера за каждое проданное авто
- DEPOSIT - счет которые создается для участия в выкупе у капота, дилер его пополняет,
            обеспечивая себе доступ к выкупу у капота в определенном ценовом сегменте. Деньги с него не снимаются по сути.
- SETTLEMENT - счет для взаиморасчёта. Мы выкупили авто для дилера, на этот счет выставляем сумму которую дилер нам должен.


### Интеграции

#### С кем
- Billing
- Lotus

#### Как
##### API
- registerDealer - Регистрация дилера(cmeDealerId: Sting, requisite: Requisite)
- addFastBuyout - как лучше назвать выкуп у капота? (cmeClientId: Sting)
- getBillsByDealer - Получить все счета которые дилер должен оплатить (cmeCleintId: String)
- updateRequisite - Обновление реквизитов
- createBill - Выставление счета по конкретной операции, типу счета (cmeClientId: String, operation: [GET_REWARD, GET_SETTLEMENT])

##### Kafka
- При выставлении счета на оплату, вызов нашей ручки bill, мы это проксируем в биллинг. Что нужно? нужно понимать счет оплачен или нет.
  В кафку будет приходить message с суммой оплаты. (Алгоритм будет в тикете). 


### БД

Postgresql

`dealers` - таблица с дилерами, до 1000 записей в год
- `id BIGINT AUTOINCREMENT`
- `cme_cleint_id VARCHAR(64)`
- `requisite BYTE`

`accounts` - таблица счетов, до 3000 записей в год
- `accountId` - dealerId + accountType
- `current_balance` - будет > 0, если дилер положил больше денег чем должен

`bill` - таблица чеков по сути, выставленных счетов, до 3000 записей в год
- `id BIG SERIAL`
- `dealer_id`
- `account_type` - dealer_id + account_type ссылка на таблицу account
- `commonSum MONEY`
- `paidSum MONEY` - выплаченная сумма
- `url` - ссылка на pfd выставленного счета

### Важное, но что будет не в этом сервисе
 - Допилить лотус
 - Цена финальная после последнего круга торгов может меняться, в ходе переговор продавца, дилера и нашего аккаунта. 
   Нужна ручка обновления цена по лоту
 - Не всегда тот кто выйграл покупает тачку, часто это другой дилер.
   Нужна ручка смены победителя по лоту. 

   
   


