Carfax-Money (aka Mинимойша)
================================================

**Carfax-Money** - сервис по определению цены отчета/пакета отчетов.

_Мотивация_ - Сложность добавления новых параметров в текущую матрицу,
возможность сломать смежные расчеты по ценам в случае добавления большого количества критериев, сильно ограниченные ресурсы монетезации, долгий ттм для заведения экспериментов.

_Основная цель_ - уйти от редактирования текущей матрицы и проводить бодрые эксперименты с ценами.
В перспективе обучить ml-модель и принимать решение о цене на ее основе.

## Требования

**Сервис должен**:
1) Быть аудируемым(sox) - т.е. отвечать на вопрос, почему на такой-то отчёт на такую-то дату была такая-то цена. Плюс технические требования к выкатке в продакшен. На этот вопрос можем отвечать таким способом - Есть арк-лог по нему сможем восстанавливать состояние сервиса на любой момент времени. Образование цен в базе мы не храним.
2) Уметь работать с абэшницей(Уметь принимать айди эксперемента и по нему отдавать разные данные - большего от сервиса не требуется, все остальное остается на админке абт).
3) Быть расширяемым, т. е. иметь возможность принимать новые или изменять текущие параметры и на их основе вычислять цену.
5) Собирать(сохранять?) статистику(например - сколько раз такой-то отчет с таким-то набором параметров был куплен абстрактным перекупом из кемерово по такой-то цене).

## Реализация

**Идем по пути нескольких итераций:**
1) Переносим определение текущей цены из мойши as is(хардкодим цены по текущей матрице)
2) Выносим принятие решения про цену в алгоритм
3) Начинаем добавлять в алгоритм новые параметры и выводить новые расчеты(собираем и сохраняем статистику?)
4) На основе сохраненных данных обучаем ml-модель
5) Принимаем решения о цене по переданным параметрам на основе обученной ml-модельки

В первом приближении сервис будет представлять собой простую грпц реализацию.
Апи будет принимать прото-сообщение с текущими параметрами(марка/модель/тех. парамы/кволити от/кволити до/гео/цена от/цена до). Ответ сервиса будет содержать вычисленную стоимость и хэш от переданных параметров.
Сервис потребитель должен сам вычислять и передавать все необходимые параметры в сервис оценки, сам сервис оценки никуда ходить не будет.

**Дальнейшие шаги** - развиваем, дополняем наш алгоритм новыми параметрами, добавляем сбор статистики.
Когда наберется достаточно исторических данных, попробуем отдать это на обучение ml-модели.

## Варианты сбора статистики покупок

1) Делаем еще одну ручку в которую будем принимать хэш от параметров отчета, если она тригерится увеличиваем счетчик для таких параметров. Будем писать в какую-нибудь базку(постгрес?).
2) Просто стримим в логи(брокер/кафку/etc) вычисленную цену и текущие параметры, а аналитики(кто-то другой?) сами сджойнят с базой покупок.
3) По сути второй вариант, только сами заводим асинхронный сервис, который будет по логу на сегодняшний день(либо потоково) считать статистику и сохранять, например в ыть.

Выбрали второй вариант, будем стримить результаты в брокер, а он в свою очередь сохранит результаты в ыть

## Нагрузка

Ожидаемая нагрузка на сервис в среднем **750-800** рпс(по статистики мойши), значения днем около **1000** рпс и ночью около **300** рпс.

## Интеграции

**Есть несколько вариантов интеграции с сейлзменом:**
1) Как сейчас только вместо _мойши_ _сейлзмен_ будет ходить в наш сервис. Но у этого подхода есть важный минус - опять нужно будет тратить ресурсы монетезации на поддержание новых параметров, либо придется делать слишком обширное апи, которое будет принимать не конкретные параметры, а сущность оффера, профиля пользователя, отчетов. И все равно чего-то может не хватить.
2) _Карфакс(про авто)_ сам собирает всю необходимую информацию и передает ее в сервис расчета цен, а монетезация уже за ценой отчета ходит напрямую в _карфакс_. Тут плюсом является, то что мы в целом сможем сами в любой момент и довольно дешево поддерживать параметры.
3) Взаимодействие остается такое же, как во втором варианте, но только цена будет непосредственно уже зашита в отчет. Тогда, кажется не придется отдельно ходить в _карфакс_, т. к. цена уже будет посчитана. Тут дополнительно нужно будет подумать, как обрабатывать ситуации, когда у пользователя куплен пакет из нескольких отчетов.

Решили, что будем делать второй вариант - отдельную ручку в карфаксе.
