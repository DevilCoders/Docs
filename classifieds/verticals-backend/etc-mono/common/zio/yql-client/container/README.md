//здесь было убито время

YQL в контейнере
================

Из чего состоит yql
-------------------

Кусочки ыкла, которые нам важны (и насколько я их понял)

* **api** - сделано на java. Ничем особым не выделяется и достаточно легко запускается локально. 
Фактически является api/шиной/координатором над воркерами  

* **yqlworker** - вокрер, который собственно выполняет работу.
Бинарь на плюсах. Оперирует 'шлюзами' (gateway) - фактически реальными стораджами, на которых выполняются запросы.
Yt - один из них.

* **mrjob** - бинарь джобы для запуска в YT для выполнения запросов. Заливается в ыть при первом запросе.

* **udfs** - динамические библиотеки udf. Воркер заливает их в ыть по мере использования. 
В частности поддержка python в запросах - это тоже udf. 
Можно (и нужно) собирать только реально используемые, потому что они весят немало. 

Конфиги описаны в https://a.yandex-team.ru/arc/trunk/arcadia/yql/cfg/local

API и yqlworker поднимаются локально. Но когда доходит до udf становится важным, чтобы yt и yqlworker работали на одной платформе.
Соответственно поднять yt в контейнере, а yqlworker на маке - не получится. Точнее получится, но udf работать не будут.

Как это собирается
-------------------

Контейнер собирается примерно так

1. Конфиги доточены для запуска: убраны ненужные шлюзы, биндинг на ipv4 адреса.
 Шлюз до локального ытя ожидает его по адресу yt:80 
 
2. Для работы api нужна монга. Поэтому ставим enterprise версию, потому что она поддерживает in-memory storage.

3. Собираем из аркадии (ya make) нужные кусочки. udf компилим только те, которые нужны. А то бинари ну очень жирные.


yt берем из доступного контейнера - https://github.yandex-team.ru/yt/docker.
 Не пытаемся его затащить в свой контейнер, просто поднимаем отдельно и связываем в одну сеть.
 Здесь самое интересное - передача _--proxy-config_ c _public_fqdn_. 
 Иначе yql пытается ходить по внутреннему (localhost) адресу, который он получает от ытя.
 

Текущие проблемы
----------------

Что пришлось monkey-патчить в коде, чтобы это завелось

* yql у себя форсит [ipv6](https://a.yandex-team.ru/arc/trunk/arcadia/yql/providers/yt/gateway/native/yql_yt_session.cpp?rev=7518709#L55).
Я не знаю, зачем это делается, потому что в других местах тип адреса берется из env. По идее нужно к ним сходить с этим вопросом.

* У меня в докере не работает получение имени пользователя. Мне пришлось запатчить [здесь](https://a.yandex-team.ru/arc/trunk/arcadia/mapreduce/yt/common/config.cpp?rev=7518709#L225),
чтобы оно возвращало любое имя. Это, скорее всего, проблема жизни в докере и она должна решаться без патча.
Насколько я могу судить, yt запускает свои процессы от пользователя, у которого нет имени. Или он их создает?
Но так как падает в коде джобы, то фикс работает. Но мб придется залезать в сбор yt контейнера, чтобы это починить.

Потенциальные неудобства:

* процессы запускаются буквально ногами. Без какого-то супервизора. Хотя для тестового контейнера это и не проблема.

* конфиги очень статичные. В частности адрес yt захардкожен в yt:80. Может быть это будет неудобно.

* все конфиги скопипасчены (как и скрипты запуска). Поэтому если завтра у них что-то поменяется, мы об этом узнаем только 
после сборки и запуска. Было бы круче брать конфиги из аркадии и править. Или даже хранить конфиги там.


Если хотите попробовать это дома
--------------------------------

Нужно скачать себе кусочек аркадии.
В частности можно сразу брать https://a.yandex-team.ru/arc/trunk/arcadia/yql. 
Также для разбирательств удобно подключить к редактору сразу yt  https://a.yandex-team.ru/arc/trunk/arcadia/yt

Чтобы сборка образа не стала болью, стоит включить [новый сборщик](https://docs.docker.com/develop/develop-images/build_enhancements/)

`export DOCKER_BUILDKIT=1`

А еще можно сразу запомнить команду `docker system prune`. Потому что место кончается очень быстро.

При проблемах наиболее приятным источником информации являются логи yqlworker. В контейнере лежат в _/var/log/worker.out_.
Что-то полезное из логов ытя я до сих пор получить не смог. Ну а api само по себе мало что делает.
Падающие на стороне ытя джобы могут очень долго ретраиться (тоже проблема), поэтому только в логах yqlworker будет что-то полезное.

Для быстрого запуска всего лучше использовать docker-compose. В отличие от testcontainers он не дропнет контейнеры при ошибке.
Можно в них покопаться. 

В докер публикую в теги
* registry.yandex.net/vertis/etc/yql:dev
* registry.yandex.net/vertis/etc/yql:dev_[idx] Чтобы иметь возможность вернуться. По идее тут должна быть версия аркадии.
