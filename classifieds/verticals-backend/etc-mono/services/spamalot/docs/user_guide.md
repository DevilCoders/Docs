# Отправка уведомлений

Api предоставляет два способа отправки: точечные сообщения и массовые рассылки по списку идентификаторов.

В качестве идентификаторов используются идентификаторы пользователей Пушного.
Отправка разделена по [доменам](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/common.proto#L10).

Обязательными являются наличие `user_id` и `topic`. Доступный список топиков для авто хранится в [справочнике](https://palma.test.vertis.yandex-team.ru/dictionaries/auto/notification/type) пальмы, для остальных пока что в [конфиге](../core/src/main/resources/topics.conf).

> **Банить топики следует с осторожностью!**
> 
> TL;DR: для незалогиненых пользователей следует банить топики по device_id. Когда пользователь логинится, следует отменить бан топика для его device_id и перебанить их по user_id.
> 
> _Объяснение:_
> 
> Сейчас топики — дублирование логики подписок в пушном спамалотом с тем отличием, что в пушном бан подписки происходит для конкретных девайсов пользователя, либо для всех его девайсов. В спамалоте этого мапинга пока нет, так что возможны неприятные для пользователя ситуации описанные в этом тикете (https://st.yandex-team.ru/VERTISTRAF-2476).
> 
> Предложенное решение проблемы временно, до тех пор, пока данный тикет не будет решён. После его решения, должен быть единый API для бана топиков без данной проблемы.

Отправка сообщений асинхронна, если вы получили ответ, значит, сообщение принято к обработке и будет обработано с задержкой от 30с (или больше зависимости от загрузки очереди).

## Пейлоад
В качестве пейлоада можно использовать шаблоны (сейчас есть несколько шаблонов из пушного, остальные будут добавлены по запросу) или же данные в формате конструктора: кнопки, медиафайлы и прочее.
Для кнопок задаются экшены, при этом на отправителе лежит ответственность за указание корректных экшенов под каждую из платформ.
Подробнее про [конструктор уведомлений](design.md#конструктор-уведомления) )

### Медиафайлы
Уведомления для колокольчика могут содержать любые сочетания медиафайлов: картинок и видео.

ЦУ принимает картинки только из неймспейсов аватарницы, причем они должны содержать определенные размеры, заданные в конфиге ЦУ(//todo: ссылка на конфиг, когда определимся с размерами).
Картинки следует передавать в виде [proto-сообщения](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/image/avatars_image.proto#L11).

:heavy_exclamation_mark: Ссылки на конкретные размера для передачи на клиенты формируются из захардкоженного в конфиге ЦУ списка, поле aliases, переданное в proto-сообщении, игнорируются. Так сделано потому, что клиенты ожидают от ЦУ определенные размеры, и он их не разочаровывает. Ответственность за наличие этих размеров в переданном неймспейсе лежит на отправителе.  

Для пушей используется первая картинка в переданном списке медиафайлов. В конфиге ЦУ также задан используемый алиас и опять же, если в реальности он отсутствует, получатель увидит пуш без картинки.

Для видео – принимается любая ссылка, если это ссылка на youtube аппы могут достать превьюшку сами (?уточнить), если на что-то другое – следует положить рядом медиа с картинкой. При наличии картинки и видео в уведомлении картинка воспринимается как превью для видео.

## Каналы отправки
По умолчанию уведомление попадет только в колокольчик. 
Если нужны дополнительные каналы для доставки (сейчас поддерживаются только мобильные пуши), в уведомлении нужно это прямо указать. 

#### Ограничения для пушей
На отправляемый по уведомлению пуш, естественно, накладываются ограничения мобильных платформ:
- 1 картинка или видео + картинка для превью (если видео не с youtube)
- не более 3 кнопок
- ограниченная поддержка разметки текста сообщения

## Дедупликация
Сообщения дедуплицируются по notification_id или по хэшу от контента, так что одинаковые сообщения одному и тому же пользователю не отправятся. Таким образом ЦУ обеспечивает идемпотентность при ретраях. В случае необходимости отправить то же уведомление повторно следует задать уникальный id нотификации.

## Пагинация
При запросе списка сообщений пользователей будет использована пагинация (по умолчанию лимит 100), сообщения возвращаются упорядоченными по времени в отправки в обратном порядке (самые свежие – самые первые). Максимально возможный размер лимита – 1000 (ограничения YDB). При возврате списка, так же возвращаются параметры для запроса следующей страницы (если мы предполагаем, что она есть), их нужно передать обратно при запросе следующей страницы в качестве значения пагинации.

## Где моя нотификация
Искать можно по id нотификации в [логах контроллера](https://grafana.vertis.yandex-team.ru/s/t/N7mCH20k3hDh2x).
Прогресс в пушном можно посмотреть по трейсам или поискав по `request_id` в [логах пушного](https://grafana.vertis.yandex-team.ru/s/t/VvWpbpXL3hEGfq).
