# Doppel-yt

Сервис для кластеризации объявлений между различными площадками. 
В настоящее время реализован только для авто и подержанных машин.
Источниками данных для доппеля являются [холокрон](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/broker/prod/warehouse/holocron/auto/cars) и [мета](https://yt.yandex-team.ru/hahn/navigation?sort=asc-false,field-name&path=//home/verticals/broker/prod/warehouse/auto/images/meta/1d) картинок. 

### Для чего нужно
* Для объявлений конкурентов отвечать на вопрос, есть ли такое объявление у нас, для последующей отправки в КЦ для обзвона. 
* Для наших объявлений – определять, нужно ли ставить плашку "только на авто.ру".
* Аналитика полноты базы

### Что должен уметь
* Матчить максимально быстро поступающие офферы и отправлять изменения в брокер (быстро пока не умеет, матчит около часа).
* Формировать плоские (1-к-1) и полные (1-ко-многим) кластеры объявлений на конец дня и публиковать их в ыть.
* Принимать и учитывать в результатах [корректирующие сигналы](#корректирующие-сигналы) от модераторов вида "вот эта пара офферов на разных классифайдах точно одно и то же/точно разное".


### Матчинг
Для матчинга объявлений используется содержимое оффера и картинки.

Матчинг картинок описан в абзаце про [индексацию](#индексация-картинок).

Для матчинга по содержимому оффера используются некоторые эвристики.
Считаем офферы сматченными, если:
- получили точное совпадение офферов по id от колл-центра или VIN-номеру
- сматчились по набору эвристик по картинкам, техпараметрам (объем/тип двигателя, количество л.с. и т.п) и другим характеристикам из оффера (цвет, пробег, цена и т.д.)

Конкретная функция (YQL lambda) выглядит так:

    $clusterize = ($row) -> {
      -- точное совпадение
      $exact_match = $row.`same_vin` is not null or $row.`call_center_offer_id` is not null;
      
      -- эвристики для региона
      $same_region = (($row.`vin_compatible` is not null and $row.`same_region` is not null) or $row.`region_compatible` is not null);
      
      -- эвристики для матчинга по картинкам с учётом техпараметров, цены, пробега и т.д
      $images_match = $row.`same_tech_params` and (
            ($same_region and ($row.`similarity` > 0.97 or $row.`similar_images` > 0) and 
            ($row.`price_close` or $row.`mileage_close`) and
            ($row.`same_color` is not null or $row.`price_or_mileage_same`))
        or  ($same_region and $row.`similarity` > 0.985 and $row.`similar_images` > 1 and $row.`price_or_mileage_close_11_6`)
        or  ($row.`vin_compatible` is not null and $row.`similarity` > 0.985 and $row.`similar_images` > 2 and $row.`price_or_mileage_close_15_10`)
      );
    
      -- эвристики для матчинга по содержимому, учитывающие цвет, техпараметры, совпадение VIN по маске, регион, цену и пробег
      $tech_params_match = 
            $row.`same_color` is not null and
            $row.`same_tech_params` and
            $row.`vin_compatible` is not null and
            $same_region and $row.`price_and_mileage_same`;

      return $images_match or $tech_params_match or $exact_match;
    };

### Имплементация
Старый доппель работал на спарке и делал это довольно хорошо, но при съезде с хадупа никто из нас не проявил достаточно энтузиазма попробовать Spark-over-YT, и решено было пойти по пути холокрона и использовать YQL.

Таким образом, новый ытёвый доппель представляет из себя набор YQL-запросов к табличкам в YT.

Используем стандартный шедулер и набор тасок:
* __index-images__ – [индексация](#индексация-картинок) и поиск похожих картинок для каждого дня
* __prepare-offers__ – материализация офферов на текущий момент времени, похоже на поиск eod в холокроне, но деактивированные офферы сохраняются. Полученная таблица будет использована в RT-кластеризации
* __fast-clustering__ – поиск существующих кластеров на текущий момент времени и диффа(_clusters_diff_) между результатом и последними отправленными в брокер кластерами, пытается быть [RT](#RT-кластеризация)
* __send-clusters__ – отправляет кластеры из таблицы _clusters_diff_ в брокер пачками, сдвигая указатель последней отправленной строчки
* __global-clustering__ – поиск плоских и полных кластеров по _eod_, подробнее [тут](#EOD-кластеризация) 

Все таски запускаются по расписанию, но выполняются только в случае изменений в исходных таблицах.

#### Индексация картинок
При индексации картинок используется _locality-sensitive hashing_ (LSH) – вероятностный метод понижения размерности многомерных данных.

При появлении доппеля были [сгенерированы](../controller/src/main/resources/yql_udf_utils.py) векторы, которые нормализованы, одинаковы для прода и тестинга и никогда не меняются (лежат [тут](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/doppel/prod/static/lsh_vectors)).

В мете каждой картинки мы получаем от компьютерного зрения аватарницы 96-мерный вектор.

Из векторов картинок и сгенерированных статических векторов доппеля строится [индекс](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/doppel/prod/warehouse/auto/images_index/2021-03-16):
каждой картинке для каждого из трех исходных векторов ставится в соответствие некоторый хэш, и далее сравниваются только картинки с одинаковыми хэшами (т. е. картинки, попавшие в один бакет).

В качестве длины бакета для LSH используем 0.02 (взято из старого доппеля, но в целом сходится с рекомендацией 1-10 * pow(numRecords, -1/inputDim) при учёте времени поиска похожих картинок: чем длинее бакет – тем дольше выполняется запрос).

Сравнение пары картинок производится путём вычисления скалярного произведения их векторов: похожими считаем, если результат >= 0.97.

Полученная дневная таблица похожих картинок сохраняется в [ыть](https://yt.yandex-team.ru/hahn/navigation?path=//home/verticals/doppel/prod/warehouse/auto/similar_images). При поступлении новых картинок внутри дня, они добавляются в индекс, а найденные пары дописываются в таблицу похожестей.

[Пример](https://yql.yandex-team.ru/Operations/YTXDmdjKS9ga7g3YtAAdejOKRIyV07P9rwwSvRZ2c7Y=) запроса, выполняющего индексацию и поиск похожих картинок.


#### RT-кластеризация
Считает полные кластеры (_fast_clusters_) по подготовленным в таске __prepare-offers__ данным, затем ищет разницу между найденными кластерами и последними отправленными в брокер (_last_sent_clusters_).

Разница дописывается в таблицу _clusters_diff_, текущие кластеры становятся новыми _last_sent_clusters_.

Примеры запросов:
1) [RT плоские кластеры](https://yql.yandex-team.ru/Operations/YTWuaNjKS9ga7fK1QSHLNjO9TVGK7kfGFNaltoVNtxs=)
2) [подсчет известных картинок](https://yql.yandex-team.ru/Operations/YTXCwxJKfVebkup_H0lQRyahR5cRZaugFF5TgzYZYlI=) для каждого оффера
3) [полные кластеры](https://yql.yandex-team.ru/Operations/YTW8U9K3DJRSYoA2C5MO8UQ8dFbTsmgmwBf7zOrtLJ0=), построенные из них
4) [поиск diff](https://yql.yandex-team.ru/Operations/YTW9mdjKS9ga7gZM_LO9k9nY6XCAJcOtPH60bywnZXQ=)

Шаги 1 и 2 выполняются параллельно. Подсчет известных картинок нужен для более эффективного расчета __enough_data__ при построении полных кластеров.


#### EOD-кластеризация
Очень похожа на RT, но выполняется на _eod_ из холокрона и содержит поле debug_info со сматченными признаками, которое можно использовать для отладки результатов кластеризации (только для таблиц с плоскими кластерами).
Полные (fat) кластеры формируются из созданных плоских кластеров и обогащаются полем __enough_data__

__enough_data__ – характеристика кластера, отображающая степень его надежности: считается по отношению количества загруженных картинок (то есть картинок, мета которых нам известна) к общему количеству картинок оффера.

Примеры запросов:
- [плоские кластеры](https://yql.yandex-team.ru/Operations/YTW3lNjKS9ga7f5nC1cBMUMdyCIuwEzLcL-0R52_CkY=)
- [полные кластеры](https://yql.yandex-team.ru/Operations/YTXKGxJKfVebkvSgnoKaenEdvW3izCfGbz6_nJeFtxY=)


#### Корректирующие сигналы
Модераторы и другие заинтересованные лица имеют возможность как исключать, так и добавлять кластеры в результаты доппеля.

Для этого нужно отправить в брокер правки в такой [модели](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/doppel/doppel_forced.proto#L14), и доппель их использует в своих расчетах.
