# AMONITION - сервис для интеграции с amoCRM

## Сущности
В amoCRM есть несколько сущностей, с которыми работает система, и которые мы используем в своей интеграции

`Компания` - сущность, содержащая информацию о конкретной компании. В рамках сервиса объявлений это юзер, у которого есть объявления, или магазин.
`Сделка` - сущность, отражающая процесс взаимодействия с конкретными компаниями (например, юзеры с большим количеством объявлений, которых мы хотим привести на сервис). Существует в различных статусах, в зависимости от того, к каким договоренностям удалось прийти. На одну компанию приходится не более одной сделки.

## Решаемые задачи
- Обработка событий от amoCRM
- Загрузка данных пользователей в amoCRM в виде компаний

## Какие данные юзеров выгружаем
- id пользователя
- номер телефона
- email
- имя
- адрес продажи
- дата первого захода на сервис
- дата создания первого объявления
- количество объявлений всего и с разбивкой по статусам
- ссылка на фид
- признак "Автозагрузка" - устанавливается, если есть объявления, созданные через автозагрузку
- признак "Форма" - устанавливается, если есть объявления, созданные через форму
- признак "б/у" - устанавливается, если есть объявления с состоянием б/у
- признак "новые" - устанавливается, если есть объявления с состоянием новое
- категории - список категорий, в которых размещены объявления пользователя
- ошибки фида

## Обработка событий amoCRM
Под событиями подразумеваются запросы, отправленные amo к нам на вебхук.

### Перенос профиля с другого классифайда через amoCRM
1.Когда сущность `сделка` в amo переходит в статус `Готов выгружать вручную`, нам приходит вебхук сделки, в котором указаны
  - URL аккаунта пользователя на стороннем классифайде
  - Номер телефона пользователя
2. Данные отправляются в сервис переноса профилей `Snatcher`, инициируя процесс перенося профиля на объявления.

### Обновление конкретной компании
1. Получаем на вебхук сущность конкретной компании.
2. Аггрегируем из наших сервисов свежие данные по пользователю и обновляем компанию по пришедшему `id`.
TODO более подробно описать, как и откуда какие данные берем при аггрегации

### Загрузка фида юзеру
1. Получаем на вебхук сущность конкретной компании.
2. Берем из сущности ссылку на фид и userId.
3. Проверяем, что пользователь существует на сервисе, иначе кидаем ошибку.
4. Проверяем, что компания есть в базе, иначе добавляем запись в базу.
5. Отправляем в сервис фидов запрос на обновление фида юзеру. (Фид грузим как периодический)

## Асинхронная загрузка юзеров в amo
Помимо обновлений юзеров по требованию есть так же периодическая загрузка/обновление данных юзеров в amo. Это нужно, чтобы менеджеры в `amo` могли пользоваться фильтрами и поиском по юзерам, а так же выгружать отчеты, имея при этом относительно свежие данные.

1. YQL-запросом из снепшотов собираем аггрегацию данных для пользователей, у которых есть офферы
2. Получаем стрим юзеров, который далее батчево обрабатываем
3. Обогащаем агрегаты по юзерам информацией из фидов (ссылка на ошибки. текущий урл фида), если юзер загружал фид
4. Для каждого пользователя проверяем в базе, загружали ли его уже в amo.
5. Батчево создаем компании для юзеров, которых в amo до этого не грузили. Для остальных батчево обрабатываем компании.
6. Заносим в базу записи про созданные компании.

## Компоненты

### Webhooks
Нужен для обработки событий, пришедших из amo.

### Scheduler
Нужен для периодической асинхронной загрузки пользователей в amo.

## Хранилище
Нужно для хранения информации об уже созданных в amo юзеров, чтобы знать, каких обновлять, а каких создавать (метода upsert-а нет).

Учитывая в основном батчевую работу с записями, предполагается небольшая нагрузка.
На данный момент у нас около 400к продавцов, большинство операций - батчевые, около 500 юзеров в батче.
Даже если юзеров станет 1кк - это около 4к запросов в час. Поэтому используем `Postgres`

`companies` - таблица с информацией о компаниях
- `company_id: String` - идентификатор компании в amo
- `seller_id: String` - идентификатор юзера объявлений
`PK = (seller_id)`
    Индексы:
    - companies_idx: `(company_id)` - для быстрого поиска по айдишникам компаний в базе