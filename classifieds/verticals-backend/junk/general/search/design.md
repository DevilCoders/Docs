# Search Design Document

## Задачи:

- Отправка изменений объявлений в [vasgen](https://github.com/YandexClassifieds/vasgen) (индексация)
- Поиск объявлений с помощью [API](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/vasgen/grpc/search.proto) `vasgen`

## Компоненты:

- [scheduler](scheduler) — отвечает за индексацию
- [api](api) — отвечает за поиск

## Индексация

[Scheduler](scheduler) читает kafka-топик `gost-offer-updates` с изменениями объявлений (в топик пишет [GOST](../gost)).
Считанная информация приводится к формату vasgen'а: объявления конвертируются в [RawDocument](https://github.com/YandexClassifieds/schema-registry/blob/7b7588e4927034cdfe1bdff603650af9c4453954/proto/vertis/vasgen/document.proto#L35)
и группируются в [QualifiedBatch](https://github.com/YandexClassifieds/schema-registry/blob/7b7588e4927034cdfe1bdff603650af9c4453954/proto/vertis/vasgen/document.proto#L42).
Полученные `QualifiedBatch` записываются в kafka-топик vasgen'а `vasgen-indexer`.

Каждая партиция топика `gost-offer-updates` обрабатывается независимо от других партиций. При этом на 
каждом шаге обработки сообщений сохраняется порядок в рамках одной партиции.

Каждый следующий `QualifiedBatch` записывается в топик при выполнении **хотя бы одного** из двух условий:

- **N** `RawDocument` готовы к отправке
- С момента записи предыдущего `QualifiedBatch` прошло **M** единиц времени и текущий батч не пуст

#### Конвертация из `OfferView` в `RawDocument`
- Версия `RawDocument` (поле `version`) соответствует полю `updated_at` объявления. 
- Для получения информации о категории и атрибутах `scheduler` использует [public-api сервиса bonsai](../bonsai/public-api) 

Необходимо учитывать, что конвертация из `OfferView` не всегда может завершиться успешно. Например:

- Информация, необходимая для формирования документа, была перемещена в другое поле proto-сообщения. 
`search-scheduler` уже скомпилирован и запущен с новой версией proto-сообщения, но в топике `gost-offer-updates`
остались непрочитанными старые сообщения.
- Была допущена ошибка в сервисе [gost](../gost) и в `OfferView` не заполнены поля, 
необходимые для конвертации в `RawDocument`.
- [public-api сервиса bonsai](../bonsai/public-api) недоступно.

Решить данные проблемы призвано следующее поведение сервиса:

1. Происходит попытка конвертации `OfferView`, прочитанного из топика `gost-offer-updates`.
 
2. При неудачной конвертации сервис обращается за актуальной версией объявления к [api сервиса gost](../gost/api). 
Таким образом, если в топике `gost-offer-updates` находится объявление в некорректном/устаревшем формате,
то для конвертации будет использован корректный `OfferView` из сервиса `gost` (при условии исправности `gost`). 
Данная логика приводит к потенциальному переупорядочиванию порядка обработки версий одного объявления.
Это не является проблемой, так как в индексе сервиса `vasgen` будет использоваться документ с наибольшей версией.

3. Если предыдущие шаги завершаются с ошибкой, то весь процесс конвертации данного объявления
будет повторен снова через определенное время. Последующие объявления в данной партиции не будут
обработаны, пока данное объявление не будет успешно сконвертировано.

## Поиск

[gRPC service](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/general/search/api.proto)

API отвечает за формирование запросов в `vasgen` и преобразование ответа.
Помимо результатов поиска API возвращает список фильтров для сужения выдачи.

### Схема работы
Внутри `vasgen`'a реализован один `ExecutionPlan`, выполняющий поиск объявлений с пагинацией и поиск категорий, подходящих под запрос.

1. Если в запросе передан текстовый запрос и не выключен [опечататочник](https://wiki.yandex-team.ru/misspell/), прогоняем запрос через него, иначе сразу переходим к пункту 2.
2. Преобразуем [SearchOffersRequest](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/general/search/api.proto#L17) в 
[ExecutionRequest](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/vasgen/grpc/search.proto#L25) и делаем 
[Execute-запрос](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/vertis/vasgen/grpc/search.proto#L25) в `vasgen`.
4. Обогащаем категории из ответа атрибутами через public-api `bonsai`.
5. Пересекаем все полученные множества атрибутов.
6. Для каждого атрибута из пересечения формируем 0 или 1 поисковый фильтр. 
Id фильтра формируем таким образом, чтобы не было пересечений с id стандартных фильтров.
7. Для каждой категории определяем множество стандартных фильтров и пересекаем все полученные множества.
Пересечение необходимо, так как некоторые категории имеют особые стандартные фильтры
(например, такими категориями являются наследники категории "Работа").
8. Объединяем все атрибутивные фильтры (из пункта 6) и стандартные фильтры (из пункта 7). 
9. Преобразуем полученные ответы в [SearchOffersResponse](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/general/search/api.proto#L27).

### Пересечение множеств атрибутов
Предполагаем, что не существует категории, два атрибута которой имеют одинаковые имена. 
Это исключает коллизии имен у фильтров, сгенерированных из атрибутов.

### Обогащение объявления CTR
Хотим ранжировать выдачу с учетом CTR. Для этого нужно при индексации обогащать документ этой информацией.
Статистика просмотров считается аналитиками и выгружается в YT в виде 2 таблиц: 
1) данные CTR для каждого объявления, просмотренного недавно (например, за последнюю неделею).
2) объявления просмотренные за последний час (множество таблиц с данными за каждый час)
Пошаговый алгоритм:
1) Периодическим процессом с помощью PushData мы перекладываем данные из таблицы 1 в YDB.
2) Каждая переливка в YDB имеет свою эпоху(=timestamp), хранящуюся в первом столбце. 
3) Текущая эпоха запоминается в generic_storage. 
4) С помощью PushData мы перекладываем данные из почасовых таблиц в очередь на YDB
5) Время переливки почасовых таблиц запоминается в generic_storage (чтобы в следующий раз перелить только новые).
6) Объявления из очереди пишутся втопик vasgen, обогащаясь данными из таблицы YDB в соответствии с текущей эпохой из generic_storage.
7) Отдельным периодическим процессом из таблицы с CTR удаляются все эпохи кроме текущей.