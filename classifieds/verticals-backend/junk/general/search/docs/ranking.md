# Ранжирование

Ранжирование нужно чтобы отсортировать поисковую выдачу по некоторой "релевантности", переместив самые важные документы наверх, а неважные вниз.
Для каждого документа "важность" высчитывается независимо, и получается некоторая чиселка, по которой документы сортируются.
Во время расчетов неизвестно какие документы будут на соседних местах, поэтому с помощью ранжирования невозможно сделать "разнообразие" (убрать заспамленность выдачи однотипными документами).

## Факторы

https://doc.yandex-team.ru/Search/saas/saas-overview/concepts/rank-gen.html
https://wiki.yandex-team.ru/jandekspoisk/saas/factorsinfo/

Факторы делятся на несколько видов:

### Статические факторы документа

Эти факторы формируются во время индексации и в дальнейшем не меняются без переотправки документа.

Примеры:

- ctr объявления
- фидовость оффера
- наличие картинок

ВАЖНО! такие факторы должны быть определены в конфиге saas'а, иначе сообщение с документом будет отброшено.
Текущий конфиг можно посмотреть на этой странице:
https://saas-mon.n.yandex-team.ru/service_info?service=vasgen_search_lb&ctype=stable

### Динамические факторы

Факторы которые формируются комбинацией данных запроса и документа.
Примеры:

#### dssm фактор

Получается перемножением embedding'а запроса и embedding'а тайтла документа.
Является одним из самых сильных факторов для полнотекстового поиска.

#### Refine factor

Передается в запросе. Позволяется указать значение конкретного фактора (даже не указанного в конфиге саас-а) для документа, если он удовлетворяет определенному условию.

Через этот механизм сделан "бустинг категорий". Отдельный классификатор определяет категорию, которая лучше подходит для заданного запроса, и выставляет специальный фактор для объявлений из этой категории. Этот фактор учитывается в формуле и повышает релевантность данных объявлений.

### Пользовательские факторы

https://wiki.yandex-team.ru/jandekspoisk/saas/factorsinfo/user/

Это факторы, которые передаются в запросе.
С помощью них можно передать какой-нибуть фактор про пользователя. Например, его пол или доход из крипты.

Либо скомбинировать несколько факторов из запроса и документа с помощью некой хитрой формулы.
Для пользовательских факторов можно использовать функции, которые недоступны для полинома.

ВАЖНО! сейчас нет поддержки пользовательких факторов в васгене

## Matrixnet модель

После вычисления всех факторов применяется mx модель, если она есть в конфиге.
Модель на входе принимает все факторы, и выдает чиселку, которая станет новым фактором.

Сейчас в SaaS можно использовать только matrixnet модель; модель Catboost'а можно сконвертить в Matrixnet модель, если там не используются ["категориальные фичи"](https://catboost.ai/docs/features/categorical-features.html).
Если возникнет нужда в категориальных фичах, то можно попросить реализовать их поддержку.

## Формула / полином

После расчета matrixnet модели, применяется полином. В нем возможно комбинировать факторы с помощью простых арифметических операций (сложение и умножение).
Обычно это линейная формула: складываются все известные факторы с какими-то коэффициентами.

Есть два представления полинома: человеческий и машиночитаемый.
Конвертить между представлениями можно на этой странице:
https://saas-mon.n.yandex-team.ru/polynom_converter?service=vasgen_search_lb

ВАЖНО! факторы, которых нет в полиноме не будут залогированы в наших event логах.
Так же этот фактор не будет вычислен, поэтому если он используется в пользовательском факторе, то его значение может быть посчитано неправильно.
Если вы добавили новый фактор, и через какое-то время хотите сделать новый полином на основе реальных значений, то следует добавить фактор в полином с нулевым коэффициентом.

ВАЖНО! факторы могут принимать любое вещественное значение, но результат полинома может принимать значение только в интервале [-10, 30]

## Прунинг

Основная статья: https://doc.yandex-team.ru/Search/saas/saas-overview/concepts/how-search-works.html?lang=ru

Смысл прунинга – ускорить сортировку, уменьшив число документов для который применяется Matrixnet модель.
Для прунинга надо определить отдельный полином, в котором должны быть указаны только статические факторы.
