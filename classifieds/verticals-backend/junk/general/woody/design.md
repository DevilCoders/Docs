# Woody (Woodpecker) Design Document

Сервис "простукивает" превалидированный полнотекст на количество соответствующих ему офферов по регионам. Формирует
url-ы для присутствующих на сервисе офферов. Полученные результаты используется для SEO

## Процесс:

1. Выгрузка данных по превалидированному полнотексту от аналитиков из YT

   #### Формат YT - таблицы аналитиков:

    - `cluster` — заголовок кластера запросов
    - `queries` — запросы, содержащиесся в кластере


2. Проверка заголовков кластера на количество активных офферов по всем регионам


3. Актуализация Postgres - таблицы бэкенда:
    - заголовок кластера есть в таблице — обновление запросов кластера
    - заколовка кластера нет в таблицее — добавление полной записи

   #### Формат Postgres - таблицы бэкенда:

    - `cluster` — заголовок кластера
    - `queries` — запросы кластера
    - `is_valid` — есть ли оферы по запросам
    - `statistics` — статистика по запросам(кол-во офферов по регионам)

      `PK = cluster`


4. Загрузка в YT непроверенных заголовков кластера для разметки "контентом": есть ли офферы по запросам на сервисе,
   подходящие ли офферы для поисковой выдачи

   #### Формат YT - таблицы для разметки контентом:

    - `cluster` — загоовок кластера


5. Выгрузка из таблицы в YT провалидированных "контентом" заголовков кластера. Актуализация Postgres - таблицы
   бэкенда (`is_valid` - столбец)

   #### Формат YT - таблицы ответа контента:

    - `cluster` — заголовок кластера
    - `is_valid` — + / -

6. Формирование snapshot-а Postgres - таблицы из валидных запросов


7. Формирование url-ов по регионам, где есть офферы, соответствующие запросам кластера. Загрузка в YT - таблицу

   #### Формат YT - табицы с url-ами

    - `cluster` — заголовок кластера
    - `queries` — запросы кластера
    - `region_offers_count` — кол-во офферов по регионам (id региона : кол-во оффееров)
    - `urls` - url-ы для каждого региона

## Компоненты:

### storage

- DAO для взаимиодействия с Postgres - таблицей

### scheduler

- GetPreValidateClusters task — загружает данные от аналитиков в Postgres-таблицу
- UploadUncheckedPreValidateClusters task — выгружает непроверенные кластеры в YT-таблицу для валидации
- DownloadCheckedPreValidateClusters task — забирает размеченные кластеры из YT-таблицы, обновляет
  Postgres-таблицу (`is_valid`)
- CheckOffersCountByRegion task — проверяет заголовки кластеров из Postgres-таблицы на количество офферов по регионам,
  обновляет Postgres-таблицу (`statistics`)
- UploadPreValidateQueriesSnapshot task — создает snapshot превалидировнных запросов и загружает его в s3
- UploadPreValidateQueriesUrls task — формирует таблицу в YT, содержащую url-ы по регионам, где есть офферы,
  соответствующие запросам кластера.

### public-snapshot

- Snapshot превалидированных запросов для использования в других сервисах 

