# Сервис хранения пользовательских профилей

## Компоненты
`general-user` состоит из двух частей – `API` и `scheduler`.

### Экспорт в топик
Экспорт происходит в режиме `at-least-once delivery`.

При модификации данных помимо таблицы `user` все изменения пишутся в нужный шард таблицы `queue`. 
Сам экспорт осуществляется одним или несколькими инстансами `general-user-scheduler`. 
Распределение работы происходит через `zookeeper` (с помощью `TokenDistributor`).
Каждый инстанс обрабатывает свою часть шардов, вычитывает батч изменений (начиная с самых старых) и пишет его в топик в параллель.
После этого весь батч удаляется из базы.

Важно, что батч не должен содержать изменения по одному пользователю.
В противном случае это может повлечь за собой реордеринг событий.

### Аккаунты продавцов
Для аккаунтов продавцов дополнительно храним:
- Описание
- Условия доставки и оплаты
- Режим работы
- Ссылка на сайт
- Публичные адреса
- Публичные телефоны
- Время создания аккаунта продавца (берем время создания паспортного профиля юзера)

В данный момент информация о магазине будет лежать в пользователе, который апгрейднулся до магазина.

## Хранение
Данные хранятся в YDB.

`user` – таблица с данными пользователя
 - `id: Int64` – PK, id пользователя (совпадает с id в `Я.Паспорт`е)
 - `proto: String` – данные пользователя в [protobuf](storage/proto/model.proto)-формате

 `PK = (id)`

`queue` – таблица для экспорта изменений в топик
 - `shard_id: UInt32` – PK, id шарда (`user_id % ShardNumber`)
 - `timestamp: Int64` – PK, unixtime изменения
 - `user_id: Int64` – PK, id пользователя
 - `proto: String` – данные пользователя в [protobuf](storage/proto/model.proto)-формате

 `PK = (shard_id, timestamp, user_id)`