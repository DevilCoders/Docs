# Trust Payment Gate
_оставь надежду всяк сюда входящий_

Общая страница [документации Trust](https://wiki.yandex-team.ru/TRUST/Payments/).

[Глоссарий траста](https://wiki.yandex-team.ru/TRUST/Payments/#terminologija)

Модель запросов и ответов Trust'a описываем [тут](https://github.com/YandexClassifieds/schema-registry/blob/master/proto/billing/trust/api_model.proto).

## TVM
Все взаимодействие с Trust'ом закрыто [TVM'ом](https://wiki.yandex-team.ru/passport/tvm2/).
При этом по client-tvm-id определяется не просто приложение, которое обращается к трасту, но и платежный терминал, по которому будет считаться выручка.
Почему так сделано - одному богу известно.

## Регистрация продукта

Все используемые продукты нужно зарегистрировать в рамках сервиса в Trust.
Сделать нужно это один раз через [ручку](https://wiki.yandex-team.ru/TRUST/Payments/API/Products/#sozdanieprodukta).

В дальнейшем при покупке в корзине нужно будет указывать лишь **product_id**. 
Поле **fiscal_name** будет использоваться в чеке оплаты, который будет отправлен пользователю Trust'ом.
При создании продукта можно также указать nds по умолчанию 


## Процесс покупки

Процесс покупки можно разделить на 2 вида:
1. покупка через форму оплаты
    - пользователь выбирает метод оплаты из доступных
    - вводит данные источника средств
2. покупка привязанной картой - покупка в один клик

### Покупка через форму оплаты

Покупку через форму оплаты нужно проводить в случае если у пользователя нет привязанных карт или
если пользователь явно выбрал форму оплаты.

В данном случае мы не фиксируем метод оплаты, пользователь будет выбирать его сам на форме оплаты.

После завершения оплаты Trust пришлет нотификацию о результате оплаты на ручку, которую мы указываем в поле _back_url_ при создании корзины.

Ниже представлена схема оплаты через форму оплат.

![Покупка через форму оплаты](trust_flow.png)

### Покупка с помощью привязанной карты
**В данный момент задизейблено.**
Чтобы включить оплату привязанной картой, нужно изменить _paymethodId_ при создании корзины в _DefaultTrustManager_.

Покупка привязанной картой производится в один клик и не требует дополнительных действий от пользовтеля.

![Покупка привязанной картой](../old-docs/PurchaseWithTiedCard.png)

Список привязанных карт пользователя можно получить из WebSdk и передавать в качестве метода оплаты при покупке.
То есть вся оплата сводится к единственному вызову метода _Purchase_, куда будет передан идентификатор карты в качестве метода оплаты.

## Кастомизация формы оплаты
Траст позволяет конфигурировать вид формы оплаты двумя способами: 
- задать параметры в **developer_payload** в реквесте на создание корзины на бэке(как сделано сейчас)
- или надо обратиться в траст чтобы они помогли [“завести репозиторий + пакет с отдельно формой для вашего сервиса”](https://wiki.yandex-team.ru/billing/trust/dev/ui/services/faq/#mozhemlimyvnositizmenenijasamostojatelnobezuchastijarazrabotchikoviztrust).

Для формы оплаты Объявлений, мы хотели по окончанию оплаты чтобы нам возвращалась форма в виде spin-а, поэтому сейчас захардкодили `paymentCompletetion = “spin”`. 
Это плохо, так как другие сервисы, которые будут использовать shop-api вполне себе захотят сделать другой вид формы. 
Поэтому **developer_payload** надо либо убрать, либо добавить отдельный параметр который все сервисы смогут сами передавать.

Если цель оставить shop-api максимально простым, то тогда стоит **developer_payload** выпилить, так как все сервисы могут это настроить через траст, но это будет долго и больно. Если мы хотим сделать shop-api более гибким, его можно оставить. 
Это будет хорошо для тех кому, как Объявлениям, надо менять только пару параметров, и тем кому это надо сделать срочно. 
Настройка вида формы через бэк будет гораздо легче и быстрее чем сетап фронта через команду траста.

## Известные проблемы
- trust отвечает `500: Internal error`, если не смог найти пользователя (вместо `404 Not Found`)
- Платежный терминал определяется из client-tvm-id. Поэтому все запросы в траст сейчас будут производиться "от имени" Я.Объявлений.
