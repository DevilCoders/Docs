# Сущности и сервисы

## Сущности

**User** - пользователь (autoru_uid, yandex_uid, smt_uid).
В сервисе представлен в виде строки.
Еще можно подумать над тем, чтобы хранить вместе с ним:
- его yandex_uid если есть
- его воплощение на сервисе (физик/юрик)

**Goods** - услуга, которая применяется к некоторому сервисному объекту (offer_id, dealer_id).

_ONE_SHOT_ - услуга без длительности.
_WITH_DURATION_ - услуга с длительностью.
_QUOTA_ - услуга с длительностью и счетчиком.
 
Нужно ли как-то типизировать object_id??

**ActiveGoods** - услуга, которая применена к сервисному объекту.

**Product** - объект покупки. В составе имеет непустое множество услуг (_Goods_).   

## Сервисы

### ProductRegistry
Реестр продуктов.

Единый реестр продуктов.
В него можно положить новый продукт либо поменять существующий.

Реестр хранит все изменения, в любой момент времени можно запросить любое состояние продукта в прошлом.
У каждого продукта есть его описание и номер ревизии и время, с которого эта ревизия действует.

Реестр по набору параметров (тип пользователя, регион, время, и тп) может выдать список доступных для покупки продуктов.

Пока такая же ракета, как и матрица цен :)

### PurchaseService

Сервис покупок.

### GoodsService

Сервис купленных и примененных услуг.

**Котел купленных услуг** - множество купленных, но еще не примененных услуг.   

**Котел активных услуг** - множество активных примененных услуг.

В оба котла можно заглянуть и поискать там услуги по набору фильтров.

Купленные услуги можно активировать(применить) к объекту.

Так же котел с купленными услугами можно рассматривать, как альтернативу промокодам на услуги.

### TransactionService

Внутреннее хранилище транзакций, не будет торчать наружу.


# Общий процесс покупки

Пока полный цикл покупки выглядит следующим образом:
1. Запрашиваем для конкретного пользователя доступные для покупки продукты
2. Запрашиваем доступные для пользователя методы оплаты
3. С выбранным методом оплаты делаем запрос на покупку продукта (продукт, метод оплаты, пользователь).
4. В ответ либо результат оплаты (успех/неудача), либо ссылка на платежную форму
5. Поллинг статуса покупки при необходимости.
 
В случае интеграции через траст процесс может упроститься: платежные sdk позволяют получить привязанные карты напрямую из Trust их сразу можно передавать в качестве метода оплаты.

Детали флоу оплаты, с точки зрения композитных платежей, холдов и коммитов:
1. Когда юзер нажал "оплатить", сервис дёргает создание покупки. Мы в ответ отдаём заводим покупку в статусе payment required и отдаём purchase url. Ещё ничего не холдируем.
2. Юзер оплачивает покупку, платёжный гейт холдирует средства и пушит в нас нотифай.
3. Мы холдируем средства в остальных системах, после этого переводим покупку в статус hold.
4. Теперь коммитим средства везде (в т.ч. в основном платёжном гейте, в котором юзер оплачивал), после этого переводим покупку в purchased.
5. Помечаем нотифай обработанным.
6. Заводим услуги в котле услуг и переводим покупку в APPLIED.

# Покупка со списанием бонусных баллов

Почти ничем не отличается от обычного платежа.
Нужно сделать разметку платежа: отображение из метод оплаты в сумму, которую нужно провести через этот метод оплаты.
Один из методов оплаты должен быть метод оплаты **yandex_checkout**.

Подробности как это выглядит со [стороны Траста](https://wiki.yandex-team.ru/TRUST/yandexaccount/#provedenieplatezhasospisaniembonusnyxballov). 

# Оплата в вебе
Документация: https://wiki.yandex-team.ru/trust/frontend/for-services/
## Интеграция через iframe 
Отстой и прошлый век предлагаю даже не рассматривать.

## Интеграция через WEB-SDK

### Trust

[Дока на sdk](https://github.yandex-team.ru/Billing/trust-web-sdk/blob/master/packages/base/docs/sdk-methods.md)
[Дока по интеграции](https://wiki.yandex-team.ru/trust/frontend/for-services/)
Из плюсов:
- нативная форма оплаты, в качестве параметра url на форму оплаты
- поллинг статуса оплаты напрямую из Trust (сомнительная штука)
- метод привязки/отвязки карты сразу sdk напрямую в Trust, минуя наш бэк

### YandexKassa

[Sdk](https://yookassa.ru/developers/payment-forms/other/yc-js).

# Оплата в Аппах

# Trust
У Траста для аппов есть [sdk](https://wiki.yandex-team.ru/users/a-kononova/paymentsdk/).

## ApplePay
Есть несколько вариантов интеграции.

Предлагаю использовать вот [этот](https://wiki.yandex-team.ru/TRUST/applepay/first_scenario/) :
- создается биндинг ApplePayToken в Трасте, через есть в PaymentSDK
- созданный биндинг содержит идентификатор метода оплаты, который можно передавать в качестве метода оплаты


#MVP

Что вообще нужно для запуска:
- ProductRegistry - пока достаточно в виде захардкоженного списка продуктов
- GoodsService
    - Котел активных услуг
    - Котел купленных услуг - пока можно пожить без него
- Интеграция с Trust

