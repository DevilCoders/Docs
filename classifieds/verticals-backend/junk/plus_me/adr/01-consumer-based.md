# Использование консьюмера кафка-топика с объявлениями

## Статус
Proposed

## Контекст
Задача сервиса – выдавать пользователю бонус (баллы плюса) 
за полезные действия (размещение объявления).
При этом должны выполняться некоторые условия:
 - пользователю еще не выдали бонус, или выдали достаточно давно.
 - объявление достаточно качественное и удовлетворяет некоторым условиям.
 - у пользователя есть привязанный аккаунт яндекса.

### Другие проблемы
#### Привязка аккаунта к яндексу
Пользователь может быть не привязан к яндексу, тогда выдать плюсы будет некуда.
Однако он может это сделать после размещения объявления, и в этом случае мы должны довыдать бонус.
Мы должны уметь это делать и периодически проверять что привязка не появилась.

#### Прозрачность для пользователя

Чтобы пользователь понимал что ему выдали баллы (их легко можно не заметить),
или понимал за что их выдали – ему надо об этом сообщать.
Так же полезно сказать ему что еще не хватает для выдачи, например, привязать яндекс к аккаунту или повысить качество объявления.
Для этого хорошо подойдут "пуши" и письма.
Для этого стейт-машина пользователя должна усложниться и включать состояния когда бонус уже можно выдать, но еще не смогли.
Так же надо мониторить состояние аккаунта пользователя и следить когда привязка к яндексу появится.

#### Фрод
Если раздавать деньги, то скоро этим начнут пользоваться нехорошие люди.
Например, они могут создавать объявления про машины, которых не существует.
Чтобы хоть как-то от этого защититься, то можно сделать временную задержку, после которой начислится бонус.
Задержка позволит модерации забанить очевидный мусор.

## Варианты

### batch обработка
Раз в сутки запускать batch задачу (например джоба в yt'е).
С учетом требований необходимо будет реализовать несколько batch-задач: отдельно для каждого вида пушей и отдельно для выдачи промокода.
Систему из нескольких задач тестировать и понимать достаточно сложно, поэтому этот вариант нам не подходит.

### Консьюмер топика с полезными событиями
Если представить каждого пользователя как актор, события – как сообщения ему, а пуши и начисления – как сообщения от него,
то получится реактивная система, которая может питаться событиями записанными в кафку.

Плюсы: 
 - просто тестировать
 - просто расширить
 - реактивно (от создания события до реакции может пройти всего несколько минут) 

Минусы:
 - необходимо хранить стейт в базе
 - при изменении логики может понадобиться какая-то миграция стейтов в базе

### Стейдж в vos'е
Написание стейджа в восе считается самым быстрым способ сделать какую-нибудь фичу, 
потому что не требует написания слоя хранения данных.
Основное ограничение которые накладывают стейджи – вся логика должна происходить в контексте одного объявления.

Поэтому для решения текущей задачи они подходят слабо – синхронизация между объявлениями всё равно должна происходить в каком-либо хранилище.


## Решение
В текущий момент вариант с консьюмером выглядит самым оптимальным. Он и будет реализован.

## Последствия
Задача очень сильно напоминает ту, которая стоит перед командой спамалота.
Возможно в дальнейшем эти два сервиса сольются.
