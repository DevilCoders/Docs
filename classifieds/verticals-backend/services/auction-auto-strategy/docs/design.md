auction auto strategy design doc

## Терминология
**Контекст аукциона** - внашем случае это набор свойств по которым работает аукцион для auto.ru это регион марка и модель

##Проблема
###Как сейчас
На текущий момент, дилеру приходится в ручную отслеживать изменение ставок в аукционе, или же пользоваться услугами агенств, у которых уже реализованы автостратегии.
### Зачем

Базовая задача   VERTISQ-342 Беклог Аукцион звонков в новых: автостратегии.

Пока рассматриваем конкретную задачу автостратегии для аукционов на звонки в Авто.ру. В целом, механизм выглядит общим и будет полезным для проведения любых аукционов в других продуктах.

наши цели:
- Мы конкурируем с агентствами для дилеров, поэтому у нас должно быть не меньше функционала
- Сделать функционал лучше, чем у агентств, потому что именно мы обладаем всеми данными и можем предложить клиентам больше, чем агентства
- Сделать продукт более удобным для клиентов и, потенциально, зарабатывать больше

###Примеры стратегий
В рамках MVP будем делать только один алгоритм, который будет занимать самое высокое место в рамках заданного бюджета.

Другие автостратегии, которые рассматривали, но пока не делаем:
- Занимать 1-е место в аукционе или выходить из аукциона;
- Платить не более, чем X шагов аукциона (100 руб.) за определенным местом в аукционе с ограничением стоимости звонка (полезно, когда между текущей позицией и следующей разрыв значительно больше, чем минимальный шаг - клиенту нет смысла переплачивать);
- Удерживать на определенной позиции весь бренд (группу компаний);
- Удерживать позицию в топ-5 аукциона
##MVP
  Текущая реализация предполагает что это будет MVP с основным ограничением 
* Только один алгоритм автостратегии - максимальная позиция в рамках заданных ограничений по максимальной ставке
* Если ставки в аукционе начинают падать то в рамках автостратегий они тоже будут опускаться
###Алгоритм автостратегий в рамках MVP 
Максимизируем место дилера в аукционе за его бюджет: клиент указывает максимальную стоимость звонка, которую он готов заплатить, а робот делает такую ставку, чтобы за данный бюджет занять лучшее место.
При этом :
1) Ставка определяется подобно аукциону ["второй цены"](https://oneretarget.com/ru/wiki/аукцион-второй-цены-в-rtb/#%3A~%3Atext%3DАукцион%2520второй%2520цены%2520%28Second-Price%2Cцент%2520%28заранее%2520определенная%2520надбавка%29.): клиент платит ставку, равную максимальной цене звонка конкурента + минимальный шаг аукциона (100 руб.).
Клиент, имеющий наименьшую "максимальную цену", заплатит ставку, равную базовой стоимости звонка + минимальный шаг.
![Пример результата работы алгоритма](image.png "Пример результата работы алгоритма")
   
2) Клиенты не могут установить одинаковую максимальную цену: например, если уже есть "7000", то можно поставить только 6900 или 7100, чтобы можно было занять абсолютное место.
3) Роботы играют не только с теми, кто включил автостратегию:
   Если кто-то из клиентов перебьет текущую максимальную фактическую ставку, то робот автоматически поднимет ставку клиентов в пределах максимальной цены за звонок.
![пример рачсета после изменения цены](image_1.png)
4) Если ставки или макс. цены конкурентов снижаются, то фактические ставки также корректируются вниз.


##Сценарий использования
- Просмотр состояния аукционов.
   1) Пользователь заходит на страницу управления аукционами. Видит текущее состояние по всем маркам/моделям.
   2) 2) Для каждой строки видит значок автостратегии, где она присутствует, и кнопки изменить и удалить
   3) При этом если у клиента включена автостратегия то он не делает ставки по аукциону в рамках заданного контекста. Чтобы продолжить работать в аукционе он должен удалить автостратегию 

-) добавление/изменение/удаление автостратегии
   1)  При добавлении автостратегии всплывает попап в котором выбирается автостратегия которой он хочет пользоваться (сейчас будет только одна так что можно убрать возможность выбора)
   и настройки этой стратегии (сейчас будет стоять только максимальная ставка). на этом попапе будет 2 кнопки сохранить и применить автостратегию.
   2) После нажатия кнопки применить автостратегия автоматически начинает работать
   3) При изменении автостратегии открывается тот же попап только уже заполненый и с 3мя кнопками Сохранить, Отменить, Удалить. Пользователь может поменять настройки автостратегии
   4) Если пользователь нажал кнопку Удалить автостратегию то ему вылезит попап чтобы он подтвердил удаление
   5) Также в меню настроек автостратегии нужно будет показывать ставки и активности других игроков. Это будет нужно для запрета делать существующию максимальную ставку (делает фронт у себя но на всякий случай мы дублируем).  

##Требования
###Функциональные требования
* после изменения аукциона данные должны быть пересчитаны в течении 30 минут
* пользователи не должны иметь возможности создать автостратегии с максимальной ставкой которая уже существет в других автостратегиях
* пользовтель в рамках одного контекста аукциона может иметь только одну автостратегию
###Нефункциональные требования
* Максимальное кол-во уникальных контекстов аукциона 1 500
* Максимальное кол-во автостратегий 100 000
* Максимальное кол-во участников в одном контексте 100 участников на один контекст (100 000/1 500 ~= 100 )
* Данные в контексте могут меняться ~1000 раз в минуту(взято из метрики топика откуда будем читать)



## Данные для расчета нагрузки
* На текущий момент уникальных контекстов за август 2021 было ~350. При этом кол-во контекстов где делалось более 50 ставок за месяц было ~40 из них максимум было ~1000 ставок в месяц
* Максимальное кол-во уникальных контекстов аукциона 1 500
* Максимальное кол-во автостратегий 100 000
* Максимальное кол-во участников в одном контексте 100 участников на один контекст (100 000/1 500 ~= 100 )
* обновление оферов в вос в среднем 1000 событий в минуту. 
* Успевать пересчитывать все автостратегии за отведенное время (в рамках mvp не более 5 минут). Если будет сильно большая нагрузка, сможем параллельно пересчитывать несколько контекстов.
* Доступность сдесь не сильно критичная особенно у апи но предполагается создание алертов. Тоесть если таска пересчитает все контексты не за 1-5 минут а например за 10, или если апи будет недоступно неоторое время например во время перезапуска


##Краткое описание решения

![схема решения](mainBlockSchema.jpg?raw=true "схема решения")

Механизм работы автостратегий делится на несколько основных частей
1) Апи для настроек автостратегий
2) Получение и обновление информации о контекстах которые нужно пересчитать
   * журнал изменения ставок аукциона
   * журнал изменения даннных об оферах автомобилей 
3) пересчет автостратегий: 
  * Периодический запуск пересчета автостратегий 
  * Получение состояния аукциона 
  * Расчет автостратегий



##Потенциальные проблемы
### Лаг между данными vos и searcher
Для получения состояния аукциона, мы проверяем в searcher-е наличие объявлений пользователя для контекста аукциона. Если объявлений нет, то ставка не учитывается при расчете.
Проблема: обновления статусов объявлений мы получаем из vos (у серчера нет нужного механизма). Но в выдаче searcher-а, эти изменения появятся через 5 - 10 минут. В результате, мы можем запустить пересчет, но в процессе получить из searcher-а старые данные.

## Полное описание работы автостратегий
### Работа с настройками автостратегий
Все настройки будут храниться в БД структура будет состоять из 2х таблиц
1) Context хранит информацию о контексте и времени изменения данного контекста
2) User_settings хранит настройки автостратегии пользователей.

структура таблиц
```
create table context (
`id` BIGINT unsigned NOT NULL AUTO_INCREMENT,
project varchar(10) not null COMMENT "название проекта в аукционах сейчас это может быть autoru,realety и другие",
product varchar(32) not null COMMENT "название продукта в аукционах сейчас это call",
context varchar(900) not null COMMENT "серилизованный контекст в виде json или proto обьекта",
last_update DATETIME(6) NOT NULL DEFAULT NOW(6) COMMENT "Время когда были произведены последние модификации с какимнибудь офером или ставкой в аукционах в рамках контекста",
CONSTRAINT PRIMARY KEY (`id`),
CONSTRAINT UNIQUE KEY `project__product__context` (`project`, `product`, `context`)
)
ENGINE = InnoDB
DEFAULT CHARSET = utf8
DEFAULT COLLATE = utf8_general_ci
;

create table user_settings(
`id` BIGINT unsigned NOT NULL AUTO_INCREMENT,
user_id varchar(255) not null COMMENT "уникалный идентификатор пользователя кто участвет в аукционах например dealer:23442",
context_id BIGINT unsigned REFERENCES context(id),
auto_strategy_type varchar(255) not null COMMENT "тип автостратегии",
settings MEDIUMTEXT not null COMMENT "все настройки автостратегий серилизованные в виде json",
CONSTRAINT PRIMARY KEY (`id`),
CONSTRAINT UNIQUE KEY `user_id__context_id`(`user_id`, `context_id`)
)
ENGINE = InnoDB
DEFAULT CHARSET = utf8
DEFAULT COLLATE = utf8_general_ci
;
```

Для пользователя будут предоставлены 4 основные ручки в паблик апи которые будут запрос просто пробрасывать из паблик апи в в сервис аукционов
1) Включение автостратегий
   через рест апи получаем контекст + тип автостртегии пользователя + настройки автостратегии
   затем либо создаем контекст либо получаем id существующего
   после добавляем запись в таблицу настроек пользователя
   затем обновляем поле last_changes в таблице контекст

2) Удаление автостратегий
   удаляем автостратегию из таблицы пользователя user_settings
   проверяем можем ли мы удалить данный контекст из таблицы автостратегий если да то удаляем
   если при удалении контекста мы получаем ошибку о том что данный конекст уже используется (например кто то добавил новые настройки) то мы просто логируем запись и игнорируем ошибку

3) список всех автостртегий пользователя
   данная ручка возвращает список всех автостратегий пользователя по всем контекстам
   она будет нужна на странице всех его оферов чтобы сразу пометить какие из них стоят с включенной автостратегие

4) список всех автостратегий по заданому контексту
   Данная ручка возвращает список все настройки всех пользователей для заданого контекста.
   Будет использованна например для фронта чтобы в текущей стратегии не дать нескольким пользователям сделать одинковую ставку (данный функционал нужно будет продублировать на беке чтобы не получить расхождения в бд) 

5) получение настроек пользователя по контексту
   Возвращает настройки одной австостратегии по заданому контексту. Будет нужен для отрисовки текущих настроек автостратегии 
   
#### Алгоритм создание автостратегий
1) Пользователь для выбранного контекста аукциона выбирает одну из доступных автостратегий и заолняет значения
2) Далее отправляется запрос в ручку public-api в которой подготавливается запрос для автостратегий (автостратегии сами по себе не чего не знают о моделях авто ру для них контекст аукциона это просто набор параметров) подготавливается контекст и устанавливается проект (авто ру ) и услуга (у нас пока только звонки)
3) приложение автостратегий изначально проверяет есть ли у пользователя уже вавтостратегия если есть кидает ошибку так как пока на один контекст аукциона можно установить только одну автостратегию
4) проверяем существует ли контекст аукциона, проект и продукт в базе автостратегий если его нет то создаем
5) создаем запись в базе настройки пользователя для зааноого контекста
6) возвращаем пользователю его сохраненые настройки
#####Риски
1) Будет недоступна база не сможем временно сохранять записи не так страшно пользователю покажется ошибка и он заново перезапишет и сценарий маловероятен
2) Временая недоступность апи например когда сеть флапнула будет решаться тем что сделают запрос еще раз

####Алгоритм удаление из автостратегий
1) пользователь наживает в вем форме удалить автостратегию
2) приходит http запрос в public-api и там уже подготавливается grpc запрос в автостратегии
3) после получение запроса на удаление настроек австостратегии мы находим контекст если его не нашли то просто отправляем OK так как удалять не чего
4) удаляем настройки автостратегий для данного пользователя
5) удаляем контекст из базы автостртатегий если больше не осталось пользователей которые используют этот контекст

#####Риски
1) Те же проблемы что и при создании проблемы сети и проблемы базы

###Чтение журнала с событиями аукциона
1) подключаемся к брокеру событий аукциона (топик кафки broker-vsmoney-auction-bids)
2) читаем сообщения и сразу пропускаем те которые были сгенерены автостратегиями (проверяем по полю source )
3) берем сообщение извлекаем из него контекст аукциона, продукт и проект
4) по извлеченым данным контекст аукциона, продукт и проект пытаемся обновить время в клонке change_time таблицы context
####Риски
1) в случае какогото ошибочного сообщения в кафке можем прекратить обновлять время обновления нужного контекста. Для этого надо делать еще один топик кафки с ошибочными топиками который будем разгребать потом в ручную

###чтение событий изменений оферов
Все события об изменении оферов будут читаться из воса. В серчере нет механизма для выгрузки изменений в выдаче. Создание такого механизма - от 2-х недель. Так что алгоритм работы будет таким:

1) подключаемся к событиям изменения оферов топик кафки vos2-auto-offer-updates
2) отфильтровываем только те сообщения где офер либо опубликовался либо удалился
3) извлекаем данные контекста аукциона далее устанавливаем для всех сообщений product=call и project = auto.ru
4) по извлеченым данным контекст аукциона, продукт и проект пытаемся обновить время в клонке change_time таблицы context
####Риски
1) в случае какогото ошибочного сообщения в кафке можем прекратить обновлять время обновления нужного контекста. Для этого надо делать еще один топик кафки с ошибочными топиками который будем разгребать потом в ручную
2) Риски расхождения данных вос и сечера. для этого закладываем время на которое может отстать индекс сечера чтобы обновить данные 

###Пересчет ставок аукциона (запуск автостратегий)
1) раз в N минут запскается таска которая будет пересчитывать ставки
2) Получаем время успешного предыдущего запуска из Zookeeper (lastProcessingTime)
3) достаем список все контекстов у которых change_time > lastProcessingTime - M а также время когда мы достали эти данные
   (где M это время которое мы используем как максимальное время задержки между отправкой даннх восом в сечер и обновлением индекса сечера)
   (время когда мы достали данные понадобится нам чтобы обновить lastProcessedTime в zookiper точно и не получить сдвиг например из за разницы системного времени сервера mysql и локальным временем приложения)
4) все полученые контексты перебираем по очереди
5) сначало идем в сервис аукционов и достаем все актуальные ставки по контексту аукционов
6) идем в поиск и получаем список дилеров чьи оферы прям сейчас есть оферы по заданому контексту аукциона
7) отбрасываем ставки дилеров у кого нет активных офреов в поисковой выдаче
8) извлекаем все автостратегии по заданому контексту
9) проверяем надо ли вообще пересчитывать автостратегии например у нас не осталось дилеров которым надо пересчитать цену
10) запускаем пересчет автостратегий(алгорим пересчета будет описан позже) на выходе получаем список действий которые надо выполнить в аукционе (изменить ставку, выйти из аукциона, ни чего не делать)
11) отправляем запросы в аукцион
12) После пресчета всех автостратегий мы обновляем lastProcessedTim в zookeeper его значене берем из достатого раньше ремени из бд
####Риски
1) может разьехаться время пересчета - решаем получением актального времени из базы до начала пересчета
2) могут разьехаться данные у нас и в сечере - решаем тем что контексты пересчитываются не только между запусками джобы но и со сдвигом по времени чтобы они успели попасть в сечер

##Проблемы и нюансы
1) В сечере есть так назваемые подписки но их использовать не можем так как в них мы не сможем нормально найти события снятия оферов и отделить события появления оферов поэтому используем топик кафки воса где будут отображаться все изменения и мы их будем фильтровать по изменению статуса офера (в топике есть поле statusDiff)
2) так как данные в кафке воса отстают от индекса сечера примерно на 5 минут то мы будем пересчитывать автостратегии у контекстов аукционов не только изменениые контексты за время между запусками таски пересчета,но и за 20 минут до предыдущего запуска пересчета(Как понял это то время когда сечер должен успеть обновить индекс).
3) Чтобы небыло расхождения во времени работы приложения и бд перед пересчетам автостратегии мы получаем текущие время на сервере mysql и потом его сохраним в zookeper да возможно какието контексты мы пересчитаем 2жды но это не страшно так как при пересчете контекстов мы уже будем учитывать лаг и пересчитать 2 раза менее страшно чем пропустить вообще
  * Также расматривали вариан что раз в N времени(например раз в час) будут пересчитаны все автостратегии. Но решили пока сделать тем вариантом   


##Сопровождение
###Мониторинг
Предлагаю сделать отдельный дашборд со всеми метриками автостратегий
1) Нагрузку на grpc сервисы можно взять из стандартных настроек
2) Кол-во событий поступивших из аукционов
3) Общее кол-во событий которое поступило от воса и кол-во сообытий которые остались после фильтрации событий воса
4) Кол-во обработанных контекстов аукционов за промежуток времени (например 10 минут)
5) Отстование в обработке контекстов
6) Кол-во событий с изменением контекста отправляемых в аукцион
7)(Под вопросом возможно не стоит делать) Добавить возможность отслеживать кол-во дилеров которые есть в аукционе но еще их нет в поиске
8) Ошибки обработки событий из кафки
###Алерты
1) основной алерт будет на отставание пересчета контекста (должны успевать за 5 минут все пересчитывать).
   * Если мы не укладываемся в 5 минут но все еще укладываемся в 15 то алерт посылать только в слак и телегу (это будет означать что пора что то сделать с нагрузкой)
   * Если мы не успеваем даже за 15 минут то тут серьезно и надо помимо отправки в телегу и слак делать эскалацию на телефон дежурного
2) Алерт на ошибки обработки данных аукционов
3) Алерты на ошибки обработки данных из кафки вос
 

###Логи
   Оснновное предназначение логов будет нужно чтобы мы могли понять почему была сделанна определенная ставка от автостратегий поэтому в логах нужно отобразить следующие
1) Список контекстов который мо обновляем и почему
2) Логируем все события которые поступают на вход grpc сервера
3) Логируем полностью таску которая будет пересчитывать контексты там будет несколько логов но главное чтобы потом их можно было отыскать по какомуто полю типа requestId 
  * Для каждого пересчитываемого контекста должны логироваться все начальные параметры
  * Полностью должна логироваться логика работы автостратегии и чтобы ее можно было связать с начальными параметрами
  * Полностью должен залогироваться список действий которые будут совершать в автостратегии со ставкой дилера

###Доступность для аналитики
Аналитики все данные будут получать из howmatch, туда будет добавленно поле source и в нем будет описание кто сделал ставку задача https://st.yandex-team.ru/VSMONEY-3376

###Нагрузка
1) Нагрузка на API будет незначительной: если отсечь по верней планке, то не более 5 rps
2) Нагрузка на таску которая читает изменение ставок аукционов судя по статистике в ((https://grafana.vertis.yandex-team.ru/d/y80eRBz7z/auctionbidsgrpchandle?orgId=1&from=now-7d&to=now графане)) максимум что может быть это несколько событий в секунду
3) Нагрузка на таску которая читает данные об изменении оферов будет до 1000 событий в минуту судя по ((https://grafana.vertis.yandex-team.ru/d/000000589/kafka?orgId=1&refresh=10s&viewPanel=4 графику)) топик vos2-auto-offer-updates 
   но возможно большую часть из этих событий мы отфильтруем так как по тому графику показываются все изменения в оферах а нас интересуют только список события добавления и снятия офера из выдачи
4) нагрузка на базу с учетом цифр полученых из графков ((https://grafana.vertis.yandex-team.ru/d/y80eRBz7z/auctionbidsgrpchandle?orgId=1&from=now-7d&to=now аукционов) и ((https://grafana.vertis.yandex-team.ru/d/qwF0tk47z/auto2-shard?orgId=1&viewPanel=21 сечера)) и округнлив все по верхней границе получаем
   4.1) В таблице со списком контекстов будет максимум 1500 записей и нагрузка на обновление доходить до 250 запросов на изменение в секунду. Запросы на чтение будут получаться только из апи и таски на пересчет контекстов и судя по логам там будет максимум до нескольких запросов в минуту
   2.2) Таблица с настройками автостратегий будет содержать максимум 100 000 записей и будет обновляться только пользователем раз в несколько минут через апи а считываться один раз в несколько минут

####Добавление вертикального маштабирования
Если вдруг таска будет неуспевать пересчитывать все процессы за заданное время можно будет начать пересчитывать чанками в паралель например по 10 или 100 штук 
####Добавляение горизонтального маштабирования
Если мы не сможем в рамках одной ноды пересчитывать все контексты то придется сильно переписать код и для этого есть 2 варианта
1) выносим пересчет отдельного контекста в отдельный сервис и мастер таска будет только выгребать данные и отправлять их на различные сервисы.
2) делаем партиционирование через БД но сдесь надо будет доделать следющие 
 * Добавить нову калонку партиционирания в бд 
 * Написать таску чтобы все контексты нормально репартиционировались раз в некоторое время (иначе может получиться так что большая часть сложных запросов свалится в одну ноду) 
 * нужно будет доработать таску которая пересчитывает контексты чтобы она пересчитывала только нужную партицию. Распределение партиций по нодам можно например сделать будет через zookeeper
 



##Дальнейшее развитие
* Добавление новых типов автостратегий
* появление новых проектов/продуктов
* расширение объемов аукцинов в звонках. Рост нагрузки на расчет автостратегий.



##Задачи
1) добавление поля source в аукционы  https://st.yandex-team.ru/VSMONEY-3376
    * добавляем в прото модель  https://st.yandex-team.ru/VSMONEY-3378
    * добавляем поддержку в сами аукционы https://st.yandex-team.ru/VSMONEY-3379
    * добавляем в паблик апи https://st.yandex-team.ru/VSMONEY-3380
    * Пробрасываем значение source в howMatch https://st.yandex-team.ru/VSMONEY-3383
    * доработка сервиса howmatch чтобы принимал тип источника https://st.yandex-team.ru/VSBILLING-4923

2) переделывание ручки с получением контекста  https://st.yandex-team.ru/VSMONEY-3386
    * правим прото модель создаем без пользователя  https://st.yandex-team.ru/VSMONEY-3393
    * реализуем логику в аукционах и деплоим их https://st.yandex-team.ru/VSMONEY-3394

3) Создание модуля автостратегий в монорепозитории (сделанно )
   3.1 также внутри нужно создать несколько подмодулей api, converters, model, scheduler, services, storage
4) Создание протом моделей и ручек в автостратегиях в schema-registry (готов пр)
5) Реализовать Апи в монорепе пока заглушками (готов надо тесты)
6) Подключить работу с кафкой в монорепу (сделанно подключил и считал данные из топика аукционов)
7) Создать БД в проде и деве руководствуюясь следующими настройкми размер базы будет не сильно большой (1500 одна таблица и 100 000 в другой)но будет много чтений по индексу до 300rps из малой таблицы и возможно много update по игдексу https://st.yandex-team.ru/VSMONEY-3392
8) затащить mysql в монорепу (частично сделал надо добить)
   8.1) сделать модель контекста
   8.2) сделать модель настроек пользователя
   8.3) псевдомодель которая будет возвращать время в mysql
9) написать сервис ContextService с методами (сделал надо добить базу и заработает)
10) написать таску которая будет читать топик кафки аукционов и обновлять значение changeTime  (осталось добавить филтрацию)
11) написать таску которая будет читать топик кафки воса и обновлять changeTime
12) сделать таску которая будет раз в N ремени вычитывать все контексты и отправлять их напересчет
13) сделать сервис который будет пересчитывать автостратегии по заданому контексту
14) реализовать работу апи отдельно будут список задач (как mysql будет почти сразу все заведется останутся только тесты)
15) настроить метрики и алерты
    15.1) добавить метрики для таски вычитывания данных из аукционов
    15.2) добавить метрики для таски вычитывания данных из воса
    15.3) добавить метрики для таски которая пересчитывает контексты
    15.4) добавить метрики для апи
    15.5) Добавить алерты на 500 в апи, добавить алерты на сильное отставание в пересчете автостратегий также добавить алерт на сильно долгий расчет автостратегии для одного контекста больше 1 минуты

16) Проверить логирование работы пересчета автостратегий и их работы если надо дописать
17) завести деплой в шиву
    написать карту сервисов и манифест деплоя
 

