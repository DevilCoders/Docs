## Оптимизации финстаты

При разработке финстаты мы столкнулись с большими таймингами запросов в кликхаус.
В итоге, проблему решили добавив сортировку таблиц по кастомным колонкам (по которым потребителям нужно фильтровать данные).
Но пока мы думали об оптимизациях, родились несколько идей, которые мы решили не реализовывать из-за ненадобности.
Этот файл содержит список придуманных оптимизаций (на случай, если нужно будет еще оптимизировать финстату).

1) Увеличить ресурсы кликхауса (класс хоста).
2) Добавить еще реплик в кликхаус.
3) Добавить кэш для ответов на запросы.
4) Попробовать прикрутить матвью. Есть подозрения, что в кликхаусе каким-то образом можно сделать матвью с дедупликацией (ссылки в помощь: [раз](https://guides.tinybird.co/guide/deduplication-strategies#using-materialized-views) и [два](https://stackoverflow.com/questions/65980332/create-materialized-view-based-on-aggregate-materialized-view)). Непонятно, как это работает (и работает ли), но с этим можно попробовать разобраться, если потребуется.
5) Добавить колонку с датой и фильтровать/группировать по ней, а не по event_time. Сейчас в группировке используется что-то типа `formatDateTime(toDate(event_time), '%Y-%m-%d', 'Europe/Moscow')`. Вероятно, это не очень эффективно. Тикеты в помощь: [раз](https://st.yandex-team.ru/VSBILLING-5322) и [два](https://st.yandex-team.ru/VSBILLING-5329).
6) Избавить от [внутреннего селекта в запросе в кликхаус](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/finstat/storage/src/query/DeduplicatedTable.scala?rev=r9253252#L31-32). Это не очень просто, так как нельзя использовать в argMax и фильтрах одинаковые имена колонок, то есть нужно переименовывать колонки.
