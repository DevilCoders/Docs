# Как в простом апи финстаты поддержать фильтры с OR условиями

## Status

accepted

## Context
Простое апи финстаты предполагает работу с фильтрами сравнения key-value (используются фильтры с типом `map<string, string>`).
Другими словами, сейчас события можно фильтровать ровно по одному продукту/офферу/клиенту.

Однако, у дилеров есть потребность выгружать и агрегировать события по нескольким продуктам. 
Для этого в апи финстаты нужно в каком-то виде поддержать фильтры с OR (`product == "product_1" OR product == "product_2"`) или IN (`product IN ("product_1", "product_2")`).

О каких решениях подумали:
1. Передавать в апи финстаты списки продуктов через запятые. То есть апи будет принимать `product: "product_1,product_2"`, сплитить внутри по запятой и формировать запрос в кликхаус с OR условиями.  
2. Усложнить прото-модели простого апи финстаты, поддержав в них фильтры с несколькими значениями.
3. Принимать в апи финстаты готовые части yql-запроса (`"product IN ('turbo-package', 'placement')"`).

## Decision
Выбрали вариант 1 - принимать списки через запятую и сплилить их внутри финстаты. 
Этот вариант не требует усложнения прото-модели/кода финстаты/кода дилерских продуктов.

## Consequences

### Good
Апи финстаты остается простым. 

### Bad
Есть небольшая опасность, что в имени продукта (или чего-то другого) появится запятая, и тогда апи финстаты будет работать некорректно. 
Вероятность такого довольна мала, и если мы с таким столкнемся, это будет не сложно поправить. 

Кроме того, выбранный вариант не поддерживает OR-условия на разные поля (нельзя сделать запрос `offer_id = "offer_1" OR product = "product_1""`). 
Но вероятно, такие фильтры в ближайшее время и не потребуются. Если они будут нужны, то можно будет усложнить апи. 