
![full](full_v2.png)

Основной вопрос который решает этот дизайн:<br />
Событий оказывается больше чем мы ожидали и простой вариант дизайна не справляется.<br />
События скапливаются, мы не успеваем пушить их в кликхаус<br />

Что можно сделать:
- несколько консьюмеров
- deduplication должна быть ок под нагрузкой  
- шардируем таблицу `new_events` на фиксированное число шардов - входящих событий, которые разбиты по батчам
запускаем несколько тасков, которые работают с этими шардами. На каждый шард создаём отдельный батч.
- чаще запускаем таск, который пушит батчи в кликхаус. Или запускаем разные таски, которые пушат в кликхаус.

### шардируем new_events
Работа с `new_events` может быть узким местом.<br/>
Если нам не хватает одной очереди на таблице `new_events` мы можем организовать несколько параллельных.<br/>
Разобьём на фиксированное кол-во шардов и на каждом запустим по таску, который пишет в `batches`.<br/>
Консьюмер будет детерминированно по какому-то алгоритму писать в конкретный шард `new_events`.

Увеличивать кол-во шардов не выглядит проблемой, т.к в `new_events` попадают уже дедуплицированные события
и сл-но после добавления шардов ничего не нужно делать со старыми событиями (т.е не нужно их перекладывать из старых шардов)
Поэтому на первом этапе можно не делать.

### несколько консьюмеров
Алгоритм записи из консьюмера в `deduplication`/`new_events` один.
Ответственность за уникальность лежит на таблице `deduplication`.
Единственное где могут возникнуть проблемы - если будут меняться условия генерации `deduplication.uniqueId`.
Возможно понадобится
- остановить консьюмеры
- сгенерить новые uniqueId для всех записей в `deduplication`
- включить консьюмеры с новым кодом генерации `uniqueId`
Впрочем с одним консьюмером это тоже проблема. Надеюсь при апдейте схемы получится иметь обратно-совместимые правила генерации `uniqueId`.

### чаще запускаем таск, отправляющий батчи
Не вижу смысла делать несколько тасков отправляющих батчи.<br/>
Всё равно в кликхаус нужно писать не чаще чем раз в секунду, иначе он может тормозить.