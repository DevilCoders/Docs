# Вопросы/ответы/решения
## Подход к разработке
1. Стоит ли сейчас подробно и долго всё разбирать или можно быстро написать MVP? И в процессе написания кода мы увидим нюансы, которые не видим сейчас.

Ответ:
Подход написать MVP - хороший подход, его не стал применять здесь, потому что
- Очень много неизвестности, было не понятно как подступиться к коду даже для MVP
- У нас сложно провести тикеты через оценку, если они недостаточно продуманы. 
- Подход с MVP тоже рабочий. Когда переключились на этот подход в shop, его быстро написали.
  Здесь по крайней мере архитектуру доведём способом, которым идём, т.к близок конец.
  
## Эволюция схемы
Что решили:
1. Добавляем schema_version в сообщение
2. Для того чтобы достать служебные поля, не прибиваем какую-то версию схемы. Используем ту которую взяли из SRAAS.
3. Данные нужные аналитикам оставляем на верхнем уровне.
4. На уровне schema-registy запрещаем эволюцию сообщений, которая нас не устраивает.
   Для этого можно воспользоваться extension-ами и посмотреть на anubis-robot, который валидирует схему в брокере.
5. Генерить id для дедупликации на стороне producer-ов не будем. Всё-таки правила оставляем у нас.

Почему так:
1. Добавляем schema_version в сообщение
   Альтернативы - парсить дескриптор с какой-то схемой, если мы распарсили не все поля,
   тогда запрашивать последнюю схему в SRAAS.
   Схема рабочая - но в плане кода сложнее. Проще для producer-ов, им не нужно писать версию схемы.

   Разработка у нас сложнее - поэтому решили писать схему на producer-ах.
   Если понадобится, потом переделаем.

   Плюс, от меня - они могут так накосячить с какими угодно любыми другими полями и точно так же будет
   проблема которую нужно исправлять.
2. Для того чтобы достать служебные поля, не прибиваем какую-то версию схемы. Используем ту которую взяли из SRAAS.
   Не хочется иметь 2 механизма работы со схемой, всё равно нам нужно уметь доставать её из SRAAS,
   на более поздней стадии, когда мы апдейтим схему в clickhouse
3. Данные нужные аналитикам оставляем на верхнем уровне.
   Мы пишем этот лог и в yt. Есть информация, что иметь плоское сообщение действительно важно для аналитиков.

   Была идея сделать
    ```
    message {
     служебные поля
     message {
        остальные поля
     }
    }
    ```
   Потому что так проще прибить версию и отдельно версионировать внутренний message.
   Так делать не будем. Всё равно будем парсить по схеме из SRAAS, не прибивая конкретную версию.<br/>

   Вариант, который мы не обсуждали - мы можем сделать внутри message именно для служебных полей,
   а не наоборот. Тогда служебные поля будут отделены от остальных.
   Т.е мы решаем оба вопроса с помощью схемы:
   ```
    message {
        поля плоской схемы как есть сейчас
        message {
            служебные поля для нас
        }
    }
    ```

4. На уровне schema-registy запрещаем эволюцию сообщений, которая нас не устраивает.
   Идея хорошая, до обсуждения её вообще не было, причин почему не сделать нет.

5. Генерить id для дедупликации на стороне producer-ов не будем. Всё-таки правила оставляем у нас.
   На самом деле система у нас сильно связана.
   Producer-ы должны заполнять сообщения одинаково, чтобы можно было использовать одинаковые запросы
   в кликхаус в конце пайплайна. Значит и в середине пайплайна можно использовать одинаковые правила
   для всех.