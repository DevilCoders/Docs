# Эволюция схемы
Т.к по эволюции схемы на каждой оценке много вопросов, всё же решил написать отдельную часть про эволюцию.

Всего в нашем проекте 3 части:
- Consumer, который вычитывает сообщения, валидирует что они корректные, дедуплицирует
  и записывает действительно новые сообщения в new_events
- Таск, который генерит батчи, сразу в виде insert-ов в clickhouse.
  Он их генерит по какой-то схеме
- Таск, который пушит батчи в clickhouse.
![схема работы подробнее описана здесь](kafka_to_clickhouse_simple.md)

Где-то в процессе мы апдейтим схему в clickhouse, если проапдейтилась protobuf-схема.
Понятно, что она должна проапдейтится до того как мы запишем батч, который сгенерили в этой схеме,
но где мы будем это делать - в таске генерящим батчи или в таске пушашем батчи в кликхаус, не важно.

## Изменение proto-схемы
Мы разрешаем только добавление новых полей, но не удаление.

## Изменение схемы в clickhouse
Схема в кликхаусе апдейтится в соотвестствии с proto-схемой.
В старых данных новое поле не заполнено/у него дефолтное значение.

## Краевые случаи
### батч сгенерённый по старой схеме и новая схема в clickhouse
Пример:<br/>
батч, сгенерённый по схеме proto v1.0<br/>
схема clickhouse v2.0<br/>
Т.е в proto-схеме есть не все поля. Когда мы заинсёртим этот батч,
мы запишем те значения что есть. Новые поля не будут записаны - это и ожидается.

### батч сгенерённый по новой схеме и старая схема в clickhouse
При нормальной работе сервиса такого не должно быть.
Т.е схема апдейтится строго до того как мы делаем запись.
Если в результате какого-то бага это произойдёт, insert в базу сфейлится,
т.к база не знает о новых полях. Далее или схема апнется или мы пойдём чинить, т.к в нашем флоу нет кейса,
когда схема ещё не апнулась.

### Может ли быть такое, что SRAAS ещё не знает про новую версию схемы?
### Может ли быть такое, что схема в SRAAS не сгенерилась, но сообщения в этой схеме нам отправляют?
Обсудили что это то ли невозможно, то ли крайне маловероятно.
Т.е на producer-e, который пишет в broker есть новая схема и они пишут например с версией 2.0,
а мы из SRAAS не можем её получить, там есть только 1.0.

В начальной версии дизайн-дока какой-то стратегии на этот счёт не предложил.<br/>
В первой версии сервиса предлагаю останавливать обработку сообщений и ждать когда в SRAAS появится версия
равная 2.0 или версию которая старше.

### Что если в результате каких-то race condition у нас один инстанс сервиса знает про новую схему, а другой нет?
Например какой-то task работал в одном дц, дц закрыли и task поднялся на другом датацентре не закончив работу на предыдущем.
Результат работы task-a сохраняется в транзакции в базу. Т.е если он сфейлился, другой таск начнёт с начала.
В итоге, можно смотреть на обработку как на однопоточный процесс.<br/>
Т.е вопрос сводится к одному из предыдущих - что если нужно сгенерить сообщение в схеме, которую мы не можем получить из SRAAS?