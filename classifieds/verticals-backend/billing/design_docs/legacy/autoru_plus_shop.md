# Прикидка что нужно в shop, чтобы запустить баллы плюса в autoru

* Нужно завезти оплаты физ лиц autoru в shop
* Нужно завезти поддержку плюса в shop

Эти проекты не обязательно делать одним шагом. На мой взгляд, лучше если это разные проекты.
Сначала перевозим существующую функциональность, затем делаем новое.

Что нужно в shop для заезда autoru?

Верхнеуровнево предлагаю такую схему:
1. Проводим оплату через shop, создаём активную услугу в shop
2. Активация пишется в лог
3. Потребляем этот лог в авто
Используем shop как замену banker, ничего более сложного не придумываем.
Т.е логика продлений и подобное остаётся в auto, в shop не переносим.
Применение промокодов в shop не уносим.
   
Что я не посмотрел и потенциально там много:
* Какие ещё ф-ии банкера кроме оплаты используются?
* Насколько сложен переезд в самом salesman. Коды ошибок, api и прочее не ложится 1в1.

## Что нужно в shop?

К интеграции с autoru стоит иметь хорошее api. Если с Объявлениями мы договорились,
   что когда оно будет хорошим мы его исправим, к интеграции с авто оно уже должно быть хорошим.
   В авто будет слишком дорого переделывать потом.

Поэтому, по тикетам
* описать, обсудить референсный пример, как должны использовать экосистему наших сервисов.
[это не исследовано, говорил об это здесь](https://wiki.yandex-team.ru/users/dkartashev/shop20210727/chto-eshhjo-nuzhno-issledovat/)
* основываясь на этом посмотреть и подумать над нашим api.
  api действительно в плачевном состоянии [во втором пункте об этом говорит Макс](https://github.com/YandexClassifieds/verticals-backend/blob/master/billing/shop/docs/design.md#todo)
  Возможно стоит делать сразу в сочетании с [разбиением кода на пакеты](https://wiki.yandex-team.ru/users/dkartashev/shop20210727/razbienie-koda-po-paketam/),
  т.к одно является отражением другого и натолкнёт на общие мысли.
* Сейчас мы можем платить только от лица Объявлений. Понадобится в трасте новый терминал, нужно будет пройти процесс интеграции с Трастом заново.
  Про это лучше проконсультироваться с [Денисом](https://staff.yandex-team.ru/denisgavrikov)
* Нужен резолвер, который будет в зависимости от project использовать разные tvm_id для запросов в траст.
* Нужно разобраться со всеми известными проблемами схемы, т.к в авто будет большой рейт запросов.
[пункт 4 из TODO Макса](https://github.com/YandexClassifieds/verticals-backend/blob/master/billing/shop/docs/design.md#todo)
* Стоит сделать нагрузочное тестирование, на нагрузке приближенной к нагрузке autoru. На мой взгляд без это проверки перевозить страшно. 
* ID юзеров будут у нас Я.Паспорта или у нас же будет соответствие id на autoru-idпаспрота?
* Нужно реализовать реккурентные платежи. Возможно что-то добавить в клиент траста + прокинуть до api.
  Т.к решение когда продлять будет принимать авто. Полного понимания как это работает нет, нужно проделать в тестинге и разобраться
  [дока траста, здесь сказано про рекурентные платежи](https://wiki.yandex-team.ru/trust/Payments/#platezhcherezapiakahost2host)
* В авто бывают транзакции на покупку сразу нескольких продуктов.
  Поэтому нужно поддержать разметку корзины. Сейчас в клиенте траста используется оплата одного продукта.
* Перед тем как делать, чтобы разработка в shop шла быстрее, стоит сделать важное отсюда [что ускорит day to day разработку shop](https://wiki.yandex-team.ru/users/dkartashev/shop20210727/chto-uskorit-day-to-day-razrabotku-shop/)
В долгосрочном плане это окупится.

## Следующий проект - баллы плюса в shop
[дока траста о баллах](https://wiki.yandex-team.ru/trust/yandexaccount/)
* Можно заранее подумать о том как баллы ложатся на наше api.
  Как ляжет на наше api балас баллов/добавление баллов?
  Возможно нужна абстракция кошелька? (есть о чём подумать)
* [Поддержать композитные платежи](https://wiki.yandex-team.ru/trust/yandexaccount/#chastichnajaoplatakorzinybonusnymiballami)  
* Добавить в код/потестить баллы
Это в рамках проекта [Дизайн-док крупным планом, участие разных сервисов](https://wiki.yandex-team.ru/users/dkartashev/bally-pljusa-v-autoru/)

## Полезное, связано с этой докой
[Дизайн-док крупным планом, участие разных сервисов](https://wiki.yandex-team.ru/users/dkartashev/bally-pljusa-v-autoru/) <br/>
[Ориентируюсь на своё исследование shop](https://wiki.yandex-team.ru/users/dkartashev/shop20210727/) <br/>
[Учитываю крупноблочное виденье](https://wiki.yandex-team.ru/users/dkartashev/mojo-mnenie-kak-razvivat-billing/) <br/>
[И решение делать удобную экосистему биллинга](https://wiki.yandex-team.ru/vertis/billing/vstrechi/) <br/>