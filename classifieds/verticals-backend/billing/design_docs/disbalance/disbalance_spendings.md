# Диздок "Дисбаланс: списания"

В данной доке речь пойдет про списания денег с кошелька клиента. Если смежному сервису нужны закрывающие акты, то ему
нужно слать списания в вертикальный биллинг.

Списания в billy будут работать по сценарию пост-оплаты (подробнее - читай ниже).

## Как все будет выглядеть

Смежники смогут слать следующую модель в биллинг:

```protobuf
message PutSpendingRequest {
    string workspace = 1;           // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2;   // сервисный внутренний id клиента
    string service_spending_id = 3; // произвольный id списания, задаваемый сервисом. Повторные вызовы с таким же id не создадут новые списания
    string product_id = 4;          // произвольный id продукта, задаваемые сервиса
    int32 kopecks = 5;              // количество копеек. Эту сумма спишется с кошелька клиента
}
```

В mvp не будем поддерживать двух-стадийные списания (hold + commit) и получение списаний, так как это не выглядит
необходимым.

## Про пост-оплату

Пост-оплата - сценарий, когда клиент может получать услуги, а оплачивать их позже. Для c2b нужен пост-оплатный сценарий,
поэтому поначалу billy будет поддерживать только его.

В Балансе в "партнеской схеме" (с который интегрируется c2b) пополнения и списания никак не связаны. Мы можем послать
сколько угодно списаний в Баланс, и если клиент внес денег меньше, чем мы послали, то клиент будет считаться должником.
В этом случае менеджер Вертикалей должен идти просить клиента внести деньги, и Вертикали сами должны накладывать санкции
на клиента (например банить доступ к нашим услугам).

Billy не будет следить за долгами клиента. Он только предоставит ручки, которые будут говорить о том, сколько должен
клиент. В сценарии c2b эти ручки пока не нужны, поэтому их мы задизайним позже.

## Детали реализации

#### Ручка обработки списаний

В billy заводим следующую таблицу

```sql
CREATE TABLE spending
(
    balance_client_id   BIGINT      NOT NULL, -- балансовый id клиента
    service_spending_id VARCHAR(64) NOT NULL, -- сервисный id списания
    product_id          VARCHAR(64) NOT NULL, -- сервисный id продукта
    kopecks             BIGINT      NOT NULL, -- количество копеек, которое было списано
    timestamp           TIMESTAMP   NOT NULL, -- время списания

    PRIMARY KEY (balance_client_id, service_spending_id)
);
```

Внутри billy ручка обработки списаний будет просто добавлять списание в эту таблицу.

#### Отправка списаний(откруток в Баланс)

Списания нужно помещать в yt, чтобы их оттуда смог забрать Баланс. Подробнее об этом
написано [в туториале Баланса в этапе 6](https://wiki.yandex-team.ru/balance/tutorial/#flouvzaimodejjstvijab2b).

В billy будет заведенена регулярная таска, которая будет выгружать списания в yt, используя [//common/yt](
https://a.yandex-team.ru/arc_vcs/classifieds/verticals-backend/common/yt/?rev=r9648437).

Возможной реализацией могла бы стать запись через брокер, но:

- Это не надежно. Первого числа в 13:00 каждого месяца все списания за прошлый месяц должны быть в yt. Брокер же
  периодически страдает из-за проблем с нагрузкой.
- Списания в yt должны быть дедуплицированы, из-за чего пришлось бы делать реакцию в реакторе, а это дополнительное
  усложнение процесса.

Поэтому billy будет писать напрямую в yt.

#### Что будет если у клиента уменьшатся деньги на заказе-кошельке?

Теоретически возможны ситуации, когда у клиента в балансе уменьшаются деньги на заказе. Например, это можем происходить
из-за возвратов платежей или переноса денег с заказа на заказ руками саппорта Баланса. В этом случае Баланс пришлет в
топик логброкера сумму меньшую, чем она была.

Однако, акты Баланс формирует на основе откруток, а не денег на заказе клиента. Если мы в открутках укажем больше, чем
есть на заказах, то ничего страшного не произойдет.

Работать это будет следующим образом:

- Пусть наш клиент пополнил заказ на 1000 рублей.
- Мы ему предоставили 10 услуг по 100 рублей и положили в yt открутки суммарно на 1000 рублей.
- Дальше клиент как-то вернул себе часть денег, которые он положил. Например, вернул себе 50 рублей.
- Итого, в сообщении топика логброкера Баланс прислал 950 рублей, а в открутках в yt по-прежнему лежит 1000 рублей.
- Наступило 1 число месяца, Баланс формирует акты. В акте будет указано 1000 рублей.
- В следующем месяце клиент пополняет заказ на 150 рублей, итого на его кошельке оказывается 1100 рублей.
- Мы продолжаем предоставлять ему услуги.

В какой-то момент клиент нам "должен" 50 рублей, но в этом нет ничего страшного, так как такие ситуации редки и их можно
при необходимости разбирать руками поддержки/менеджеров.

## Про wallet

Сервис wallet был придуман для того, чтобы взять всю работу с пополнениями и списаниями на себя. Однако, мы не успеваем
подготовить его к дедлайну billy, поэтому делаем списания в самом billy (так делать намного быстрее). В последствии, мы
унесем всю работу со списаниями в wallet.

Мотивация для этого:

- для работы с предоплатами, нужно будет знать о пополнениях, которые будут храниться только в wallet. Логичней всего
  пред-оплатные и пост-оплатные списания пускать по похожим процессам.
- если мы унесем все wallet, то это существенно упростит billy, а мы как раз и хотим делать более простые микро-сервисы.
