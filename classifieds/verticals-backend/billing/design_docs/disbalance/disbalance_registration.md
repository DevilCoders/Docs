## Диздок "Дисбаланс: регистрация клиента"

В этой доке описаны первые шаги, которые мы будем делать в рамках проекта [Дисбаланса](disbalance.md).

Дока текущей регистрации клиентов находится [здесь](https://wiki.yandex-team.ru/users/fedleonid/old-process-creation-clients).

Это дока писалась до того, как мы взялись за проект c2b. Новый диздок регистрации прочитать можно [здесь](c2b_registration.md).

### Основная идея

1) В биллинге делаем новую ручку регистрации клиентов.
   - Внутри биллинга она создает клиента и связанный с ним заказ в Балансе.
   - Информацию о созданном клиенте и заказе ручка пишет в новые таблицы новой базы данных биллинга. Так же ручка сохраняет мэппинг балансовых и внутренних сервисных id.
   - Ручка будет возвращать балансовый id клиента и заказа (почему - смотри ниже).
2) Переписываем текущие dao биллинга клиентов/заказов, чтобы они могли брать информацию и из старых, и из новых таблиц биллинга (подробнее - смотри ниже).
3) В cabinet-api команда дилерских продуктов переписывает [таску SaveClientsToYaBalanceTask](https://a.yandex-team.ru/arc_vcs/classifieds/cabinet-api/cabinet-tasks/src/main/scala/ru/auto/cabinet/tasks/impl/ya_balance/SaveClientsToYaBalanceTask.scala?rev=r9360999) так,
чтобы она ходила только в новую ручку биллинга.

### Подробнее о том, почему стоит делать именно так

### Мэппинг балансовых и внутренних id

Сейчас биллинг работает только с балансовыми id, а cabinet-api записывает мэппинг балансовых и дилерских id в бд _main.balance_.
В будущем хочется избавить потребителей биллинга от необходимости запоминать балансовые id, поэтому новая ручка должна сохранять мэппинг внутри биллинга.

Однако, на текущем этапе Дисбаланса, мэппинг в _main.balance_ по-прежнему нужно хранить, так как на это многое завязано и переписать все разом не представляется возможным.

Видятся только два варианта, как это можно сделать:
1) Биллинг сам начинает писать в _main.balance_ балансовые id и не возвращает их в респонсе новой ручки.
2) Биллинг возвращает балансовые id в cabinet-api, чтобы он мог их записать в _main.balance_.

Первый вариант не стоит выбирать, так как это кастомная доменная логика, которую не хочется добавлять в новый код биллинга.

Второй вариант плох тем, что наружу все еще будут торчать балансовые id, но это будет временно.
В дальнейшем авто/недвижка полностью избавятся от хождения в Баланс, и им не нужно будет запоминать балансовые id.

Итого, выбираем 2 вариант.

#### Сохранение клиентов/заказов в базу данных биллинга

Есть несколько вариантов, как можно сохранять созданных клиентов/заказов в биллинге:

1) Сохраняет все только в старые текущие таблицы биллинга.
2) Сохраняет все только в новые таблицы (которые нужно будет сделать).
3) Сохраняет все и в старые, и в новые для всех клиентов.
4) Сохраняет в старые для авто/недвижки, и в новые для авто/недвижки/CMExpert.

Сохранять только в старые таблицы не хочется, так как от их схемы хочется отказаться.

Писать в новой ручке регистрации и в новые, и в старые таблицы тоже не хочется, так как это захламление нового кода и усложнение интеграции с CMExpert, так как будет сложнее дебажить.

Единственная проблема писать только в новые таблицы в том, что нужно в этот же момент переделать несколько текущих Dao биллинга.
Однако, это не является очень трудоемкой задачей и в будущем от этих Dao будем отказываться, так что сложность логики в них будет временная.

В связи с вышесказанным делаем 2 вариант.

### Прото-модели новой ручки биллинга

Прото-модели новой ручки будут выглядеть _примерно_ так:

```protobuf
message CreateClientRequest {
    string workspace = 1;         // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2; // сервисный внутренний id клиента
    string name = 3;              // имя клиента, которое будет отражено в Балансе
    string email = 4;             // email клиента
}

message CreateClientResponse {
    string balance_client_id = 1; // балансовый id клиента
    string balance_order_id = 2;  // балансовый id заказа клиента
}
```

### Новая база биллинга и новые таблицы

#### Зачем новая бд

Сейчас биллинг имеет отдельную базу для каждого домена, что неудобно с точки зрения
- заведения новых потребителей биллинга
- дебага
- тестирования
- накатывания изменений таблиц

Хотелось бы, чтобы все данные лежали в одной базе. Поэтому мы решили попробовать завести новую базу с новыми таблицами.

#### Выбор новой базы

Выбирали между ydb и postgres.

Вариант mysql был быстро отброшен, так как разница его с postgres совсем небольшая, и мы в команде решили, что нам приятнее было бы работать c postgres.

**Плюсы ydb:**
- Serializable, который упростит написание кода работы с базой.
- Хорошая масштабируемость.

**Минусы ydb:**
- Риски переезда. Весьма вероятно в будущем потребуется миграция текущих данных на новые таблицы и мигрировать на ydb будет несколько сложнее.
- Сложности join и прочими запросами реляционки. Вероятно в биллинге подобные запросы понадобятся, и если мы выберем ydb, нам нужно будет хорошо продумывать структуры таблиц, чтобы джойны работали быстро.
- Сложности с шардированием и оптимизацией. Проблемы долго-работающих запросов в реляционке часто решаются за час накидыванием индекса.
Проблемы долгих запросов ydb часто приводят ко дню переписывания самих запросов и/или структуры таблиц.
Биллинг - сервис, от которого критически важна доступность, и подобные проблемы нужно решать как можно быстрее.

Исходя из всего вышесказанного, было принято решение на этом этапе Дисбаланса завести базу postgres.

#### Схема новых таблиц

Новые таблицы будут выглядеть _примерно_ так:

```sql
CREATE TABLE client (
  balance_id INTEGER      NOT NULL,
  service_id VARCHAR(128) NOT NULL,
  name       VARCHAR(128) NOT NULL,
  email      VARCHAR(128) NOT NULL,
  workspace  VARCHAR(32)  NOT NULL, -- autoru/realty/cmexpert

  PRIMARY KEY client_pk (workspace, balance_id),
  UNIQUE KEY client_uk (workspace, service_id),
);

CREATE TABLE actual_order (
  balance_id INTEGER     NOT NULL,
  order_id   INTEGER     NOT NULL,
  workspace  VARCHAR(32) NOT NULL, -- autoru/realty/cmexpert

  PRIMARY KEY actual_order_pk (workspace, order_id),
  UNIQUE KEY actual_order_uk (workspace, balance_id),
);
```

### Новое название биллинга и его расположение в репозитории

Решили

1) **Назвать новые модули сервиса _billy-\*_.**
   Название _billing-*_ сейчас путает многих людей, так как есть яндексовый биллинг (он же Баланс),
   есть "команда биллинга" (которая занимается биллингом, банкиром, финстатой и многим другим) и есть сервис biling.
   Поэтому логично выбрать новым модулям другое название.

2) **Положить новые модули в [//billing/billy-\*](../../billy).** Такое расположение будет более явно отделять новый код от старого.

Конкретно новая ручка регистрации будет лежать в новом сервисе _billy-api_.

### Про регистрацию агенств

Помимо регистрации клиентов, о которых здесь идет речь, есть процесс регистрации агенств.
Новая ручка регистрации клиента будет регистрировать только прямых клиентов и субклиентов (клиентов под агенством).

Процесс регистрации агенств несколько отличается от регистрации прямых клиентов, и не стоит это все подгонять под один интерфейс и единую логику.

Про агентсва будет отдельный эпик Дисбаланса, которым мы займемся позже -- [VSBILLING-5457](https://st.yandex-team.ru/VSBILLING-5457).
