# Диздок "Дисбаланс: регистрация клиента для c2b"

В процессе проектирования Дисбаланса выяснилось, что нам нужно в сжатые сроки
сделать [проект c2b](https://wiki.yandex-team.ru/users/olgalyubimova/tickets/newservice-2113/) и правильней всего делать
его сразу через вертикальный биллинг. Также обнаружилось, что флоу работы с заказами (кошельками) в c2b будет несколько
отличаться от привычного флоу построенного в авто и недвижке.

Здесь было решено для начала сделать новый вертикальный биллинг для c2b (с оглядкой на cmexpert/авто/недвижку), а потом
доделать все, что нужно, для других сервисов.

Старая дока, которая писалась до исследования с2b, находится [здесь](disbalance_registration.md). Она пригодится, когда
будем дорабатывать новый биллинг для авто.ру. В этой же доке приняли решение назвать новый сервис _billy_ и завести
новую базу данных на postgres.

## Что делаем в billy

В billy делаем простую ручку создания/обновления клиента в Балансе. Заказ в Балансе эта ручка **не** создает (почему -
читай ниже про лицевой счет).

Прото-модели новой ручки будут выглядеть так:

```protobuf
message CreateOrUpdateClientRequest {
    string workspace = 1;         // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2; // сервисный внутренний id клиента
    string name = 3;              // имя клиента, которое будет отражено в Балансе
    string email = 4              // email клиента
    string phone = 5              // телефон клиента
}

// В респонсе ручка будет просто отдавать OK или ошибку
```

Ручка будет ходить в метод [CreateClient](https://wiki.yandex-team.ru/balance/xmlrpc#balance.createclient) Баланса и
сохранять в бд billy мэппинг балансовых и внутренних сервисных id.

Таблица клиентов будет выглядеть так:

```sql
CREATE TABLE client
(
    balance_id INTEGER      NOT NULL,
    service_id VARCHAR(128) NOT NULL,
    name       VARCHAR(128) NOT NULL,
    email      VARCHAR(128) NOT NULL,
    phone      VARCHAR(128) NOT NULL,
    workspace  VARCHAR(32)  NOT NULL, -- autoru/realty/cmexpert

    PRIMARY KEY client_pk (workspace, balance_id),
    UNIQUE KEY client_uk (workspace, service_id),
);
```

Кроме того, в Балансе нужно линковать некоторых клиентов и конфигурации Баланса. Об конфигурациях можно прочитать
в [доке Баланса](https://wiki.yandex-team.ru/balance/xmlrpc/#partnerskieintegracii). Пока на каждый воркспейс (сервис
Баланса) будет ровно одна конфигурация, и все клиенты этого сервиса будут линковаться к этой конфигурации. Линковать
клиентов будет billy в момент создания клиентов.

## Про лицевой счет в Балансе

После загрузки договора Баланс автоматически создает для клиента лицевой счет и заказ-кошелек. На этот заказ можно
создавать счета на оплату и с этим же заказом можно связывать открутки. Баланс рекомендует пользоваться именно таким
способом, а не создавать заказы вручную.

Billy будет работать именно с этим заказом (как именно - смотри в [этой доке](disbalance_income.md)), а не создавать
новые заказы сам.

## Доработки, которые потом потребуются

### Привязки к паспорту

Для того, чтобы клиент мог сам смотреть свои счета в веб-интерфейсе Баланса, нужно привязывать балансового клиента и
паспортный id, которым будет пользоваться клиент.

В [этой доке](https://wiki.yandex-team.ru/balance/tutorial/#flouvzaimodejjstvijab2b) Баланса написано, как именно нужно
работать с паспортными id, и из этой доки становится понятно, что это не очень просто. В реализации для c2b мы не будем
связывать клиентов с паспортом. Вернемся к этому вопросу, когда будем дорабатывать сервис для авто/недвижки.

### Миграция авто/недвижки на billy

В прошлой дизайне регистрации клиентов ручка создания возвращала балансовый id заказа для того, чтобы не сломать текущие
процессы cabinet-api. В новом дизайне billy не создает заказы, а пользуется автоматически созданным лицевым счетом.
Из-за этого авто/недвижке будет сложнее мигрировать на billy, но есть предположения, что не сильно сложнее. Вернемся к
этому, когда закончим проект c2b.

### Агентства

Как и в прошлой доке регистрации тут ничего не сказано про агентства и субклиентов. В первой реализации billy будет
работать только с прямыми клиентами.
