# Схема биллинга после реализации Дисбаланса

Здесь описано, что примерно из себя будет представлять биллинг после того, как мы реализуем Дисбаланс.
Текущая реализация биллинга делает похожие вещи, но предоставляет менее удобное апи, чем будет в будущем.

## Что такое вертикальный биллинг

Вертикальный биллинг - сервис для работы с деньгами юр.лиц, построенный над Балансом.
С помощью биллинга можно выставлять счета клиентам на оплату, управлять списаниями за продукты и формировать акты об оказанных услугах.

Интеграция с вертикальным биллингом существенно проще интеграции с Балансом напрямую.
Это связано с неудобным xmlrpc-api Баланса, рутинной работы при взаимодействии с ним (которую можно сложить на биллинг), а также медленно отвечающей поддержки команды Баланса.

Новый вертикальный биллинг, с которым будет интегрироваться cm.expert, мы решили назвать **_billy_**.

Под "смежными сервисами" в этой доке имеются ввиду авто/cmexpert/недвижка.

## Как работать с биллингом

С помощью своего апи вертикальный биллинг будет позволять:

- регистировать/обновлять клиента в Балансе
- формировать счета на оплату
- следить за проведенными платежами клиента и за количеством денег на его кошельке
- управлять списаниями за продукты
- формировать акты об оказанных услугах за месяц в начале следующего месяца

Ниже описано подробнее про каждый пункт

### Регистрация клиента

Для формирования счетов на оплату в Балансе необходимо создать клиента, заказ, договор и плательщика.
Биллинг предоставит для этого апи, чтобы смежные сервисы для этого могли ходить в биллинг, а не Баланс.

Главная идея billy здесь в том, что сервисы смогут присылать в него свою внутренние id клиента и не заботиться о запоминании балансовых id.
Биллинг будет сам запоминать матчинг внутренних и балансовых id.

Сущность заказа клиента тоже будет скрыта. С точки зрения смежных сервисов у клиентов будет "кошелек", где начисляются и списываются деньги.

По сути billy предоставит три следующих ручки:

#### 1) Создание клиента и заказа в Балансе.
Это будет одна максимально простая ручка. Сюда достаточно будет передавать внутренний id клиента, его имя и email.

#### 2) Добавление/обновление договора.
Договор - довольно большая (по количеству полей) сущность в Балансе, и здесь биллинг не сможет существенно упростить апи.
В данной ручке billy будет выступать лишь прокси с более приятным протоколом (grpc вместо xmlrpc).

Еще возможный вариант - группы сопровождения клиентов будут добавлять договоры в админке самого Баланса.
Пока что не очень понятно, насколько это хорошо или плохо. Но решение этого вопроса не влияет на другие процессы, и потому его можно несколько отложить.

#### 3) Добавление/обновление плательщика.

Ситуация c плательщиками похожа на договоры. Здесь тоже биллинг по большей мере просто предоставит приятное прокси.

Единственное, billy может запомнить плательщиков клиента и использовать это в нужные моменты (например, формирование счета).

### Формирование счета на оплату

В Балансе есть пред- и пост-оплатные счета. Планируется, что billy будет работать с обоими типами счетов.

Пред-оплата и пост-оплата требуют разные виды договоров и идут несколько по разным пайплайнам.

#### Пред-оплата

Первым делом для клиента формируется счет на оплату. В самом Балансе для этого нужно вызвать несколько ручек друг за другом. Этот момент billy скроет в своей реализации.
Смежные сервисы смогут формировать счет с помощью одной более простой ручки биллинга.

Далее клиенту нужно будет оплатить счет (произвести платеж). После платежа на кошельке клиента появятся деньги и можно будет с него списывать средства за услуги.

#### Пост-оплата

Пост-оплата в Балансе работает следующим образом:
1) клиенту выделяется кредитный лимит (это прописано в договоре)
2) в течение месяца сколько угодно раз можно перемещать деньги с кредитного лимита на заказ. С точки зрения сервисов это выглядит, как будто бы кошелек пополнили деньгами
3) после перекидывания денег на заказ можно списывать средства за услуги
4) в начале следующего месяца Баланс сам формирует счет на пост-оплату, который клиент должен будет оплатить в течение 15 дней

В данном месте планируется, что billy предоставит простую ручку для перекидывания денег с кредитного лимита на заказ.

### Обработка платежей клиента

Оплата счетов клиентами идет через платежные системы/банки в Баланс.
В данном месте сервисам, которые пользуются Балансом нужно уметь обрабатывать нотификации Баланса о том, что поступил платеж.
Эту работу на себя возьмет billy. Авто/сmexpert/недвижка смогут ходить в биллинг и смотреть текущий баланс кошелька.

### Управление списаниями

Billy в этом месте предоставит
- апи для применения услуги: "сделать списание N рублей c клиента A за продукт X"
- апи для возврата примененной услуги
- формирование поставки в broker лога примененных услуг
- апи для просмотра списка примененных услуг

Важный момент: биллинг не получится использовать для хранения каких-то больших пейлоадов примененных услуг клиента.
В billy можно будет только узнать, что "клиент A в такое-то время купил продукт c идентификатором X за N рублей".

Кроме того, billy будет предоставлять возможность для двух-стадийного списания: холдирование денег у клиента и подтверждение списания.

### Формирование актов об оказанных услугах

Акт об оказанных услугах — документ, предоставляемый клиенту и подтверждающий оказание услуг.
В Балансе формируется акт на каждый заказ клиента в начале каждого месяца за все списания, которые произошли в течении предыдущего месяца.
Формирование актов работает полностью автоматически в Балансе.

Планируется, что у каждого клиента будет ровно один заказ на все услуги.
То есть клиенту в начале месяца придет один акт, где будет одна цифра - сколько клиента потратил денег на все услуги за месяц.

### Какая еще будет функциональность billy

Планируется следующая дополнительная функциональность:
- работа с агенствами (смена агенств у субклиентов)
- обилливание телепоневских звонков
- овердрафты

Это все сложные задачи, которые нужно исследовать. Пока нет понимания, как это будет работать.

## Что еще команда вертикального биллинга может предложить

У нас есть еще несколько сервисов, которые могут помочь при работе с деньгами клиентов:
- [Финстата](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/finstat)
- [Howmuch](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/howmuch)
- [Промокодер](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/promocoder)
