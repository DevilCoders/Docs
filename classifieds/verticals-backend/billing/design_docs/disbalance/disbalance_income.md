# Диздок "Дисбаланс: пополнение кошелька"

В данной доке речь идет про пополнение кошелька клиента, а конкретно про формирование пред-оплатного счета и обработки
платежей клиента. Общий дизайн работы с биллингом описан [здесь](schema_after_disbalance.md).

Тут стоит сказать, что мы решили, что в самой первой реализации Дисбаланса договоры и плательщики в Балансе будут
управляться руками в админке Баланса (а не через billy). Поэтому об этом в доке речь не пойдет. Будем считать, что в
момент формирования счета плательщики и договоры уже заведены в Баланс и billy про них не знает.

## Ликбез: способы выставления счета в Балансе

В самом Балансе счет выставляется в два этапа:

1) Формирование недовыставленного счета (заготовки счета).
2) Выставление счета.

Первый этап нужно делать через один метод апи Баланса, а вот со вторым все сложнее. Во-первых, выставлять счет можно как
через апи Баланса, так и через веб-интерфейс Баланса
([выглядит таким образом](https://wiki.yandex-team.ru/users/fedleonid/skrinvystavlenijascheta/)). Во-вторых, при
выставлении счета нужно указывать плательщика, договор и способ оплаты.

Нужно упомянуть, что у клиента могут быть несколько актуальных плательщиков и договоров.

## TL;DR: как все будет устроено

В billy заводим следующее:

- ручки указания billy, какого плательщика и какой договор нужно использовать при выставлении счета
- метод подтягивания номера заказа-кошелька из Баланса и сохранение его у себя
- ручку выставления счета, которая в ответе будет отдатвать печатную форму счета (для оплаты)
- ручки получения списка текущих плательщиков и договоров клиента
- метод обработки событий от Баланса о поступлении платежа клиента

Смежные сервисы (авто/недвижка/cmexpert) смогут формировать и выставлять счет через billy. Здесь они должны будут
указать billy, какого плательщика и договор нужно использовать. Это может делать саппорт или сам клиент через какой-то
интерфейс смежного сервиса. Также это можно сделать как задолго до выставления счета (например, при первом заведении
договора в Баланс), так и непосредственно перед выставлением.

## Реализация на стороне billy

### Ручки указания billy, какого плательщика и какой договор нужно использовать при выставлении счета

Предлагается в бд billy хранить key-value таблицу с актуальным плательщиком и договором клиента, а также сделать ручки
редактирования этой таблицы.

Таблицу можно сделать одну:

```sql
CREATE TABLE actual_requisites
(
    workspace         VARCHAR(32) NOT NULL, -- autoru/realty/cmexpert
    balance_client_id INTEGER     NOT NULL, -- балансовый id клиента
    payer_id          VARCHAR(64),          -- id плательщика из Баланса
    contract_id       VARCHAR(64),          -- id договора из Баланса

    PRIMARY KEY actual_requisites_pk (workspace, balance_client_id)
);
```

Ручки выставления, как мне кажется, лучше сделать разные:

```protobuf
message PutPayerRequest {
    string workspace = 1;         // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2; // сервисный внутренний id клиента
    string payer_id = 3;           // id плательщика в Балансе
}

message PutContractRequest {
    string workspace = 1;         // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2; // сервисный внутренний id клиента
    string contract_id = 3;        // id договора в Балансе
}
```

### Метод подтягивания номера заказа-кошелька из Баланса и сохранение его у себя

Про то, что такое лицевой счет и заказ-кошелек, можно почитать [здесь](c2b_registration.md).

В billy нужен метод, который будет ходить в ручку
Баланса [GetOrdersInfo](https://wiki.yandex-team.ru/Balance/XmlRpc/#balance.getordersinfo) и подтягивать оттуда номер
заказа-кошелька ([здесь](https://wiki.yandex-team.ru/balance/tutorial/#flouvzaimodejjstvijab2b) написано, как нужно
фильтровать респонс Баланса). Этот номер нужно будет сохранить в базу billy.

Новая таблица будет выглядеть примерно так:

```sql
CREATE TABLE order
(
    workspace         VARCHAR(32) NOT NULL, -- autoru/realty/cmexpert
    balance_client_id INTEGER     NOT NULL, -- балансовый id клиента
    order_id          INTEGER     NOT NULL, -- id заказа в Баланса

    PRIMARY KEY actual_order_pk (workspace, order_id),
    UNIQUE KEY actual_order_uk (workspace, balance_client_id),
);
```

Это метод не будет торчать ручкой из billy, а будет скрытой реализацией. Его нужно будет вызывать в billy при
выставлении счета, если таблица order еще не содержит заказ клиента.

### Ручка выставления счета

Модель данной ручки:

```protobuf
message InvoiceRequest {
    string workspace = 1;           // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 2;   // сервисный внутренний id клиента
    int32 kopecks = 3;              // количество копеек. На эту сумму выставится счет на оплату
    string service_invoice_id = 4;  // произвольный идемпотентный id создания, задаваемый смежным сервисом
}

message CreateInvoiceResponse {
    string pdf_url = 1;             // Ссылка на файл в s3 с pdf печатной формой счета. Доступна только внутри сети Яндекса
}
```

Параметр `service_invoice_id` нужен для того, чтобы не выставлять несколько счетов, когда нужно выставить только один.

В billy это ручка будет формировать и выставлять счет, последовательно вызвав
[этот](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/common/balance/src/BalanceClient.scala?rev=r9558090#L18)
и [этот](https://a.yandex-team.ru/arcadia/classifieds/verticals-backend/billing/common/balance/src/BalanceClient.scala?rev=r9558090#L24)
метод Баланса.

Id плательщика и договора billy возьмет из своей таблицы, о которой говорилось выше. Если в таблице не будет данных, то
billy вернет ошибку.

Предлагается, что этим методом биллинг будет создавать счета только со способом оплаты "банк для юр.лиц". Другие способы
оплаты в этом сценарии поддержать немного сложнее, и в первой реализации Дисбаланса их добавлять не планируется. Сейчас
в авто и недвижке другие способы _почти_ никогда не используются, но если они кому-то понадобятся, то тогда мы подумаем,
как их добавить.

Кроме того, в этой ручке billy должен будет запомнить в своей бд _service_invoice_id_ и id счетов Баланса. В Балансе
недовыставленный счет и выставленный счет имеют разные id.

В billy будет примерно такая таблица:

```sql
CREATE TABLE invoice
(
    workspace          VARCHAR(32) NOT NULL, -- autoru/realty/cmexpert
    service_invoice_id INTEGER     NOT NULL, -- сервисный id счета
    pre_invoice_id     INTEGER,              -- id недовыставленного счета из Баланса
    invoice_id         INTEGER,              -- id выставленного счета из Баланс

    PRIMARY KEY invoice_pk (workspace, service_invoice_id),
    UNIQUE KEY invoice_uk_1 (workspace, pre_invoice_id),
    UNIQUE KEY invoice_uk_2 (workspace, invoice_id)
);
```

В ручке выставления счета billy будет отдавать ссылку на pdf c печатной формой счета. Печатная форма счета нужна
клиентам для проведении оплаты (только для способа оплаты "банк для юр.лиц"). Для получении pdf billy нужно будет ходить
в [этот метод Баланса](https://wiki.yandex-team.ru/balance/http/#getinvoicefrommds).

### Ручки получения списка текущих плательщиков и договоров клиента

Эти ручки можно будет вызывать из смежных сервисов, получить плательщиков и договоры клиента, показать списки клиенту и
дать ему выбрать. Выбранного плательщика и договор можно будет прислать в billy в вышеописанных ручках.

Данные ручки нужна только для клиентов, которые имеют несколько плательщиков и/или договоров. Вероятно, в самой первой
реализации Дисбаланса это не потребуется, поэтому эти ручки подробнее будем дизайнить позже.

### Метод обработки событий от Баланса о поступлении платежа клиента

После того как клиент совершил платеж по выставленному счету, эта информация доходит до Баланса, а Баланс посылает
событие в логброкер.

Про топик логброкера написано [здесь](https://wiki.yandex-team.ru/balance/tutorial/#flouvzaimodejjstvijab2b) и
[здесь](https://wiki.yandex-team.ru/users/olgalyubimova/configurator/developers/template/common/logbroker/).

По этому топику нельзя понять, по какому счету прошел платеж. Баланс посылает только цифру количества денег на заказе,
поступившее за все время (total_income). Еще важным моментом тут является то, что эта цифра может уменьшаться. Например,
такое может произойти из-за возврата платежа или перекидывания денег с заказа на заказ.

Отдельная сложность топика Баланса - версии сообщений. В каждом сообщении Баланс шлет version_id и object_id, которые
нужно анализировать. Если для какого-то конкретного object_id пришла какая-то version_id = N, то версии меньшие, чем N,
для этого object_id обрабатывать не нужно. В object_id может быть записано что угодно (id договора/счета/клиента), и нам
не стоит анализировать этот object_id, так как он может измениться. Для того, чтобы понимать, какой клиент внес деньги,
в сообщении Баланса есть ClientId. Всю эту логику про версии будет делать billy.

Мы решили, что сделаем новый сервис wallet, который будет отвечать за пополнения и списания. Часть логики пойдет в его
ответственность.

В этой части billy будет делать следующее:

1) читать топик от Баланса (читая только новые version_id сообщений)
2) посылать total_income в wallet, и в ответе от него получать разницу нового total_income и предыдущего
3) посылать в кафку разницу денег на кошельке (сколько поступило или вернулось)

Billy будет посылать в топик такие данные:

```protobuf
message Income {
    int64 version = 1;            // строго возрастающая версия сообщения. Сделано для дедупликации
    string workspace = 2;         // имя домена в биллинге (autoru, realty, realty_commercial, cm_expert)
    string service_client_id = 3; // сервисный внутренний id клиента
    int64 diff_kopecks = 4;       // количество копеек, которое изменилось на кошельке клиента. Может быть как положительным, так и отрицательным
}
```

Была мысль внутри самого биллинга связывать платежи с выставлениями счетов (например, кидать все деньги на самый ранний
неоплаченный счет и помечать его оплаченным). Однако здесь могут возникнуть ситуации, когда нужно "забыть" о каком-то
счете. Например, дилер хотел выкупить машину, мы создали счет, но клиент передумал платить. Для таких случаев в биллинге
нужно было бы добавлять апи для удаления счетов, что переусложняет биллинг. Итого, мы решили такой вариант не
реализовывать.

## Про выставление счетов через веб-интерфейс Баланса

Баланс позволяет выставлять счет на оплату через свой веб-интерфейс, и в этом же интерфейсе можно получить печатную
форму счета. Однако, для доступа нужно связывать клиента Баланса и паспортный id. Это не очень простая задача (почему -
понятно из [этой доке](https://wiki.yandex-team.ru/balance/tutorial/#flouvzaimodejjstvijab2b)), поэтому в реализации
нового биллинга для c2b billy это делать не будет.

Некоторые клиента авто/недвижке сейчас пользуются веб-интерфейсом Баланса, поэтому когда мы будем мигрировать их на
billy, мы еще раз подумаем о том, как это поддержать в новом биллинге.
