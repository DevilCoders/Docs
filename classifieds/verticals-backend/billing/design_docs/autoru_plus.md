# Что нужно в биллинге для запуска баллов Плюса в autoru
Для поддержки возможности оплаты баллами Плюса сервис должен совершать платежи через Траст.
Ранее предлагался вариант интеграции с Плюсом через **shop**, так как он подключен к Трасту.
В текущих реалиях **banker** тоже подключен к Трасту, поэтому интеграцию с Плюсом будем делать сразу в нём.

## Настройки на стороне Траста
Для пополнения и списания бонусных баллов сервису требуется подключить соответствующие терминалы в Трасте.
О возможности работы сервиса с бонусными аккаунтами говорит наличие следующих значений в секции **enabled_payment_methods** ручки `GET /payment_methods`:
- `payment_method: yandex_account_topup`: сервису доступно пополнение баланса бонусного аккаунта
- `payment_method: yandex_account_withdraw`: сервису доступно списание баллов с бонусного аккаунта
- `payment_method: composite`: для проведения композитных платежей

## Получение баланса бонусного аккаунта
В Банкире нужна ручка, через которую можно будет получить баланс баллов Плюса.
Как вариант, можно доработать существующую ручку [Account balance info](http://banker-api-http-api.vrts-slb.test.vertis.yandex.net/swagger/index.html?url=/api/1.x#/account/getAccountInfo),
но в неё потребуется передавать паспортный **uid**, так как идентификация в Плюсе происходит по нему.
Возможно, стоит сделать отдельную ручку для получения баланса Плюса, так как текущая ручка довольно тяжёлая - она вытаскивает все транзакции пользователя из базы и считает баланс кошелька по ним.
В зависимости от реализации UI, запрашивать баланс бонусного аккаунта может потребоваться чаще, чем баланс кошелька.

Получить баланс бонусного аккаунта можно из ручки Траста `GET /payment_methods` либо `GET /legacy/wallet-balance`.
Если бонусный аккаунт отсутствует, то нам нужно его создать через ручку `POST /account` и после этого запросить баланс.

## Оплата со списанием бонусных баллов
В трасте существует 2 варианта проведения платежей со списанием бонусных баллов:
- Полная оплата корзины бонусными баллами
- Частичная оплата корзины бонусными баллами

В первом случае оплата происходит стандартным образом, в качестве **paymethod_id** требуется передавать id бонусного аккаунта.

Во втором случае необходимо использовать АПИ композитных платежей с разметкой корзины.
Разметка корзины нужна для того, чтобы принимать от сервиса готовое распределение сумм по способам оплаты в разрезе заказов.
То есть если пользователь захотел оплатить часть покупки бонусными баллами, остальную часть - банковской картой, то сервис должен определить сколько бонусных баллов должно быть списано для каждого заказа, а сколько денег должно быть списано с банковской карты.

Нам нужно поддержать второй вариант, так как мы хотим, чтобы как минимум 1 рубль всегда оплачивался картой.

Сейчас в Банкире отсутствует поддержка композитных платежей, нужно поддержать её на уровне АПИ.

### Сценарии оплаты
Разметку корзины можно передавать либо в момент создания корзины, либо после того, как пользователь сам произвел желаемую разметку на платежной форме.
Есть три сценария взаимодействия с сервисом:
1. Передача разметки при создании корзины
2. Обновление разметки через веб-форму Траста
3. Обновление разметки через внешнюю форму оплаты

Первый сценарий самый простой в реализации. Разметку мы задаём один раз при создании корзины и больше не изменяем.
Такой вариант нам подойдёт для оплаты из мобильных приложений и для рекуррентных платежей (если будем для них поддерживать оплату баллами).

Для web-платежей autoru придётся делать третий сценарий, так у нас на фронтенде используется кастомная форма оплаты.
Для её отрисовки необходим **purchase_token**, который можно получить только после создания корзины.
Соответственно, после отрисовки формы пользователь должен будет иметь возможность выбрать, сколько баллов списать с бонусного аккаунта.
После этого фронт через public-api должен вызвать Банкир, чтобы Банкир отправил апдейт разметки корзины в Траст.
Потребуется новая ручка для апдейта разметки корзины.
Фронт должен разрешать пользователю совершить оплату только после получения ответа от Банкира об успешном апдейте корзины.
В противном случае оплата может пройти по не обновлённой корзине.

## Пополнение бонусного аккаунта
Для пополнения бонусного аккаунта необходимо иметь подключенный терминал со способом оплаты **yandex_account_topup** и необходимой валютой пополнения.
Процесс пополнения идентичен по статусам с процессом создания / оплаты корзины: сначала нужно создать пополнение, затем запустить его в оплату, а после - дождаться финального статуса.

При пополнении требуется указать продукт, по которому происходит пополнение.
Это необходимо для учета различных источников бонусных баллов (маркетинговая акция / промокод или кэшбек за покупку).

Пополнения бонусного аккаунта должны поддерживать 2 сценария.
Во-первых, нужно поддержать логику автоматических начислений после успешного совершения оплаты.
Для этого нужно добавить в ручку создания платежа дополнительное поле, которое будет обозначать, сколько баллов необходимо накинуть пользователю в случае успешной покупки.
Во-вторых, есть сценарии выдачи кэшбека и всяких акций. Они с покупкой не связаны, поэтому они должны происходить отдельно от платежей.

Потребуется сделать ручки в Банкире: создания пополнения, получения статуса пополнения, отмены пополнения, получения всех пополнений пользователя.
Также нужна будет таблица в БД для пополнений и периодическая таска, которая будет поллить из Траста статус незавершенных пополнений.
Также нам нужно будет подготовить заранее список продуктов, по которым будем проводить пополнения.

Для возврата пополнений аккаунта и списаний с него используется стандартный общий интерфейс создания рефандов - [Trust API Refunds](https://wiki.yandex-team.ru/TRUST/Payments/API/Refunds/).

## Формирование GAAP отчетности
Формирование отчетности состоит из 2 частей.
Во-первых, нужно для каждой оплаты с использованием баллов Плюса передавать в Траст **payload** в определенном формате в момент создания корзины.
Какие именно данные требуется записывать в пейлод от нашего сервиса - пока не до конца понятно.
В документации есть примеры пейлода для других сервисов, но для нашего сервиса набор и значения полей могут отличаться.
Нужно будет попросить ответственных дать нам пример пейлода, который требуется от нашего сервиса.
Во-вторых, необходимо отгружать исторические данные в YT. Можно раз в месяц добавлять таблицу с данными за прошедший месяц, или каждый день добавлять таблицу с данными за прошедший день
Помимо пейлода, в выгрузке должны присутствовать другие поля, например, **order_id** = **trust_payment_id** - идентификатор транзакции в трасте и другие поля, судя по всему, специфичные для определенного сервиса.

**NB 1**: В документации ничего не сказано об отчетности для операций пополнения бонусного аккаунта. Вероятно, для пополнений она не требуется.

**NB 2**: По документации не ясно, нужно ли писать формировать отчётность также для операций возвратов, но вероятно, что нужно.

**NB 3**: Есть обязательное булевое поле **has_plus** - признак плюсовика на дату начисления баллов. По АПИ Траста не вижу, каким образом мы можем его получить. Возможно, это нужно брать из Я.Паспорта или откуда-то ещё.

В банкире нужно будет поддержать хранение данных для GAAP отчетности в БД для каждой операции покупки / возврата с использованием Плюса.
Это могут быть либо отдельные таблицы, либо дополнительные поля в таблицах **trust_purchase_external** / **trust_purchase_refund_external**.
Также нужен фоновый механизм отгрузки исторических данных в YT.
Можем либо сразу писать в YT по требуемому пути, либо сделать по аналогии с открутками: сначала писать в брокер, а потом перекладывать с помощью реактора.

## Мысли о том, что делать с кошельком Банкира в autoru
Сейчас часть оплат происходит с нашего внутреннего кошелька.
Более сложный сценарий: например, у пользователя есть 10 рублей на кошельке, он доплачивает 90 рублей и покупает услугу за 100 рублей.
На самом деле оплата проходит в 2 этапа: сначала 90 рублей зачисляются на кошелек, а потом проходит оплата на 100 рублей с кошелька.
В сценарии оплаты с кошелька мы не можем интегрировать баллы Плюса, так как для их работы полностью вся сумма услуги должна быть оплачена через Траст с соответствующей разметкой корзины.

После интеграции с Плюсом можно отключить наш кошелек в autoru, а оставшиеся средства зачислить на бонусные аккаунты Плюса.
Проблема может возникнуть с пользователями, у которых не привязан паспортный **uid**. Для них, вероятно, придётся оставить кошелек.

## Мысли о том, что делать с кэшбеком / промокодами в autoru
Сейчас salesman списывает кэшбек/промокоды с промокодера и начисляет туда же.
На оплату в Банкир отправляется оставшаяся сумма после вычета промокодов и кэшбека.
Теоретически в этот сценарий можно интегрировать баллы Плюса, но будет выглядеть странновато.
Например, услуга стоит 1000 рублей, после применения промокода на скидку цена снижается на 50%, еще 150 рублей оплачиваются с промокода на кэшбек,
ещё 100 рублей пользователь выбирает списать с баллов Плюса и 250 рублей с карты.
В траст в этом случае уйдёт композитный платеж: 100 баллов Плюса + 250 рублей с карты, в чеке соответственно тоже отобразятся только эти суммы.
А 50% скидка и 150 рублей автошного кэшбека отобразятся только в ЛК авто.ру.

Думаю, что промокоды на скидки можно оставить, а вместо промокодов на кэшбек лучше зачислять этот кэшбек на аккаунт Плюса.
Как и в предыдущем случае, проблема может возникнуть с пользователями, у которых не привязан паспортный **uid**.
Таким пользователям, вероятно, можно вместо кэшбека присылать ссылку на привязку Яндексового аккаунта :)

## Открытые вопросы
- Какие есть требования к продуктам для пополнения бонусного аккаунта? Должны ли они соответствовать продуктам оплаты услуг? Можем ли мы все пополнения проводить по одному продукту?
- Отправляет ли Траст нотификации об успешных / неуспешных пополнениях бонусного аккаунта? Где описан формат этих нотификаций?
- Уточнить у ответственных от Траста / Плюса структуру таблицы GAAP отчетности для нашего сервиса.
- Нужно ли делать GAAP отчетность для пополнений бонусного аккаунта?
- Нужно ли делать GAAP отчетность для возвратов? Если нужно, то в этом случае **order_id** = **trust_refund_id**?
- Откуда брать признак **has_plus** для GAAP отчетности?
- Что делаем с кошельком Банкира?
- Что делаем с кэшбеком / промокодами?

## Полезные ссылки
- [Плюс 2.0 - главная страница](https://wiki.yandex-team.ru/pluswallet/)
- [Оплата бонусными баллами через Trust - основная документация](https://wiki.yandex-team.ru/trust/yandexaccount/)
- [Требования к сервисам - GAAP отчетность](https://wiki.yandex-team.ru/bi/md/prj274wallet/prj274reqtoservices/)
- [Диздок, в котором рассматривался вариант интеграции через shop](./legacy/autoru_plus_shop.md)
- [Исследование Дани](https://wiki.yandex-team.ru/users/dkartashev/bally-pljusa-v-autoru/)
