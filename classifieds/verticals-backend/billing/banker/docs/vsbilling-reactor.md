Reactor - [reactor.yandex-team.ru](https://reactor.yandex-team.ru/) - это общеяндексовый *способ обработки событий*.
Звучит абстрактно, поэтому поясню.

Есть **артефакт**(artifact) - некий объект, лежащий по определённому **пути** в реакторе и имеющий **поля** и **версию**. Внешний пользователь может изменять версию объекта, при этом добавляя, удаляя или изменяя поля в нем. Для простоты можете думать, что артефакт это JSON (на самом деле так и есть, ток не говорите никому), а точнее - иммутабельный JSON.
Каждое изменение артефакта - это создание нового JSONа с новой версией и новым содержанием. **При создании новой версии артефакта старая deprecate'ится**. Для каждого артефакта хранится все версии его JSONов, вся история его изменений, и она доступна для взаимодействий (см. ниже).
Для простоты использования артефакты типизированы, причем типы создавать (кажется) нельзя - надо использовать существующие. Одним из типов, к примеру, является **YtPath** - т.е. артефакт, который хранит некий путь в YT. Новые версии артефакта, соответственно, могут иметь другое путь - другое значение поля path.

К артефакту может быть подключено от 0 до N **реакций** - действий, которые происходят при изменении. Это могут быть serverless-функции на питоне, YQL запросы итд. У некоторых реакций есть возможность настройки **deprecation policy** - что делать, если произошло не добавление нового артефакта, а обновление старого.

В контексте VSBILLING почти всегда артефакт будет иметь тип **YtPath** и порождаться автоматически вертикальным брокером. Подробнее про публикацию артефактов можно почитать в [доке брокера](https://docs.yandex-team.ru/classifieds-infra/broker/configuration#publishing).
Наиболее полезной для нас реакцией является упоминавшаяся YQLReaction - именованный запрос в YQL, который, например, дедуплицирует данные и сохраняет их обратно в YT.

Общий control flow таков (на примере пары YtPath-YQLReaction):
1. Некий внешний актор (e.g. брокер) пушит новую версию артефакта
2. Реактор под капотом достает привязанную реакцию (точнее, реакции - их может быть больше одной)
3. Вычисляются входные параметры для YQLReaction. У реактора есть собственный скриптовый переDSL-недоязык для этого.
По факту же, почти всегда вы будете писать
`
input = %artifact_name%.triggered.data.path
`
т.е. открыть артефакт, взять его версию, для которой стриггерилась реакция, достать оттуда путь в YT.
4. Вычисленные параметры передаются в YQL запрос и он запускается
5. По его завершению чекаются и запускаются нотификации, если они есть (скажем, on FAIL send message to TG chat billing-monitoring-chat)

В данный момент в вертикальном биллинге есть следующие реакции:
* trust_deduplication [[test](https://reactor.yandex-team.ru/browse?selected=11705874) | [prod](https://reactor.yandex-team.ru/browse?selected=11705897)]. Берет YT-путь до налитого брокером файла и переливает его, дедуплицируя по deduplication_id. Ссылки на артефакт и YQL-запрос есть в реакциях.

Реакции можно запускать вручную для любой версии артефакта, которая когда-либо была запушена в реактор. Для этого:
1. Перейдите в желаемую реакцию и нажмите Launch

![](vsbilling-pic1.png)


2. Выберите "Evaluate global expressions"(1.), путь до артефакта (2.) и его конкретную версию (3.), с которой будет запускаться реакция. Для выбора версии нажмите на карандашик:)

![](vsbilling-pic2.png)

3. Запустите реакцию. Ход ее исполнения можно наблюдать на странице реакции во вкладке Launches. Там же находится вся история запусков и перевычислений при депрекации.
