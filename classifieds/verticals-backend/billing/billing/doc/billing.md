# Биллинг

Вертикальный Биллинг -- сервис для учета денежных движений юридических лиц.

Имеет 2 потока средств:
- входящий - пополнения средств
- исходящий - траты юр. лиц.

Пополнения производятся через общеяндексовый сервис Я.Баланс.
В большом Яндексе принято его называть Биллингом, поэтому если общаетесь с кем-то из большого Яндекса, то лучше наш Биллинг называть вертикальным.

Баланс нотифицирует о пополнениях (входящий поток средств), Биллинг отправляет траты (исходящий поток средств - **открутки**).

# Предметная область

**Customer** - некое представление Балансового клиента.

**Типы Customer** :
- прямой - клиент, который работает напрямую
- агентство - рекламное агентство (**РА**)
- клиент под агентством - клиент, подключенный через РА.

Агентство может полностью управлять бюджетом своих клиентов и имеет нужные для этого доступы и права.

**Order (Кошелек)** - кошелек пользователя. Привязан к customer'у, customer может иметь неограниченное кол-во order'ов.

**Product (Продукт)** - это множество услуг, оказываемых на сервисе.

**Рекламная компания (РК)** - это пересечение Продукта и Кошелька. РК привязана строго к одному Кошельку.
Такое название исторически взято из Директа :).
Каждое списания с Кошелька производятся в рамках РК, т.е. каждое списание по какому-то продукту. Кастомер может иметь несколько РК по разным продуктам, но не более 1-ой РК по одному продукту.
Для того, чтобы производить списания по новому продукту, то сервису необходимо завести РК с соответствующим продуктом.

**Настройки РК**:
- Лимиты - ограничение трат
- Депозит - минимальная необходимая сумма средств, которая должна быть на кошельке для того, чтобы РК была активна.

РК считается активной, если она:
- включена;
- не достигла лимита по тратам (если он настроен для РК);
- на соответствующем ей кошельке средств больше, чем стоимость продкута;
- на соответствующем ей кошельке средств больше, чем депозит (если он настроен для РК).

В иных случаях РК считается неактивной и помечается соответствующим статусом.

# Процессы

## Обилливание

В Биллинге событийная модель обилливания. Списание средств происходит постфактум, т.е. случилось событие (клик/звонок/поднятие оффера) и только после мы списываем деньги за это.

Для части продуктов (клики/показы/звонки) такая модель естественная.

Для остальных, например применение услуги (поднятие, размещение) к офферу подходит не очень, так как между самим фактом применения услуги и фактическим списанием (изменением состояния кошелька клиента) есть большой лаг (до 1 часа).

Соответственно, сервис, который применяет услуги к офферам (salesman/seller), не знает в моменте актуальный баланс клиента, а следовательно, не знает, хватает ли на очередную услугу денег.

Поэтому было введено **холдирование**.

Холдирование - процесс заморозки произвольной суммы средств на произвольный период.

Процесс обилливания с холдированием выглядит примерно так:
- сервис хочет применить услугу стоимостью X к офферу клиента K
- сервис отправляет запрос в Биллинг на холдирование суммы X со счета клиента К, при этом указывая стабильный идентификатор холда (например offer_id + время применения услуги)
- если средств достаточно или такой холд уже был совершен, то холдирование считается успешным
- далее сервис указыват идентификатор холда в событии списания
- при обилливаниии соответствующий холд будет закоммичен
