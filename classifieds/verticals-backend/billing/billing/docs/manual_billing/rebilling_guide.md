# Гайд по переобилливанию для потребителей

Рассмотрим периодически возникающий кейс: списали неверное количество денег с клиентов, нужно списать верное.

## Общие важные нюансы

Желательно успеть переобиллить события до конца месяца, в котором эти события возникли.

<details>
  <summary>Это сильно упростит переобилливание.</summary>

  Если событие для оплаты произошло в месяце X, то первого числа месяца (X+1) Баланс сформирует для клиента акт об оказанных услугах за месяц X, по полученным данным от нашего биллинга.
  В этом акте будет указана сумма для оплаты услуг за месяц.

  Клиентам важно, чтобы событие за месяц X попало в акт за месяц X.
  Акт можно исправить в течение 10-12 дней.
  Конкретное число дней зависит от месяца.
  При необходимости нужно уточнить его у Баланса.

  На исправление актов нужно тратить много сил, поэтому лучше успевать до конца месяца.
</details>

Все цены для биллинга всегда указываются в копейках.

### Для звонков в доменах AUTORU и REALTY_COMMERCIAL

1. Исправить матрицу цен: проставить в ней правильные цены за нужный временной период.
2. Попросить команду биллинга переобиллить события за временной период.

### Для событий, в которых лежит цена

1. Подготовить события [EventMessage](https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/vertis/hydra/event_model.proto?rev=r9558371L19) для отправки в биллинг.
   В идеале, события должны быть такими же, как исходные события, но с изменённым значением одного ключа мапы `tuple`:
   - ключа `billing.indexing.revenue` -- для событий индексации;
   - ключа `billing.call.revenue` -- для звонков;
   - ключа `billing.click.revenue` -- для кликов.
   Откуда взять исходные события: надёжнее всего из продакшн-кафки: топика `broker-billing-event-to-pay` или `billing-event-log`.
2. Если хочется переобиллить события индексации, то попросить команду биллинга принимать обновления событий индексации: по дефолту, обновления цены скипаются. Дождаться отмашки от биллинга, что начать принимать обновления.
3. Отправить подготовленные события в брокер.
4. Попросить команду биллинга переобиллить события за временной период.

### Для событий, цена которой лежит в РК

Попросить команду биллинга изменить цены РК в прошлом, и переобиллить события за временной период.
