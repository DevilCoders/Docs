# Как интегрироваться с вертикальным биллингом

**Сервис находится на стадии разработки, и эта дока будет писаться со временем.**

В этой доке описано, как стоит пользоваться вертикальным биллингом.

Для каждого смежного сервиса(авто/недвижимость/cmexpert) заведено уникальное имя - _workspace_. Его нужно передавать во
все ручки биллинга. Для того, чтобы добавить новый _workspace_, напишите в
в [наш чат поддержки](http://t.me/joinchat/DN5j4EhyeEtKVkNXcFUDsg).

## Адреса балансеров grpc-api

Billy предоставляет свое grpc-api по следующим хостам:

- тестинг: [billy-api-grpc.vrts-slb.test.vertis.yandex.net:80](finstat-api-grpc.vrts-slb.test.vertis.yandex.net:80)
- прод: [billy-api-grpc.vrts-slb.prod.vertis.yandex.net:80](finstat-api-grpc.vrts-slb.prod.vertis.yandex.net:80)

## Регистрация клиента в биллинге

Перед тем, как принимать и списывать с клиента деньги, нужно его зарегистрировать. Для регистрации клиента необходимо
три вещи

- создать сущность клиента в биллинге
- создать плательщика клиента. Здесь прописаны юридические данные клиента, на которого будут выставляться счета на
  оплату
- создать договор клиента. Это документ с деталями о проведении платежей

### Создание сущности клиента в биллинге

Для создания клиента достаточно воспользоваться
[этой ручкой](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/client.proto?rev=r9632733#L10). В этот
метод нужно будет отправить сервисный id клиента, который будет использоваться в других ручках billy.

### Cоздать плательщика клиента

Мы решили, что в mvp плательщики клиентов будут добавляться руками в админке Баланса. Добавляться они будут
менеджерами/поддержкой/группой сопровождения клиентов/etc.

Для получения формы в админке Балансе, куда нужно заводить плательщика конкретного клиента, можно
воспользоваться [этой ручкой billy](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/util.proto?rev=r9632733#L8).

После создания плательщика нужно прокинуть id плательщика в биллинг в [этой ручке](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/client.proto?rev=r9632733#L14
). Нужный id отобразится в админке Баланса после заполнения формы создания плательщика.

### Cоздать договор клиента

Договоры, как и плательщики, в mvp будут заводиться руками. Заводить их нужно все в той же админке Баланса, ссылку на
которую можно получить по [этой ручкой billy](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/util.proto?rev=r9632733#L8).

После создания договора нужно прокинуть id договора в биллинг в [этой ручке](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/client.proto?rev=r9632733#L18
). Нужный id отобразится в админке Баланса после заполнении формы создания договора.

## Пополнения кошелька

У каждого клиента после создание договора автоматически создается кошелек. Клиент может пополнять кошелек деньгими, и с
этого же кошелька будут списываться деньги за услуги.

**Про термины:** под "счетом" везде подразумевается нечто вроде счета-фактуры (документа для запроса оплаты от клиента).
То, что люди привыкли называть счетом (где лежат деньги), в терминах биллинга называется "кошельком".

Для того, чтобы клиент мог пополнить кошелек, смежному сервису нужно создать счет на оплату и отдать клиенту pdf с
печатной формой счетом.

### Создание счета на оплату

Для создания счета нужно вызвать [эту ручку billy](
https://a.yandex-team.ru/arcadia/classifieds/schema-registry/proto/billing/billy/invoice.proto?rev=r9719829#L9
).

Счета создаются с методом оплаты "банк для юр.лиц", то есть клиенты смогут их оплатить только в банке, перечислив деньги
на расчетный счет Яндекса.

В респонсе этой ручки будет содержаться ссылка на pdf с печатной формой счета.

### Про pdf с печатной формой счета

Смежный сервис должен сам отдать печатную форму клиенту (в своем веб-интерфейсе через проксирование или послать pdf на
почту клиенту), чтобы клиент смог оплатить счет.

Стоит сказать, что в mvp биллинг будет в этой ручке возвращать ссылку на s3, который доступен только из сети Яндекса.
Поэтому смежному сервису нельзя просто пересылать полученную ссылку клиенту.

Если кто-то из смежного сервиса захочет класть pdf с печатными формами во свой s3, то это обязательно нужно обговорить с
командой биллинга.

### Про тайминги ручки создания счетов

Создание счета и формирование печатной формы - долгая операция на стороне Баланса. Рекомендуется ждать ответа ручки
формирования счета как минимум 15 секунд в проде и 25 секунд в тестинге.

## Получение информации о платежах клиента

Эта часть находится в разработке, документация будет позже.

## Списания за услуги

Большинству клиентов вертикального биллинга нужно управление списаниями за услуги. Вертикальный биллинг предоставляет
для этого ручки, а так же асинхронно отправляет списания в Баланс. Баланс на основе этих данных умеет формировать "Акты
об оказанных услугах", которые требуются в бухгалтерии большинства наших клиентов-юр.лиц.

Если вы не уверены, нужно ли вам тащить списания до Баланса/вертикального биллинга, то поговорите с вашим менеджером и
командой вертикального биллинга.

### Ручки управлениями списаний

Ручка добавления списаний находится[здесь](
https://a.yandex-team.ru/arc_vcs/classifieds/schema-registry/proto/billing/billy/spending.proto?rev=r9734496#L10).

TODO написать про ручки получения списаний

Ручки обновления/отмены списаний будут сделаны позже.

### Пост-оплата

На данный момент billy работает по схеме пост-оплаты. Это значит, что в ручке добавления списания billy не смотрит на
то, сколько денег есть у клиента на кошельке. Более того, billy никак не следит за долгами клиентов (если клиент за
месяц внес денег меньше, чем мы списали с него за услуги). Следить за долгами клиентов должны сервисы, использующие
billy.

Пример, как могут работать смежные сервисы:

- в течение месяца присылать в billy списания клиента
- в первые дни месяца выставлять через billy клиенту счет на сумму долга за прошлый месяц и просить клиента оплатить
  счет
- если клиент не оплачивает этот счет, то банить клиенту доступ до нашего сервиса

Пост-оплатную схему, естественно, нужно согласовывать у продакт-менеджеров и юристов.
