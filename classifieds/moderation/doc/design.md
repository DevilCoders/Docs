## Описание
Модерация - сервис осуществляющий оценку пользователей и объявлений (обобщенно **инстансов**) на основе информации от внешних сервисов и данных от вспомогательных сервисов группы качества контента.

## Основные понятия
Основная сущность - объект модерации, называется [Instance](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L363). Содержит:
* [Opinion](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L394) - вердикт модерации, отражающий наличие или отсутсвие проблем с инстансом. Вычисляемое поле, считается на основе essentials, сигналов и метаданных, может принимать одно из трех значений: `Failed`, `Unknown`, `Ok`, в БД не хранится. `Failed` свидетельствует о проблемах с инстансом, `Unknown` - проблем не обнаружено; `Ok` используется крайне редко и только для некоторых сервисов.
* [Essentials](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L376) - данные, присылаемые сервисом-потребителем для проверки
* [Сигналы](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L400) - служебные данные Модерации, содержат информацию о тех или иных проблемах с проверяемой сущностью. Существует [несколько видов](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L839) сигналов, наиболее активно используются `WarnSignal`, `BanSignal` и `HoboSignal`. Сигналы могут ставить модераторы (и тогда он считается ["ручным"](https://github.com/YandexClassifieds/schema-registry/blob/623f797e50347362a8a4356021a731ddd65ad389/proto/vertis/moderation/model.proto#L1786)), или сервисы группы качества контента (в этом случае сигнал - [автоматический](https://github.com/YandexClassifieds/schema-registry/blob/623f797e50347362a8a4356021a731ddd65ad389/proto/vertis/moderation/model.proto#L1761)). При возникновении необходимости избавиться от сигнала существует два варианта: поставить свитч-офф (описан ниже), либо удалить. Удаление сигнала приведет к тому, что в [SignalSet](https://github.com/YandexClassifieds/moderation/blob/92a5b198117cff13a2e56c44912b53c2e866fc1a/moderation-core/src/main/scala/ru/yandex/vertis/moderation/model/signal/SignalSet.scala#L17) в мапе сигналов по ключу сигнала будет храниться [Tombstone](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-core/src/main/scala/ru/yandex/vertis/moderation/model/signal/Tombstone.scala#L9). Таким образом хранится информация о том, кто и когда удалил сигнал.
* [Свитч-оффы](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L403) - выключатели сигналов. Наличие свитч-оффа для определенного сигнала означает, что такой сигнал считается отключенным и не учитывается при вычислении вердикта. Основное преимущество перед удалением сигнала заключается в том, что с помощью свитч-оффа модераторы могут "защитить" сущность от определенного сигнала: [даже при повторной простановке сигнала автоматикой](https://github.com/YandexClassifieds/moderation/blob/028501eb7893bee420a87b14643bb335a3a15681/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/instance/InstancePatchCalculatorImpl.scala#L105) он не будет учитываться, если есть вручную проставленный свитч-офф. 
* [Reason](https://github.com/YandexClassifieds/schema-registry/blob/623f797e50347362a8a4356021a731ddd65ad389/proto/vertis/moderation/model.proto#L1244) - данные характеризующие точную причину проблемы с инстансом. 
* [Метаданные](https://github.com/YandexClassifieds/schema-registry/blob/bbd8c9bda082a9e6b82563d7d509e033dbabf884/proto/vertis/moderation/model.proto#L397) - произвольные дополнительные данные о проверяемом объекте, получаемые Модерацией. Могут быть как служебными, для внутренних нужд Модерации (например, статистика сигналов и офферов), так и публичными, потребляемыми внешними сервисами (метаданные "проверенный собстввенник" в авто.ру)
* [Контекст](https://github.com/YandexClassifieds/schema-registry/blob/aab7d6d1529ff454e85b4ae03d64b55586119a4a/proto/vertis/moderation/model.proto#L391) - определяет статус сущности на стороне сервиса-потребителя
* [Домен](https://github.com/YandexClassifieds/schema-registry/blob/aab7d6d1529ff454e85b4ae03d64b55586119a4a/proto/vertis/moderation/model.proto#L1362) - определяет некоторое подмножество сервиса-потребителя, нужен для того, чтобы банить сущность не на всем сервисе, а в какой-то его части.
* [Diff](https://github.com/YandexClassifieds/schema-registry/blob/09440fb55e151aaeb4f55c2cdd4f735dac4e9112/proto/vertis/moderation/model.proto#L1895) - содержит информацию об изменениях, произошедших в инстансе по сравнению с предыдущим состоянием.
* [UpdateJournalRecord](https://github.com/YandexClassifieds/schema-registry/blob/aab7d6d1529ff454e85b4ae03d64b55586119a4a/proto/vertis/moderation/model.proto#L2097) - событие изменения модерируемой сущности.
* [OwnerJournalRecord](https://github.com/YandexClassifieds/schema-registry/blob/aab7d6d1529ff454e85b4ae03d64b55586119a4a/proto/vertis/moderation/model.proto#L2112) - событие изменения владельца модерируемой сущности. Для офферов - это пользователь, разместивший объявление.
* [ModerationRequest](https://github.com/YandexClassifieds/schema-registry/blob/5e9ebdac4fc4e2b5fba121b3d318002bfdbaf39d/proto/vertis/moderation/model.proto#L2125) - запрос, описывающий операцию изменения модерирумой сущности.  

## moderation-api
API для совершения ручных действий над модерируемым контентом, основным потребителем является фронтенд модерации. Существует [кэш](https://github.com/YandexClassifieds/moderation/blob/c37ba6acb81b12b925a93d1a09e08d823ee8c822/moderation-api/src/main/scala/ru/yandex/vertis/moderation/backend/EnvironmentInitializer.scala#L158), который позволяет пользователям сразу видеть результат своего запроса (например, когда модератор ставит сигнал). По сути, кэш был добавлен для спокойствия модераторов: когда человек не сразу видит результат запроса - он начинает беспокоиться, а пока сам запрос пройдет через весь пайплайн модерации, могут пройти единицы, или даже десятки секунд.

## moderation-push-api
API для автоматики: поставка данных внешним сервисом, и простановка сигналов другими сервисами группы качества контента (например, `User-Punisher`, `Complaints`).
 
## moderation-tms
Содержит консьюмеры и шедулерные таски. Консьюмеры делятся на две условные группы: одни выполняют некоторые вспомогательные задачи (например, отправка данных в брокер), другие осуществляют различные проверки согласно некоторой бизнес-логики. Шедулерные таски бывают автоматические (например, регулярное обновление словарей стопслов) и ручные (переиндексация инстансов в одном из сервисов).
 
## moderation-flink
Содержит джобы для обработки стримов данных. Например, сбор статистики офферов, или статистики сигналов пользователя; обработка событий о загрузке фотографий в некоторый неймспецс. Подробнее в [доке](https://wiki.yandex-team.ru/vertis/moderation/moderation-flink/).

## Поставка данных
Поставка данных в модерацию осуществляется двумя способами:
- http-запрос в `push-api` со стороны внешнего сервиса. Информация присылается в виде [InstanceSource](https://github.com/YandexClassifieds/schema-registry/blob/09440fb55e151aaeb4f55c2cdd4f735dac4e9112/proto/vertis/moderation/model.proto#L22), каждый запрос в результате порождает `ModerationRequest.PushInstance`, который записывается в топик `moderation-supply-${service}`.
- чтение модерацией топика с обновлениями от внешнего сервиса в кафке. Вся информация, необходимая для формирования `InstanceSource` извлекается из читаемого сообщения. Далее создается `ModerationRequest.PushInstance`, который записывается в топик `moderation-supply-${service}`.

В момент обработки обновлений от внешних сервисов возможно обогащение Essentials дополнительной полезной информацией. Например, обогащение офферов авто.ру [информацией о РРЦ](https://github.com/YandexClassifieds/moderation/blob/3fe82af3be52bcdb79bf3772f91dc44fe25ec9e6/moderation-push-api/src/main/scala/ru/yandex/vertis/moderation/service/PushApiInstanceServiceImpl.scala#L67).
При обработке обновлений вычисляются поля, в которых произошли изменения. Эта информация, [Diff](https://github.com/YandexClassifieds/schema-registry/blob/09440fb55e151aaeb4f55c2cdd4f735dac4e9112/proto/vertis/moderation/model.proto#L1895), в дальнейшем используется консьюмерами в moderation-tms для принятия решения об обработке сообщения. Например, если в объявлении обновилось только текстовое описание, нет смысла пытаться найти дубликаты в фотографиях, так как ранее это уже было сделано.

## Хранение данных
На текущий момент основным хранилищем данных в модерации является YDB.
Данные по объявлениям [хранятся 183 дня](https://github.com/YandexClassifieds/moderation/blob/489b8f88fcd3042cd5ae4ccfb0e643413ab2cac1/moderation-core/src/main/scala/ru/yandex/vertis/moderation/Globals.scala#L60), сигналы объявлений [хранятся 1100 дней](https://github.com/YandexClassifieds/moderation/blob/489b8f88fcd3042cd5ae4ccfb0e643413ab2cac1/moderation-core/src/main/scala/ru/yandex/vertis/moderation/Globals.scala#L109), данные по пользователям хранятся бесконечно.
В качестве хранилища данных автоправил используется MySQL.
Архив изменений инстансов хранится в YDB. Данные имеют [ttl в зависимости от сервиса](https://github.com/YandexClassifieds/moderation/blob/489b8f88fcd3042cd5ae4ccfb0e643413ab2cac1/moderation-core/src/main/scala/ru/yandex/vertis/moderation/Globals.scala#L88).

## Обработка данных
В результате получения обновлений данных от внешнего сервиса или в результате работы консьюмеров `moderation-tms` (они используют [KafkaModerationRequestHandler](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/KafkaModerationRequestHandler.scala#L14) для того, чтобы непосредственная обработка запросов происходила не сразу на месте, а в специальном консьюмере) формируется [ModerationRequest](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-core/src/main/scala/ru/yandex/vertis/moderation/model/ModerationRequest.scala#L17) и записывается в топик `moderation-supply-${service}`. Этот топик читает [ModerationRequestConsumer](https://github.com/YandexClassifieds/moderation/blob/c37ba6acb81b12b925a93d1a09e08d823ee8c822/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/ModerationRequestConsumer.scala#L27) и именно в этот момент происходит обработка всех `ModerationRequest`.  
Обработку реквестов осуществляет [DirectModerationRequestHandler](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/DirectModerationRequestHandler.scala#L26), который производит некоторые действия основываясь на типе реквеста. Во всех случаях, [кроме ModerationRequest.UpdateOwner](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/DirectModerationRequestHandler.scala#L161):  
- происходит [расчет патча](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/DirectModerationRequestHandler.scala#L109), который необходимо применить к инстансу для осуществления изменений;
- [формируется обновленная версия инстанса](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/DirectModerationRequestHandler.scala#L110);
- [создается](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/handler/impl/DirectModerationRequestHandler.scala#L111) `UpdateJournalRecord`, содержащий [новую версию инстанса, предыдущую версию и дифф](https://github.com/YandexClassifieds/schema-registry/blob/09440fb55e151aaeb4f55c2cdd4f735dac4e9112/proto/vertis/moderation/model.proto#L2295), отражающий произошедшие изменения;  
- `UpdateJournalRecord` записывается в топик `moderation-update-journal-${service}`, а обновленный инстанс записывается в БД.  

Подавляющее большинство консьюмеров в `moderation-tms` читают этот топик, и, основываясь на `diff`, решают обрабатывать сообщение или нет. В результате обработки формируется `ModerationRequest` и записывается в `moderation-supply-${service}`.  

**Подробный пример** можно найти [здесь](https://wiki.yandex-team.ru/vertis/moderation/#primerobrabotkiofferadzhenerala).

## Расчет вердикта (opinion)
Расчет вердикта осуществляет [DefaultOpinionCalculator](https://github.com/YandexClassifieds/moderation/blob/c37ba6acb81b12b925a93d1a09e08d823ee8c822/moderation-core/src/main/scala/ru/yandex/vertis/moderation/opinion/DefaultOpinionCalculator.scala#L19). Расчет происходит "на лету" и не сохраняется в бд.
Помимо собственно вердикта, существует понятие уточняющих деталей вердикта [Opinion.Details](https://github.com/YandexClassifieds/moderation/blob/c37ba6acb81b12b925a93d1a09e08d823ee8c822/moderation-core/src/main/scala/ru/yandex/vertis/moderation/model/Opinion.scala#L30), в которых может содержаться важная для внешних сервисов информация.

## Поставка вердиктов внешним сервисам
Внешние сервисы получают вердикты посредством топиков `moderation-updates-for-${service}`. Сообщения в виде `UpdateJournalRecord` пишутся в топик только в случае изменения вердикта или важных метаданных, см [SubmitUpdatesToServiceConsumer](https://github.com/YandexClassifieds/moderation/blob/c37ba6acb81b12b925a93d1a09e08d823ee8c822/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/SubmitUpdatesToServiceConsumer.scala#L25).

## Наследование сигналов
В модерации существует механизм наследования сигналов, который позволяет наследовать сигналы пользователя в его объявления. Подробно механизм описан [тут](https://wiki.yandex-team.ru/vertis/moderation/#mexanizmnasledovanijasignalovvmoderacii).

## "Обратное наследование" (объявление -> пользователь)
Существуют ситуации, когда сигнал о важных проблемах оффера должен унаследовать в пользователя, или обновление метаданных оффера должно быть отражено в метаданных пользователя. Такое "обратное наследование" реализовано с помощью [BanUserByHoboSignalConsumer](https://github.com/YandexClassifieds/moderation/blob/3fe82af3be52bcdb79bf3772f91dc44fe25ec9e6/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/BanUserByHoboSignalConsumer.scala#L39), [AddHoboSignalForUserConsumer](https://github.com/YandexClassifieds/moderation/blob/3fe82af3be52bcdb79bf3772f91dc44fe25ec9e6/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/AddHoboSignalForUserConsumer.scala#L38) и [SyncMetadataToUsersConsumer](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/SyncMetadataToUsersConsumer.scala#L27) соответственно.

## Фильтрация информации в инстансах
Существуют ситуации, когда некоторая информация в инстансе устерал и должна быть отфильтрована: например, сигналы или метаданные. Для этих целей существует [InstanceTransformer](https://github.com/YandexClassifieds/moderation/blob/3fe82af3be52bcdb79bf3772f91dc44fe25ec9e6/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/service/InstanceTransformer.scala#L19).

## Автодействия
Автодействия представляют собой автоматические правила модерации.
Каждое автодействие включает в себя [фильтр](https://github.com/YandexClassifieds/moderation/blob/00e0a56099ca650a66819d2bb71772730aebffc4/moderation-filters/src/main/scala/ru/yandex/vertis/moderation/rule/ModerationRule.scala#L16) (поисковый запрос) и [action](https://github.com/YandexClassifieds/moderation/blob/master/moderation-filters/src/main/scala/ru/yandex/vertis/moderation/rule/ModerationAction.scala), описывающий, что надо сделать при нахождении сущности, удовлетворяющей фильтру.
Они позволяют гибко настраивать [политику применения](https://github.com/YandexClassifieds/moderation/blob/master/moderation-filters/src/main/scala/ru/yandex/vertis/moderation/rule/RuleApplyingPolicy.scala): можно [конфигурировать](https://github.com/YandexClassifieds/moderation/blob/master/moderation-filters/src/main/scala/ru/yandex/vertis/moderation/rule/State.scala), что должно происходить, когда сущность удовлетворяет фильтру, и когда она ему не удовлетворяет. Для работы с автодействиями есть [API](http://moderation-api.vrts-slb.test.vertis.yandex.net/swagger/#/rule).
Автодействия работают на потоке изменений модерации: каждую изменившуюся сущность [консьюмер](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/ModerationRulesConsumer.scala#L35) автодействий [матчит](https://github.com/YandexClassifieds/moderation/blob/master/moderation-filters/src/main/scala/ru/yandex/vertis/moderation/rule/service/DocumentClauseMatcher.scala) с сохраненными фильтрами и применяет необходимые действия, определяемые action-ами.

## Поиск
В качестве поискового движка используется [saas](https://doc.yandex-team.ru/Search/saas/saas-overview/concepts/about.xml).
Суть происходящего в следующем: в saas проиндексированы многие поля инстансов. При обращении в `moderation-api` поисковый запрос конвертируется в формат, понятный saas. В результате запроса в saas возвращается список `InstanceId`, подходящих под фильтр. После этого из `InstanceDao` [достаются непротухшие инстансы](https://github.com/YandexClassifieds/moderation/blob/028501eb7893bee420a87b14643bb335a3a15681/moderation-api/src/main/scala/ru/yandex/vertis/moderation/service/ApiInstanceServiceImpl.scala#L154) и возвращаются в качестве ответа на поисковый запрос.
Ключевой сущностью является [Clause](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-searcher-core/src/main/scala/ru/yandex/vertis/moderation/searcher/core/saas/clauses/Clause.scala#L10). Для формирования поискового запроса используется [SearchClauseBuilder](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-searcher-core/src/main/scala/ru/yandex/vertis/moderation/searcher/core/saas/search/SearchClauseBuilder.scala).

Отправка документов на индексацию осуществляется в moderation-tms с помощью [SubmitToSearchIndexPushDaemon](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/SubmitToSearchIndexPushDaemon.scala#L15), который использует [SearchSubmitter](https://github.com/YandexClassifieds/moderation/blob/d2ff521df737dde3aaf6d206e163dbfbff3f6df9/moderation-dao/src/main/scala/ru/yandex/vertis/moderation/dao/SearchSubmitter.scala#L12) для формирования запроса и отправки его в [демона для записи через LogBroker](https://wiki.yandex-team.ru/jandekspoisk/saas/DataDelivery/PQ/Demon-dlja-zapisi-v-SaaS-cherez-LB). Демон поставляется и поддерживается командой `saas`.

## Взаимодействие с другими сервисами группы качества контента
[Hobo](https://wiki.yandex-team.ru/vertis/hobo/)  
Модерация умеет [создавать задачи](https://github.com/YandexClassifieds/moderation/blob/028501eb7893bee420a87b14643bb335a3a15681/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/HoboConsumer.scala#L27) в хобо и [обрабатывать их результаты](https://github.com/YandexClassifieds/moderation/blob/028501eb7893bee420a87b14643bb335a3a15681/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/consumer/HoboTasksResultConsumer.scala#L29). В результате выполнения задач могут ставиться новые сигналы, выключаться существующие, изменяться метаданные, и т.д.

[User-Punisher](https://wiki.yandex-team.ru/vertis/user-punisher/)  
Панишер осуществляет запросы в %%moderation-push-api%% для постановки сигналов пользователям согласно различным бизнес-правилам.

[Complaints](https://wiki.yandex-team.ru/vsqmanagement/complaints/complaints2)  
Сервис жалоб осуществляет запросы в `moderation-push-api` для простановки tag-сигналов объявлениям. Далее [ComplaintsHoboTrigger](https://github.com/YandexClassifieds/moderation/blob/028501eb7893bee420a87b14643bb335a3a15681/moderation-tms/src/main/scala/ru/yandex/vertis/moderation/hobo/ComplaintsHoboTrigger.scala#L20) хобо-сигнал и в результате в хобо создается задача на проверку объявления. 
