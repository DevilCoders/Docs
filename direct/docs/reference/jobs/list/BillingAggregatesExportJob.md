## BillingAggregatesExportJob

**TODO: уточнить и дополнить**

### Продукт/подсистема

Интеграция с Биллингом.


### Роль в работе продукта/подсистемы

В рекламной кампании может быть представлено несколько типов "продуктов", которые клиенты хотят видеть по отдельности в актах, которые формирует Биллинг. Для такого разделения существуют "биллинговые агрегаты" (aka "БОИДы"). Каждый агрегат соответствует одному "продукту". Например, в Медийной кампании (`campaigns.type = 'cpm_banner'`) присутствуют такие продукты как "Охватные баннеры", "Охватное видео" и другие.

Сами агрегаты представлены в Директе особым типом кампании, невидимым пользователю: `campaigns.type = 'billing_aggregate'` - такой подкапотный костыль. Аграгаты линкуются не к каждой кампании, а к "общему счету". Общий счет - это еще один особый невидимый клиентам тип кампании (`campaigns.type = 'wallet'`), который служит в качестве единого места для хранения денег - еще один костыль. Таким образом, при создании кампании добавляются нужные для этой кампании биллинговые агрегаты и привязываются к общему счету, если их там еще нет.

Данная джоба делает экспорт биллинговых агрегатов в связке с кошельком для Биллинга. Кошелек - это еще один особый невидимый клиентам тип кампании (`campaigns.type = 'wallet'`), который представляет "Общий счет" и служит в качестве единого места для хранения денег.


### Датафлоу

Джоба параметризованная, и в качестве параметров выступают целевые кластеры YT для наливки (`Hahn`, `Arnold`).

У джобы есть 2 датафлоу:
- инкрементальная наливка каждый день.
- полная переналивка первого числа каждого месяца (или по требованию с помощью ppc-property);

Инкрементальная наливка:
- Джоба последовательно обходит все шарды в MySQL и из каждого чанками достает биллинговые агрегаты, созданные с предыдущего запуска ([campaigns](https://direct-dev.yandex-team.ru/db/ppc/tables/campaigns.html) + [camp_options](https://direct-dev.yandex-team.ru/db/ppc/tables/camp_options.html)).
- Доливает полученные записи в таблицу в YT [//home/direct/export/billing_aggregates](https://yt.yandex-team.ru/arnold/navigation?path=//home/direct/export/billing_aggregates).

Полная переналивка работает так же, как и инкрементальная, только обходит MySQL полностью и переналивает целевую таблицу целиком.

Делает полезную работу один раз в сутки, но запускается раз в час - для отказоустойчивости. <br/>


### Способы наблюдения за текущим состоянием

- [Juggler-проверка](https://juggler.yandex-team.ru/check_details/?host=checks_auto.direct.yandex.ru&service=jobs.BillingAggregatesExportJob.working.production&query=&last=1DAY)
- [Логи](https://direct.yandex.ru/logviewer#~(logType~'messages~form~(fields~(~'log_time~'host~'service~'method~'trace_id~'span_id~'prefix~'log_level~'class_name~'message)~conditions~(service~'direct.jobs~method~'billingaggregatesexport.BillingAggregatesExportJob)~limit~100~offset~0~reverseOrder~false~showTraceIdRelated~false))$)


### Какая функциональность пострадает от отказа джобы

Неизвестно, но наверняка что-то важное.


### Как пользователи (или команда) заметят проблему и через какое время

Неизвестно.


### Контакты разработчиков и менеджеров

Разработчики: [Алексей Александров](https://staff.yandex-team.ru/hrustyashko)


### Желательное время исправления в случае поломки

Таблица должна обновляться каждый день до 6 утра и содержать данные актуальные на конец предыдущего дня.
TODO.


### Способы регулирования работы джобы

- Ppc-property `billing_aggregates_force_full_export` - если свойство установить в true, то следующий запуск джобы сделает полную переналивку целевых таблиц и сбросит свойство обратно в false.


### Известные причины поломок

Отсутствуют.


### Дополнительно: тонкости и подводные камни

Результирующая таблица может содержать биллинговые агрегаты, которые были удалены в Директе, но это нормально.
