# Добавить/обновить секрет в Я.Деплойный стейдж


Официальная дока:
<https://deploy.yandex-team.ru/docs/how-to/secrets>

## Через интерфейс

1. Находим нужный стейдж в [direct-production](https://deploy.yandex-team.ru/projects/direct-production) или [direct-np](https://deploy.yandex-team.ru/projects/direct-np) или [uac](https://deploy.yandex-team.ru/projects/uac)
2. На стейдже идем на вкладку **Config** и жмем **Edit**
   1. Слева в навигации выбираем **Deploy unit** (второй сверху) и на экране **Deploy unit settings** выбираем вкладку **Secrets**
      1. Внизу страницы можно добавить секрет **Add secret**, выбираем нашего секрета **Secret**, жмем **Add**
      2. Если нужно обновить версию секрета необходимо найти секрет(по названию) и рядом с ним нажать **Add version** и в открывшемся окне выбрать нужную версию и запомнить получившийся алиас
   2. Затем на этой же странице с нужным **Deploy unit** выбираем вкладку **Disks, volumes and resources**
      1. Ниже находим список секретов **secrets** и добавляем новый **Add file**
      2. Выбираем тип **secret**, имя файла **Name** в контейнере внутри /etc/direct-tokens, выбираем **Secret**(по алиасу) добавленный в Deploy unit, выбираем нужную часть секрета **key** и жмем **Create**
3. Справа вверху **Update**, видим изменение конфигурации, пишем комментарий (добавил такой-то секрет), жмем **Deploy**.
4. После деплоя на вкладке **Status** можно развернуть любой хост, нажать **SSH** и проверить наличие файла с секретом

## Через консоль со старым типом хранилища(с указанием delegation_token в спеке)

1. Выписываем delegation token. Делаем через API (веб-интерфейс не справляется с длинными названиями)  
  Пример: `ya vault create token sec-01e733j2zpz9zd81az4mzvkkym -tvm 2001151 -s direct-logviewer-production.logviewer`  
  подставить id секрета, который добавляем (`sec-...`), а в последний параметр — название стейджа и деплой-юнита  
2. В спеке стейджа добавить настройки в двух местах
   1. в секции secrets, там где есть delegation_token — по аналогии с соседними секретами  
   Делегейшн токен берем с предыдущего шага.  
   ВАЖНО: алиас (ключ в дикте) даем не как документация советует "id секретва:id версии". Вместо id версии пишем константную строчку "ver-latest".  
   Для образца см. настройки steps-test
   2. В секцию static_resources, по аналогии с соседними секретами.  
   Важно:  
   алиас — это алиас с предыдущего шага (с "ver-latest"),  
   file_name — имя файла в /etc/direct-tokens,  
   id — название ключа (поля) в секрете в Секретнице, в котором лежит нужный секрет
3. Загружаем новую спеку (dctl put)
