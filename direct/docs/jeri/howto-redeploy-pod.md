# Переналивка единичной машинки в облаке(Deploy/Nanny)

## Для чего

Иногда бывает необходимо потыкать одну машинку не трогая весь сервис. 
Например, если:
* на машинке приложение ведет себя неадекватно 
* надо проверить какую-то гипотезу при рестарте
* вносились изменения и надо налить с нуля машинку, чтоб вернуть все на место
* налить так, чтобы машинка осознала себя по другому(применительно к схеме ТС в няне через зукипер)

## Переливка в Deploy через эвакуацию

* Заходим в [Deploy](https://deploy.yandex-team.ru/) открываем необходимый stage
* Находим в списке нужный под(возможно нужно будет выбрать необходимый ДЦ, нажав на его название)
* Кликаем на имя пода ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T08:26:59Z.3f058c3.png "Зайти в под")
* Откроется окно с информацией о конкретном поде ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T08:30:59Z.3dc5eb7.png) здесь также можно посомтреть его свойства, такие как квоты, сеть, abc
* В правом верхнем углу кнопка **Request eviction** для инициации процесса эвакуации
* После ее нажатия всплывает окно с требованием написать причину - пишем и жмем **Evict**
* Теперь рядом появляется кнопка **Acknowledge eviction** ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T08:34:09Z.acd4f88.png "ACK")
* Нажимаем **Acknowledge eviction** и переходим на вкладку History смотреть как происходит эвакуация


## Переливка в няне через уничтожение пода(Nanny)

В няне мы полностью сначала уничтожаем машинку, а затем снова говорим ей вернуться в активное состояние. Делается это следующими шагами:
* Заходим в [Няню](https://nanny.yandex-team.ru/ui/#/), проваливаемся в Services
* Находим нужный сервис. Для облегчения поиска можно вписать _**direct**_ в фильтр(сохраняется), свернуть папочку _balancer_ и искать сервис, который называется также как начало имени машинки.
* Попадаем в сервис и видим снапшоты, находим активный ![alt text](https://jing.yandex-team.ru/files/pe4kin/FBED1D83-50B4-4C25-B604-EE2C124F1955_share.910fcaf.png "Активный снапшот")
* В нем нажимаем  _**Instances**_ ![alt text](https://jing.yandex-team.ru/files/pe4kin/FBED1D83-50B4-4C25-B604-EE2C124F1955_share.92198e3.png "Кнопка")
* Получаем список инстансов, находим нужный и нажимаем возле него шестеренку ![alt text](https://jing.yandex-team.ru/files/pe4kin/1182FEA6-E58A-4931-8C84-013FD6D32C09_share.b367199.png "Шестеренка")
* Открывается окно изменения стейта инстанса, в нем нужно нажать **Presented in YP/ISS only** (1), всплывет подсказка про остановку наливания трафика со ссылкой на Endpoint set (2) ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T09:40:20Z.168632e.png "Отключение пода")
* Открываем ссылку(лучше в соседнем табе). Видим там endpoint set(скорее всего один, если нет, то надо будет указывать в каждом). Открываем окно изменения, нажав на карандашик ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T09:49:00Z.06712e6.png "Изменение endpoint set") В открывшемся окне заполняем _**Pod filter**_ как на примерчике под этим полем, только используя свои id подов. id можно посмотреть на вкладке YP pods, но чаще всего это fqdn минус суффикс `.<DC>.yp-c.yandex.net`, например для `direct-testing-perl-intapi-1.man.yp-c.yandex.net` это `direct-testing-perl-intapi-1`. В фильтре надо использовать отрицание, т.к. это то, как сам ендпоинт сет отфильтрует поды из всего сервиса(по дефолту, с пустым фильтром, попадают все). После всех действий c фильтром надо нажать кнопку _**Resolve Pod Filter**_, чтобы посмотреть что в итоге попадает в endpoint set. Будет написан сам фильтр и сколько подов попадает в endpoint set. ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T10:02:14Z.dcefa78.png "Резолв фильтра"). Должно стать на 1(или сколько было решено переналить) меньше, чем во всем сервисе. Если все ожидаемо - возвращаемся по кнопке Dismiss и сохраняем по синей **Save**.
* Теперь на вкладке с инстансами можно нажать **Apply**
* Машинка начнет переходить в состояние Removed. ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T10:07:25Z.d871eb9.png "Removed") Надо дождаться, когда обе плашечки станут желтыми, т.е. е текущий стейт станет Removed. Это займет несколько минут.
* Снова надо нажать шестеренку, выбрать **Active** и нажать **Apply** ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T10:10:00Z.7ad2592.png "Active")
* Дождаться, когда стейт станет Active, для этого должен полностью отработать ansible на машинке, который проставит метку готовности. Активация должна работать десятки минут. Если активация шла меньше минуты, то инстанс на самом деле не переналивался, потому что не успел снестись. В этом случае можно попробовать воспользоваться эвакуацией.
* После переналивки в сервисе у инстанса будет статус Active и тогда нужно будет удалить выставленный нами фильтр в **Endpoint set**

## Переливка в няне через эвакуацию(Nanny)

* Заходим в [Няню](https://nanny.yandex-team.ru/ui/#/), проваливаемся в Services
* Находим нужный сервис. Для облегчения поиска можно вписать _**direct**_ в фильтр(сохраняется), свернуть папочку _balancer_ и искать сервис, который называется также как начало имени машинки.
* Жмем справа **Endpoint set** и попадаем на список endpoint set(скорее всего один, если нет, то надо будет указывать в каждом). Открываем окно изменения, нажав на карандашик ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T09:49:00Z.06712e6.png "Изменение endpoint set") В открывшемся окне заполняем _**Pod filter**_ как на примерчике под этим полем, только используя свои id подов. id можно посмотреть на вкладке YP pods, но чаще всего это fqdn минус суффикс `.<DC>.yp-c.yandex.net`, например для `direct-testing-perl-intapi-1.man.yp-c.yandex.net` это `direct-testing-perl-intapi-1`. В фильтре надо использовать отрицание, т.к. это то, как сам ендпоинт сет отфильтрует поды из всего сервиса(по дефолту, с пустым фильтром, попадают все). После всех действий c фильтром надо нажать кнопку _**Resolve Pod Filter**_, чтобы посмотреть что в итоге попадает в endpoint set. Будет написан сам фильтр и сколько подов попадает в endpoint set. ![alt text](https://jing.yandex-team.ru/files/pe4kin/2021-10-08T10:02:14Z.dcefa78.png "Резолв фильтра"). Должно стать на 1(или сколько было решено переналить) меньше, чем во всем сервисе. Если все ожидаемо - возвращаемся по кнопке Dismiss и сохраняем по синей **Save**.
* Жмем справа **View pods** и попадаем на список подов
* Напротив нужного инстанса выбираем Action **Request Pod eviction**
* Потом нам же подтверждаем, выбирая Action **Acknowledge Pod eviction**
* Возвращаемся в сервис и находим активный снапшот ![alt text](https://jing.yandex-team.ru/files/pe4kin/FBED1D83-50B4-4C25-B604-EE2C124F1955_share.910fcaf.png "Активный снапшот")
* Жмем на его имя и в открвшемся окне открываем вкладку **History**, где можно наблюдать за прогрессом
* После переналивки в сервисе у инстанса будет статус **Active** и тогда нужно будет удалить выставленный нами фильтр в **Endpoint set**

## Какие права нужны для этих операций

- В Deploy надо быть минимум Maintainer стейджа - подробнее про роли [тут](https://deploy.yandex-team.ru/docs/reference/access-management/rbac)
- В Nanny надо быть Operation managers в конкретном сервисе. Права выдаются во вкладке Administrators ![alt text](https://jing.yandex-team.ru/files/pe4kin/F049964C-1670-4268-9364-E8C47CD1B8B3_share.7a620c1.png "Права в няне")
