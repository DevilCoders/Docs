# Релиз UAC

### Сборка релиза
- Сборка релиза UAC происходит автоматически по понедельникам, средам и пятницам в 17:00 ([ссылка на планировщик](https://a.yandex-team.ru/arc/trunk/arcadia/direct/a.yaml?rev=r9578439#L663))
- В интерфейсе new CI  релизы UAC  можно найти по [ссылке](https://a.yandex-team.ru/projects/direct/ci/releases/timeline?dir=direct&id=uac-release)
- [Фильтр релизных задач](https://st.yandex-team.ru/DIRECT/order:updated:false/filter?resolution=empty()&type=12&components=110090)


{% note tip "Если сборка упала" %}

- Если сомневаешься в приоритете или нужна техническая помощь, призови на помощь разработчика для оценки масштаба, [ссылка на дежурного frontend](https://abc.yandex-team.ru/services/direct/duty/?role=4844&lang=ru)
- Если нужна помощь бэк-дежурного, призывай [Василия Михайлова](https://staff.yandex-team.ru/bratgrim)
- Если всё ещё сомневаешься в приоритете, позови [Ксению Аникееву](https://staff.yandex-team.ru/anyksenya)
- Продублируй призыв в чат UAC devs,если критикал или подозрение на критикал
- Проконтролируй хотфикс критикала (пингуй, контролируй попадание в нужный релиз)
- Хотфиксы в Прод - хотфиксим в Прод, не ждём релиз

{% endnote %}


### Асессоры
Асессоры запускаются в релизы по регулярным бронированиям в 20:00. 

[Аккаунты](https://wiki.yandex-team.ru/bst/assessors/testing/projects/universal-campaign/?from=%2Feva%2Ftesting%2Fprojects%2Funiversal-campaign%2F) для разбора тикетов асессоров

{% note warning "Внеочередной запуск асессоров" %}
1. Остановить прошлый запуск (если необходимо). Для остановки асессоров необходимо остановить все ненужные запуски в [хитмане](https://hitman.yandex-team.ru/projects/testing_direct/united_assessors_adapter_direct-frontend/?jobCreationTimeQuery=YEAR&jobPage=1&pageSize=20)
2. Создать разовую бронь в бронировщике и сохранить id брони ([Инструкция в хелпе](https://booking.yandex-team.ru/#/help?section=manage-create))
При копировании брони слетат условие AND в окружениях, после создания [проконтролирвать](https://jing.yandex-team.ru/files/bimster/2021-11-08T14:01:38Z.6e677f4.png) 
3. ДО перевода тикета в Можно тестировать добавить тег booking_id:123456
в релизный тикет (где 123456 – номер вашей брони)
4. Если необходимо перезапустить ассессоров, то надо перезапустить кубик "Crowdtest assessors run" в CI релизе

{% endnote %}


{% note tip "Релиз без асессоров" %}

Внимание! Если запуск асессоров не нужен, в релизном тикете ДО окончания деплоя в CI нужно добавить тег no_assessors. И Удалить ближайшую бронь в https://booking.yandex-team.ru/#/ перед тем, как перевести релизный тикет в тистинг.

{% endnote %}



## Регламент тестирования релиза { #rules-release }

{% note tip "Договоренности" %}

На данный момент существует  договоренность о том, что пятничный релиз uac разбирает Ваня Борисевич или Никита Савченко. Релиз понедельника и среды разбираем мы.

{% endnote %}

1. После деплоя на крауд релизный тикет автоматически переводится в статус Можно тестировать. 
При этом отработает автоматически кубик "Crowdtest assessors run" в очереди DIRECT  и в релизном тикете должен появиться комментарий про успешный запуск процесса тестирования асессорами.


2. Необходимо перейти по ссылке "чтобы увидеть запуски тестов нажмите здесь" и убедиться, что тестраны для асессоров [создались](https://testpalm.yandex-team.ru/direct-frontend-crowd/testruns):
   - проверить что появились "автозапуски"
   - перевести тикет в Ready for Assessors
   - зайти в 1-2 автозапуска и проверить id  брони если запуск внеплановый
   - если запуск асессоров не состоялся (не появился комментарий что асессоры запущены в релизном тикете или нет ранов в тестпалме). Необходимо посмотреть логи в кубике ci "Crowdtest assessors run" и перезапустить асессоров, нажав на рестарт в кубике. Если перезапуск не помог, обратиться к дежурному разработчику.

3. Переводим релизный тикет в статус "Тестируется"

4. Назначаем себя QA в релизный тикет

5. Разбираем тикеты после прогона асессоров:
   - Результаты тестирования ассесорами будут в тикете из комментария к релизу. И на борде релизов
   - Берём тикет в работу Start progress
   - Если проблема ямла меняем тип на "Улучшение" и переоткрываем
   - Если баг клонируем в нашу очередь, ставим нужный стейдж, слинковываем с асессорским и переоткрываем
   - Если асессоры завели не проблему - wont'fix
   - Пофиксить ямлы
   - После разбора тикетов от асессоров закрываем тикет регрессии асессоров и пишем "Тикеты разобраны,новых багов не обнаружено" (если обнаружены новые баги, то линкуем в релизный тикет и ждем починки/ХФ)


6. Смотрим тикеты в "Неразобранные тикеты". Если тикеты долго не разбирают, то идем и просим посмотреть. В них должно быть понятное описание что сделано, зачем и как тестировалось самостоятельно. Если описания нет или оно неполное - просим дозаполнить тикет. Если по описанию все равно что-то остается непонятным - идем к руководителю разработчика и просим его посмотреть все ли впорядке с задачей и может ли она ехать в прод

7. На запуски автотестов в регрессии  смотрит дежурный. Он классифицирует падения в тестовом прогоне. Всё подозрительное перепроверяется силами дежурного по тестам с привлечением при необходимости специалиста QA. Специалист QA валидирует информацию от дежурного по тестам. Важно, чтобы на падения в тестах взглянул тестировщик и посмотрел, что по ним написал дежурный по тестам, чтобы снизить вероятность ошибки. Когда все падения разобраны и тикеты на баги созданы — можно закрывать регрессию. При условии что упавшие кейсы проверены руками, фикса тестов можно не ждать. После успешного прохождения регрессии пишем об этом в релизный тикет: 'Регрессия автотестами успешно завершена'. Тикеты на починку тестов заводим на разработчика задачи, если понятно, откуда сломалось. Или на дежурного

8. Провести регрессию по неавтоматизированным сценариям:
   - [Для UC](https://wiki.yandex-team.ru/users/larilena/ruchnaja-regressija-v-relizax-uc/)
   - [Для РМП](https://wiki.yandex-team.ru/users/bimster/cheklist-rmp/) — красные заголовки то что не автоматизированно и нужно смотреть руками

8. Все найденные релизные баги линкуем к релизному тикету

### После окончания тестирования
Проверить, что:
- Не осталось непроверенных тикетов (в тикетах проставлены Affected apps и Tested apps , оставлен комментарий)
- Разобраны тикеты после регрессии асессоров 
- Тикет с автотестами закрыт (тесты прошли, падения известны или не критичны для релиза)

После того, как все проверили: 
1. Пишем комментарий в релизный тикет "Релиз протестирован, новых ошибок не обнаружено"
2. Переходим во флоу (ссылка в описании релизного тикета). Там надо нажать "play" на кубике "manual testing finished". Запустить кубик получиться, только если все проверки прошли успешно, если упали какие-то тесты - надо обязательно проверить кейсы в ручном режиме и если это оказались не баги, то тесты надо заскипать через тесткоп либо заигнорить проверку
3. Пишем в релизный чат: "Релиз UAC протестирован, всем спасибо! "

## Регламент выкладки релиза { #rules-release-deploy }

Общий регламент выкладки релизов через NewCI [тут](../../processes/regulations_deploy_releases_newci.md)
1. После запуска переключения тега на проде дежурные должны наблюдають за статусом:
    - В сервисе Deploy [в секцию управления продакшеном](https://deploy.yandex-team.ru/stages/uac-frontend-prod) (будет меняться статус подов во время выкатки),
    - Сейчас включена [полокационная выкладка](https://deploy.yandex-team.ru/docs/concepts/perlocation): релиз будет раскатываться на кластеры по очереди MAN->VLA->SAS. MAN обновляется автоматически, VLA и SAS требуют подтверждения. Для этого нужно зайти на стенд и нажать на кнопку "Approve" у VLA, дожидаться раскатки на MAN необязательно
    - Если возникнет необходимость отката релиза после раскатки на один ДЦ, нужно сделать коммит предыдущей ревизии поверх раскатывающейся. В таких условиях новая ревизия(откат) будет выкладываться в рамках уже "модифицированного" ДЦ. Таким образом откат можно будет проверить уже на сбойном ДЦ, и выяснить, действительно ли проблема непосредственно в новом релизе, или она воспроизводится и на предыдущем релизе.
    - в сервисе Deploy можно смотреть [серверные логи]( https://deploy.yandex-team.ru/stages/uac-frontend-prod/logs),
    - и ошибками (если они есть) в [факапочном чате](https://t.me/joinchat/UrDAmN7DUY2G1cVt),
    - на графиках в [Головане](https://yasm.yandex-team.ru/panel/uac_front_tv/),
    - серверные ошибки [ServerErrorBooster](https://datalens.yandex-team.ru/pid0siza5flgi-uac-nodejs-booster),
    - в сервисе [ErrorBooster](https://error.yandex-team.ru/projects/uac/projectDashboard?filter=environment%20==%20production).
2. После окончания выкладки убеждаемся в успешности:
    - проверяем работоспособность сервиса,
    - [в секцию управления продакшеном](https://deploy.yandex-team.ru/stages/uac-frontend-prod/history) нажимаем на последнюю версию сборки и смотрим конфиг. Ищем строчку _"tag"_, она должна совпадать с [версией сервиса в продакшене](https://uac.yandex.ru/wizard/version.json),
    - **в случае обнаружения критичных ошибок**, откатываем релиз через [Deploy](https://deploy.yandex-team.ru/stages/uac-frontend-prod/history). Нужно нажать на кнопку _"Apply"_ для предыдущей версии. **Подробнее в [доке по откату](https://docs.yandex-team.ru/direct-dev/processes/regulations_deploy_releases_newci#otkat-esli-vse-poshlo-ploho)**
3. Дежурный пишет сообщение в чат `Direct.Admin.Chat` ([ссылка](https://t.me/+P2iPYYcBpFFbZ9iF)) о успешной выкладке релиза `UAC`.

### Хотфиксы {#hotfix}

### На ТС в текущий релиз

{% include [примечание про ОК от Леши](_includes/new-tasks-hotfixing.md) %}

1. Заходим в созданную для релиза ветку в интерфейсе new CI 
2. Нажимаем кнопку Cherry pick 
3. Выбираем коммит, который нужно добавить. Включить опции Enable merge  и Publish review 
4. Нажимаем cherry-pick . Откроется страничка с результатами мёрджа, просто закрываем её и переходим обратно к релизу с которого пришли
5. После добавления коммита и появления его в списке коммитов запускамем сборку от последнего коммита этой ветки:
- Нажимаем  кнопку "Run release"
- Проверяем, что это необходимый коммит
- В появившемся окне галочку Cancel other releases  проставлять не стоит, если не уверены, что не удалятся лишние релизы. Лучше вручную отменить те, которые будут мешать сборке хотфикса. [На одной стадии релиза: pre-build, build, testing, deploy может находиться только один релиз. Если какой-то релиз занимает стадию, более поздние релизы ждут пока стадия будет свободна]
- В Release flow выбираем uac-release-flow  (если добавляются изменения в текущий релиз)
6. Запустится новый релизный граф, который обновит минорную версию релиза в релизном тикете и допишет комментарий о хотфиксе. Комментарий о хотфиксе сейчас публикуется, не дожидаясь окончания сборки и обновления сред, поэтому до тестирования хотфикса нужно убедиться на графе релиза, что билд собрался и среды обновились
7. На одной стадии может находиться не более одного релиза. Так что сборка хотфикса заблокируется предыдущим релизом
8. Чтобы разблокировать стадию "testing" отменим предыдущий релиз (он как раз её занимает):
- Нажимаем кнопку(3 точки) около названия релиза и в выпадающем меню выбираем "cancel"
- В открывшемся модальном окне указываем причину отмены релиза (Например, "Довозим ХФ NNNN")
- Предыдущий релиз отменится, а новый релиз с хотфиксом займёт стадию "testing"

### В прод
1. Заходим в созданную для релиза ветку в интерфейсе new CI 
2. Нажимаем кнопку Cherry pick 
3. Выбираем коммит, который нужно добавить. Включить опции Enable merge  и Publish review 
4. Нажимаем cherry-pick . Откроется страничка с результатами мёрджа, просто закрываем её и переходим обратно к релизу с которого пришли
5. После добавления коммита и появления его в списке коммитов запускамем сборку от последнего коммита этой ветки:
- Нажимаем  кнопку "Run release"
- Проверяем, что это необходимый коммит
- В появившемся окне галочку Cancel other releases  проставлять не стоит, если не уверены, что не удалятся лишние релизы. Лучше вручную отменить те, которые будут мешать сборке хотфикса. [На одной стадии релиза: pre-build, build, testing, deploy может находиться только один релиз. Если какой-то релиз занимает стадию, более поздние релизы ждут пока стадия будет свободна]
- В Release flow выбираем uac-hotfix-flow  (если хотфикс делается в прод)
6. Запустится новый релизный граф, который обновит минорную версию релиза в релизном тикете и допишет комментарий о хотфиксе. Комментарий о хотфиксе сейчас публикуется, не дожидаясь окончания сборки и обновления сред, поэтому до тестирования хотфикса нужно убедиться на графе релиза, что билд собрался и среды обновились
7. Если везем ХФ в прод, то в тестируемый релиз необходимо привезти этот же релиз


## Дополнительная информация 
- [Метатрекер](https://javadirect-dev.yandex-team.ru/metatracker/?current_app=dna&app=uac&release_id=-1)  
- [Версия на ТС](https://crowd.uac.test.yandex.ru/wizard/version.json)
- [Документация по релизу на вики](https://wiki.yandex-team.ru/uac/relizy-uac/deploy-via-newci/?from=%2Fuac%2Fdeploy%2Fdeploy-via-newci%2F)
