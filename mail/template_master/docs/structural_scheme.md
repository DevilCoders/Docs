## Общая схема обратки запроса
![Structural Scheme](imgs/structural_schem.jpg)

## Шаги при обработке запроса
* SO отправляет http запрос с html телом письма и мета информацией в балансер
* Когда балансер доставит запрос на инстанс template-master'a мы начинаем поиск похожих шаблонов в базе
    * Если в базе нашелся шаблон, токены которого целиком находятся в письме то мы выделяем дельту и прекращаем обработку запроса
    * Если подходящий шаблон не был найден мы выделяем фичи из письма и исходя из этого, роутим письмо на нужный инстанс, 
    где находятся похожие на это письмо шаблоны
* Когда мы отправили письмо на нужный инстанс мы выбираем нужный template pool где хранятся похожие на письмо шаблоны
    * Поднимаем похожие шаблоны в template pool используя MinHash алгоритм
    * Для каждого поднятого шаблона мы явно вычисляем [Jacquard Index](https://en.wikipedia.org/wiki/Jaccard_index)
    * Сортируем шаблоны в порядке убывания [Jacquard Index](https://en.wikipedia.org/wiki/Jaccard_index) и берем первые ***k***
    * Вычисляем [LCS](https://en.wikipedia.org/wiki/Longest_common_subsequence_problem) между сообщением и каждым шаблоном
    * После этого берем тот шаблон, общая часть которого и сообщения составляет наибольший % от всех токенов шаблона и 
    превосходит определенный порог
    * Обновляем этот шаблон
    * Если количество сматченных писем для этого шаблона превзошло определенный порог, мы сохраняем шаблон в базе
    * Выделяем дельту и отправляем ответ
