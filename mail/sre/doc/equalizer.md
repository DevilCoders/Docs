### Что делает сервис
Equalizer читает mail.change_log, группирует интересные ему события по пользователям и отправляет в mailpusher.

### Импакт на пользователей от от отключения сервиса
Пользователи перестанут получать пуши "У вас новое письмо" в вебе и на мобильных устройствах. В вебе перестанет обновляться список писем без рефреша страницы. Аналогично в imap - клиенты перестанут получать обновления от сервера.

### Импакт остановки тачки/ДЦ
Шарды, которые обрабатывались погашенными тачками, будут перераспределены между остальными. Процесс перераспределения должен сходиться достаточно быстро (меньше минуты).

### Особенности деплоя
Краткий даунтайм во время активации, переотправка сообщений за последнюю минуту (https://st.yandex-team.ru/RTEC-3843).

### Критичные метрики
#### eq_db
Перечисленные в тексте проверки шарды не обрабатываются эквалайзером, пользователи этих шардов испытывают импакт остановки сервиса.
#### eq_lag
Пользователи перечисленных в CRIT шардов получают пуши с критично большой задержкой.

### Куда ходит
#### mdb (ymod_pq)
Читающие запросы с rps порядка 1-2.
#### sharpei (httpclient)
Получает список шардов каждые pg.poll_interval секунд (по умолчанию 30).
#### blackbox (ymod_blackbox)
1 раз ходит для каждой интересущей строчки из change_log. Параллельно выполняется не более auth.stream.window запросов для каждого захваченного шарда.
#### leasemeta (lock_manger)
Держит по 1 ресурсу на каждый захваченный шард. Каждый инстанс захватывает не более max_owned_locks шардов.
#### mailpusher (httpclient)
Отправляет пачки событий в body в json. Максимальный размер пачки - equalizer.user_queue_limit.
Выполняется не более equalizer.stream.window параллельных запросов для каждого захваченного шарда.
В случае ошибки со стороны mailpusher события ретраятся не более max_event_send_attempts раз с интервалом в equalizer.retry_interval секунд между запросами.
В случае медленных ответов для каждого uid копится в памяти не более equalizer.user_queue_limit событий, лишние дропаются.
