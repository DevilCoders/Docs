### Что делает сервис
**imap** - предоставляет доступ к ящику пользователя по протоколу IMAP (Internet Mail Access Protocol). Позволяет загружать папки, письма и флаги, а также выполнять модифицирующие операции над ними. Обслуживает почтовые клиенты: Microsoft Outlook, Mozilla Thunderbird, Apple Mail, а также сторонние сборщики писем.
С точки зрения клиента является не-HTTP сервером и предоставляет набор IMAP команд: LOGIN, LIST, SELECT, RENAME, SEARCH и др. Однако HTTP-интерфейс тоже имеется, но он предназначен для реализации взаимодействия с другими сервисами, в частности, для получения push-уведомлений от xiva.

### Импакт на пользователей от отключения сервиса
При недоступности сервиса перестанут работать пользовательские почтовые программы и сторонние сборщики в части взаимодействия с почтовыми серверами: подключение, получение/отправка писем, пометка писем прочитанными/непрочитанными, подписка на уведомления, перемещения между папками и пр.

### Импакт остановки тачки/ДЦ
Балансер должен перенаправить нагрузку на другие тачки/ДЦ, нагрузка на них возрастет пропорционально.
По тем же причинам, что и в 'особенностях деплоя' снимать нагрузку с ДЦ желательно постепенно.

### Особенности деплоя
imap держит долгие сессии с клиентами, поэтому при деплое перезапускать узлы надо постепенно, например, с окном 5-10%, чтобы избежать всплеска нагрузки при массовых переподключениях клиентов.

### Критичные метрики
#### Количество сессий (*_imap_sessions)
Трендовый алерт на количество активных подключений, срабатывающий при резком падении их числа.

### Куда ходит
#### blackbox (http_client)
Ходит в blackbox-mail (с fallback-ом на blackbox) для аутентификации клиента (login/authenticate).
#### MDS (http_client)
Получает содержимое (тело и/или заголовки) письма, возможно, частями.
#### sharpei (http_client)
Определяет шард метабазы (MDB) пользователя по его uid'у.
#### mdb (macs_pg)
Получает метаинформацию о письмах: список писем и папок, метки и флаги, идентификатор письма в хранилище MDS и т.п. Также может модифицировать некоторые данные.
#### msearch (http_client)
Та часть поиска по сообщениям почты, которая не реализуется силами самого сервиса, выполняется посредством делегирования запросов в msearch.
#### xiva (http_client)
Подписка/отписка на уведомления об изменениях на сервере: новые письма, метки, удаление/перемещение писем и т.п. Получение событий 'разлогина' от паспорта.
#### fastsrv ()
Используется для добавления писем в ящик пользователя (например, в папку Отправленные и Черновики). Взаимодействие с fastsrv происходит по протоколу LMTP (Local Mail Transfer Protocol, аналог SMTP).
