### Что делает сервис
Mops выполняет модифицирующие операции над: 
 * Письмами - перемещение, удаление, пометка прочитанным, пометка спамом и т.п..
 * Папками - создание, изменение, удаление, изменение позиции.
 * Метками - создание, изменение, удаление.
### Импакт на пользователей от отключения сервиса
Пользователи не смогут выполнять модифицирующие операции с письмами, папками, метками. Чаще жалуются на операции - пометить прочитанным и удаление. Так же не могут применять правила к существующим письмам. 
### Импакт остановки тачки/ДЦ
Импакта быть не должно, нагрузка перенаправляется балансером на другие машины/ДЦ.

### Особенности деплоя
Нет

### Критичные метрики
#### 5xx и 4хх сервиса
Смотреть на [диагностический дашборд](https://yasm.yandex-team.ru/template/panel/mops_panel/env=production/). Чаще всего проблемы возникают из-за недоступности баз, sharpei или blackbox).
#### Очередь асинхронных операций
[Размера очереди prod](https://yasm.yandex-team.ru/alert/mopsdb_queue_size_prod)

[Размера очереди corp](https://yasm.yandex-team.ru/alert/mopsdb_queue_size_corp)

### Куда ходит
#### mdb (macs)
Модифицирующие операции с письмами/папками/метками. Основная работа сервиса это операции в базе.
#### sharpei (httpclient)
При выполнении операций определяется шард пользователя. 
#### blackbox (httpclient)
При потребительском запросе ходит 1 раз, проверяя является ли юзер мэйлиш (для мэйлиш юзеров вернется ошибка).
#### mopsdb (pgg)
При создании и разборе очередей тасков для асинхронных операций делается поход в mopsdb.
Так же в mopsdb берется лок для найденого таска при выполнении асинхронных операций по uid - для предотвращения конфликтов, когда несколько воркеров работают по одному пользователю.
#### push.yandex.ru (httpclient)
После асинхронной обработки чанка mops отправляет нотифай в Xiva.
#### complaint.so.yandex.net (httpclient)
Для некоторых операций (спам, анспам, удаление непрочитанного) mops отправляет репорт в СО.

### Особенность работы сервиса
В основном сервис выполняет операции синхронно - с тз клиента отвечает после выполнения операции, но есть лимит писем для синхронных операций (в данный момент 500), при его превышении, операции ставится в очередь  - создается таск в mopsdb (PostgreSQL база в MDB) на выполнение или на определение mid'ов для обработки. В mops есть несколько тредов воркеров, которые считывают свежие таски из mopsdb. Мастер mopsdb задается напрямую в конфиге (rw днс алиас). Работает с mopsdb через pgg. Так же есть puli - это отдельный микросервис для мониторинга и кронов вспомогательных баз, при отключении не происходит ротации таблиц с логами и удаления устаревших тасков, через несколько дней перестают выполняться асинхронные операции, начинает расти очередь.
