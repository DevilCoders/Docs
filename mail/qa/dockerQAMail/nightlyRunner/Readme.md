# Томат

## Описание
Томат представляет из себя веб-интерфес с самыми используемыми скриптами почты.
На данный момент в томате есть следующий функционал:
- Запуск автотестов прямо сейчас для Календаря, Тача, Веба - добавляет запуск в очередь, запускает тесты в акве, ретраит
3 раза, грепает логи и присылает отчёт на почту
- Регулярный запуск автотестов ночью - делает всё то же самое, но ночью и до тех пор, пока задание не будет удалено
руками
- Запуск асессоров на регресс по релизу - наш регулярный фиксированный регресс

Кроме того есть апи, позволяющее запускать автотесты дёрнув ручку

## API
### GET /api/runned?project=
Получает текущее состояние очереди запусков (кто сейчас гонят и сколько ещё в очереди)
liza/cal/touch
### POST /api/run_now?stand=&service=&category=&emails=&testpalm=&issueKey=&priority=
Запуск автотестов сейчас
- stand
стенд для запуска, например ub1-qa.mail.yandex.ru
- service
сервис liza/touch/cal
- category
пресет паков, сейчас есть только smoke или ничего
- emails
адреса, на которые отправить отчёт, пишем через запятую
- testpalm
версия в пальме, к которой прилинковать ран
- issueKey
тикет в стартркеке, куда отправить отчёт
- priority
приоритет в очереди, по умолчанию 2, чем приоритет ниже, тем раньше будет запущен ран

возвращает id рана
### POST /api/nightly?service=
запуск всех ночных ранов
liza/cal/touch
### GET /api/status?run_id=
получать статус рана по идентификатору

## Сабмодули

### accessorMailTool
Модуль отвечающий за запуск асессоров, умеет заводить версию в пальме, добавлять туда раны, делать тикет и версию в
стартреке и затем отправлять всё это в хитман

### LogParse
Отвечает за греп логов в Лизе

### set_secret
Вытягивает все необходимые роботные токены и секреты из Секретницы

## Как всё работает
Входной точкой всего является web-app, написанный на tornado, сервер можно запустить из файла `tornadoWebApp.py` вся
вёрстка находится в папках `static` и `pages`

В `tornado_web_app.py` находится логика API и веб-морды

### Автотесты
За очереди автотестов отвечают классы-наследники класса  `TestRunner`, они запускаются при старте веб-сервера.
Очереди отвечают за хранение запусков, которые нужно произвести и непосредственно за сам запуск автотестов и греп логов.

Каждый запуск представляет из себя объект `Run` в котором содержится следующая информация:
- id рана - его уникальный идентификатор, по которому можно отследить прогресс его выполнения
- тип рана - ночной или обычный, ночные запуски не попадают в очередь до тех пор, пока мы не дёрнем специальную ручку,
а обычные раны встают в очередь сразу же
- аргументы рана - различные параметры рана:
  * сервис, для которого ран создан (календрь, тач, лиза)
  * адреса, на которые отправить отчёт
  * паки, которые надо запустить
  * стенд, на котором будет произведен запуск
  * тикет, в который должен прийти отлуп
  * версия в пальме, к которой будут прилинкованы раны
  * статус - текущее состояние рана (ожидает, запущен, завершён)
- время создания рана

Паки, категории и прочая специфика хранится в папке `packs_config`